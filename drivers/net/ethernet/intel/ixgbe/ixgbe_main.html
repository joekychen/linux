<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgbe › ixgbe_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ixgbe_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel 10 Gigabit PCI Express Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/sctp.h&gt;</span>
<span class="cp">#include &lt;linux/pkt_sched.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fcoe.h&gt;</span>

<span class="cp">#include &quot;ixgbe.h&quot;</span>
<span class="cp">#include &quot;ixgbe_common.h&quot;</span>
<span class="cp">#include &quot;ixgbe_dcb_82599.h&quot;</span>
<span class="cp">#include &quot;ixgbe_sriov.h&quot;</span>

<span class="kt">char</span> <span class="n">ixgbe_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ixgbe&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ixgbe_driver_string</span><span class="p">[]</span> <span class="o">=</span>
			      <span class="s">&quot;Intel(R) 10 Gigabit PCI Express Network Driver&quot;</span><span class="p">;</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
<span class="kt">char</span> <span class="n">ixgbe_default_device_descr</span><span class="p">[]</span> <span class="o">=</span>
			      <span class="s">&quot;Intel(R) 10 Gigabit Network Connection&quot;</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ixgbe_default_device_descr</span><span class="p">[]</span> <span class="o">=</span>
			      <span class="s">&quot;Intel(R) 10 Gigabit Network Connection&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#define MAJ 3</span>
<span class="cp">#define MIN 9</span>
<span class="cp">#define BUILD 15</span>
<span class="cp">#define DRV_VERSION __stringify(MAJ) &quot;.&quot; __stringify(MIN) &quot;.&quot; \</span>
<span class="cp">	__stringify(BUILD) &quot;-k&quot;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">ixgbe_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_VERSION</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ixgbe_copyright</span><span class="p">[]</span> <span class="o">=</span>
				<span class="s">&quot;Copyright (c) 1999-2012 Intel Corporation.&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbe_info</span> <span class="o">*</span><span class="n">ixgbe_info_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">board_82598</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_82598_info</span><span class="p">,</span>
	<span class="p">[</span><span class="n">board_82599</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_82599_info</span><span class="p">,</span>
	<span class="p">[</span><span class="n">board_X540</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_X540_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ixgbe_pci_tbl - PCI Device ID Table</span>
<span class="cm"> *</span>
<span class="cm"> * Wildcard entries (PCI_ANY_ID) should come last</span>
<span class="cm"> * Last entry must be all 0s</span>
<span class="cm"> *</span>
<span class="cm"> * { Vendor ID, Device ID, SubVendor ID, SubDevice ID,</span>
<span class="cm"> *   Class, Class Mask, private data (not used) }</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ixgbe_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598AF_DUAL_PORT</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598AF_SINGLE_PORT</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598AT</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598AT2</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598EB_CX4</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598_CX4_DUAL_PORT</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598_DA_DUAL_PORT</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598_SR_DUAL_PORT_EM</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598EB_XF_LR</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598EB_SFP_LOM</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82598_BX</span><span class="p">),</span> <span class="n">board_82598</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_KX4</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_XAUI_LOM</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_KR</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_SFP</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_SFP_EM</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_KX4_MEZZ</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_CX4</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_BACKPLANE_FCOE</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_SFP_FCOE</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_T3_LOM</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_COMBO_BACKPLANE</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_X540T</span><span class="p">),</span> <span class="n">board_X540</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_SFP_SF2</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_LS</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599EN_SFP</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">IXGBE_DEV_ID_82599_SFP_SF_QP</span><span class="p">),</span> <span class="n">board_82599</span> <span class="p">},</span>
	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ixgbe_pci_tbl</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_notify_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">dca_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">ixgbe_notify_dca</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>          <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span>      <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_vfs</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_vfs</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_vfs</span><span class="p">,</span>
		 <span class="s">&quot;Maximum number of virtual functions to allocate per physical function - default is zero and maximum value is 63&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_IOV */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">allow_unsupported_sfp</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">allow_unsupported_sfp</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">allow_unsupported_sfp</span><span class="p">,</span>
		 <span class="s">&quot;Allow unsupported and untested SFP+ modules on 82599-based adapters&quot;</span><span class="p">);</span>

<span class="cp">#define DEFAULT_MSG_ENABLE (NETIF_MSG_DRV|NETIF_MSG_PROBE|NETIF_MSG_LINK)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0=none,...,16=all)&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Intel Corporation, &lt;linux.nics@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel(R) 10 Gigabit PCI Express Network Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_service_event_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_SERVICE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_service_event_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_SERVICE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

	<span class="cm">/* flush memory to make sure state is correct before next watchdog */</span>
	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_SERVICE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ixgbe_reg_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbe_reg_info</span> <span class="n">ixgbe_reg_info_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* General Registers */</span>
	<span class="p">{</span><span class="n">IXGBE_CTRL</span><span class="p">,</span> <span class="s">&quot;CTRL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_STATUS</span><span class="p">,</span> <span class="s">&quot;STATUS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_CTRL_EXT</span><span class="p">,</span> <span class="s">&quot;CTRL_EXT&quot;</span><span class="p">},</span>

	<span class="cm">/* Interrupt Registers */</span>
	<span class="p">{</span><span class="n">IXGBE_EICR</span><span class="p">,</span> <span class="s">&quot;EICR&quot;</span><span class="p">},</span>

	<span class="cm">/* RX Registers */</span>
	<span class="p">{</span><span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;SRRCTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_DCA_RXCTRL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;DRXCTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_RDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;RDLEN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_RDH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;RDH&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_RDT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;RDT&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;RXDCTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_RDBAL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;RDBAL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_RDBAH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;RDBAH&quot;</span><span class="p">},</span>

	<span class="cm">/* TX Registers */</span>
	<span class="p">{</span><span class="n">IXGBE_TDBAL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;TDBAL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_TDBAH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;TDBAH&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_TDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;TDLEN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_TDH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;TDH&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_TDT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;TDT&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;TXDCTL&quot;</span><span class="p">},</span>

	<span class="cm">/* List Terminator */</span>
	<span class="p">{}</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * ixgbe_regdump - register printout routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_regdump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ixgbe_reg_info</span> <span class="o">*</span><span class="n">reginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rname</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">regs</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reginfo</span><span class="o">-&gt;</span><span class="n">ofs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DCA_RXCTRL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_RXCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_RDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDLEN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_RDH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_RDT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_RDBAL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDBAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_RDBAH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDBAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_TDBAL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDBAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_TDBAH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDBAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_TDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDLEN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_TDH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_TDT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%-15s %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reginfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">reginfo</span><span class="o">-&gt;</span><span class="n">ofs</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">rname</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%s[%d-%d]&quot;</span><span class="p">,</span> <span class="n">reginfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s&quot;</span><span class="p">,</span> <span class="n">rname</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ixgbe_dump - Print registers, tx-rings and rx-rings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_reg_info</span> <span class="o">*</span><span class="n">reginfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">my_u0</span> <span class="p">{</span> <span class="n">u64</span> <span class="n">a</span><span class="p">;</span> <span class="n">u64</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span> <span class="o">*</span><span class="n">u0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">rx_buffer_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">staterr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Print netdevice Info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Net device Info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Device Name     state            &quot;</span>
			<span class="s">&quot;trans_start      last_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%-15s %016lX %016lX %016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Print Registers */</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Register Dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; Register Name   Value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reginfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_reg_info</span> <span class="o">*</span><span class="p">)</span><span class="n">ixgbe_reg_info_tbl</span><span class="p">;</span>
	     <span class="n">reginfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">reginfo</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_regdump</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">reginfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Print TX Ring Summary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX Rings Summary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Queue [NTU] [NTC] [bi(ntc)-&gt;dma  ] leng ntw timestamp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">tx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">];</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; %5d %5X %5X %016llX %04X %p %016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">n</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">),</span>
			   <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
			   <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">next_to_watch</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Print TX Rings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_msg_tx_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_ring_summary</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX Rings Dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Transmit Descriptor Formats</span>
<span class="cm">	 *</span>
<span class="cm">	 * Advanced Transmit Descriptor</span>
<span class="cm">	 *   +--------------------------------------------------------------+</span>
<span class="cm">	 * 0 |         Buffer Address [63:0]                                |</span>
<span class="cm">	 *   +--------------------------------------------------------------+</span>
<span class="cm">	 * 8 |  PAYLEN  | PORTS  | IDX | STA | DCMD  |DTYP |  RSV |  DTALEN |</span>
<span class="cm">	 *   +--------------------------------------------------------------+</span>
<span class="cm">	 *   63       46 45    40 39 36 35 32 31   24 23 20 19              0</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;TX QUEUE INDEX = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;T [desc]     [address 63:0  ] &quot;</span>
			<span class="s">&quot;[PlPOIdStDDt Ln] [bi-&gt;dma       ] &quot;</span>
			<span class="s">&quot;leng  ntw timestamp        bi-&gt;skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">tx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">u0</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">my_u0</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_desc</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;T [0x%03X]    %016llX %016llX %016llX&quot;</span>
				<span class="s">&quot; %04X  %p %016llX %p&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">u0</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">),</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">u0</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">),</span>
				<span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
				<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">next_to_watch</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">,</span>
				<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">&amp;&amp;</span>
				<span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; NTC/U</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; NTU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; NTC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
					<span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">phys_to_virt</span><span class="p">(</span><span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span>
								    <span class="n">dma</span><span class="p">)),</span>
					<span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
					<span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Print RX Rings Summary */</span>
<span class="nl">rx_ring_summary:</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX Rings Summary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Queue [NTU] [NTC]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%5d %5X %5X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">n</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Print RX Rings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX Rings Dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Advanced Receive Descriptor (Read) Format</span>
<span class="cm">	 *    63                                           1        0</span>
<span class="cm">	 *    +-----------------------------------------------------+</span>
<span class="cm">	 *  0 |       Packet Buffer Address [63:1]           |A0/NSE|</span>
<span class="cm">	 *    +----------------------------------------------+------+</span>
<span class="cm">	 *  8 |       Header Buffer Address [63:1]           |  DD  |</span>
<span class="cm">	 *    +-----------------------------------------------------+</span>
<span class="cm">	 *</span>
<span class="cm">	 *</span>
<span class="cm">	 * Advanced Receive Descriptor (Write-Back) Format</span>
<span class="cm">	 *</span>
<span class="cm">	 *   63       48 47    32 31  30      21 20 16 15   4 3     0</span>
<span class="cm">	 *   +------------------------------------------------------+</span>
<span class="cm">	 * 0 | Packet     IP     |SPH| HDR_LEN   | RSV|Packet|  RSS |</span>
<span class="cm">	 *   | Checksum   Ident  |   |           |    | Type | Type |</span>
<span class="cm">	 *   +------------------------------------------------------+</span>
<span class="cm">	 * 8 | VLAN Tag | Length | Extended Error | Extended Status |</span>
<span class="cm">	 *   +------------------------------------------------------+</span>
<span class="cm">	 *   63       48 47    32 31            20 19               0</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RX QUEUE INDEX = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;R  [desc]      [ PktBuf     A0] &quot;</span>
			<span class="s">&quot;[  HeadBuf   DD] [bi-&gt;dma       ] [bi-&gt;skb] &quot;</span>
			<span class="s">&quot;&lt;-- Adv Rx Read format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RWB[desc]      [PcsmIpSHl PtRs] &quot;</span>
			<span class="s">&quot;[vl er S cks ln] ---------------- [bi-&gt;skb] &quot;</span>
			<span class="s">&quot;&lt;-- Adv Rx Write-Back format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">IXGBE_RX_DESC</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">u0</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">my_u0</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_desc</span><span class="p">;</span>
			<span class="n">staterr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">upper</span><span class="p">.</span><span class="n">status_error</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">staterr</span> <span class="o">&amp;</span> <span class="n">IXGBE_RXD_STAT_DD</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Descriptor Done */</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RWB[0x%03X]     %016llX &quot;</span>
					<span class="s">&quot;%016llX ---------------- %p&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">u0</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">),</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">u0</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">),</span>
					<span class="n">rx_buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;R  [0x%03X]     %016llX &quot;</span>
					<span class="s">&quot;%016llX %016llX %p&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">u0</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">),</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">u0</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">),</span>
					<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">rx_buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					<span class="n">rx_buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
					   <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					   <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">rx_buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">),</span>
					   <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; NTU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; NTC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_release_hw_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl_ext</span><span class="p">;</span>

	<span class="cm">/* Let firmware take over control of h/w */</span>
	<span class="n">ctrl_ext</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL_EXT</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL_EXT</span><span class="p">,</span>
			<span class="n">ctrl_ext</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IXGBE_CTRL_EXT_DRV_LOAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_get_hw_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl_ext</span><span class="p">;</span>

	<span class="cm">/* Let firmware know the driver has taken over */</span>
	<span class="n">ctrl_ext</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL_EXT</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL_EXT</span><span class="p">,</span>
			<span class="n">ctrl_ext</span> <span class="o">|</span> <span class="n">IXGBE_CTRL_EXT_DRV_LOAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ixgbe_set_ivar - set the IVAR registers, mapping interrupt causes to vectors</span>
<span class="cm"> * @adapter: pointer to adapter struct</span>
<span class="cm"> * @direction: 0 for Rx, 1 for Tx, -1 for other causes</span>
<span class="cm"> * @queue: queue to map the corresponding interrupt to</span>
<span class="cm"> * @msix_vector: the vector to map to the corresponding queue</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_set_ivar</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">s8</span> <span class="n">direction</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">queue</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">msix_vector</span> <span class="o">|=</span> <span class="n">IXGBE_IVAR_ALLOC_VAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(((</span><span class="n">direction</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="n">queue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
		<span class="n">ivar</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_IVAR</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
		<span class="n">ivar</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)));</span>
		<span class="n">ivar</span> <span class="o">|=</span> <span class="p">(</span><span class="n">msix_vector</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)));</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_IVAR</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">ivar</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* other causes */</span>
			<span class="n">msix_vector</span> <span class="o">|=</span> <span class="n">IXGBE_IVAR_ALLOC_VAL</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">((</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">ivar</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_IVAR_MISC</span><span class="p">);</span>
			<span class="n">ivar</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">ivar</span> <span class="o">|=</span> <span class="p">(</span><span class="n">msix_vector</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_IVAR_MISC</span><span class="p">,</span> <span class="n">ivar</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* tx or rx causes */</span>
			<span class="n">msix_vector</span> <span class="o">|=</span> <span class="n">IXGBE_IVAR_ALLOC_VAL</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">((</span><span class="mi">16</span> <span class="o">*</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">direction</span><span class="p">));</span>
			<span class="n">ivar</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_IVAR</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">ivar</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">ivar</span> <span class="o">|=</span> <span class="p">(</span><span class="n">msix_vector</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_IVAR</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ivar</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_irq_rearm_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					  <span class="n">u64</span> <span class="n">qmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">IXGBE_EIMS_RTX_QUEUE</span> <span class="o">&amp;</span> <span class="n">qmask</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICS</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">qmask</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICS_EX</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">qmask</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICS_EX</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ixgbe_unmap_and_free_tx_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">),</span>
					 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
					 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">),</span>
			       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
			       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">next_to_watch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* tx_buffer must be completely set up in the transmit path */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_xoff_rx_lfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw_stats</span> <span class="o">*</span><span class="n">hwstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span> <span class="o">!=</span> <span class="n">ixgbe_fc_full</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span> <span class="o">!=</span> <span class="n">ixgbe_fc_rx_pause</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LXOFFRXC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LXOFFRXCNT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">lxoffrxc</span> <span class="o">+=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* refill credits (no tx hang) if we received xoff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_HANG_CHECK_ARMED</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_xoff_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw_stats</span> <span class="o">*</span><span class="n">hwstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xoff</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pfc_en</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">)</span>
		<span class="n">pfc_en</span> <span class="o">|=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pfc_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_update_xoff_rx_lfc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update stats for each tc, only valid with PFC enabled */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_PACKET_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
			<span class="n">xoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PXOFFRXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">xoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PXOFFRXCNT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">pxoffrxc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xoff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* disarm tx queues that have received xoff frames */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dcb_tc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span><span class="p">[</span><span class="n">tc</span><span class="p">])</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_HANG_CHECK_ARMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ixgbe_get_tx_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ixgbe_get_tx_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">head</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDH</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDT</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="n">tail</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">head</span> <span class="o">&lt;</span> <span class="n">tail</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">tail</span> <span class="o">-</span> <span class="n">head</span> <span class="o">:</span> <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ixgbe_check_tx_hang</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tx_done</span> <span class="o">=</span> <span class="n">ixgbe_get_tx_completed</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tx_done_old</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">tx_done_old</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_pending</span> <span class="o">=</span> <span class="n">ixgbe_get_tx_pending</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">clear_check_for_tx_hang</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for a hung queue, but be thorough. This verifies</span>
<span class="cm">	 * that a transmit has been completed since the previous</span>
<span class="cm">	 * check AND there is at least one packet pending. The</span>
<span class="cm">	 * ARMED bit is set to indicate a potential hang. The</span>
<span class="cm">	 * bit is cleared if a pause frame is received to remove</span>
<span class="cm">	 * false hang detection due to PFC or 802.3x frames. By</span>
<span class="cm">	 * requiring this to fail twice we avoid races with</span>
<span class="cm">	 * pfc clearing the ARMED bit and conditions where we</span>
<span class="cm">	 * run the check_tx_hang logic with a transmit completion</span>
<span class="cm">	 * pending but without time to complete it yet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tx_done_old</span> <span class="o">==</span> <span class="n">tx_done</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tx_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make sure it is true for two checks in a row */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_HANG_CHECK_ARMED</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* update completed stats and continue */</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">tx_done_old</span> <span class="o">=</span> <span class="n">tx_done</span><span class="p">;</span>
		<span class="cm">/* reset the countdown */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_HANG_CHECK_ARMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_tx_timeout_reset - initiate reset due to Tx timeout</span>
<span class="cm"> * @adapter: driver private struct</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_tx_timeout_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Do the reset outside of interrupt context */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_RESET_REQUESTED</span><span class="p">;</span>
		<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_clean_tx_irq - Reclaim resources after transmit completes</span>
<span class="cm"> * @q_vector: structure containing interrupt and ring information</span>
<span class="cm"> * @tx_ring: tx ring to clean</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ixgbe_clean_tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">budget</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">work_limit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">tx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">-=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span> <span class="o">*</span><span class="n">eop_desc</span> <span class="o">=</span> <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">next_to_watch</span><span class="p">;</span>

		<span class="cm">/* if next_to_watch is not set then there is no work pending */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eop_desc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* prevent any other reads prior to eop_desc */</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="cm">/* if DD is not set pending work has not been completed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eop_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_TXD_STAT_DD</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* clear next_to_watch to prevent false hangs */</span>
		<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">next_to_watch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* update the statistics for this packet */</span>
		<span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">bytecount</span><span class="p">;</span>
		<span class="n">total_packets</span> <span class="o">+=</span> <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">gso_segs</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span>
			     <span class="n">IXGBE_TX_FLAGS_TSTAMP</span><span class="p">))</span>
			<span class="n">ixgbe_ptp_tx_hwtstamp</span><span class="p">(</span><span class="n">q_vector</span><span class="p">,</span>
					      <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

<span class="cp">#endif</span>
		<span class="cm">/* free the skb */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* unmap skb header data */</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">),</span>
				 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="cm">/* clear tx_buffer data */</span>
		<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* unmap remaining buffers */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tx_desc</span> <span class="o">!=</span> <span class="n">eop_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_buffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">-=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
				<span class="n">tx_buffer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">;</span>
				<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* unmap any remaining paged data */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">),</span>
					       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
					       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
				<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* move us one more past the eop_desc for start of next pkt */</span>
		<span class="n">tx_buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
			<span class="n">tx_buffer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">;</span>
			<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* issue prefetch for next Tx descriptor */</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">tx_desc</span><span class="p">);</span>

		<span class="cm">/* update budget accounting */</span>
		<span class="n">budget</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">budget</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span> <span class="o">+=</span> <span class="n">total_packets</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">total_packets</span> <span class="o">+=</span> <span class="n">total_packets</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_for_tx_hang</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ixgbe_check_tx_hang</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* schedule immediate reset if we believe we hung */</span>
		<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;Detected Tx Unit Hang</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  Tx Queue             &lt;%d&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  TDH, TDT             &lt;%x&gt;, &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  next_to_use          &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  next_to_clean        &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;tx_buffer_info[next_to_clean]</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  time_stamp           &lt;%lx&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  jiffies              &lt;%lx&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">,</span>
			<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDH</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">)),</span>
			<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDT</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">)),</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time_stamp</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

		<span class="n">netif_stop_subqueue</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>

		<span class="n">e_info</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span>
		       <span class="s">&quot;tx hang %d detected on queue %d, resetting adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>

		<span class="cm">/* schedule immediate reset if we believe we hung */</span>
		<span class="n">ixgbe_tx_timeout_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="cm">/* the adapter is about to reset, no point in enabling stuff */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_tx_completed_queue</span><span class="p">(</span><span class="n">txring_txq</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">),</span>
				  <span class="n">total_packets</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>

<span class="cp">#define TX_WAKE_THRESHOLD (DESC_NEEDED * 2)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">total_packets</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">ixgbe_desc_unused</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TX_WAKE_THRESHOLD</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Make sure that anybody stopping the queue after this</span>
<span class="cm">		 * sees the new next_to_clean.</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__netif_subqueue_stopped</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
					     <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_wake_subqueue</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
					    <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
			<span class="o">++</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">restart_queue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">budget</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_tx_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txctrl</span> <span class="o">=</span> <span class="n">dca3_get_tag</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg_offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="n">IXGBE_DCA_TXCTRL</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="n">IXGBE_DCA_TXCTRL_82599</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">);</span>
		<span class="n">txctrl</span> <span class="o">&lt;&lt;=</span> <span class="n">IXGBE_DCA_TXCTRL_CPUID_SHIFT_82599</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* for unknown hardware do not write register */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can enable relaxed ordering for reads, but not writes when</span>
<span class="cm">	 * DCA is enabled.  This is due to a known issue in some chipsets</span>
<span class="cm">	 * which will cause the DCA tag to be cleared.</span>
<span class="cm">	 */</span>
	<span class="n">txctrl</span> <span class="o">|=</span> <span class="n">IXGBE_DCA_TXCTRL_DESC_RRO_EN</span> <span class="o">|</span>
		  <span class="n">IXGBE_DCA_TXCTRL_DATA_RRO_EN</span> <span class="o">|</span>
		  <span class="n">IXGBE_DCA_TXCTRL_DESC_DCA_EN</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">txctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_rx_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxctrl</span> <span class="o">=</span> <span class="n">dca3_get_tag</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">rxctrl</span> <span class="o">&lt;&lt;=</span> <span class="n">IXGBE_DCA_RXCTRL_CPUID_SHIFT_82599</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can enable relaxed ordering for reads, but not writes when</span>
<span class="cm">	 * DCA is enabled.  This is due to a known issue in some chipsets</span>
<span class="cm">	 * which will cause the DCA tag to be cleared.</span>
<span class="cm">	 */</span>
	<span class="n">rxctrl</span> <span class="o">|=</span> <span class="n">IXGBE_DCA_RXCTRL_DESC_RRO_EN</span> <span class="o">|</span>
		  <span class="n">IXGBE_DCA_RXCTRL_DATA_DCA_EN</span> <span class="o">|</span>
		  <span class="n">IXGBE_DCA_RXCTRL_DESC_DCA_EN</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_RXCTRL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">rxctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_update</span><span class="p">;</span>

	<span class="n">ixgbe_for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span>
		<span class="n">ixgbe_update_tx_dca</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">ixgbe_for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
		<span class="n">ixgbe_update_rx_dca</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
<span class="nl">out_no_update:</span>
	<span class="n">put_cpu</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_setup_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_q_vectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* always use CB2 mode, difference is masked in the CB driver */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span>
		<span class="n">num_q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_q_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_q_vectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ixgbe_update_dca</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ixgbe_notify_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCA_CAPABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCA_PROVIDER_ADD</span>:
		<span class="cm">/* if we&#39;re already enabled, don&#39;t do it again */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dca_add_requester</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">;</span>
			<span class="n">ixgbe_setup_dca</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fall Through since DCA is disabled. */</span>
	<span class="k">case</span> <span class="n">DCA_PROVIDER_REMOVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dca_remove_requester</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_DCA */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_rx_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">lower</span><span class="p">.</span><span class="n">hi_dword</span><span class="p">.</span><span class="n">rss</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
<span class="cm">/**</span>
<span class="cm"> * ixgbe_rx_is_fcoe - check the rx desc for incoming pkt type</span>
<span class="cm"> * @ring: structure containing ring specific data</span>
<span class="cm"> * @rx_desc: advanced rx descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns : true if it is FCoE pkt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ixgbe_rx_is_fcoe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">pkt_info</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">lower</span><span class="p">.</span><span class="n">lo_dword</span><span class="p">.</span><span class="n">hs_rss</span><span class="p">.</span><span class="n">pkt_info</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_RX_FCOE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span><span class="n">pkt_info</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IXGBE_RXDADV_PKTTYPE_ETQF_MASK</span><span class="p">))</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IXGBE_ETQF_FILTER_FCOE</span> <span class="o">&lt;&lt;</span>
			     <span class="n">IXGBE_RXDADV_PKTTYPE_ETQF_SHIFT</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
<span class="cm">/**</span>
<span class="cm"> * ixgbe_rx_checksum - indicate in skb if hw indicated a good cksum</span>
<span class="cm"> * @ring: structure containing ring specific data</span>
<span class="cm"> * @rx_desc: current Rx descriptor being processed</span>
<span class="cm"> * @skb: skb currently being received and modified</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_rx_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				     <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Rx csum disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if IP and error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXD_STAT_IPCS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXDADV_ERR_IPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">csum_err</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXD_STAT_L4CS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXDADV_ERR_TCPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">pkt_info</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">lower</span><span class="p">.</span><span class="n">lo_dword</span><span class="p">.</span><span class="n">hs_rss</span><span class="p">.</span><span class="n">pkt_info</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * 82599 errata, UDP frames with a 0 checksum can be marked as</span>
<span class="cm">		 * checksum errors.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pkt_info</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IXGBE_RXDADV_PKTTYPE_UDP</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_RX_CSUM_UDP_ZERO_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">csum_err</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It must be a TCP or UDP packet with a valid checksum */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_release_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* update next to alloc since we have filled the ring */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_alloc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Force memory writes to complete before letting h/w</span>
<span class="cm">	 * know there are new descriptors to fetch.  (Only</span>
<span class="cm">	 * applicable for weak-ordered memory model archs,</span>
<span class="cm">	 * such as IA-64).</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ixgbe_alloc_mapped_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* since we are recycling buffers we should seldom need to alloc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dma</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* alloc new page for storage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">__GFP_COLD</span> <span class="o">|</span> <span class="n">__GFP_COMP</span><span class="p">,</span>
				   <span class="n">ixgbe_rx_pg_order</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">alloc_rx_page_failed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* map page for use */</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">ixgbe_rx_pg_size</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if mapping failed free memory back to system since</span>
<span class="cm">	 * there isn&#39;t much point in holding memory we can&#39;t use</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__free_pages</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">ixgbe_rx_pg_order</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">));</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">alloc_rx_page_failed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">^=</span> <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_alloc_rx_buffers - Replace used receive buffers</span>
<span class="cm"> * @rx_ring: ring to place buffers on</span>
<span class="cm"> * @cleaned_count: number of buffers to replace</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">ixgbe_alloc_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cleaned_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>

	<span class="cm">/* nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cleaned_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">IXGBE_RX_DESC</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">bi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">i</span> <span class="o">-=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgbe_alloc_mapped_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">bi</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Refresh the desc even if buffer_addrs didn&#39;t change</span>
<span class="cm">		 * because each write-back erases this info.</span>
<span class="cm">		 */</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">pkt_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">);</span>

		<span class="n">rx_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bi</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">IXGBE_RX_DESC</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear the hdr_addr for the next_to_use descriptor */</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">hdr_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cleaned_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cleaned_count</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">ixgbe_release_rx_desc</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_get_headlen - determine size of header for RSC/LRO/GRO/FCOE</span>
<span class="cm"> * @data: pointer to the start of the headers</span>
<span class="cm"> * @max_len: total length of section to find headers in</span>
<span class="cm"> *</span>
<span class="cm"> * This function is meant to determine the length of headers that will</span>
<span class="cm"> * be recognized by hardware for LRO, GRO, and RSC offloads.  The main</span>
<span class="cm"> * motivation of doing this is to only perform one pull for IPv4 TCP</span>
<span class="cm"> * packets so that we can do basic things like calculating the gso_size</span>
<span class="cm"> * based on the average data per packet.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ixgbe_get_headlen</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">network</span><span class="p">;</span>
		<span class="cm">/* l2 headers */</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vlan_hdr</span> <span class="o">*</span><span class="n">vlan</span><span class="p">;</span>
		<span class="cm">/* l3 headers */</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ipv4</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nexthdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default to not TCP */</span>
	<span class="n">u8</span> <span class="n">hlen</span><span class="p">;</span>

	<span class="cm">/* this should never happen, but better safe than sorry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">max_len</span><span class="p">;</span>

	<span class="cm">/* initialize network frame pointer */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* set first protocol and move network header forward */</span>
	<span class="n">protocol</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">+=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="cm">/* handle any vlan tag if present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="n">VLAN_HLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">max_len</span><span class="p">;</span>

		<span class="n">protocol</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">+=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle L3 protocols */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">max_len</span><span class="p">;</span>

		<span class="cm">/* access ihl as a u8 to avoid unaligned access on ia64 */</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* verify hlen meets minimum size requirements */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>

		<span class="cm">/* record next protocol */</span>
		<span class="n">nexthdr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">+=</span> <span class="n">hlen</span><span class="p">;</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="n">FCOE_HEADER_LEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">max_len</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">+=</span> <span class="n">FCOE_HEADER_LEN</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* finally sort out TCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nexthdr</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">max_len</span><span class="p">;</span>

		<span class="cm">/* access doff as a u8 to avoid unaligned access on ia64 */</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* verify hlen meets minimum size requirements */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">+=</span> <span class="n">hlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If everything has gone correctly hdr.network should be the</span>
<span class="cm">	 * data section of the packet and will be the end of the header.</span>
<span class="cm">	 * If not then it probably represents the end of the last recognized</span>
<span class="cm">	 * header.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">max_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_get_rsc_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">rsc_enabled</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rsc_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring_is_rsc_enabled</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rsc_enabled</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">lower</span><span class="p">.</span><span class="n">lo_dword</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;</span>
		      <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_RXDADV_RSCCNT_MASK</span><span class="p">);</span>

	<span class="cm">/* If this is an RSC frame rsc_cnt should be non-zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsc_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rsc_cnt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsc_enabled</span><span class="p">);</span>
	<span class="n">rsc_cnt</span> <span class="o">&gt;&gt;=</span> <span class="n">IXGBE_RXDADV_RSCCNT_SHIFT</span><span class="p">;</span>

	<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">append_cnt</span> <span class="o">+=</span> <span class="n">rsc_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_set_rsc_gso_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* set gso_size to avoid messing up TCP MSS */</span>
	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">),</span>
						 <span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">append_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_rsc_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if append_cnt is 0 then frame is not RSC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">append_cnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">rsc_count</span> <span class="o">+=</span> <span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">append_cnt</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">rsc_flush</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ixgbe_set_rsc_gso_size</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* gso_size is computed using append_cnt so always clear it last */</span>
	<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">append_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_process_skb_fields - Populate skb header fields from Rx descriptor</span>
<span class="cm"> * @rx_ring: rx descriptor ring packet is being transacted on</span>
<span class="cm"> * @rx_desc: pointer to the EOP Rx descriptor</span>
<span class="cm"> * @skb: pointer to current skb being populated</span>
<span class="cm"> *</span>
<span class="cm"> * This function checks the ring, descriptor, and packet information in</span>
<span class="cm"> * order to populate the hash, checksum, VLAN, timestamp, protocol, and</span>
<span class="cm"> * other fields within the skb.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_process_skb_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				     <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">ixgbe_update_rsc_stats</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ixgbe_rx_hash</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ixgbe_rx_checksum</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXDADV_STAT_TS</span><span class="p">))</span>
		<span class="n">ixgbe_ptp_rx_hwtstamp</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXD_STAT_VP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">upper</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_IN_NETPOLL</span><span class="p">))</span>
		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_is_non_eop - process handling of non-EOP buffers</span>
<span class="cm"> * @rx_ring: Rx ring being processed</span>
<span class="cm"> * @rx_desc: Rx descriptor for current buffer</span>
<span class="cm"> * @skb: Current socket buffer containing buffer in progress</span>
<span class="cm"> *</span>
<span class="cm"> * This function updates next to clean.  If the buffer is an EOP buffer</span>
<span class="cm"> * this function exits returning false, otherwise it will place the</span>
<span class="cm"> * sk_buff in the next buffer to be chained and return true indicating</span>
<span class="cm"> * that this is in fact a non-EOP buffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ixgbe_is_non_eop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ntc</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* fetch, update, and store next to clean */</span>
	<span class="n">ntc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntc</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">?</span> <span class="n">ntc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="n">ntc</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">IXGBE_RX_DESC</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">ntc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXD_STAT_EOP</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* append_cnt indicates packet is RSC, if so fetch nextp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">append_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ntc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">upper</span><span class="p">.</span><span class="n">status_error</span><span class="p">);</span>
		<span class="n">ntc</span> <span class="o">&amp;=</span> <span class="n">IXGBE_RXDADV_NEXTP_MASK</span><span class="p">;</span>
		<span class="n">ntc</span> <span class="o">&gt;&gt;=</span> <span class="n">IXGBE_RXDADV_NEXTP_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* place skb in next buffer to be received */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">ntc</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">non_eop_descs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_cleanup_headers - Correct corrupted or empty headers</span>
<span class="cm"> * @rx_ring: rx descriptor ring packet is being transacted on</span>
<span class="cm"> * @rx_desc: pointer to the EOP Rx descriptor</span>
<span class="cm"> * @skb: pointer to current skb being fixed</span>
<span class="cm"> *</span>
<span class="cm"> * Check for corrupted packet headers caused by senders on the local L2</span>
<span class="cm"> * embedded NIC switch not setting up their Tx Descriptors right.  These</span>
<span class="cm"> * should be very rare.</span>
<span class="cm"> *</span>
<span class="cm"> * Also address the case where we are pulling data in on pages only</span>
<span class="cm"> * and as such no data is present in the skb header.</span>
<span class="cm"> *</span>
<span class="cm"> * In addition if skb is not at least 60 bytes we need to pad it so that</span>
<span class="cm"> * it is large enough to qualify as a valid Ethernet frame.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if an error was encountered and skb was freed.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ixgbe_cleanup_headers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pull_len</span><span class="p">;</span>

	<span class="cm">/* if the page was released unmap it, else just sync our portion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">page_released</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			       <span class="n">ixgbe_rx_pg_size</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">page_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_range_for_cpu</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					      <span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span>
					      <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span>
					      <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* verify that the packet does not have any known errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span>
					<span class="n">IXGBE_RXDADV_ERR_FRAME_ERR_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * it is valid to use page_address instead of kmap since we are</span>
<span class="cm">	 * working with pages allocated out of the lomem pool per</span>
<span class="cm">	 * alloc_page(GFP_ATOMIC)</span>
<span class="cm">	 */</span>
	<span class="n">va</span> <span class="o">=</span> <span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * we need the header to contain the greater of either ETH_HLEN or</span>
<span class="cm">	 * 60 bytes if the skb-&gt;len is less than 60 for skb_pad.</span>
<span class="cm">	 */</span>
	<span class="n">pull_len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pull_len</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">pull_len</span> <span class="o">=</span> <span class="n">ixgbe_get_headlen</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">pull_len</span><span class="p">);</span>

	<span class="cm">/* align pull length to size of long to optimize memcpy performance */</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">pull_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)));</span>

	<span class="cm">/* update all of the pointers */</span>
	<span class="n">skb_frag_size_sub</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">pull_len</span><span class="p">);</span>
	<span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">+=</span> <span class="n">pull_len</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">-=</span> <span class="n">pull_len</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">pull_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we sucked the frag empty then we should free it,</span>
<span class="cm">	 * if there are other frags here something is screwed up in hardware</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__skb_frag_unref</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">-=</span> <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="cm">/* do not attempt to pad FCoE Frames as this will disrupt DDP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_rx_is_fcoe</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="cp">#endif</span>
	<span class="cm">/* if skb_pad returns an error the skb was freed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pad_len</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_pad</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pad_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pad_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_can_reuse_page - determine if we can reuse a page</span>
<span class="cm"> * @rx_buffer: pointer to rx_buffer containing the page we want to reuse</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if page can be reused in another Rx buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ixgbe_can_reuse_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">rx_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>

	<span class="cm">/* if we are only owner of page and it is local we can reuse it */</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="n">page_count</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="n">likely</span><span class="p">(</span><span class="n">page_to_nid</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="n">numa_node_id</span><span class="p">());</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_reuse_rx_page - page flip buffer and store it back on the ring</span>
<span class="cm"> * @rx_ring: rx descriptor ring to store buffers on</span>
<span class="cm"> * @old_buff: donor buffer to have page reused</span>
<span class="cm"> *</span>
<span class="cm"> * Syncronizes page for reuse by the adapter</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_reuse_rx_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">old_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">new_buff</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nta</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_alloc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bufsz</span> <span class="o">=</span> <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">new_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">nta</span><span class="p">];</span>

	<span class="cm">/* update, and store next to alloc */</span>
	<span class="n">nta</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">nta</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">?</span> <span class="n">nta</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* transfer page from old buffer to new buffer */</span>
	<span class="n">new_buff</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">old_buff</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="n">new_buff</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">old_buff</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* flip page offset to other buffer and store to new_buff */</span>
	<span class="n">new_buff</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">old_buff</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">^</span> <span class="n">bufsz</span><span class="p">;</span>

	<span class="cm">/* sync the buffer for use by the device */</span>
	<span class="n">dma_sync_single_range_for_device</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">new_buff</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					 <span class="n">new_buff</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span> <span class="n">bufsz</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="cm">/* bump ref count on page before it is given to the stack */</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">new_buff</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_add_rx_frag - Add contents of Rx buffer to sk_buff</span>
<span class="cm"> * @rx_ring: rx descriptor ring to transact packets on</span>
<span class="cm"> * @rx_buffer: buffer containing page to add</span>
<span class="cm"> * @rx_desc: descriptor containing length of buffer written by hardware</span>
<span class="cm"> * @skb: sk_buff to place the data into</span>
<span class="cm"> *</span>
<span class="cm"> * This function is based on skb_add_rx_frag.  I would have used that</span>
<span class="cm"> * function however it doesn&#39;t handle the truesize case correctly since we</span>
<span class="cm"> * are allocating more memory than might be used for a single receive.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_add_rx_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">rx_buffer</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span>
			   <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span>
			   <span class="n">size</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_clean_rx_irq - Clean completed descriptors from Rx ring - bounce buf</span>
<span class="cm"> * @q_vector: structure containing interrupt and ring information</span>
<span class="cm"> * @rx_ring: rx descriptor ring to transact packets on</span>
<span class="cm"> * @budget: Total limit on number of packets to process</span>
<span class="cm"> *</span>
<span class="cm"> * This function provides a &quot;bounce buffer&quot; approach to Rx interrupt</span>
<span class="cm"> * processing.  The advantage to this is that on systems that have</span>
<span class="cm"> * expensive overhead for IOMMU access this provides a means of avoiding</span>
<span class="cm"> * it by maintaining the mapping of the page to the syste.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if all work is completed without reaching budget</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ixgbe_clean_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_rx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_rx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ddp_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="n">u16</span> <span class="n">cleaned_count</span> <span class="o">=</span> <span class="n">ixgbe_desc_unused</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">rx_buffer</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ntc</span><span class="p">;</span>

		<span class="cm">/* return some buffers to hardware, one at a time is too slow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cleaned_count</span> <span class="o">&gt;=</span> <span class="n">IXGBE_RX_BUFFER_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ixgbe_alloc_rx_buffers</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">cleaned_count</span><span class="p">);</span>
			<span class="n">cleaned_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ntc</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">;</span>
		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">IXGBE_RX_DESC</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">ntc</span><span class="p">);</span>
		<span class="n">rx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">ntc</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgbe_test_staterr</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">IXGBE_RXD_STAT_DD</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This memory barrier is needed to keep us from reading</span>
<span class="cm">		 * any other fields out of the rx_desc until we know the</span>
<span class="cm">		 * RXD_STAT_DD bit is set</span>
<span class="cm">		 */</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span>
					  <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>

			<span class="cm">/* prefetch first cache line of first page */</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="n">page_addr</span><span class="p">);</span>
<span class="cp">#if L1_CACHE_BYTES &lt; 128</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="n">page_addr</span> <span class="o">+</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="cm">/* allocate a skb to store the frags */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
							<span class="n">IXGBE_RX_HDR_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">alloc_rx_buff_failed</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * we will be copying header into skb-&gt;data in</span>
<span class="cm">			 * pskb_may_pull so it is in our interest to prefetch</span>
<span class="cm">			 * it now to avoid a possible cache miss</span>
<span class="cm">			 */</span>
			<span class="n">prefetchw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Delay unmapping of the first packet. It carries the</span>
<span class="cm">			 * header information, HW may still access the header</span>
<span class="cm">			 * after the writeback.  Only unmap it when EOP is</span>
<span class="cm">			 * reached</span>
<span class="cm">			 */</span>
			<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* we are reusing so sync this buffer for CPU use */</span>
			<span class="n">dma_sync_single_range_for_cpu</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
						      <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span>
						      <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span>
						      <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* pull page into skb */</span>
		<span class="n">ixgbe_add_rx_frag</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_buffer</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">upper</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_can_reuse_page</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* hand second half of page back to the ring */</span>
			<span class="n">ixgbe_reuse_rx_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_buffer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the page has been released from the ring */</span>
			<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">page_released</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* we are not reusing the buffer so unmap it */</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				       <span class="n">ixgbe_rx_pg_size</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span>
				       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* clear contents of buffer_info */</span>
		<span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ixgbe_get_rsc_cnt</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">cleaned_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* place incomplete frames back on ring for completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_is_non_eop</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* verify the packet layout is correct */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_cleanup_headers</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* probably a little skewed due to removing CRC */</span>
		<span class="n">total_rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">total_rx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* populate checksum, timestamp, VLAN, and protocol */</span>
		<span class="n">ixgbe_process_skb_fields</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
		<span class="cm">/* if ddp, not passing to ULD unless for FCP_RSP or error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_rx_is_fcoe</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ddp_bytes</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_ddp</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddp_bytes</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
		<span class="n">ixgbe_rx_skb</span><span class="p">(</span><span class="n">q_vector</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* update budget accounting */</span>
		<span class="n">budget</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">budget</span><span class="p">));</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="cm">/* include DDPed FCoE data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddp_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mss</span><span class="p">;</span>

		<span class="n">mss</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mss</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
			<span class="n">mss</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">511</span><span class="p">;</span>
		<span class="n">total_rx_bytes</span> <span class="o">+=</span> <span class="n">ddp_bytes</span><span class="p">;</span>
		<span class="n">total_rx_packets</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ddp_bytes</span><span class="p">,</span> <span class="n">mss</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span> <span class="o">+=</span> <span class="n">total_rx_packets</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">total_rx_bytes</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">total_packets</span> <span class="o">+=</span> <span class="n">total_rx_packets</span><span class="p">;</span>
	<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">total_rx_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cleaned_count</span><span class="p">)</span>
		<span class="n">ixgbe_alloc_rx_buffers</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">cleaned_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">budget</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_configure_msix - Configure MSI-X hardware</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_configure_msix sets up the hardware to properly generate MSI-X</span>
<span class="cm"> * interrupts.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_configure_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_vectors</span><span class="p">,</span> <span class="n">v_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span>

	<span class="cm">/* Populate MSIX to EITR Select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">eitrsel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">-</span> <span class="mi">32</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EITRSEL</span><span class="p">,</span> <span class="n">eitrsel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Populate the IVAR table and set the ITR values to the</span>
<span class="cm">	 * corresponding register.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">v_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">v_idx</span> <span class="o">&lt;</span> <span class="n">q_vectors</span><span class="p">;</span> <span class="n">v_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">v_idx</span><span class="p">];</span>

		<span class="n">ixgbe_for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">ixgbe_set_ivar</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">,</span> <span class="n">v_idx</span><span class="p">);</span>

		<span class="n">ixgbe_for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span>
			<span class="n">ixgbe_set_ivar</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">,</span> <span class="n">v_idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">ring</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* tx only vector */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_itr_setting</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">IXGBE_10K_ITR</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_itr_setting</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* rx or rx/tx vector */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">IXGBE_20K_ITR</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ixgbe_write_eitr</span><span class="p">(</span><span class="n">q_vector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">ixgbe_set_ivar</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">IXGBE_IVAR_OTHER_CAUSES_INDEX</span><span class="p">,</span>
			       <span class="n">v_idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">ixgbe_set_ivar</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v_idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EITR</span><span class="p">(</span><span class="n">v_idx</span><span class="p">),</span> <span class="mi">1950</span><span class="p">);</span>

	<span class="cm">/* set up to autoclear timer, and the vectors */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">IXGBE_EIMS_ENABLE_MASK</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_EIMS_OTHER</span> <span class="o">|</span>
		  <span class="n">IXGBE_EIMS_MAILBOX</span> <span class="o">|</span>
		  <span class="n">IXGBE_EIMS_LSC</span><span class="p">);</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIAC</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">latency_range</span> <span class="p">{</span>
	<span class="n">lowest_latency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">low_latency</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">bulk_latency</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">latency_invalid</span> <span class="o">=</span> <span class="mi">255</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_update_itr - update the dynamic ITR value based on statistics</span>
<span class="cm"> * @q_vector: structure containing interrupt and ring information</span>
<span class="cm"> * @ring_container: structure containing ring performance data</span>
<span class="cm"> *</span>
<span class="cm"> *      Stores a new ITR value based on packets and byte</span>
<span class="cm"> *      counts during the last interrupt.  The advantage of per interrupt</span>
<span class="cm"> *      computation is faster updates and more accurate ITR for the current</span>
<span class="cm"> *      traffic pattern.  Constants in this function were computed</span>
<span class="cm"> *      based on theoretical maximum wire speed and thresholds were set based</span>
<span class="cm"> *      on testing data as well as attempting to minimize response time</span>
<span class="cm"> *      while increasing bulk throughput.</span>
<span class="cm"> *      this functionality is controlled by the InterruptThrottleRate module</span>
<span class="cm"> *      parameter (see ixgbe_param.c)</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_update_itr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ixgbe_ring_container</span> <span class="o">*</span><span class="n">ring_container</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ring_container</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">packets</span> <span class="o">=</span> <span class="n">ring_container</span><span class="o">-&gt;</span><span class="n">total_packets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timepassed_us</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bytes_perint</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">itr_setting</span> <span class="o">=</span> <span class="n">ring_container</span><span class="o">-&gt;</span><span class="n">itr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* simple throttlerate management</span>
<span class="cm">	 *   0-10MB/s   lowest (100000 ints/s)</span>
<span class="cm">	 *  10-20MB/s   low    (20000 ints/s)</span>
<span class="cm">	 *  20-1249MB/s bulk   (8000 ints/s)</span>
<span class="cm">	 */</span>
	<span class="cm">/* what was last interrupt timeslice? */</span>
	<span class="n">timepassed_us</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">bytes_perint</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">timepassed_us</span><span class="p">;</span> <span class="cm">/* bytes/usec */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">itr_setting</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">lowest_latency</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_perint</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">itr_setting</span> <span class="o">=</span> <span class="n">low_latency</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">low_latency</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_perint</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">itr_setting</span> <span class="o">=</span> <span class="n">bulk_latency</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bytes_perint</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">itr_setting</span> <span class="o">=</span> <span class="n">lowest_latency</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">bulk_latency</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_perint</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">itr_setting</span> <span class="o">=</span> <span class="n">low_latency</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear work counters since we have the values we need */</span>
	<span class="n">ring_container</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring_container</span><span class="o">-&gt;</span><span class="n">total_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* write updated itr to ring container */</span>
	<span class="n">ring_container</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">itr_setting</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_write_eitr - write EITR register in hardware specific way</span>
<span class="cm"> * @q_vector: structure containing interrupt and ring information</span>
<span class="cm"> *</span>
<span class="cm"> * This function is made to be called by ethtool and by the driver</span>
<span class="cm"> * when it needs to update EITR registers at runtime.  Hardware</span>
<span class="cm"> * specific quirks/differences are taken care of here.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ixgbe_write_eitr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v_idx</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">v_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">itr_reg</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">&amp;</span> <span class="n">IXGBE_MAX_EITR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="cm">/* must write high and low 16 bits to reset counter */</span>
		<span class="n">itr_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">itr_reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="cm">/*</span>
<span class="cm">		 * set the WDIS bit to not clear the timer bits and cause an</span>
<span class="cm">		 * immediate assertion of the interrupt</span>
<span class="cm">		 */</span>
		<span class="n">itr_reg</span> <span class="o">|=</span> <span class="n">IXGBE_EITR_CNT_WDIS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EITR</span><span class="p">(</span><span class="n">v_idx</span><span class="p">),</span> <span class="n">itr_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_set_itr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">new_itr</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_itr</span><span class="p">;</span>

	<span class="n">ixgbe_update_itr</span><span class="p">(</span><span class="n">q_vector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="n">ixgbe_update_itr</span><span class="p">(</span><span class="n">q_vector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

	<span class="n">current_itr</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">itr</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">itr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">current_itr</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* counts and packets in update_itr are dependent on these numbers */</span>
	<span class="k">case</span> <span class="n">lowest_latency</span>:
		<span class="n">new_itr</span> <span class="o">=</span> <span class="n">IXGBE_100K_ITR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">low_latency</span>:
		<span class="n">new_itr</span> <span class="o">=</span> <span class="n">IXGBE_20K_ITR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">bulk_latency</span>:
		<span class="n">new_itr</span> <span class="o">=</span> <span class="n">IXGBE_8K_ITR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_itr</span> <span class="o">!=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do an exponential smoothing */</span>
		<span class="n">new_itr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">new_itr</span> <span class="o">*</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span><span class="p">)</span> <span class="o">/</span>
			  <span class="p">((</span><span class="mi">9</span> <span class="o">*</span> <span class="n">new_itr</span><span class="p">)</span> <span class="o">+</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span><span class="p">);</span>

		<span class="cm">/* save the algorithm value here */</span>
		<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">new_itr</span><span class="p">;</span>

		<span class="n">ixgbe_write_eitr</span><span class="p">(</span><span class="n">q_vector</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_check_overtemp_subtask - check for over temperature</span>
<span class="cm"> * @adapter: pointer to adapter</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_check_overtemp_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eicr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">interrupt_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_EVENT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_TEMP_SENSOR_EVENT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82599_T3_LOM</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Since the warning interrupt is for both ports</span>
<span class="cm">		 * we don&#39;t have to check if:</span>
<span class="cm">		 *  - This interrupt wasn&#39;t for our port.</span>
<span class="cm">		 *  - We may have missed the interrupt so always have to</span>
<span class="cm">		 *    check if we  got a LSC</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_GPI_SDP0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_LSC</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_LSC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">autoneg</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autoneg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if this is not due to overtemp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_overtemp</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IXGBE_ERR_OVERTEMP</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_GPI_SDP0</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e_crit</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span>
	       <span class="s">&quot;Network adapter has been stopped because it has over heated. &quot;</span>
	       <span class="s">&quot;Restart the computer. If the problem persists, &quot;</span>
	       <span class="s">&quot;power off the system and replace the adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">interrupt_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_check_fan_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eicr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FAN_FAIL_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_GPI_SDP1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_crit</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;Fan has stopped, replace the adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* write to clear the interrupt */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICR</span><span class="p">,</span> <span class="n">IXGBE_EICR_GPI_SDP1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_check_overtemp_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eicr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_CAPABLE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Need to check link state so complete overtemp check</span>
<span class="cm">		 * on service task</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_GPI_SDP0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_LSC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">interrupt_event</span> <span class="o">=</span> <span class="n">eicr</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_EVENT</span><span class="p">;</span>
			<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_TS</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_crit</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span>
	       <span class="s">&quot;Network adapter has been stopped because it has over heated. &quot;</span>
	       <span class="s">&quot;Restart the computer. If the problem persists, &quot;</span>
	       <span class="s">&quot;power off the system and replace the adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_check_sfp_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eicr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_GPI_SDP2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the interrupt */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICR</span><span class="p">,</span> <span class="n">IXGBE_EICR_GPI_SDP2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">;</span>
			<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_GPI_SDP1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the interrupt */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICR</span><span class="p">,</span> <span class="n">IXGBE_EICR_GPI_SDP1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_NEED_LINK_CONFIG</span><span class="p">;</span>
			<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_check_lsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">lsc_int</span><span class="o">++</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_check_timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC</span><span class="p">,</span> <span class="n">IXGBE_EIMC_LSC</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_irq_enable_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					   <span class="n">u64</span> <span class="n">qmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">IXGBE_EIMS_RTX_QUEUE</span> <span class="o">&amp;</span> <span class="n">qmask</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMS</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">qmask</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMS_EX</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">qmask</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMS_EX</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* skip the flush */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_irq_disable_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="n">u64</span> <span class="n">qmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">IXGBE_EIMS_RTX_QUEUE</span> <span class="o">&amp;</span> <span class="n">qmask</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">qmask</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC_EX</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">qmask</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC_EX</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* skip the flush */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_irq_enable - Enable default interrupt generation settings</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">queues</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">IXGBE_EIMS_ENABLE_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IXGBE_EIMS_RTX_QUEUE</span><span class="p">);</span>

	<span class="cm">/* don&#39;t reenable LSC while waiting for link */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_EIMS_LSC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_CAPABLE</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_GPI_SDP0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_TS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FAN_FAIL_CAPABLE</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_GPI_SDP1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_GPI_SDP1</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_GPI_SDP2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_ECC</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_MAILBOX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_FDIR_REQUIRES_REINIT</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_FLOW_DIR</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMS</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queues</span><span class="p">)</span>
		<span class="n">ixgbe_irq_enable_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ixgbe_msix_other</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eicr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Workaround for Silicon errata.  Use clear-by-write instead</span>
<span class="cm">	 * of clear-by-read.  Reading with EICS will return the</span>
<span class="cm">	 * interrupt causes without clearing, which later be done</span>
<span class="cm">	 * with the write to EICR.</span>
<span class="cm">	 */</span>
	<span class="n">eicr</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICS</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICR</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_LSC</span><span class="p">)</span>
		<span class="n">ixgbe_check_lsc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_MAILBOX</span><span class="p">)</span>
		<span class="n">ixgbe_msg_task</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_ECC</span><span class="p">)</span>
			<span class="n">e_info</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;Received unrecoverable ECC Err, please &quot;</span>
			       <span class="s">&quot;reboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Handle Flow Director Full threshold interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_FLOW_DIR</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reinit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__IXGBE_TX_FDIR_INIT_DONE</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
					<span class="n">reinit_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reinit_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no more flow director interrupts until after init */</span>
				<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC</span><span class="p">,</span> <span class="n">IXGBE_EIMC_FLOW_DIR</span><span class="p">);</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_FDIR_REQUIRES_REINIT</span><span class="p">;</span>
				<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ixgbe_check_sfp_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
		<span class="n">ixgbe_check_overtemp_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_check_fan_failure</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_check_pps_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* re-enable the original interrupt state, no lsc, no queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">ixgbe_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ixgbe_msix_clean_rings</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* EIAM disabled interrupts (on this vector) for us */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ring</span> <span class="o">||</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_poll - NAPI Rx polling callback</span>
<span class="cm"> * @napi: structure for representing this polling device</span>
<span class="cm"> * @budget: how many packets driver is allowed to clean</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used for legacy and MSI, NAPI mode</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">ixgbe_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span>
				<span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ixgbe_q_vector</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">per_ring_budget</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">clean_complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">)</span>
		<span class="n">ixgbe_update_dca</span><span class="p">(</span><span class="n">q_vector</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ixgbe_for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span>
		<span class="n">clean_complete</span> <span class="o">&amp;=</span> <span class="o">!!</span><span class="n">ixgbe_clean_tx_irq</span><span class="p">(</span><span class="n">q_vector</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

	<span class="cm">/* attempt to distribute budget to each queue fairly, but don&#39;t allow</span>
<span class="cm">	 * the budget to go below 1 because we&#39;ll exit polling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">per_ring_budget</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">budget</span><span class="o">/</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">per_ring_budget</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

	<span class="n">ixgbe_for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
		<span class="n">clean_complete</span> <span class="o">&amp;=</span> <span class="n">ixgbe_clean_rx_irq</span><span class="p">(</span><span class="n">q_vector</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span>
						     <span class="n">per_ring_budget</span><span class="p">);</span>

	<span class="cm">/* If all work not completed, return budget and keep polling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clean_complete</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">budget</span><span class="p">;</span>

	<span class="cm">/* all work done, exit the polling mode */</span>
	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ixgbe_set_itr</span><span class="p">(</span><span class="n">q_vector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">ixgbe_irq_enable_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">v_idx</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_request_msix_irqs - Initialize MSI-X interrupts</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_request_msix_irqs allocates MSI-X vectors and requests</span>
<span class="cm"> * interrupts from the kernel.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_request_msix_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vector</span> <span class="o">&lt;</span> <span class="n">q_vectors</span><span class="p">;</span> <span class="n">vector</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">vector</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">vector</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">ring</span> <span class="o">&amp;&amp;</span> <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="s">&quot;%s-%s-%d&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TxRx&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ti</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="s">&quot;%s-%s-%d&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rx&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="s">&quot;%s-%s-%d&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx&quot;</span><span class="p">,</span> <span class="n">ti</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* skip this unused q_vector */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ixgbe_msix_clean_rings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">q_vector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;request_irq failed for MSIX interrupt &quot;</span>
			      <span class="s">&quot;Error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_queue_irqs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If Flow Director is enabled, set interrupt affinity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* assign the mask for this irq */</span>
			<span class="n">irq_set_affinity_hint</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">affinity_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">vector</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			  <span class="n">ixgbe_msix_other</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;request_irq for msix_other failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_queue_irqs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_queue_irqs:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vector</span><span class="o">--</span><span class="p">;</span>
		<span class="n">irq_set_affinity_hint</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">vector</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">vector</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">vector</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">;</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_intr - legacy mode Interrupt Handler</span>
<span class="cm"> * @irq: interrupt number</span>
<span class="cm"> * @data: pointer to a network interface device structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ixgbe_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">eicr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Workaround for silicon errata #26 on 82598.  Mask the interrupt</span>
<span class="cm">	 * before the read of EICR.</span>
<span class="cm">	 */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC</span><span class="p">,</span> <span class="n">IXGBE_IRQ_CLEAR_MASK</span><span class="p">);</span>

	<span class="cm">/* for NAPI, using EIAM to auto-mask tx/rx interrupt bits on read</span>
<span class="cm">	 * therefore no explicit interrupt disable is necessary */</span>
	<span class="n">eicr</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eicr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * shared interrupt alert!</span>
<span class="cm">		 * make sure interrupts are enabled because the read will</span>
<span class="cm">		 * have disabled interrupts due to EIAM</span>
<span class="cm">		 * finish the workaround of silicon errata on 82598.  Unmask</span>
<span class="cm">		 * the interrupt that we masked before the EICR read.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">ixgbe_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* Not our interrupt */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_LSC</span><span class="p">)</span>
		<span class="n">ixgbe_check_lsc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="n">ixgbe_check_sfp_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">eicr</span> <span class="o">&amp;</span> <span class="n">IXGBE_EICR_ECC</span><span class="p">)</span>
			<span class="n">e_info</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;Received unrecoverable ECC err, please &quot;</span>
				     <span class="s">&quot;reboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ixgbe_check_overtemp_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_check_fan_failure</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_check_pps_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eicr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* would disable interrupts here but EIAM disabled it */</span>
	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * re-enable link(maybe) and non-queue interrupts, no flush.</span>
<span class="cm">	 * ixgbe_poll will re-enable the queue interrupts</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">ixgbe_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_request_irq - initialize interrupts</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Attempts to configure interrupts using the best available</span>
<span class="cm"> * capabilities of the hardware and kernel.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_request_msix_irqs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSI_ENABLED</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ixgbe_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ixgbe_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;request_irq failed, Error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">q_vectors</span><span class="p">;</span>

		<span class="n">q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">q_vectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* free only the irqs that were actually requested */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ring</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* clear the affinity_mask in the IRQ descriptor */</span>
			<span class="n">irq_set_affinity_hint</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">);</span>

			<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_irq_disable - Mask off interrupt generation on the NIC</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ixgbe_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC</span><span class="p">,</span> <span class="mh">0xFFFF0000</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC_EX</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMC_EX</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_configure_msi_and_legacy - Initialize PIN (INTA...) and MSI interrupts</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_configure_msi_and_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* rx/tx vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">IXGBE_20K_ITR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span><span class="p">;</span>

	<span class="n">ixgbe_write_eitr</span><span class="p">(</span><span class="n">q_vector</span><span class="p">);</span>

	<span class="n">ixgbe_set_ivar</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ixgbe_set_ivar</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">e_info</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Legacy interrupt IVAR setup done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_configure_tx_ring - Configure 8259x Tx ring after Reset</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> * @ring: structure containing ring specific data</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the Tx descriptor ring after a reset.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">ixgbe_configure_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tdba</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_loop</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txdctl</span> <span class="o">=</span> <span class="n">IXGBE_TXDCTL_ENABLE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>

	<span class="cm">/* disable queue to avoid issues while updating state */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDBAL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tdba</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDBAH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="p">(</span><span class="n">tdba</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDLEN</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_addr</span> <span class="o">+</span> <span class="n">IXGBE_TDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set WTHRESH to encourage burst writeback, it should not be set</span>
<span class="cm">	 * higher than 1 when ITR is 0 as it could cause false TX hangs</span>
<span class="cm">	 *</span>
<span class="cm">	 * In order to avoid issues WTHRESH + PTHRESH should always be equal</span>
<span class="cm">	 * to or less than the number of on chip descriptors, which is</span>
<span class="cm">	 * currently 40.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">q_vector</span> <span class="o">||</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">itr</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">txdctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* WTHRESH = 1 */</span>
	<span class="k">else</span>
		<span class="n">txdctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* WTHRESH = 8 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setting PTHRESH to 32 both improves performance</span>
<span class="cm">	 * and avoids a TX hang with DFP enabled</span>
<span class="cm">	 */</span>
	<span class="n">txdctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* HTHRESH = 1 */</span>
		   <span class="mi">32</span><span class="p">;</span>		<span class="cm">/* PTHRESH = 32 */</span>

	<span class="cm">/* reinitialize flowdirector state */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGBE_TX_FDIR_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_HANG_CHECK_ARMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* enable queue */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">txdctl</span><span class="p">);</span>

	<span class="cm">/* TXDCTL.EN will return 0 on 82598 if link is down, so skip it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LINKS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_UP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* poll to verify queue is enabled */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">txdctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait_loop</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">txdctl</span> <span class="o">&amp;</span> <span class="n">IXGBE_TXDCTL_ENABLE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_loop</span><span class="p">)</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;Could not enable Tx Queue %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_setup_mtqc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rttdcs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">netdev_get_num_tc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* disable the arbiter while setting MTQC */</span>
	<span class="n">rttdcs</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RTTDCS</span><span class="p">);</span>
	<span class="n">rttdcs</span> <span class="o">|=</span> <span class="n">IXGBE_RTTDCS_ARBDIS</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RTTDCS</span><span class="p">,</span> <span class="n">rttdcs</span><span class="p">);</span>

	<span class="cm">/* set transmit pool layout */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>:
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MTQC</span><span class="p">,</span>
				<span class="p">(</span><span class="n">IXGBE_MTQC_VT_ENA</span> <span class="o">|</span> <span class="n">IXGBE_MTQC_64VF</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcs</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">IXGBE_MTQC_64Q_1PB</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcs</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">IXGBE_MTQC_RT_ENA</span> <span class="o">|</span> <span class="n">IXGBE_MTQC_4TC_4TQ</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">IXGBE_MTQC_RT_ENA</span> <span class="o">|</span> <span class="n">IXGBE_MTQC_8TC_8TQ</span><span class="p">;</span>

		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MTQC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* Enable Security TX Buffer IFG for multiple pb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SECTXMINIFG</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">IXGBE_SECTX_DCB</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SECTXMINIFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* re-enable the arbiter */</span>
	<span class="n">rttdcs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RTTDCS_ARBDIS</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RTTDCS</span><span class="p">,</span> <span class="n">rttdcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_configure_tx - Configure 8259x Transmit Unit after Reset</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the Tx unit of the MAC after a reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_configure_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmatxctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ixgbe_setup_mtqc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DMATXCTL.EN must be before Tx queues are enabled */</span>
		<span class="n">dmatxctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DMATXCTL</span><span class="p">);</span>
		<span class="n">dmatxctl</span> <span class="o">|=</span> <span class="n">IXGBE_DMATXCTL_TE</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DMATXCTL</span><span class="p">,</span> <span class="n">dmatxctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the HW Tx Head and Tail descriptor pointers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ixgbe_configure_tx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_enable_rx_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srrctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>

	<span class="n">srrctl</span> <span class="o">|=</span> <span class="n">IXGBE_SRRCTL_DROP_EN</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">srrctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_disable_rx_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srrctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>

	<span class="n">srrctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_SRRCTL_DROP_EN</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">srrctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
<span class="kt">void</span> <span class="n">ixgbe_set_rx_drop_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_set_rx_drop_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pfc_en</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">)</span>
		<span class="n">pfc_en</span> <span class="o">|=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should set the drop enable bit if:</span>
<span class="cm">	 *  SR-IOV is enabled</span>
<span class="cm">	 *   or</span>
<span class="cm">	 *  Number of Rx queues &gt; 1 and flow control is disabled</span>
<span class="cm">	 *</span>
<span class="cm">	 *  This allows us to avoid head of line blocking for security</span>
<span class="cm">	 *  and performance reasons.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">||</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span> <span class="o">&amp;</span> <span class="n">ixgbe_fc_tx_pause</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pfc_en</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ixgbe_enable_rx_drop</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ixgbe_disable_rx_drop</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define IXGBE_SRRCTL_BSIZEHDRSIZE_SHIFT 2</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure_srrctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">srrctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring_feature</span> <span class="o">*</span><span class="n">feature</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">RING_F_RSS</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">reg_idx</span> <span class="o">=</span> <span class="n">reg_idx</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">srrctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>

	<span class="n">srrctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_SRRCTL_BSIZEHDR_MASK</span><span class="p">;</span>
	<span class="n">srrctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_SRRCTL_BSIZEPKT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">)</span>
		<span class="n">srrctl</span> <span class="o">|=</span> <span class="n">IXGBE_SRRCTL_DROP_EN</span><span class="p">;</span>

	<span class="n">srrctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGBE_RX_HDR_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_SRRCTL_BSIZEHDRSIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">IXGBE_SRRCTL_BSIZEHDR_MASK</span><span class="p">;</span>

<span class="cp">#if PAGE_SIZE &gt; IXGBE_MAX_RXBUFFER</span>
	<span class="n">srrctl</span> <span class="o">|=</span> <span class="n">IXGBE_MAX_RXBUFFER</span> <span class="o">&gt;&gt;</span> <span class="n">IXGBE_SRRCTL_BSIZEPKT_SHIFT</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">srrctl</span> <span class="o">|=</span> <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IXGBE_SRRCTL_BSIZEPKT_SHIFT</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">srrctl</span> <span class="o">|=</span> <span class="n">IXGBE_SRRCTL_DESCTYPE_ADV_ONEBUF</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SRRCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">srrctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_setup_mrqc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">seed</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xE291D73D</span><span class="p">,</span> <span class="mh">0x1805EC6C</span><span class="p">,</span> <span class="mh">0x2A94B30D</span><span class="p">,</span>
			  <span class="mh">0xA54F2BEC</span><span class="p">,</span> <span class="mh">0xEA49AF7C</span><span class="p">,</span> <span class="mh">0xE214AD3D</span><span class="p">,</span> <span class="mh">0xB855AABE</span><span class="p">,</span>
			  <span class="mh">0x6A3E67EA</span><span class="p">,</span> <span class="mh">0x14364D17</span><span class="p">,</span> <span class="mh">0x3BED200D</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">mrqc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxcsum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">netdev_get_num_tc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">maxq</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">[</span><span class="n">RING_F_RSS</span><span class="p">].</span><span class="n">indices</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcs</span><span class="p">)</span>
		<span class="n">maxq</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxq</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span> <span class="o">/</span> <span class="n">tcs</span><span class="p">);</span>

	<span class="cm">/* Fill out hash function seeds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RSSRK</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">seed</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Fill out redirection table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">maxq</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* reta = 4-byte sliding window of</span>
<span class="cm">		 * 0x00..(indices-1)(indices-1)00..etc. */</span>
		<span class="n">reta</span> <span class="o">=</span> <span class="p">(</span><span class="n">reta</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RETA</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">reta</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable indicating checksum in descriptor, enables RSS hash */</span>
	<span class="n">rxcsum</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXCSUM</span><span class="p">);</span>
	<span class="n">rxcsum</span> <span class="o">|=</span> <span class="n">IXGBE_RXCSUM_PCSD</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXCSUM</span><span class="p">,</span> <span class="n">rxcsum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mrqc</span> <span class="o">=</span> <span class="n">IXGBE_MRQC_RSSEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGBE_FLAG_RSS_ENABLED</span>
					     <span class="o">|</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">)</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcs</span><span class="p">)</span>
				<span class="n">mrqc</span> <span class="o">=</span> <span class="n">IXGBE_MRQC_RSSEN</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcs</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">mrqc</span> <span class="o">=</span> <span class="n">IXGBE_MRQC_RTRSS4TCEN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mrqc</span> <span class="o">=</span> <span class="n">IXGBE_MRQC_RTRSS8TCEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>:
			<span class="n">mrqc</span> <span class="o">=</span> <span class="n">IXGBE_MRQC_VMDQEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Perform hash on these packet types */</span>
	<span class="n">mrqc</span> <span class="o">|=</span> <span class="n">IXGBE_MRQC_RSS_FIELD_IPV4</span>
	      <span class="o">|</span> <span class="n">IXGBE_MRQC_RSS_FIELD_IPV4_TCP</span>
	      <span class="o">|</span> <span class="n">IXGBE_MRQC_RSS_FIELD_IPV6</span>
	      <span class="o">|</span> <span class="n">IXGBE_MRQC_RSS_FIELD_IPV6_TCP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSS_FIELD_IPV4_UDP</span><span class="p">)</span>
		<span class="n">mrqc</span> <span class="o">|=</span> <span class="n">IXGBE_MRQC_RSS_FIELD_IPV4_UDP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSS_FIELD_IPV6_UDP</span><span class="p">)</span>
		<span class="n">mrqc</span> <span class="o">|=</span> <span class="n">IXGBE_MRQC_RSS_FIELD_IPV6_UDP</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MRQC</span><span class="p">,</span> <span class="n">mrqc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_configure_rscctl - enable RSC for the indicated ring</span>
<span class="cm"> * @adapter:    address of board private structure</span>
<span class="cm"> * @index:      index of ring to set</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure_rscctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rscctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring_is_rsc_enabled</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rscctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RSCCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="n">rscctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RSCCTL_RSCEN</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * we must limit the number of descriptors so that the</span>
<span class="cm">	 * total size of max desc * buf_len is not greater</span>
<span class="cm">	 * than 65536</span>
<span class="cm">	 */</span>
<span class="cp">#if (PAGE_SIZE &lt;= 8192)</span>
	<span class="n">rscctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RSCCTL_MAXDESC_16</span><span class="p">;</span>
<span class="cp">#elif (PAGE_SIZE &lt;= 16384)</span>
	<span class="n">rscctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RSCCTL_MAXDESC_8</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">rscctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RSCCTL_MAXDESC_4</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RSCCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">rscctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IXGBE_MAX_RX_DESC_POLL 10</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_rx_desc_queue_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_loop</span> <span class="o">=</span> <span class="n">IXGBE_MAX_RX_DESC_POLL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxdctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>

	<span class="cm">/* RXDCTL.EN will return 0 on 82598 if link is down, so skip it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LINKS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_UP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">rxdctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait_loop</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rxdctl</span> <span class="o">&amp;</span> <span class="n">IXGBE_RXDCTL_ENABLE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;RXDCTL.ENABLE on Rx queue %d not set within &quot;</span>
		      <span class="s">&quot;the polling period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_idx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ixgbe_disable_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_loop</span> <span class="o">=</span> <span class="n">IXGBE_MAX_RX_DESC_POLL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxdctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>

	<span class="n">rxdctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="n">rxdctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RXDCTL_ENABLE</span><span class="p">;</span>

	<span class="cm">/* write value back with RXDCTL.ENABLE bit cleared */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">rxdctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LINKS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_UP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* the hardware may take up to 100us to really disable the rx queue */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">rxdctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait_loop</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxdctl</span> <span class="o">&amp;</span> <span class="n">IXGBE_RXDCTL_ENABLE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;RXDCTL.ENABLE on Rx queue %d not cleared within &quot;</span>
		      <span class="s">&quot;the polling period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_idx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ixgbe_configure_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rdba</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxdctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>

	<span class="cm">/* disable queue to avoid issues while updating state */</span>
	<span class="n">rxdctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">));</span>
	<span class="n">ixgbe_disable_rx_queue</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDBAL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="p">(</span><span class="n">rdba</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDBAH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="p">(</span><span class="n">rdba</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDLEN</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_addr</span> <span class="o">+</span> <span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">);</span>

	<span class="n">ixgbe_configure_srrctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="n">ixgbe_configure_rscctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

	<span class="cm">/* If operating in IOV mode set RLPML for X540 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_X540</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxdctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RXDCTL_RLPMLMASK</span><span class="p">;</span>
		<span class="n">rxdctl</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span>
			    <span class="n">ETH_FCS_LEN</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">)</span> <span class="o">|</span> <span class="n">IXGBE_RXDCTL_RLPML_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * enable cache line friendly hardware writes:</span>
<span class="cm">		 * PTHRESH=32 descriptors (half the internal cache),</span>
<span class="cm">		 * this also removes ugly rx_no_buffer_count increment</span>
<span class="cm">		 * HTHRESH=4 descriptors (to minimize latency on fetch)</span>
<span class="cm">		 * WTHRESH=8 burst writeback up to two cache lines</span>
<span class="cm">		 */</span>
		<span class="n">rxdctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3FFFFF</span><span class="p">;</span>
		<span class="n">rxdctl</span> <span class="o">|=</span>  <span class="mh">0x080420</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable receive descriptor ring */</span>
	<span class="n">rxdctl</span> <span class="o">|=</span> <span class="n">IXGBE_RXDCTL_ENABLE</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">rxdctl</span><span class="p">);</span>

	<span class="n">ixgbe_rx_desc_queue_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="n">ixgbe_alloc_rx_buffers</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">ixgbe_desc_unused</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_setup_psrtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/* PSRTYPE must be initialized in non 82598 adapters */</span>
	<span class="n">u32</span> <span class="n">psrtype</span> <span class="o">=</span> <span class="n">IXGBE_PSRTYPE_TCPHDR</span> <span class="o">|</span>
		      <span class="n">IXGBE_PSRTYPE_UDPHDR</span> <span class="o">|</span>
		      <span class="n">IXGBE_PSRTYPE_IPV4HDR</span> <span class="o">|</span>
		      <span class="n">IXGBE_PSRTYPE_L2HDR</span> <span class="o">|</span>
		      <span class="n">IXGBE_PSRTYPE_IPV6HDR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">)</span>
		<span class="n">psrtype</span> <span class="o">|=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues_per_pool</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_pools</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PSRTYPE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">+</span> <span class="n">p</span><span class="p">),</span>
				<span class="n">psrtype</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure_virtualization</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gcr_ext</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vt_reg_bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">vf_shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vmdctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vmdctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VT_CTL</span><span class="p">);</span>
	<span class="n">vt_reg_bits</span> <span class="o">=</span> <span class="n">IXGBE_VMD_CTL_VMDQ_EN</span> <span class="o">|</span> <span class="n">IXGBE_VT_CTL_REPLEN</span><span class="p">;</span>
	<span class="n">vt_reg_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_VT_CTL_POOL_SHIFT</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VT_CTL</span><span class="p">,</span> <span class="n">vmdctl</span> <span class="o">|</span> <span class="n">vt_reg_bits</span><span class="p">);</span>

	<span class="n">vf_shift</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">reg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable only the PF&#39;s pool for Tx/Rx */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRE</span><span class="p">(</span><span class="n">reg_offset</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vf_shift</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRE</span><span class="p">(</span><span class="n">reg_offset</span> <span class="o">^</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTE</span><span class="p">(</span><span class="n">reg_offset</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vf_shift</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTE</span><span class="p">(</span><span class="n">reg_offset</span> <span class="o">^</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PFDTXGSWC</span><span class="p">,</span> <span class="n">IXGBE_PFDTXGSWC_VT_LBEN</span><span class="p">);</span>

	<span class="cm">/* Map PF MAC address in RAR Entry 0 to first pool following VFs */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_vmdq</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up VF register offsets for selected VT Mode,</span>
<span class="cm">	 * i.e. 32 or 64 VFs for SR-IOV</span>
<span class="cm">	 */</span>
	<span class="n">gcr_ext</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GCR_EXT</span><span class="p">);</span>
	<span class="n">gcr_ext</span> <span class="o">|=</span> <span class="n">IXGBE_GCR_EXT_MSIX_EN</span><span class="p">;</span>
	<span class="n">gcr_ext</span> <span class="o">|=</span> <span class="n">IXGBE_GCR_EXT_VT_MODE_64</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GCR_EXT</span><span class="p">,</span> <span class="n">gcr_ext</span><span class="p">);</span>

	<span class="cm">/* enable Tx loopback for VF/PF communication */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PFDTXGSWC</span><span class="p">,</span> <span class="n">IXGBE_PFDTXGSWC_VT_LBEN</span><span class="p">);</span>
	<span class="cm">/* Enable MAC Anti-Spoofing */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_mac_anti_spoofing</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
					  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">);</span>
	<span class="cm">/* For VFs that have spoof checking turned off */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vfinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spoofchk_enabled</span><span class="p">)</span>
			<span class="n">ixgbe_ndo_set_vf_spoofchk</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_set_rx_buffer_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mhadd</span><span class="p">,</span> <span class="n">hlreg0</span><span class="p">;</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="cm">/* adjust max frame to be able to do baby jumbo for FCoE */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">max_frame</span> <span class="o">&lt;</span> <span class="n">IXGBE_FCOE_JUMBO_FRAME_SIZE</span><span class="p">))</span>
		<span class="n">max_frame</span> <span class="o">=</span> <span class="n">IXGBE_FCOE_JUMBO_FRAME_SIZE</span><span class="p">;</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="n">mhadd</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MHADD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_frame</span> <span class="o">!=</span> <span class="p">(</span><span class="n">mhadd</span> <span class="o">&gt;&gt;</span> <span class="n">IXGBE_MHADD_MFS_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mhadd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_MHADD_MFS_MASK</span><span class="p">;</span>
		<span class="n">mhadd</span> <span class="o">|=</span> <span class="n">max_frame</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_MHADD_MFS_SHIFT</span><span class="p">;</span>

		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MHADD</span><span class="p">,</span> <span class="n">mhadd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* MHADD will allow an extra 4 bytes past for vlan tagged frames */</span>
	<span class="n">max_frame</span> <span class="o">+=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>

	<span class="n">hlreg0</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_HLREG0</span><span class="p">);</span>
	<span class="cm">/* set jumbo enable since MHADD.MFS is keeping size locked at max_frame */</span>
	<span class="n">hlreg0</span> <span class="o">|=</span> <span class="n">IXGBE_HLREG0_JUMBOEN</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_HLREG0</span><span class="p">,</span> <span class="n">hlreg0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup the HW Rx Head and Tail Descriptor Pointers and</span>
<span class="cm">	 * the Base and Length of the Rx Descriptor Ring</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">)</span>
			<span class="n">set_ring_rsc_enabled</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_ring_rsc_enabled</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_setup_rdrxctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rdrxctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDRXCTL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="cm">/*</span>
<span class="cm">		 * For VMDq support of different descriptor types or</span>
<span class="cm">		 * buffer sizes through the use of multiple SRRCTL</span>
<span class="cm">		 * registers, RDRXCTL.MVMEN must be set to 1</span>
<span class="cm">		 *</span>
<span class="cm">		 * also, the manual doesn&#39;t mention it clearly but DCA hints</span>
<span class="cm">		 * will only use queue 0&#39;s tags unless this bit is set.  Side</span>
<span class="cm">		 * effects of setting this bit are only that SRRCTL must be</span>
<span class="cm">		 * fully programmed [0..15]</span>
<span class="cm">		 */</span>
		<span class="n">rdrxctl</span> <span class="o">|=</span> <span class="n">IXGBE_RDRXCTL_MVMEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="cm">/* Disable RSC for ACK packets */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RSCDBU</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">IXGBE_RSCDBU_RSCACKDIS</span> <span class="o">|</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RSCDBU</span><span class="p">)));</span>
		<span class="n">rdrxctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RDRXCTL_RSCFRSTSIZE</span><span class="p">;</span>
		<span class="cm">/* hardware requires some bits to be set by default */</span>
		<span class="n">rdrxctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGBE_RDRXCTL_RSCACKC</span> <span class="o">|</span> <span class="n">IXGBE_RDRXCTL_FCOE_WRFIX</span><span class="p">);</span>
		<span class="n">rdrxctl</span> <span class="o">|=</span> <span class="n">IXGBE_RDRXCTL_CRCSTRIP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* We should do nothing since we don&#39;t know this hardware */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RDRXCTL</span><span class="p">,</span> <span class="n">rdrxctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_configure_rx - Configure 8259x Receive Unit after Reset</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the Rx unit of the MAC after a reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxctrl</span><span class="p">;</span>

	<span class="cm">/* disable receives while setting up the descriptors */</span>
	<span class="n">rxctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXCTRL</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXCTRL</span><span class="p">,</span> <span class="n">rxctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IXGBE_RXCTRL_RXEN</span><span class="p">);</span>

	<span class="n">ixgbe_setup_psrtype</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_setup_rdrxctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Program registers for the distribution of queues */</span>
	<span class="n">ixgbe_setup_mrqc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* set_rx_buffer_len must be called before ring initialization */</span>
	<span class="n">ixgbe_set_rx_buffer_len</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup the HW Rx Head and Tail Descriptor Pointers and</span>
<span class="cm">	 * the Base and Length of the Rx Descriptor Ring</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ixgbe_configure_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* disable drop enable for 82598 parts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">rxctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RXCTRL_DMBYPS</span><span class="p">;</span>

	<span class="cm">/* enable all receives */</span>
	<span class="n">rxctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RXCTRL_RXEN</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_rx_dma</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rxctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pool_ndx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span>

	<span class="cm">/* add VID to filter table */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_vfta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vid</span><span class="p">,</span> <span class="n">pool_ndx</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pool_ndx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span>

	<span class="cm">/* remove VID from filter table */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_vfta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vid</span><span class="p">,</span> <span class="n">pool_ndx</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_vlan_filter_disable - helper to disable hw vlan filtering</span>
<span class="cm"> * @adapter: driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_vlan_filter_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlnctrl</span><span class="p">;</span>

	<span class="n">vlnctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">);</span>
	<span class="n">vlnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_VLNCTRL_VFE</span> <span class="o">|</span> <span class="n">IXGBE_VLNCTRL_CFIEN</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">,</span> <span class="n">vlnctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_vlan_filter_enable - helper to enable hw vlan filtering</span>
<span class="cm"> * @adapter: driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_vlan_filter_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlnctrl</span><span class="p">;</span>

	<span class="n">vlnctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">);</span>
	<span class="n">vlnctrl</span> <span class="o">|=</span> <span class="n">IXGBE_VLNCTRL_VFE</span><span class="p">;</span>
	<span class="n">vlnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_VLNCTRL_CFIEN</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">,</span> <span class="n">vlnctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_vlan_strip_disable - helper to disable hw vlan stripping</span>
<span class="cm"> * @adapter: driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_vlan_strip_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlnctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">vlnctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">);</span>
		<span class="n">vlnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_VLNCTRL_VME</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">,</span> <span class="n">vlnctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>
			<span class="n">vlnctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
			<span class="n">vlnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RXDCTL_VME</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">vlnctrl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_vlan_strip_enable - helper to enable hw vlan stripping</span>
<span class="cm"> * @adapter: driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_vlan_strip_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlnctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">vlnctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">);</span>
		<span class="n">vlnctrl</span> <span class="o">|=</span> <span class="n">IXGBE_VLNCTRL_VME</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VLNCTRL</span><span class="p">,</span> <span class="n">vlnctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>
			<span class="n">vlnctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
			<span class="n">vlnctrl</span> <span class="o">|=</span> <span class="n">IXGBE_RXDCTL_VME</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">vlnctrl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_restore_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">ixgbe_vlan_rx_add_vid</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span>
		<span class="n">ixgbe_vlan_rx_add_vid</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_write_uc_addr_list - write unicast addresses to RAR table</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Writes unicast address list to the RAR table.</span>
<span class="cm"> * Returns: -ENOMEM on failure/insufficient address space</span>
<span class="cm"> *                0 on no addresses written</span>
<span class="cm"> *                X on writing X addresses to the RAR table</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_write_uc_addr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vfn</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rar_entries</span> <span class="o">=</span> <span class="n">IXGBE_MAX_PF_MACVLANS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* return ENOMEM indicating insufficient memory for addresses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_uc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rar_entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_uc_empty</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rar_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="cm">/* return error if we do not support writing to RAR table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rar</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">netdev_for_each_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rar_entries</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rar</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rar_entries</span><span class="o">--</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
					    <span class="n">vfn</span><span class="p">,</span> <span class="n">IXGBE_RAH_AV</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* write the addresses in reverse order to avoid write combining */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">rar_entries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">rar_entries</span><span class="o">--</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">clear_rar</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rar_entries</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_set_rx_mode - Unicast, Multicast and Promiscuous mode set</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * The set_rx_method entry point is called whenever the unicast/multicast</span>
<span class="cm"> * address list or the network interface flags are updated.  This routine is</span>
<span class="cm"> * responsible for configuring the hardware for proper unicast, multicast and</span>
<span class="cm"> * promiscuous mode.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="n">ixgbe_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fctrl</span><span class="p">,</span> <span class="n">vmolr</span> <span class="o">=</span> <span class="n">IXGBE_VMOLR_BAM</span> <span class="o">|</span> <span class="n">IXGBE_VMOLR_AUPE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Check for Promiscuous and All Multicast modes */</span>

	<span class="n">fctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">);</span>

	<span class="cm">/* set all bits that we expect to always be set */</span>
	<span class="n">fctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FCTRL_SBP</span><span class="p">;</span> <span class="cm">/* disable store-bad-packets */</span>
	<span class="n">fctrl</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_BAM</span><span class="p">;</span>
	<span class="n">fctrl</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_DPF</span><span class="p">;</span> <span class="cm">/* discard pause frames when FC enabled */</span>
	<span class="n">fctrl</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_PMCF</span><span class="p">;</span>

	<span class="cm">/* clear the bits we are changing the status of */</span>
	<span class="n">fctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_FCTRL_UPE</span> <span class="o">|</span> <span class="n">IXGBE_FCTRL_MPE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">user_set_promisc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">fctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGBE_FCTRL_UPE</span> <span class="o">|</span> <span class="n">IXGBE_FCTRL_MPE</span><span class="p">);</span>
		<span class="n">vmolr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGBE_VMOLR_ROPE</span> <span class="o">|</span> <span class="n">IXGBE_VMOLR_MPE</span><span class="p">);</span>
		<span class="cm">/* don&#39;t hardware filter vlans in promisc mode */</span>
		<span class="n">ixgbe_vlan_filter_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fctrl</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_MPE</span><span class="p">;</span>
			<span class="n">vmolr</span> <span class="o">|=</span> <span class="n">IXGBE_VMOLR_MPE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Write addresses to the MTA, if the attempt fails</span>
<span class="cm">			 * then we should just turn on promiscuous mode so</span>
<span class="cm">			 * that we can at least receive multicast traffic</span>
<span class="cm">			 */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">update_mc_addr_list</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
			<span class="n">vmolr</span> <span class="o">|=</span> <span class="n">IXGBE_VMOLR_ROMPE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ixgbe_vlan_filter_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">user_set_promisc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write addresses to available RAR registers, if there is not</span>
<span class="cm">	 * sufficient space to store all the addresses then enable</span>
<span class="cm">	 * unicast promiscuous mode</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">ixgbe_write_uc_addr_list</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fctrl</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_UPE</span><span class="p">;</span>
		<span class="n">vmolr</span> <span class="o">|=</span> <span class="n">IXGBE_VMOLR_ROPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_restore_vf_multicasts</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">vmolr</span> <span class="o">|=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VMOLR</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_VMOLR_MPE</span> <span class="o">|</span> <span class="n">IXGBE_VMOLR_ROMPE</span> <span class="o">|</span>
			   <span class="n">IXGBE_VMOLR_ROPE</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VMOLR</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">),</span> <span class="n">vmolr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This is useful for sniffing bad packets. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* UPE and MPE will be handled by normal PROMISC logic</span>
<span class="cm">		 * in e1000e_set_rx_mode */</span>
		<span class="n">fctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGBE_FCTRL_SBP</span> <span class="o">|</span> <span class="cm">/* Receive bad packets */</span>
			  <span class="n">IXGBE_FCTRL_BAM</span> <span class="o">|</span> <span class="cm">/* RX All Bcast Pkts */</span>
			  <span class="n">IXGBE_FCTRL_PMCF</span><span class="p">);</span> <span class="cm">/* RX All MAC Ctrl Pkts */</span>

		<span class="n">fctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_FCTRL_DPF</span><span class="p">);</span>
		<span class="cm">/* NOTE:  VLAN filtering is disabled by setting PROMISC */</span>
	<span class="p">}</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">,</span> <span class="n">fctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">ixgbe_vlan_strip_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ixgbe_vlan_strip_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_napi_enable_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">q_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span>

	<span class="cm">/* legacy and MSI only use one vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">))</span>
		<span class="n">q_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">q_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q_idx</span> <span class="o">&lt;</span> <span class="n">q_vectors</span><span class="p">;</span> <span class="n">q_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">q_idx</span><span class="p">];</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_napi_disable_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">q_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span>

	<span class="cm">/* legacy and MSI only use one vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">))</span>
		<span class="n">q_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">q_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q_idx</span> <span class="o">&lt;</span> <span class="n">q_vectors</span><span class="p">;</span> <span class="n">q_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">q_idx</span><span class="p">];</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
<span class="cm">/*</span>
<span class="cm"> * ixgbe_configure_dcb - Configure DCB hardware</span>
<span class="cm"> * @adapter: ixgbe adapter struct</span>
<span class="cm"> *</span>
<span class="cm"> * This is called by the driver on open to configure the DCB hardware.</span>
<span class="cm"> * This is also called by the gennetlink interface when reconfiguring</span>
<span class="cm"> * the DCB state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure_dcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
			<span class="n">netif_set_gso_max_size</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">netif_set_gso_max_size</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_vfta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_FCOE_MTU</span><span class="p">)</span>
		<span class="n">max_frame</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">max_frame</span><span class="p">,</span> <span class="n">IXGBE_FCOE_JUMBO_FRAME_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* reconfigure the hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_dcb_calculate_tc_credits</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">max_frame</span><span class="p">,</span>
						<span class="n">DCB_TX_CONFIG</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_calculate_tc_credits</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">max_frame</span><span class="p">,</span>
						<span class="n">DCB_RX_CONFIG</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_hw_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_dcb_hw_ets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
				 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">,</span>
				 <span class="n">max_frame</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_hw_pfc_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable RSS Hash per TC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">msb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tc_to_txq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">msb</span><span class="o">++</span><span class="p">;</span>

			<span class="n">reg</span> <span class="o">|=</span> <span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_RQTC_SHIFT_TC</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RQTC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Additional bittime to account for IXGBE framing */</span>
<span class="cp">#define IXGBE_ETH_FRAMING 20</span>

<span class="cm">/*</span>
<span class="cm"> * ixgbe_hpbthresh - calculate high water mark for flow control</span>
<span class="cm"> *</span>
<span class="cm"> * @adapter: board private structure to calculate for</span>
<span class="cm"> * @pb - packet buffer to calculate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_hpbthresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">marker</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dv_id</span><span class="p">,</span> <span class="n">rx_pba</span><span class="p">;</span>

	<span class="cm">/* Calculate max LAN frame size */</span>
	<span class="n">tc</span> <span class="o">=</span> <span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span> <span class="o">+</span> <span class="n">IXGBE_ETH_FRAMING</span><span class="p">;</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="cm">/* FCoE traffic class uses FCOE jumbo frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_FCOE_MTU</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fcoe_pb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
		<span class="n">fcoe_pb</span> <span class="o">=</span> <span class="n">netdev_get_prio_tc_map</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span><span class="p">);</span>

<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_pb</span> <span class="o">==</span> <span class="n">pb</span> <span class="o">&amp;&amp;</span> <span class="n">tc</span> <span class="o">&lt;</span> <span class="n">IXGBE_FCOE_JUMBO_FRAME_SIZE</span><span class="p">)</span>
			<span class="n">tc</span> <span class="o">=</span> <span class="n">IXGBE_FCOE_JUMBO_FRAME_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Calculate delay value for device */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">dv_id</span> <span class="o">=</span> <span class="n">IXGBE_DV_X540</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dv_id</span> <span class="o">=</span> <span class="n">IXGBE_DV</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loopback switch introduces additional latency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>
		<span class="n">dv_id</span> <span class="o">+=</span> <span class="n">IXGBE_B2BT</span><span class="p">(</span><span class="n">tc</span><span class="p">);</span>

	<span class="cm">/* Delay value is calculated in bit times convert to KB */</span>
	<span class="n">kb</span> <span class="o">=</span> <span class="n">IXGBE_BT2KB</span><span class="p">(</span><span class="n">dv_id</span><span class="p">);</span>
	<span class="n">rx_pba</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXPBSIZE</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">marker</span> <span class="o">=</span> <span class="n">rx_pba</span> <span class="o">-</span> <span class="n">kb</span><span class="p">;</span>

	<span class="cm">/* It is possible that the packet buffer is not large enough</span>
<span class="cm">	 * to provide required headroom. In this case throw an error</span>
<span class="cm">	 * to user and a do the best we can.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">marker</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_warn</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;Packet Buffer(%i) can not provide enough&quot;</span>
			    <span class="s">&quot;headroom to support flow control.&quot;</span>
			    <span class="s">&quot;Decrease MTU or number of traffic classes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="p">);</span>
		<span class="n">marker</span> <span class="o">=</span> <span class="n">tc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">marker</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ixgbe_lpbthresh - calculate low water mark for for flow control</span>
<span class="cm"> *</span>
<span class="cm"> * @adapter: board private structure to calculate for</span>
<span class="cm"> * @pb - packet buffer to calculate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_lpbthresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dv_id</span><span class="p">;</span>

	<span class="cm">/* Calculate max LAN frame size */</span>
	<span class="n">tc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

	<span class="cm">/* Calculate delay value for device */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">dv_id</span> <span class="o">=</span> <span class="n">IXGBE_LOW_DV_X540</span><span class="p">(</span><span class="n">tc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dv_id</span> <span class="o">=</span> <span class="n">IXGBE_LOW_DV</span><span class="p">(</span><span class="n">tc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delay value is calculated in bit times convert to KB */</span>
	<span class="k">return</span> <span class="n">IXGBE_BT2KB</span><span class="p">(</span><span class="n">dv_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ixgbe_pbthresh_setup - calculate and setup high low water marks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_pbthresh_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_tc</span> <span class="o">=</span> <span class="n">netdev_get_num_tc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_tc</span><span class="p">)</span>
		<span class="n">num_tc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">low_water</span> <span class="o">=</span> <span class="n">ixgbe_lpbthresh</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_tc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">high_water</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ixgbe_hpbthresh</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* Low water marks must not be larger than high water marks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">low_water</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">high_water</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">low_water</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure_pb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">netdev_get_num_tc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span> <span class="o">||</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_PERFECT_CAPABLE</span><span class="p">)</span>
		<span class="n">hdrm</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_pballoc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdrm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rxpba</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">hdrm</span><span class="p">,</span> <span class="n">PBA_STRATEGY_EQUAL</span><span class="p">);</span>
	<span class="n">ixgbe_pbthresh_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_fdir_filter_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">node2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_fdir_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_perfect_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_filter_list</span><span class="p">))</span>
		<span class="n">ixgbe_fdir_set_input_mask_82599</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_mask</span><span class="p">);</span>

	<span class="n">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_filter_list</span><span class="p">,</span> <span class="n">fdir_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_fdir_write_perfect_filter_82599</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span>
				<span class="n">filter</span><span class="o">-&gt;</span><span class="n">sw_idx</span><span class="p">,</span>
				<span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IXGBE_FDIR_DROP_QUEUE</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">IXGBE_FDIR_DROP_QUEUE</span> <span class="o">:</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_perfect_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ixgbe_configure_pb</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
	<span class="n">ixgbe_configure_dcb</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ixgbe_set_rx_mode</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ixgbe_restore_vlan</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_ENABLED</span><span class="p">)</span>
		<span class="n">ixgbe_configure_fcoe</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_rx_buff</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_init_fdir_signature_82599</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_pballoc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_PERFECT_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_init_fdir_perfect_82599</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					      <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_pballoc</span><span class="p">);</span>
		<span class="n">ixgbe_fdir_filter_restore</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_rx_buff</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_configure_virtualization</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_configure_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_configure_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="n">ixgbe_is_sfp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_avago</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_ftl</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_intel</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_unknown</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_passive_tyco</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_passive_unknown</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_active_unknown</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_sfp_ftl_active</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_phy_nl</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_sfp_link_config - set up SFP+ link</span>
<span class="cm"> * @adapter: pointer to private adapter struct</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_sfp_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We are assuming the worst case scenario here, and that</span>
<span class="cm">	 * is that an SFP was inserted/removed after the reset</span>
<span class="cm">	 * but before SFP detection was enabled.  As such the best</span>
<span class="cm">	 * solution is to just start searching as soon as we start</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_SEARCH_FOR_SFP</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_non_sfp_link_config - set up non-SFP+ link</span>
<span class="cm"> * @hw: pointer to private hardware struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_non_sfp_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">negotiation</span><span class="p">,</span> <span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IXGBE_ERR_LINK_SETUP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autoneg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">link_cfg_out</span><span class="p">;</span>

	<span class="n">autoneg</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">autoneg_advertised</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">autoneg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_link_capabilities</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_link_capabilities</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autoneg</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">negotiation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">link_cfg_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">negotiation</span><span class="p">,</span> <span class="n">link_up</span><span class="p">);</span>
<span class="nl">link_cfg_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_setup_gpie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpie</span> <span class="o">=</span> <span class="n">IXGBE_GPIE_MSIX_MODE</span> <span class="o">|</span> <span class="n">IXGBE_GPIE_PBA_SUPPORT</span> <span class="o">|</span>
		       <span class="n">IXGBE_GPIE_OCD</span><span class="p">;</span>
		<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_GPIE_EIAME</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * use EIAM to auto-mask when MSI-X interrupt is asserted</span>
<span class="cm">		 * this saves a register write for every interrupt</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIAM</span><span class="p">,</span> <span class="n">IXGBE_EICS_RTX_QUEUE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="nl">default:</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIAM_EX</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIAM_EX</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* legacy interrupts, use EIAM to auto-mask when reading EICR,</span>
<span class="cm">		 * specifically only auto mask tx and rx interrupts */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIAM</span><span class="p">,</span> <span class="n">IXGBE_EICS_RTX_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* XXX: to interrupt immediately for EICS writes, enable this */</span>
	<span class="cm">/* gpie |= IXGBE_GPIE_EIMEN; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpie</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_GPIE_VTMODE_MASK</span><span class="p">;</span>
		<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_GPIE_VTMODE_64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Thermal over heat sensor interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
			<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_SDP0_GPIEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
			<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_EIMS_TS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable fan failure interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FAN_FAIL_CAPABLE</span><span class="p">)</span>
		<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_SDP1_GPIEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_SDP1_GPIEN</span><span class="p">;</span>
		<span class="n">gpie</span> <span class="o">|=</span> <span class="n">IXGBE_SDP2_GPIEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GPIE</span><span class="p">,</span> <span class="n">gpie</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_up_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl_ext</span><span class="p">;</span>

	<span class="n">ixgbe_get_hw_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_setup_gpie</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span>
		<span class="n">ixgbe_configure_msix</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ixgbe_configure_msi_and_legacy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* enable the optics for both mult-speed fiber and 82599 SFP+ fiber */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_tx_laser</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">multispeed_fiber</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_media_type</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">==</span> <span class="n">ixgbe_media_type_fiber</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">))))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_tx_laser</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">ixgbe_napi_enable_all</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_is_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ixgbe_sfp_link_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_non_sfp_link_config</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;link_config FAILED %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear any pending interrupts, may auto mask */</span>
	<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICR</span><span class="p">);</span>
	<span class="n">ixgbe_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this adapter has a fan, check to see if we had a failure</span>
<span class="cm">	 * before we enabled the interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FAN_FAIL_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">esdp</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ESDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esdp</span> <span class="o">&amp;</span> <span class="n">IXGBE_ESDP_SDP1</span><span class="p">)</span>
			<span class="n">e_crit</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;Fan has stopped, replace the adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* enable transmits */</span>
	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* bring the link up in the watchdog, this could race with our first</span>
<span class="cm">	 * link up interrupt but shouldn&#39;t be a problem */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_check_timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/* Set PF Reset Done bit so PF/VF Mail Ops can work */</span>
	<span class="n">ctrl_ext</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL_EXT</span><span class="p">);</span>
	<span class="n">ctrl_ext</span> <span class="o">|=</span> <span class="n">IXGBE_CTRL_EXT_PFRSTD</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL_EXT</span><span class="p">,</span> <span class="n">ctrl_ext</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ixgbe_reinit_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="cm">/* put off any impending NetWatchDogTimeout */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="n">ixgbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If SR-IOV enabled then wait a bit before bringing the adapter</span>
<span class="cm">	 * back up to give the VFs time to respond to the reset.  The</span>
<span class="cm">	 * two second wait is based upon the watchdog timer cycle in</span>
<span class="cm">	 * the VF driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">ixgbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ixgbe_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* hardware has been reset, we need to reload some things */</span>
	<span class="n">ixgbe_configure</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_up_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ixgbe_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* lock SFP init bit to prevent race conditions with the watchdog */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_IN_SFP_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="cm">/* clear all SFP and link config related flags while holding SFP_INIT */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_FLAG2_SEARCH_FOR_SFP</span> <span class="o">|</span>
			     <span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_NEED_LINK_CONFIG</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">init_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="n">IXGBE_ERR_SFP_NOT_PRESENT</span>:
	<span class="k">case</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_ERR_MASTER_REQUESTS_PENDING</span>:
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;master disable timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_ERR_EEPROM_VERSION</span>:
		<span class="cm">/* We are running on a pre-production device, log a warning */</span>
		<span class="n">e_dev_warn</span><span class="p">(</span><span class="s">&quot;This device is a pre-production adapter/LOM. &quot;</span>
			   <span class="s">&quot;Please be aware there may be issues associated with &quot;</span>
			   <span class="s">&quot;your hardware.  If you are experiencing problems &quot;</span>
			   <span class="s">&quot;please contact your Intel or hardware &quot;</span>
			   <span class="s">&quot;representative who provided you with this &quot;</span>
			   <span class="s">&quot;hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;Hardware Error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_IN_SFP_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* reprogram the RAR[0] in case user changed it. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rar</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">,</span>
			    <span class="n">IXGBE_RAH_AV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_init_rx_page_offset - initialize page offset values for Rx buffers</span>
<span class="cm"> * @rx_ring: ring to setup</span>
<span class="cm"> *</span>
<span class="cm"> * On many IA platforms the L1 cache has a critical stride of 4K, this</span>
<span class="cm"> * results in each receive buffer starting in the same cache set.  To help</span>
<span class="cm"> * reduce the pressure on this cache set we can interleave the offsets so</span>
<span class="cm"> * that only every other buffer will be in the same cache set.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_init_rx_page_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">rx_buffer</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="n">rx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_clean_rx_ring - Free Rx Buffers per Queue</span>
<span class="cm"> * @rx_ring: ring to free buffers from</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_clean_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* ring already cleared, nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Free all the Rx ring sk_buffs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span> <span class="o">*</span><span class="n">rx_buffer</span><span class="p">;</span>

		<span class="n">rx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">page_released</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					       <span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span>
					       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
				<span class="n">IXGBE_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">page_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				       <span class="n">ixgbe_rx_pg_size</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">),</span>
				       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
			<span class="n">__free_pages</span><span class="p">(</span><span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span>
				     <span class="n">ixgbe_rx_pg_order</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">));</span>
		<span class="n">rx_buffer</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">ixgbe_init_rx_page_offset</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="cm">/* Zero out the descriptor ring */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_clean_tx_ring - Free Tx Buffers</span>
<span class="cm"> * @tx_ring: ring to be cleaned</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_clean_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* ring already cleared, nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Free all the Tx ring sk_buffs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ixgbe_unmap_and_free_tx_resource</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">tx_buffer_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netdev_tx_reset_queue</span><span class="p">(</span><span class="n">txring_txq</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">));</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Zero out the descriptor ring */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_clean_all_rx_rings - Free Rx Buffers for all queues</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_clean_all_rx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ixgbe_clean_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_clean_all_tx_rings - Free Tx Buffers for all queues</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_clean_all_tx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ixgbe_clean_tx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_fdir_filter_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">node2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_fdir_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_perfect_lock</span><span class="p">);</span>

	<span class="n">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_filter_list</span><span class="p">,</span> <span class="n">fdir_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">fdir_node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_filter_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_perfect_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ixgbe_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* signal that we are down to the interrupt handler */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* disable receives */</span>
	<span class="n">rxctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXCTRL</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXCTRL</span><span class="p">,</span> <span class="n">rxctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IXGBE_RXCTRL_RXEN</span><span class="p">);</span>

	<span class="cm">/* disable all enabled rx queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* this call also flushes the previous write */</span>
		<span class="n">ixgbe_disable_rx_queue</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>

	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* call carrier off first to avoid false dev_watchdog timeouts */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ixgbe_irq_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_napi_disable_all</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_FLAG2_FDIR_REQUIRES_REINIT</span> <span class="o">|</span>
			     <span class="n">IXGBE_FLAG2_RESET_REQUESTED</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear EITR Select mapping */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EITRSEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Mark all the VFs as inactive */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vfinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear_to_send</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* ping all the active vfs to let them know we are going down */</span>
		<span class="n">ixgbe_ping_all_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="cm">/* Disable all VFTE/VFRE TX/RX */</span>
		<span class="n">ixgbe_disable_tx_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable transmits in the hardware now that interrupts are off */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_idx</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span> <span class="n">IXGBE_TXDCTL_SWFLSH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the Tx DMA engine on 82599 and X540 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DMATXCTL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DMATXCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="o">~</span><span class="n">IXGBE_DMATXCTL_TE</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">ixgbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* power down the optics for multispeed fiber and 82599 SFP+ fiber */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_tx_laser</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">multispeed_fiber</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_media_type</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">==</span> <span class="n">ixgbe_media_type_fiber</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">))))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_tx_laser</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ixgbe_clean_all_tx_rings</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_clean_all_rx_rings</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
	<span class="cm">/* since we reset the hardware DCA settings were cleared */</span>
	<span class="n">ixgbe_setup_dca</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_tx_timeout - Respond to a Tx Hang</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Do the reset outside of interrupt context */</span>
	<span class="n">ixgbe_tx_timeout_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_sw_init - Initialize general software structures (struct ixgbe_adapter)</span>
<span class="cm"> * @adapter: board private structure to initialize</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_sw_init initializes the Adapter private data structure.</span>
<span class="cm"> * Fields are initialized based on PCI device information and</span>
<span class="cm"> * OS network device settings (MTU size).</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">ixgbe_sw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rss</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc_configuration</span> <span class="o">*</span><span class="n">tc</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* PCI config space info */</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">subsystem_vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">subsystem_device_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>

	<span class="cm">/* Set capability flags */</span>
	<span class="n">rss</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">IXGBE_MAX_RSS_INDICES</span><span class="p">,</span> <span class="n">num_online_cpus</span><span class="p">());</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">[</span><span class="n">RING_F_RSS</span><span class="p">].</span><span class="n">indices</span> <span class="o">=</span> <span class="n">rss</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGBE_DEV_ID_82598AT</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_FAN_FAIL_CAPABLE</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_msix_q_vectors</span> <span class="o">=</span> <span class="n">MAX_MSIX_Q_VECTORS_82598</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_CAPABLE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_msix_q_vectors</span> <span class="o">=</span> <span class="n">MAX_MSIX_Q_VECTORS_82599</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_RSC_CAPABLE</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGBE_DEV_ID_82599_T3_LOM</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_TEMP_SENSOR_CAPABLE</span><span class="p">;</span>
		<span class="cm">/* Flow Director hash filters enabled */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">[</span><span class="n">RING_F_FDIR</span><span class="p">].</span><span class="n">indices</span> <span class="o">=</span>
							 <span class="n">IXGBE_MAX_FDIR_INDICES</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_pballoc</span> <span class="o">=</span> <span class="n">IXGBE_FDIR_PBALLOC_64K</span><span class="p">;</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_FCOE_CAPABLE</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_FCOE_ENABLED</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">[</span><span class="n">RING_F_FCOE</span><span class="p">].</span><span class="n">indices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
		<span class="cm">/* Default traffic class to use for FCoE */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">IXGBE_FCOE_DEFTC</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* n-tuple support exists, always init our spinlock */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_perfect_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span> <span class="o">=</span> <span class="n">X540_TRAFFIC_CLASS</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pfc_tcs</span> <span class="o">=</span> <span class="n">X540_TRAFFIC_CLASS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span> <span class="o">=</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pfc_tcs</span> <span class="o">=</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure DCB traffic classes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">DCB_TX_CONFIG</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">DCB_TX_CONFIG</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">DCB_RX_CONFIG</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">DCB_RX_CONFIG</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">dcb_pfc</span> <span class="o">=</span> <span class="n">pfc_disabled</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize default user to priority mapping, UPx-&gt;TC0 */</span>
	<span class="n">tc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">DCB_TX_CONFIG</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">DCB_RX_CONFIG</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">DCB_TX_CONFIG</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">DCB_RX_CONFIG</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">=</span> <span class="n">DCB_CAP_DCBX_HOST</span> <span class="o">|</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">));</span>

<span class="cp">#endif</span>

	<span class="cm">/* default flow control settings */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">ixgbe_fc_full</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span> <span class="o">=</span> <span class="n">ixgbe_fc_full</span><span class="p">;</span>	<span class="cm">/* init for ethtool output */</span>
	<span class="n">ixgbe_pbthresh_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">pause_time</span> <span class="o">=</span> <span class="n">IXGBE_DEFAULT_FCPAUSE</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">send_xon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">disable_fc_autoneg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* enable itr by default in dynamic mode */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_itr_setting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set default ring sizes */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">=</span> <span class="n">IXGBE_DEFAULT_TXD</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span> <span class="o">=</span> <span class="n">IXGBE_DEFAULT_RXD</span><span class="p">;</span>

	<span class="cm">/* set default work limits */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_work_limit</span> <span class="o">=</span> <span class="n">IXGBE_DEFAULT_TX_WORK</span><span class="p">;</span>

	<span class="cm">/* initialize eeprom parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_init_eeprom_params_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;EEPROM initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_setup_tx_resources - allocate Tx resources (Descriptors)</span>
<span class="cm"> * @tx_ring:    tx descriptor ring (for a specific queue) to setup</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="n">ixgbe_setup_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_node</span> <span class="o">=</span> <span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">numa_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">)</span>
		<span class="n">numa_node</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">numa_node</span><span class="p">;</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span> <span class="o">=</span> <span class="n">vzalloc_node</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">numa_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">)</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* round up to nearest 4K */</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="n">set_dev_node</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">numa_node</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">set_dev_node</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">orig_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for the Tx descriptor ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_setup_all_tx_resources - allocate all queues Tx resources</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * If this function returns with an error, then it&#39;s possible one or</span>
<span class="cm"> * more of the rings is populated (while the rest are not).  It is the</span>
<span class="cm"> * callers duty to clean those orphaned rings.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_setup_all_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;Allocation for Tx Queue %u failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_setup_rx_resources - allocate Rx resources (Descriptors)</span>
<span class="cm"> * @rx_ring:    rx descriptor ring (for a specific queue) to setup</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="n">ixgbe_setup_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_node</span> <span class="o">=</span> <span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">numa_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_rx_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">)</span>
		<span class="n">numa_node</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">numa_node</span><span class="p">;</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span> <span class="o">=</span> <span class="n">vzalloc_node</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">numa_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">)</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Round up to nearest 4K */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ixgbe_adv_rx_desc</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="n">set_dev_node</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">numa_node</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">set_dev_node</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">orig_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ixgbe_init_rx_page_offset</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for the Rx descriptor ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_setup_all_rx_resources - allocate all queues Rx resources</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * If this function returns with an error, then it&#39;s possible one or</span>
<span class="cm"> * more of the rings is populated (while the rest are not).  It is the</span>
<span class="cm"> * callers duty to clean those orphaned rings.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_setup_all_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;Allocation for Rx Queue %u failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_free_tx_resources - Free Tx Resources per Queue</span>
<span class="cm"> * @tx_ring: Tx descriptor ring for a specific queue</span>
<span class="cm"> *</span>
<span class="cm"> * Free all transmit software resources</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="n">ixgbe_free_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ixgbe_clean_tx_ring</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* if not set, then don&#39;t free */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_free_all_tx_resources - Free Tx Resources for All Queues</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Free all transmit software resources</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_free_all_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">ixgbe_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_free_rx_resources - Free Rx Resources</span>
<span class="cm"> * @rx_ring: ring to clean the resources from</span>
<span class="cm"> *</span>
<span class="cm"> * Free all receive software resources</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="n">ixgbe_free_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ixgbe_clean_rx_ring</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* if not set, then don&#39;t free */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_free_all_rx_resources - Free Rx Resources for All Queues</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Free all receive software resources</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_free_all_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">ixgbe_free_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_change_mtu - Change the Maximum Transfer Unit</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> * @new_mtu: new value for maximum frame size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

	<span class="cm">/* MTU &lt; 68 is an error and causes problems on some kernels */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">max_frame</span> <span class="o">&gt;</span> <span class="n">IXGBE_MAX_JUMBO_FRAME_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For 82599EB we cannot allow PF to change MTU greater than 1500</span>
<span class="cm">	 * in SR-IOV mode as it may cause buffer overruns in guest VFs that</span>
<span class="cm">	 * don&#39;t allocate and chain buffers correctly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">max_frame</span> <span class="o">&gt;</span> <span class="n">MAXIMUM_ETHERNET_VLAN_SIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">e_info</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;changing MTU from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>

	<span class="cm">/* must set new MTU before calling down or up */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgbe_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_open - Called when a network interface is made active</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value on failure</span>
<span class="cm"> *</span>
<span class="cm"> * The open entry point is called when a network interface is made</span>
<span class="cm"> * active by the system (IFF_UP).  At this point all resources needed</span>
<span class="cm"> * for transmit and receive operations are allocated, the interrupt</span>
<span class="cm"> * handler is registered with the OS, the watchdog timer is started,</span>
<span class="cm"> * and the stack is notified that the interface is ready.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* disallow open during test */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_TESTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* allocate transmit descriptors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_all_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_tx</span><span class="p">;</span>

	<span class="cm">/* allocate receive descriptors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_all_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_rx</span><span class="p">;</span>

	<span class="n">ixgbe_configure</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_req_irq</span><span class="p">;</span>

	<span class="n">ixgbe_up_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_req_irq:</span>
<span class="nl">err_setup_rx:</span>
	<span class="n">ixgbe_free_all_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_setup_tx:</span>
	<span class="n">ixgbe_free_all_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_close - Disables a network interface</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0, this is not allowed to fail</span>
<span class="cm"> *</span>
<span class="cm"> * The close entry point is called when an interface is de-activated</span>
<span class="cm"> * by the OS.  The hardware is still under the drivers control, but</span>
<span class="cm"> * needs to be disabled.  A global MAC reset is issued to stop the</span>
<span class="cm"> * hardware, and all transmit and receive resources are freed.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ixgbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_fdir_filter_exit</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_free_all_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_free_all_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_release_hw_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * pci_restore_state clears dev-&gt;state_saved so call</span>
<span class="cm">	 * pci_save_state to restore it.</span>
<span class="cm">	 */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;Cannot enable PCI device from suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_init_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;Cannot initialize interrupts for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_WUS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__ixgbe_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">enable_wake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">fctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wufc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">ixgbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">ixgbe_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">ixgbe_free_all_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">ixgbe_free_all_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ixgbe_clear_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wufc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_set_rx_mode</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * enable the optics for both mult-speed fiber and</span>
<span class="cm">		 * 82599 SFP+ fiber as we can WoL.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_tx_laser</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">multispeed_fiber</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_media_type</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">==</span> <span class="n">ixgbe_media_type_fiber</span> <span class="o">&amp;&amp;</span>
		     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">)))</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_tx_laser</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/* turn on all-multi mode if wake on multicast is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wufc</span> <span class="o">&amp;</span> <span class="n">IXGBE_WUFC_MC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">);</span>
			<span class="n">fctrl</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_MPE</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">,</span> <span class="n">fctrl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">IXGBE_CTRL_GIO_DIS</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_WUFC</span><span class="p">,</span> <span class="n">wufc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_WUC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_WUFC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">!!</span><span class="n">wufc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">enable_wake</span> <span class="o">=</span> <span class="o">!!</span><span class="n">wufc</span><span class="p">;</span>

	<span class="n">ixgbe_release_hw_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wake</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__ixgbe_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wake</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_prepare_to_sleep</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">wake</span><span class="p">;</span>

	<span class="n">__ixgbe_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wake</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">system_state</span> <span class="o">==</span> <span class="n">SYSTEM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">wake</span><span class="p">);</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_update_stats - Update the board statistics counters.</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="n">ixgbe_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw_stats</span> <span class="o">*</span><span class="n">hwstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">total_mpc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">missed_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">bprc</span><span class="p">,</span> <span class="n">lxon</span><span class="p">,</span> <span class="n">lxoff</span><span class="p">,</span> <span class="n">xon_off_tot</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">non_eop_descs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">restart_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">alloc_rx_page_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alloc_rx_buff_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hw_csum_rx_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">struct</span> <span class="n">ixgbe_fcoe</span> <span class="o">*</span><span class="n">fcoe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fcoe_noddp_counts_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_noddp_ext_buff_counts_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">rsc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">rsc_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rsc_count</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">rsc_count</span><span class="p">;</span>
			<span class="n">rsc_flush</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">rsc_flush</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rsc_total_count</span> <span class="o">=</span> <span class="n">rsc_count</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rsc_total_flush</span> <span class="o">=</span> <span class="n">rsc_flush</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">non_eop_descs</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">non_eop_descs</span><span class="p">;</span>
		<span class="n">alloc_rx_page_failed</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">alloc_rx_page_failed</span><span class="p">;</span>
		<span class="n">alloc_rx_buff_failed</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">alloc_rx_buff_failed</span><span class="p">;</span>
		<span class="n">hw_csum_rx_error</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">csum_err</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">packets</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">non_eop_descs</span> <span class="o">=</span> <span class="n">non_eop_descs</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">alloc_rx_page_failed</span> <span class="o">=</span> <span class="n">alloc_rx_page_failed</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">alloc_rx_buff_failed</span> <span class="o">=</span> <span class="n">alloc_rx_buff_failed</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_csum_rx_error</span> <span class="o">=</span> <span class="n">hw_csum_rx_error</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">packets</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* gather some stats to the adapter struct that are per queue */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">restart_queue</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">restart_queue</span><span class="p">;</span>
		<span class="n">tx_busy</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">tx_busy</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">packets</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">restart_queue</span> <span class="o">=</span> <span class="n">restart_queue</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_busy</span> <span class="o">=</span> <span class="n">tx_busy</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">packets</span><span class="p">;</span>

	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">crcerrs</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CRCERRS</span><span class="p">);</span>

	<span class="cm">/* 8 register reads */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for packet buffers not used, the register should read 0 */</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MPC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">missed_rx</span> <span class="o">+=</span> <span class="n">mpc</span><span class="p">;</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mpc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mpc</span><span class="p">;</span>
		<span class="n">total_mpc</span> <span class="o">+=</span> <span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mpc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">pxontxc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PXONTXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">pxofftxc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PXOFFTXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">rnbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RNBC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">qbtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QBTC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">qbrc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QBRC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">pxonrxc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span>
				<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PXONRXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">pxonrxc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span>
				<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PXONRXCNT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*16 register reads */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">qptc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QPTC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">qprc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QPRC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_X540</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">qbtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QBTC_L</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QBTC_H</span><span class="p">(</span><span class="n">i</span><span class="p">));</span> <span class="cm">/* to clear */</span>
			<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">qbrc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QBRC_L</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QBRC_H</span><span class="p">(</span><span class="n">i</span><span class="p">));</span> <span class="cm">/* to clear */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gprc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GPRC</span><span class="p">);</span>
	<span class="cm">/* work around hardware counting issue */</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gprc</span> <span class="o">-=</span> <span class="n">missed_rx</span><span class="p">;</span>

	<span class="n">ixgbe_update_xoff_received</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* 82598 hardware only has a 32 bit counter in the high register */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>:
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">lxonrxc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LXONRXC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gorc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GORCH</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gotc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GOTCH</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">tor</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TORH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="cm">/* OS2BMC stats are X540 only*/</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">o2bgptc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_O2BGPTC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">o2bspc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_O2BSPC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">b2ospc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_B2OSPC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">b2ogprc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_B2OGPRC</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_rx_no_dma_resources</span> <span class="o">+=</span>
					     <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_QPRDC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gorc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GORCL</span><span class="p">);</span>
		<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GORCH</span><span class="p">);</span> <span class="cm">/* to clear */</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gotc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GOTCL</span><span class="p">);</span>
		<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GOTCH</span><span class="p">);</span> <span class="cm">/* to clear */</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">tor</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TORL</span><span class="p">);</span>
		<span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TORH</span><span class="p">);</span> <span class="cm">/* to clear */</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">lxonrxc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LXONRXCNT</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fdirmatch</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FDIRMATCH</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fdirmiss</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FDIRMISS</span><span class="p">);</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fccrc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCCRC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoerpdc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCOERPDC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoeprc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCOEPRC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoeptc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCOEPTC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoedwrc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCOEDWRC</span><span class="p">);</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoedwtc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCOEDWTC</span><span class="p">);</span>
		<span class="cm">/* Add up per cpu counters for total ddp aloc fail */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcoe</span><span class="o">-&gt;</span><span class="n">pcpu_noddp</span> <span class="o">&amp;&amp;</span> <span class="n">fcoe</span><span class="o">-&gt;</span><span class="n">pcpu_noddp_ext_buff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcoe_noddp_counts_sum</span> <span class="o">+=</span>
					<span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">fcoe</span><span class="o">-&gt;</span><span class="n">pcpu_noddp</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
				<span class="n">fcoe_noddp_ext_buff_counts_sum</span> <span class="o">+=</span>
					<span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">fcoe</span><span class="o">-&gt;</span>
						<span class="n">pcpu_noddp_ext_buff</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoe_noddp</span> <span class="o">=</span> <span class="n">fcoe_noddp_counts_sum</span><span class="p">;</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">fcoe_noddp_ext_buff</span> <span class="o">=</span> <span class="n">fcoe_noddp_ext_buff_counts_sum</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bprc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_BPRC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">bprc</span> <span class="o">+=</span> <span class="n">bprc</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mprc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MPRC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mprc</span> <span class="o">-=</span> <span class="n">bprc</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">roc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ROC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">prc64</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PRC64</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">prc127</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PRC127</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">prc255</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PRC255</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">prc511</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PRC511</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">prc1023</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PRC1023</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">prc1522</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PRC1522</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">rlec</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RLEC</span><span class="p">);</span>
	<span class="n">lxon</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LXONTXC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">lxontxc</span> <span class="o">+=</span> <span class="n">lxon</span><span class="p">;</span>
	<span class="n">lxoff</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LXOFFTXC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">lxofftxc</span> <span class="o">+=</span> <span class="n">lxoff</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gptc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GPTC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mptc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MPTC</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * 82598 errata - tx of flow control packets is included in tx counters</span>
<span class="cm">	 */</span>
	<span class="n">xon_off_tot</span> <span class="o">=</span> <span class="n">lxon</span> <span class="o">+</span> <span class="n">lxoff</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gptc</span> <span class="o">-=</span> <span class="n">xon_off_tot</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mptc</span> <span class="o">-=</span> <span class="n">xon_off_tot</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">gotc</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xon_off_tot</span> <span class="o">*</span> <span class="p">(</span><span class="n">ETH_ZLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">));</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ruc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RUC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">rfc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RFC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">rjc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RJC</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">tpr</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TPR</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc64</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PTC64</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc64</span> <span class="o">-=</span> <span class="n">xon_off_tot</span><span class="p">;</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc127</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PTC127</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc255</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PTC255</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc511</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PTC511</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc1023</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PTC1023</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">ptc1522</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PTC1522</span><span class="p">);</span>
	<span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">bptc</span> <span class="o">+=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_BPTC</span><span class="p">);</span>

	<span class="cm">/* Fill out the OS statistics structure */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">mprc</span><span class="p">;</span>

	<span class="cm">/* Rx Errors */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">crcerrs</span> <span class="o">+</span> <span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">rlec</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">rlec</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">hwstats</span><span class="o">-&gt;</span><span class="n">crcerrs</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">total_mpc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_fdir_reinit_subtask - worker thread to reinit FDIR filter table</span>
<span class="cm"> * @adapter - pointer to the device adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_fdir_reinit_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_FDIR_REQUIRES_REINIT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_FDIR_REQUIRES_REINIT</span><span class="p">;</span>

	<span class="cm">/* if interface is down do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* do nothing if we are not using signature filters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fdir_overflow</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_reinit_fdir_tables_82599</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGBE_TX_FDIR_INIT_DONE</span><span class="p">,</span>
			        <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="cm">/* re-enable flow director interrupts */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMS</span><span class="p">,</span> <span class="n">IXGBE_EIMS_FLOW_DIR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;failed to finish FDIR re-initialization, &quot;</span>
		      <span class="s">&quot;ignored adding FDIR ATR filters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_check_hang_subtask - check for hung queues and dropped interrupts</span>
<span class="cm"> * @adapter - pointer to the device adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function serves two purposes.  First it strobes the interrupt lines</span>
<span class="cm"> * in order to make certain interrupts are occurring.  Secondly it sets the</span>
<span class="cm"> * bits needed to check for TX hangs.  As a result we should immediately</span>
<span class="cm"> * determine if a hang has occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_check_hang_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">eics</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re down or resetting, just bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Force detection of hung controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">set_check_for_tx_hang</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * for legacy and MSI interrupts don&#39;t set any bits</span>
<span class="cm">		 * that are enabled for EIAM, because this operation</span>
<span class="cm">		 * would set *both* EIMS and EICS for any bit in EIAM</span>
<span class="cm">		 */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EICS</span><span class="p">,</span>
			<span class="p">(</span><span class="n">IXGBE_EICS_TCP_TIMER</span> <span class="o">|</span> <span class="n">IXGBE_EICS_OTHER</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* get one bit for every active tx/rx interrupt vector */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">qv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ring</span> <span class="o">||</span> <span class="n">qv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span>
				<span class="n">eics</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Cause software interrupt to ensure rings are cleaned */</span>
	<span class="n">ixgbe_irq_rearm_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eics</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_watchdog_update_link - update the link status</span>
<span class="cm"> * @adapter - pointer to the device adapter structure</span>
<span class="cm"> * @link_speed - pointer to a u32 to store the link_speed</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_watchdog_update_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_speed</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link_up</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pfc_en</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* always assume link is up, if no check link function */</span>
		<span class="n">link_speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span><span class="p">;</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">)</span>
		<span class="n">pfc_en</span> <span class="o">|=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pfc_en</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">fc_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">ixgbe_set_rx_drop_en</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_check_timeout</span> <span class="o">+</span>
				 <span class="n">IXGBE_TRY_LINK_TIMEOUT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EIMS</span><span class="p">,</span> <span class="n">IXGBE_EIMC_LSC</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">link_speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_watchdog_link_is_up - update netif_carrier status and</span>
<span class="cm"> *                             print link up message</span>
<span class="cm"> * @adapter - pointer to the device adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_watchdog_link_is_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_speed</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flow_rx</span><span class="p">,</span> <span class="n">flow_tx</span><span class="p">;</span>

	<span class="cm">/* only continue if link was previously down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_SEARCH_FOR_SFP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82598EB</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">frctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">rmcs</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RMCS</span><span class="p">);</span>
		<span class="n">flow_rx</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">frctl</span> <span class="o">&amp;</span> <span class="n">IXGBE_FCTRL_RFCE</span><span class="p">);</span>
		<span class="n">flow_tx</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rmcs</span> <span class="o">&amp;</span> <span class="n">IXGBE_RMCS_TFCE_802_3X</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mflcn</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MFLCN</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">fccfg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCCFG</span><span class="p">);</span>
		<span class="n">flow_rx</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mflcn</span> <span class="o">&amp;</span> <span class="n">IXGBE_MFLCN_RFCE</span><span class="p">);</span>
		<span class="n">flow_tx</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fccfg</span> <span class="o">&amp;</span> <span class="n">IXGBE_FCCFG_TFCE_802_3X</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">flow_tx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">flow_rx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_start_cyclecounter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">e_info</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;NIC Link is Up %s, Flow Control: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">link_speed</span> <span class="o">==</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span> <span class="o">?</span>
	       <span class="s">&quot;10 Gbps&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">link_speed</span> <span class="o">==</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span> <span class="o">?</span>
	       <span class="s">&quot;1 Gbps&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">link_speed</span> <span class="o">==</span> <span class="n">IXGBE_LINK_SPEED_100_FULL</span> <span class="o">?</span>
	       <span class="s">&quot;100 Mbps&quot;</span> <span class="o">:</span>
	       <span class="s">&quot;unknown speed&quot;</span><span class="p">))),</span>
	       <span class="p">((</span><span class="n">flow_rx</span> <span class="o">&amp;&amp;</span> <span class="n">flow_tx</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RX/TX&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">flow_rx</span> <span class="o">?</span> <span class="s">&quot;RX&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">flow_tx</span> <span class="o">?</span> <span class="s">&quot;TX&quot;</span> <span class="o">:</span> <span class="s">&quot;None&quot;</span><span class="p">))));</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ixgbe_check_vf_rate_limit</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_watchdog_link_is_down - update netif_carrier status and</span>
<span class="cm"> *                               print link down message</span>
<span class="cm"> * @adapter - pointer to the adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_watchdog_link_is_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* only continue if link was up previously */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* poll for SFP+ cable when link is down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_is_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_SEARCH_FOR_SFP</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_start_cyclecounter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">e_info</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;NIC Link is Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_watchdog_flush_tx - flush queues on link down</span>
<span class="cm"> * @adapter - pointer to the device adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_watchdog_flush_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">some_tx_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">!=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">some_tx_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">some_tx_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We&#39;ve lost link, so the controller stops DMA,</span>
<span class="cm">			 * but we&#39;ve got queued Tx work that&#39;s never going</span>
<span class="cm">			 * to get done, so reset controller to flush Tx.</span>
<span class="cm">			 * (Do the reset outside of interrupt context).</span>
<span class="cm">			 */</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_RESET_REQUESTED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_spoof_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ssvpc</span><span class="p">;</span>

	<span class="cm">/* Do not perform spoof check for 82598 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ssvpc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SSVPC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ssvpc register is cleared on read, if zero then no</span>
<span class="cm">	 * spoofed packets in the last interval.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssvpc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">e_warn</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;%d Spoofed packets detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ssvpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_watchdog_subtask - check and bring link up</span>
<span class="cm"> * @adapter - pointer to the device adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_watchdog_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if interface is down do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ixgbe_watchdog_update_link</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">ixgbe_watchdog_link_is_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ixgbe_watchdog_link_is_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_spoof_check</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_update_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_watchdog_flush_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_sfp_detection_subtask - poll for SFP+ cable</span>
<span class="cm"> * @adapter - the ixgbe adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_sfp_detection_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* not searching for SFP so there is nothing to do here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_SEARCH_FOR_SFP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* someone else is in init, wait until next service event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_IN_SFP_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">identify_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sfp_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If no cable is present, then we need to reset</span>
<span class="cm">		 * the next time we find a good cable. */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* exit on error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sfp_out</span><span class="p">;</span>

	<span class="cm">/* exit if reset not needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">sfp_out</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_SFP_NEEDS_RESET</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A module may be identified correctly, but the EEPROM may not have</span>
<span class="cm">	 * support for that module.  setup_sfp() will fail in that case, so</span>
<span class="cm">	 * we should not allow that module to load.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sfp_out</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_NEED_LINK_CONFIG</span><span class="p">;</span>
	<span class="n">e_info</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;detected SFP+: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">sfp_type</span><span class="p">);</span>

<span class="nl">sfp_out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_IN_SFP_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">==</span> <span class="n">NETREG_REGISTERED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;failed to initialize because an unsupported &quot;</span>
			  <span class="s">&quot;SFP+ module type was detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;Reload the driver after installing a &quot;</span>
			  <span class="s">&quot;supported module.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_sfp_link_config_subtask - set up link SFP after module install</span>
<span class="cm"> * @adapter - the ixgbe adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_sfp_link_config_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">negotiation</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_NEED_LINK_CONFIG</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* someone else is in init, wait until next service event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_IN_SFP_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_NEED_LINK_CONFIG</span><span class="p">;</span>

	<span class="n">autoneg</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">autoneg_advertised</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">autoneg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_link_capabilities</span><span class="p">))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_link_capabilities</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autoneg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">negotiation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">negotiation</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_check_timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_IN_SFP_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_check_for_bad_vf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ciaa</span><span class="p">,</span> <span class="n">ciad</span><span class="p">;</span>

	<span class="n">gpc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXDGPC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpc</span><span class="p">)</span> <span class="cm">/* If incrementing then no need for the check below */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check to see if a bad DMA write target from an errant or</span>
<span class="cm">	 * malicious VF has caused a PCIe error.  If so then we can</span>
<span class="cm">	 * issue a VFLR to the offending VF(s) and then resume without</span>
<span class="cm">	 * requesting a full slot reset.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vf</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span> <span class="n">vf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ciaa</span> <span class="o">=</span> <span class="p">(</span><span class="n">vf</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="cm">/* 32 bit read so align, we really want status at offset 6 */</span>
		<span class="n">ciaa</span> <span class="o">|=</span> <span class="n">PCI_COMMAND</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CIAA_82599</span><span class="p">,</span> <span class="n">ciaa</span><span class="p">);</span>
		<span class="n">ciad</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CIAD_82599</span><span class="p">);</span>
		<span class="n">ciaa</span> <span class="o">&amp;=</span> <span class="mh">0x7FFFFFFF</span><span class="p">;</span>
		<span class="cm">/* disable debug mode asap after reading data */</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CIAA_82599</span><span class="p">,</span> <span class="n">ciaa</span><span class="p">);</span>
		<span class="cm">/* Get the upper 16 bits which will be the PCI status reg */</span>
		<span class="n">ciad</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ciad</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_REC_MASTER_ABORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;VF %d Hung DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
			<span class="cm">/* Issue VFLR */</span>
			<span class="n">ciaa</span> <span class="o">=</span> <span class="p">(</span><span class="n">vf</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">ciaa</span> <span class="o">|=</span> <span class="mh">0xA8</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CIAA_82599</span><span class="p">,</span> <span class="n">ciaa</span><span class="p">);</span>
			<span class="n">ciad</span> <span class="o">=</span> <span class="mh">0x00008000</span><span class="p">;</span>  <span class="cm">/* VFLR */</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CIAD_82599</span><span class="p">,</span> <span class="n">ciad</span><span class="p">);</span>
			<span class="n">ciaa</span> <span class="o">&amp;=</span> <span class="mh">0x7FFFFFFF</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CIAA_82599</span><span class="p">,</span> <span class="n">ciaa</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>
<span class="cm">/**</span>
<span class="cm"> * ixgbe_service_timer - Timer Call-back</span>
<span class="cm"> * @data: pointer to adapter cast into an unsigned long</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_service_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_event_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* poll faster when waiting for link */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">)</span>
		<span class="n">next_event_offset</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">next_event_offset</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="cm">/*</span>
<span class="cm">	 * don&#39;t bother with SR-IOV VF DMA hang check if there are</span>
<span class="cm">	 * no VFs or the link is down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_NEED_LINK_UPDATE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">normal_timer_service</span><span class="p">;</span>

	<span class="cm">/* If we have VFs allocated then we must check for DMA hangs */</span>
	<span class="n">ixgbe_check_for_bad_vf</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">next_event_offset</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">timer_event_accumulator</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">timer_event_accumulator</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">timer_event_accumulator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">normal_timer_service:</span>
<span class="cp">#endif</span>
	<span class="cm">/* Reset the timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_timer</span><span class="p">,</span> <span class="n">next_event_offset</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ready</span><span class="p">)</span>
		<span class="n">ixgbe_service_event_schedule</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_reset_subtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RESET_REQUESTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_RESET_REQUESTED</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re already down or resetting, just bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ixgbe_dump</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Reset adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ixgbe_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_service_task - manages and runs subtasks</span>
<span class="cm"> * @work: pointer to work_struct containing our data</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_service_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">ixgbe_adapter</span><span class="p">,</span>
						     <span class="n">service_task</span><span class="p">);</span>

	<span class="n">ixgbe_reset_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_sfp_detection_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_sfp_link_config_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_check_overtemp_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_watchdog_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_fdir_reinit_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_check_hang_subtask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_overflow_check</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ixgbe_service_event_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_tso</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="o">*</span><span class="n">hdr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlan_macip_lens</span><span class="p">,</span> <span class="n">type_tucmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mss_l4len_idx</span><span class="p">,</span> <span class="n">l4len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_header_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ADV DTYP TUCMD MKRLOC/ISCSIHEDLEN */</span>
	<span class="n">type_tucmd</span> <span class="o">=</span> <span class="n">IXGBE_ADVTXD_TUCMD_L4T_TCP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
							 <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							 <span class="n">IPPROTO_TCP</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">);</span>
		<span class="n">type_tucmd</span> <span class="o">|=</span> <span class="n">IXGBE_ADVTXD_TUCMD_IPV4</span><span class="p">;</span>
		<span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_TSO</span> <span class="o">|</span>
				   <span class="n">IXGBE_TX_FLAGS_CSUM</span> <span class="o">|</span>
				   <span class="n">IXGBE_TX_FLAGS_IPV4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso_v6</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">payload_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span>
		    <span class="o">~</span><span class="n">csum_ipv6_magic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_TSO</span> <span class="o">|</span>
				   <span class="n">IXGBE_TX_FLAGS_CSUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* compute header lengths */</span>
	<span class="n">l4len</span> <span class="o">=</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="o">*</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">l4len</span><span class="p">;</span>

	<span class="cm">/* update gso size and bytecount with header size */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">gso_segs</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_segs</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">bytecount</span> <span class="o">+=</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">gso_segs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="o">*</span><span class="n">hdr_len</span><span class="p">;</span>

	<span class="cm">/* mss_l4len_id: use 1 as index for TSO */</span>
	<span class="n">mss_l4len_idx</span> <span class="o">=</span> <span class="n">l4len</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_L4LEN_SHIFT</span><span class="p">;</span>
	<span class="n">mss_l4len_idx</span> <span class="o">|=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_MSS_SHIFT</span><span class="p">;</span>
	<span class="n">mss_l4len_idx</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_IDX_SHIFT</span><span class="p">;</span>

	<span class="cm">/* vlan_macip_lens: HEADLEN, MACLEN, VLAN tag */</span>
	<span class="n">vlan_macip_lens</span> <span class="o">=</span> <span class="n">skb_network_header_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">vlan_macip_lens</span> <span class="o">|=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_MACLEN_SHIFT</span><span class="p">;</span>
	<span class="n">vlan_macip_lens</span> <span class="o">|=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_VLAN_MASK</span><span class="p">;</span>

	<span class="n">ixgbe_tx_ctxtdesc</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">vlan_macip_lens</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type_tucmd</span><span class="p">,</span>
			  <span class="n">mss_l4len_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_tx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlan_macip_lens</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mss_l4len_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">type_tucmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">!=</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_HW_VLAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_TXSW</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">l4_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span>:
			<span class="n">vlan_macip_lens</span> <span class="o">|=</span> <span class="n">skb_network_header_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">type_tucmd</span> <span class="o">|=</span> <span class="n">IXGBE_ADVTXD_TUCMD_IPV4</span><span class="p">;</span>
			<span class="n">l4_hdr</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">)</span>:
			<span class="n">vlan_macip_lens</span> <span class="o">|=</span> <span class="n">skb_network_header_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">l4_hdr</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">net_ratelimit</span><span class="p">()))</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;partial checksum but proto=%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">l4_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
			<span class="n">type_tucmd</span> <span class="o">|=</span> <span class="n">IXGBE_ADVTXD_TUCMD_L4T_TCP</span><span class="p">;</span>
			<span class="n">mss_l4len_idx</span> <span class="o">=</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">IXGBE_ADVTXD_L4LEN_SHIFT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_SCTP</span>:
			<span class="n">type_tucmd</span> <span class="o">|=</span> <span class="n">IXGBE_ADVTXD_TUCMD_L4T_SCTP</span><span class="p">;</span>
			<span class="n">mss_l4len_idx</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sctphdr</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">IXGBE_ADVTXD_L4LEN_SHIFT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
			<span class="n">mss_l4len_idx</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">IXGBE_ADVTXD_L4LEN_SHIFT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">net_ratelimit</span><span class="p">()))</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;partial checksum but l4 proto=%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">l4_hdr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update TX checksum flag */</span>
		<span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_CSUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* vlan_macip_lens: MACLEN, VLAN tag */</span>
	<span class="n">vlan_macip_lens</span> <span class="o">|=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_MACLEN_SHIFT</span><span class="p">;</span>
	<span class="n">vlan_macip_lens</span> <span class="o">|=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_VLAN_MASK</span><span class="p">;</span>

	<span class="n">ixgbe_tx_ctxtdesc</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">vlan_macip_lens</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">type_tucmd</span><span class="p">,</span> <span class="n">mss_l4len_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__le32</span> <span class="n">ixgbe_tx_cmd_type</span><span class="p">(</span><span class="n">u32</span> <span class="n">tx_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set type for advanced descriptor with frame checksum insertion */</span>
	<span class="n">__le32</span> <span class="n">cmd_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_DTYP_DATA</span> <span class="o">|</span>
				      <span class="n">IXGBE_ADVTXD_DCMD_IFCS</span> <span class="o">|</span>
				      <span class="n">IXGBE_ADVTXD_DCMD_DEXT</span><span class="p">);</span>

	<span class="cm">/* set HW vlan bit if vlan is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_HW_VLAN</span><span class="p">)</span>
		<span class="n">cmd_type</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_DCMD_VLE</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_TSTAMP</span><span class="p">)</span>
		<span class="n">cmd_type</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_MAC_TSTAMP</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* set segmentation enable bits for TSO/FSO */</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGBE_TX_FLAGS_TSO</span> <span class="o">|</span> <span class="n">IXGBE_TX_FLAGS_FSO</span><span class="p">))</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_TSO</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">cmd_type</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_DCMD_TSE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_tx_olinfo_status</span><span class="p">(</span><span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">tx_flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">paylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">olinfo_status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">paylen</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_PAYLEN_SHIFT</span><span class="p">);</span>

	<span class="cm">/* enable L4 checksum for TSO and TX checksum offload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_CSUM</span><span class="p">)</span>
		<span class="n">olinfo_status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_POPTS_TXSM</span><span class="p">);</span>

	<span class="cm">/* enble IPv4 checksum for TSO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_IPV4</span><span class="p">)</span>
		<span class="n">olinfo_status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_POPTS_IXSM</span><span class="p">);</span>

	<span class="cm">/* use index 1 context for TSO/FSO/FCOE */</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGBE_TX_FLAGS_TSO</span> <span class="o">|</span> <span class="n">IXGBE_TX_FLAGS_FCOE</span><span class="p">))</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_TSO</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">olinfo_status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_ADVTXD_IDX_SHIFT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check Context must be set if Tx switch is enabled, which it</span>
<span class="cm">	 * always is for case where virtual functions are running</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGBE_TX_FLAGS_TXSW</span> <span class="o">|</span> <span class="n">IXGBE_TX_FLAGS_FCOE</span><span class="p">))</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_TXSW</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">olinfo_status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_CC</span><span class="p">);</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span> <span class="o">=</span> <span class="n">olinfo_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IXGBE_TXD_CMD (IXGBE_TXD_CMD_EOP | \</span>
<span class="cp">		       IXGBE_TXD_CMD_RS)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_tx_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="n">hdr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ixgbe_adv_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">paylen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">cmd_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>

	<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">ixgbe_tx_olinfo_status</span><span class="p">(</span><span class="n">tx_desc</span><span class="p">,</span> <span class="n">tx_flags</span><span class="p">,</span> <span class="n">paylen</span><span class="p">);</span>
	<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">ixgbe_tx_cmd_type</span><span class="p">(</span><span class="n">tx_flags</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_FCOE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">)</span> <span class="o">-</span> <span class="n">data_len</span><span class="p">;</span>
			<span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#endif</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">dma_error</span><span class="p">;</span>

	<span class="cm">/* record length, and DMA address */</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span> <span class="o">=</span>
				<span class="n">cmd_type</span> <span class="o">|</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">);</span>

			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dma</span> <span class="o">+=</span> <span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">;</span>

			<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">data_len</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">no_fcs</span><span class="p">))</span>
			<span class="n">cmd_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_ADVTXD_DCMD_IFCS</span><span class="p">));</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span> <span class="o">=</span> <span class="n">cmd_type</span> <span class="o">|</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
<span class="cp">#else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">data_len</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">dma</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">dma_error</span><span class="p">;</span>

		<span class="n">tx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>

		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">frag</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write last descriptor with RS and EOP bits */</span>
	<span class="n">cmd_type</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGBE_TXD_CMD</span><span class="p">);</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span> <span class="o">=</span> <span class="n">cmd_type</span><span class="p">;</span>

	<span class="n">netdev_tx_sent_queue</span><span class="p">(</span><span class="n">txring_txq</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">),</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">bytecount</span><span class="p">);</span>

	<span class="cm">/* set the timestamp */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force memory writes to complete before letting h/w know there</span>
<span class="cm">	 * are new descriptors to fetch.  (Only applicable for weak-ordered</span>
<span class="cm">	 * memory model archs, such as IA-64).</span>
<span class="cm">	 *</span>
<span class="cm">	 * We also need this memory barrier to make certain all of the</span>
<span class="cm">	 * status bits have been updated before next_to_watch is written.</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* set next_to_watch value indicating a packet is present */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">next_to_watch</span> <span class="o">=</span> <span class="n">tx_desc</span><span class="p">;</span>

	<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* notify HW of packet */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">dma_error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX DMA map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* clear dma mappings for failed tx_buffer_info map */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">tx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ixgbe_unmap_and_free_tx_resource</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">tx_buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_buffer</span> <span class="o">==</span> <span class="n">first</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_atr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ixgbe_atr_hash_dword</span> <span class="n">input</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dword</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">ixgbe_atr_hash_dword</span> <span class="n">common</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dword</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">network</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ipv4</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ipv6hdr</span> <span class="o">*</span><span class="n">ipv6</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">vlan_id</span><span class="p">;</span>

	<span class="cm">/* if ring doesn&#39;t have a interrupt vector, cannot perform ATR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q_vector</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* do nothing if sampling is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* snag network header to get L4 type and address */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Currently only IPv4/IPv6 with TCP is supported */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">nexthdr</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* skip this packet since it is invalid or the socket is closing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">th</span> <span class="o">||</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* sample on all syn packets or once every atr sample count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_count</span> <span class="o">&lt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_sample_rate</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* reset sample count */</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">atr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vlan_id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&gt;&gt;</span> <span class="n">IXGBE_TX_FLAGS_VLAN_SHIFT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * src and dst are inverted, think how the receiver sees them</span>
<span class="cm">	 *</span>
<span class="cm">	 * The input is broken into two sections, a non-compressed section</span>
<span class="cm">	 * containing vm_pool, vlan_id, and flow_type.  The rest of the data</span>
<span class="cm">	 * is XORed together and stored in the compressed dword.</span>
<span class="cm">	 */</span>
	<span class="n">input</span><span class="p">.</span><span class="n">formatted</span><span class="p">.</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * since src port and flex bytes occupy the same word XOR them together</span>
<span class="cm">	 * and write the value to source port portion of compressed dword</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGBE_TX_FLAGS_SW_VLAN</span> <span class="o">|</span> <span class="n">IXGBE_TX_FLAGS_HW_VLAN</span><span class="p">))</span>
		<span class="n">common</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">src</span> <span class="o">^=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">^</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">common</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">src</span> <span class="o">^=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">^</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">common</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">dst</span> <span class="o">^=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input</span><span class="p">.</span><span class="n">formatted</span><span class="p">.</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">IXGBE_ATR_FLOW_TYPE_TCPV4</span><span class="p">;</span>
		<span class="n">common</span><span class="p">.</span><span class="n">ip</span> <span class="o">^=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">^</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input</span><span class="p">.</span><span class="n">formatted</span><span class="p">.</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">IXGBE_ATR_FLOW_TYPE_TCPV6</span><span class="p">;</span>
		<span class="n">common</span><span class="p">.</span><span class="n">ip</span> <span class="o">^=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span>
			     <span class="n">hdr</span><span class="p">.</span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* This assumes the Rx queue and Tx queue are bound to the same CPU */</span>
	<span class="n">ixgbe_fdir_add_signature_filter_82599</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_vector</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					      <span class="n">input</span><span class="p">,</span> <span class="n">common</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_subqueue</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
	<span class="cm">/* Herbert&#39;s original patch had:</span>
<span class="cm">	 *  smp_mb__after_netif_stop_queue();</span>
<span class="cm">	 * but since that doesn&#39;t exist yet, just open code it. */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/* We need to check again in a case another CPU has just</span>
<span class="cm">	 * made room available. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ixgbe_desc_unused</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* A reprieve! - use start_queue because it doesn&#39;t call schedule */</span>
	<span class="n">netif_start_subqueue</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
	<span class="o">++</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">restart_queue</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ixgbe_desc_unused</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">ixgbe_select_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">txq</span> <span class="o">=</span> <span class="n">skb_rx_queue_recorded</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb_get_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">:</span>
					       <span class="n">smp_processor_id</span><span class="p">();</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="n">__be16</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">vlan_get_protocol</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txq</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">[</span><span class="n">RING_F_FCOE</span><span class="p">].</span><span class="n">indices</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">txq</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_feature</span><span class="p">[</span><span class="n">RING_F_FCOE</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">txq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">txq</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">real_num_tx_queues</span><span class="p">))</span>
			<span class="n">txq</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">real_num_tx_queues</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">txq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb_tx_hash</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">netdev_tx_t</span> <span class="n">ixgbe_xmit_frame_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_tx_buffer</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tso</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if PAGE_SIZE &gt; IXGBE_MAX_DATA_PER_TXD</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">f</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">TXD_USE_COUNT</span><span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">__be16</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * need: 1 descriptor per page * PAGE_SIZE/IXGBE_MAX_DATA_PER_TXD,</span>
<span class="cm">	 *       + 1 desc for skb_headlen/IXGBE_MAX_DATA_PER_TXD,</span>
<span class="cm">	 *       + 2 desc gap to keep tail from touching head,</span>
<span class="cm">	 *       + 1 desc for context descriptor,</span>
<span class="cm">	 * otherwise try next time</span>
<span class="cm">	 */</span>
<span class="cp">#if PAGE_SIZE &gt; IXGBE_MAX_DATA_PER_TXD</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">TXD_USE_COUNT</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">tx_busy</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* record the location of the first descriptor for this packet */</span>
	<span class="n">first</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">];</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">bytecount</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">gso_segs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if we have a HW VLAN tag being added default to the HW one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_TX_FLAGS_VLAN_SHIFT</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_HW_VLAN</span><span class="p">;</span>
	<span class="cm">/* else if it is a SW VLAN check the next protocol and store the tag */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vlan_hdr</span> <span class="o">*</span><span class="n">vhdr</span><span class="p">,</span> <span class="n">_vhdr</span><span class="p">;</span>
		<span class="n">vhdr</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_vhdr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_vhdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vhdr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>

		<span class="n">protocol</span> <span class="o">=</span> <span class="n">vhdr</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">vhdr</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				  <span class="n">IXGBE_TX_FLAGS_VLAN_SHIFT</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_SW_VLAN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">SKBTX_HW_TSTAMP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">SKBTX_IN_PROGRESS</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_TSTAMP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use the l2switch_enable flag - would be false if the DMA</span>
<span class="cm">	 * Tx switch had been disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_TXSW</span><span class="p">;</span>

<span class="cp">#endif</span>
	<span class="cm">/* DCB maps skb priorities 0-7 onto 3 bit PCP of VLAN tag. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGBE_TX_FLAGS_HW_VLAN</span> <span class="o">|</span> <span class="n">IXGBE_TX_FLAGS_SW_VLAN</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">!=</span> <span class="n">TC_PRIO_CONTROL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_TX_FLAGS_VLAN_PRIO_MASK</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">IXGBE_TX_FLAGS_VLAN_PRIO_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_TX_FLAGS_SW_VLAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="n">vhdr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_header_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
			<span class="n">vhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">vhdr</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">tx_flags</span> <span class="o">&gt;&gt;</span>
						 <span class="n">IXGBE_TX_FLAGS_VLAN_SHIFT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGBE_TX_FLAGS_HW_VLAN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* record initial flags and protocol */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_flags</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="cm">/* setup tx offload for FCoE */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tso</span> <span class="o">=</span> <span class="n">ixgbe_fso</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tso</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">xmit_fcoe</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="n">tso</span> <span class="o">=</span> <span class="n">ixgbe_tso</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tso</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tso</span><span class="p">)</span>
		<span class="n">ixgbe_tx_csum</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

	<span class="cm">/* add the ATR filter if ATR is on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_TX_FDIR_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">ixgbe_atr</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
<span class="nl">xmit_fcoe:</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="n">ixgbe_tx_map</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="n">ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">DESC_NEEDED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">out_drop:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ixgbe_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The minimum packet size for olinfo paylen is 17 so pad the skb</span>
<span class="cm">	 * in order to meet this minimum size requirement.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">ixgbe_xmit_frame_ring</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_set_mac - Change the Ethernet Address of the NIC</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> * @p: pointer to an address structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rar</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">,</span>
			    <span class="n">IXGBE_RAH_AV</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">ixgbe_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prtad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prtad</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prtad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devad</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prtad</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="k">case</span> <span class="n">SIOCSHWTSTAMP</span>:
		<span class="k">return</span> <span class="n">ixgbe_ptp_hwtstamp_ioctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">mdio_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_add_sanmac_netdev - Add the SAN MAC address to the corresponding</span>
<span class="cm"> * netdev-&gt;dev_addrs</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_add_sanmac_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">san_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev_addr_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">san_addr</span><span class="p">,</span> <span class="n">NETDEV_HW_ADDR_T_SAN</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_del_sanmac_netdev - Removes the SAN MAC address to the corresponding</span>
<span class="cm"> * netdev-&gt;dev_addrs</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_del_sanmac_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">san_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dev_addr_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">san_addr</span><span class="p">,</span> <span class="n">NETDEV_HW_ADDR_T_SAN</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling &#39;interrupt&#39; - used by things like netconsole to send skbs</span>
<span class="cm"> * without having to re-enable interrupts. It&#39;s not called while</span>
<span class="cm"> * the interrupt routine is executing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* if interface is down do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_IN_NETPOLL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">num_q_vectors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vectors</span> <span class="o">-</span> <span class="n">NON_Q_VECTORS</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_q_vectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ixgbe_q_vector</span> <span class="o">*</span><span class="n">q_vector</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">q_vector</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ixgbe_msix_clean_rings</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_vector</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ixgbe_intr</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_IN_NETPOLL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">ixgbe_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">u64</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">packets</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
				<span class="n">packets</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
				<span class="n">bytes</span>   <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">packets</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span>   <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgbe_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">u64</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">packets</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
				<span class="n">packets</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
				<span class="n">bytes</span>   <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">packets</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span>   <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="cm">/* following stats updated by ixgbe_watchdog_task() */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span>	<span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span>	<span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span>	<span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span>	<span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span>	<span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
<span class="cm">/* ixgbe_validate_rtr - verify 802.1Qp to Rx packet buffer mapping is valid.</span>
<span class="cm"> * #adapter: pointer to ixgbe_adapter</span>
<span class="cm"> * @tc: number of traffic classes currently enabled</span>
<span class="cm"> *</span>
<span class="cm"> * Configure a valid 802.1Qp to Rx packet buffer mapping ie confirm</span>
<span class="cm"> * 802.1Q priority maps to a packet buffer that exists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_validate_rtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">rsave</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* 82598 have a static priority to TC mapping that can not</span>
<span class="cm">	 * be changed so no validation is needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RTRUP2TC</span><span class="p">);</span>
	<span class="n">rsave</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">up2tc</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">IXGBE_RTRUP2TC_UP_SHIFT</span><span class="p">);</span>

		<span class="cm">/* If up2tc is out of bounds default to zero */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up2tc</span> <span class="o">&gt;</span> <span class="n">tc</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_RTRUP2TC_UP_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">rsave</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RTRUP2TC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ixgbe_setup_tc - routine to configure net_device for multiple traffic</span>
<span class="cm"> * classes.</span>
<span class="cm"> *</span>
<span class="cm"> * @netdev: net device to configure</span>
<span class="cm"> * @tc: number of traffic classes to enable</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ixgbe_setup_tc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Multiple traffic classes requires multiple queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_MSIX_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;Enable failed, needs MSI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware supports up to 8 traffic classes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span> <span class="o">&amp;&amp;</span>
	     <span class="n">tc</span> <span class="o">&lt;</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Hardware has to reinitialize queues and interrupts to</span>
<span class="cm">	 * match packet buffer alignment. Unfortunately, the</span>
<span class="cm">	 * hardware is not flexible enough to do this dynamically.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ixgbe_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ixgbe_clear_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_set_num_tc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">last_lfc_mode</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">ixgbe_fc_none</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_reset_tc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">last_lfc_mode</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_init_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_validate_rtr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ixgbe_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_DCB */</span><span class="cp"></span>
<span class="kt">void</span> <span class="n">ixgbe_do_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgbe_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ixgbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="n">ixgbe_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					    <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* return error if RXHASH is being enabled when RSS is not supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_RXHASH</span><span class="p">;</span>

	<span class="cm">/* If Rx checksum is disabled, then RSC/LRO should also be disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="cm">/* Turn off LRO if not RSC capable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_CAPABLE</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">need_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Make sure RSC matches LRO, reset if change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">)</span>
			<span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_itr_setting</span> <span class="o">&gt;</span> <span class="n">IXGBE_MIN_RSC_ITR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">;</span>
			<span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">^</span> <span class="n">features</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e_info</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;rx-usecs set too low, &quot;</span>
			       <span class="s">&quot;disabling RSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if Flow Director n-tuple support was enabled or disabled.  If</span>
<span class="cm">	 * the state changed, we need to reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_NTUPLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_PERFECT_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* turn off Flow Director, set ATR and reset */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">))</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">;</span>
			<span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_FDIR_PERFECT_CAPABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FDIR_PERFECT_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* turn off ATR, enable perfect filters and reset */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_FDIR_HASH_CAPABLE</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_FDIR_PERFECT_CAPABLE</span><span class="p">;</span>
		<span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">ixgbe_vlan_strip_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ixgbe_vlan_strip_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span>
		<span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_reset</span><span class="p">)</span>
		<span class="n">ixgbe_do_reset</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_ndo_fdb_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndmsg</span> <span class="o">*</span><span class="n">ndm</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndm</span><span class="o">-&gt;</span><span class="n">ndm_state</span> <span class="o">&amp;</span> <span class="n">NUD_PERMANENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: FDB only supports static addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ixgbe_driver_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_unicast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dev_uc_add_excl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dev_mc_add_excl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only return duplicate errors if NLM_F_EXCL is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_EXCL</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_ndo_fdb_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndmsg</span> <span class="o">*</span><span class="n">ndm</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndm</span><span class="o">-&gt;</span><span class="n">ndm_state</span> <span class="o">&amp;</span> <span class="n">NUD_PERMANENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: FDB only supports static addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ixgbe_driver_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_unicast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dev_uc_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dev_mc_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgbe_ndo_fdb_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ndo_dflt_fdb_dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ixgbe_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ixgbe_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ixgbe_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ixgbe_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_select_queue</span>	<span class="o">=</span> <span class="n">ixgbe_select_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ixgbe_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ixgbe_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">ixgbe_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ixgbe_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">ixgbe_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">ixgbe_vlan_rx_kill_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">ixgbe_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_mac</span>		<span class="o">=</span> <span class="n">ixgbe_ndo_set_vf_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_vlan</span>	<span class="o">=</span> <span class="n">ixgbe_ndo_set_vf_vlan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_tx_rate</span>	<span class="o">=</span> <span class="n">ixgbe_ndo_set_vf_bw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_spoofchk</span>	<span class="o">=</span> <span class="n">ixgbe_ndo_set_vf_spoofchk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_vf_config</span>	<span class="o">=</span> <span class="n">ixgbe_ndo_get_vf_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">ixgbe_get_stats64</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
	<span class="p">.</span><span class="n">ndo_setup_tc</span>		<span class="o">=</span> <span class="n">ixgbe_setup_tc</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">ixgbe_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="p">.</span><span class="n">ndo_fcoe_ddp_setup</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_ddp_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fcoe_ddp_target</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_ddp_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fcoe_ddp_done</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_ddp_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fcoe_enable</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fcoe_disable</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fcoe_get_wwn</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_get_wwn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fcoe_get_hbainfo</span> <span class="o">=</span> <span class="n">ixgbe_fcoe_get_hbainfo</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">ndo_set_features</span> <span class="o">=</span> <span class="n">ixgbe_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span> <span class="o">=</span> <span class="n">ixgbe_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fdb_add</span>		<span class="o">=</span> <span class="n">ixgbe_ndo_fdb_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fdb_del</span>		<span class="o">=</span> <span class="n">ixgbe_ndo_fdb_del</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fdb_dump</span>		<span class="o">=</span> <span class="n">ixgbe_ndo_fdb_dump</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ixgbe_probe_vf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbe_info</span> <span class="o">*</span><span class="n">ii</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* The 82599 supports up to 64 VFs per physical function</span>
<span class="cm">	 * but this implementation limits allocation to 63 so that</span>
<span class="cm">	 * basic networking resources are still available to the</span>
<span class="cm">	 * physical function.  If the user requests greater thn</span>
<span class="cm">	 * 63 VFs then it is an error - reset to default of zero.</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_vfs</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">max_vfs</span><span class="p">;</span>
	<span class="n">ixgbe_enable_sriov</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_IOV */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_wol_supported - Check whether device supports WoL</span>
<span class="cm"> * @hw: hw specific details</span>
<span class="cm"> * @device_id: the device ID</span>
<span class="cm"> * @subdev_id: the subsystem device ID</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used by probe and ethtool to determine</span>
<span class="cm"> * which devices have WoL support</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">ixgbe_wol_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device_id</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">subdevice_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wol_cap</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeprom_cap</span> <span class="o">&amp;</span> <span class="n">IXGBE_DEVICE_CAPS_WOL_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_wol_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82599_SFP</span>:
		<span class="cm">/* Only these subdevices could supports WOL */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">subdevice_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IXGBE_SUBDEV_ID_82599_560FLR</span>:
			<span class="cm">/* only support first port */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">func</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IXGBE_SUBDEV_ID_82599_SFP</span>:
			<span class="n">is_wol_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82599_COMBO_BACKPLANE</span>:
		<span class="cm">/* All except this subdevice support WOL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subdevice_id</span> <span class="o">!=</span> <span class="n">IXGBE_SUBDEV_ID_82599_KX4_KR_MEZZ</span><span class="p">)</span>
			<span class="n">is_wol_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82599_KX4</span>:
		<span class="n">is_wol_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_X540T</span>:
		<span class="cm">/* check eeprom to see if enabled wol */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wol_cap</span> <span class="o">==</span> <span class="n">IXGBE_DEVICE_CAPS_WOL_PORT0_1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">wol_cap</span> <span class="o">==</span> <span class="n">IXGBE_DEVICE_CAPS_WOL_PORT0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">func</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">is_wol_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">is_wol_supported</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_probe - Device Initialization Routine</span>
<span class="cm"> * @pdev: PCI device information struct</span>
<span class="cm"> * @ent: entry in ixgbe_pci_tbl</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_probe initializes an adapter identified by a pci_dev structure.</span>
<span class="cm"> * The OS initialization, configuring of the adapter private structure,</span>
<span class="cm"> * and a hardware reset occur.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ixgbe_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbe_info</span> <span class="o">*</span><span class="n">ii</span> <span class="o">=</span> <span class="n">ixgbe_info_tbl</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">pci_using_dac</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">part_str</span><span class="p">[</span><span class="n">IXGBE_PBANUM_LENGTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">num_possible_cpus</span><span class="p">();</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="n">u16</span> <span class="n">device_caps</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u32</span> <span class="n">eec</span><span class="p">;</span>

	<span class="cm">/* Catch broken hardware that put the wrong VF device ID in</span>
<span class="cm">	 * the PCIe SR-IOV capability.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s (%hx:%hx) should not be a VF!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_dma</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="n">IORESOURCE_MEM</span><span class="p">),</span> <span class="n">ixgbe_driver_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pci_request_selected_regions failed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pci_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
	<span class="n">indices</span> <span class="o">*=</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">IXGBE_MAX_RSS_INDICES</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">IXGBE_MAX_FDIR_INDICES</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="n">indices</span> <span class="o">+=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">num_possible_cpus</span><span class="p">(),</span>
			 <span class="n">IXGBE_MAX_FCOE_INDICES</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span><span class="p">),</span> <span class="n">indices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_etherdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">back</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">DEFAULT_MSG_ENABLE</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_netdev_ops</span><span class="p">;</span>
	<span class="n">ixgbe_set_ethtool_ops</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bd_number</span> <span class="o">=</span> <span class="n">cards_found</span><span class="p">;</span>

	<span class="cm">/* Setup hw api */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">ii</span><span class="o">-&gt;</span><span class="n">mac_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span>  <span class="o">=</span> <span class="n">ii</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>

	<span class="cm">/* EEPROM */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">ii</span><span class="o">-&gt;</span><span class="n">eeprom_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">eec</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">);</span>
	<span class="cm">/* If EEPROM is valid (bit 8 = 1), use default otherwise use bit bang */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_eeprom_bit_bang_generic</span><span class="p">;</span>

	<span class="cm">/* PHY */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">ii</span><span class="o">-&gt;</span><span class="n">phy_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">sfp_type</span> <span class="o">=</span> <span class="n">ixgbe_sfp_type_unknown</span><span class="p">;</span>
	<span class="cm">/* ixgbe_identify_phy_generic will set prtad and mmds properly */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span> <span class="o">=</span> <span class="n">MDIO_PRTAD_NONE</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">mmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">mode_support</span> <span class="o">=</span> <span class="n">MDIO_SUPPORTS_C45</span> <span class="o">|</span> <span class="n">MDIO_EMULATE_C22</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">ixgbe_mdio_read</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">ixgbe_mdio_write</span><span class="p">;</span>

	<span class="n">ii</span><span class="o">-&gt;</span><span class="n">get_invariants</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* setup the private structure */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_sw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>

	<span class="cm">/* Make it possible the adapter to be woken up via WOL */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_WUS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is a fan on this device and it has failed log the</span>
<span class="cm">	 * failure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FAN_FAIL_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">esdp</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ESDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esdp</span> <span class="o">&amp;</span> <span class="n">IXGBE_ESDP_SDP1</span><span class="p">)</span>
			<span class="n">e_crit</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;Fan has stopped, replace the adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allow_unsupported_sfp</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">allow_unsupported_sfp</span> <span class="o">=</span> <span class="n">allow_unsupported_sfp</span><span class="p">;</span>

	<span class="cm">/* reset_hw fills in the perm_addr as well */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">reset_if_overtemp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">reset_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">reset_if_overtemp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_PRESENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;failed to load because an unsupported SFP+ &quot;</span>
			  <span class="s">&quot;module type was detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;Reload the driver after installing a supported &quot;</span>
			  <span class="s">&quot;module.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;HW Init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_probe_vf</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span>
			   <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
			   <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_VLAN_FILTER</span> <span class="o">|</span>
			   <span class="n">NETIF_F_TSO</span> <span class="o">|</span>
			   <span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
			   <span class="n">NETIF_F_RXHASH</span> <span class="o">|</span>
			   <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_SCTP_CSUM</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_SCTP_CSUM</span> <span class="o">|</span>
				       <span class="n">NETIF_F_NTUPLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXALL</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO6</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_IPV6_CSUM</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_SUPP_NOFCS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_FLAG_RSS_ENABLED</span> <span class="o">|</span>
				    <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCB</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dcbnl_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_device_caps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_device_caps</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_caps</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">device_caps</span> <span class="o">&amp;</span> <span class="n">IXGBE_DEVICE_CAPS_FCOE_OFFLOADS</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_FCOE_CAPABLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_FCOE_CRC</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_FSO</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_FCOE_MTU</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_CAPABLE</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG2_RSC_ENABLED</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="cm">/* make sure the EEPROM is good */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">validate_checksum</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;The EEPROM Checksum Is Not Valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_validate_mac_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;invalid MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_timer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ixgbe_service_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_task</span><span class="p">,</span> <span class="n">ixgbe_service_task</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_SERVICE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_init_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_RSS_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_RXHASH</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_RXHASH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* WOL not supported for all devices */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeprom_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_wol_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="n">IXGBE_WUFC_MAG</span><span class="p">;</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_PTP*/</span><span class="cp"></span>

	<span class="cm">/* save off EEPROM version number */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeprom_verh</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeprom_verl</span><span class="p">);</span>

	<span class="cm">/* pick up the PCI bus settings for reporting later */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_bus_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* print bus type/speed/width info */</span>
	<span class="n">e_dev_info</span><span class="p">(</span><span class="s">&quot;(PCI Express:%s:%s) %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">ixgbe_bus_speed_5000</span> <span class="o">?</span> <span class="s">&quot;5.0GT/s&quot;</span> <span class="o">:</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">ixgbe_bus_speed_2500</span> <span class="o">?</span> <span class="s">&quot;2.5GT/s&quot;</span> <span class="o">:</span>
		    <span class="s">&quot;Unknown&quot;</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">ixgbe_bus_width_pcie_x8</span> <span class="o">?</span> <span class="s">&quot;Width x8&quot;</span> <span class="o">:</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">ixgbe_bus_width_pcie_x4</span> <span class="o">?</span> <span class="s">&quot;Width x4&quot;</span> <span class="o">:</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">ixgbe_bus_width_pcie_x1</span> <span class="o">?</span> <span class="s">&quot;Width x1&quot;</span> <span class="o">:</span>
		    <span class="s">&quot;Unknown&quot;</span><span class="p">),</span>
		   <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_read_pba_string_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">part_str</span><span class="p">,</span> <span class="n">IXGBE_PBANUM_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">part_str</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="n">IXGBE_PBANUM_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_is_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">sfp_type</span> <span class="o">!=</span> <span class="n">ixgbe_sfp_type_not_present</span><span class="p">)</span>
		<span class="n">e_dev_info</span><span class="p">(</span><span class="s">&quot;MAC: %d, PHY: %d, SFP+: %d, PBA No: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">sfp_type</span><span class="p">,</span>
		           <span class="n">part_str</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">e_dev_info</span><span class="p">(</span><span class="s">&quot;MAC: %d, PHY: %d, PBA No: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">part_str</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">ixgbe_bus_width_pcie_x4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_warn</span><span class="p">(</span><span class="s">&quot;PCI-Express bandwidth available for this card is &quot;</span>
			   <span class="s">&quot;not sufficient for optimal performance.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">e_dev_warn</span><span class="p">(</span><span class="s">&quot;For optimal performance a x8 PCI-Express slot &quot;</span>
			   <span class="s">&quot;is required.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset the hardware with the new settings */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">start_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">IXGBE_ERR_EEPROM_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are running on a pre-production device, log a warning */</span>
		<span class="n">e_dev_warn</span><span class="p">(</span><span class="s">&quot;This device is a pre-production adapter/LOM. &quot;</span>
			   <span class="s">&quot;Please be aware there may be issues associated &quot;</span>
			   <span class="s">&quot;with your hardware.  If you are experiencing &quot;</span>
			   <span class="s">&quot;problems please contact your Intel or hardware &quot;</span>
			   <span class="s">&quot;representative who provided you with this &quot;</span>
			   <span class="s">&quot;hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>

	<span class="cm">/* power down the optics for multispeed fiber and 82599 SFP+ fiber */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_tx_laser</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">multispeed_fiber</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_media_type</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">==</span> <span class="n">ixgbe_media_type_fiber</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82599EB</span><span class="p">))))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_tx_laser</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* carrier off reporting is important to ethtool even BEFORE open */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dca_add_requester</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">;</span>
		<span class="n">ixgbe_setup_dca</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_info</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;IOV is enabled with %d VFs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ixgbe_vf_configuration</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">|</span> <span class="mh">0x10000000</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* firmware requires driver version to be 0xFFFFFFFF</span>
<span class="cm">	 * since os does not support feature</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_fw_drv_ver</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_fw_drv_ver</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
					   <span class="mh">0xFF</span><span class="p">);</span>

	<span class="cm">/* add san mac addr to netdev */</span>
	<span class="n">ixgbe_add_sanmac_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">e_dev_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ixgbe_default_device_descr</span><span class="p">);</span>
	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IXGBE_HWMON</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_sysfs_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;failed to allocate sysfs resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_HWMON */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_register:</span>
	<span class="n">ixgbe_release_hw_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_clear_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_sw_init:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span>
		<span class="n">ixgbe_disable_sriov</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG2_SEARCH_FOR_SFP</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_alloc_etherdev:</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">));</span>
<span class="nl">err_pci_reg:</span>
<span class="nl">err_dma:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_remove - Device Removal Routine</span>
<span class="cm"> * @pdev: PCI device information struct</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_remove is called by the PCI subsystem to alert the driver</span>
<span class="cm"> * that it should release a PCI device.  The could be caused by a</span>
<span class="cm"> * Hot-Plug event, or because the driver is going to be removed from</span>
<span class="cm"> * memory.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ixgbe_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGBE_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_task</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_PTP</span>
	<span class="n">ixgbe_ptp_stop</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAG_DCA_ENABLED</span><span class="p">;</span>
		<span class="n">dca_remove_requester</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_IXGBE_HWMON</span>
	<span class="n">ixgbe_sysfs_exit</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_HWMON */</span><span class="cp"></span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_FCOE_ENABLED</span><span class="p">)</span>
		<span class="n">ixgbe_cleanup_fcoe</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* IXGBE_FCOE */</span><span class="cp"></span>

	<span class="cm">/* remove the added san mac */</span>
	<span class="n">ixgbe_del_sanmac_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">==</span> <span class="n">NETREG_REGISTERED</span><span class="p">)</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_SRIOV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ixgbe_check_vf_assignment</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span>
			<span class="n">ixgbe_disable_sriov</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">e_dev_warn</span><span class="p">(</span><span class="s">&quot;Unloading driver while VFs are assigned &quot;</span>
				   <span class="s">&quot;- VFs will not be deallocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ixgbe_clear_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgbe_release_hw_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DCB</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">);</span>

<span class="cp">#endif</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">);</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">IORESOURCE_MEM</span><span class="p">));</span>

	<span class="n">e_dev_info</span><span class="p">(</span><span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_io_error_detected - called when PCI error is detected</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> * @state: The current pci connection state</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called after a PCI bus error affecting</span>
<span class="cm"> * this device has been detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">ixgbe_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="o">*</span><span class="n">vfdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw0</span><span class="p">,</span> <span class="n">dw1</span><span class="p">,</span> <span class="n">dw2</span><span class="p">,</span> <span class="n">dw3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">req_id</span><span class="p">,</span> <span class="n">pf_func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_mac_82598EB</span> <span class="o">||</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_bad_vf_detection</span><span class="p">;</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">!=</span> <span class="n">PCI_EXP_TYPE_ROOT_PORT</span><span class="p">))</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_bad_vf_detection</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_bad_vf_detection</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ERR_HEADER_LOG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw0</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ERR_HEADER_LOG</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw1</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ERR_HEADER_LOG</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ERR_HEADER_LOG</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw3</span><span class="p">);</span>

	<span class="n">req_id</span> <span class="o">=</span> <span class="n">dw1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* On the 82599 if bit 7 of the requestor ID is set then it&#39;s a VF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req_id</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_bad_vf_detection</span><span class="p">;</span>

	<span class="n">pf_func</span> <span class="o">=</span> <span class="n">req_id</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pf_func</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>

		<span class="n">vf</span> <span class="o">=</span> <span class="p">(</span><span class="n">req_id</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;VF %d has caused a PCIe error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;TLP: dw0: %8.8x</span><span class="se">\t</span><span class="s">dw1: %8.8x</span><span class="se">\t</span><span class="s">dw2: &quot;</span>
				<span class="s">&quot;%8.8x</span><span class="se">\t</span><span class="s">dw3: %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dw0</span><span class="p">,</span> <span class="n">dw1</span><span class="p">,</span> <span class="n">dw2</span><span class="p">,</span> <span class="n">dw3</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
			<span class="n">device_id</span> <span class="o">=</span> <span class="n">IXGBE_82599_VF_DEVICE_ID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
			<span class="n">device_id</span> <span class="o">=</span> <span class="n">IXGBE_X540_VF_DEVICE_ID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">device_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Find the pci device of the offending VF */</span>
		<span class="n">vfdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">IXGBE_INTEL_VENDOR_ID</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vfdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vfdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="p">(</span><span class="n">req_id</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">vfdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">IXGBE_INTEL_VENDOR_ID</span><span class="p">,</span>
					       <span class="n">device_id</span><span class="p">,</span> <span class="n">vfdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * There&#39;s a slim chance the VF could have been hot plugged,</span>
<span class="cm">		 * so if it is no longer present we don&#39;t need to issue the</span>
<span class="cm">		 * VFLR.  Just clean up the AER in that case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vfdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;Issuing VFLR to VF %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">vfdev</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0x00008000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Even though the error may have occurred on the other port</span>
<span class="cm">	 * we still need to increment the vf error reference count for</span>
<span class="cm">	 * both ports because the I/O resume function will be called</span>
<span class="cm">	 * for both of them.</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vferr_refcount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

<span class="nl">skip_bad_vf_detection:</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_IOV */</span><span class="cp"></span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Request a slot reset. */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_io_slot_reset - called after the pci bus has been reset.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Restart the card from scratch, as if from a cold-boot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">ixgbe_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_ers_result_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_err</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;Cannot re-enable PCI device after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">ixgbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_WUS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dev_err</span><span class="p">(</span><span class="s">&quot;pci_cleanup_aer_uncorrect_error_status &quot;</span>
			  <span class="s">&quot;failed 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* non-fatal, continue */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_io_resume - called when traffic can start flowing again.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called when the error recovery driver tells us that</span>
<span class="cm"> * its OK to resume normal operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vferr_refcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_info</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="s">&quot;Resuming after VF err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vferr_refcount</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">ixgbe_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">ixgbe_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">ixgbe_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ixgbe_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ixgbe_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">ixgbe_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ixgbe_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">ixgbe_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ixgbe_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">ixgbe_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">ixgbe_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ixgbe_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_err_handler</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_init_module - Driver Registration Routine</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_init_module is the first routine called when the driver is</span>
<span class="cm"> * loaded. All it does is register with the PCI subsystem.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ixgbe_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s - version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ixgbe_driver_string</span><span class="p">,</span> <span class="n">ixgbe_driver_version</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ixgbe_copyright</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
	<span class="n">dca_register_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dca_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ixgbe_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ixgbe_init_module</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_exit_module - Driver Exit Cleanup Routine</span>
<span class="cm"> *</span>
<span class="cm"> * ixgbe_exit_module is called just before the driver is removed</span>
<span class="cm"> * from memory.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ixgbe_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
	<span class="n">dca_unregister_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dca_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ixgbe_driver</span><span class="p">);</span>
	<span class="n">rcu_barrier</span><span class="p">();</span> <span class="cm">/* Wait for completion of call_rcu()&#39;s */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IXGBE_DCA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_notify_dca</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ixgbe_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span>
					 <span class="n">__ixgbe_notify_dca</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span> <span class="o">?</span> <span class="n">NOTIFY_BAD</span> <span class="o">:</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_DCA */</span><span class="cp"></span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">ixgbe_exit_module</span><span class="p">);</span>

<span class="cm">/* ixgbe_main.c */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
