<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgbe › ixgbe_82598.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ixgbe_82598.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel 10 Gigabit PCI Express Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &quot;ixgbe.h&quot;</span>
<span class="cp">#include &quot;ixgbe_phy.h&quot;</span>

<span class="cp">#define IXGBE_82598_MAX_TX_QUEUES 32</span>
<span class="cp">#define IXGBE_82598_MAX_RX_QUEUES 64</span>
<span class="cp">#define IXGBE_82598_RAR_ENTRIES   16</span>
<span class="cp">#define IXGBE_82598_MC_TBL_SIZE  128</span>
<span class="cp">#define IXGBE_82598_VFT_TBL_SIZE 128</span>
<span class="cp">#define IXGBE_82598_RX_PB_SIZE	 512</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">ixgbe_setup_copper_link_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                         <span class="n">ixgbe_link_speed</span> <span class="n">speed</span><span class="p">,</span>
                                         <span class="n">bool</span> <span class="n">autoneg</span><span class="p">,</span>
                                         <span class="n">bool</span> <span class="n">autoneg_wait_to_complete</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">ixgbe_read_i2c_eeprom_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte_offset</span><span class="p">,</span>
                                       <span class="n">u8</span> <span class="o">*</span><span class="n">eeprom_data</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_set_pcie_completion_timeout - set pci-e completion timeout</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  The defaults for 82598 should be in the range of 50us to 50ms,</span>
<span class="cm"> *  however the hardware default for these parts is 500us to 1ms which is less</span>
<span class="cm"> *  than the 10ms recommended by the pci-e spec.  To address this we need to</span>
<span class="cm"> *  increase the value to either 10ms to 250ms for capability version 1 config,</span>
<span class="cm"> *  or 16ms to 55ms for version 2.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_set_pcie_completion_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gcr</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GCR</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pcie_devctl2</span><span class="p">;</span>

	<span class="cm">/* only take action if timeout value is defaulted to 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gcr</span> <span class="o">&amp;</span> <span class="n">IXGBE_GCR_CMPL_TMOUT_MASK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if capababilities version is type 1 we can write the</span>
<span class="cm">	 * timeout of 10ms to 250ms through the GCR register</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gcr</span> <span class="o">&amp;</span> <span class="n">IXGBE_GCR_CAP_VER2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gcr</span> <span class="o">|=</span> <span class="n">IXGBE_GCR_CMPL_TMOUT_10ms</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * for version 2 capabilities we need to write the config space</span>
<span class="cm">	 * directly in order to set the completion timeout value for</span>
<span class="cm">	 * 16ms to 55ms</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
	                     <span class="n">IXGBE_PCI_DEVICE_CONTROL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_devctl2</span><span class="p">);</span>
	<span class="n">pcie_devctl2</span> <span class="o">|=</span> <span class="n">IXGBE_PCI_DEVICE_CONTROL2_16ms</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
	                      <span class="n">IXGBE_PCI_DEVICE_CONTROL2</span><span class="p">,</span> <span class="n">pcie_devctl2</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="cm">/* disable completion timeout resend */</span>
	<span class="n">gcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_GCR_CMPL_TMOUT_RESEND</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GCR</span><span class="p">,</span> <span class="n">gcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_get_invariants_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>

	<span class="cm">/* Call PHY identify routine to get the phy type */</span>
	<span class="n">ixgbe_identify_phy_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mcft_size</span> <span class="o">=</span> <span class="n">IXGBE_82598_MC_TBL_SIZE</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vft_size</span> <span class="o">=</span> <span class="n">IXGBE_82598_VFT_TBL_SIZE</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">num_rar_entries</span> <span class="o">=</span> <span class="n">IXGBE_82598_RAR_ENTRIES</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_rx_queues</span> <span class="o">=</span> <span class="n">IXGBE_82598_MAX_RX_QUEUES</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_tx_queues</span> <span class="o">=</span> <span class="n">IXGBE_82598_MAX_TX_QUEUES</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_msix_vectors</span> <span class="o">=</span> <span class="n">ixgbe_get_pcie_msix_count_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_init_phy_ops_82598 - PHY/SFP specific init</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Initialize any function pointers that were not able to be</span>
<span class="cm"> *  set during get_invariants because the PHY/SFP type was</span>
<span class="cm"> *  not known.  Perform the SFP init if necessary.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_init_phy_ops_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_phy_info</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">list_offset</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">;</span>

	<span class="cm">/* Identify the PHY */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">identify</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Overwrite the link function pointers if copper PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_media_type</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">==</span> <span class="n">ixgbe_media_type_copper</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_copper_link_82598</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_link_capabilities</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">ixgbe_get_copper_link_capabilities_generic</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_phy_tn</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_phy_link_tnx</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_check_phy_link_tnx</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_firmware_version</span> <span class="o">=</span>
		             <span class="o">&amp;</span><span class="n">ixgbe_get_phy_firmware_version_tnx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_phy_nl</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_reset_phy_nl</span><span class="p">;</span>

		<span class="cm">/* Call SFP+ identify routine to get the SFP+ module type */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">identify_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">sfp_type</span> <span class="o">==</span> <span class="n">ixgbe_sfp_type_unknown</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check to see if SFP+ module is supported */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">ixgbe_get_sfp_init_sequence_offsets</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
		                                            <span class="o">&amp;</span><span class="n">list_offset</span><span class="p">,</span>
		                                            <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_start_hw_82598 - Prepare hardware for Tx/Rx</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Starts the hardware using the generic start_hw function.</span>
<span class="cm"> *  Disables relaxed ordering Then set pcie completion timeout</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_start_hw_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">ixgbe_start_hw_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Disable relaxed ordering */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">max_tx_queues</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_DCA_MAX_QUEUES_82598</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_TXCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_DCA_TXCTRL_DESC_WRO_EN</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_TXCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">regval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">max_rx_queues</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_DCA_MAX_QUEUES_82598</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_RXCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_DCA_RXCTRL_DATA_WRO_EN</span> <span class="o">|</span>
			    <span class="n">IXGBE_DCA_RXCTRL_HEAD_WRO_EN</span><span class="p">);</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_DCA_RXCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">regval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">rx_pb_size</span> <span class="o">=</span> <span class="n">IXGBE_82598_RX_PB_SIZE</span><span class="p">;</span>

	<span class="cm">/* set the completion timeout for interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ixgbe_set_pcie_completion_timeout</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_get_link_capabilities_82598 - Determines link capabilities</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @speed: pointer to link speed</span>
<span class="cm"> *  @autoneg: boolean auto-negotiation value</span>
<span class="cm"> *</span>
<span class="cm"> *  Determines the link capabilities by reading the AUTOC register.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_get_link_capabilities_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                             <span class="n">ixgbe_link_speed</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span>
                                             <span class="n">bool</span> <span class="o">*</span><span class="n">autoneg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">autoc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine link capabilities based on the stored value of AUTOC,</span>
<span class="cm">	 * which represents EEPROM defaults.  If AUTOC value has not been</span>
<span class="cm">	 * stored, use the current register value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_link_settings_stored</span><span class="p">)</span>
		<span class="n">autoc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_autoc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">autoc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_LMS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_1G_LINK_NO_AN</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">autoneg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_10G_LINK_NO_AN</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">autoneg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_1G_AN</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">autoneg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_KX4_AN</span>:
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_KX4_AN_1G_AN</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_KX4_SUPP</span><span class="p">)</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">|=</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_KX_SUPP</span><span class="p">)</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">|=</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">autoneg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_LINK_SETUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_get_media_type_82598 - Determines media type</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns the media type (fiber, copper, backplane)</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">ixgbe_media_type</span> <span class="nf">ixgbe_get_media_type_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ixgbe_media_type</span> <span class="n">media_type</span><span class="p">;</span>

	<span class="cm">/* Detect if there is a copper PHY attached. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_phy_cu_unknown</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_tn</span>:
		<span class="n">media_type</span> <span class="o">=</span> <span class="n">ixgbe_media_type_copper</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Media type for I82598 is based on device ID */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598_BX</span>:
		<span class="cm">/* Default device ID is mezzanine card KX/KX4 */</span>
		<span class="n">media_type</span> <span class="o">=</span> <span class="n">ixgbe_media_type_backplane</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598AF_DUAL_PORT</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598AF_SINGLE_PORT</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598_DA_DUAL_PORT</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598_SR_DUAL_PORT_EM</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598EB_XF_LR</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598EB_SFP_LOM</span>:
		<span class="n">media_type</span> <span class="o">=</span> <span class="n">ixgbe_media_type_fiber</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598EB_CX4</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598_CX4_DUAL_PORT</span>:
		<span class="n">media_type</span> <span class="o">=</span> <span class="n">ixgbe_media_type_cx4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598AT</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598AT2</span>:
		<span class="n">media_type</span> <span class="o">=</span> <span class="n">ixgbe_media_type_copper</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">media_type</span> <span class="o">=</span> <span class="n">ixgbe_media_type_unknown</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">media_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_fc_enable_82598 - Enable flow control</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Enable flow control according to the current settings.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_fc_enable_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fctrl_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rmcs_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcrtl</span><span class="p">,</span> <span class="n">fcrth</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link_up</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate the water mark configuration for packet buffer 0.  Zero</span>
<span class="cm">	 * water marks indicate that the packet buffer was not configured</span>
<span class="cm">	 * and the watermarks for packet buffer 0 should always be configured.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">low_water</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">high_water</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">pause_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Invalid water mark configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IXGBE_ERR_INVALID_LINK_SETTINGS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * On 82598 having Rx FC on causes resets while doing 1G</span>
<span class="cm">	 * so if it&#39;s on turn it off once we know link_speed. For</span>
<span class="cm">	 * more details see 82598 Specification update.</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span> <span class="n">link_speed</span> <span class="o">==</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_fc_full</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">ixgbe_fc_tx_pause</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_fc_rx_pause</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">ixgbe_fc_none</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* no change */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Negotiate the fc mode to use */</span>
	<span class="n">ixgbe_fc_autoneg</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Disable any previous flow control settings */</span>
	<span class="n">fctrl_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">);</span>
	<span class="n">fctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_FCTRL_RFCE</span> <span class="o">|</span> <span class="n">IXGBE_FCTRL_RPFCE</span><span class="p">);</span>

	<span class="n">rmcs_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RMCS</span><span class="p">);</span>
	<span class="n">rmcs_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_RMCS_TFCE_PRIORITY</span> <span class="o">|</span> <span class="n">IXGBE_RMCS_TFCE_802_3X</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The possible values of fc.current_mode are:</span>
<span class="cm">	 * 0: Flow control is completely disabled</span>
<span class="cm">	 * 1: Rx flow control is enabled (we can receive pause frames,</span>
<span class="cm">	 *    but not send pause frames).</span>
<span class="cm">	 * 2: Tx flow control is enabled (we can send pause frames but</span>
<span class="cm">	 *     we do not support receiving pause frames).</span>
<span class="cm">	 * 3: Both Rx and Tx flow control (symmetric) are enabled.</span>
<span class="cm">	 * other: Invalid.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_fc_none</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Flow control is disabled by software override or autoneg.</span>
<span class="cm">		 * The code below will actually disable it in the HW.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_fc_rx_pause</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Rx Flow control is enabled and Tx Flow control is</span>
<span class="cm">		 * disabled by software override. Since there really</span>
<span class="cm">		 * isn&#39;t a way to advertise that we are capable of RX</span>
<span class="cm">		 * Pause ONLY, we will advertise that we support both</span>
<span class="cm">		 * symmetric and asymmetric Rx PAUSE.  Later, we will</span>
<span class="cm">		 * disable the adapter&#39;s ability to send PAUSE frames.</span>
<span class="cm">		 */</span>
		<span class="n">fctrl_reg</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_RFCE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_fc_tx_pause</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Tx Flow control is enabled, and Rx Flow control is</span>
<span class="cm">		 * disabled by software override.</span>
<span class="cm">		 */</span>
		<span class="n">rmcs_reg</span> <span class="o">|=</span> <span class="n">IXGBE_RMCS_TFCE_802_3X</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ixgbe_fc_full</span>:
		<span class="cm">/* Flow control (both Rx and Tx) is enabled by SW override. */</span>
		<span class="n">fctrl_reg</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_RFCE</span><span class="p">;</span>
		<span class="n">rmcs_reg</span> <span class="o">|=</span> <span class="n">IXGBE_RMCS_TFCE_802_3X</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Flow control param set incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IXGBE_ERR_CONFIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set 802.3x based flow control settings. */</span>
	<span class="n">fctrl_reg</span> <span class="o">|=</span> <span class="n">IXGBE_FCTRL_DPF</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTRL</span><span class="p">,</span> <span class="n">fctrl_reg</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RMCS</span><span class="p">,</span> <span class="n">rmcs_reg</span><span class="p">);</span>

	<span class="n">fcrtl</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">low_water</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">IXGBE_FCRTL_XONE</span><span class="p">;</span>

	<span class="cm">/* Set up and enable Rx high/low water mark thresholds, enable XON. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span> <span class="o">&amp;</span> <span class="n">ixgbe_fc_tx_pause</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">high_water</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">fcrth</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">high_water</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">IXGBE_FCRTH_FCEN</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCRTL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">fcrtl</span><span class="p">);</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCRTH</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">fcrth</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCRTL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCRTH</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Configure pause time (2 TCs per register) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">pause_time</span> <span class="o">*</span> <span class="mh">0x00010001</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_TRAFFIC_CLASS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCTTV</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Configure flow control refresh threshold value */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_FCRTV</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">pause_time</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_start_mac_link_82598 - Configures MAC link settings</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Configures link settings based on values in the ixgbe_hw struct.</span>
<span class="cm"> *  Restarts the link.  Performs autonegotiation if needed.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_start_mac_link_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                      <span class="n">bool</span> <span class="n">autoneg_wait_to_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">autoc_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">links_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Restart link */</span>
	<span class="n">autoc_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">);</span>
	<span class="n">autoc_reg</span> <span class="o">|=</span> <span class="n">IXGBE_AUTOC_AN_RESTART</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">,</span> <span class="n">autoc_reg</span><span class="p">);</span>

	<span class="cm">/* Only poll for autoneg to complete if specified to do so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoneg_wait_to_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">autoc_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_LMS_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">IXGBE_AUTOC_LMS_KX4_AN</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">autoc_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_LMS_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">IXGBE_AUTOC_LMS_KX4_AN_1G_AN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">links_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Just in case Autoneg time = 0 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_AUTO_NEG_TIME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">links_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LINKS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">links_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_KX_AN_COMP</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">links_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_KX_AN_COMP</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_AUTONEG_NOT_COMPLETE</span><span class="p">;</span>
				<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Autonegotiation did not complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Add delay to filter out noises during initial link setup */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_validate_link_ready - Function looks for phy link</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Function indicates success when phy link is available. If phy is not ready</span>
<span class="cm"> *  within 5 seconds of MAC indicating link, the function returns error.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_validate_link_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">an_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">!=</span> <span class="n">IXGBE_DEV_ID_82598AT2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">IXGBE_VALIDATE_LINK_READY_TIMEOUT</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MDIO_STAT1</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">an_reg</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_STAT1_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">an_reg</span> <span class="o">&amp;</span> <span class="n">MDIO_STAT1_LSTATUS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="n">IXGBE_VALIDATE_LINK_READY_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Link was indicated but link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IXGBE_ERR_LINK_SETUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_check_mac_link_82598 - Get link/speed status</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @speed: pointer to link speed</span>
<span class="cm"> *  @link_up: true is link is up, false otherwise</span>
<span class="cm"> *  @link_up_wait_to_complete: bool used to wait for link up or not</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads the links register to determine if link is up and the current speed</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_check_mac_link_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                      <span class="n">ixgbe_link_speed</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">link_up</span><span class="p">,</span>
                                      <span class="n">bool</span> <span class="n">link_up_wait_to_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">links_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">link_reg</span><span class="p">,</span> <span class="n">adapt_comp_reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SERDES PHY requires us to read link status from register 0xC79F.</span>
<span class="cm">	 * Bit 0 set indicates link is up/ready; clear indicates link down.</span>
<span class="cm">	 * 0xC00C is read to check that the XAUI lanes are active.  Bit 0</span>
<span class="cm">	 * clear indicates active; set indicates inactive.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_phy_nl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xC79F</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_reg</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xC79F</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_reg</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xC00C</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
		                     <span class="o">&amp;</span><span class="n">adapt_comp_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_up_wait_to_complete</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_LINK_UP_TIME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">link_reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">((</span><span class="n">adapt_comp_reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xC79F</span><span class="p">,</span>
				                     <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				                     <span class="o">&amp;</span><span class="n">link_reg</span><span class="p">);</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xC00C</span><span class="p">,</span>
				                     <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				                     <span class="o">&amp;</span><span class="n">adapt_comp_reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">link_reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">adapt_comp_reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">link_up</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">links_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LINKS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up_wait_to_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_LINK_UP_TIME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">links_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_UP</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">links_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LINKS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">links_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_UP</span><span class="p">)</span>
			<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">links_reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINKS_SPEED</span><span class="p">)</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGBE_DEV_ID_82598AT2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ixgbe_validate_link_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="o">*</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_setup_mac_link_82598 - Set MAC link speed</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @speed: new link speed</span>
<span class="cm"> *  @autoneg: true if auto-negotiation enabled</span>
<span class="cm"> *  @autoneg_wait_to_complete: true when waiting for completion is needed</span>
<span class="cm"> *</span>
<span class="cm"> *  Set the link speed in the AUTOC register and restarts link.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_setup_mac_link_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                           <span class="n">ixgbe_link_speed</span> <span class="n">speed</span><span class="p">,</span> <span class="n">bool</span> <span class="n">autoneg</span><span class="p">,</span>
                                           <span class="n">bool</span> <span class="n">autoneg_wait_to_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span>              <span class="n">status</span>            <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ixgbe_link_speed</span> <span class="n">link_capabilities</span> <span class="o">=</span> <span class="n">IXGBE_LINK_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">u32</span>              <span class="n">curr_autoc</span>        <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">);</span>
	<span class="n">u32</span>              <span class="n">autoc</span>             <span class="o">=</span> <span class="n">curr_autoc</span><span class="p">;</span>
	<span class="n">u32</span>              <span class="n">link_mode</span>         <span class="o">=</span> <span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_LMS_MASK</span><span class="p">;</span>

	<span class="cm">/* Check to see if speed passed in is supported. */</span>
	<span class="n">ixgbe_get_link_capabilities_82598</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_capabilities</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autoneg</span><span class="p">);</span>
	<span class="n">speed</span> <span class="o">&amp;=</span> <span class="n">link_capabilities</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">IXGBE_LINK_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_LINK_SETUP</span><span class="p">;</span>

	<span class="cm">/* Set KX4/KX support according to speed requested */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_mode</span> <span class="o">==</span> <span class="n">IXGBE_AUTOC_LMS_KX4_AN</span> <span class="o">||</span>
	         <span class="n">link_mode</span> <span class="o">==</span> <span class="n">IXGBE_AUTOC_LMS_KX4_AN_1G_AN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">autoc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_AUTOC_KX4_KX_SUPP_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span><span class="p">)</span>
			<span class="n">autoc</span> <span class="o">|=</span> <span class="n">IXGBE_AUTOC_KX4_SUPP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span><span class="p">)</span>
			<span class="n">autoc</span> <span class="o">|=</span> <span class="n">IXGBE_AUTOC_KX_SUPP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">!=</span> <span class="n">curr_autoc</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">,</span> <span class="n">autoc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Setup and restart the link based on the new values in</span>
<span class="cm">		 * ixgbe_hw This will write the AUTOC register based on the new</span>
<span class="cm">		 * stored values</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_start_mac_link_82598</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						    <span class="n">autoneg_wait_to_complete</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *  ixgbe_setup_copper_link_82598 - Set the PHY autoneg advertised field</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @speed: new link speed</span>
<span class="cm"> *  @autoneg: true if autonegotiation enabled</span>
<span class="cm"> *  @autoneg_wait_to_complete: true if waiting is needed to complete</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets the link speed in the AUTOC register in the MAC and restarts link.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_setup_copper_link_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                               <span class="n">ixgbe_link_speed</span> <span class="n">speed</span><span class="p">,</span>
                                               <span class="n">bool</span> <span class="n">autoneg</span><span class="p">,</span>
                                               <span class="n">bool</span> <span class="n">autoneg_wait_to_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Setup the PHY according to input speed */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link_speed</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">,</span>
	                                      <span class="n">autoneg_wait_to_complete</span><span class="p">);</span>
	<span class="cm">/* Set up MAC */</span>
	<span class="n">ixgbe_start_mac_link_82598</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">autoneg_wait_to_complete</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_reset_hw_82598 - Performs hardware reset</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Resets the hardware by resetting the transmit and receive units, masks and</span>
<span class="cm"> *  clears all interrupts, performing a PHY reset, and performing a link (MAC)</span>
<span class="cm"> *  reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_reset_hw_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">phy_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gheccr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">autoc</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">analog_val</span><span class="p">;</span>

	<span class="cm">/* Call adapter stop to disable tx/rx and clear interrupts */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">stop_adapter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reset_hw_out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power up the Atlas Tx lanes if they are currently powered down.</span>
<span class="cm">	 * Atlas Tx lanes are powered down for MAC loopback tests, but</span>
<span class="cm">	 * they are not automatically restored on reset.</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_LPBK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">analog_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">analog_val</span> <span class="o">&amp;</span> <span class="n">IXGBE_ATLAS_PDN_TX_REG_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable Tx Atlas so packets can be transmitted again */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_LPBK</span><span class="p">,</span>
		                             <span class="o">&amp;</span><span class="n">analog_val</span><span class="p">);</span>
		<span class="n">analog_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_ATLAS_PDN_TX_REG_EN</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_LPBK</span><span class="p">,</span>
		                              <span class="n">analog_val</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_10G</span><span class="p">,</span>
		                             <span class="o">&amp;</span><span class="n">analog_val</span><span class="p">);</span>
		<span class="n">analog_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_ATLAS_PDN_TX_10G_QL_ALL</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_10G</span><span class="p">,</span>
		                              <span class="n">analog_val</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_1G</span><span class="p">,</span>
		                             <span class="o">&amp;</span><span class="n">analog_val</span><span class="p">);</span>
		<span class="n">analog_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_ATLAS_PDN_TX_1G_QL_ALL</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_1G</span><span class="p">,</span>
		                              <span class="n">analog_val</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_AN</span><span class="p">,</span>
		                             <span class="o">&amp;</span><span class="n">analog_val</span><span class="p">);</span>
		<span class="n">analog_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_ATLAS_PDN_TX_AN_QL_ALL</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_analog_reg8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLAS_PDN_AN</span><span class="p">,</span>
		                              <span class="n">analog_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">reset_disable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PHY ops must be identified and initialized prior to reset */</span>

		<span class="cm">/* Init PHY and function pointers, perform SFP setup */</span>
		<span class="n">phy_status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_status</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_SUPPORTED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">reset_hw_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_status</span> <span class="o">==</span> <span class="n">IXGBE_ERR_SFP_NOT_PRESENT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">mac_reset_top</span><span class="p">;</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">mac_reset_top:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Issue global reset to the MAC.  This needs to be a SW reset.</span>
<span class="cm">	 * If link reset is used, it might reset the MAC when mng is using it</span>
<span class="cm">	 */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">IXGBE_CTRL_RST</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Poll for reset bit to self-clear indicating reset is complete */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">IXGBE_CTRL_RST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">IXGBE_CTRL_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_RESET_FAILED</span><span class="p">;</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Reset polling failed to complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Double resets are required for recovery from certain error</span>
<span class="cm">	 * conditions.  Between resets, it is necessary to stall to allow time</span>
<span class="cm">	 * for any pending HW events to complete.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAGS_DOUBLE_RESET_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAGS_DOUBLE_RESET_REQUIRED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mac_reset_top</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gheccr</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GHECCR</span><span class="p">);</span>
	<span class="n">gheccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GHECCR</span><span class="p">,</span> <span class="n">gheccr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store the original AUTOC value if it has not been</span>
<span class="cm">	 * stored off yet.  Otherwise restore the stored original</span>
<span class="cm">	 * AUTOC value since the reset operation sets back to deaults.</span>
<span class="cm">	 */</span>
	<span class="n">autoc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_link_settings_stored</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_autoc</span> <span class="o">=</span> <span class="n">autoc</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_link_settings_stored</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_autoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">orig_autoc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Store the permanent mac address */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">perm_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store MAC address from RAR0, clear receive address registers, and</span>
<span class="cm">	 * clear the multicast table</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">init_rx_addrs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="nl">reset_hw_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_status</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">phy_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_set_vmdq_82598 - Associate a VMDq set index with a rx address</span>
<span class="cm"> *  @hw: pointer to hardware struct</span>
<span class="cm"> *  @rar: receive address register index to associate with a VMDq index</span>
<span class="cm"> *  @vmdq: VMDq set index</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_set_vmdq_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vmdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rar_high</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rar_entries</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">num_rar_entries</span><span class="p">;</span>

	<span class="cm">/* Make sure we are using a valid rar index range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rar</span> <span class="o">&gt;=</span> <span class="n">rar_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;RAR index %d is out of range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rar</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IXGBE_ERR_INVALID_ARGUMENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rar_high</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RAH</span><span class="p">(</span><span class="n">rar</span><span class="p">));</span>
	<span class="n">rar_high</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RAH_VIND_MASK</span><span class="p">;</span>
	<span class="n">rar_high</span> <span class="o">|=</span> <span class="p">((</span><span class="n">vmdq</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_RAH_VIND_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IXGBE_RAH_VIND_MASK</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RAH</span><span class="p">(</span><span class="n">rar</span><span class="p">),</span> <span class="n">rar_high</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_clear_vmdq_82598 - Disassociate a VMDq set index from an rx address</span>
<span class="cm"> *  @hw: pointer to hardware struct</span>
<span class="cm"> *  @rar: receive address register index to associate with a VMDq index</span>
<span class="cm"> *  @vmdq: VMDq clear index (not used in 82598, but elsewhere)</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_clear_vmdq_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vmdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rar_high</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rar_entries</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">num_rar_entries</span><span class="p">;</span>


	<span class="cm">/* Make sure we are using a valid rar index range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rar</span> <span class="o">&gt;=</span> <span class="n">rar_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;RAR index %d is out of range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rar</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IXGBE_ERR_INVALID_ARGUMENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rar_high</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RAH</span><span class="p">(</span><span class="n">rar</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rar_high</span> <span class="o">&amp;</span> <span class="n">IXGBE_RAH_VIND_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rar_high</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_RAH_VIND_MASK</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RAH</span><span class="p">(</span><span class="n">rar</span><span class="p">),</span> <span class="n">rar_high</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_set_vfta_82598 - Set VLAN filter table</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @vlan: VLAN id to write to VLAN filter</span>
<span class="cm"> *  @vind: VMDq output index that maps queue to VLAN id in VFTA</span>
<span class="cm"> *  @vlan_on: boolean flag to turn on/off VLAN in VFTA</span>
<span class="cm"> *</span>
<span class="cm"> *  Turn on/off specified VLAN in the VLAN filter table.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_set_vfta_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vind</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">vlan_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regindex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitindex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vftabyte</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IXGBE_ERR_PARAM</span><span class="p">;</span>

	<span class="cm">/* Determine 32-bit word position in array */</span>
	<span class="n">regindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlan</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>   <span class="cm">/* upper seven bits */</span>

	<span class="cm">/* Determine the location of the (VMD) queue index */</span>
	<span class="n">vftabyte</span> <span class="o">=</span>  <span class="p">((</span><span class="n">vlan</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span> <span class="cm">/* bits (4:3) indicating byte array */</span>
	<span class="n">bitindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlan</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>    <span class="cm">/* lower 3 bits indicate nibble */</span>

	<span class="cm">/* Set the nibble for VMD queue index */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTAVIND</span><span class="p">(</span><span class="n">vftabyte</span><span class="p">,</span> <span class="n">regindex</span><span class="p">));</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x0F</span> <span class="o">&lt;&lt;</span> <span class="n">bitindex</span><span class="p">));</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vind</span> <span class="o">&lt;&lt;</span> <span class="n">bitindex</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTAVIND</span><span class="p">(</span><span class="n">vftabyte</span><span class="p">,</span> <span class="n">regindex</span><span class="p">),</span> <span class="n">bits</span><span class="p">);</span>

	<span class="cm">/* Determine the location of the bit for this VLAN id */</span>
	<span class="n">bitindex</span> <span class="o">=</span> <span class="n">vlan</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>   <span class="cm">/* lower five bits */</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTA</span><span class="p">(</span><span class="n">regindex</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_on</span><span class="p">)</span>
		<span class="cm">/* Turn on this VLAN id */</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitindex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Turn off this VLAN id */</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitindex</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTA</span><span class="p">(</span><span class="n">regindex</span><span class="p">),</span> <span class="n">bits</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_clear_vfta_82598 - Clear VLAN filter table</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Clears the VLAN filer table, and the VMDq index associated with the filter</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_clear_vfta_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlanbyte</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">vft_size</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTA</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vlanbyte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vlanbyte</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">vlanbyte</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">vft_size</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTAVIND</span><span class="p">(</span><span class="n">vlanbyte</span><span class="p">,</span> <span class="n">offset</span><span class="p">),</span>
			                <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_read_analog_reg8_82598 - Reads 8 bit Atlas analog register</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @reg: analog register to read</span>
<span class="cm"> *  @val: read value</span>
<span class="cm"> *</span>
<span class="cm"> *  Performs read operation to Atlas analog register specified.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_read_analog_reg8_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">atlas_ctl</span><span class="p">;</span>

	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLASCTL</span><span class="p">,</span>
	                <span class="n">IXGBE_ATLASCTL_WRITE_CMD</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">atlas_ctl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLASCTL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">atlas_ctl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_write_analog_reg8_82598 - Writes 8 bit Atlas analog register</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @reg: atlas register to write</span>
<span class="cm"> *  @val: value to write</span>
<span class="cm"> *</span>
<span class="cm"> *  Performs write operation to Atlas analog register specified.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_write_analog_reg8_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">atlas_ctl</span><span class="p">;</span>

	<span class="n">atlas_ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_ATLASCTL</span><span class="p">,</span> <span class="n">atlas_ctl</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_read_i2c_eeprom_82598 - Reads 8 bit word over I2C interface.</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @byte_offset: EEPROM byte offset to read</span>
<span class="cm"> *  @eeprom_data: value read</span>
<span class="cm"> *</span>
<span class="cm"> *  Performs 8 byte read operation to SFP module&#39;s EEPROM over I2C interface.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_read_i2c_eeprom_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte_offset</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">eeprom_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sfp_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sfp_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sfp_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_phy_nl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * phy SDA/SCL registers are at addresses 0xC30A to</span>
<span class="cm">		 * 0xC30D.  These registers are used to talk to the SFP+</span>
<span class="cm">		 * module&#39;s EEPROM through the SDA/SCL (I2C) interface.</span>
<span class="cm">		 */</span>
		<span class="n">sfp_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">IXGBE_I2C_EEPROM_DEV_ADDR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">byte_offset</span><span class="p">;</span>
		<span class="n">sfp_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sfp_addr</span> <span class="o">|</span> <span class="n">IXGBE_I2C_EEPROM_READ_MASK</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
		                      <span class="n">IXGBE_MDIO_PMA_PMD_SDA_SCL_ADDR</span><span class="p">,</span>
		                      <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
		                      <span class="n">sfp_addr</span><span class="p">);</span>

		<span class="cm">/* Poll status */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			                     <span class="n">IXGBE_MDIO_PMA_PMD_SDA_SCL_STAT</span><span class="p">,</span>
			                     <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
			                     <span class="o">&amp;</span><span class="n">sfp_stat</span><span class="p">);</span>
			<span class="n">sfp_stat</span> <span class="o">=</span> <span class="n">sfp_stat</span> <span class="o">&amp;</span> <span class="n">IXGBE_I2C_EEPROM_STATUS_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sfp_stat</span> <span class="o">!=</span> <span class="n">IXGBE_I2C_EEPROM_STATUS_IN_PROGRESS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sfp_stat</span> <span class="o">!=</span> <span class="n">IXGBE_I2C_EEPROM_STATUS_PASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read did not pass.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SFP_NOT_PRESENT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read data */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MDIO_PMA_PMD_SDA_SCL_DATA</span><span class="p">,</span>
		                     <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfp_data</span><span class="p">);</span>

		<span class="o">*</span><span class="n">eeprom_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sfp_data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_PHY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_get_supported_physical_layer_82598 - Returns physical layer type</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Determines physical layer capabilities of the current configuration.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ixgbe_get_supported_physical_layer_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_UNKNOWN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">autoc</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_AUTOC</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pma_pmd_10g</span> <span class="o">=</span> <span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_10G_PMA_PMD_MASK</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pma_pmd_1g</span> <span class="o">=</span> <span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_1G_PMA_PMD_MASK</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ext_ability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">identify</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Copper PHY must be checked before AUTOC LMS to determine correct</span>
<span class="cm">	 * physical layer because 10GBase-T PHYs use LMS = KX4/KX */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_phy_tn</span>:
	<span class="k">case</span> <span class="n">ixgbe_phy_cu_unknown</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MDIO_PMA_EXTABLE</span><span class="p">,</span>
		<span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_ability</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_ability</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_EXTABLE_10GBT</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_T</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_ability</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_EXTABLE_1000BT</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_1000BASE_T</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_ability</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_EXTABLE_100BTX</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_100BASE_TX</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_LMS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_1G_AN</span>:
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_1G_LINK_NO_AN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pma_pmd_1g</span> <span class="o">==</span> <span class="n">IXGBE_AUTOC_1G_KX</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_1000BASE_KX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_1000BASE_BX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_10G_LINK_NO_AN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pma_pmd_10g</span> <span class="o">==</span> <span class="n">IXGBE_AUTOC_10G_CX4</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_CX4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pma_pmd_10g</span> <span class="o">==</span> <span class="n">IXGBE_AUTOC_10G_KX4</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_KX4</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* XAUI */</span>
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_KX4_AN</span>:
	<span class="k">case</span> <span class="n">IXGBE_AUTOC_LMS_KX4_AN_1G_AN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_KX_SUPP</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_1000BASE_KX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoc</span> <span class="o">&amp;</span> <span class="n">IXGBE_AUTOC_KX4_SUPP</span><span class="p">)</span>
			<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_KX4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_phy_nl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">identify_sfp</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">sfp_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ixgbe_sfp_type_da_cu</span>:
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_SFP_PLUS_CU</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_sfp_type_sr</span>:
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_SR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ixgbe_sfp_type_lr</span>:
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_LR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_UNKNOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598_DA_DUAL_PORT</span>:
		<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_SFP_PLUS_CU</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598AF_DUAL_PORT</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598AF_SINGLE_PORT</span>:
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598_SR_DUAL_PORT_EM</span>:
		<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_SR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_DEV_ID_82598EB_XF_LR</span>:
		<span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_LR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">physical_layer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_set_lan_id_multi_port_pcie_82598 - Set LAN id for PCIe multiple</span>
<span class="cm"> *  port devices.</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Calls common function and corrects issue with some single port devices</span>
<span class="cm"> *  that enable LAN1 but not LAN0.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_set_lan_id_multi_port_pcie_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_bus_info</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_ctrl2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ixgbe_set_lan_id_multi_port_pcie</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* check if LAN0 is disabled */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_PCIE_GENERAL_PTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_gen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_gen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pci_gen</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pci_gen</span> <span class="o">+</span> <span class="n">IXGBE_PCIE_CTRL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_ctrl2</span><span class="p">);</span>

		<span class="cm">/* if LAN0 is completely disabled force function to 0 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pci_ctrl2</span> <span class="o">&amp;</span> <span class="n">IXGBE_PCIE_CTRL2_LAN_DISABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">pci_ctrl2</span> <span class="o">&amp;</span> <span class="n">IXGBE_PCIE_CTRL2_DISABLE_SELECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">pci_ctrl2</span> <span class="o">&amp;</span> <span class="n">IXGBE_PCIE_CTRL2_DUMMY_ENABLE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_set_rxpba_82598 - Configure packet buffers</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> * @dcb_config: pointer to ixgbe_dcb_config structure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure packet buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_set_rxpba_82598</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_pb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">headroom</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">strategy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rxpktsize</span> <span class="o">=</span> <span class="n">IXGBE_RXPBSIZE_64KB</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_pb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Setup Rx packet buffer sizes */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PBA_STRATEGY_WEIGHTED</span>:
		<span class="cm">/* Setup the first four at 80KB */</span>
		<span class="n">rxpktsize</span> <span class="o">=</span> <span class="n">IXGBE_RXPBSIZE_80KB</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXPBSIZE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">rxpktsize</span><span class="p">);</span>
		<span class="cm">/* Setup the last four at 48KB...don&#39;t re-init i */</span>
		<span class="n">rxpktsize</span> <span class="o">=</span> <span class="n">IXGBE_RXPBSIZE_48KB</span><span class="p">;</span>
		<span class="cm">/* Fall Through */</span>
	<span class="k">case</span> <span class="n">PBA_STRATEGY_EQUAL</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Divide the remaining Rx packet buffer evenly among the TCs */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_MAX_PACKET_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXPBSIZE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">rxpktsize</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup Tx packet buffer sizes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_MAX_PACKET_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_TXPBSIZE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">IXGBE_TXPBSIZE_40KB</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ixgbe_mac_operations</span> <span class="n">mac_ops_82598</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_hw</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_hw_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_hw</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_reset_hw_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_hw</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_start_hw_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_hw_cntrs</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_hw_cntrs_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_media_type</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_media_type_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_supported_physical_layer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_supported_physical_layer_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_rx_dma</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_enable_rx_dma_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mac_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_mac_addr_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_adapter</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_stop_adapter_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bus_info</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_bus_info_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_lan_id</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_lan_id_multi_port_pcie_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_analog_reg8</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_analog_reg8_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_analog_reg8</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_analog_reg8_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_mac_link_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rxpba</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_rxpba_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_check_mac_link_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_capabilities</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_link_capabilities_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">led_on</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_led_on_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">led_off</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_led_off_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blink_led_start</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_blink_led_start_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blink_led_stop</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_blink_led_stop_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rar</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_rar_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_rar</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_rar_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_vmdq</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_vmdq_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_vmdq</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_vmdq_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_rx_addrs</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_rx_addrs_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_mc_addr_list</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_update_mc_addr_list_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_enable_mc_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_mc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_disable_mc_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_vfta</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_vfta_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_vfta</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_vfta_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fc_enable</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_fc_enable_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fw_drv_ver</span>         <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire_swfw_sync</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_acquire_swfw_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_swfw_sync</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_release_swfw_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_thermal_sensor_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_thermal_sensor_thresh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ixgbe_eeprom_operations</span> <span class="n">eeprom_ops_82598</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_params</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_eeprom_params_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_eerd_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_eeprom_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_buffer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_eeprom_buffer_bit_bang_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_buffer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_eerd_buffer_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_checksum</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_calc_eeprom_checksum_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">validate_checksum</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_validate_eeprom_checksum_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_checksum</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_update_eeprom_checksum_generic</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ixgbe_phy_operations</span> <span class="n">phy_ops_82598</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">identify</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_identify_phy_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">identify_sfp</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_identify_sfp_module_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_phy_ops_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_reset_phy_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_reg</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_phy_reg_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_reg</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_phy_reg_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_phy_link_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link_speed</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_phy_link_speed_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_i2c_eeprom</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_i2c_eeprom_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_overtemp</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_tn_check_overtemp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ixgbe_info</span> <span class="n">ixgbe_82598_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">ixgbe_mac_82598EB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_invariants</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_invariants_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_ops_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eeprom_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">eeprom_ops_82598</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_82598</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
