<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgbe › ixgbe_dcb_nl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ixgbe_dcb_nl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel 10 Gigabit PCI Express Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  Linux NICS &lt;linux.nics@intel.com&gt;</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &quot;ixgbe.h&quot;</span>
<span class="cp">#include &lt;linux/dcbnl.h&gt;</span>
<span class="cp">#include &quot;ixgbe_dcb_82598.h&quot;</span>
<span class="cp">#include &quot;ixgbe_dcb_82599.h&quot;</span>

<span class="cm">/* Callbacks for DCB netlink in the kernel */</span>
<span class="cp">#define BIT_DCB_MODE	0x01</span>
<span class="cp">#define BIT_PFC		0x02</span>
<span class="cp">#define BIT_PG_RX	0x04</span>
<span class="cp">#define BIT_PG_TX	0x08</span>
<span class="cp">#define BIT_APP_UPCHG	0x10</span>
<span class="cp">#define BIT_LINKSPEED   0x80</span>

<span class="cm">/* Responses for the DCB_C_SET_ALL command */</span>
<span class="cp">#define DCB_HW_CHG_RST  0  </span><span class="cm">/* DCB configuration changed with reset */</span><span class="cp"></span>
<span class="cp">#define DCB_NO_HW_CHG   1  </span><span class="cm">/* DCB configuration did not change */</span><span class="cp"></span>
<span class="cp">#define DCB_HW_CHG      2  </span><span class="cm">/* DCB configuration changed, no reset */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_copy_dcb_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tc_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_dcb_config</span> <span class="o">*</span><span class="n">scfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_dcb_config</span> <span class="o">*</span><span class="n">dcfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc_configuration</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc_configuration</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">DCB_TX_CONFIG</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">DCB_RX_CONFIG</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">struct</span> <span class="n">dcb_app</span> <span class="n">app</span> <span class="o">=</span> <span class="p">{</span>
			      <span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span><span class="p">,</span>
			      <span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ETH_P_FCOE</span><span class="p">,</span>
			     <span class="p">};</span>
	<span class="n">u8</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dcb_getapp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">up</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span><span class="p">)))</span>
		<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_APP_UPCHG</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tc_max</span> <span class="o">+</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scfg</span><span class="o">-&gt;</span><span class="n">tc_config</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">];</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tc_config</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_TC_0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">prio_type</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">prio_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">prio_type</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">prio_type</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_TX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_id</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_TX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_percent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">bwg_percent</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_TX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">!=</span>
				<span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">=</span>
				<span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_PG_TX</span> <span class="o">|</span> <span class="n">BIT_PFC</span> <span class="o">|</span> <span class="n">BIT_APP_UPCHG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">prio_type</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">prio_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">prio_type</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">prio_type</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_RX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_id</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_RX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_percent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">bwg_percent</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_RX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">!=</span>
				<span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">=</span>
				<span class="n">src</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_PG_RX</span> <span class="o">|</span> <span class="n">BIT_PFC</span> <span class="o">|</span> <span class="n">BIT_APP_UPCHG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCB_PG_ATTR_BW_ID_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PG_ATTR_BW_ID_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">tx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">tx</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">tx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">tx</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_TX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">rx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">rx</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">rx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">rx</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PG_RX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCB_PFC_UP_ATTR_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">DCB_PFC_UP_ATTR_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tc_config</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dcb_pfc</span> <span class="o">!=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">tc_config</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dcb_pfc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tc_config</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dcb_pfc</span> <span class="o">=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">tc_config</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dcb_pfc</span><span class="p">;</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PFC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">pfc_mode_enable</span> <span class="o">!=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">pfc_mode_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">pfc_mode_enable</span> <span class="o">=</span> <span class="n">scfg</span><span class="o">-&gt;</span><span class="n">pfc_mode_enable</span><span class="p">;</span>
		<span class="n">changes</span> <span class="o">|=</span> <span class="n">BIT_PFC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">changes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prio_tc</span><span class="p">[</span><span class="n">MAX_USER_PRIORITY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Fail command if not in CEE mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* verify there is something to do, if not then exit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">state</span> <span class="o">!=</span> <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_tc</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_unpack_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">DCB_TX_CONFIG</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_tc</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE_8021QAZ_MAX_TCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netdev_set_prio_tc_map</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_get_perm_hw_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="o">*</span><span class="n">perm_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">perm_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">MAX_ADDR_LEN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">perm_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">perm_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ixgbe_mac_82599EB</span>:
	<span class="k">case</span> <span class="n">ixgbe_mac_X540</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">perm_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">san_addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_set_pg_tc_cfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="n">prio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bwg_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prio</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prio_type</span> <span class="o">=</span> <span class="n">prio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bwg_id</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="n">bwg_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw_pct</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">=</span>
			<span class="n">bw_pct</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_map</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">=</span>
			<span class="n">up_map</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_set_pg_bwg_cfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bwg_id</span><span class="p">,</span>
                                          <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">bw_percentage</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bwg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">bw_pct</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_set_pg_tc_cfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="n">prio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bwg_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prio</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">prio_type</span> <span class="o">=</span> <span class="n">prio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bwg_id</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="n">bwg_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw_pct</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bwg_percent</span> <span class="o">=</span>
			<span class="n">bw_pct</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_map</span> <span class="o">!=</span> <span class="n">DCB_ATTR_VALUE_UNDEFINED</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span> <span class="o">=</span>
			<span class="n">up_map</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_set_pg_bwg_cfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bwg_id</span><span class="p">,</span>
                                          <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">bw_percentage</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">bwg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">bw_pct</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_get_pg_tc_cfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="o">*</span><span class="n">prio</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bwg_id</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="o">*</span><span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">prio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prio_type</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bwg_id</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bwg_percent</span><span class="p">;</span>
	<span class="o">*</span><span class="n">up_map</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_get_pg_bwg_cfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bwg_id</span><span class="p">,</span>
                                          <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">bw_percentage</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bwg_id</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_get_pg_tc_cfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="o">*</span><span class="n">prio</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bwg_id</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">,</span>
                                         <span class="n">u8</span> <span class="o">*</span><span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">prio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">prio_type</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bwg_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bwg_id</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bwg_percent</span><span class="p">;</span>
	<span class="o">*</span><span class="n">up_map</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">tc</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">up_to_tc_bitmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_get_pg_bwg_cfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bwg_id</span><span class="p">,</span>
                                          <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">bw_percentage</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">bwg_id</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_set_pfc_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
                                    <span class="n">u8</span> <span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">dcb_pfc</span> <span class="o">=</span> <span class="n">setting</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">dcb_pfc</span> <span class="o">!=</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">dcb_pfc</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_get_pfc_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
                                    <span class="n">u8</span> <span class="o">*</span><span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">setting</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">tc_config</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">dcb_pfc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_devreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ixgbe_clear_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgbe_init_interrupt_scheme</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBE_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_set_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_dcb_config</span> <span class="o">*</span><span class="n">dcb_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">DCB_NO_HW_CHG</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Fail command if not in CEE mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">|=</span> <span class="n">ixgbe_copy_dcb_cfg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						      <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_PG_TX</span><span class="o">|</span><span class="n">BIT_PG_RX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">refill</span><span class="p">[</span><span class="n">MAX_TRAFFIC_CLASS</span><span class="p">],</span> <span class="n">max</span><span class="p">[</span><span class="n">MAX_TRAFFIC_CLASS</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">bwg_id</span><span class="p">[</span><span class="n">MAX_TRAFFIC_CLASS</span><span class="p">],</span> <span class="n">prio_type</span><span class="p">[</span><span class="n">MAX_TRAFFIC_CLASS</span><span class="p">];</span>
		<span class="cm">/* Priority to TC mapping in CEE case default to 1:1 */</span>
		<span class="n">u8</span> <span class="n">prio_tc</span><span class="p">[</span><span class="n">MAX_USER_PRIORITY</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_FCOE_MTU</span><span class="p">)</span>
			<span class="n">max_frame</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">max_frame</span><span class="p">,</span> <span class="n">IXGBE_FCOE_JUMBO_FRAME_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">ixgbe_dcb_calculate_tc_credits</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">max_frame</span><span class="p">,</span>
					       <span class="n">DCB_TX_CONFIG</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_calculate_tc_credits</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">max_frame</span><span class="p">,</span>
					       <span class="n">DCB_RX_CONFIG</span><span class="p">);</span>

		<span class="n">ixgbe_dcb_unpack_refill</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">DCB_TX_CONFIG</span><span class="p">,</span> <span class="n">refill</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_unpack_max</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_unpack_bwgid</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">DCB_TX_CONFIG</span><span class="p">,</span> <span class="n">bwg_id</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_unpack_prio</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">DCB_TX_CONFIG</span><span class="p">,</span> <span class="n">prio_type</span><span class="p">);</span>
		<span class="n">ixgbe_dcb_unpack_map</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">DCB_TX_CONFIG</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">);</span>

		<span class="n">ixgbe_dcb_hw_ets_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">refill</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">bwg_id</span><span class="p">,</span>
					<span class="n">prio_type</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE_8021QAZ_MAX_TCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">netdev_set_prio_tc_map</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">DCB_HW_CHG_RST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT_PFC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb_cfg</span><span class="o">-&gt;</span><span class="n">pfc_mode_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">pfc_en</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">prio_tc</span><span class="p">[</span><span class="n">MAX_USER_PRIORITY</span><span class="p">];</span>

			<span class="n">ixgbe_dcb_unpack_map</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="n">DCB_TX_CONFIG</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">);</span>
			<span class="n">ixgbe_dcb_unpack_pfc</span><span class="p">(</span><span class="n">dcb_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc_en</span><span class="p">);</span>
			<span class="n">ixgbe_dcb_hw_pfc_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pfc_en</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">fc_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ixgbe_set_rx_drop_en</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">DCB_HW_CHG</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="cm">/* Reprogam FCoE hardware offloads when the traffic class</span>
<span class="cm">	 * FCoE is using changes. This happens if the APP info</span>
<span class="cm">	 * changes or the up2tc mapping is updated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT_APP_UPCHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dcb_app</span> <span class="n">app</span> <span class="o">=</span> <span class="p">{</span>
				      <span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ETH_P_FCOE</span><span class="p">,</span>
				     <span class="p">};</span>
		<span class="n">u8</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dcb_getapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ixgbe_dcbnl_devreset</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DCB_HW_CHG_RST</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_getcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">capid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">capid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PG</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PFC</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_UP2TC</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PG_TCS</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PFC_TCS</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_GSP</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_BCN</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_CAP_ATTR_DCBX</span>:
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_getnumtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tcid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAG_DCB_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tcid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCB_NUMTCS_ATTR_PG</span>:
			<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_NUMTCS_ATTR_PFC</span>:
			<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pfc_tcs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_setnumtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tcid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_getpfcstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_dcbnl_setpfcstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp_dcb_cfg</span><span class="p">.</span><span class="n">pfc_mode_enable</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_dcbnl_getapp - retrieve the DCBX application user priority</span>
<span class="cm"> * @netdev : the corresponding netdev</span>
<span class="cm"> * @idtype : identifies the id as ether type or TCP/UDP port number</span>
<span class="cm"> * @id: id is either ether type or TCP/UDP port number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns : on success, returns a non-zero 802.1p user priority bitmap</span>
<span class="cm"> * otherwise returns 0 as the invalid user priority bitmap to indicate an</span>
<span class="cm"> * error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_getapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dcb_app</span> <span class="n">app</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">idtype</span><span class="p">,</span>
				<span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>
			     <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dcb_getapp</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_ieee_getets</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee_ets</span> <span class="o">*</span><span class="n">ets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee_ets</span> <span class="o">*</span><span class="n">my_ets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">;</span>

	<span class="n">ets</span><span class="o">-&gt;</span><span class="n">ets_cap</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span><span class="p">;</span>

	<span class="cm">/* No IEEE PFC settings available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_ets</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ets</span><span class="o">-&gt;</span><span class="n">cbs</span> <span class="o">=</span> <span class="n">my_ets</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">tc_tx_bw</span><span class="p">,</span> <span class="n">my_ets</span><span class="o">-&gt;</span><span class="n">tc_tx_bw</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">tc_tx_bw</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">tc_rx_bw</span><span class="p">,</span> <span class="n">my_ets</span><span class="o">-&gt;</span><span class="n">tc_rx_bw</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">tc_rx_bw</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">tc_tsa</span><span class="p">,</span> <span class="n">my_ets</span><span class="o">-&gt;</span><span class="n">tc_tsa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">tc_tsa</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">,</span> <span class="n">my_ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_ieee_setets</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee_ets</span> <span class="o">*</span><span class="n">ets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">max_tc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_ets</span><span class="p">),</span>
						  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE_8021QAZ_MAX_TCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_tc</span><span class="p">)</span>
			<span class="n">max_tc</span> <span class="o">=</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_tc</span><span class="p">)</span>
		<span class="n">max_tc</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_tc</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pg_tcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_tc</span> <span class="o">!=</span> <span class="n">netdev_get_num_tc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_tc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">max_tc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE_8021QAZ_MAX_TCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netdev_set_prio_tc_map</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_dcb_hw_ets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span> <span class="n">max_frame</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_ieee_getpfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="o">*</span><span class="n">pfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="o">*</span><span class="n">my_pfc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">pfc_cap</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_cfg</span><span class="p">.</span><span class="n">num_tcs</span><span class="p">.</span><span class="n">pfc_tcs</span><span class="p">;</span>

	<span class="cm">/* No IEEE PFC settings available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_pfc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span> <span class="o">=</span> <span class="n">my_pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">;</span>
	<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">mbc</span> <span class="o">=</span> <span class="n">my_pfc</span><span class="o">-&gt;</span><span class="n">mbc</span><span class="p">;</span>
	<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">my_pfc</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TRAFFIC_CLASS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pxoffrxc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">indications</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pxofftxc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_ieee_setpfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="o">*</span><span class="n">pfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">prio_tc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_pfc</span><span class="p">),</span>
						  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prio_tc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_ets</span><span class="o">-&gt;</span><span class="n">prio_tc</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">,</span> <span class="n">pfc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_ieee_pfc</span><span class="p">));</span>

	<span class="cm">/* Enable link flow control parameters if PFC is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_dcb_hw_pfc_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span><span class="p">,</span> <span class="n">prio_tc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">fc_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ixgbe_set_rx_drop_en</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_ieee_setapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dcb_ieee_setapp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">==</span> <span class="n">IEEE_8021QAZ_APP_SEL_ETHERTYPE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">app</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_FCOE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">app_mask</span> <span class="o">=</span> <span class="n">dcb_ieee_getapp_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">app_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="n">ixgbe_dcbnl_devreset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_dcbnl_ieee_delapp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dcb_ieee_delapp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>

<span class="cp">#ifdef IXGBE_FCOE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">==</span> <span class="n">IEEE_8021QAZ_APP_SEL_ETHERTYPE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">app</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_FCOE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">app_mask</span> <span class="o">=</span> <span class="n">dcb_ieee_getapp_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">app</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">app_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">app_mask</span> <span class="o">?</span>
				   <span class="n">ffs</span><span class="p">(</span><span class="n">app_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">IXGBE_FCOE_DEFTC</span><span class="p">;</span>
		<span class="n">ixgbe_dcbnl_devreset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_getdcbx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ixgbe_dcbnl_setdcbx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee_ets</span> <span class="n">ets</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">ieee_pfc</span> <span class="n">pfc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no support for LLD_MANAGED modes or CEE+IEEE */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_LLD_MANAGED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_HOST</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcbx_cap</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* ETS and PFC defaults */</span>
	<span class="n">ets</span><span class="p">.</span><span class="n">ets_cap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pfc</span><span class="p">.</span><span class="n">pfc_cap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_IEEE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgbe_dcbnl_ieee_setets</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ets</span><span class="p">);</span>
		<span class="n">ixgbe_dcbnl_ieee_setpfc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BIT_PFC</span> <span class="o">|</span> <span class="n">BIT_PG_TX</span> <span class="o">|</span> <span class="n">BIT_PG_RX</span> <span class="o">|</span> <span class="n">BIT_APP_UPCHG</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dcb_set_bitmap</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">ixgbe_dcbnl_set_all</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Drop into single TC mode strict priority as this</span>
<span class="cm">		 * indicates CEE and IEEE versions are disabled</span>
<span class="cm">		 */</span>
		<span class="n">ixgbe_dcbnl_ieee_setets</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ets</span><span class="p">);</span>
		<span class="n">ixgbe_dcbnl_ieee_setpfc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbe_setup_tc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="n">dcbnl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ieee_getets</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_ieee_getets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ieee_setets</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_ieee_setets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ieee_getpfc</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_ieee_getpfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ieee_setpfc</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_ieee_setpfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ieee_setapp</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_ieee_setapp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ieee_delapp</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_ieee_delapp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getstate</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setstate</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpermhwaddr</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_perm_hw_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgtccfgtx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_pg_tc_cfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgbwgcfgtx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_pg_bwg_cfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgtccfgrx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_pg_tc_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgbwgcfgrx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_pg_bwg_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgtccfgtx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_pg_tc_cfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgbwgcfgtx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_pg_bwg_cfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgtccfgrx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_pg_tc_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgbwgcfgrx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_pg_bwg_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpfccfg</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_pfc_cfg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpfccfg</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_get_pfc_cfg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setall</span>		<span class="o">=</span> <span class="n">ixgbe_dcbnl_set_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getcap</span>		<span class="o">=</span> <span class="n">ixgbe_dcbnl_getcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getnumtcs</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_getnumtcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setnumtcs</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_setnumtcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpfcstate</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_getpfcstate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpfcstate</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_setpfcstate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getapp</span>		<span class="o">=</span> <span class="n">ixgbe_dcbnl_getapp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getdcbx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_getdcbx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setdcbx</span>	<span class="o">=</span> <span class="n">ixgbe_dcbnl_setdcbx</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
