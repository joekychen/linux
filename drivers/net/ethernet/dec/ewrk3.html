<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dec › ewrk3.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ewrk3.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*  ewrk3.c: A DIGITAL EtherWORKS 3 ethernet driver for Linux.</span>

<span class="cm">   Written 1994 by David C. Davies.</span>

<span class="cm">   Copyright 1994 Digital Equipment Corporation.</span>

<span class="cm">   This software may be used and distributed according to the terms of</span>
<span class="cm">   the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">   This driver is written for the Digital Equipment Corporation series</span>
<span class="cm">   of EtherWORKS ethernet cards:</span>

<span class="cm">   DE203 Turbo (BNC)</span>
<span class="cm">   DE204 Turbo (TP)</span>
<span class="cm">   DE205 Turbo (TP BNC)</span>

<span class="cm">   The driver has been tested on a relatively busy  network using the DE205</span>
<span class="cm">   card and benchmarked with &#39;ttcp&#39;: it transferred 16M  of data at 975kB/s</span>
<span class="cm">   (7.8Mb/s) to a DECstation 5000/200.</span>

<span class="cm">   The author may be reached at davies@maniac.ultranet.com.</span>

<span class="cm">   =========================================================================</span>
<span class="cm">   This driver has been written  substantially  from scratch, although  its</span>
<span class="cm">   inheritance of style and stack interface from &#39;depca.c&#39; and in turn from</span>
<span class="cm">   Donald Becker&#39;s &#39;lance.c&#39; should be obvious.</span>

<span class="cm">   The  DE203/4/5 boards  all  use a new proprietary   chip in place of the</span>
<span class="cm">   LANCE chip used in prior cards  (DEPCA, DE100, DE200/1/2, DE210, DE422).</span>
<span class="cm">   Use the depca.c driver in the standard distribution  for the LANCE based</span>
<span class="cm">   cards from DIGITAL; this driver will not work with them.</span>

<span class="cm">   The DE203/4/5 cards have 2  main modes: shared memory  and I/O only. I/O</span>
<span class="cm">   only makes  all the card accesses through  I/O transactions and  no high</span>
<span class="cm">   (shared)  memory is used. This  mode provides a &gt;48% performance penalty</span>
<span class="cm">   and  is deprecated in this  driver,  although allowed to provide initial</span>
<span class="cm">   setup when hardstrapped.</span>

<span class="cm">   The shared memory mode comes in 3 flavours: 2kB, 32kB and 64kB. There is</span>
<span class="cm">   no point in using any mode other than the 2kB  mode - their performances</span>
<span class="cm">   are virtually identical, although the driver has  been tested in the 2kB</span>
<span class="cm">   and 32kB modes. I would suggest you uncomment the line:</span>

<span class="cm">   FORCE_2K_MODE;</span>

<span class="cm">   to allow the driver to configure the card as a  2kB card at your current</span>
<span class="cm">   base  address, thus leaving more  room to clutter  your  system box with</span>
<span class="cm">   other memory hungry boards.</span>

<span class="cm">   As many ISA  and EISA cards  can be supported  under this driver  as you</span>
<span class="cm">   wish, limited primarily  by the available IRQ lines,  rather than by the</span>
<span class="cm">   available I/O addresses  (24 ISA,  16 EISA).   I have  checked different</span>
<span class="cm">   configurations of  multiple  depca cards and  ewrk3 cards  and have  not</span>
<span class="cm">   found a problem yet (provided you have at least depca.c v0.38) ...</span>

<span class="cm">   The board IRQ setting   must be at  an unused  IRQ which is  auto-probed</span>
<span class="cm">   using  Donald  Becker&#39;s autoprobe  routines.   All  these cards   are at</span>
<span class="cm">   {5,10,11,15}.</span>

<span class="cm">   No 16MB memory  limitation should exist with this  driver as DMA is  not</span>
<span class="cm">   used and the common memory area is in low memory on the network card (my</span>
<span class="cm">   current system has 20MB and I&#39;ve not had problems yet).</span>

<span class="cm">   The ability to load  this driver as a  loadable module has been included</span>
<span class="cm">   and used  extensively during the  driver development (to save those long</span>
<span class="cm">   reboot sequences). To utilise this ability, you have to do 8 things:</span>

<span class="cm">   0) have a copy of the loadable modules code installed on your system.</span>
<span class="cm">   1) copy ewrk3.c from the  /linux/drivers/net directory to your favourite</span>
<span class="cm">   temporary directory.</span>
<span class="cm">   2) edit the  source code near  line 1898 to reflect  the I/O address and</span>
<span class="cm">   IRQ you&#39;re using.</span>
<span class="cm">   3) compile  ewrk3.c, but include -DMODULE in  the command line to ensure</span>
<span class="cm">   that the correct bits are compiled (see end of source code).</span>
<span class="cm">   4) if you are wanting to add a new  card, goto 5. Otherwise, recompile a</span>
<span class="cm">   kernel with the ewrk3 configuration turned off and reboot.</span>
<span class="cm">   5) insmod ewrk3.o</span>
<span class="cm">   [Alan Cox: Changed this so you can insmod ewrk3.o irq=x io=y]</span>
<span class="cm">   [Adam Kropelin: now accepts irq=x1,x2 io=y1,y2 for multiple cards]</span>
<span class="cm">   6) run the net startup bits for your new eth?? interface manually</span>
<span class="cm">   (usually /etc/rc.inet[12] at boot time).</span>
<span class="cm">   7) enjoy!</span>

<span class="cm">   Note that autoprobing is not allowed in loadable modules - the system is</span>
<span class="cm">   already up and running and you&#39;re messing with interrupts.</span>

<span class="cm">   To unload a module, turn off the associated interface</span>
<span class="cm">   &#39;ifconfig eth?? down&#39; then &#39;rmmod ewrk3&#39;.</span>

<span class="cm">   Promiscuous   mode has been  turned  off  in this driver,   but  all the</span>
<span class="cm">   multicast  address bits  have been   turned on. This  improved the  send</span>
<span class="cm">   performance on a busy network by about 13%.</span>

<span class="cm">   Ioctl&#39;s have now been provided (primarily because  I wanted to grab some</span>
<span class="cm">   packet size statistics). They  are patterned after &#39;plipconfig.c&#39; from a</span>
<span class="cm">   suggestion by Alan Cox.  Using these  ioctls, you can enable promiscuous</span>
<span class="cm">   mode, add/delete multicast  addresses, change the hardware address,  get</span>
<span class="cm">   packet size distribution statistics and muck around with the control and</span>
<span class="cm">   status register. I&#39;ll add others if and when the need arises.</span>

<span class="cm">   TO DO:</span>
<span class="cm">   ------</span>


<span class="cm">   Revision History</span>
<span class="cm">   ----------------</span>

<span class="cm">   Version   Date        Description</span>

<span class="cm">   0.1     26-aug-94   Initial writing. ALPHA code release.</span>
<span class="cm">   0.11    31-aug-94   Fixed: 2k mode memory base calc.,</span>
<span class="cm">   LeMAC version calc.,</span>
<span class="cm">   IRQ vector assignments during autoprobe.</span>
<span class="cm">   0.12    31-aug-94   Tested working on LeMAC2 (DE20[345]-AC) card.</span>
<span class="cm">   Fixed up MCA hash table algorithm.</span>
<span class="cm">   0.20     4-sep-94   Added IOCTL functionality.</span>
<span class="cm">   0.21    14-sep-94   Added I/O mode.</span>
<span class="cm">   0.21axp 15-sep-94   Special version for ALPHA AXP Linux V1.0.</span>
<span class="cm">   0.22    16-sep-94   Added more IOCTLs &amp; tidied up.</span>
<span class="cm">   0.23    21-sep-94   Added transmit cut through.</span>
<span class="cm">   0.24    31-oct-94   Added uid checks in some ioctls.</span>
<span class="cm">   0.30     1-nov-94   BETA code release.</span>
<span class="cm">   0.31     5-dec-94   Added check/allocate region code.</span>
<span class="cm">   0.32    16-jan-95   Broadcast packet fix.</span>
<span class="cm">   0.33    10-Feb-95   Fix recognition bug reported by &lt;bkm@star.rl.ac.uk&gt;.</span>
<span class="cm">   0.40    27-Dec-95   Rationalise MODULE and autoprobe code.</span>
<span class="cm">   Rewrite for portability &amp; updated.</span>
<span class="cm">   ALPHA support from &lt;jestabro@amt.tay1.dec.com&gt;</span>
<span class="cm">   Added verify_area() calls in ewrk3_ioctl() from</span>
<span class="cm">   suggestion by &lt;heiko@colossus.escape.de&gt;.</span>
<span class="cm">   Add new multicasting code.</span>
<span class="cm">   0.41    20-Jan-96   Fix IRQ set up problem reported by</span>
<span class="cm">   &lt;kenneth@bbs.sas.ntu.ac.sg&gt;.</span>
<span class="cm">   0.42    22-Apr-96   Fix alloc_device() bug &lt;jari@markkus2.fimr.fi&gt;</span>
<span class="cm">   0.43    16-Aug-96   Update alloc_device() to conform to de4x5.c</span>
<span class="cm">   0.44    08-Nov-01   use library crc32 functions &lt;Matt_Domsch@dell.com&gt;</span>
<span class="cm">   0.45    19-Jul-02   fix unaligned access on alpha &lt;martin@bruli.net&gt;</span>
<span class="cm">   0.46    10-Oct-02   Multiple NIC support when module &lt;akropel1@rochester.rr.com&gt;</span>
<span class="cm">   0.47    18-Oct-02   ethtool support &lt;akropel1@rochester.rr.com&gt;</span>
<span class="cm">   0.48    18-Oct-02   cli/sti removal for 2.5 &lt;vda@port.imtp.ilyichevsk.odessa.ua&gt;</span>
<span class="cm">   ioctl locking, signature search cleanup &lt;akropel1@rochester.rr.com&gt;</span>

<span class="cm">   =========================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;ewrk3.h&quot;</span>

<span class="cp">#define DRV_NAME	&quot;ewrk3&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;0.48&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="n">DRV_NAME</span> <span class="s">&quot;:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; 2002/10/18 davies@maniac.ultranet.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#ifdef EWRK3_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_debug</span> <span class="o">=</span> <span class="n">EWRK3_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define EWRK3_NDA 0xffe0	</span><span class="cm">/* No Device Address */</span><span class="cp"></span>

<span class="cp">#define PROBE_LENGTH    32</span>
<span class="cp">#define ETH_PROM_SIG    0xAA5500FFUL</span>

<span class="cp">#ifndef EWRK3_SIGNATURE</span>
<span class="cp">#define EWRK3_SIGNATURE {&quot;DE203&quot;,&quot;DE204&quot;,&quot;DE205&quot;,&quot;&quot;}</span>
<span class="cp">#define EWRK3_STRLEN 8</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef EWRK3_RAM_BASE_ADDRESSES</span>
<span class="cp">#define EWRK3_RAM_BASE_ADDRESSES {0xc0000,0xd0000,0x00000}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">   ** Sets up the I/O area for the autoprobe.</span>
<span class="cm"> */</span>
<span class="cp">#define EWRK3_IO_BASE 0x100	</span><span class="cm">/* Start address for probe search */</span><span class="cp"></span>
<span class="cp">#define EWRK3_IOP_INC 0x20	</span><span class="cm">/* I/O address increment */</span><span class="cp"></span>
<span class="cp">#define EWRK3_TOTAL_SIZE 0x20	</span><span class="cm">/* required I/O address length */</span><span class="cp"></span>

<span class="cp">#ifndef MAX_NUM_EWRK3S</span>
<span class="cp">#define MAX_NUM_EWRK3S 21</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef EWRK3_EISA_IO_PORTS</span>
<span class="cp">#define EWRK3_EISA_IO_PORTS 0x0c00	</span><span class="cm">/* I/O port base address, slot 0 */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef MAX_EISA_SLOTS</span>
<span class="cp">#define MAX_EISA_SLOTS 16</span>
<span class="cp">#define EISA_SLOT_INC 0x1000</span>
<span class="cp">#endif</span>

<span class="cp">#define QUEUE_PKT_TIMEOUT (1*HZ)	</span><span class="cm">/* Jiffies */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">   ** EtherWORKS 3 shared memory window sizes</span>
<span class="cm"> */</span>
<span class="cp">#define IO_ONLY         0x00</span>
<span class="cp">#define SHMEM_2K        0x800</span>
<span class="cp">#define SHMEM_32K       0x8000</span>
<span class="cp">#define SHMEM_64K       0x10000</span>

<span class="cm">/*</span>
<span class="cm">   ** EtherWORKS 3 IRQ ENABLE/DISABLE</span>
<span class="cm"> */</span>
<span class="cp">#define ENABLE_IRQs { \</span>
<span class="cp">  icr |= lp-&gt;irq_mask;\</span>
<span class="cp">  outb(icr, EWRK3_ICR);                     </span><span class="cm">/* Enable the IRQs */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cp">#define DISABLE_IRQs { \</span>
<span class="cp">  icr = inb(EWRK3_ICR);\</span>
<span class="cp">  icr &amp;= ~lp-&gt;irq_mask;\</span>
<span class="cp">  outb(icr, EWRK3_ICR);                     </span><span class="cm">/* Disable the IRQs */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm">   ** EtherWORKS 3 START/STOP</span>
<span class="cm"> */</span>
<span class="cp">#define START_EWRK3 { \</span>
<span class="cp">  csr = inb(EWRK3_CSR);\</span>
<span class="cp">  csr &amp;= ~(CSR_TXD|CSR_RXD);\</span>
<span class="cp">  outb(csr, EWRK3_CSR);                     </span><span class="cm">/* Enable the TX and/or RX */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cp">#define STOP_EWRK3 { \</span>
<span class="cp">  csr = (CSR_TXD|CSR_RXD);\</span>
<span class="cp">  outb(csr, EWRK3_CSR);                     </span><span class="cm">/* Disable the TX and/or RX */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm">   ** The EtherWORKS 3 private structure</span>
<span class="cm"> */</span>
<span class="cp">#define EWRK3_PKT_STAT_SZ 16</span>
<span class="cp">#define EWRK3_PKT_BIN_SZ  128	</span><span class="cm">/* Should be &gt;=100 unless you</span>
<span class="cm">				   increase EWRK3_PKT_STAT_SZ */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">ewrk3_stats</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">bins</span><span class="p">[</span><span class="n">EWRK3_PKT_STAT_SZ</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">unicast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">multicast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">broadcast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">excessive_collisions</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_underruns</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">excessive_underruns</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">adapter_name</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>	<span class="cm">/* Name exported to /proc/ioports */</span>
	<span class="n">u_long</span> <span class="n">shmem_base</span><span class="p">;</span>	<span class="cm">/* Shared memory start address */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shmem</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">shmem_length</span><span class="p">;</span>	<span class="cm">/* Shared memory window length */</span>
	<span class="k">struct</span> <span class="n">ewrk3_stats</span> <span class="n">pktStats</span><span class="p">;</span> <span class="cm">/* Private stats counters */</span>
	<span class="n">u_char</span> <span class="n">irq_mask</span><span class="p">;</span>	<span class="cm">/* Adapter IRQ mask bits */</span>
	<span class="n">u_char</span> <span class="n">mPage</span><span class="p">;</span>		<span class="cm">/* Maximum 2kB Page number */</span>
	<span class="n">u_char</span> <span class="n">lemac</span><span class="p">;</span>		<span class="cm">/* Chip rev. level */</span>
	<span class="n">u_char</span> <span class="n">hard_strapped</span><span class="p">;</span>	<span class="cm">/* Don&#39;t allow a full open */</span>
	<span class="n">u_char</span> <span class="n">txc</span><span class="p">;</span>		<span class="cm">/* Transmit cut through */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mctbl</span><span class="p">;</span>	<span class="cm">/* Pointer to the multicast table */</span>
	<span class="n">u_char</span> <span class="n">led_mask</span><span class="p">;</span>	<span class="cm">/* Used to reserve LED access for ethtool */</span>
	<span class="n">spinlock_t</span> <span class="n">hw_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">   ** Force the EtherWORKS 3 card to be in 2kB MODE</span>
<span class="cm"> */</span>
<span class="cp">#define FORCE_2K_MODE { \</span>
<span class="cp">  shmem_length = SHMEM_2K;\</span>
<span class="cp">  outb(((mem_start - 0x80000) &gt;&gt; 11), EWRK3_MBR);\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Public Functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ewrk3_queue_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ewrk3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops_203</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">   ** Private functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ewrk3_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ewrk3_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">EthwrkSignature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eeprom_image</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">DevicePresent</span><span class="p">(</span><span class="n">u_long</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SetMulticastFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">EISA_signature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">s32</span> <span class="n">eisa_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">Read_EEPROM</span><span class="p">(</span><span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">eaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">Write_EEPROM</span><span class="p">(</span><span class="kt">short</span> <span class="n">data</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">eaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">get_hw_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span> <span class="n">eeprom_image</span><span class="p">,</span> <span class="kt">char</span> <span class="n">chipType</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ewrk3_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eisa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">irq</span><span class="p">[</span><span class="n">MAX_NUM_EWRK3S</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">EWRK3_STRLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num_ewrks3s</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">   ** Miscellaneous defines...</span>
<span class="cm"> */</span>
<span class="cp">#define INIT_EWRK3 {\</span>
<span class="cp">    outb(EEPROM_INIT, EWRK3_IOPR);\</span>
<span class="cp">    mdelay(1);\</span>
<span class="cp">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">ewrk3_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ewrk3_private</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ewrk3_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ewrk3_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Address PROM pattern */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">isa_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">eisa_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EWRK3_TOTAL_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ewrk3_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ewrk3_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ewrk3_queue_pkt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ewrk3_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">ewrk3_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ewrk3_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">ewrk3_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">shmem_length</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cr</span><span class="p">,</span> <span class="n">cmr</span><span class="p">,</span> <span class="n">icr</span><span class="p">,</span> <span class="n">nicsr</span><span class="p">,</span> <span class="n">lemac</span><span class="p">,</span> <span class="n">hard_strapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_MAX</span><span class="p">],</span> <span class="n">chksum</span><span class="p">,</span> <span class="n">eisa_cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	** Stop the EWRK3. Enable the DBR ROM. Disable interrupts and remote boot.</span>
<span class="cm">	** This also disables the EISA_ENABLE bit in the EISA Control Register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">eisa_cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EISA_CR</span><span class="p">);</span>
	<span class="n">INIT_EWRK3</span><span class="p">;</span>

	<span class="n">nicsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>

	<span class="n">icr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_ICR</span><span class="p">);</span>
	<span class="n">icr</span> <span class="o">&amp;=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">EWRK3_ICR</span><span class="p">);</span>	<span class="cm">/* Disable all the IRQs */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nicsr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">CSR_TXD</span> <span class="o">|</span> <span class="n">CSR_RXD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Check that the EEPROM is alive and well and not living on Pluto... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_MAX</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">tmp</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="n">Read_EEPROM</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">eeprom_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">eeprom_image</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Bad EEPROM Data! */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Device has a bad on-board EEPROM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EthwrkSignature</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">eeprom_image</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">eisa_cr</span><span class="p">,</span> <span class="n">EISA_CR</span><span class="p">);</span>		<span class="cm">/* Rewrite the EISA CR */</span>
	<span class="p">}</span>
	<span class="n">lemac</span> <span class="o">=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_CHIPVER</span><span class="p">];</span>
	<span class="n">cmr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CMR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">lemac</span> <span class="o">==</span> <span class="n">LeMAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">cmr</span> <span class="o">&amp;</span> <span class="n">CMR_NO_EEPROM</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMR_NO_EEPROM</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">lemac</span> <span class="o">==</span> <span class="n">LeMAC2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cmr</span> <span class="o">&amp;</span> <span class="n">CMR_HS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s at %#4lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
		<span class="n">hard_strapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">iobase</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">==</span> <span class="n">EWRK3_EISA_IO_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EISA slot address */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s at %#4lx (EISA slot %ld)&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="p">((</span><span class="n">iobase</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* ISA port address */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s at %#4lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, h/w address &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lemac</span> <span class="o">!=</span> <span class="n">LeMAC2</span><span class="p">)</span>
		<span class="n">DevicePresent</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>	<span class="cm">/* need after EWRK3_INIT */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">get_hw_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eeprom_image</span><span class="p">,</span> <span class="n">lemac</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      which has an EEPROM CRC error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lemac</span> <span class="o">==</span> <span class="n">LeMAC2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Special LeMAC2 CMR things */</span>
		<span class="n">cmr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMR_RA</span> <span class="o">|</span> <span class="n">CMR_WB</span> <span class="o">|</span> <span class="n">CMR_LINK</span> <span class="o">|</span> <span class="n">CMR_POLARITY</span> <span class="o">|</span> <span class="n">CMR_0WS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_MISC0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">READ_AHEAD</span><span class="p">)</span>
			<span class="n">cmr</span> <span class="o">|=</span> <span class="n">CMR_RA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_MISC0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WRITE_BEHIND</span><span class="p">)</span>
			<span class="n">cmr</span> <span class="o">|=</span> <span class="n">CMR_WB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_NETMAN0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NETMAN_POL</span><span class="p">)</span>
			<span class="n">cmr</span> <span class="o">|=</span> <span class="n">CMR_POLARITY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_NETMAN0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NETMAN_LINK</span><span class="p">)</span>
			<span class="n">cmr</span> <span class="o">|=</span> <span class="n">CMR_LINK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_MISC0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_0WS_ENA</span><span class="p">)</span>
			<span class="n">cmr</span> <span class="o">|=</span> <span class="n">CMR_0WS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_SETUP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SETUP_DRAM</span><span class="p">)</span>
		<span class="n">cmr</span> <span class="o">|=</span> <span class="n">CMR_DRAM</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cmr</span><span class="p">,</span> <span class="n">EWRK3_CMR</span><span class="p">);</span>

	<span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>	<span class="cm">/* Set up the Control Register */</span>
	<span class="n">cr</span> <span class="o">|=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_SETUP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SETUP_APD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">SETUP_APD</span><span class="p">)</span>
		<span class="n">cr</span> <span class="o">|=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_SETUP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SETUP_PS</span><span class="p">;</span>
	<span class="n">cr</span> <span class="o">|=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_MISC0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FAST_BUS</span><span class="p">;</span>
	<span class="n">cr</span> <span class="o">|=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_MISC0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ENA_16</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** Determine the base address and window length for the EWRK3</span>
<span class="cm">	** RAM from the memory base register.</span>
<span class="cm">	*/</span>
	<span class="n">mem_start</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_MBR</span><span class="p">);</span>
	<span class="n">shmem_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mem_start</span> <span class="o">&gt;=</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem_start</span> <span class="o">&lt;=</span> <span class="mh">0x0f</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mem_start</span> <span class="o">*=</span> <span class="n">SHMEM_64K</span><span class="p">;</span>
			<span class="n">shmem_length</span> <span class="o">=</span> <span class="n">SHMEM_64K</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mem_start</span> <span class="o">&gt;=</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem_start</span> <span class="o">&lt;=</span> <span class="mh">0x1f</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mem_start</span> <span class="o">*=</span> <span class="n">SHMEM_32K</span><span class="p">;</span>
			<span class="n">shmem_length</span> <span class="o">=</span> <span class="n">SHMEM_32K</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mem_start</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem_start</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mem_start</span> <span class="o">=</span> <span class="n">mem_start</span> <span class="o">*</span> <span class="n">SHMEM_2K</span> <span class="o">+</span> <span class="mh">0x80000</span><span class="p">;</span>
			<span class="n">shmem_length</span> <span class="o">=</span> <span class="n">SHMEM_2K</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	** See the top of this source code for comments about</span>
<span class="cm">	** uncommenting this line.</span>
<span class="cm">	*/</span>
<span class="cm">/*          FORCE_2K_MODE; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hard_strapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      is hard strapped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mem_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      has a %dk RAM window&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">shmem_length</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; at 0x%.5lx&quot;</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      is in I/O only mode&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">=</span> <span class="n">mem_start</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">shmem_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">=</span> <span class="n">shmem_length</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lemac</span> <span class="o">=</span> <span class="n">lemac</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hard_strapped</span> <span class="o">=</span> <span class="n">hard_strapped</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">led_mask</span> <span class="o">=</span> <span class="n">CR_LED</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mPage</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmr</span> <span class="o">&amp;</span> <span class="n">CMR_DRAM</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mPage</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 2 DRAMS on module */</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span> <span class="s">&quot;%s (%s)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">ICR_TNEM</span> <span class="o">|</span> <span class="n">ICR_TXDM</span> <span class="o">|</span> <span class="n">ICR_RNEM</span> <span class="o">|</span> <span class="n">ICR_RXDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hard_strapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		** Enable EWRK3 board interrupts for autoprobing</span>
<span class="cm">		*/</span>
		<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_IE</span><span class="p">;</span>	<span class="cm">/* Enable interrupts */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">EWRK3_ICR</span><span class="p">);</span>

		<span class="cm">/* The DMA channel may be passed in on this parameter. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* To auto-IRQ we enable the initialization-done and DMA err,</span>
<span class="cm">		   interrupts. For now we will always get a DMA error. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
			<span class="n">u_char</span> <span class="n">irqnum</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span><span class="p">;</span>


			<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>

			<span class="cm">/*</span>
<span class="cm">			** Trigger a TNE interrupt.</span>
<span class="cm">			*/</span>
			<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_TNEM</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">EWRK3_TDQ</span><span class="p">);</span>	<span class="cm">/* Write to the TX done queue */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">EWRK3_ICR</span><span class="p">);</span>	<span class="cm">/* Unmask the TXD interrupt */</span>

			<span class="n">irqnum</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[((</span><span class="n">icr</span> <span class="o">&amp;</span> <span class="n">IRQ_SEL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)];</span>

			<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irqnum</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; and uses IRQ%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; and failed to detect IRQ line.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">irqnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lemac</span> <span class="o">==</span> <span class="n">LeMAC2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; and an illegal IRQ line detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, but incorrect IRQ line detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">DISABLE_IRQs</span><span class="p">;</span>	<span class="cm">/* Mask all interrupts */</span>

<span class="cp">#endif				</span><span class="cm">/* MODULE */</span><span class="cp"></span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; and requires IRQ%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ewrk3_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* The EWRK3-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ewrk3_netdev_ops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;3&#39;</span><span class="p">)</span>
		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_ops_203</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">QUEUE_PKT_TIMEOUT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">icr</span><span class="p">,</span> <span class="n">csr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   ** Stop the TX and RX...</span>
<span class="cm">	 */</span>
	<span class="n">STOP_EWRK3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hard_strapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">ewrk3_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ewrk3&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ewrk3_open(): Requested IRQ%d is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			   ** Re-initialize the EWRK3...</span>
<span class="cm">			 */</span>
			<span class="n">ewrk3_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ewrk3_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ewrk3 open with irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  physical address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  no shared memory, I/O only mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  start of shared memory: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_base</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  window length: 0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  # of DRAMS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CMR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  csr:  0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cr:   0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  icr:  0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_ICR</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cmr:  0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CMR</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  fmqc: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_FMQC</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			   ** Unmask EWRK3 board interrupts</span>
<span class="cm">			 */</span>
			<span class="n">icr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_ICR</span><span class="p">);</span>
			<span class="n">ENABLE_IRQs</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ewrk3 available for hard strapped set up only.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;      Run the &#39;ewrk3setup&#39; utility or remove the hard straps.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Initialize the EtherWORKS 3 operating conditions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ewrk3_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_char</span> <span class="n">csr</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   ** Enable any multicasts</span>
<span class="cm">	 */</span>
	<span class="n">set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** Set hardware MAC address. Address is initialized from the EEPROM</span>
<span class="cm">	** during startup but may have since been changed by the user.</span>
<span class="cm">	*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">EWRK3_PAR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	   ** Clean out any remaining entries in all the queues here</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_TQ</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_TDQ</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_RQ</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_FMQ</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	   ** Write a clean free memory queue</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mPage</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Write the free page numbers */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_FMQ</span><span class="p">);</span>	<span class="cm">/* to the Free Memory Queue */</span>
	<span class="p">}</span>

	<span class="n">START_EWRK3</span><span class="p">;</span>		<span class="cm">/* Enable the TX and/or RX */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Transmit timeout</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ewrk3_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_char</span> <span class="n">icr</span><span class="p">,</span> <span class="n">csr</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hard_strapped</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: transmit timed/locked out, status %04x, resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		   ** Mask all board interrupts</span>
<span class="cm">		 */</span>
		<span class="n">DISABLE_IRQs</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		   ** Stop the TX and RX...</span>
<span class="cm">		 */</span>
		<span class="n">STOP_EWRK3</span><span class="p">;</span>

		<span class="n">ewrk3_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		   ** Unmask EWRK3 board interrupts</span>
<span class="cm">		 */</span>
		<span class="n">ENABLE_IRQs</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Writes a socket buffer to the free page queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ewrk3_queue_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">icr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">page</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">DISABLE_IRQs</span><span class="p">;</span>

	<span class="cm">/* if no resources available, exit, request packet be queued */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span> <span class="p">(</span><span class="n">EWRK3_FMQC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ewrk3_queue_pkt(): No free resources...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ewrk3_queue_pkt(): CSR: %02x ICR: %02x FMQC: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span> <span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">),</span> <span class="n">inb</span> <span class="p">(</span><span class="n">EWRK3_ICR</span><span class="p">),</span>
			<span class="n">inb</span> <span class="p">(</span><span class="n">EWRK3_FMQC</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Get a free page from the FMQ</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">page</span> <span class="o">=</span> <span class="n">inb</span> <span class="p">(</span><span class="n">EWRK3_FMQ</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mPage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;ewrk3_queue_pkt(): Invalid free memory page (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 ** Set up shared memory window and pointer into the window</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">SHMEM_2K</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">;</span>
		<span class="n">outb</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">SHMEM_32K</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">short</span><span class="p">)</span> <span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7800</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">;</span>
		<span class="n">outb</span> <span class="p">((</span><span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">SHMEM_64K</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">short</span><span class="p">)</span> <span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">;</span>
		<span class="n">outb</span> <span class="p">((</span><span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Oops - your private data area is hosed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">BUG</span> <span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Set up the buffer control structures and copy the data from</span>
<span class="cm">	 ** the socket buffer to the shared memory .</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">outb</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">TCR_QMODE</span> <span class="o">|</span> <span class="n">TCR_PAD</span> <span class="o">|</span> <span class="n">TCR_IFC</span><span class="p">),</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
		<span class="n">outb</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
		<span class="n">outb</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
		<span class="n">outb</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">outb</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_TQ</span><span class="p">);</span>	<span class="cm">/* Start sending pkt */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writeb</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">TCR_QMODE</span> <span class="o">|</span> <span class="n">TCR_PAD</span> <span class="o">|</span> <span class="n">TCR_IFC</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>	<span class="cm">/* ctrl byte */</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">writeb</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>	<span class="cm">/* length (16 bit xfer) */</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">XCT</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>	<span class="cm">/* index byte */</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>	<span class="cm">/* Write the XCT flag */</span>
			<span class="n">memcpy_toio</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PRELOAD</span><span class="p">);</span>	<span class="cm">/* Write PRELOAD bytes */</span>
			<span class="n">outb</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_TQ</span><span class="p">);</span>	<span class="cm">/* Start sending pkt */</span>
			<span class="n">memcpy_toio</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PRELOAD</span><span class="p">,</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">PRELOAD</span><span class="p">,</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">PRELOAD</span><span class="p">);</span>
			<span class="n">writeb</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>	<span class="cm">/* Write the XCT flag */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writeb</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>	<span class="cm">/* index byte */</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memcpy_toio</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>	<span class="cm">/* Write data bytes */</span>
			<span class="n">outb</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_TQ</span><span class="p">);</span>	<span class="cm">/* Start sending pkt */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ENABLE_IRQs</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Check for free resources: stop Tx queue if there are none */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span> <span class="p">(</span><span class="n">EWRK3_FMQC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">ENABLE_IRQs</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** The EWRK3 interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ewrk3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">icr</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* get the interrupt information */</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Mask the EWRK3 board interrupts and turn on the LED</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">DISABLE_IRQs</span><span class="p">;</span>

	<span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>
	<span class="n">cr</span> <span class="o">|=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">led_mask</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">CSR_RNE</span><span class="p">)</span>	<span class="cm">/* Rx interrupt (packet[s] arrived) */</span>
		<span class="n">ewrk3_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">CSR_TNE</span><span class="p">)</span>	<span class="cm">/* Tx interrupt (packet sent) */</span>
		<span class="n">ewrk3_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Now deal with the TX/RX disable flags. These are set when there</span>
<span class="cm">	 ** are no more resources. If resources free up then enable these</span>
<span class="cm">	 ** interrupts, otherwise mask them - failure to do this will result</span>
<span class="cm">	 ** in the system hanging in an interrupt loop.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_FMQC</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* any resources available? */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">ICR_TXDM</span> <span class="o">|</span> <span class="n">ICR_RXDM</span><span class="p">;</span>	<span class="cm">/* enable the interrupt source */</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_TXD</span> <span class="o">|</span> <span class="n">CSR_RXD</span><span class="p">);</span>	<span class="cm">/* ensure restart of a stalled TX or RX */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_TXDM</span> <span class="o">|</span> <span class="n">ICR_RXDM</span><span class="p">);</span>		<span class="cm">/* disable the interrupt source */</span>
	<span class="p">}</span>

	<span class="cm">/* Unmask the EWRK3 board interrupts and turn off the LED */</span>
	<span class="n">cr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">led_mask</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>
	<span class="n">ENABLE_IRQs</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with lp-&gt;hw_lock held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_RQC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Whilst there&#39;s incoming data */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_RQ</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mPage</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Get next entry&#39;s buffer page */</span>
			<span class="cm">/*</span>
<span class="cm">			   ** Set up shared memory window and pointer into the window</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">SHMEM_2K</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">SHMEM_32K</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">short</span><span class="p">)</span> <span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7800</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">((</span><span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">SHMEM_64K</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">short</span><span class="p">)</span> <span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">((</span><span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Oops - your private data area is hosed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">rx_status</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rx_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">);</span>
					<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">);</span>
					<span class="n">pkt_len</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u_short</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rx_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="n">buf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
					<span class="n">buf</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">R_ROK</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* There was an error. */</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Update the error stats. */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">R_DBE</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">R_CRC</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">R_PLL</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
						<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align to 16 bytes */</span>
						<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">);</span>	<span class="cm">/* dummy read */</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
								<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EWRK3_PKT_STAT_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">*</span> <span class="n">EWRK3_PKT_BIN_SZ</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
								<span class="n">i</span> <span class="o">=</span> <span class="n">EWRK3_PKT_STAT_SZ</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* Look at the dest addr */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">broadcast</span><span class="o">++</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
									    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">unicast</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* Duplicates stats.rx_packets */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Reset counters */</span>
							<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">));</span>
						<span class="p">}</span>
						<span class="cm">/*</span>
<span class="cm">						   ** Notify the upper protocol layers that there is another</span>
<span class="cm">						   ** packet to handle</span>
<span class="cm">						 */</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
						<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

						<span class="cm">/*</span>
<span class="cm">						   ** Update stats</span>
<span class="cm">						 */</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Insufficient memory; nuking packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* Really, deferred. */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			   ** Return the received buffer to the free memory queue</span>
<span class="cm">			 */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">EWRK3_FMQ</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ewrk3_rx(): Illegal page number, page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ewrk3_rx(): CSR: %02x ICR: %02x FMQC: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">),</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_ICR</span><span class="p">),</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_FMQC</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Buffer sent - check for TX buffer errors.</span>
<span class="cm">** Called with lp-&gt;hw_lock held</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tx_status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_TDQ</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Whilst there&#39;s old buffers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_VSTS</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* The status is valid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_TXE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_NCL</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_LCL</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_CTU</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_COLL</span><span class="p">)</span> <span class="o">^</span> <span class="n">T_XUR</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">tx_underruns</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">excessive_underruns</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_COLL</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">T_COLL</span><span class="p">)</span> <span class="o">^</span> <span class="n">T_XCOLL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">excessive_collisions</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">icr</span><span class="p">,</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ewrk3_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Shutting down ethercard, status was %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   ** We stop the EWRK3 here... mask interrupts and stop TX &amp; RX</span>
<span class="cm">	 */</span>
	<span class="n">DISABLE_IRQs</span><span class="p">;</span>

	<span class="n">STOP_EWRK3</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   ** Clean out the TX and RX queues here (note that one entry</span>
<span class="cm">	   ** may get added to either the TXD or RX queues if the TX or RX</span>
<span class="cm">	   ** just starts processing a packet before the STOP_EWRK3 command</span>
<span class="cm">	   ** is received. This will be flushed in the ewrk3_open() call).</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_TQ</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_TDQ</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_RQ</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hard_strapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Set or clear the multicast filter for this adapter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span> <span class="o">+</span> <span class="n">PAGE0_HTE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_PME</span> <span class="o">|</span> <span class="n">CSR_MCE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* set promiscuous mode */</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">CSR_PME</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SetMulticastFilter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">CSR_MCE</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Calculate the hash code and update the logical address filter</span>
<span class="cm">   ** from a list of ethernet multicast addresses.</span>
<span class="cm">   ** Little endian crc one liner from Matt Thomas, DEC.</span>
<span class="cm">   **</span>
<span class="cm">   ** Note that when clearing the table, the broadcast bit must remain asserted</span>
<span class="cm">   ** to receive broadcast messages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">SetMulticastFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bit</span><span class="p">,</span> <span class="n">byte</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hashcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">PAGE0_HTE</span><span class="p">,</span> <span class="n">EWRK3_PIR1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* memset didn&#39;t work here */</span>
				<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Clear table except for broadcast bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* insert the broadcast bit */</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memset_io</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span> <span class="o">+</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Update table */</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">hashcode</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* hashcode is 9 LSb of CRC */</span>

			<span class="n">byte</span> <span class="o">=</span> <span class="n">hashcode</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* bit[3-8] -&gt; byte in filter */</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hashcode</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>	<span class="cm">/* bit[0-2] -&gt; bit in byte */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_char</span> <span class="n">tmp</span><span class="p">;</span>

				<span class="n">outw</span><span class="p">(</span><span class="n">PAGE0_HTE</span> <span class="o">+</span> <span class="n">byte</span><span class="p">,</span> <span class="n">EWRK3_PIR1</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">PAGE0_HTE</span> <span class="o">+</span> <span class="n">byte</span><span class="p">,</span> <span class="n">EWRK3_PIR1</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EWRK3_DATA</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span> <span class="o">+</span> <span class="n">byte</span><span class="p">)</span> <span class="o">|</span> <span class="n">bit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mctbl</span> <span class="o">+</span> <span class="n">byte</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** ISA bus I/O device probe</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">isa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">num_ewrks3s</span><span class="p">,</span> <span class="n">maxSlots</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">&gt;=</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Autoprobing */</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">EWRK3_IO_BASE</span><span class="p">;</span>		<span class="cm">/* Get the first slot address */</span>
		<span class="n">maxSlots</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Probe a specific location */</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
		<span class="n">maxSlots</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxSlots</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	     <span class="n">iobase</span> <span class="o">+=</span> <span class="n">EWRK3_IOP_INC</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">EWRK3_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DevicePresent</span><span class="p">(</span><span class="n">iobase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ewrk3_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">EWRK3_TOTAL_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** EISA bus I/O device probe. Probe from slot 1 since slot 0 is usually</span>
<span class="cm">   ** the motherboard.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eisa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">maxSlots</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">maxSlots</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxSlots</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+=</span> <span class="n">EISA_SLOT_INC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EISA_signature</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">EISA_ID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">EWRK3_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">DevicePresent</span><span class="p">(</span><span class="n">iobase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ewrk3_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">EWRK3_TOTAL_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   ** Read the EWRK3 EEPROM using this routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">Read_EEPROM</span><span class="p">(</span><span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">eaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">eaddr</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span> <span class="n">EWRK3_PIR1</span><span class="p">);</span>	<span class="cm">/* set up 6 bits of address info */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EEPROM_RD</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>	<span class="cm">/* issue read command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>	<span class="cm">/* wait 1msec */</span>

	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">EWRK3_EPROM1</span><span class="p">);</span>	<span class="cm">/* 16 bits data return */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Write the EWRK3 EEPROM using this routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">Write_EEPROM</span><span class="p">(</span><span class="kt">short</span> <span class="n">data</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">eaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">EEPROM_WR_EN</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>		<span class="cm">/* issue write enable command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>	<span class="cm">/* wait 1msec */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EWRK3_EPROM1</span><span class="p">);</span>	<span class="cm">/* write data to register */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">eaddr</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span> <span class="n">EWRK3_PIR1</span><span class="p">);</span>	<span class="cm">/* set up 6 bits of address info */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EEPROM_WR</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>	<span class="cm">/* issue write command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">75000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>	<span class="cm">/* wait 15msec */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EEPROM_WR_DIS</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>	<span class="cm">/* issue write disable command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>	<span class="cm">/* wait 1msec */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Look for a particular board name in the on-board EEPROM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">EthwrkSignature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eeprom_image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">signatures</span><span class="p">[]</span> <span class="o">=</span> <span class="n">EWRK3_SIGNATURE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">signatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">eeprom_image</span><span class="o">+</span><span class="n">EEPROM_PNAME7</span><span class="p">,</span> <span class="n">signatures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strlen</span><span class="p">(</span><span class="n">signatures</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">signatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">eeprom_image</span><span class="o">+</span><span class="n">EEPROM_PNAME7</span><span class="p">,</span> <span class="n">EWRK3_STRLEN</span><span class="p">);</span>
		<span class="n">name</span><span class="p">[</span><span class="n">EWRK3_STRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Look for a special sequence in the Ethernet station address PROM that</span>
<span class="cm">   ** is common across all EWRK3 products.</span>
<span class="cm">   **</span>
<span class="cm">   ** Search the Ethernet address ROM for the signature. Since the ROM address</span>
<span class="cm">   ** counter can start at an arbitrary point, the search must include the entire</span>
<span class="cm">   ** probe sequence length plus the (length_of_the_signature - 1).</span>
<span class="cm">   ** Stop the search IMMEDIATELY after the signature is found so that the</span>
<span class="cm">   ** PROM address counter is correctly positioned at the start of the</span>
<span class="cm">   ** ethernet address for later read out.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">DevicePresent</span><span class="p">(</span><span class="n">u_long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">b</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">llsig</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">Sig</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">sigLength</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="p">.</span><span class="n">llsig</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ETH_PROM_SIG</span><span class="p">;</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">llsig</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ETH_PROM_SIG</span><span class="p">;</span>
	<span class="n">sigLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sigLength</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROBE_LENGTH</span> <span class="o">+</span> <span class="n">sigLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_APROM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">Sig</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* track signature */</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* lost signature; begin search again */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">dev</span><span class="p">.</span><span class="n">Sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">sigLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/* search failed */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">__init</span> <span class="nf">get_hw_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span> <span class="n">eeprom_image</span><span class="p">,</span> <span class="kt">char</span> <span class="n">chipType</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">crc</span><span class="p">,</span> <span class="n">lfsr</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chipType</span> <span class="o">==</span> <span class="n">LeMAC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_PADDR0</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">EWRK3_PAR0</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">sd</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lfsr</span> <span class="o">=</span> <span class="p">((((</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">^</span> <span class="p">(</span><span class="n">sd</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">lfsr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">eeprom_image</span><span class="p">[</span><span class="n">EEPROM_PA_CRC</span><span class="p">])</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="n">k</span> <span class="o">-=</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_APROM</span><span class="p">));</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">EWRK3_PAR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_APROM</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">EWRK3_PAR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="n">k</span> <span class="o">-=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_APROM</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">|=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_APROM</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">chksum</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** Look for a particular board name in the EISA configuration space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">EISA_signature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">s32</span> <span class="n">eisa_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">signatures</span><span class="p">[]</span> <span class="o">=</span> <span class="n">EWRK3_SIGNATURE</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ManCode</span><span class="p">[</span><span class="n">EWRK3_STRLEN</span><span class="p">];</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">ID</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">Id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">Eisa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">eisa_id</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ManCode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">ManCode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">ManCode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">ManCode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">ManCode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Eisa</span><span class="p">.</span><span class="n">Id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">ManCode</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">signatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ManCode</span><span class="p">,</span> <span class="n">signatures</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ManCode</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>		<span class="cm">/* return the device name string */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ewrk3_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fwrev</span> <span class="o">=</span> <span class="n">Read_EEPROM</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EEPROM_REVLVL</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">fwrev</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="n">EEPROM_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;3&#39;</span>: <span class="cm">/* DE203 */</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_BNC</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_BNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;4&#39;</span>: <span class="cm">/* DE204 */</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_TP</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;5&#39;</span>: <span class="cm">/* DE205 */</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_BNC</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">CR_APD</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		** Port is only valid if autoneg is disabled</span>
<span class="cm">		** and even then we don&#39;t know if AUI is jumpered.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">CR_PSEL</span><span class="p">)</span> <span class="o">?</span> <span class="n">PORT_BNC</span> <span class="o">:</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">;</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr</span><span class="p">;</span>

	<span class="cm">/* DE205 is the only card with anything to set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;5&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* Sanity-check parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">PORT_TP</span> <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">PORT_BNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* AUI is not software-selectable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">!=</span> <span class="n">XCVR_INTERNAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>

	<span class="cm">/* If Autoneg is set, change to Auto Port mode */</span>
	<span class="cm">/* Otherwise, disable Auto Port and set port explicitly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CR_APD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cr</span> <span class="o">|=</span> <span class="n">CR_APD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">PORT_TP</span><span class="p">)</span>
			<span class="n">cr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CR_PSEL</span><span class="p">;</span>		<span class="cm">/* Force TP */</span>
		<span class="k">else</span>
			<span class="n">cr</span> <span class="o">|=</span> <span class="n">CR_PSEL</span><span class="p">;</span>		<span class="cm">/* Force BNC */</span>
	<span class="p">}</span>

	<span class="cm">/* Commit the changes */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ewrk3_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CMR</span><span class="p">);</span>
	<span class="cm">/* DE203 has BNC only and link status does not apply */</span>
	<span class="cm">/* On DE204 this is always valid since TP is the only port. */</span>
	<span class="cm">/* On DE205 this reflects TP status even if BNC or AUI is selected. */</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">cmr</span> <span class="o">&amp;</span> <span class="n">CMR_LINK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_set_phys_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="cm">/* Prevent ISR from twiddling the LED */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">led_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* cycle on/off twice per second */</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cr</span> <span class="o">|</span> <span class="n">CR_LED</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_LED</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">led_mask</span> <span class="o">=</span> <span class="n">CR_LED</span><span class="p">;</span>
		<span class="n">cr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_LED</span><span class="p">,</span> <span class="n">EWRK3_CR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops_203</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ewrk3_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">ewrk3_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">ewrk3_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span> <span class="o">=</span> <span class="n">ewrk3_set_phys_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ewrk3_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">ewrk3_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">ewrk3_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ewrk3_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span> <span class="o">=</span> <span class="n">ewrk3_set_phys_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">   ** Perform IOCTL call functions here. Some are privileged operations and the</span>
<span class="cm">   ** effective uid is checked in those cases.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ewrk3_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ewrk3_ioctl</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ewrk3_ioctl</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">csr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ewrk3_addr</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="n">addr</span><span class="p">[</span><span class="n">HASH_TABLE_LEN</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">val</span><span class="p">[(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">};</span>

	<span class="k">union</span> <span class="n">ewrk3_addr</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* All we handle are private IOCTLs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">EWRK3IOCTL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ewrk3_addr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tmp</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EWRK3_GET_HWADDR</span>:	<span class="cm">/* Get the hardware address */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EWRK3_SET_HWADDR</span>:	<span class="cm">/* Set the hardware address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CSR_TXD</span> <span class="o">|</span> <span class="n">CSR_RXD</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>	<span class="cm">/* Disable the TX and RX */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">EWRK3_PAR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_TXD</span> <span class="o">|</span> <span class="n">CSR_RXD</span><span class="p">);</span>	<span class="cm">/* Enable the TX and RX */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_SET_PROM</span>:	<span class="cm">/* Set Promiscuous Mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">CSR_PME</span><span class="p">;</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_MCE</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_CLR_PROM</span>:	<span class="cm">/* Clear Promiscuous Mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_PME</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_GET_MCA</span>:	<span class="cm">/* Get the multicast address table */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem_length</span> <span class="o">==</span> <span class="n">IO_ONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EWRK3_IOPR</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">PAGE0_HTE</span><span class="p">,</span> <span class="n">EWRK3_PIR1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_DATA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EWRK3_MPR</span><span class="p">);</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span> <span class="o">+</span> <span class="n">PAGE0_HTE</span><span class="p">,</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_SET_MCA</span>:	<span class="cm">/* Set a multicast address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HASH_TABLE_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_CLR_MCA</span>:	<span class="cm">/* Clear all multicast addresses */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_MCA_EN</span>:	<span class="cm">/* Enable multicast addressing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">CSR_MCE</span><span class="p">;</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_PME</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_GET_STATS</span>: <span class="p">{</span> <span class="cm">/* Get the driver statistics */</span>
		<span class="k">struct</span> <span class="n">ewrk3_stats</span> <span class="o">*</span><span class="n">tmp_stats</span> <span class="o">=</span>
        		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_stats</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">)))</span>
    			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmp_stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">EWRK3_CLR_STATS</span>:	<span class="cm">/* Zero out the driver statistics */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_GET_CSR</span>:	<span class="cm">/* Get the CSR Register contents */</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CSR</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_SET_CSR</span>:	<span class="cm">/* Set the CSR Register contents */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EWRK3_CSR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_GET_EEPROM</span>:	<span class="cm">/* Get the EEPROM contents */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">EEPROM_MAX</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="n">Read_EEPROM</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">EEPROM_MAX</span><span class="p">;</span>
			<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CMR</span><span class="p">);</span>		<span class="cm">/* Config/Management Reg. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_PAR0</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">EEPROM_MAX</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_SET_EEPROM</span>:	<span class="cm">/* Set the EEPROM contents */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">EEPROM_MAX</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">EEPROM_MAX</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">Write_EEPROM</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_GET_CMR</span>:	<span class="cm">/* Get the CMR Register contents */</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EWRK3_CMR</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_SET_TX_CUT_THRU</span>:	<span class="cm">/* Set TX cut through mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EWRK3_CLR_TX_CUT_THRU</span>:	<span class="cm">/* Clear TX cut through mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ewrk3_devs</span><span class="p">[</span><span class="n">MAX_NUM_EWRK3S</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ndevs</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="n">MAX_NUM_EWRK3S</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="cm">/* &#39;21&#39; below should really be &#39;MAX_NUM_EWRK3S&#39; */</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;EtherWORKS 3 I/O base address(es)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;EtherWORKS 3 IRQ number(s)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">ewrk3_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ewrk3_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ewrk3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ewrk3_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EWRK3_TOTAL_SIZE</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">shmem</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">ewrk3_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span>
			<span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ewrk3_private</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ewrk3_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ewrk3_devs</span><span class="p">[</span><span class="n">ndevs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ndevs</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Hack for breakage in new module stuff */</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ewrk3_exit_module</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ewrk3_init_module</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* MODULE */</span><span class="cp"></span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
