<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dec › tulip › pnic2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>pnic2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	drivers/net/ethernet/dec/tulip/pnic2.c</span>

<span class="cm">	Copyright 2000,2001  The Linux Kernel Team</span>
<span class="cm">	Written/copyright 1994-2001 by Donald Becker.</span>
<span class="cm">        Modified to hep support PNIC_II by Kevin B. Hendricks</span>

<span class="cm">	This software may be used and distributed according to the terms</span>
<span class="cm">	of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">        Please submit bugs to http://bugzilla.kernel.org/ .</span>
<span class="cm">*/</span>


<span class="cm">/* Understanding the PNIC_II - everything is this file is based</span>
<span class="cm"> * on the PNIC_II_PDF datasheet which is sorely lacking in detail</span>
<span class="cm"> *</span>
<span class="cm"> * As I understand things, here are the registers and bits that</span>
<span class="cm"> * explain the masks and constants used in this file that are</span>
<span class="cm"> * either different from the 21142/3 or important for basic operation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * CSR 6  (mask = 0xfe3bd1fd of bits not to change)</span>
<span class="cm"> * -----</span>
<span class="cm"> * Bit 24    - SCR</span>
<span class="cm"> * Bit 23    - PCS</span>
<span class="cm"> * Bit 22    - TTM (Trasmit Threshold Mode)</span>
<span class="cm"> * Bit 18    - Port Select</span>
<span class="cm"> * Bit 13    - Start - 1, Stop - 0 Transmissions</span>
<span class="cm"> * Bit 11:10 - Loop Back Operation Mode</span>
<span class="cm"> * Bit 9     - Full Duplex mode (Advertise 10BaseT-FD is CSR14&lt;7&gt; is set)</span>
<span class="cm"> * Bit 1     - Start - 1, Stop - 0 Receive</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * CSR 14  (mask = 0xfff0ee39 of bits not to change)</span>
<span class="cm"> * ------</span>
<span class="cm"> * Bit 19    - PAUSE-Pause</span>
<span class="cm"> * Bit 18    - Advertise T4</span>
<span class="cm"> * Bit 17    - Advertise 100baseTx-FD</span>
<span class="cm"> * Bit 16    - Advertise 100baseTx-HD</span>
<span class="cm"> * Bit 12    - LTE - Link Test Enable</span>
<span class="cm"> * Bit 7     - ANE - Auto Negotiate Enable</span>
<span class="cm"> * Bit 6     - HDE - Advertise 10baseT-HD</span>
<span class="cm"> * Bit 2     - Reset to Power down - kept as 1 for normal operation</span>
<span class="cm"> * Bit 1     -  Loop Back enable for 10baseT MCC</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * CSR 12</span>
<span class="cm"> * ------</span>
<span class="cm"> * Bit 25    - Partner can do T4</span>
<span class="cm"> * Bit 24    - Partner can do 100baseTx-FD</span>
<span class="cm"> * Bit 23    - Partner can do 100baseTx-HD</span>
<span class="cm"> * Bit 22    - Partner can do 10baseT-FD</span>
<span class="cm"> * Bit 21    - Partner can do 10baseT-HD</span>
<span class="cm"> * Bit 15    - LPN is 1 if all above bits are valid other wise 0</span>
<span class="cm"> * Bit 14:12 - autonegotiation state (write 001 to start autonegotiate)</span>
<span class="cm"> * Bit 3     - Autopolarity state</span>
<span class="cm"> * Bit 2     - LS10B - link state of 10baseT 0 - good, 1 - failed</span>
<span class="cm"> * Bit 1     - LS100B - link state of 100baseT 0 - good, 1 - failed</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Data Port Selection Info</span>
<span class="cm"> *-------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * CSR14&lt;7&gt;   CSR6&lt;18&gt;    CSR6&lt;22&gt;    CSR6&lt;23&gt;    CSR6&lt;24&gt;   MODE/PORT</span>
<span class="cm"> *   1           0           0 (X)       0 (X)       1        NWAY</span>
<span class="cm"> *   0           0           1           0 (X)       0        10baseT</span>
<span class="cm"> *   0           1           0           1           1 (X)    100baseT</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>



<span class="cp">#include &quot;tulip.h&quot;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>


<span class="kt">void</span> <span class="nf">pnic2_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PNIC2 negotiation status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_tick</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">next_tick</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pnic2_start_nway</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">csr14</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">csr12</span><span class="p">;</span>

        <span class="cm">/* set up what to advertise during the negotiation */</span>

        <span class="cm">/* load in csr14  and mask off bits not to touch</span>
<span class="cm">         * comment at top of file explains mask value</span>
<span class="cm">         */</span>
	<span class="n">csr14</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0ee39</span><span class="p">);</span>

        <span class="cm">/* bit 17 - advetise 100baseTx-FD */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="n">csr14</span> <span class="o">|=</span> <span class="mh">0x00020000</span><span class="p">;</span>

        <span class="cm">/* bit 16 - advertise 100baseTx-HD */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="n">csr14</span> <span class="o">|=</span> <span class="mh">0x00010000</span><span class="p">;</span>

        <span class="cm">/* bit 6 - advertise 10baseT-HD */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span> <span class="n">csr14</span> <span class="o">|=</span> <span class="mh">0x00000040</span><span class="p">;</span>

        <span class="cm">/* Now set bit 12 Link Test Enable, Bit 7 Autonegotiation Enable</span>
<span class="cm">         * and bit 0 Don&#39;t PowerDown 10baseT</span>
<span class="cm">         */</span>
        <span class="n">csr14</span> <span class="o">|=</span> <span class="mh">0x00001184</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Restarting PNIC2 autonegotiation, csr14=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">csr14</span><span class="p">);</span>

        <span class="cm">/* tell pnic2_lnk_change we are doing an nway negotiation */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nway</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mediasense</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">lpar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* now we have to set up csr6 for NWAY state */</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;On Entry to Nway, csr6=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">);</span>

        <span class="cm">/* mask off any bits not to touch</span>
<span class="cm">         * comment at top of file explains mask value</span>
<span class="cm">         */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0xfe3bd1fd</span><span class="p">;</span>

        <span class="cm">/* don&#39;t forget that bit 9 is also used for advertising */</span>
        <span class="cm">/* advertise 10baseT-FD for the negotiation (bit 9) */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x00000200</span><span class="p">;</span>

        <span class="cm">/* set bit 24 for nway negotiation mode ...</span>
<span class="cm">         * see Data Port Selection comment at top of file</span>
<span class="cm">         * and &quot;Stop&quot; - reset both Transmit (bit 13) and Receive (bit 1)</span>
<span class="cm">         */</span>
        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x01000000</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">csr14</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">);</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

        <span class="cm">/* all set up so now force the negotiation to begin */</span>

        <span class="cm">/* read in current values and mask off all but the</span>
<span class="cm">	 * Autonegotiation bits 14:12.  Writing a 001 to those bits</span>
<span class="cm">         * should start the autonegotiation</span>
<span class="cm">         */</span>
        <span class="n">csr12</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff8fff</span><span class="p">);</span>
        <span class="n">csr12</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">csr12</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">pnic2_lnk_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">csr14</span><span class="p">;</span>

        <span class="cm">/* read the staus register to find out what is up */</span>
	<span class="kt">int</span> <span class="n">csr12</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;PNIC2 link status interrupt %08x,  CSR5 %x, %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">csr12</span><span class="p">,</span> <span class="n">csr5</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">));</span>

	<span class="cm">/* If NWay finished and we have a negotiated partner capability.</span>
<span class="cm">         * check bits 14:12 for bit pattern 101 - all is good</span>
<span class="cm">         */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nway</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span><span class="p">)</span> <span class="p">{</span>

	        <span class="cm">/* we did an auto negotiation */</span>

                <span class="k">if</span> <span class="p">((</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5000</span><span class="p">)</span> <span class="p">{</span>

	               <span class="cm">/* negotiation ended successfully */</span>

	               <span class="cm">/* get the link partners reply and mask out all but</span>
<span class="cm">                        * bits 24-21 which show the partners capabilities</span>
<span class="cm">                        * and match those to what we advertised</span>
<span class="cm">                        *</span>
<span class="cm">                        * then begin to interpret the results of the negotiation.</span>
<span class="cm">                        * Always go in this order : (we are ignoring T4 for now)</span>
<span class="cm">                        *     100baseTx-FD, 100baseTx-HD, 10baseT-FD, 10baseT-HD</span>
<span class="cm">                        */</span>

		        <span class="kt">int</span> <span class="n">negotiated</span> <span class="o">=</span> <span class="p">((</span><span class="n">csr12</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01E0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span><span class="p">;</span>
		        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">lpar</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr12</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">negotiated</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiated</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiated</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">)</span>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiated</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
			     <span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				     <span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="s">&quot;funny autonegotiate result csr12 %08x advertising %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">csr12</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span><span class="p">);</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="cm">/* so check  if 100baseTx link state is okay */</span>
			     <span class="k">if</span> <span class="p">((</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span> <span class="o">&amp;</span> <span class="mh">0x0180</span><span class="p">))</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* now record the duplex that was negotiated */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			       <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span><span class="p">)</span>
				       <span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;Switching to %s based on link negotiation %04x &amp; %04x = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">medianame</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">],</span>
						<span class="n">tp</span><span class="o">-&gt;</span><span class="n">sym_advertise</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">lpar</span><span class="p">,</span>
						<span class="n">negotiated</span><span class="p">);</span>
			<span class="p">}</span>

                        <span class="cm">/* remember to turn off bit 7 - autonegotiate</span>
<span class="cm">                         * enable so we can properly end nway mode and</span>
<span class="cm">                         * set duplex (ie. use csr6&lt;9&gt; again)</span>
<span class="cm">                         */</span>
	                <span class="n">csr14</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff7f</span><span class="p">);</span>
                        <span class="n">iowrite32</span><span class="p">(</span><span class="n">csr14</span><span class="p">,</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">);</span>


                        <span class="cm">/* now set the data port and operating mode</span>
<span class="cm">			 * (see the Data Port Selection comments at</span>
<span class="cm">			 * the top of the file</span>
<span class="cm">			 */</span>

			<span class="cm">/* get current csr6 and mask off bits not to touch */</span>
			<span class="cm">/* see comment at top of file */</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe3bd1fd</span><span class="p">);</span>

			<span class="cm">/* so if using if_port 3 or 5 then select the 100baseT</span>
<span class="cm">			 * port else select the 10baseT port.</span>
<span class="cm">			 * See the Data Port Selection table at the top</span>
<span class="cm">			 * of the file which was taken from the PNIC_II.PDF</span>
<span class="cm">			 * datasheet</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x01840000</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>

			<span class="cm">/* now set the full duplex bit appropriately */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x00000200</span><span class="p">;</span>

			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR13</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Setting CSR6 %08x/%x CSR12 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">,</span>
					   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">),</span>
					   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">));</span>

			<span class="cm">/* now the following actually writes out the</span>
<span class="cm">			 * new csr6 values</span>
<span class="cm">			 */</span>
			<span class="n">tulip_start_rxtx</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

                        <span class="k">return</span><span class="p">;</span>

	        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	                <span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Autonegotiation failed, using %s, link beat status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">medianame</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">],</span> <span class="n">csr12</span><span class="p">);</span>

                        <span class="cm">/* remember to turn off bit 7 - autonegotiate</span>
<span class="cm">                         * enable so we don&#39;t forget</span>
<span class="cm">                         */</span>
	                <span class="n">csr14</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff7f</span><span class="p">);</span>
                        <span class="n">iowrite32</span><span class="p">(</span><span class="n">csr14</span><span class="p">,</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">);</span>

                        <span class="cm">/* what should we do when autonegotiate fails?</span>
<span class="cm">                         * should we try again or default to baseline</span>
<span class="cm">                         * case.  I just don&#39;t know.</span>
<span class="cm">                         *</span>
<span class="cm">                         * for now default to some baseline case</span>
<span class="cm">                         */</span>

	                 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                         <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nway</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                         <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                         <span class="cm">/* set to 10baseTx-HD - see Data Port Selection</span>
<span class="cm">                          * comment given at the top of the file</span>
<span class="cm">                          */</span>
	                 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe3bd1fd</span><span class="p">);</span>
                         <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>

	                 <span class="n">tulip_restart_rxtx</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

                         <span class="k">return</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">3</span>  <span class="o">||</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nway</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPLnkFail</span><span class="p">))))</span> <span class="p">{</span>

		<span class="cm">/* Link blew? Maybe restart NWay. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ugh! Link blew?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">pnic2_start_nway</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

                <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">3</span>  <span class="o">||</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>

	        <span class="cm">/* we are at 100mb and a potential link change occurred */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PNIC2 %s link beat %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">medianame</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">],</span>
				 <span class="p">(</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;good&quot;</span><span class="p">);</span>

                <span class="cm">/* check 100 link beat */</span>

                <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nway</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                <span class="cm">/* if failed then try doing an nway to get in sync */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">medialock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">pnic2_start_nway</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
       			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">||</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>

	        <span class="cm">/* we are at 10mb and a potential link change occurred */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PNIC2 %s link beat %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">medianame</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">],</span>
				 <span class="p">(</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;good&quot;</span><span class="p">);</span>


                <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nway</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nwayset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                <span class="cm">/* if failed, try doing an nway to get in sync */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">medialock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">pnic2_start_nway</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
       			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PNIC2 Link Change Default?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="cm">/* if all else fails default to trying 10baseT-HD */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* make sure autonegotiate enable is off */</span>
	<span class="n">csr14</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff7f</span><span class="p">);</span>
        <span class="n">iowrite32</span><span class="p">(</span><span class="n">csr14</span><span class="p">,</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR14</span><span class="p">);</span>

        <span class="cm">/* set to 10baseTx-HD - see Data Port Selection</span>
<span class="cm">         * comment given at the top of the file</span>
<span class="cm">         */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe3bd1fd</span><span class="p">);</span>
        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>

	<span class="n">tulip_restart_rxtx</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
