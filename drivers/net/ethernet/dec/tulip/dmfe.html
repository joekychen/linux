<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dec › tulip › dmfe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dmfe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    A Davicom DM9102/DM9102A/DM9102A+DM9801/DM9102A+DM9802 NIC fast</span>
<span class="cm">    ethernet driver for Linux.</span>
<span class="cm">    Copyright (C) 1997  Sten Wang</span>

<span class="cm">    This program is free software; you can redistribute it and/or</span>
<span class="cm">    modify it under the terms of the GNU General Public License</span>
<span class="cm">    as published by the Free Software Foundation; either version 2</span>
<span class="cm">    of the License, or (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    DAVICOM Web-Site: www.davicom.com.tw</span>

<span class="cm">    Author: Sten Wang, 886-3-5798797-8517, E-mail: sten_wang@davicom.com.tw</span>
<span class="cm">    Maintainer: Tobias Ringstrom &lt;tori@unhappy.mine.nu&gt;</span>

<span class="cm">    (C)Copyright 1997-1998 DAVICOM Semiconductor,Inc. All Rights Reserved.</span>

<span class="cm">    Marcelo Tosatti &lt;marcelo@conectiva.com.br&gt; :</span>
<span class="cm">    Made it compile in 2.3 (device to net_device)</span>

<span class="cm">    Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt; :</span>
<span class="cm">    Cleaned up for kernel merge.</span>
<span class="cm">    Removed the back compatibility support</span>
<span class="cm">    Reformatted, fixing spelling etc as I went</span>
<span class="cm">    Removed IRQ 0-15 assumption</span>

<span class="cm">    Jeff Garzik &lt;jgarzik@pobox.com&gt; :</span>
<span class="cm">    Updated to use new PCI driver API.</span>
<span class="cm">    Resource usage cleanups.</span>
<span class="cm">    Report driver version to user.</span>

<span class="cm">    Tobias Ringstrom &lt;tori@unhappy.mine.nu&gt; :</span>
<span class="cm">    Cleaned up and added SMP safety.  Thanks go to Jeff Garzik,</span>
<span class="cm">    Andrew Morton and Frank Davis for the SMP safety fixes.</span>

<span class="cm">    Vojtech Pavlik &lt;vojtech@suse.cz&gt; :</span>
<span class="cm">    Cleaned up pointer arithmetics.</span>
<span class="cm">    Fixed a lot of 64bit issues.</span>
<span class="cm">    Cleaned up printk()s a bit.</span>
<span class="cm">    Fixed some obvious big endian problems.</span>

<span class="cm">    Tobias Ringstrom &lt;tori@unhappy.mine.nu&gt; :</span>
<span class="cm">    Use time_after for jiffies calculation.  Added ethtool</span>
<span class="cm">    support.  Updated PCI resource allocation.  Do not</span>
<span class="cm">    forget to unmap PCI mapped skbs.</span>

<span class="cm">    Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm">    Added new PCI identifiers provided by Clear Zhang at ALi</span>
<span class="cm">    for their 1563 ethernet device.</span>

<span class="cm">    TODO</span>

<span class="cm">    Check on 64 bit boxes.</span>
<span class="cm">    Check and fix on big endian boxes.</span>

<span class="cm">    Test and make sure PCI latency is now correct for all cases.</span>
<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define DRV_NAME	&quot;dmfe&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.36.4&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;2002-01-17&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#ifdef CONFIG_TULIP_DM910X</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#endif</span>


<span class="cm">/* Board/System/Debug information/definition ---------------- */</span>
<span class="cp">#define PCI_DM9132_ID   0x91321282      </span><span class="cm">/* Davicom DM9132 ID */</span><span class="cp"></span>
<span class="cp">#define PCI_DM9102_ID   0x91021282      </span><span class="cm">/* Davicom DM9102 ID */</span><span class="cp"></span>
<span class="cp">#define PCI_DM9100_ID   0x91001282      </span><span class="cm">/* Davicom DM9100 ID */</span><span class="cp"></span>
<span class="cp">#define PCI_DM9009_ID   0x90091282      </span><span class="cm">/* Davicom DM9009 ID */</span><span class="cp"></span>

<span class="cp">#define DM9102_IO_SIZE  0x80</span>
<span class="cp">#define DM9102A_IO_SIZE 0x100</span>
<span class="cp">#define TX_MAX_SEND_CNT 0x1             </span><span class="cm">/* Maximum tx packet per time */</span><span class="cp"></span>
<span class="cp">#define TX_DESC_CNT     0x10            </span><span class="cm">/* Allocated Tx descriptors */</span><span class="cp"></span>
<span class="cp">#define RX_DESC_CNT     0x20            </span><span class="cm">/* Allocated Rx descriptors */</span><span class="cp"></span>
<span class="cp">#define TX_FREE_DESC_CNT (TX_DESC_CNT - 2)	</span><span class="cm">/* Max TX packet count */</span><span class="cp"></span>
<span class="cp">#define TX_WAKE_DESC_CNT (TX_DESC_CNT - 3)	</span><span class="cm">/* TX wakeup count */</span><span class="cp"></span>
<span class="cp">#define DESC_ALL_CNT    (TX_DESC_CNT + RX_DESC_CNT)</span>
<span class="cp">#define TX_BUF_ALLOC    0x600</span>
<span class="cp">#define RX_ALLOC_SIZE   0x620</span>
<span class="cp">#define DM910X_RESET    1</span>
<span class="cp">#define CR0_DEFAULT     0x00E00000      </span><span class="cm">/* TX &amp; RX burst mode */</span><span class="cp"></span>
<span class="cp">#define CR6_DEFAULT     0x00080000      </span><span class="cm">/* HD */</span><span class="cp"></span>
<span class="cp">#define CR7_DEFAULT     0x180c1</span>
<span class="cp">#define CR15_DEFAULT    0x06            </span><span class="cm">/* TxJabber RxWatchdog */</span><span class="cp"></span>
<span class="cp">#define TDES0_ERR_MASK  0x4302          </span><span class="cm">/* TXJT, LC, EC, FUE */</span><span class="cp"></span>
<span class="cp">#define MAX_PACKET_SIZE 1514</span>
<span class="cp">#define DMFE_MAX_MULTICAST 14</span>
<span class="cp">#define RX_COPY_SIZE	100</span>
<span class="cp">#define MAX_CHECK_PACKET 0x8000</span>
<span class="cp">#define DM9801_NOISE_FLOOR 8</span>
<span class="cp">#define DM9802_NOISE_FLOOR 5</span>

<span class="cp">#define DMFE_WOL_LINKCHANGE	0x20000000</span>
<span class="cp">#define DMFE_WOL_SAMPLEPACKET	0x10000000</span>
<span class="cp">#define DMFE_WOL_MAGICPACKET	0x08000000</span>


<span class="cp">#define DMFE_10MHF      0</span>
<span class="cp">#define DMFE_100MHF     1</span>
<span class="cp">#define DMFE_10MFD      4</span>
<span class="cp">#define DMFE_100MFD     5</span>
<span class="cp">#define DMFE_AUTO       8</span>
<span class="cp">#define DMFE_1M_HPNA    0x10</span>

<span class="cp">#define DMFE_TXTH_72	0x400000	</span><span class="cm">/* TX TH 72 byte */</span><span class="cp"></span>
<span class="cp">#define DMFE_TXTH_96	0x404000	</span><span class="cm">/* TX TH 96 byte */</span><span class="cp"></span>
<span class="cp">#define DMFE_TXTH_128	0x0000		</span><span class="cm">/* TX TH 128 byte */</span><span class="cp"></span>
<span class="cp">#define DMFE_TXTH_256	0x4000		</span><span class="cm">/* TX TH 256 byte */</span><span class="cp"></span>
<span class="cp">#define DMFE_TXTH_512	0x8000		</span><span class="cm">/* TX TH 512 byte */</span><span class="cp"></span>
<span class="cp">#define DMFE_TXTH_1K	0xC000		</span><span class="cm">/* TX TH 1K  byte */</span><span class="cp"></span>

<span class="cp">#define DMFE_TIMER_WUT  (jiffies + HZ * 1)</span><span class="cm">/* timer wakeup time : 1 second */</span><span class="cp"></span>
<span class="cp">#define DMFE_TX_TIMEOUT ((3*HZ)/2)	</span><span class="cm">/* tx packet time-out time 1.5 s&quot; */</span><span class="cp"></span>
<span class="cp">#define DMFE_TX_KICK 	(HZ/2)	</span><span class="cm">/* tx packet Kick-out time 0.5 s&quot; */</span><span class="cp"></span>

<span class="cp">#define dw32(reg, val)	iowrite32(val, ioaddr + (reg))</span>
<span class="cp">#define dw16(reg, val)	iowrite16(val, ioaddr + (reg))</span>
<span class="cp">#define dr32(reg)	ioread32(ioaddr + (reg))</span>
<span class="cp">#define dr16(reg)	ioread16(ioaddr + (reg))</span>
<span class="cp">#define dr8(reg)	ioread8(ioaddr + (reg))</span>

<span class="cp">#define DMFE_DBUG(dbug_now, msg, value)			\</span>
<span class="cp">	do {						\</span>
<span class="cp">		if (dmfe_debug || (dbug_now))		\</span>
<span class="cp">			pr_err(&quot;%s %lx\n&quot;,		\</span>
<span class="cp">			       (msg), (long) (value));	\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define SHOW_MEDIA_TYPE(mode)				\</span>
<span class="cp">	pr_info(&quot;Change Speed to %sMhz %s duplex\n&quot; ,	\</span>
<span class="cp">		(mode &amp; 1) ? &quot;100&quot;:&quot;10&quot;,		\</span>
<span class="cp">		(mode &amp; 4) ? &quot;full&quot;:&quot;half&quot;);</span>


<span class="cm">/* CR9 definition: SROM/MII */</span>
<span class="cp">#define CR9_SROM_READ   0x4800</span>
<span class="cp">#define CR9_SRCS        0x1</span>
<span class="cp">#define CR9_SRCLK       0x2</span>
<span class="cp">#define CR9_CRDOUT      0x8</span>
<span class="cp">#define SROM_DATA_0     0x0</span>
<span class="cp">#define SROM_DATA_1     0x4</span>
<span class="cp">#define PHY_DATA_1      0x20000</span>
<span class="cp">#define PHY_DATA_0      0x00000</span>
<span class="cp">#define MDCLKH          0x10000</span>

<span class="cp">#define PHY_POWER_DOWN	0x800</span>

<span class="cp">#define SROM_V41_CODE   0x14</span>

<span class="cp">#define __CHK_IO_SIZE(pci_id, dev_rev) \</span>
<span class="cp"> (( ((pci_id)==PCI_DM9132_ID) || ((dev_rev) &gt;= 0x30) ) ? \</span>
<span class="cp">	DM9102A_IO_SIZE: DM9102_IO_SIZE)</span>

<span class="cp">#define CHK_IO_SIZE(pci_dev) \</span>
<span class="cp">	(__CHK_IO_SIZE(((pci_dev)-&gt;device &lt;&lt; 16) | (pci_dev)-&gt;vendor, \</span>
<span class="cp">	(pci_dev)-&gt;revision))</span>

<span class="cm">/* Sten Check */</span>
<span class="cp">#define DEVICE net_device</span>

<span class="cm">/* Structure/enum declaration ------------------------------- */</span>
<span class="k">struct</span> <span class="n">tx_desc</span> <span class="p">{</span>
        <span class="n">__le32</span> <span class="n">tdes0</span><span class="p">,</span> <span class="n">tdes1</span><span class="p">,</span> <span class="n">tdes2</span><span class="p">,</span> <span class="n">tdes3</span><span class="p">;</span> <span class="cm">/* Data for the card */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf_ptr</span><span class="p">;</span>               <span class="cm">/* Data for us */</span>
        <span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">next_tx_desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span> <span class="n">aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="p">));</span>

<span class="k">struct</span> <span class="n">rx_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">rdes0</span><span class="p">,</span> <span class="n">rdes1</span><span class="p">,</span> <span class="n">rdes2</span><span class="p">,</span> <span class="n">rdes3</span><span class="p">;</span> <span class="cm">/* Data for the card */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb_ptr</span><span class="p">;</span>	<span class="cm">/* Data for us */</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">next_rx_desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span> <span class="n">aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="p">));</span>

<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">chip_id</span><span class="p">;</span>			<span class="cm">/* Chip vendor/Device ID */</span>
	<span class="n">u8</span> <span class="n">chip_revision</span><span class="p">;</span>		<span class="cm">/* Chip revision */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">next_dev</span><span class="p">;</span>	<span class="cm">/* next device */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>		<span class="cm">/* PCI device */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>		<span class="cm">/* I/O base address */</span>
	<span class="n">u32</span> <span class="n">cr0_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr5_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr6_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr7_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr15_data</span><span class="p">;</span>

	<span class="cm">/* pointer for memory physical address */</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_pool_dma_ptr</span><span class="p">;</span>	<span class="cm">/* Tx buffer pool memory */</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_pool_dma_start</span><span class="p">;</span>	<span class="cm">/* Tx buffer pool align dword */</span>
	<span class="n">dma_addr_t</span> <span class="n">desc_pool_dma_ptr</span><span class="p">;</span>	<span class="cm">/* descriptor pool memory */</span>
	<span class="n">dma_addr_t</span> <span class="n">first_tx_desc_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">first_rx_desc_dma</span><span class="p">;</span>

	<span class="cm">/* descriptor pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf_pool_ptr</span><span class="p">;</span>	<span class="cm">/* Tx buffer pool memory */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf_pool_start</span><span class="p">;</span>	<span class="cm">/* Tx buffer pool align dword */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc_pool_ptr</span><span class="p">;</span>	<span class="cm">/* descriptor pool memory */</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">first_tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">tx_insert_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">tx_remove_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">first_rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx_insert_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx_ready_ptr</span><span class="p">;</span>	<span class="cm">/* packet come pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_packet_cnt</span><span class="p">;</span>	<span class="cm">/* transmitted packet count */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_queue_cnt</span><span class="p">;</span>	<span class="cm">/* wait to send packet count */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_avail_cnt</span><span class="p">;</span>	<span class="cm">/* available rx descriptor count */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval_rx_cnt</span><span class="p">;</span>	<span class="cm">/* rx packet count a callback time */</span>

	<span class="n">u16</span> <span class="n">HPNA_command</span><span class="p">;</span>		<span class="cm">/* For HPNA register 16 */</span>
	<span class="n">u16</span> <span class="n">HPNA_timer</span><span class="p">;</span>			<span class="cm">/* For HPNA remote device check */</span>
	<span class="n">u16</span> <span class="n">dbug_cnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">NIC_capability</span><span class="p">;</span>		<span class="cm">/* NIC media capability */</span>
	<span class="n">u16</span> <span class="n">PHY_reg4</span><span class="p">;</span>			<span class="cm">/* Saved Phyxcer register 4 value */</span>

	<span class="n">u8</span> <span class="n">HPNA_present</span><span class="p">;</span>		<span class="cm">/* 0:none, 1:DM9801, 2:DM9802 */</span>
	<span class="n">u8</span> <span class="n">chip_type</span><span class="p">;</span>			<span class="cm">/* Keep DM9102A chip type */</span>
	<span class="n">u8</span> <span class="n">media_mode</span><span class="p">;</span>			<span class="cm">/* user specify media mode */</span>
	<span class="n">u8</span> <span class="n">op_mode</span><span class="p">;</span>			<span class="cm">/* real work media mode */</span>
	<span class="n">u8</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wait_reset</span><span class="p">;</span>			<span class="cm">/* Hardware failed, need to reset */</span>
	<span class="n">u8</span> <span class="n">dm910x_chk_mode</span><span class="p">;</span>		<span class="cm">/* Operating mode check */</span>
	<span class="n">u8</span> <span class="n">first_in_callback</span><span class="p">;</span>		<span class="cm">/* Flag to record state */</span>
	<span class="n">u8</span> <span class="n">wol_mode</span><span class="p">;</span>			<span class="cm">/* user WOL settings */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>

	<span class="cm">/* Driver defined statistic counter */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_fifo_underrun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_loss_carrier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_no_carrier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_late_collision</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_excessive_collision</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_jabber_timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_cr8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_fatal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_TXtimeout</span><span class="p">;</span>

	<span class="cm">/* NIC SROM data */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">srom</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dmfe_offsets</span> <span class="p">{</span>
	<span class="n">DCR0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">DCR1</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">DCR2</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">DCR3</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">DCR4</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">DCR5</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">DCR6</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">DCR7</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">DCR8</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">DCR9</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="n">DCR10</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">DCR11</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">DCR12</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">DCR13</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">DCR14</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="n">DCR15</span> <span class="o">=</span> <span class="mh">0x78</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dmfe_CR6_bits</span> <span class="p">{</span>
	<span class="n">CR6_RXSC</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">CR6_PBF</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">CR6_PM</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">CR6_PAM</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">CR6_FDM</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">CR6_TXSC</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="n">CR6_STI</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">,</span>
	<span class="n">CR6_SFT</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">CR6_RXA</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="n">CR6_NO_PURGE</span> <span class="o">=</span> <span class="mh">0x20000000</span>
<span class="p">};</span>

<span class="cm">/* Global variable declaration ----------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinitdata</span> <span class="n">printed_version</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span>
	<span class="s">&quot;Davicom DM9xxx net driver, version &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dmfe_debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">DMFE_AUTO</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">dmfe_cr6_user_set</span><span class="p">;</span>

<span class="cm">/* For module input parameter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">cr6set</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">chkmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">HPNA_mode</span><span class="p">;</span>		<span class="cm">/* Default: Low Power/High Speed */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">HPNA_rx_cmd</span><span class="p">;</span>		<span class="cm">/* Default: Disable Rx remote command */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">HPNA_tx_cmd</span><span class="p">;</span>		<span class="cm">/* Default: Don&#39;t issue remote command */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">HPNA_NoiseFloor</span><span class="p">;</span>	<span class="cm">/* Default: HPNA NoiseFloor */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">SF_mode</span><span class="p">;</span>		<span class="cm">/* Special Function: 1:VLAN, 2:RX Flow Control</span>
<span class="cm">				   4: TX pause packet */</span>


<span class="cm">/* function declaration ------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmfe_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">dmfe_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmfe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_set_filter_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">read_srom_word</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">dmfe_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">poll_dmfe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_descriptor_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">allocate_rx_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_cr6</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_filter_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dm9132_id_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">phy_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">phy_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">phy_write_1bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">phy_read_1bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">dmfe_sense_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_process_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="n">cal_CRC</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_rx_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_free_tx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_reuse_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_dynamic_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_free_rxbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_init_dm910x</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_parse_srom</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_program_DM9801</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_program_DM9802</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_HPNA_remote_cmd_chk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dmfe_set_phyxcer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* DM910X network board routine ---------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">dmfe_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">dmfe_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">dmfe_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">dmfe_set_filter_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">poll_dmfe</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Search DM910X board ,allocate space and register it</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dmfe_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>	<span class="cm">/* board information structure */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pci_pmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_init_one()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	SPARC on-board DM910x chips should be handled by the main</span>
<span class="cm">	 *	tulip driver, except for early DM9100s.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_TULIP_DM910X</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">PCI_DM9100_ID</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">PCI_DM9102_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;skipping on-board DM910x (use tulip)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Init network device */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">db</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;32-bit PCI DMA not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Master/IO access, Disable memory access */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I/O base is zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">CHK_IO_SIZE</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocated I/O size too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c">	/* pci_{enable_device,set_master} sets minimum latency for us now */</span>

<span class="c">	/* Set Latency Timer 80h */</span>
<span class="c">	/* FIXME: setting values &gt; 32 breaks some SiS 559x stuff.</span>
<span class="c">	   Need a PCI quirk.. */</span>

<span class="c">	pci_write_config_byte(pdev, PCI_LATENCY_TIMER, 0x80);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to request PCI regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init system &amp; device */</span>
	<span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Allocate Tx/Rx descriptor memory */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_ptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">DESC_ALL_CNT</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_dma_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_ptr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_res</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_ptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_BUF_ALLOC</span> <span class="o">*</span>
			<span class="n">TX_DESC_CNT</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_dma_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_ptr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_desc</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_ptr</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc_dma</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_dma_ptr</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_start</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_ptr</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_dma_start</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_dma_ptr</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="cm">/* IO type range. */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_buf</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">wol_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_pmr</span><span class="p">);</span>
	<span class="n">pci_pmr</span> <span class="o">&amp;=</span> <span class="mh">0x70000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pci_pmr</span> <span class="o">==</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">==</span> <span class="mh">0x31</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* DM9102A E3 */</span>
	<span class="k">else</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read 64 word srom data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">read_srom_word</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Set Node address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">[</span><span class="mi">20</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unmap</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Davicom DM%04lx at pci%s, %pM, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">err_out_free_buf:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_BUF_ALLOC</span> <span class="o">*</span> <span class="n">TX_DESC_CNT</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_ptr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_dma_ptr</span><span class="p">);</span>
<span class="nl">err_out_free_desc:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">DESC_ALL_CNT</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span>
			    <span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_ptr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_dma_ptr</span><span class="p">);</span>
<span class="nl">err_out_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_free:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">dmfe_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_remove_one()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">DESC_ALL_CNT</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_ptr</span><span class="p">,</span>
 					<span class="n">db</span><span class="o">-&gt;</span><span class="n">desc_pool_dma_ptr</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_BUF_ALLOC</span> <span class="o">*</span> <span class="n">TX_DESC_CNT</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_ptr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_dma_ptr</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* free board information */</span>

		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_remove_one() exit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Open the interface.</span>
<span class="cm"> *	The interface is opened whenever &quot;ifconfig&quot; actives it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmfe_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_open&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dmfe_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* system variable init */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">=</span> <span class="n">CR6_DEFAULT</span> <span class="o">|</span> <span class="n">dmfe_cr6_user_set</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">wait_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_in_callback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">NIC_capability</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>	<span class="cm">/* All capability*/</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span> <span class="o">=</span> <span class="mh">0x1e0</span><span class="p">;</span>

	<span class="cm">/* CR6 operation mode decision */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">chkmode</span> <span class="o">||</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="n">DMFE_TXTH_256</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr0_data</span> <span class="o">=</span> <span class="n">CR0_DEFAULT</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>		<span class="cm">/* Enter the normal mode */</span>
 	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="n">CR6_SFT</span><span class="p">;</span>	<span class="cm">/* Store &amp; Forward mode */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr0_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Enter the check mode */</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize DM910X board */</span>
	<span class="n">dmfe_init_dm910x</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Active System Interface */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* set and active a timer process */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">DMFE_TIMER_WUT</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">dmfe_timer</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*	Initialize DM910X board</span>
<span class="cm"> *	Reset DM910X board</span>
<span class="cm"> *	Initialize TX/Rx descriptor chain structure</span>
<span class="cm"> *	Send the set-up frame</span>
<span class="cm"> *	Enable Tx/Rx machine</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_init_dm910x</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_init_dm910x()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset DM910x MAC controller */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR0</span><span class="p">,</span> <span class="n">DM910X_RESET</span><span class="p">);</span>	<span class="cm">/* RESET MAC */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR0</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr0_data</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Phy addr : DM910(A)2/DM9132/9801, phy address = 1 */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Parser SROM and media mode */</span>
	<span class="n">dmfe_parse_srom</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">=</span> <span class="n">dmfe_media_mode</span><span class="p">;</span>

	<span class="cm">/* RESET Phyxcer Chip by GPR port bit 7 */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR12</span><span class="p">,</span> <span class="mh">0x180</span><span class="p">);</span>		<span class="cm">/* Let bit 7 output port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9009_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR12</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* Issue RESET signal */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>			<span class="cm">/* Delay 300 ms */</span>
	<span class="p">}</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR12</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>	<span class="cm">/* Clear RESET signal */</span>

	<span class="cm">/* Process Phyxcer Media Mode */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">)</span>	<span class="cm">/* Force 1M mode */</span>
		<span class="n">dmfe_set_phyxcer</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="cm">/* Media Mode Process */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="n">DMFE_AUTO</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span><span class="p">;</span> 	<span class="cm">/* Force Mode */</span>

	<span class="cm">/* Initialize Transmit/Receive decriptor and CR3/4 */</span>
	<span class="n">dmfe_descriptor_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Init CR6 to program DM910x operation */</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Send setup frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span>
		<span class="n">dm9132_id_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* DM9132 */</span>
	<span class="k">else</span>
		<span class="n">send_filter_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* DM9102/DM9102A */</span>

	<span class="cm">/* Init CR7, interrupt active bit */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr7_data</span> <span class="o">=</span> <span class="n">CR7_DEFAULT</span><span class="p">;</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr7_data</span><span class="p">);</span>

	<span class="cm">/* Init CR15, Tx jabber and Rx watchdog timer */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR15</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr15_data</span><span class="p">);</span>

	<span class="cm">/* Enable DM910X Tx/Rx function */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="n">CR6_RXSC</span> <span class="o">|</span> <span class="n">CR6_TXSC</span> <span class="o">|</span> <span class="mh">0x40000</span><span class="p">;</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Hardware start transmission.</span>
<span class="cm"> *	Send a packet to media from the upper layer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">dmfe_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">txptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_start_xmit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Too large packet check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_PACKET_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;big packet = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Resource flag check */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* No Tx resource check, it never happen nromally */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span> <span class="o">&gt;=</span> <span class="n">TX_FREE_DESC_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No Tx resource %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable NIC interrupt */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* transmit this packet */</span>
	<span class="n">txptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_insert_ptr</span><span class="p">;</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xe1000000</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Point to next transmit free descriptor */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_insert_ptr</span> <span class="o">=</span> <span class="n">txptr</span><span class="o">-&gt;</span><span class="n">next_tx_desc</span><span class="p">;</span>

	<span class="cm">/* Transmit Packet Process */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span> <span class="o">&lt;</span> <span class="n">TX_MAX_SEND_CNT</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">);</span>	<span class="cm">/* Set owner bit */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* Ready to send */</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>			<span class="cm">/* Issue Tx polling */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>		<span class="cm">/* saved time stamp */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* queue TX packet */</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>			<span class="cm">/* Issue Tx polling */</span>
	<span class="p">}</span>

	<span class="cm">/* Tx resource check */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span> <span class="o">&lt;</span> <span class="n">TX_FREE_DESC_CNT</span> <span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Restore CR7 to enable interrupt */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr7_data</span><span class="p">);</span>

	<span class="cm">/* free this SKB */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Stop the interface.</span>
<span class="cm"> *	The interface is stopped when it is brought.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmfe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_stop&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* disable system */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* deleted timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Reset &amp; stop DM910X board */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR0</span><span class="p">,</span> <span class="n">DM910X_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

	<span class="cm">/* free interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* free allocated rx buffer */</span>
	<span class="n">dmfe_free_rxbuffer</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* show statistic counter */</span>
<span class="c">	printk(&quot;FU:%lx EC:%lx LC:%lx NC:%lx LOC:%lx TXJT:%lx RESET:%lx RCR8:%lx FAL:%lx TT:%lx\n&quot;,</span>
<span class="c">	       db-&gt;tx_fifo_underrun, db-&gt;tx_excessive_collision,</span>
<span class="c">	       db-&gt;tx_late_collision, db-&gt;tx_no_carrier, db-&gt;tx_loss_carrier,</span>
<span class="c">	       db-&gt;tx_jabber_timeout, db-&gt;reset_count, db-&gt;reset_cr8,</span>
<span class="c">	       db-&gt;reset_fatal, db-&gt;reset_TXtimeout);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	DM9102 insterrupt handler</span>
<span class="cm"> *	receive the packet to upper layer, free the transmitted packet</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dmfe_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_interrupt()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Got DM910X status */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span> <span class="o">=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">DCR5</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR5</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span> <span class="o">&amp;</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable all interrupt in CR7 to solve the interrupt edge problem */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Check system status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* system bus error happen */</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;System bus error happen. CR5=&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">reset_fatal</span><span class="o">++</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">wait_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Need to RESET */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	 <span class="cm">/* Received the coming packet */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span> <span class="p">)</span>
		<span class="n">dmfe_rx_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="cm">/* reallocate rx descriptor buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="o">&lt;</span><span class="n">RX_DESC_CNT</span><span class="p">)</span>
		<span class="n">allocate_rx_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free the transmitted descriptor */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr5_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">dmfe_free_tx_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="cm">/* Mode Check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Restore CR7 to enable interrupt mask */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr7_data</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling &#39;interrupt&#39; - used by things like netconsole to send skbs</span>
<span class="cm"> * without having to re-enable interrupts. It&#39;s not called while</span>
<span class="cm"> * the interrupt routine is executing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">poll_dmfe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* disable_irq here is not very nice, but with the lockless</span>
<span class="cm">	   interrupt handler we have no other choice. */</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dmfe_interrupt</span> <span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Free TX resource after TX complete</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_free_tx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">txptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tdes0</span><span class="p">;</span>

	<span class="n">txptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_remove_ptr</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tdes0</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* A packet sent completed */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Transmit statistic counter */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">tdes0</span> <span class="o">!=</span> <span class="mh">0x7fffffff</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="n">TDES0_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* UnderRun */</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_fifo_underrun</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;</span> <span class="n">CR6_SFT</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
						<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|</span> <span class="n">CR6_SFT</span><span class="p">;</span>
						<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_excessive_collision</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_late_collision</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_no_carrier</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_loss_carrier</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tdes0</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_jabber_timeout</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

    		<span class="n">txptr</span> <span class="o">=</span> <span class="n">txptr</span><span class="o">-&gt;</span><span class="n">next_tx_desc</span><span class="p">;</span>
	<span class="p">}</span><span class="cm">/* End of while */</span>

	<span class="cm">/* Update TX remove pointer to next */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_remove_ptr</span> <span class="o">=</span> <span class="n">txptr</span><span class="p">;</span>

	<span class="cm">/* Send the Tx packet in queue */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span> <span class="o">&lt;</span> <span class="n">TX_MAX_SEND_CNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">);</span>	<span class="cm">/* Set owner bit */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* Ready to send */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>			<span class="cm">/* Issue Tx polling */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>		<span class="cm">/* saved time stamp */</span>
	<span class="p">}</span>

	<span class="cm">/* Resource available check */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span> <span class="o">&lt;</span> <span class="n">TX_WAKE_DESC_CNT</span> <span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* Active upper layer, send again */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Calculate the CRC valude of the Rx packet</span>
<span class="cm"> *	flag = 	1 : return the reverse CRC (for the received packet CRC)</span>
<span class="cm"> *		0 : return the normal CRC (for Hash Table index)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">cal_CRC</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">Data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">Len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="n">crc</span> <span class="o">=</span> <span class="o">~</span><span class="n">crc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Receive the come packet and pass to upper layer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_rx_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rxptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">newskb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rdes0</span><span class="p">;</span>

	<span class="n">rxptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_ready_ptr</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdes0</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>	<span class="cm">/* packet owner check */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">interval_rx_cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes2</span><span class="p">),</span>
				 <span class="n">RX_ALLOC_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x300</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* A packet without First/Last flag */</span>
			<span class="cm">/* reuse this SKB */</span>
			<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Reuse SK buffer, rdes0&quot;</span><span class="p">,</span> <span class="n">rdes0</span><span class="p">);</span>
			<span class="n">dmfe_reuse_skb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* A packet with First/Last flag */</span>
			<span class="n">rxlen</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

			<span class="cm">/* error summary bit check */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* This is a error packet */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;</span> <span class="n">CR6_PM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxlen</span><span class="o">&gt;</span><span class="mi">6</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">;</span>

				<span class="cm">/* Received Packet CRC check need or not */</span>
				<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">cal_CRC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">rxlen</span><span class="p">)</span> <span class="p">)))</span> <span class="p">{</span> <span class="cm">/* FIXME (?) */</span>
					<span class="cm">/* Found a error received packet */</span>
					<span class="n">dmfe_reuse_skb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">);</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Good packet, send to upper layer */</span>
					<span class="cm">/* Shorst packet used new SKB */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rxlen</span> <span class="o">&lt;</span> <span class="n">RX_COPY_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">((</span><span class="n">newskb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rxlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
						<span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>

						<span class="n">skb</span> <span class="o">=</span> <span class="n">newskb</span><span class="p">;</span>
						<span class="cm">/* size less than COPY_SIZE, allocate a rxlen SKB */</span>
						<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* 16byte align */</span>
						<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">,</span>
							  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">),</span>
									  <span class="n">rxlen</span><span class="p">);</span>
						<span class="n">dmfe_reuse_skb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">);</span>

					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
					<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rxlen</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Reuse SKB buffer when the packet is error */</span>
				<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Reuse SK buffer, rdes0&quot;</span><span class="p">,</span> <span class="n">rdes0</span><span class="p">);</span>
				<span class="n">dmfe_reuse_skb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rxptr</span> <span class="o">=</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_ready_ptr</span> <span class="o">=</span> <span class="n">rxptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set DM910X multicast address</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_set_filter_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">DEVICE</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_set_filter_mode()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Enable PROM Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="n">CR6_PM</span> <span class="o">|</span> <span class="n">CR6_PBF</span><span class="p">;</span>
		<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span> <span class="n">mc_count</span> <span class="o">&gt;</span> <span class="n">DMFE_MAX_MULTICAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Pass all multicast address&quot;</span><span class="p">,</span> <span class="n">mc_count</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CR6_PM</span> <span class="o">|</span> <span class="n">CR6_PBF</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="n">CR6_PAM</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Set multicast address&quot;</span><span class="p">,</span> <span class="n">mc_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span>
		<span class="n">dm9132_id_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* DM9132 */</span>
	<span class="k">else</span>
		<span class="n">send_filter_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* DM9102/DM9102A */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 	Ethtool interace</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_ethtool_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmfe_ethtool_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKE_UCAST</span> <span class="o">|</span> <span class="n">WAKE_MCAST</span> <span class="o">|</span> <span class="n">WAKE_BCAST</span> <span class="o">|</span>
		   		<span class="n">WAKE_ARP</span> <span class="o">|</span> <span class="n">WAKE_MAGICSECURE</span><span class="p">))</span>
		   <span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">wol_mode</span> <span class="o">=</span> <span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_ethtool_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">wol_mode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">dmfe_ethtool_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>               <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">dmfe_ethtool_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">dmfe_ethtool_get_wol</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	A periodic timer routine</span>
<span class="cm"> *	Dynamic media sense, allocate Rx buffer...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_cr8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp_cr12</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">link_ok</span><span class="p">,</span> <span class="n">link_ok_phy</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_timer()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Media mode process when Link OK before enter this route */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">first_in_callback</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_in_callback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="o">==</span><span class="n">PCI_DM9102_ID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000</span><span class="p">;</span>
			<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">phy_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="mh">0x40000</span><span class="p">;</span>
			<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">DMFE_TIMER_WUT</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* Operating Mode Check */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">&gt;</span> <span class="n">MAX_CHECK_PACKET</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dm910x_chk_mode</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>

	<span class="cm">/* Dynamic reset DM910X : system error or transmit time-out */</span>
	<span class="n">tmp_cr8</span> <span class="o">=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">DCR8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">interval_rx_cnt</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp_cr8</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">reset_cr8</span><span class="o">++</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">wait_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">interval_rx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* TX polling kick monitor */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span> <span class="o">&amp;&amp;</span>
	     <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">DMFE_TX_KICK</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>   <span class="cm">/* Tx polling again */</span>

		<span class="cm">/* TX Timeout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">DMFE_TX_TIMEOUT</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">reset_TXtimeout</span><span class="o">++</span><span class="p">;</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">wait_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx timeout - resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">wait_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Dynamic Reset device&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dmfe_dynamic_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_in_callback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">DMFE_TIMER_WUT</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Link status check, Dynamic media type change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span>
		<span class="n">tmp_cr12</span> <span class="o">=</span> <span class="n">dr8</span><span class="p">(</span><span class="n">DCR9</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* DM9132 */</span>
	<span class="k">else</span>
		<span class="n">tmp_cr12</span> <span class="o">=</span> <span class="n">dr8</span><span class="p">(</span><span class="n">DCR12</span><span class="p">);</span>		<span class="cm">/* DM9102/DM9102A */</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9102_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DM9102A Chip */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_cr12</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">link_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">link_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="cm">/*0x43 is used instead of 0x3 because bit 6 should represent</span>
<span class="cm">			link status of external PHY */</span>
		<span class="n">link_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_cr12</span> <span class="o">&amp;</span> <span class="mh">0x43</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* If chip reports that link is failed it could be because external</span>
<span class="cm">		PHY link status pin is not connected correctly to chip</span>
<span class="cm">		To be sure ask PHY too.</span>
<span class="cm">	*/</span>

	<span class="cm">/* need a dummy read because of PHY&#39;s register latch*/</span>
	<span class="n">phy_read</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">link_ok_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_read</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
		       <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok_phy</span> <span class="o">!=</span> <span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMFE_DBUG</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PHY and chip report different link status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_ok</span> <span class="o">=</span> <span class="n">link_ok</span> <span class="o">|</span> <span class="n">link_ok_phy</span><span class="p">;</span>
 	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">link_ok</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Link Failed */</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Link Failed&quot;</span><span class="p">,</span> <span class="n">tmp_cr12</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* For Force 10/100M Half/Full mode: Enable Auto-Nego mode */</span>
		<span class="cm">/* AUTO or force 1M Homerun/Longrun don&#39;t need */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

		<span class="cm">/* AUTO mode, if INT phyxcer link failed, select EXT device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="n">DMFE_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 10/100M link failed, used 1M Home-Net */</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="o">|=</span><span class="mh">0x00040000</span><span class="p">;</span>	<span class="cm">/* bit18=1, MII */</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="o">&amp;=~</span><span class="mh">0x00000200</span><span class="p">;</span>	<span class="cm">/* bit9=0, HD mode */</span>
			<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Link link OK&quot;</span><span class="p">,</span> <span class="n">tmp_cr12</span><span class="p">);</span>

		<span class="cm">/* Auto Sense Speed */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="n">DMFE_AUTO</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">dmfe_sense_speed</span><span class="p">(</span><span class="n">db</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">SHOW_MEDIA_TYPE</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dmfe_process_mode</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* HPNA remote command check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_timer</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_timer</span><span class="p">)</span>
			<span class="n">dmfe_HPNA_remote_cmd_chk</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Timer active again */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">DMFE_TIMER_WUT</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Dynamic reset the DM910X board</span>
<span class="cm"> *	Stop DM910X board</span>
<span class="cm"> *	Free Tx/Rx allocated memory</span>
<span class="cm"> *	Reset DM910X board</span>
<span class="cm"> *	Re-initialize DM910X board</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_dynamic_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_dynamic_reset()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Sopt MAC controller */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CR6_RXSC</span> <span class="o">|</span> <span class="n">CR6_TXSC</span><span class="p">);</span>	<span class="cm">/* Disable Tx/Rx */</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>				<span class="cm">/* Disable Interrupt */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR5</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">DCR5</span><span class="p">));</span>

	<span class="cm">/* Disable upper layer interface */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free Rx Allocate buffer */</span>
	<span class="n">dmfe_free_rxbuffer</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="cm">/* system variable init */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">wait_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Re-initialize DM910X board */</span>
	<span class="n">dmfe_init_dm910x</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Restart upper layer interface */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	free all allocated rx buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_free_rxbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_free_rxbuffer()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* free allocated rx buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_ready_ptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_ready_ptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_ready_ptr</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Reuse the SK buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_reuse_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rxptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_insert_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes0</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">RX_ALLOC_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span> <span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_insert_ptr</span> <span class="o">=</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SK Buffer reuse method error&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Initialize transmit/Receive descriptor</span>
<span class="cm"> *	Using Chain structure, and allocate Tx/Rx buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_descriptor_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">tmp_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">tmp_rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp_buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tmp_tx_dma</span><span class="p">,</span> <span class="n">tmp_rx_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tmp_buf_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_descriptor_init()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* tx descriptor start pointer */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_insert_ptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_remove_ptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span><span class="p">;</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR4</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc_dma</span><span class="p">);</span>     <span class="cm">/* TX DESC address */</span>

	<span class="cm">/* rx descriptor start pointer */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_DESC_CNT</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc_dma</span> <span class="o">=</span>  <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc_dma</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_DESC_CNT</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_insert_ptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_ready_ptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc</span><span class="p">;</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR3</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc_dma</span><span class="p">);</span>		<span class="cm">/* RX DESC address */</span>

	<span class="cm">/* Init Transmit chain */</span>
	<span class="n">tmp_buf</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_start</span><span class="p">;</span>
	<span class="n">tmp_buf_dma</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">buf_pool_dma_start</span><span class="p">;</span>
	<span class="n">tmp_tx_dma</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc_dma</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp_tx</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_DESC_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tmp_tx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr</span> <span class="o">=</span> <span class="n">tmp_buf</span><span class="p">;</span>
		<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">tdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">tdes1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x81000000</span><span class="p">);</span>	<span class="cm">/* IC, chain */</span>
		<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">tdes2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp_buf_dma</span><span class="p">);</span>
		<span class="n">tmp_tx_dma</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">);</span>
		<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">tdes3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp_tx_dma</span><span class="p">);</span>
		<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">next_tx_desc</span> <span class="o">=</span> <span class="n">tmp_tx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tmp_buf</span> <span class="o">=</span> <span class="n">tmp_buf</span> <span class="o">+</span> <span class="n">TX_BUF_ALLOC</span><span class="p">;</span>
		<span class="n">tmp_buf_dma</span> <span class="o">=</span> <span class="n">tmp_buf_dma</span> <span class="o">+</span> <span class="n">TX_BUF_ALLOC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">--</span><span class="n">tmp_tx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tdes3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc_dma</span><span class="p">);</span>
	<span class="n">tmp_tx</span><span class="o">-&gt;</span><span class="n">next_tx_desc</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span><span class="p">;</span>

	 <span class="cm">/* Init Receive descriptor chain */</span>
	<span class="n">tmp_rx_dma</span><span class="o">=</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc_dma</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp_rx</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_DESC_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tmp_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_rx</span><span class="o">-&gt;</span><span class="n">rdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">tmp_rx</span><span class="o">-&gt;</span><span class="n">rdes1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x01000600</span><span class="p">);</span>
		<span class="n">tmp_rx_dma</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>
		<span class="n">tmp_rx</span><span class="o">-&gt;</span><span class="n">rdes3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp_rx_dma</span><span class="p">);</span>
		<span class="n">tmp_rx</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span> <span class="o">=</span> <span class="n">tmp_rx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">--</span><span class="n">tmp_rx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rdes3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc_dma</span><span class="p">);</span>
	<span class="n">tmp_rx</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">first_rx_desc</span><span class="p">;</span>

	<span class="cm">/* pre-allocate Rx buffer */</span>
	<span class="n">allocate_rx_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Update CR6 value</span>
<span class="cm"> *	Firstly stop DM910X , then written value and start</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_cr6</span><span class="p">(</span><span class="n">u32</span> <span class="n">cr6_data</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cr6_tmp</span><span class="p">;</span>

	<span class="n">cr6_tmp</span> <span class="o">=</span> <span class="n">cr6_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2002</span><span class="p">;</span>           <span class="cm">/* stop Tx/Rx */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR6</span><span class="p">,</span> <span class="n">cr6_tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR6</span><span class="p">,</span> <span class="n">cr6_data</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Send a setup frame for DM9132</span>
<span class="cm"> *	This setup frame initialize DM910X address filter mode</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9132_id_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">addrptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Node address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addrptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ioaddr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear Hash Table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hash_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hash_table</span><span class="p">));</span>

	<span class="cm">/* broadcast address */</span>
	<span class="n">hash_table</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="cm">/* the multicast address in Hash Table : 64 bits */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hash_val</span> <span class="o">=</span> <span class="n">cal_CRC</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">hash_table</span><span class="p">[</span><span class="n">hash_val</span> <span class="o">/</span> <span class="mi">16</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hash_val</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Write the hash table to MAC MD table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dw16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Send a setup frame for DM9102/DM9102A</span>
<span class="cm"> *	This setup frame initialize DM910X address filter mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_filter_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">txptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span> <span class="n">addrptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span> <span class="n">suptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;send_filter_frame()&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">txptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_insert_ptr</span><span class="p">;</span>
	<span class="n">suptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr</span><span class="p">;</span>

	<span class="cm">/* Node address */</span>
	<span class="n">addrptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addrptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addrptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addrptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* broadcast address */</span>
	<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* fit the multicast address */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addrptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addrptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addrptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addrptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">suptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare the setup frame */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_insert_ptr</span> <span class="o">=</span> <span class="n">txptr</span><span class="o">-&gt;</span><span class="n">next_tx_desc</span><span class="p">;</span>
	<span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x890000c0</span><span class="p">);</span>

	<span class="cm">/* Resource Check and Send the setup packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

		<span class="cm">/* Resource Empty */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_packet_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">txptr</span><span class="o">-&gt;</span><span class="n">tdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>	<span class="cm">/* Issue Tx polling */</span>
		<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_queue_cnt</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Put in TX queue */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Allocate rx buffer,</span>
<span class="cm"> *	As possible as allocate maxiumn Rx buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">allocate_rx_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rxptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">rxptr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_insert_ptr</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span> <span class="o">&lt;</span> <span class="n">RX_DESC_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_ALLOC_SIZE</span><span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rx_skb_ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span> <span class="cm">/* FIXME (?) */</span>
		<span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				    <span class="n">RX_ALLOC_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span> <span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">rdes0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">rxptr</span> <span class="o">=</span> <span class="n">rxptr</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_avail_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">rx_insert_ptr</span> <span class="o">=</span> <span class="n">rxptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srom_clk_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span><span class="p">,</span>
		<span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span> <span class="o">|</span> <span class="n">CR9_SRCLK</span><span class="p">,</span>
		<span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Read one word data from the serial ROM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">read_srom_word</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">srom_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">CR9_SROM_READ</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Send the Read Command 110b */</span>
	<span class="n">srom_clk_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SROM_DATA_1</span><span class="p">);</span>
	<span class="n">srom_clk_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SROM_DATA_1</span><span class="p">);</span>
	<span class="n">srom_clk_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SROM_DATA_0</span><span class="p">);</span>

	<span class="cm">/* Send the offset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srom_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">SROM_DATA_1</span> <span class="o">:</span> <span class="n">SROM_DATA_0</span><span class="p">;</span>
		<span class="n">srom_clk_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">srom_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span> <span class="o">|</span> <span class="n">CR9_SRCLK</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">srom_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">srom_data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">dr32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR9_CRDOUT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">CR9_SROM_READ</span> <span class="o">|</span> <span class="n">CR9_SRCS</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">CR9_SROM_READ</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">srom_data</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Auto sense the media mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">dmfe_sense_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ErrFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_mode</span><span class="p">;</span>

	<span class="cm">/* CR6 bit18=0, select 10/100M */</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40000</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">phy_mode</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">phy_mode</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x24</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span>	<span class="cm">/* DM9132 */</span>
			<span class="n">phy_mode</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
				    <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="k">else</span> 				<span class="cm">/* DM9102/DM9102A */</span>
			<span class="n">phy_mode</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
				    <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1000</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">DMFE_10MHF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2000</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">DMFE_10MFD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4000</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">DMFE_100MHF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8000</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">DMFE_100MFD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">DMFE_10MHF</span><span class="p">;</span>
			<span class="n">ErrFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">DMFE_10MHF</span><span class="p">;</span>
		<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Link Failed :&quot;</span><span class="p">,</span> <span class="n">phy_mode</span><span class="p">);</span>
		<span class="n">ErrFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ErrFlag</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Set 10/100 phyxcer capability</span>
<span class="cm"> *	AUTO mode : phyxcer register4 is NIC capability</span>
<span class="cm"> *	Force mode: phyxcer register4 is the force media</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_set_phyxcer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="cm">/* Select 10/100M phyxcer */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000</span><span class="p">;</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* DM9009 Chip: Phyxcer reg18 bit12=0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9009_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_reg</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
				   <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>

		<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
			  <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Phyxcer capability setting */</span>
	<span class="n">phy_reg</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01e0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="n">DMFE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AUTO Mode */</span>
		<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Force Mode */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMFE_10MHF</span>: <span class="n">phy_reg</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMFE_10MFD</span>: <span class="n">phy_reg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMFE_100MHF</span>: <span class="n">phy_reg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMFE_100MFD</span>: <span class="n">phy_reg</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9009_ID</span><span class="p">)</span> <span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="mh">0x61</span><span class="p">;</span>
	<span class="p">}</span>

  	<span class="cm">/* Write new capability to Phyxcer Reg4 */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">phy_reg</span> <span class="o">&amp;</span> <span class="mh">0x01e0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy_reg</span><span class="o">|=</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span><span class="o">|=</span><span class="n">DMFE_AUTO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

 	<span class="cm">/* Restart Auto-Negotiation */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9102_ID</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="p">)</span>
		<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Process op-mode</span>
<span class="cm"> *	AUTO mode : PHY controller in Auto-negotiation Mode</span>
<span class="cm"> *	Force mode: PHY controller in force mode with HUB</span>
<span class="cm"> *			N-way force capability with SWITCH</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_process_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="cm">/* Full Duplex Mode Check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="n">CR6_FDM</span><span class="p">;</span>	<span class="cm">/* Set Full Duplex Bit */</span>
	<span class="k">else</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CR6_FDM</span><span class="p">;</span>	<span class="cm">/* Clear Full Duplex Bit */</span>

	<span class="cm">/* Transciver Selection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>		<span class="cm">/* 1M HomePNA */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|=</span> <span class="mh">0x40000</span><span class="p">;</span><span class="cm">/* External MII select */</span>
	<span class="k">else</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000</span><span class="p">;</span><span class="cm">/* Internal 10/100 transciver */</span>

	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* 10/100M phyxcer force mode need */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">media_mode</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Forece Mode */</span>
		<span class="n">phy_reg</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">phy_reg</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* parter without N-Way capability */</span>
			<span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">op_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DMFE_10MHF</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DMFE_10MFD</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DMFE_100MHF</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DMFE_100MFD</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x2100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
				  <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
       			<span class="k">if</span> <span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9102_ID</span><span class="p">)</span> <span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
				  <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Write a word to Phy register</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phy_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">phy_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw16</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DM9102/DM9102A Chip */</span>

		<span class="cm">/* Send 33 synchronization clock to Phy controller */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>

		<span class="cm">/* Send start command(01) to Phy */</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>

		<span class="cm">/* Send write command(01) to Phy */</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>

		<span class="cm">/* Send Phy address */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span>
				       <span class="n">phy_addr</span> <span class="o">&amp;</span> <span class="n">i</span> <span class="o">?</span> <span class="n">PHY_DATA_1</span> <span class="o">:</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>

		<span class="cm">/* Send register address */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span>
				       <span class="n">offset</span> <span class="o">&amp;</span> <span class="n">i</span> <span class="o">?</span> <span class="n">PHY_DATA_1</span> <span class="o">:</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>

		<span class="cm">/* written trasnition */</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>

		<span class="cm">/* Write a word data to PHY controller */</span>
		<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span>
				       <span class="n">phy_data</span> <span class="o">&amp;</span> <span class="n">i</span> <span class="o">?</span> <span class="n">PHY_DATA_1</span> <span class="o">:</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Read a word data from phy register</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">phy_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">PCI_DM9132_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DM9132 Chip */</span>
		<span class="n">phy_data</span> <span class="o">=</span> <span class="n">dr16</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DM9102/DM9102A Chip */</span>

		<span class="cm">/* Send 33 synchronization clock to Phy controller */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>

		<span class="cm">/* Send start command(01) to Phy */</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>

		<span class="cm">/* Send read command(10) to Phy */</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_1</span><span class="p">);</span>
		<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>

		<span class="cm">/* Send Phy address */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span>
				       <span class="n">phy_addr</span> <span class="o">&amp;</span> <span class="n">i</span> <span class="o">?</span> <span class="n">PHY_DATA_1</span> <span class="o">:</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>

		<span class="cm">/* Send register address */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">phy_write_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span>
				       <span class="n">offset</span> <span class="o">&amp;</span> <span class="n">i</span> <span class="o">?</span> <span class="n">PHY_DATA_1</span> <span class="o">:</span> <span class="n">PHY_DATA_0</span><span class="p">);</span>

		<span class="cm">/* Skip transition state */</span>
		<span class="n">phy_read_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

		<span class="cm">/* read 16bit data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">phy_data</span> <span class="o">|=</span> <span class="n">phy_read_1bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">phy_data</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Write one bit data to Phy Controller</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phy_write_1bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>		<span class="cm">/* MII Clock Low */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">phy_data</span> <span class="o">|</span> <span class="n">MDCLKH</span><span class="p">);</span>	<span class="cm">/* MII Clock High */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>		<span class="cm">/* MII Clock Low */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Read one bit phy data from PHY controller</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">phy_read_1bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="mh">0x50000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR9</span><span class="p">,</span> <span class="mh">0x40000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">phy_data</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Parser SROM and media mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_parse_srom</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">srom</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dmfe_mode</span><span class="p">,</span> <span class="n">tmp_reg</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_parse_srom() &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Init CR15 */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr15_data</span> <span class="o">=</span> <span class="n">CR15_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* Check SROM Version */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">srom</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">SROM_V41_CODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SROM V4.01 */</span>
		<span class="cm">/* Get NIC support media mode */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">NIC_capability</span> <span class="o">=</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">34</span><span class="p">));</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tmp_reg</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">tmp_reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">NIC_capability</span> <span class="o">&amp;</span> <span class="n">tmp_reg</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x1</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span> <span class="o">|=</span> <span class="mh">0x0040</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x4</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span> <span class="o">|=</span> <span class="mh">0x0080</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x8</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">PHY_reg4</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Media Mode Force or not check */</span>
		<span class="n">dmfe_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpup</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">34</span><span class="p">))</span> <span class="o">&amp;</span>
			     <span class="n">le32_to_cpup</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">36</span><span class="p">)));</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">dmfe_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x4</span>: <span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">DMFE_100MHF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* 100MHF */</span>
		<span class="k">case</span> <span class="mh">0x2</span>: <span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">DMFE_10MFD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* 10MFD */</span>
		<span class="k">case</span> <span class="mh">0x8</span>: <span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">DMFE_100MFD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* 100MFD */</span>
		<span class="k">case</span> <span class="mh">0x100</span>:
		<span class="k">case</span> <span class="mh">0x200</span>: <span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">DMFE_1M_HPNA</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span><span class="cm">/* HomePNA */</span>
		<span class="p">}</span>

		<span class="cm">/* Special Function setting */</span>
		<span class="cm">/* VLAN function */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">SF_mode</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srom</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr15_data</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="cm">/* Flow Control */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">SF_mode</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srom</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr15_data</span> <span class="o">|=</span> <span class="mh">0x400</span><span class="p">;</span>

		<span class="cm">/* TX pause packet */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">SF_mode</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srom</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr15_data</span> <span class="o">|=</span> <span class="mh">0x9800</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parse HPNA parameter */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Accept remote command or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HPNA_rx_cmd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	 <span class="cm">/* Issue remote command &amp; operation mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HPNA_tx_cmd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">HPNA_mode</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Issue Remote Command */</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0904</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0a00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0506</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0602</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">HPNA_mode</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Don&#39;t Issue */</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0006</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x0002</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* Check DM9801 or DM9802 present or not */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">|</span> <span class="mh">0x40000</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">tmp_reg</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span> <span class="p">)</span> <span class="o">==</span> <span class="mh">0xb900</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DM9801 or DM9802 present */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_timer</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4404</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DM9801 HomeRun */</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dmfe_program_DM9801</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tmp_reg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DM9802 LongRun */</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_present</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">dmfe_program_DM9802</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Init HomeRun DM9801</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_program_DM9801</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">HPNA_rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">reg17</span><span class="p">,</span> <span class="n">reg25</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">HPNA_NoiseFloor</span> <span class="p">)</span> <span class="n">HPNA_NoiseFloor</span> <span class="o">=</span> <span class="n">DM9801_NOISE_FLOOR</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">HPNA_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0xb900</span>: <span class="cm">/* DM9801 E3 */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">reg25</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">reg25</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">reg25</span> <span class="o">+</span> <span class="n">HPNA_NoiseFloor</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">reg17</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb901</span>: <span class="cm">/* DM9801 E4 */</span>
		<span class="n">reg25</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">reg25</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg25</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">+</span> <span class="n">HPNA_NoiseFloor</span><span class="p">;</span>
		<span class="n">reg17</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">reg17</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg17</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">)</span> <span class="o">+</span> <span class="n">HPNA_NoiseFloor</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb902</span>: <span class="cm">/* DM9801 E5 */</span>
	<span class="k">case</span> <span class="mh">0xb903</span>: <span class="cm">/* DM9801 E6 */</span>
	<span class="nl">default:</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">reg25</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">reg25</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg25</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">+</span> <span class="n">HPNA_NoiseFloor</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">reg17</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">reg17</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg17</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">)</span> <span class="o">+</span> <span class="n">HPNA_NoiseFloor</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">reg17</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">reg25</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Init HomeRun DM9802</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_program_DM9802</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">HPNA_NoiseFloor</span> <span class="p">)</span> <span class="n">HPNA_NoiseFloor</span> <span class="o">=</span> <span class="n">DM9802_NOISE_FLOOR</span><span class="p">;</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">phy_reg</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">phy_reg</span> <span class="o">=</span> <span class="p">(</span> <span class="n">phy_reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">+</span> <span class="n">HPNA_NoiseFloor</span><span class="p">;</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Check remote HPNA power and speed status. If not correct,</span>
<span class="cm"> *	issue command again.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmfe_HPNA_remote_cmd_chk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="cm">/* Got remote device status */</span>
	<span class="n">phy_reg</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">phy_reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x0a00</span><span class="p">;</span><span class="k">break</span><span class="p">;</span> <span class="cm">/* LP/LS */</span>
	<span class="k">case</span> <span class="mh">0x20</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x0900</span><span class="p">;</span><span class="k">break</span><span class="p">;</span> <span class="cm">/* LP/HS */</span>
	<span class="k">case</span> <span class="mh">0x40</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x0600</span><span class="p">;</span><span class="k">break</span><span class="p">;</span> <span class="cm">/* HP/LS */</span>
	<span class="k">case</span> <span class="mh">0x60</span>: <span class="n">phy_reg</span> <span class="o">=</span> <span class="mh">0x0500</span><span class="p">;</span><span class="k">break</span><span class="p">;</span> <span class="cm">/* HP/HS */</span>
	<span class="p">}</span>

	<span class="cm">/* Check remote device status match our setting ot not */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">phy_reg</span> <span class="o">!=</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_write</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_command</span><span class="p">,</span>
			  <span class="n">db</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_timer</span><span class="o">=</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">HPNA_timer</span><span class="o">=</span><span class="mi">600</span><span class="p">;</span>	<span class="cm">/* Match, every 10 minutes, check */</span>
<span class="p">}</span>



<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">dmfe_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x1282</span><span class="p">,</span> <span class="mh">0x9132</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DM9132_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1282</span><span class="p">,</span> <span class="mh">0x9102</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DM9102_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1282</span><span class="p">,</span> <span class="mh">0x9100</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DM9100_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1282</span><span class="p">,</span> <span class="mh">0x9009</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DM9009_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">dmfe_pci_tbl</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmfe_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dmfe_board_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Disable upper layer interface */</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable Tx/Rx */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CR6_RXSC</span> <span class="o">|</span> <span class="n">CR6_TXSC</span><span class="p">);</span>
	<span class="n">update_cr6</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cr6_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Disable Interrupt */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DCR5</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">DCR5</span><span class="p">));</span>

	<span class="cm">/* Fre RX buffers */</span>
	<span class="n">dmfe_free_rxbuffer</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="cm">/* Enable WOL */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DMFE_WOL_LINKCHANGE</span><span class="o">|</span><span class="n">DMFE_WOL_MAGICPACKET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">wol_mode</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMFE_WOL_LINKCHANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">wol_mode</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMFE_WOL_MAGICPACKET</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Power down device*/</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pci_choose_state</span> <span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmfe_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* Re-initialize DM910X board */</span>
	<span class="n">dmfe_init_dm910x</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable WOL */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DMFE_WOL_LINKCHANGE</span> <span class="o">|</span> <span class="n">DMFE_WOL_MAGICPACKET</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Restart upper layer interface */</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define dmfe_suspend NULL</span>
<span class="cp">#define dmfe_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">dmfe_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;dmfe&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">dmfe_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">dmfe_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dmfe_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>        <span class="o">=</span> <span class="n">dmfe_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>         <span class="o">=</span> <span class="n">dmfe_resume</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sten Wang, sten_wang@davicom.com.tw&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Davicom DM910X fast ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cr6set</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">chkmode</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">HPNA_mode</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">HPNA_rx_cmd</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">HPNA_tx_cmd</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">HPNA_NoiseFloor</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">SF_mode</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Davicom DM9xxx enable debugging (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;Davicom DM9xxx: &quot;</span>
		<span class="s">&quot;Bit 0: 10/100Mbps, bit 2: duplex, bit 8: HomePNA&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">SF_mode</span><span class="p">,</span> <span class="s">&quot;Davicom DM9xxx special function &quot;</span>
		<span class="s">&quot;(bit 0: VLAN, bit 1 Flow Control, bit 2: TX pause packet)&quot;</span><span class="p">);</span>

<span class="cm">/*	Description:</span>
<span class="cm"> *	when user used insmod to add module, system invoked init_module()</span>
<span class="cm"> *	to initialize and register.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dmfe_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="n">printed_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;init_module() &quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">dmfe_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>	<span class="cm">/* set debug flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr6set</span><span class="p">)</span>
		<span class="n">dmfe_cr6_user_set</span> <span class="o">=</span> <span class="n">cr6set</span><span class="p">;</span>

 	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
   	<span class="k">case</span> <span class="n">DMFE_10MHF</span>:
	<span class="k">case</span> <span class="n">DMFE_100MHF</span>:
	<span class="k">case</span> <span class="n">DMFE_10MFD</span>:
	<span class="k">case</span> <span class="n">DMFE_100MFD</span>:
	<span class="k">case</span> <span class="n">DMFE_1M_HPNA</span>:
		<span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span><span class="n">dmfe_media_mode</span> <span class="o">=</span> <span class="n">DMFE_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HPNA_mode</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">HPNA_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Default: LP/HS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HPNA_rx_cmd</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">HPNA_rx_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Default: Ignored remote cmd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HPNA_tx_cmd</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">HPNA_tx_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Default: Don&#39;t issue remote cmd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HPNA_NoiseFloor</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">HPNA_NoiseFloor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmfe_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *	when user used rmmod to delete module, system invoked clean_module()</span>
<span class="cm"> *	to un-register all registered services.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dmfe_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMFE_DBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dmfe_clean_module() &quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmfe_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dmfe_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dmfe_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
