<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dec › tulip › de4x5.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>de4x5.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*  de4x5.c: A DIGITAL DC21x4x DECchip and DE425/DE434/DE435/DE450/DE500</span>
<span class="cm">             ethernet driver for Linux.</span>

<span class="cm">    Copyright 1994, 1995 Digital Equipment Corporation.</span>

<span class="cm">    Testing resources for this driver have been made available</span>
<span class="cm">    in part by NASA Ames Research Center (mjacob@nas.nasa.gov).</span>

<span class="cm">    The author may be reached at davies@maniac.ultranet.com.</span>

<span class="cm">    This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm">    under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm">    Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm">    option) any later version.</span>

<span class="cm">    THIS  SOFTWARE  IS PROVIDED   ``AS  IS&#39;&#39; AND   ANY  EXPRESS OR   IMPLIED</span>
<span class="cm">    WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm">    MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN</span>
<span class="cm">    NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT,  INDIRECT,</span>
<span class="cm">    INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm">    NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF</span>
<span class="cm">    USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm">    ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm">    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm">    THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="cm">    You should have received a copy of the  GNU General Public License along</span>
<span class="cm">    with this program; if not, write  to the Free Software Foundation, Inc.,</span>
<span class="cm">    675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">    Originally,   this  driver  was    written  for the  Digital   Equipment</span>
<span class="cm">    Corporation series of EtherWORKS ethernet cards:</span>

<span class="cm">        DE425 TP/COAX EISA</span>
<span class="cm">	DE434 TP PCI</span>
<span class="cm">	DE435 TP/COAX/AUI PCI</span>
<span class="cm">	DE450 TP/COAX/AUI PCI</span>
<span class="cm">	DE500 10/100 PCI Fasternet</span>

<span class="cm">    but it  will  now attempt  to  support all  cards which   conform to the</span>
<span class="cm">    Digital Semiconductor   SROM   Specification.    The  driver   currently</span>
<span class="cm">    recognises the following chips:</span>

<span class="cm">        DC21040  (no SROM)</span>
<span class="cm">	DC21041[A]</span>
<span class="cm">	DC21140[A]</span>
<span class="cm">	DC21142</span>
<span class="cm">	DC21143</span>

<span class="cm">    So far the driver is known to work with the following cards:</span>

<span class="cm">        KINGSTON</span>
<span class="cm">	Linksys</span>
<span class="cm">	ZNYX342</span>
<span class="cm">	SMC8432</span>
<span class="cm">	SMC9332 (w/new SROM)</span>
<span class="cm">	ZNYX31[45]</span>
<span class="cm">	ZNYX346 10/100 4 port (can act as a 10/100 bridge!)</span>

<span class="cm">    The driver has been tested on a relatively busy network using the DE425,</span>
<span class="cm">    DE434, DE435 and DE500 cards and benchmarked with &#39;ttcp&#39;: it transferred</span>
<span class="cm">    16M of data to a DECstation 5000/200 as follows:</span>

<span class="cm">                TCP           UDP</span>
<span class="cm">             TX     RX     TX     RX</span>
<span class="cm">    DE425   1030k  997k   1170k  1128k</span>
<span class="cm">    DE434   1063k  995k   1170k  1125k</span>
<span class="cm">    DE435   1063k  995k   1170k  1125k</span>
<span class="cm">    DE500   1063k  998k   1170k  1125k  in 10Mb/s mode</span>

<span class="cm">    All  values are typical (in   kBytes/sec) from a  sample  of 4 for  each</span>
<span class="cm">    measurement. Their error is +/-20k on a quiet (private) network and also</span>
<span class="cm">    depend on what load the CPU has.</span>

<span class="cm">    =========================================================================</span>
<span class="cm">    This driver  has been written substantially  from  scratch, although its</span>
<span class="cm">    inheritance of style and stack interface from &#39;ewrk3.c&#39; and in turn from</span>
<span class="cm">    Donald Becker&#39;s &#39;lance.c&#39; should be obvious. With the module autoload of</span>
<span class="cm">    every  usable DECchip board,  I  pinched Donald&#39;s &#39;next_module&#39; field to</span>
<span class="cm">    link my modules together.</span>

<span class="cm">    Up to 15 EISA cards can be supported under this driver, limited primarily</span>
<span class="cm">    by the available IRQ lines.  I have  checked different configurations of</span>
<span class="cm">    multiple depca, EtherWORKS 3 cards and de4x5 cards and  have not found a</span>
<span class="cm">    problem yet (provided you have at least depca.c v0.38) ...</span>

<span class="cm">    PCI support has been added  to allow the driver  to work with the DE434,</span>
<span class="cm">    DE435, DE450 and DE500 cards. The I/O accesses are a bit of a kludge due</span>
<span class="cm">    to the differences in the EISA and PCI CSR address offsets from the base</span>
<span class="cm">    address.</span>

<span class="cm">    The ability to load this  driver as a loadable  module has been included</span>
<span class="cm">    and used extensively  during the driver development  (to save those long</span>
<span class="cm">    reboot sequences).  Loadable module support  under PCI and EISA has been</span>
<span class="cm">    achieved by letting the driver autoprobe as if it were compiled into the</span>
<span class="cm">    kernel. Do make sure  you&#39;re not sharing  interrupts with anything  that</span>
<span class="cm">    cannot accommodate  interrupt  sharing!</span>

<span class="cm">    To utilise this ability, you have to do 8 things:</span>

<span class="cm">    0) have a copy of the loadable modules code installed on your system.</span>
<span class="cm">    1) copy de4x5.c from the  /linux/drivers/net directory to your favourite</span>
<span class="cm">    temporary directory.</span>
<span class="cm">    2) for fixed  autoprobes (not  recommended),  edit the source code  near</span>
<span class="cm">    line 5594 to reflect the I/O address  you&#39;re using, or assign these when</span>
<span class="cm">    loading by:</span>

<span class="cm">                   insmod de4x5 io=0xghh           where g = bus number</span>
<span class="cm">		                                        hh = device number</span>

<span class="cm">       NB: autoprobing for modules is now supported by default. You may just</span>
<span class="cm">           use:</span>

<span class="cm">                   insmod de4x5</span>

<span class="cm">           to load all available boards. For a specific board, still use</span>
<span class="cm">	   the &#39;io=?&#39; above.</span>
<span class="cm">    3) compile  de4x5.c, but include -DMODULE in  the command line to ensure</span>
<span class="cm">    that the correct bits are compiled (see end of source code).</span>
<span class="cm">    4) if you are wanting to add a new  card, goto 5. Otherwise, recompile a</span>
<span class="cm">    kernel with the de4x5 configuration turned off and reboot.</span>
<span class="cm">    5) insmod de4x5 [io=0xghh]</span>
<span class="cm">    6) run the net startup bits for your new eth?? interface(s) manually</span>
<span class="cm">    (usually /etc/rc.inet[12] at boot time).</span>
<span class="cm">    7) enjoy!</span>

<span class="cm">    To unload a module, turn off the associated interface(s)</span>
<span class="cm">    &#39;ifconfig eth?? down&#39; then &#39;rmmod de4x5&#39;.</span>

<span class="cm">    Automedia detection is included so that in  principal you can disconnect</span>
<span class="cm">    from, e.g.  TP, reconnect  to BNC  and  things will still work  (after a</span>
<span class="cm">    pause whilst the   driver figures out   where its media went).  My tests</span>
<span class="cm">    using ping showed that it appears to work....</span>

<span class="cm">    By  default,  the driver will  now   autodetect any  DECchip based card.</span>
<span class="cm">    Should you have a need to restrict the driver to DIGITAL only cards, you</span>
<span class="cm">    can compile with a  DEC_ONLY define, or if  loading as a module, use the</span>
<span class="cm">    &#39;dec_only=1&#39;  parameter.</span>

<span class="cm">    I&#39;ve changed the timing routines to  use the kernel timer and scheduling</span>
<span class="cm">    functions  so that the  hangs  and other assorted problems that occurred</span>
<span class="cm">    while autosensing the  media  should be gone.  A  bonus  for the DC21040</span>
<span class="cm">    auto  media sense algorithm is  that it can now  use one that is more in</span>
<span class="cm">    line with the  rest (the DC21040  chip doesn&#39;t  have a hardware  timer).</span>
<span class="cm">    The downside is the 1 &#39;jiffies&#39; (10ms) resolution.</span>

<span class="cm">    IEEE 802.3u MII interface code has  been added in anticipation that some</span>
<span class="cm">    products may use it in the future.</span>

<span class="cm">    The SMC9332 card  has a non-compliant SROM  which needs fixing -  I have</span>
<span class="cm">    patched this  driver to detect it  because the SROM format used complies</span>
<span class="cm">    to a previous DEC-STD format.</span>

<span class="cm">    I have removed the buffer copies needed for receive on Intels.  I cannot</span>
<span class="cm">    remove them for   Alphas since  the  Tulip hardware   only does longword</span>
<span class="cm">    aligned  DMA transfers  and  the  Alphas get   alignment traps with  non</span>
<span class="cm">    longword aligned data copies (which makes them really slow). No comment.</span>

<span class="cm">    I  have added SROM decoding  routines to make this  driver work with any</span>
<span class="cm">    card that  supports the Digital  Semiconductor SROM spec. This will help</span>
<span class="cm">    all  cards running the dc2114x  series chips in particular.  Cards using</span>
<span class="cm">    the dc2104x  chips should run correctly with  the basic  driver.  I&#39;m in</span>
<span class="cm">    debt to &lt;mjacob@feral.com&gt; for the  testing and feedback that helped get</span>
<span class="cm">    this feature working.  So far we have  tested KINGSTON, SMC8432, SMC9332</span>
<span class="cm">    (with the latest SROM complying  with the SROM spec  V3: their first was</span>
<span class="cm">    broken), ZNYX342  and  LinkSys. ZYNX314 (dual  21041  MAC) and  ZNYX 315</span>
<span class="cm">    (quad 21041 MAC)  cards also  appear  to work despite their  incorrectly</span>
<span class="cm">    wired IRQs.</span>

<span class="cm">    I have added a temporary fix for interrupt problems when some SCSI cards</span>
<span class="cm">    share the same interrupt as the DECchip based  cards. The problem occurs</span>
<span class="cm">    because  the SCSI card wants to  grab the interrupt  as a fast interrupt</span>
<span class="cm">    (runs the   service routine with interrupts turned   off) vs.  this card</span>
<span class="cm">    which really needs to run the service routine with interrupts turned on.</span>
<span class="cm">    This driver will  now   add the interrupt service   routine  as  a  fast</span>
<span class="cm">    interrupt if it   is bounced from the   slow interrupt.  THIS IS NOT   A</span>
<span class="cm">    RECOMMENDED WAY TO RUN THE DRIVER  and has been done  for a limited time</span>
<span class="cm">    until  people   sort  out their  compatibility    issues and the  kernel</span>
<span class="cm">    interrupt  service code  is  fixed.   YOU  SHOULD SEPARATE OUT  THE FAST</span>
<span class="cm">    INTERRUPT CARDS FROM THE SLOW INTERRUPT CARDS to ensure that they do not</span>
<span class="cm">    run on the same interrupt. PCMCIA/CardBus is another can of worms...</span>

<span class="cm">    Finally, I think  I have really  fixed  the module  loading problem with</span>
<span class="cm">    more than one DECchip based  card.  As a  side effect, I don&#39;t mess with</span>
<span class="cm">    the  device structure any  more which means that  if more than 1 card in</span>
<span class="cm">    2.0.x is    installed (4  in   2.1.x),  the  user   will have   to  edit</span>
<span class="cm">    linux/drivers/net/Space.c  to make room for  them. Hence, module loading</span>
<span class="cm">    is  the preferred way to use   this driver, since  it  doesn&#39;t have this</span>
<span class="cm">    limitation.</span>

<span class="cm">    Where SROM media  detection is used and  full duplex is specified in the</span>
<span class="cm">    SROM,  the feature is  ignored unless  lp-&gt;params.fdx  is set at compile</span>
<span class="cm">    time  OR during  a   module load  (insmod  de4x5   args=&#39;eth??:fdx&#39; [see</span>
<span class="cm">    below]).  This is because there  is no way  to automatically detect full</span>
<span class="cm">    duplex   links  except through   autonegotiation.    When I  include the</span>
<span class="cm">    autonegotiation feature in  the SROM autoconf  code, this detection will</span>
<span class="cm">    occur automatically for that case.</span>

<span class="cm">    Command  line arguments are  now  allowed, similar  to passing arguments</span>
<span class="cm">    through LILO. This will allow a per adapter board  set up of full duplex</span>
<span class="cm">    and media. The only lexical constraints  are: the board name (dev-&gt;name)</span>
<span class="cm">    appears in the list before its  parameters.  The list of parameters ends</span>
<span class="cm">    either at the end of the parameter list or with another board name.  The</span>
<span class="cm">    following parameters are allowed:</span>

<span class="cm">            fdx        for full duplex</span>
<span class="cm">	    autosense  to set the media/speed; with the following</span>
<span class="cm">	               sub-parameters:</span>
<span class="cm">		       TP, TP_NW, BNC, AUI, BNC_AUI, 100Mb, 10Mb, AUTO</span>

<span class="cm">    Case sensitivity is important  for  the sub-parameters. They *must*   be</span>
<span class="cm">    upper case. Examples:</span>

<span class="cm">        insmod de4x5 args=&#39;eth1:fdx autosense=BNC eth0:autosense=100Mb&#39;.</span>

<span class="cm">    For a compiled in driver, at or above line 548, place e.g.</span>
<span class="cm">	#define DE4X5_PARM &quot;eth0:fdx autosense=AUI eth2:autosense=TP&quot;</span>

<span class="cm">    Yes,  I know full duplex isn&#39;t  permissible on BNC  or AUI; they&#39;re just</span>
<span class="cm">    examples. By default, full duplex is turned off and  AUTO is the default</span>
<span class="cm">    autosense setting.  In reality, I expect only  the full duplex option to</span>
<span class="cm">    be used. Note the use of single quotes in the two examples above and the</span>
<span class="cm">    lack of commas to separate items. ALSO, you must get the requested media</span>
<span class="cm">    correct in relation to what the adapter SROM says it has. There&#39;s no way</span>
<span class="cm">    to  determine this in  advance other than by  trial and error and common</span>
<span class="cm">    sense, e.g. call a BNC connectored port &#39;BNC&#39;, not &#39;10Mb&#39;.</span>

<span class="cm">    Changed the bus probing.  EISA used to be  done first,  followed by PCI.</span>
<span class="cm">    Most people probably don&#39;t even know  what a de425 is today and the EISA</span>
<span class="cm">    probe has messed  up some SCSI cards  in the past,  so now PCI is always</span>
<span class="cm">    probed  first  followed by  EISA if  a) the architecture allows EISA and</span>
<span class="cm">    either  b) there have been no PCI cards detected or  c) an EISA probe is</span>
<span class="cm">    forced by  the user.  To force  a probe  include  &quot;force_eisa&quot;  in  your</span>
<span class="cm">    insmod &quot;args&quot; line;  for built-in kernels either change the driver to do</span>
<span class="cm">    this  automatically  or include  #define DE4X5_FORCE_EISA  on or  before</span>
<span class="cm">    line 1040 in the driver.</span>

<span class="cm">    TO DO:</span>
<span class="cm">    ------</span>

<span class="cm">    Revision History</span>
<span class="cm">    ----------------</span>

<span class="cm">    Version   Date        Description</span>

<span class="cm">      0.1     17-Nov-94   Initial writing. ALPHA code release.</span>
<span class="cm">      0.2     13-Jan-95   Added PCI support for DE435&#39;s.</span>
<span class="cm">      0.21    19-Jan-95   Added auto media detection.</span>
<span class="cm">      0.22    10-Feb-95   Fix interrupt handler call &lt;chris@cosy.sbg.ac.at&gt;.</span>
<span class="cm">                          Fix recognition bug reported by &lt;bkm@star.rl.ac.uk&gt;.</span>
<span class="cm">			  Add request/release_region code.</span>
<span class="cm">			  Add loadable modules support for PCI.</span>
<span class="cm">			  Clean up loadable modules support.</span>
<span class="cm">      0.23    28-Feb-95   Added DC21041 and DC21140 support.</span>
<span class="cm">                          Fix missed frame counter value and initialisation.</span>
<span class="cm">			  Fixed EISA probe.</span>
<span class="cm">      0.24    11-Apr-95   Change delay routine to use &lt;linux/udelay&gt;.</span>
<span class="cm">                          Change TX_BUFFS_AVAIL macro.</span>
<span class="cm">			  Change media autodetection to allow manual setting.</span>
<span class="cm">			  Completed DE500 (DC21140) support.</span>
<span class="cm">      0.241   18-Apr-95   Interim release without DE500 Autosense Algorithm.</span>
<span class="cm">      0.242   10-May-95   Minor changes.</span>
<span class="cm">      0.30    12-Jun-95   Timer fix for DC21140.</span>
<span class="cm">                          Portability changes.</span>
<span class="cm">			  Add ALPHA changes from &lt;jestabro@ant.tay1.dec.com&gt;.</span>
<span class="cm">			  Add DE500 semi automatic autosense.</span>
<span class="cm">			  Add Link Fail interrupt TP failure detection.</span>
<span class="cm">			  Add timer based link change detection.</span>
<span class="cm">			  Plugged a memory leak in de4x5_queue_pkt().</span>
<span class="cm">      0.31    13-Jun-95   Fixed PCI stuff for 1.3.1.</span>
<span class="cm">      0.32    26-Jun-95   Added verify_area() calls in de4x5_ioctl() from a</span>
<span class="cm">                          suggestion by &lt;heiko@colossus.escape.de&gt;.</span>
<span class="cm">      0.33     8-Aug-95   Add shared interrupt support (not released yet).</span>
<span class="cm">      0.331   21-Aug-95   Fix de4x5_open() with fast CPUs.</span>
<span class="cm">                          Fix de4x5_interrupt().</span>
<span class="cm">                          Fix dc21140_autoconf() mess.</span>
<span class="cm">			  No shared interrupt support.</span>
<span class="cm">      0.332   11-Sep-95   Added MII management interface routines.</span>
<span class="cm">      0.40     5-Mar-96   Fix setup frame timeout &lt;maartenb@hpkuipc.cern.ch&gt;.</span>
<span class="cm">                          Add kernel timer code (h/w is too flaky).</span>
<span class="cm">			  Add MII based PHY autosense.</span>
<span class="cm">			  Add new multicasting code.</span>
<span class="cm">			  Add new autosense algorithms for media/mode</span>
<span class="cm">			  selection using kernel scheduling/timing.</span>
<span class="cm">			  Re-formatted.</span>
<span class="cm">			  Made changes suggested by &lt;jeff@router.patch.net&gt;:</span>
<span class="cm">			    Change driver to detect all DECchip based cards</span>
<span class="cm">			    with DEC_ONLY restriction a special case.</span>
<span class="cm">			    Changed driver to autoprobe as a module. No irq</span>
<span class="cm">			    checking is done now - assume BIOS is good!</span>
<span class="cm">			  Added SMC9332 detection &lt;manabe@Roy.dsl.tutics.ac.jp&gt;</span>
<span class="cm">      0.41    21-Mar-96   Don&#39;t check for get_hw_addr checksum unless DEC card</span>
<span class="cm">                          only &lt;niles@axp745gsfc.nasa.gov&gt;</span>
<span class="cm">			  Fix for multiple PCI cards reported by &lt;jos@xos.nl&gt;</span>
<span class="cm">			  Duh, put the IRQF_SHARED flag into request_interrupt().</span>
<span class="cm">			  Fix SMC ethernet address in enet_det[].</span>
<span class="cm">			  Print chip name instead of &quot;UNKNOWN&quot; during boot.</span>
<span class="cm">      0.42    26-Apr-96   Fix MII write TA bit error.</span>
<span class="cm">                          Fix bug in dc21040 and dc21041 autosense code.</span>
<span class="cm">			  Remove buffer copies on receive for Intels.</span>
<span class="cm">			  Change sk_buff handling during media disconnects to</span>
<span class="cm">			   eliminate DUP packets.</span>
<span class="cm">			  Add dynamic TX thresholding.</span>
<span class="cm">			  Change all chips to use perfect multicast filtering.</span>
<span class="cm">			  Fix alloc_device() bug &lt;jari@markkus2.fimr.fi&gt;</span>
<span class="cm">      0.43   21-Jun-96    Fix unconnected media TX retry bug.</span>
<span class="cm">                          Add Accton to the list of broken cards.</span>
<span class="cm">			  Fix TX under-run bug for non DC21140 chips.</span>
<span class="cm">			  Fix boot command probe bug in alloc_device() as</span>
<span class="cm">			   reported by &lt;koen.gadeyne@barco.com&gt; and</span>
<span class="cm">			   &lt;orava@nether.tky.hut.fi&gt;.</span>
<span class="cm">			  Add cache locks to prevent a race condition as</span>
<span class="cm">			   reported by &lt;csd@microplex.com&gt; and</span>
<span class="cm">			   &lt;baba@beckman.uiuc.edu&gt;.</span>
<span class="cm">			  Upgraded alloc_device() code.</span>
<span class="cm">      0.431  28-Jun-96    Fix potential bug in queue_pkt() from discussion</span>
<span class="cm">                          with &lt;csd@microplex.com&gt;</span>
<span class="cm">      0.44   13-Aug-96    Fix RX overflow bug in 2114[023] chips.</span>
<span class="cm">                          Fix EISA probe bugs reported by &lt;os2@kpi.kharkov.ua&gt;</span>
<span class="cm">			  and &lt;michael@compurex.com&gt;.</span>
<span class="cm">      0.441   9-Sep-96    Change dc21041_autoconf() to probe quiet BNC media</span>
<span class="cm">                           with a loopback packet.</span>
<span class="cm">      0.442   9-Sep-96    Include AUI in dc21041 media printout. Bug reported</span>
<span class="cm">                           by &lt;bhat@mundook.cs.mu.OZ.AU&gt;</span>
<span class="cm">      0.45    8-Dec-96    Include endian functions for PPC use, from work</span>
<span class="cm">                           by &lt;cort@cs.nmt.edu&gt; and &lt;g.thomas@opengroup.org&gt;.</span>
<span class="cm">      0.451  28-Dec-96    Added fix to allow autoprobe for modules after</span>
<span class="cm">                           suggestion from &lt;mjacob@feral.com&gt;.</span>
<span class="cm">      0.5    30-Jan-97    Added SROM decoding functions.</span>
<span class="cm">                          Updated debug flags.</span>
<span class="cm">			  Fix sleep/wakeup calls for PCI cards, bug reported</span>
<span class="cm">			   by &lt;cross@gweep.lkg.dec.com&gt;.</span>
<span class="cm">			  Added multi-MAC, one SROM feature from discussion</span>
<span class="cm">			   with &lt;mjacob@feral.com&gt;.</span>
<span class="cm">			  Added full module autoprobe capability.</span>
<span class="cm">			  Added attempt to use an SMC9332 with broken SROM.</span>
<span class="cm">			  Added fix for ZYNX multi-mac cards that didn&#39;t</span>
<span class="cm">			   get their IRQs wired correctly.</span>
<span class="cm">      0.51   13-Feb-97    Added endian fixes for the SROM accesses from</span>
<span class="cm">			   &lt;paubert@iram.es&gt;</span>
<span class="cm">			  Fix init_connection() to remove extra device reset.</span>
<span class="cm">			  Fix MAC/PHY reset ordering in dc21140m_autoconf().</span>
<span class="cm">			  Fix initialisation problem with lp-&gt;timeout in</span>
<span class="cm">			   typeX_infoblock() from &lt;paubert@iram.es&gt;.</span>
<span class="cm">			  Fix MII PHY reset problem from work done by</span>
<span class="cm">			   &lt;paubert@iram.es&gt;.</span>
<span class="cm">      0.52   26-Apr-97    Some changes may not credit the right people -</span>
<span class="cm">                           a disk crash meant I lost some mail.</span>
<span class="cm">			  Change RX interrupt routine to drop rather than</span>
<span class="cm">			   defer packets to avoid hang reported by</span>
<span class="cm">			   &lt;g.thomas@opengroup.org&gt;.</span>
<span class="cm">			  Fix srom_exec() to return for COMPACT and type 1</span>
<span class="cm">			   infoblocks.</span>
<span class="cm">			  Added DC21142 and DC21143 functions.</span>
<span class="cm">			  Added byte counters from &lt;phil@tazenda.demon.co.uk&gt;</span>
<span class="cm">			  Added IRQF_DISABLED temporary fix from</span>
<span class="cm">			   &lt;mjacob@feral.com&gt;.</span>
<span class="cm">      0.53   12-Nov-97    Fix the *_probe() to include &#39;eth??&#39; name during</span>
<span class="cm">                           module load: bug reported by</span>
<span class="cm">			   &lt;Piete.Brooks@cl.cam.ac.uk&gt;</span>
<span class="cm">			  Fix multi-MAC, one SROM, to work with 2114x chips:</span>
<span class="cm">			   bug reported by &lt;cmetz@inner.net&gt;.</span>
<span class="cm">			  Make above search independent of BIOS device scan</span>
<span class="cm">			   direction.</span>
<span class="cm">			  Completed DC2114[23] autosense functions.</span>
<span class="cm">      0.531  21-Dec-97    Fix DE500-XA 100Mb/s bug reported by</span>
<span class="cm">                           &lt;robin@intercore.com</span>
<span class="cm">			  Fix type1_infoblock() bug introduced in 0.53, from</span>
<span class="cm">			   problem reports by</span>
<span class="cm">			   &lt;parmee@postecss.ncrfran.france.ncr.com&gt; and</span>
<span class="cm">			   &lt;jo@ice.dillingen.baynet.de&gt;.</span>
<span class="cm">			  Added argument list to set up each board from either</span>
<span class="cm">			   a module&#39;s command line or a compiled in #define.</span>
<span class="cm">			  Added generic MII PHY functionality to deal with</span>
<span class="cm">			   newer PHY chips.</span>
<span class="cm">			  Fix the mess in 2.1.67.</span>
<span class="cm">      0.532   5-Jan-98    Fix bug in mii_get_phy() reported by</span>
<span class="cm">                           &lt;redhat@cococo.net&gt;.</span>
<span class="cm">                          Fix bug in pci_probe() for 64 bit systems reported</span>
<span class="cm">			   by &lt;belliott@accessone.com&gt;.</span>
<span class="cm">      0.533   9-Jan-98    Fix more 64 bit bugs reported by &lt;jal@cs.brown.edu&gt;.</span>
<span class="cm">      0.534  24-Jan-98    Fix last (?) endian bug from &lt;geert@linux-m68k.org&gt;</span>
<span class="cm">      0.535  21-Feb-98    Fix Ethernet Address PROM reset bug for DC21040.</span>
<span class="cm">      0.536  21-Mar-98    Change pci_probe() to use the pci_dev structure.</span>
<span class="cm">			  **Incompatible with 2.0.x from here.**</span>
<span class="cm">      0.540   5-Jul-98    Atomicize assertion of dev-&gt;interrupt for SMP</span>
<span class="cm">                           from &lt;lma@varesearch.com&gt;</span>
<span class="cm">			  Add TP, AUI and BNC cases to 21140m_autoconf() for</span>
<span class="cm">			   case where a 21140 under SROM control uses, e.g. AUI</span>
<span class="cm">			   from problem report by &lt;delchini@lpnp09.in2p3.fr&gt;</span>
<span class="cm">			  Add MII parallel detection to 2114x_autoconf() for</span>
<span class="cm">			   case where no autonegotiation partner exists from</span>
<span class="cm">			   problem report by &lt;mlapsley@ndirect.co.uk&gt;.</span>
<span class="cm">			  Add ability to force connection type directly even</span>
<span class="cm">			   when using SROM control from problem report by</span>
<span class="cm">			   &lt;earl@exis.net&gt;.</span>
<span class="cm">			  Updated the PCI interface to conform with the latest</span>
<span class="cm">			   version. I hope nothing is broken...</span>
<span class="cm">          		  Add TX done interrupt modification from suggestion</span>
<span class="cm">			   by &lt;Austin.Donnelly@cl.cam.ac.uk&gt;.</span>
<span class="cm">			  Fix is_anc_capable() bug reported by</span>
<span class="cm">			   &lt;Austin.Donnelly@cl.cam.ac.uk&gt;.</span>
<span class="cm">			  Fix type[13]_infoblock() bug: during MII search, PHY</span>
<span class="cm">			   lp-&gt;rst not run because lp-&gt;ibn not initialised -</span>
<span class="cm">			   from report &amp; fix by &lt;paubert@iram.es&gt;.</span>
<span class="cm">			  Fix probe bug with EISA &amp; PCI cards present from</span>
<span class="cm">                           report by &lt;eirik@netcom.com&gt;.</span>
<span class="cm">      0.541  24-Aug-98    Fix compiler problems associated with i386-string</span>
<span class="cm">                           ops from multiple bug reports and temporary fix</span>
<span class="cm">			   from &lt;paubert@iram.es&gt;.</span>
<span class="cm">			  Fix pci_probe() to correctly emulate the old</span>
<span class="cm">			   pcibios_find_class() function.</span>
<span class="cm">			  Add an_exception() for old ZYNX346 and fix compile</span>
<span class="cm">			   warning on PPC &amp; SPARC, from &lt;ecd@skynet.be&gt;.</span>
<span class="cm">			  Fix lastPCI to correctly work with compiled in</span>
<span class="cm">			   kernels and modules from bug report by</span>
<span class="cm">			   &lt;Zlatko.Calusic@CARNet.hr&gt; et al.</span>
<span class="cm">      0.542  15-Sep-98    Fix dc2114x_autoconf() to stop multiple messages</span>
<span class="cm">                           when media is unconnected.</span>
<span class="cm">			  Change dev-&gt;interrupt to lp-&gt;interrupt to ensure</span>
<span class="cm">			   alignment for Alpha&#39;s and avoid their unaligned</span>
<span class="cm">			   access traps. This flag is merely for log messages:</span>
<span class="cm">			   should do something more definitive though...</span>
<span class="cm">      0.543  30-Dec-98    Add SMP spin locking.</span>
<span class="cm">      0.544   8-May-99    Fix for buggy SROM in Motorola embedded boards using</span>
<span class="cm">                           a 21143 by &lt;mmporter@home.com&gt;.</span>
<span class="cm">			  Change PCI/EISA bus probing order.</span>
<span class="cm">      0.545  28-Nov-99    Further Moto SROM bug fix from</span>
<span class="cm">                           &lt;mporter@eng.mcd.mot.com&gt;</span>
<span class="cm">                          Remove double checking for DEBUG_RX in de4x5_dbg_rx()</span>
<span class="cm">			   from report by &lt;geert@linux-m68k.org&gt;</span>
<span class="cm">      0.546  22-Feb-01    Fixes Alpha XP1000 oops.  The srom_search function</span>
<span class="cm">                           was causing a page fault when initializing the</span>
<span class="cm">                           variable &#39;pb&#39;, on a non de4x5 PCI device, in this</span>
<span class="cm">                           case a PCI bridge (DEC chip 21152). The value of</span>
<span class="cm">                           &#39;pb&#39; is now only initialized if a de4x5 chip is</span>
<span class="cm">                           present.</span>
<span class="cm">                           &lt;france@handhelds.org&gt;</span>
<span class="cm">      0.547  08-Nov-01    Use library crc32 functions by &lt;Matt_Domsch@dell.com&gt;</span>
<span class="cm">      0.548  30-Aug-03    Big 2.6 cleanup. Ported to PCI/EISA probing and</span>
<span class="cm">                           generic DMA APIs. Fixed DE425 support on Alpha.</span>
<span class="cm">			   &lt;maz@wild-wind.fr.eu.org&gt;</span>
<span class="cm">    =========================================================================</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/eisa.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

<span class="cp">#include &quot;de4x5.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span>
	<span class="n">KERN_INFO</span> <span class="s">&quot;de4x5.c:V0.546 2001/02/22 davies@maniac.ultranet.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#define c_char const char</span>

<span class="cm">/*</span>
<span class="cm">** MII Information</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">phy_table</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>              <span class="cm">/* Hard reset required?                         */</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>                 <span class="cm">/* IEEE OUI                                     */</span>
    <span class="kt">int</span> <span class="n">ta</span><span class="p">;</span>                 <span class="cm">/* One cycle TA time - 802.3u is confusing here */</span>
    <span class="k">struct</span> <span class="p">{</span>                <span class="cm">/* Non autonegotiation (parallel) speed det.    */</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">spd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mii_phy</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>              <span class="cm">/* Hard reset required?                      */</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>                 <span class="cm">/* IEEE OUI                                  */</span>
    <span class="kt">int</span> <span class="n">ta</span><span class="p">;</span>                 <span class="cm">/* One cycle TA time                         */</span>
    <span class="k">struct</span> <span class="p">{</span>                <span class="cm">/* Non autonegotiation (parallel) speed det. */</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">spd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>               <span class="cm">/* MII address for the PHY                   */</span>
    <span class="n">u_char</span>  <span class="o">*</span><span class="n">gep</span><span class="p">;</span>           <span class="cm">/* Start of GEP sequence block in SROM       */</span>
    <span class="n">u_char</span>  <span class="o">*</span><span class="n">rst</span><span class="p">;</span>           <span class="cm">/* Start of reset sequence in SROM           */</span>
    <span class="n">u_int</span> <span class="n">mc</span><span class="p">;</span>               <span class="cm">/* Media Capabilities                        */</span>
    <span class="n">u_int</span> <span class="n">ana</span><span class="p">;</span>              <span class="cm">/* NWay Advertisement                        */</span>
    <span class="n">u_int</span> <span class="n">fdx</span><span class="p">;</span>              <span class="cm">/* Full DupleX capabilities for each media   */</span>
    <span class="n">u_int</span> <span class="n">ttm</span><span class="p">;</span>              <span class="cm">/* Transmit Threshold Mode for each media    */</span>
    <span class="n">u_int</span> <span class="n">mci</span><span class="p">;</span>              <span class="cm">/* 21142 MII Connector Interrupt info        */</span>
<span class="p">};</span>

<span class="cp">#define DE4X5_MAX_PHY 8     </span><span class="cm">/* Allow up to 8 attached PHY devices per board */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">sia_phy</span> <span class="p">{</span>
    <span class="n">u_char</span> <span class="n">mc</span><span class="p">;</span>              <span class="cm">/* Media Code                                */</span>
    <span class="n">u_char</span> <span class="n">ext</span><span class="p">;</span>             <span class="cm">/* csr13-15 valid when set                   */</span>
    <span class="kt">int</span> <span class="n">csr13</span><span class="p">;</span>              <span class="cm">/* SIA Connectivity Register                 */</span>
    <span class="kt">int</span> <span class="n">csr14</span><span class="p">;</span>              <span class="cm">/* SIA TX/RX Register                        */</span>
    <span class="kt">int</span> <span class="n">csr15</span><span class="p">;</span>              <span class="cm">/* SIA General Register                      */</span>
    <span class="kt">int</span> <span class="n">gepc</span><span class="p">;</span>               <span class="cm">/* SIA GEP Control Information               */</span>
    <span class="kt">int</span> <span class="n">gep</span><span class="p">;</span>                <span class="cm">/* SIA GEP Data                              */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** Define the know universe of PHY devices that can be</span>
<span class="cm">** recognised by this driver.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">phy_table</span> <span class="n">phy_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="n">NATIONAL_TX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}},</span>       <span class="cm">/* National TX      */</span>
    <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">BROADCOM_T4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">}},</span>       <span class="cm">/* Broadcom T4      */</span>
    <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEEQ_T4</span>    <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">}},</span>       <span class="cm">/* SEEQ T4          */</span>
    <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="n">CYPRESS_T4</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">}},</span>       <span class="cm">/* Cypress T4       */</span>
    <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x7810</span>     <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">}}</span>    <span class="cm">/* Level One LTX970 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** These GENERIC values assumes that the PHY devices follow 802.3u and</span>
<span class="cm">** allow parallel detection to set the link partner ability register.</span>
<span class="cm">** Detection of 100Base-TX [H/F Duplex] and 100Base-T4 is supported.</span>
<span class="cm">*/</span>
<span class="cp">#define GENERIC_REG   0x05      </span><span class="cm">/* Autoneg. Link Partner Advertisement Reg. */</span><span class="cp"></span>
<span class="cp">#define GENERIC_MASK  MII_ANLPA_100M </span><span class="cm">/* All 100Mb/s Technologies            */</span><span class="cp"></span>
<span class="cp">#define GENERIC_VALUE MII_ANLPA_100M </span><span class="cm">/* 100B-TX, 100B-TX FDX, 100B-T4       */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">** Define special SROM detection cases</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">c_char</span> <span class="n">enet_det</span><span class="p">[][</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
    <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define SMC    1</span>
<span class="cp">#define ACCTON 2</span>

<span class="cm">/*</span>
<span class="cm">** SROM Repair definitions. If a broken SROM is detected a card may</span>
<span class="cm">** use this information to help figure out what to do. This is a</span>
<span class="cm">** &quot;stab in the dark&quot; and so far for SMC9332&#39;s only.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">c_char</span> <span class="n">srom_repair_info</span><span class="p">[][</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span>             <span class="cm">/* SMC9332 */</span>
     <span class="mh">0x1f</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x8f</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span>
     <span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span>
     <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,}</span>
<span class="p">};</span>


<span class="cp">#ifdef DE4X5_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">de4x5_debug</span> <span class="o">=</span> <span class="n">DE4X5_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cm">/*static int de4x5_debug = (DEBUG_MII | DEBUG_SROM | DEBUG_PCICFG | DEBUG_MEDIA | DEBUG_VERSION);*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">de4x5_debug</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEBUG_MEDIA</span> <span class="o">|</span> <span class="n">DEBUG_VERSION</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">** Allow per adapter set up. For modules this is simply a command line</span>
<span class="cm">** parameter, e.g.:</span>
<span class="cm">** insmod de4x5 args=&#39;eth1:fdx autosense=BNC eth0:autosense=100Mb&#39;.</span>
<span class="cm">**</span>
<span class="cm">** For a compiled in driver, place e.g.</span>
<span class="cm">**     #define DE4X5_PARM &quot;eth0:fdx autosense=AUI eth2:autosense=TP&quot;</span>
<span class="cm">** here</span>
<span class="cm">*/</span>
<span class="cp">#ifdef DE4X5_PARM</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">DE4X5_PARM</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">parameters</span> <span class="p">{</span>
    <span class="n">bool</span> <span class="n">fdx</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">autosense</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DE4X5_AUTOSENSE_MS 250      </span><span class="cm">/* msec autosense tick (DE500) */</span><span class="cp"></span>

<span class="cp">#define DE4X5_NDA 0xffe0            </span><span class="cm">/* No Device (I/O) Address */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">** Ethernet PROM defines</span>
<span class="cm">*/</span>
<span class="cp">#define PROBE_LENGTH    32</span>
<span class="cp">#define ETH_PROM_SIG    0xAA5500FFUL</span>

<span class="cm">/*</span>
<span class="cm">** Ethernet Info</span>
<span class="cm">*/</span>
<span class="cp">#define PKT_BUF_SZ	1536            </span><span class="cm">/* Buffer size for each Tx/Rx buffer */</span><span class="cp"></span>
<span class="cp">#define IEEE802_3_SZ    1518            </span><span class="cm">/* Packet + CRC */</span><span class="cp"></span>
<span class="cp">#define MAX_PKT_SZ   	1514            </span><span class="cm">/* Maximum ethernet packet length */</span><span class="cp"></span>
<span class="cp">#define MAX_DAT_SZ   	1500            </span><span class="cm">/* Maximum ethernet data length */</span><span class="cp"></span>
<span class="cp">#define MIN_DAT_SZ   	1               </span><span class="cm">/* Minimum ethernet data length */</span><span class="cp"></span>
<span class="cp">#define PKT_HDR_LEN     14              </span><span class="cm">/* Addresses and data length info */</span><span class="cp"></span>
<span class="cp">#define FAKE_FRAME_LEN  (MAX_PKT_SZ + 1)</span>
<span class="cp">#define QUEUE_PKT_TIMEOUT (3*HZ)        </span><span class="cm">/* 3 second timeout */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm">** EISA bus defines</span>
<span class="cm">*/</span>
<span class="cp">#define DE4X5_EISA_IO_PORTS   0x0c00    </span><span class="cm">/* I/O port base address, slot 0 */</span><span class="cp"></span>
<span class="cp">#define DE4X5_EISA_TOTAL_SIZE 0x100     </span><span class="cm">/* I/O address extent */</span><span class="cp"></span>

<span class="cp">#define EISA_ALLOWED_IRQ_LIST  {5, 9, 10, 11}</span>

<span class="cp">#define DE4X5_SIGNATURE {&quot;DE425&quot;,&quot;DE434&quot;,&quot;DE435&quot;,&quot;DE450&quot;,&quot;DE500&quot;}</span>
<span class="cp">#define DE4X5_NAME_LENGTH 8</span>

<span class="k">static</span> <span class="n">c_char</span> <span class="o">*</span><span class="n">de4x5_signatures</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DE4X5_SIGNATURE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** Ethernet PROM defines for DC21040</span>
<span class="cm">*/</span>
<span class="cp">#define PROBE_LENGTH    32</span>
<span class="cp">#define ETH_PROM_SIG    0xAA5500FFUL</span>

<span class="cm">/*</span>
<span class="cm">** PCI Bus defines</span>
<span class="cm">*/</span>
<span class="cp">#define PCI_MAX_BUS_NUM      8</span>
<span class="cp">#define DE4X5_PCI_TOTAL_SIZE 0x80       </span><span class="cm">/* I/O address extent */</span><span class="cp"></span>
<span class="cp">#define DE4X5_CLASS_CODE     0x00020000 </span><span class="cm">/* Network controller, Ethernet */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">** Memory Alignment. Each descriptor is 4 longwords long. To force a</span>
<span class="cm">** particular alignment on the TX descriptor, adjust DESC_SKIP_LEN and</span>
<span class="cm">** DESC_ALIGN. ALIGN aligns the start address of the private memory area</span>
<span class="cm">** and hence the RX descriptor ring&#39;s first entry.</span>
<span class="cm">*/</span>
<span class="cp">#define DE4X5_ALIGN4      ((u_long)4 - 1)     </span><span class="cm">/* 1 longword align */</span><span class="cp"></span>
<span class="cp">#define DE4X5_ALIGN8      ((u_long)8 - 1)     </span><span class="cm">/* 2 longword align */</span><span class="cp"></span>
<span class="cp">#define DE4X5_ALIGN16     ((u_long)16 - 1)    </span><span class="cm">/* 4 longword align */</span><span class="cp"></span>
<span class="cp">#define DE4X5_ALIGN32     ((u_long)32 - 1)    </span><span class="cm">/* 8 longword align */</span><span class="cp"></span>
<span class="cp">#define DE4X5_ALIGN64     ((u_long)64 - 1)    </span><span class="cm">/* 16 longword align */</span><span class="cp"></span>
<span class="cp">#define DE4X5_ALIGN128    ((u_long)128 - 1)   </span><span class="cm">/* 32 longword align */</span><span class="cp"></span>

<span class="cp">#define DE4X5_ALIGN         DE4X5_ALIGN32           </span><span class="cm">/* Keep the DC21040 happy... */</span><span class="cp"></span>
<span class="cp">#define DE4X5_CACHE_ALIGN   CAL_16LONG</span>
<span class="cp">#define DESC_SKIP_LEN DSL_0             </span><span class="cm">/* Must agree with DESC_ALIGN */</span><span class="cp"></span>
<span class="cm">/*#define DESC_ALIGN    u32 dummy[4];  / * Must agree with DESC_SKIP_LEN */</span>
<span class="cp">#define DESC_ALIGN</span>

<span class="cp">#ifndef DEC_ONLY                        </span><span class="cm">/* See README.de4x5 for using this */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dec_only</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dec_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">** DE4X5 IRQ ENABLE/DISABLE</span>
<span class="cm">*/</span>
<span class="cp">#define ENABLE_IRQs { \</span>
<span class="cp">    imr |= lp-&gt;irq_en;\</span>
<span class="cp">    outl(imr, DE4X5_IMR);               </span><span class="cm">/* Enable the IRQs */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cp">#define DISABLE_IRQs {\</span>
<span class="cp">    imr = inl(DE4X5_IMR);\</span>
<span class="cp">    imr &amp;= ~lp-&gt;irq_en;\</span>
<span class="cp">    outl(imr, DE4X5_IMR);               </span><span class="cm">/* Disable the IRQs */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cp">#define UNMASK_IRQs {\</span>
<span class="cp">    imr |= lp-&gt;irq_mask;\</span>
<span class="cp">    outl(imr, DE4X5_IMR);               </span><span class="cm">/* Unmask the IRQs */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cp">#define MASK_IRQs {\</span>
<span class="cp">    imr = inl(DE4X5_IMR);\</span>
<span class="cp">    imr &amp;= ~lp-&gt;irq_mask;\</span>
<span class="cp">    outl(imr, DE4X5_IMR);               </span><span class="cm">/* Mask the IRQs */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm">** DE4X5 START/STOP</span>
<span class="cm">*/</span>
<span class="cp">#define START_DE4X5 {\</span>
<span class="cp">    omr = inl(DE4X5_OMR);\</span>
<span class="cp">    omr |= OMR_ST | OMR_SR;\</span>
<span class="cp">    outl(omr, DE4X5_OMR);               </span><span class="cm">/* Enable the TX and/or RX */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="cp">#define STOP_DE4X5 {\</span>
<span class="cp">    omr = inl(DE4X5_OMR);\</span>
<span class="cp">    omr &amp;= ~(OMR_ST|OMR_SR);\</span>
<span class="cp">    outl(omr, DE4X5_OMR);               </span><span class="cm">/* Disable the TX and/or RX */</span><span class="cp"> \</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm">** DE4X5 SIA RESET</span>
<span class="cm">*/</span>
<span class="cp">#define RESET_SIA outl(0, DE4X5_SICR);  </span><span class="cm">/* Reset SIA connectivity regs */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">** DE500 AUTOSENSE TIMER INTERVAL (MILLISECS)</span>
<span class="cm">*/</span>
<span class="cp">#define DE4X5_AUTOSENSE_MS  250</span>

<span class="cm">/*</span>
<span class="cm">** SROM Structure</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">de4x5_srom</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">sub_vendor_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">sub_system_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">id_block_crc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">reserved2</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">version</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">num_controllers</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ieee_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">info</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="kt">short</span> <span class="n">chksum</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define SUB_VENDOR_ID 0x500a</span>

<span class="cm">/*</span>
<span class="cm">** DE4X5 Descriptors. Make sure that all the RX buffers are contiguous</span>
<span class="cm">** and have sizes of both a power of 2 and a multiple of 4.</span>
<span class="cm">** A size of 256 bytes for each buffer could be chosen because over 90% of</span>
<span class="cm">** all packets in our network are &lt;256 bytes long and 64 longword alignment</span>
<span class="cm">** is possible. 1536 showed better &#39;ttcp&#39; performance. Take your pick. 32 TX</span>
<span class="cm">** descriptors are needed for machines with an ALPHA CPU.</span>
<span class="cm">*/</span>
<span class="cp">#define NUM_RX_DESC 8                   </span><span class="cm">/* Number of RX descriptors   */</span><span class="cp"></span>
<span class="cp">#define NUM_TX_DESC 32                  </span><span class="cm">/* Number of TX descriptors   */</span><span class="cp"></span>
<span class="cp">#define RX_BUFF_SZ  1536                </span><span class="cm">/* Power of 2 for kmalloc and */</span><span class="cp"></span>
                                        <span class="cm">/* Multiple of 4 for DC21040  */</span>
                                        <span class="cm">/* Allows 512 byte alignment  */</span>
<span class="k">struct</span> <span class="n">de4x5_desc</span> <span class="p">{</span>
    <span class="k">volatile</span> <span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">__le32</span> <span class="n">des1</span><span class="p">;</span>
    <span class="n">__le32</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">__le32</span> <span class="n">next</span><span class="p">;</span>
    <span class="n">DESC_ALIGN</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** The DE4X5 private structure</span>
<span class="cm">*/</span>
<span class="cp">#define DE4X5_PKT_STAT_SZ 16</span>
<span class="cp">#define DE4X5_PKT_BIN_SZ  128            </span><span class="cm">/* Should be &gt;=100 unless you</span>
<span class="cm">                                            increase DE4X5_PKT_STAT_SZ */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">pkt_stats</span> <span class="p">{</span>
	<span class="n">u_int</span> <span class="n">bins</span><span class="p">[</span><span class="n">DE4X5_PKT_STAT_SZ</span><span class="p">];</span>      <span class="cm">/* Private stats counters       */</span>
	<span class="n">u_int</span> <span class="n">unicast</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">multicast</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">broadcast</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">excessive_collisions</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">tx_underruns</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">excessive_underruns</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">rx_runt_frames</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">rx_collision</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">rx_dribble</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">rx_overflow</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">de4x5_private</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">adapter_name</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>                  <span class="cm">/* Adapter name                 */</span>
    <span class="n">u_long</span> <span class="n">interrupt</span><span class="p">;</span>                       <span class="cm">/* Aligned ISR flag             */</span>
    <span class="k">struct</span> <span class="n">de4x5_desc</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>		    <span class="cm">/* RX descriptor ring           */</span>
    <span class="k">struct</span> <span class="n">de4x5_desc</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>		    <span class="cm">/* TX descriptor ring           */</span>
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">NUM_TX_DESC</span><span class="p">];</span>    <span class="cm">/* TX skb for freeing when sent */</span>
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">NUM_RX_DESC</span><span class="p">];</span>    <span class="cm">/* RX skb&#39;s                     */</span>
    <span class="kt">int</span> <span class="n">rx_new</span><span class="p">,</span> <span class="n">rx_old</span><span class="p">;</span>                     <span class="cm">/* RX descriptor ring pointers  */</span>
    <span class="kt">int</span> <span class="n">tx_new</span><span class="p">,</span> <span class="n">tx_old</span><span class="p">;</span>                     <span class="cm">/* TX descriptor ring pointers  */</span>
    <span class="kt">char</span> <span class="n">setup_frame</span><span class="p">[</span><span class="n">SETUP_FRAME_LEN</span><span class="p">];</span>      <span class="cm">/* Holds MCA and PA info.       */</span>
    <span class="kt">char</span> <span class="n">frame</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>                         <span class="cm">/* Min sized packet for loopback*/</span>
    <span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>                        <span class="cm">/* Adapter specific spinlock    */</span>
    <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">stats</span><span class="p">;</span>          <span class="cm">/* Public stats                 */</span>
    <span class="k">struct</span> <span class="n">pkt_stats</span> <span class="n">pktStats</span><span class="p">;</span>	            <span class="cm">/* Private stats counters	    */</span>
    <span class="kt">char</span> <span class="n">rxRingSize</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">txRingSize</span><span class="p">;</span>
    <span class="kt">int</span>  <span class="n">bus</span><span class="p">;</span>                               <span class="cm">/* EISA or PCI                  */</span>
    <span class="kt">int</span>  <span class="n">bus_num</span><span class="p">;</span>                           <span class="cm">/* PCI Bus number               */</span>
    <span class="kt">int</span>  <span class="n">device</span><span class="p">;</span>                            <span class="cm">/* Device number on PCI bus     */</span>
    <span class="kt">int</span>  <span class="n">state</span><span class="p">;</span>                             <span class="cm">/* Adapter OPENED or CLOSED     */</span>
    <span class="kt">int</span>  <span class="n">chipset</span><span class="p">;</span>                           <span class="cm">/* DC21040, DC21041 or DC21140  */</span>
    <span class="n">s32</span>  <span class="n">irq_mask</span><span class="p">;</span>                          <span class="cm">/* Interrupt Mask (Enable) bits */</span>
    <span class="n">s32</span>  <span class="n">irq_en</span><span class="p">;</span>                            <span class="cm">/* Summary interrupt bits       */</span>
    <span class="kt">int</span>  <span class="n">media</span><span class="p">;</span>                             <span class="cm">/* Media (eg TP), mode (eg 100B)*/</span>
    <span class="kt">int</span>  <span class="n">c_media</span><span class="p">;</span>                           <span class="cm">/* Remember the last media conn */</span>
    <span class="n">bool</span> <span class="n">fdx</span><span class="p">;</span>                               <span class="cm">/* media full duplex flag       */</span>
    <span class="kt">int</span>  <span class="n">linkOK</span><span class="p">;</span>                            <span class="cm">/* Link is OK                   */</span>
    <span class="kt">int</span>  <span class="n">autosense</span><span class="p">;</span>                         <span class="cm">/* Allow/disallow autosensing   */</span>
    <span class="n">bool</span> <span class="n">tx_enable</span><span class="p">;</span>                         <span class="cm">/* Enable descriptor polling    */</span>
    <span class="kt">int</span>  <span class="n">setup_f</span><span class="p">;</span>                           <span class="cm">/* Setup frame filtering type   */</span>
    <span class="kt">int</span>  <span class="n">local_state</span><span class="p">;</span>                       <span class="cm">/* State within a &#39;media&#39; state */</span>
    <span class="k">struct</span> <span class="n">mii_phy</span> <span class="n">phy</span><span class="p">[</span><span class="n">DE4X5_MAX_PHY</span><span class="p">];</span>      <span class="cm">/* List of attached PHY devices */</span>
    <span class="k">struct</span> <span class="n">sia_phy</span> <span class="n">sia</span><span class="p">;</span>                     <span class="cm">/* SIA PHY Information          */</span>
    <span class="kt">int</span>  <span class="n">active</span><span class="p">;</span>                            <span class="cm">/* Index to active PHY device   */</span>
    <span class="kt">int</span>  <span class="n">mii_cnt</span><span class="p">;</span>                           <span class="cm">/* Number of attached PHY&#39;s     */</span>
    <span class="kt">int</span>  <span class="n">timeout</span><span class="p">;</span>                           <span class="cm">/* Scheduling counter           */</span>
    <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>                <span class="cm">/* Timer info for kernel        */</span>
    <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>                                <span class="cm">/* Temporary global per card    */</span>
    <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u_long</span> <span class="n">lock</span><span class="p">;</span>                        <span class="cm">/* Lock the cache accesses      */</span>
	<span class="n">s32</span> <span class="n">csr0</span><span class="p">;</span>                           <span class="cm">/* Saved Bus Mode Register      */</span>
	<span class="n">s32</span> <span class="n">csr6</span><span class="p">;</span>                           <span class="cm">/* Saved Operating Mode Reg.    */</span>
	<span class="n">s32</span> <span class="n">csr7</span><span class="p">;</span>                           <span class="cm">/* Saved IRQ Mask Register      */</span>
	<span class="n">s32</span> <span class="n">gep</span><span class="p">;</span>                            <span class="cm">/* Saved General Purpose Reg.   */</span>
	<span class="n">s32</span> <span class="n">gepc</span><span class="p">;</span>                           <span class="cm">/* Control info for GEP         */</span>
	<span class="n">s32</span> <span class="n">csr13</span><span class="p">;</span>                          <span class="cm">/* Saved SIA Connectivity Reg.  */</span>
	<span class="n">s32</span> <span class="n">csr14</span><span class="p">;</span>                          <span class="cm">/* Saved SIA TX/RX Register     */</span>
	<span class="n">s32</span> <span class="n">csr15</span><span class="p">;</span>                          <span class="cm">/* Saved SIA General Register   */</span>
	<span class="kt">int</span> <span class="n">save_cnt</span><span class="p">;</span>                       <span class="cm">/* Flag if state already saved  */</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">queue</span><span class="p">;</span>          <span class="cm">/* Save the (re-ordered) skb&#39;s  */</span>
    <span class="p">}</span> <span class="n">cache</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">de4x5_srom</span> <span class="n">srom</span><span class="p">;</span>                 <span class="cm">/* A copy of the SROM           */</span>
    <span class="kt">int</span> <span class="n">cfrv</span><span class="p">;</span>				    <span class="cm">/* Card CFRV copy */</span>
    <span class="kt">int</span> <span class="n">rx_ovf</span><span class="p">;</span>                             <span class="cm">/* Check for &#39;RX overflow&#39; tag  */</span>
    <span class="n">bool</span> <span class="n">useSROM</span><span class="p">;</span>                           <span class="cm">/* For non-DEC card use SROM    */</span>
    <span class="n">bool</span> <span class="n">useMII</span><span class="p">;</span>                            <span class="cm">/* Infoblock using the MII      */</span>
    <span class="kt">int</span> <span class="n">asBitValid</span><span class="p">;</span>                         <span class="cm">/* Autosense bits in GEP?       */</span>
    <span class="kt">int</span> <span class="n">asPolarity</span><span class="p">;</span>                         <span class="cm">/* 0 =&gt; asserted high           */</span>
    <span class="kt">int</span> <span class="n">asBit</span><span class="p">;</span>                              <span class="cm">/* Autosense bit number in GEP  */</span>
    <span class="kt">int</span> <span class="n">defMedium</span><span class="p">;</span>                          <span class="cm">/* SROM default medium          */</span>
    <span class="kt">int</span> <span class="n">tcount</span><span class="p">;</span>                             <span class="cm">/* Last infoblock number        */</span>
    <span class="kt">int</span> <span class="n">infoblock_init</span><span class="p">;</span>                     <span class="cm">/* Initialised this infoblock?  */</span>
    <span class="kt">int</span> <span class="n">infoleaf_offset</span><span class="p">;</span>                    <span class="cm">/* SROM infoleaf for controller */</span>
    <span class="n">s32</span> <span class="n">infoblock_csr6</span><span class="p">;</span>                     <span class="cm">/* csr6 value in SROM infoblock */</span>
    <span class="kt">int</span> <span class="n">infoblock_media</span><span class="p">;</span>                    <span class="cm">/* infoblock media              */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">infoleaf_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>    <span class="cm">/* Pointer to infoleaf function */</span>
    <span class="n">u_char</span> <span class="o">*</span><span class="n">rst</span><span class="p">;</span>                            <span class="cm">/* Pointer to Type 5 reset info */</span>
    <span class="n">u_char</span>  <span class="n">ibn</span><span class="p">;</span>                            <span class="cm">/* Infoblock number             */</span>
    <span class="k">struct</span> <span class="n">parameters</span> <span class="n">params</span><span class="p">;</span>               <span class="cm">/* Command line/ #defined params */</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">;</span>	            <span class="cm">/* Generic device */</span>
    <span class="n">dma_addr_t</span> <span class="n">dma_rings</span><span class="p">;</span>		    <span class="cm">/* DMA handle for rings	    */</span>
    <span class="kt">int</span> <span class="n">dma_size</span><span class="p">;</span>			    <span class="cm">/* Size of the DMA area	    */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">rx_bufs</span><span class="p">;</span>			    <span class="cm">/* rx bufs on alpha, sparc, ... */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** To get around certain poxy cards that don&#39;t provide an SROM</span>
<span class="cm">** for the second and more DECchip, I have to key off the first</span>
<span class="cm">** chip&#39;s address. I&#39;ll assume there&#39;s not a bad SROM iff:</span>
<span class="cm">**</span>
<span class="cm">**      o the chipset is the same</span>
<span class="cm">**      o the bus number is the same and &gt; 0</span>
<span class="cm">**      o the sum of all the returned hw address bytes is 0 or 0x5fa</span>
<span class="cm">**</span>
<span class="cm">** Also have to save the irq for those cards whose hardware designers</span>
<span class="cm">** can&#39;t follow the PCI to PCI Bridge Architecture spec.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">chipset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">bus</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">last</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>

<span class="cm">/*</span>
<span class="cm">** The transmit ring full condition is described by the tx_old and tx_new</span>
<span class="cm">** pointers by:</span>
<span class="cm">**    tx_old            = tx_new    Empty ring</span>
<span class="cm">**    tx_old            = tx_new+1  Full ring</span>
<span class="cm">**    tx_old+txRingSize = tx_new+1  Full ring  (wrapped condition)</span>
<span class="cm">*/</span>
<span class="cp">#define TX_BUFFS_AVAIL ((lp-&gt;tx_old&lt;=lp-&gt;tx_new)?\</span>
<span class="cp">			lp-&gt;tx_old+lp-&gt;txRingSize-lp-&gt;tx_new-1:\</span>
<span class="cp">			lp-&gt;tx_old               -lp-&gt;tx_new-1)</span>

<span class="cp">#define TX_PKT_PENDING (lp-&gt;tx_old != lp-&gt;tx_new)</span>

<span class="cm">/*</span>
<span class="cm">** Public Functions</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">de4x5_queue_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">de4x5_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span>  <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">de4x5_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_local_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">** Private functions</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_ast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_txur</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_rx_ovfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>     <span class="n">autoconf_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">create_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">load_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21040_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">srom_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prev_state</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">),</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">asfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21040_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr13</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr14</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr15</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">next_state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspect_state</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">test_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr13</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr14</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr15</span><span class="p">,</span> <span class="n">s32</span> <span class="n">msec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">test_for_100Mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">wait_for_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">test_mii_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pol</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">is_spd_100</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">is_100_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">is_10_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">is_anc_capable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">ping_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msec</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">de4x5_alloc_rx_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_free_rx_buffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_free_tx_buffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_save_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_rst_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_cache_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_put_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_putb_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span>  <span class="n">sk_buff</span> <span class="o">*</span><span class="n">de4x5_get_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_setup_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_reset_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">reset_init_sia</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">sicr</span><span class="p">,</span> <span class="n">s32</span> <span class="n">strr</span><span class="p">,</span> <span class="n">s32</span> <span class="n">sigr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">test_ans</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">s32</span> <span class="n">msec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">test_tp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">msec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">EISA_signature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">PCI_signature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">DevicePresent</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">enet_addr_rst</span><span class="p">(</span><span class="n">u_long</span> <span class="n">aprom_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_bad_srom</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">short</span>   <span class="n">srom_rd</span><span class="p">(</span><span class="n">u_long</span> <span class="n">address</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">srom_latch</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">address</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">srom_command</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">address</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">srom_address</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">address</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">short</span>   <span class="n">srom_data</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">address</span><span class="p">);</span>
<span class="cm">/*static void    srom_busy(u_int command, u_long address);*/</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">sendto_srom</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">getfrom_srom</span><span class="p">(</span><span class="n">u_long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">srom_map_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">srom_infoleaf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">srom_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">srom_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">mii_rd</span><span class="p">(</span><span class="n">u_char</span> <span class="n">phyreg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">mii_wr</span><span class="p">(</span><span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">phyreg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">mii_rdata</span><span class="p">(</span><span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">mii_wdata</span><span class="p">(</span><span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">mii_ta</span><span class="p">(</span><span class="n">u_long</span> <span class="n">rw</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">mii_swap</span><span class="p">(</span><span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">mii_address</span><span class="p">(</span><span class="n">u_char</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">sendto_mii</span><span class="p">(</span><span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">getfrom_mii</span><span class="p">(</span><span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">mii_get_oui</span><span class="p">(</span><span class="n">u_char</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">mii_get_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">SetMulticastFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">get_hw_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">srom_repair</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">test_bad_enet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">an_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span>    <span class="o">*</span><span class="n">build_setup_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">disable_ast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span>    <span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">gep_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">gep_wr</span><span class="p">(</span><span class="n">s32</span> <span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">yawn</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_parse_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_dbg_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_dbg_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_dbg_srom</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_srom</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">de4x5_dbg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">de4x5_strncmp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21041_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21140_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21142_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">dc21143_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">type0_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">type1_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">type2_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">type3_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">type4_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">type5_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">compact_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">** Note now that module autoprobing is allowed under EISA and PCI. The</span>
<span class="cm">** IRQ lines will not be auto-detected; instead I&#39;ll rely on the BIOSes</span>
<span class="cm">** to &quot;do the right thing&quot;.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="o">=</span><span class="mh">0x0</span><span class="p">;</span><span class="cm">/* EDIT THIS LINE FOR YOUR CONFIGURATION IF NEEDED        */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">de4x5_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dec_only</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;de4x5 I/O base address&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">de4x5_debug</span><span class="p">,</span> <span class="s">&quot;de4x5 debug mask&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dec_only</span><span class="p">,</span> <span class="s">&quot;de4x5 probe only for Digital boards (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;de4x5 full duplex and media type settings; see de4x5.c for details&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">** List the SROM infoleaf functions and chipsets</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">InfoLeaf</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">chipset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">InfoLeaf</span> <span class="n">infoleaf_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">DC21041</span><span class="p">,</span> <span class="n">dc21041_infoleaf</span><span class="p">},</span>
    <span class="p">{</span><span class="n">DC21140</span><span class="p">,</span> <span class="n">dc21140_infoleaf</span><span class="p">},</span>
    <span class="p">{</span><span class="n">DC21142</span><span class="p">,</span> <span class="n">dc21142_infoleaf</span><span class="p">},</span>
    <span class="p">{</span><span class="n">DC21143</span><span class="p">,</span> <span class="n">dc21143_infoleaf</span><span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define INFOLEAF_SIZE ARRAY_SIZE(infoleaf_array)</span>

<span class="cm">/*</span>
<span class="cm">** List the SROM info block functions</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">dc_infoblock</span><span class="p">[])(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">type0_infoblock</span><span class="p">,</span>
    <span class="n">type1_infoblock</span><span class="p">,</span>
    <span class="n">type2_infoblock</span><span class="p">,</span>
    <span class="n">type3_infoblock</span><span class="p">,</span>
    <span class="n">type4_infoblock</span><span class="p">,</span>
    <span class="n">type5_infoblock</span><span class="p">,</span>
    <span class="n">compact_infoblock</span>
<span class="p">};</span>

<span class="cp">#define COMPACT (ARRAY_SIZE(dc_infoblock) - 1)</span>

<span class="cm">/*</span>
<span class="cm">** Miscellaneous defines...</span>
<span class="cm">*/</span>
<span class="cp">#define RESET_DE4X5 {\</span>
<span class="cp">    int i;\</span>
<span class="cp">    i=inl(DE4X5_BMR);\</span>
<span class="cp">    mdelay(1);\</span>
<span class="cp">    outl(i | BMR_SWR, DE4X5_BMR);\</span>
<span class="cp">    mdelay(1);\</span>
<span class="cp">    outl(i, DE4X5_BMR);\</span>
<span class="cp">    mdelay(1);\</span>
<span class="cp">    for (i=0;i&lt;5;i++) {inl(DE4X5_BMR); mdelay(1);}\</span>
<span class="cp">    mdelay(1);\</span>
<span class="cp">}</span>

<span class="cp">#define PHY_HARD_RESET {\</span>
<span class="cp">    outl(GEP_HRST, DE4X5_GEP);           </span><span class="cm">/* Hard RESET the PHY dev. */</span><span class="cp">\</span>
<span class="cp">    mdelay(1);                           </span><span class="cm">/* Assert for 1ms */</span><span class="cp">\</span>
<span class="cp">    outl(0x00, DE4X5_GEP);\</span>
<span class="cp">    mdelay(2);                           </span><span class="cm">/* Wait for 2ms */</span><span class="cp">\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">de4x5_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">de4x5_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">de4x5_close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_start_xmit</span>	<span class="o">=</span> <span class="n">de4x5_queue_pkt</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_get_stats</span>	<span class="o">=</span> <span class="n">de4x5_get_stats</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_do_ioctl</span>	<span class="o">=</span> <span class="n">de4x5_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_change_mtu</span>	<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_set_mac_address</span><span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">de4x5_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">iobase</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">DE4X5_NAME_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">gendev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

    <span class="cm">/* Ensure we&#39;re not sleeping */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">EISA</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">WAKEUP</span><span class="p">,</span> <span class="n">PCI_CFPM</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span> <span class="p">(</span><span class="n">gendev</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CFDA_PSM</span><span class="p">,</span> <span class="n">WAKEUP</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

    <span class="n">RESET_DE4X5</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STS_TS</span> <span class="o">|</span> <span class="n">STS_RS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>                       <span class="cm">/* Hardware could not reset */</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">    ** Now find out what kind of DC21040/DC21041/DC21140 board we have.</span>
<span class="cm">    */</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">PCI</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PCI_signature</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">EISA_signature</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">gendev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>                     <span class="cm">/* Not found a board signature */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s: %s at 0x%04lx&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">gendev</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">get_hw_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;, h/w address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      which has an Ethernet PROM CRC error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span> <span class="o">=</span> <span class="n">GEP_INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span> <span class="o">=</span> <span class="n">GEP_SLNK</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span> <span class="o">=</span> <span class="n">GEP_SLNK</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">gendev</span> <span class="o">=</span> <span class="n">gendev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">de4x5_ast</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">de4x5_parse_params</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** Choose correct autosensing in case someone messed up</span>
<span class="cm">	*/</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="o">==</span><span class="n">DC21040</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span><span class="o">&amp;</span><span class="n">TP_NW</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="o">==</span><span class="n">DC21041</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span><span class="o">&amp;</span><span class="n">BNC_AUI</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span><span class="s">&quot;%s (%s)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">gendev</span><span class="p">));</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">NUM_RX_DESC</span> <span class="o">+</span> <span class="n">NUM_TX_DESC</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_desc</span><span class="p">);</span>
<span class="cp">#if defined(__alpha__) || defined(__powerpc__) || defined(CONFIG_SPARC) || defined(DE4X5_DO_MEMCPY)</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">+=</span> <span class="n">RX_BUFF_SZ</span> <span class="o">*</span> <span class="n">NUM_RX_DESC</span> <span class="o">+</span> <span class="n">DE4X5_ALIGN</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">gendev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	** Set up the RX descriptor ring (Intels)</span>
<span class="cm">	** Allocate contiguous receive buffers, long word aligned (Alphas)</span>
<span class="cm">	*/</span>
<span class="cp">#if !defined(__alpha__) &amp;&amp; !defined(__powerpc__) &amp;&amp; !defined(CONFIG_SPARC) &amp;&amp; !defined(DE4X5_DO_MEMCPY)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">des1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RX_BUFF_SZ</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Dummy entry */</span>
	<span class="p">}</span>

<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_rx_bufs</span><span class="p">;</span>

		<span class="n">dma_rx_bufs</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span> <span class="o">+</span> <span class="p">(</span><span class="n">NUM_RX_DESC</span> <span class="o">+</span> <span class="n">NUM_TX_DESC</span><span class="p">)</span>
		      	<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_desc</span><span class="p">);</span>
		<span class="n">dma_rx_bufs</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_rx_bufs</span> <span class="o">+</span> <span class="n">DE4X5_ALIGN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DE4X5_ALIGN</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bufs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">long</span><span class="p">)(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span>
		      	<span class="o">+</span> <span class="n">NUM_TX_DESC</span><span class="p">)</span> <span class="o">+</span> <span class="n">DE4X5_ALIGN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DE4X5_ALIGN</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">des1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RX_BUFF_SZ</span><span class="p">);</span>
	    		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_rx_bufs</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">RX_BUFF_SZ</span><span class="p">);</span>
	    		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Dummy entry */</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span> <span class="o">=</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span> <span class="o">=</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>

	<span class="cm">/* Write the end of list marker to the descriptor lists */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">des1</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RD_RER</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">des1</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TD_TER</span><span class="p">);</span>

	<span class="cm">/* Tell the adapter where the TX/RX rings are located. */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span><span class="p">,</span> <span class="n">DE4X5_RRBA</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_desc</span><span class="p">),</span>
	     <span class="n">DE4X5_TRBA</span><span class="p">);</span>

	<span class="cm">/* Initialise the IRQ mask and Enable/Disable */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">IMR_RIM</span> <span class="o">|</span> <span class="n">IMR_TIM</span> <span class="o">|</span> <span class="n">IMR_TUM</span> <span class="o">|</span> <span class="n">IMR_UNM</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_en</span>   <span class="o">=</span> <span class="n">IMR_NIM</span> <span class="o">|</span> <span class="n">IMR_AIM</span><span class="p">;</span>

	<span class="cm">/* Create a loopback packet frame for later media probing */</span>
	<span class="n">create_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">));</span>

	<span class="cm">/* Check if the RX overflow bug needs testing for */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cfrv</span> <span class="o">&amp;</span> <span class="mh">0x000000fe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ovf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialise the SROM pointers if possible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">INITIALISED</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">srom_infoleaf_info</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	        <span class="n">dma_free_coherent</span> <span class="p">(</span><span class="n">gendev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">srom_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CLOSED</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	** Check for an MII interface</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="n">DC21040</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="n">DC21041</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">mii_get_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      and requires IRQ%d (provided by %s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">PCI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PCI BIOS&quot;</span> <span class="o">:</span> <span class="s">&quot;EISA CNFG&quot;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_VERSION</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* The DE4X5-specific entries in the device structure. */</span>
    <span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gendev</span><span class="p">);</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">de4x5_netdev_ops</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Fill in the generic fields of the device structure. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">register_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
	    <span class="n">dma_free_coherent</span> <span class="p">(</span><span class="n">gendev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Let the adapter sleep to save power */</span>
    <span class="n">yawn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLEEP</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">omr</span><span class="p">;</span>

    <span class="cm">/* Allocate the RX buffers */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de4x5_alloc_rx_buff</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_free_rx_buffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">    ** Wake up the adapter</span>
<span class="cm">    */</span>
    <span class="n">yawn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAKEUP</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">    ** Re-initialize the DE4X5...</span>
<span class="cm">    */</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">de4x5_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">de4x5_dbg_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">de4x5_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		                                     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;de4x5_open(): Requested IRQ%d is busy - attemping FAST/SHARE...&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">de4x5_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			                             <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">              Cannot get IRQ- reconfigure your hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">disable_ast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">de4x5_free_rx_buffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">de4x5_free_tx_buffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">yawn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLEEP</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CLOSED</span><span class="p">;</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">              Succeeded, but you should reconfigure your hardware to avoid this.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WARNING: there may be IRQ related problems in heavily loaded systems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">UNMASK_INTERRUPTS</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>

    <span class="n">START_DE4X5</span><span class="p">;</span>

    <span class="n">de4x5_setup_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_OPEN</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sts:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">bmr:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_BMR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">imr:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_IMR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">omr:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sisr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sicr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SICR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">strr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STRR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sigr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SIGR</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Initialize the DE4X5 operating conditions. NB: a chip problem with the</span>
<span class="cm">** DC21140 requires using perfect filtering mode for that chip. Since I can&#39;t</span>
<span class="cm">** see why I&#39;d want &gt; 14 multicast addresses, I have changed all chips to use</span>
<span class="cm">** the perfect filtering mode. Keep the DMA burst length at 8: there seems</span>
<span class="cm">** to be data corruption problems if it is larger (UDP errors seen from a</span>
<span class="cm">** ttcp source).</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Lock out other processes whilst setting up the hardware */</span>
    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">de4x5_sw_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="cm">/* Autoconfigure the connected port */</span>
    <span class="n">autoconf_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">bmr</span><span class="p">,</span> <span class="n">omr</span><span class="p">;</span>

    <span class="cm">/* Select the MII or SRL port now and RESET the MAC */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_SDP</span> <span class="o">|</span> <span class="n">OMR_PS</span> <span class="o">|</span> <span class="n">OMR_HBD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_SDP</span> <span class="o">|</span> <span class="n">OMR_TTM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">    ** Set the programmable burst length to 8 longwords for all the DC21140</span>
<span class="cm">    ** Fasternet chips and 4 longwords for all others: DMA errors result</span>
<span class="cm">    ** without these values. Cache align 16 long.</span>
<span class="cm">    */</span>
    <span class="n">bmr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="o">==</span><span class="n">DC21140</span> <span class="o">?</span> <span class="n">PBL_8</span> <span class="o">:</span> <span class="n">PBL_4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DESC_SKIP_LEN</span> <span class="o">|</span> <span class="n">DE4X5_CACHE_ALIGN</span><span class="p">;</span>
    <span class="n">bmr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span><span class="o">==</span><span class="n">DC2114x</span> <span class="o">?</span> <span class="n">BMR_RML</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">bmr</span><span class="p">,</span> <span class="n">DE4X5_BMR</span><span class="p">);</span>

    <span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_PR</span><span class="p">;</span>             <span class="cm">/* Turn off promiscuous mode */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">omr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">OMR_SDP</span> <span class="o">|</span> <span class="n">OMR_SB</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_f</span> <span class="o">=</span> <span class="n">PERFECT</span><span class="p">;</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span><span class="p">,</span> <span class="n">DE4X5_RRBA</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_desc</span><span class="p">),</span>
	 <span class="n">DE4X5_TRBA</span><span class="p">);</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">R_OWN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">barrier</span><span class="p">();</span>

    <span class="cm">/* Build the setup frame depending on filtering mode */</span>
    <span class="n">SetMulticastFilter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">load_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">,</span> <span class="n">PERFECT_F</span><span class="o">|</span><span class="n">TD_SET</span><span class="o">|</span><span class="n">SETUP_FRAME_LEN</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="o">|</span><span class="n">OMR_ST</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>

    <span class="cm">/* Poll for setup frame completion (adapter interrupts are disabled now) */</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">500</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>       <span class="cm">/* Up to 500ms delay */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>                        <span class="cm">/* Stop everything! */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Setup frame timed out, status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Writes a socket buffer address to the next available transmit descriptor.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">de4x5_queue_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span>                   <span class="cm">/* Cannot send for now */</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_LOCKED</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">    ** Clean out the TX ring asynchronously to interrupts - sometimes the</span>
<span class="cm">    ** interrupts are lost by delayed descriptor status updates relative to</span>
<span class="cm">    ** the irq assertion, especially with a busy PCI bus.</span>
<span class="cm">    */</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">de4x5_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="cm">/* Test if cache is already locked - requeue skb if so */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_LOCKED</span><span class="p">;</span>

    <span class="cm">/* Transmit descriptor ring full or stale skb */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_putb_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>          <span class="cm">/* Requeue the buffer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">de4x5_put_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_TX</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: transmit busy, lost media or stale skb found:</span><span class="se">\n</span><span class="s">  STS:%08x</span><span class="se">\n</span><span class="s">  tbusy:%d</span><span class="se">\n</span><span class="s">  IMR:%08x</span><span class="se">\n</span><span class="s">  OMR:%08x</span><span class="se">\n</span><span class="s"> Stale skb: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">),</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_IMR</span><span class="p">),</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">),</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* If we already have stuff queued locally, use that first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_put_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	    <span class="n">skb</span> <span class="o">=</span> <span class="n">de4x5_get_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">load_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">TD_IC</span> <span class="o">|</span> <span class="n">TD_LS</span> <span class="o">|</span> <span class="n">TD_FS</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
 	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">POLL_DEMAND</span><span class="p">,</span> <span class="n">DE4X5_TPD</span><span class="p">);</span><span class="cm">/* Start the TX */</span>

	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>         <span class="cm">/* Another pkt may be queued */</span>
	    <span class="p">}</span>
	    <span class="n">skb</span> <span class="o">=</span> <span class="n">de4x5_get_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="n">de4x5_putb_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** The DE4X5 interrupt handler.</span>
<span class="cm">**</span>
<span class="cm">** I/O Read/Writes through intermediate PCI bridges are never &#39;posted&#39;,</span>
<span class="cm">** so that the asserted interrupt always has some real data to work with -</span>
<span class="cm">** if these I/O accesses are ever changed to memory accesses, ensure the</span>
<span class="cm">** STS write is read immediately to complete the transaction if the adapter</span>
<span class="cm">** is not on bus 0. Lost interrupts can still occur when the PCI bus load</span>
<span class="cm">** is high and descriptor status bits cannot be set before the associated</span>
<span class="cm">** interrupt is asserted and this routine entered.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">de4x5_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">imr</span><span class="p">,</span> <span class="n">omr</span><span class="p">,</span> <span class="n">sts</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="n">DISABLE_IRQs</span><span class="p">;</span>                        <span class="cm">/* Ensure non re-entrancy */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">MASK_INTERRUPTS</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">))</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Re-entering the interrupt handler.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">limit</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">limit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">);</span>            <span class="cm">/* Read IRQ status */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">DE4X5_STS</span><span class="p">);</span>            <span class="cm">/* Reset the board interrupts */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span><span class="cm">/* All done */</span>
	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STS_RI</span> <span class="o">|</span> <span class="n">STS_RU</span><span class="p">))</span>     <span class="cm">/* Rx interrupt (packet[s] arrived) */</span>
	  <span class="n">de4x5_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STS_TI</span> <span class="o">|</span> <span class="n">STS_TU</span><span class="p">))</span>     <span class="cm">/* Tx interrupt (packet sent) */</span>
	  <span class="n">de4x5_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_LNF</span><span class="p">)</span> <span class="p">{</span>             <span class="cm">/* TP Link has failed */</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IMR_LFM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_UNF</span><span class="p">)</span> <span class="p">{</span>             <span class="cm">/* Transmit underrun */</span>
	    <span class="n">de4x5_txur</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_SE</span><span class="p">)</span> <span class="p">{</span>              <span class="cm">/* Bus Error */</span>
	    <span class="n">STOP_DE4X5</span><span class="p">;</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Fatal bus error occurred, sts=%#8x, device stopped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
	    <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Load the TX ring with any locally stored packets */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_queue_pkt</span><span class="p">(</span><span class="n">de4x5_get_cache</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">UNMASK_INTERRUPTS</span><span class="p">;</span>
    <span class="n">ENABLE_IRQs</span><span class="p">;</span>
    <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">status</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">;</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span>
	                                                    <span class="n">entry</span><span class="o">=</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ovf</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_MFC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MFC_FOCM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">de4x5_rx_ovfc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_FS</span><span class="p">)</span> <span class="p">{</span>                 <span class="cm">/* Remember the start of frame */</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_LS</span><span class="p">)</span> <span class="p">{</span>                 <span class="cm">/* Valid frame status */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_ES</span><span class="p">)</span> <span class="p">{</span>	      <span class="cm">/* There was an error. */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>        <span class="cm">/* Update the error stats. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RD_RF</span> <span class="o">|</span> <span class="n">RD_TL</span><span class="p">))</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_CE</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_OF</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_TL</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_RF</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">rx_runt_frames</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_CS</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">rx_collision</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_DB</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">rx_dribble</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_OF</span><span class="p">)</span>           <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">rx_overflow</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                          <span class="cm">/* A valid frame received */</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">)</span>
					                            <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">de4x5_alloc_rx_buff</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Insufficient memory; nuking packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			                                            <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">de4x5_dbg_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

		    <span class="cm">/* Push up the protocol stack */</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
		    <span class="n">de4x5_local_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		    <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		    <span class="cm">/* Update stats */</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
 		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>

	    <span class="cm">/* Change buffer ownership for this frame, back to the adapter */</span>
	    <span class="k">for</span> <span class="p">(;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span><span class="o">!=</span><span class="n">entry</span><span class="p">;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span><span class="o">=</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">R_OWN</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	    <span class="p">}</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">R_OWN</span><span class="p">);</span>
	    <span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	** Update entry information</span>
<span class="cm">	*/</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">de4x5_free_tx_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buf</span><span class="p">),</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">des1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TD_TBS1</span><span class="p">,</span>
		     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Buffer sent - check for TX buffer errors.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">status</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span> <span class="n">entry</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                     <span class="cm">/* Buffer not sent yet */</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mh">0x7fffffff</span><span class="p">)</span> <span class="p">{</span>    <span class="cm">/* Not setup frame */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_ES</span><span class="p">)</span> <span class="p">{</span>             <span class="cm">/* An error happened */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_NC</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_LC</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_UF</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_EC</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">excessive_collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_DE</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TX_PKT_PENDING</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">outl</span><span class="p">(</span><span class="n">POLL_DEMAND</span><span class="p">,</span> <span class="n">DE4X5_TPD</span><span class="p">);</span><span class="cm">/* Restart a stalled TX */</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                      <span class="cm">/* Packet sent */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="cm">/* Update the collision counter */</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_EC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span>
				                      <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_CC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>

	    <span class="cm">/* Free the buffer. */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	    	<span class="n">de4x5_free_tx_buff</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update all the pointers */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Any resources available? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span>
	    <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
	    <span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_ast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">srom_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21041</span><span class="p">)</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21040_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_tick</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">)</span>
		<span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">dt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_txur</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">omr</span><span class="p">;</span>

    <span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="n">OMR_SF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="o">==</span><span class="n">DC21041</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="o">==</span><span class="n">DC21040</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">omr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OMR_ST</span><span class="o">|</span><span class="n">OMR_SR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_TS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="n">OMR_TR</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">OMR_TR</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">omr</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">omr</span> <span class="o">|=</span> <span class="n">OMR_SF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">|</span> <span class="n">OMR_ST</span> <span class="o">|</span> <span class="n">OMR_SR</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_rx_ovfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">omr</span><span class="p">;</span>

    <span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_SR</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_RS</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">].</span><span class="n">status</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">R_OWN</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">imr</span><span class="p">,</span> <span class="n">omr</span><span class="p">;</span>

    <span class="n">disable_ast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_CLOSE</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Shutting down ethercard, status was %8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">    ** We stop the DE4X5 here... mask interrupts and stop TX &amp; RX</span>
<span class="cm">    */</span>
    <span class="n">DISABLE_IRQs</span><span class="p">;</span>
    <span class="n">STOP_DE4X5</span><span class="p">;</span>

    <span class="cm">/* Free the associated irq */</span>
    <span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CLOSED</span><span class="p">;</span>

    <span class="cm">/* Free any socket buffers */</span>
    <span class="n">de4x5_free_rx_buffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">de4x5_free_tx_buffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="cm">/* Put the adapter to sleep to save power */</span>
    <span class="n">yawn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLEEP</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">de4x5_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_MFC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MFC_OVFL</span> <span class="o">|</span> <span class="n">MFC_CNTR</span><span class="p">));</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_local_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pkt_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">DE4X5_PKT_STAT_SZ</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">DE4X5_PKT_BIN_SZ</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	    <span class="n">i</span> <span class="o">=</span> <span class="n">DE4X5_PKT_STAT_SZ</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">broadcast</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">unicast</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>       <span class="cm">/* Duplicates stats.rx_packets */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Reset counters */</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Removes the TD_IC flag from previous descriptor to improve TX performance.</span>
<span class="cm">** If the flag is changed on a descriptor that is being read by the hardware,</span>
<span class="cm">** I assume PCI transaction ordering will mean you are either successful or</span>
<span class="cm">** just miss asserting the change to the hardware. Anyway you&#39;re messing with</span>
<span class="cm">** a descriptor you don&#39;t own, but this shouldn&#39;t kill the chip provided</span>
<span class="cm">** the descriptor register is read only to the hardware.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">load_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">?</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">dma_addr_t</span> <span class="n">buf_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TD_TBS1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf_dma</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">].</span><span class="n">des1</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TD_TER</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">].</span><span class="n">des1</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">des1</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">TD_IC</span><span class="p">);</span>
    <span class="n">barrier</span><span class="p">();</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">T_OWN</span><span class="p">);</span>
    <span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Set or clear the multicast filter for this adaptor.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="cm">/* First, double check that the adapter is open */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OPEN</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>         <span class="cm">/* set promiscuous mode */</span>
	    <span class="n">u32</span> <span class="n">omr</span><span class="p">;</span>
	    <span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>
	    <span class="n">omr</span> <span class="o">|=</span> <span class="n">OMR_PR</span><span class="p">;</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">SetMulticastFilter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">load_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">,</span> <span class="n">TD_IC</span> <span class="o">|</span> <span class="n">PERFECT_F</span> <span class="o">|</span> <span class="n">TD_SET</span> <span class="o">|</span>
			                                <span class="n">SETUP_FRAME_LEN</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>

	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">POLL_DEMAND</span><span class="p">,</span> <span class="n">DE4X5_TPD</span><span class="p">);</span>       <span class="cm">/* Start the TX */</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Calculate the hash code and update the logical address filter</span>
<span class="cm">** from a list of ethernet multicast addresses.</span>
<span class="cm">** Little endian crc one liner from Matt Thomas, DEC.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SetMulticastFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">byte</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">hashcode</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">omr</span><span class="p">,</span> <span class="n">crc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addrs</span><span class="p">;</span>

    <span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>
    <span class="n">omr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OMR_PR</span> <span class="o">|</span> <span class="n">OMR_PM</span><span class="p">);</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">build_setup_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ALL</span><span class="p">);</span>        <span class="cm">/* Build the basic frame */</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">omr</span> <span class="o">|=</span> <span class="n">OMR_PM</span><span class="p">;</span>                       <span class="cm">/* Pass all multicasts */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_f</span> <span class="o">==</span> <span class="n">HASH_PERF</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* Hash Filtering */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">hashcode</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="n">HASH_BITS</span><span class="p">;</span>  <span class="cm">/* hashcode is 9 LSb of CRC */</span>

		<span class="n">byte</span> <span class="o">=</span> <span class="n">hashcode</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>        <span class="cm">/* bit[3-8] -&gt; byte in filter */</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hashcode</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span><span class="cm">/* bit[0-2] -&gt; bit in byte */</span>

		<span class="n">byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>                  <span class="cm">/* calc offset into setup frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">byte</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                 <span class="cm">/* Perfect filtering */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">addrs</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="n">addrs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">pa</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EISA</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">de4x5_irq</span><span class="p">[]</span> <span class="o">=</span> <span class="n">EISA_ALLOWED_IRQ_LIST</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">de4x5_eisa_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">irq</span><span class="p">,</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">vendor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="n">edev</span> <span class="o">=</span> <span class="n">to_eisa_device</span> <span class="p">(</span><span class="n">gendev</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">edev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span> <span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">DE4X5_EISA_TOTAL_SIZE</span><span class="p">,</span> <span class="s">&quot;de4x5&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DE4X5_EISA_IO_PORTS</span><span class="p">,</span>
			     <span class="n">DE4X5_EISA_TOTAL_SIZE</span><span class="p">,</span> <span class="s">&quot;de4x5&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_reg_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_reg_2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cfid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">inl</span><span class="p">(</span><span class="n">PCI_CFID</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cfrv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">inl</span><span class="p">(</span><span class="n">PCI_CFRV</span><span class="p">);</span>
	<span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffff00</span><span class="p">;</span>
	<span class="n">vendor</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">cfid</span><span class="p">;</span>

	<span class="cm">/* Read the EISA Configuration Registers */</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EISA_REG0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ER0_INTL</span> <span class="o">|</span> <span class="n">ER0_INTT</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ALPHA</span>
	<span class="cm">/* Looks like the Jensen firmware (rev 2.2) doesn&#39;t really</span>
<span class="cm">	 * care about the EISA configuration, and thus doesn&#39;t</span>
<span class="cm">	 * configure the PLX bridge properly. Oh well... Simply mimic</span>
<span class="cm">	 * the EISA config file to sort it out. */</span>

	<span class="cm">/* EISA REG1: Assert DecChip 21040 HW Reset */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">ER1_IAM</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EISA_REG1</span><span class="p">);</span>
	<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* EISA REG1: Deassert DecChip 21040 HW Reset */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">ER1_IAM</span><span class="p">,</span> <span class="n">EISA_REG1</span><span class="p">);</span>
	<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* EISA REG3: R/W Burst Transfer Enable */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">ER3_BWE</span> <span class="o">|</span> <span class="n">ER3_BRE</span><span class="p">,</span> <span class="n">EISA_REG3</span><span class="p">);</span>

	<span class="cm">/* 32_bit slave/master, Preempt Time=23 bclks, Unlatched Interrupt */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">ER0_BSW</span> <span class="o">|</span> <span class="n">ER0_BMW</span> <span class="o">|</span> <span class="n">ER0_EPT</span> <span class="o">|</span> <span class="n">regval</span><span class="p">,</span> <span class="n">EISA_REG0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">de4x5_irq</span><span class="p">[(</span><span class="n">regval</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_DC2114x</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">device</span> <span class="o">=</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cfrv</span> <span class="o">&amp;</span> <span class="n">CFRV_RN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DC2114x_BRK</span> <span class="o">?</span> <span class="n">DC21142</span> <span class="o">:</span> <span class="n">DC21143</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">EISA</span><span class="p">;</span>

	<span class="cm">/* Write the PCI Configuration Registers */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">PCI_COMMAND_IO</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">,</span> <span class="n">PCI_CFCS</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00006000</span><span class="p">,</span> <span class="n">PCI_CFLT</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">PCI_CBIO</span><span class="p">);</span>

	<span class="n">DevicePresent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EISA_APROM</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="n">de4x5_hw_init</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">gendev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">release_reg_2:</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DE4X5_EISA_IO_PORTS</span><span class="p">,</span> <span class="n">DE4X5_EISA_TOTAL_SIZE</span><span class="p">);</span>
 <span class="nl">release_reg_1:</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">DE4X5_EISA_TOTAL_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">de4x5_eisa_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">unregister_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DE4X5_EISA_IO_PORTS</span><span class="p">,</span> <span class="n">DE4X5_EISA_TOTAL_SIZE</span><span class="p">);</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">DE4X5_EISA_TOTAL_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_device_id</span> <span class="n">de4x5_eisa_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s">&quot;DEC4250&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 0 is the board name index... */</span>
        <span class="p">{</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">eisa</span><span class="p">,</span> <span class="n">de4x5_eisa_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_driver</span> <span class="n">de4x5_eisa_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">de4x5_eisa_ids</span><span class="p">,</span>
        <span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;de4x5&quot;</span><span class="p">,</span>
                <span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">de4x5_eisa_probe</span><span class="p">,</span>
                <span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span> <span class="p">(</span><span class="n">de4x5_eisa_remove</span><span class="p">),</span>
        <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">eisa</span><span class="p">,</span> <span class="n">de4x5_eisa_ids</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="cm">/*</span>
<span class="cm">** This function searches the current bus (which is &gt;0) for a DECchip with an</span>
<span class="cm">** SROM, so that in multiport cards that have one SROM shared between multiple</span>
<span class="cm">** DECchips, we can find the base SROM irrespective of the BIOS scan direction.</span>
<span class="cm">** For single port cards this is a time waster...</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">srom_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">pb</span><span class="p">;</span>
    <span class="n">u_short</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">u_int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                     <span class="cm">/* Clear upper 32 bits in Alphas */</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">this_dev</span><span class="p">;</span>

    <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">this_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">vendor</span> <span class="o">=</span> <span class="n">this_dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">this_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is_DC21040</span> <span class="o">||</span> <span class="n">is_DC21041</span> <span class="o">||</span> <span class="n">is_DC21140</span> <span class="o">||</span> <span class="n">is_DC2114x</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* Get the chip configuration revision register */</span>
	<span class="n">pb</span> <span class="o">=</span> <span class="n">this_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* Set the device number information */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">this_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">pb</span><span class="p">;</span>

	<span class="cm">/* Set the chipset information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_DC2114x</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">device</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="n">CFRV_RN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DC2114x_BRK</span>
		      <span class="o">?</span> <span class="n">DC21142</span> <span class="o">:</span> <span class="n">DC21143</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="cm">/* Get the board I/O address (64 bits on sparc64) */</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">this_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Fetch the IRQ to be used */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">this_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* Check if I/O accesses are enabled */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">this_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* Search for a valid SROM attached to this DECchip */</span>
	<span class="n">DevicePresent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DE4X5_APROM</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">j</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="o">*</span><span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">SROM_HWADD</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">6</span> <span class="o">*</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">last</span><span class="p">.</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	    <span class="n">last</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">pb</span><span class="p">;</span>
	    <span class="n">last</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">SROM_HWADD</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** PCI bus I/O device probe</span>
<span class="cm">** NB: PCI I/O accesses and Bus Mastering are enabled by the PCI BIOS, not</span>
<span class="cm">** the driver. Some PCI BIOS&#39;s, pre V2.1, need the slot + features to be</span>
<span class="cm">** enabled by the user first in the set up utility. Hence we just check for</span>
<span class="cm">** enabled features and silently ignore the card if they&#39;re not.</span>
<span class="cm">**</span>
<span class="cm">** STOP PRESS: Some BIOS&#39;s __require__ the driver to enable the bus mastering</span>
<span class="cm">** bit. Here, check for I/O accesses and then set BM. If you put the card in</span>
<span class="cm">** a non BM slot, you&#39;re on your own (and complain to the PC vendor that your</span>
<span class="cm">** PC doesn&#39;t conform to the PCI standard)!</span>
<span class="cm">**</span>
<span class="cm">** This function is only compatible with the *latest* 2.1.x kernels. For 2.0.x</span>
<span class="cm">** kernels use the V0.535[n] drivers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">de4x5_pci_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">pb</span><span class="p">,</span> <span class="n">pbus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">dnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Clear upper 32 bits in Alphas */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="n">dev_num</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">pb</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* probe a single PCI device */</span>
		<span class="n">pbus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)(</span><span class="n">io</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)(</span><span class="n">io</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pbus</span> <span class="o">!=</span> <span class="n">pb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dnum</span> <span class="o">!=</span> <span class="n">dev_num</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is_DC21040</span> <span class="o">||</span> <span class="n">is_DC21041</span> <span class="o">||</span> <span class="n">is_DC21140</span> <span class="o">||</span> <span class="n">is_DC2114x</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Ok, the device seems to be for us. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_enable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">disable_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">PCI</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Search for an SROM on this bus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">!=</span> <span class="n">pb</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">pb</span><span class="p">;</span>
	    <span class="n">srom_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get the chip configuration revision register */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cfrv</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="cm">/* Set the device number information */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">dev_num</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">pb</span><span class="p">;</span>

	<span class="cm">/* Set the chipset information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_DC2114x</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">device</span> <span class="o">=</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cfrv</span> <span class="o">&amp;</span> <span class="n">CFRV_RN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DC2114x_BRK</span> <span class="o">?</span> <span class="n">DC21142</span> <span class="o">:</span> <span class="n">DC21143</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="cm">/* Get the board I/O address (64 bits on sparc64) */</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Fetch the IRQ to be used */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if I/O accesses and Bus Mastering are enabled */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#ifdef __powerpc__</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">status</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
	    <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	    <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __powerpc__ */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">status</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
	    <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	    <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the latency timer for values &gt;= 0x60 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DevicePresent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DE4X5_APROM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span> <span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">DE4X5_PCI_TOTAL_SIZE</span><span class="p">,</span> <span class="s">&quot;de4x5&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">de4x5_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">release:</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">DE4X5_PCI_TOTAL_SIZE</span><span class="p">);</span>
 <span class="nl">free_dev:</span>
	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">disable_dev:</span>
	<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">de4x5_pci_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">unregister_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">DE4X5_PCI_TOTAL_SIZE</span><span class="p">);</span>
	<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">de4x5_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DEC_TULIP</span><span class="p">,</span>
          <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DEC_TULIP_PLUS</span><span class="p">,</span>
          <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DEC_TULIP_FAST</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DEC_21142</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
        <span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">de4x5_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;de4x5&quot;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">de4x5_pci_tbl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">de4x5_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span> <span class="p">(</span><span class="n">de4x5_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">** Auto configure the media here rather than setting the port at compile</span>
<span class="cm">** time. This routine is called by de4x5_init() and when a loss of media is</span>
<span class="cm">** detected (excessive collisions, loss of carrier, no carrier or link fail</span>
<span class="cm">** [TP] or no recent receive activity) to check whether the user has been</span>
<span class="cm">** sneaky and changed the port on us.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">autoconf_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">disable_ast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>                     <span class="cm">/* Bogus last media */</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_MFC</span><span class="p">);</span>                         <span class="cm">/* Zero the lost frames counter */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">de4x5_ast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Autoconfigure the media when using the DC21040. AUI cannot be distinguished</span>
<span class="cm">** from BNC as the port has a jumper to set thick or thin wire. When set for</span>
<span class="cm">** BNC, the BNC port will indicate activity if it&#39;s not terminated correctly.</span>
<span class="cm">** The only way to test for that is to place a loopback packet onto the</span>
<span class="cm">** network and watch for errors. Since we&#39;re messing with the interrupt mask</span>
<span class="cm">** register, disable the board interrupts and do not allow any more packets to</span>
<span class="cm">** be queued to the hardware. Re-enable everything only when the media is</span>
<span class="cm">** found.</span>
<span class="cm">** I may have to &quot;age out&quot; locally queued packets so that the higher layer</span>
<span class="cm">** timeouts don&#39;t effectively duplicate packets on the network.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21040_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">imr</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">INIT</span>:
	<span class="n">DISABLE_IRQs</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">de4x5_save_skbs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">TP</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">BNC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">BNC_AUI</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC_AUI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">EXT_SIA</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">EXT_SIA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21040_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TP</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21040_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8f01</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">BNC_AUI</span><span class="p">,</span>
		                                         <span class="n">TP_SUSPECT</span><span class="p">,</span> <span class="n">test_tp</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TP_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">TP</span><span class="p">,</span> <span class="n">test_tp</span><span class="p">,</span> <span class="n">dc21040_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC</span>:
    <span class="k">case</span> <span class="n">AUI</span>:
    <span class="k">case</span> <span class="n">BNC_AUI</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21040_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8f09</span><span class="p">,</span> <span class="mh">0x0705</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">EXT_SIA</span><span class="p">,</span>
		                                  <span class="n">BNC_AUI_SUSPECT</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC_AUI_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">BNC_AUI</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">,</span> <span class="n">dc21040_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">EXT_SIA</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21040_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3041</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span>
		                              <span class="n">NC</span><span class="p">,</span> <span class="n">EXT_SIA_SUSPECT</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">EXT_SIA_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">EXT_SIA</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">,</span> <span class="n">dc21040_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">NC</span>:
	<span class="cm">/* default to TP for all */</span>
	<span class="n">reset_init_sia</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8f01</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21040_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr13</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr14</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csr15</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">next_state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspect_state</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">linkBad</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span>:
	<span class="n">reset_init_sia</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">csr13</span><span class="p">,</span> <span class="n">csr14</span><span class="p">,</span> <span class="n">csr15</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">++</span><span class="p">;</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">1</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">linkBad</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">linkBad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">linkBad</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linkBad</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">suspect_state</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_suspect_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prev_state</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">),</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">asfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">linkBad</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">prev_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">++</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">asfn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">2</span>:
	<span class="n">linkBad</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkBad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">linkBad</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">linkBad</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">--</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">prev_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Autoconfigure the media when using the DC21041. AUI needs to be tested</span>
<span class="cm">** before BNC, because the BNC port will indicate activity if it&#39;s not</span>
<span class="cm">** terminated correctly. The only way to test for that is to place a loopback</span>
<span class="cm">** packet onto the network and watch for errors. Since we&#39;re messing with</span>
<span class="cm">** the interrupt mask register, disable the board interrupts and do not allow</span>
<span class="cm">** any more packets to be queued to the hardware. Re-enable everything only</span>
<span class="cm">** when the media is found.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21041_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">sts</span><span class="p">,</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">imr</span><span class="p">,</span> <span class="n">omr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">INIT</span>:
	<span class="n">DISABLE_IRQs</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">de4x5_save_skbs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>          <span class="cm">/* Save non transmitted skb&#39;s */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">TP_NW</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>            <span class="cm">/* On chip auto negotiation is broken */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">TP</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">BNC</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUI</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TP_NW</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span><span class="cm">/* Set up full duplex for the autonegotiate */</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">|</span> <span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">irqs</span> <span class="o">=</span> <span class="n">STS_LNF</span> <span class="o">|</span> <span class="n">STS_LNP</span><span class="p">;</span>
	<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">IMR_LFM</span> <span class="o">|</span> <span class="n">IMR_LPM</span><span class="p">;</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">test_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mh">0xef01</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mi">2400</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_LNP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ANS</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ANS</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">irqs</span> <span class="o">=</span> <span class="n">STS_LNP</span><span class="p">;</span>
	    <span class="n">irq_mask</span> <span class="o">=</span> <span class="n">IMR_LPM</span><span class="p">;</span>
	    <span class="n">sts</span> <span class="o">=</span> <span class="n">test_ans</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_LNP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ANS_SUSPECT</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ANS_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">ANS</span><span class="p">,</span> <span class="n">test_tp</span><span class="p">,</span> <span class="n">dc21041_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TP</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>          <span class="cm">/* Set up half duplex for TP */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">irqs</span> <span class="o">=</span> <span class="n">STS_LNF</span> <span class="o">|</span> <span class="n">STS_LNP</span><span class="p">;</span>
	    <span class="n">irq_mask</span> <span class="o">=</span> <span class="n">IMR_LFM</span> <span class="o">|</span> <span class="n">IMR_LPM</span><span class="p">;</span>
	    <span class="n">sts</span> <span class="o">=</span> <span class="n">test_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mh">0xef01</span><span class="p">,</span> <span class="mh">0xff3f</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mi">2400</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_LNP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISR_NRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI</span><span class="p">;</span>       <span class="cm">/* Non selected port activity */</span>
		    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP_SUSPECT</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TP_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">TP</span><span class="p">,</span> <span class="n">test_tp</span><span class="p">,</span> <span class="n">dc21041_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">AUI</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>          <span class="cm">/* Set up half duplex for AUI */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">sts</span> <span class="o">=</span> <span class="n">test_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mh">0xef09</span><span class="p">,</span> <span class="mh">0xf73d</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISR_SRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI_SUSPECT</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">AUI_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">AUI</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">,</span> <span class="n">dc21041_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC</span>:
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>          <span class="cm">/* Set up half duplex for BNC */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">sts</span> <span class="o">=</span> <span class="n">test_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mh">0xef09</span><span class="p">,</span> <span class="mh">0xf73d</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">++</span><span class="p">;</span>             <span class="cm">/* Ensure media connected */</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21041_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sts</span> <span class="o">=</span> <span class="n">ping_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
		    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		    <span class="p">}</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC_SUSPECT</span><span class="p">;</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">BNC</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">,</span> <span class="n">dc21041_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">NC</span>:
	<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>    <span class="cm">/* Set up full duplex for the autonegotiate */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">|</span> <span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="n">reset_init_sia</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xef01</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span><span class="cm">/* Initialise the SIA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Some autonegotiation chips are broken in that they do not return the</span>
<span class="cm">** acknowledge bit (anlpa &amp; MII_ANLPA_ACK) in the link partner advertisement</span>
<span class="cm">** register, except at the first power up negotiation.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21140m_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ana</span><span class="p">,</span> <span class="n">anlpa</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">slnk</span><span class="p">,</span> <span class="n">sr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">imr</span><span class="p">,</span> <span class="n">omr</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">INIT</span>:
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DISABLE_IRQs</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">de4x5_save_skbs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>          <span class="cm">/* Save non transmitted skb&#39;s */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_reset_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">next_tick</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srom_map_media</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
		    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">gep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">==</span> <span class="n">ANS</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">ana</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">ana</span> <span class="o">|</span> <span class="n">MII_ANA_CSMA</span><span class="p">;</span>
		    <span class="n">mii_wr</span><span class="p">(</span><span class="n">ana</span><span class="p">,</span> <span class="n">MII_ANA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">MII_SR_ASSC</span><span class="p">;</span>     <span class="cm">/* Fake out the MII speed set */</span>
		<span class="n">SET_10Mb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">_100Mb</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">_10Mb</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			            <span class="p">((</span><span class="n">sr</span><span class="o">=</span><span class="n">is_anc_capable</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MII_SR_ANC</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">ana</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sr</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MII_ANA_TAF</span><span class="p">)</span> <span class="o">|</span> <span class="n">MII_ANA_CSMA</span><span class="p">);</span>
		    <span class="n">ana</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="o">~</span><span class="n">MII_ANA_FDAM</span><span class="p">);</span>
		    <span class="n">mii_wr</span><span class="p">(</span><span class="n">ana</span><span class="p">,</span> <span class="n">MII_ANA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ANS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_100_up</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ANS</span>:
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_wr</span><span class="p">(</span><span class="n">MII_CR_ASSE</span> <span class="o">|</span> <span class="n">MII_CR_RAN</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">cr</span> <span class="o">=</span> <span class="n">test_mii_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">MII_CR_RAN</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">cr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
	    <span class="k">if</span> <span class="p">((</span><span class="n">sr</span><span class="o">=</span><span class="n">test_mii_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MII_SR</span><span class="p">,</span> <span class="n">MII_SR_ASSC</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="p">{</span>                         <span class="cm">/* Success! */</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">MII_SR_ASSC</span><span class="p">;</span>
		    <span class="n">anlpa</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ANLPA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		    <span class="n">ana</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ANA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANLPA_RF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">cap</span> <span class="o">=</span> <span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANLPA_TAF</span> <span class="o">&amp;</span> <span class="n">ana</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MII_ANA_100M</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ana</span> <span class="o">&amp;</span> <span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANA_FDAM</span> <span class="o">&amp;</span> <span class="n">MII_ANA_100M</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MII_ANA_10M</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ana</span> <span class="o">&amp;</span> <span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANA_FDAM</span> <span class="o">&amp;</span> <span class="n">MII_ANA_10M</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
			<span class="p">}</span>
		    <span class="p">}</span>
		<span class="p">}</span>                       <span class="cm">/* Auto Negotiation failed to finish */</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>                           <span class="cm">/* Auto Negotiation failed to start */</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">SPD_DET</span>:                              <span class="cm">/* Choose 10Mb/s or 100Mb/s */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">id</span> <span class="o">?</span> <span class="n">MII_SR_LKS</span> <span class="o">:</span>
		                                  <span class="p">(</span><span class="o">~</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GEP_LNP</span><span class="p">));</span>
	    <span class="n">SET_100Mb_PDET</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">slnk</span> <span class="o">=</span> <span class="n">test_for_100Mb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6500</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">slnk</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_100_up</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">is_10_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">_100Mb</span>:                               <span class="cm">/* Set 100Mb/s */</span>
        <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SET_100Mb</span><span class="p">;</span>
	    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_100_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC</span>:
    <span class="k">case</span> <span class="n">AUI</span>:
    <span class="k">case</span> <span class="n">_10Mb</span>:                                <span class="cm">/* Set 10Mb/s */</span>
        <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SET_10Mb</span><span class="p">;</span>
	    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_10_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">&amp;&amp;</span> <span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">NC</span>:
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** This routine may be merged into dc21140m_autoconf() sometime as I&#39;m</span>
<span class="cm">** changing how I figure out the media - but trying to keep it backwards</span>
<span class="cm">** compatible with the de500-xa and de500-aa.</span>
<span class="cm">** Whether it&#39;s BNC, AUI, SYM or MII is sorted out in the infoblock</span>
<span class="cm">** functions and set during de4x5_mac_port() and/or de4x5_reset_phy().</span>
<span class="cm">** This routine just has to figure out whether 10Mb/s or 100Mb/s is</span>
<span class="cm">** active.</span>
<span class="cm">** When autonegotiation is working, the ANS part searches the SROM for</span>
<span class="cm">** the highest common speed (TP) link that both can run and if that can</span>
<span class="cm">** be full duplex. That infoblock is executed and then the link speed set.</span>
<span class="cm">**</span>
<span class="cm">** Only _10Mb and _100Mb are tested here.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc2114x_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">cr</span><span class="p">,</span> <span class="n">anlpa</span><span class="p">,</span> <span class="n">ana</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">imr</span><span class="p">,</span> <span class="n">omr</span><span class="p">,</span> <span class="n">slnk</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">sts</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">INIT</span>:
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DISABLE_IRQs</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	    <span class="n">de4x5_save_skbs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>            <span class="cm">/* Save non transmitted skb&#39;s */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srom_map_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>         <span class="cm">/* Fixed media requested      */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
		    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_reset_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">next_tick</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">_100Mb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">_10Mb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">TP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">BNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">==</span> <span class="n">ANS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		                    <span class="p">((</span><span class="n">sr</span><span class="o">=</span><span class="n">is_anc_capable</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MII_SR_ANC</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">ana</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sr</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MII_ANA_TAF</span><span class="p">)</span> <span class="o">|</span> <span class="n">MII_ANA_CSMA</span><span class="p">);</span>
		    <span class="n">ana</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="o">~</span><span class="n">MII_ANA_FDAM</span><span class="p">);</span>
		    <span class="n">mii_wr</span><span class="p">(</span><span class="n">ana</span><span class="p">,</span> <span class="n">MII_ANA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ANS</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ANS</span>:
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_wr</span><span class="p">(</span><span class="n">MII_CR_ASSE</span> <span class="o">|</span> <span class="n">MII_CR_RAN</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">cr</span> <span class="o">=</span> <span class="n">test_mii_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">MII_CR_RAN</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">cr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
	    <span class="n">sr</span> <span class="o">=</span> <span class="n">test_mii_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MII_SR</span><span class="p">,</span> <span class="n">MII_SR_ASSC</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="p">{</span>                         <span class="cm">/* Success! */</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">MII_SR_ASSC</span><span class="p">;</span>
		    <span class="n">anlpa</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ANLPA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		    <span class="n">ana</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ANA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANLPA_RF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">cap</span> <span class="o">=</span> <span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANLPA_TAF</span> <span class="o">&amp;</span> <span class="n">ana</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MII_ANA_100M</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ana</span> <span class="o">&amp;</span> <span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANA_FDAM</span> <span class="o">&amp;</span> <span class="n">MII_ANA_100M</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MII_ANA_10M</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ana</span> <span class="o">&amp;</span> <span class="n">anlpa</span> <span class="o">&amp;</span> <span class="n">MII_ANA_FDAM</span> <span class="o">&amp;</span> <span class="n">MII_ANA_10M</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
			<span class="p">}</span>
		    <span class="p">}</span>
		<span class="p">}</span>                       <span class="cm">/* Auto Negotiation failed to finish */</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>                           <span class="cm">/* Auto Negotiation failed to start  */</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">AUI</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>   <span class="cm">/* Set up half duplex for AUI        */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">sts</span> <span class="o">=</span> <span class="n">test_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISR_SRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI_SUSPECT</span><span class="p">;</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">AUI_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">AUI</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">,</span> <span class="n">dc2114x_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC</span>:
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>          <span class="cm">/* Set up half duplex for BNC */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OMR_FDX</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">sts</span> <span class="o">=</span> <span class="n">test_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">irqs</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span><span class="o">++</span><span class="p">;</span>             <span class="cm">/* Ensure media connected */</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sts</span> <span class="o">=</span> <span class="n">ping_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">local_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
		    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		    <span class="p">}</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC_SUSPECT</span><span class="p">;</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BNC_SUSPECT</span>:
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">de4x5_suspect_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">BNC</span><span class="p">,</span> <span class="n">ping_media</span><span class="p">,</span> <span class="n">dc2114x_autoconf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">SPD_DET</span>:                              <span class="cm">/* Choose 10Mb/s or 100Mb/s */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">srom_map_media</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
	      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	      <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">_100Mb</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">if</span> <span class="p">((</span><span class="n">slnk</span> <span class="o">=</span> <span class="n">test_for_100Mb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6500</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		  <span class="k">return</span> <span class="n">slnk</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
	      <span class="p">}</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">wait_for_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">SPD_DET</span><span class="p">;</span>
		  <span class="k">return</span> <span class="n">PDET_LINK_WAIT</span><span class="p">;</span>
	      <span class="p">}</span>
	  <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ANS</span><span class="p">)</span> <span class="p">{</span>           <span class="cm">/* Do MII parallel detection */</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
	      <span class="p">}</span>
	      <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">_100Mb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_100_up</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">_10Mb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">TP</span><span class="p">)</span> <span class="o">||</span>
		       <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">BNC</span><span class="p">)</span>   <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">AUI</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		      <span class="n">is_10_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
	      <span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
	      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">_10Mb</span>:
        <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SET_10Mb</span><span class="p">;</span>
	    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_10_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">&amp;&amp;</span> <span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">_100Mb</span>:
        <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SET_100Mb</span><span class="p">;</span>
	    <span class="n">de4x5_init_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autosense</span> <span class="o">==</span> <span class="n">AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_100_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
		    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Huh?: media:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">srom_autoconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_fn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** This mapping keeps the original media codes and FDX flag unchanged.</span>
<span class="cm">** While it isn&#39;t strictly necessary, it helps me for the moment...</span>
<span class="cm">** The early return avoids a media state / SROM media space clash.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">srom_map_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">SROM_10BASETF</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">SROM_10BASET</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">SROM_10BASE2</span>:
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">SROM_10BASE5</span>:
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">AUI</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">SROM_100BASETF</span>:
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">SROM_100BASET</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">SROM_100BASET4</span>:
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">SROM_100BASEFF</span>:
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">SROM_100BASEF</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">ANS</span>:
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ANS</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="nl">default:</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Bad media code [%d] detected in SROM!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	                                                  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_init_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>          <span class="cm">/* Stop scrolling media messages */</span>
    <span class="p">}</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">de4x5_rst_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">de4x5_setup_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">POLL_DEMAND</span><span class="p">,</span> <span class="n">DE4X5_TPD</span><span class="p">);</span>

    <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** General PHY reset function. Some MII devices don&#39;t reset correctly</span>
<span class="cm">** since their MII address pins can float at voltages that are dependent</span>
<span class="cm">** on the signal pin use. Do a double reset to ensure a reset.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_reset_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">rst</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">rst</span><span class="p">);</span>
		    <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">rst</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span> <span class="p">{</span>          <span class="cm">/* Type 5 infoblock reset */</span>
		    <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">);</span>
		    <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PHY_HARD_RESET</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">mii_wr</span><span class="p">(</span><span class="n">MII_CR_RST</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">next_tick</span> <span class="o">=</span> <span class="n">test_mii_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">MII_CR_RST</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PHY_HARD_RESET</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr13</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr14</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr15</span><span class="p">,</span> <span class="n">s32</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">sts</span><span class="p">,</span> <span class="n">csr12</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msec</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>      <span class="cm">/* Already done if by SROM, else dc2104[01] */</span>
	    <span class="n">reset_init_sia</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">csr13</span><span class="p">,</span> <span class="n">csr14</span><span class="p">,</span> <span class="n">csr15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set up the interrupt mask */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">,</span> <span class="n">DE4X5_IMR</span><span class="p">);</span>

	<span class="cm">/* clear all pending interrupts */</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">DE4X5_STS</span><span class="p">);</span>

	<span class="cm">/* clear csr12 NRA and SRA bits */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21041</span><span class="p">)</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">csr12</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">);</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">csr12</span><span class="p">,</span> <span class="n">DE4X5_SISR</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">sts</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">irqs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_tp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sisr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msec</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sisr</span> <span class="o">=</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SISR_LKF</span> <span class="o">|</span> <span class="n">SISR_NCR</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sisr</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sisr</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sisr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Samples the 100Mb Link State Signal. The sample interval is important</span>
<span class="cm">** because too fast a rate can give erroneous results and confuse the</span>
<span class="cm">** speed sense algorithm.</span>
<span class="cm">*/</span>
<span class="cp">#define SAMPLE_INTERVAL 500  </span><span class="cm">/* ms */</span><span class="cp"></span>
<span class="cp">#define SAMPLE_DELAY    2000 </span><span class="cm">/* ms */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_for_100Mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">gep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span><span class="o">==</span><span class="n">DC2114x</span><span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span><span class="n">GEP_SLNK</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msec</span><span class="o">/</span><span class="n">SAMPLE_INTERVAL</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&gt;</span> <span class="n">SAMPLE_DELAY</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">msec</span> <span class="o">-</span> <span class="n">SAMPLE_DELAY</span><span class="p">)</span><span class="o">/</span><span class="n">SAMPLE_INTERVAL</span><span class="p">;</span>
	    <span class="n">gep</span> <span class="o">=</span> <span class="n">SAMPLE_DELAY</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
	    <span class="k">return</span> <span class="n">gep</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msec</span><span class="o">/</span><span class="n">SAMPLE_INTERVAL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">id</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">gep</span> <span class="o">=</span> <span class="n">is_100_up</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">is_spd_100</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">gep</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GEP_SLNK</span> <span class="o">|</span> <span class="n">GEP_LNP</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gep</span> <span class="o">&amp;</span> <span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">gep</span> <span class="o">=</span> <span class="n">SAMPLE_INTERVAL</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">gep</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wait_for_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">**</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_mii_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pol</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">test</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msec</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">reg</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">((</span><span class="n">u_char</span><span class="p">)</span><span class="n">reg</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
    <span class="n">test</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">^</span> <span class="p">(</span><span class="n">pol</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">test</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_spd_100</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">spd</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">spd</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">spd</span><span class="p">.</span><span class="n">reg</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	<span class="n">spd</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">spd</span> <span class="o">^</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">spd</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="n">spd</span> <span class="o">&amp;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">spd</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>                      <span class="cm">/* de500-xa */</span>
	<span class="n">spd</span> <span class="o">=</span> <span class="p">((</span><span class="o">~</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">GEP_SLNK</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="p">)</span>
	    <span class="k">return</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21143</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">~</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SISR_LS100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spd</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span> <span class="o">^</span> <span class="p">(</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span><span class="p">)))</span> <span class="o">|</span>
	          <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">spd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_100_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Double read for sticky bits &amp; temporary drops */</span>
	<span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_SR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_SR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MII_SR_LKS</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* de500-xa */</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">~</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">GEP_SLNK</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="p">)</span>
	    <span class="k">return</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21143</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">~</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SISR_LS100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span><span class="o">^</span><span class="p">(</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span><span class="p">)))</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_10_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Double read for sticky bits &amp; temporary drops */</span>
	<span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_SR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_SR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MII_SR_LKS</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* de500-xa */</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">~</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">GEP_LNP</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="p">)</span>
	    <span class="k">return</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="o">~</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SISR_LS10</span><span class="p">)</span><span class="o">:</span>
		    <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span>	<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span><span class="o">^</span><span class="p">(</span><span class="n">gep_rd</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span><span class="p">)))</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linkOK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_anc_capable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_SR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISR_LPN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Send a packet onto the media and watch for send errors that indicate the</span>
<span class="cm">** media is bad or unconnected.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ping_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sisr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msec</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>                <span class="cm">/* Remember the ring position */</span>
	<span class="n">load_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="n">TD_LS</span> <span class="o">|</span> <span class="n">TD_FS</span> <span class="o">|</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">),</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">POLL_DEMAND</span><span class="p">,</span> <span class="n">DE4X5_TPD</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">sisr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">sisr</span> <span class="o">&amp;</span> <span class="n">SISR_NCR</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	<span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">sisr</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">sisr</span> <span class="o">&amp;</span> <span class="n">SISR_NCR</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">T_OWN</span> <span class="o">|</span> <span class="n">TD_ES</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">sisr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">sisr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sisr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** This function does 2 things: on Intels it kmalloc&#39;s another buffer to</span>
<span class="cm">** replace the one about to be passed up. On Alpha&#39;s it kmallocs a buffer</span>
<span class="cm">** into which the packet is copied.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">de4x5_alloc_rx_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="cp">#if !defined(__alpha__) &amp;&amp; !defined(__powerpc__) &amp;&amp; !defined(CONFIG_SPARC) &amp;&amp; !defined(DE4X5_DO_MEMCPY)</span>
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE802_3_SZ</span> <span class="o">+</span> <span class="n">DE4X5_ALIGN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">DE4X5_ALIGN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DE4X5_ALIGN</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="n">skb_reserve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#else</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OPEN</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Fake out the open */</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">skb_reserve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	                               <span class="cm">/* Align */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span><span class="p">)</span> <span class="p">{</span>                          <span class="cm">/* Wrapped buffer */</span>
	<span class="kt">short</span> <span class="n">tlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_BUFF_SZ</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">tlen</span><span class="p">),</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bufs</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">*</span> <span class="n">RX_BUFF_SZ</span><span class="p">,</span><span class="n">tlen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">len</span><span class="o">-</span><span class="n">tlen</span><span class="p">),</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">,</span><span class="n">len</span><span class="o">-</span><span class="n">tlen</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                           <span class="cm">/* Linear buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">len</span><span class="p">),</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bufs</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">*</span> <span class="n">RX_BUFF_SZ</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_free_rx_buffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* Dummy entry */</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_free_tx_buffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
	    <span class="n">de4x5_free_tx_buff</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Unload the locally queued packets */</span>
    <span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** When a user pulls a connection, the DECchip can end up in a</span>
<span class="cm">** &#39;running - waiting for end of transmission&#39; state. This means that we</span>
<span class="cm">** have to perform a chip soft reset to ensure that we can synchronize</span>
<span class="cm">** the hardware and software and make any media probes using a loopback</span>
<span class="cm">** packet meaningful.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_save_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">omr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">save_cnt</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">STOP_DE4X5</span><span class="p">;</span>
	<span class="n">de4x5_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>                          <span class="cm">/* Flush any sent skb&#39;s */</span>
	<span class="n">de4x5_free_tx_buffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">de4x5_cache_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DE4X5_SAVE_STATE</span><span class="p">);</span>
	<span class="n">de4x5_sw_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">de4x5_cache_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DE4X5_RESTORE_STATE</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">save_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">START_DE4X5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_rst_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">omr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">save_cnt</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">STOP_DE4X5</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span><span class="p">,</span> <span class="n">DE4X5_RRBA</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_rings</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_desc</span><span class="p">),</span>
	     <span class="n">DE4X5_TRBA</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">R_OWN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">save_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">START_DE4X5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_cache_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">DE4X5_SAVE_STATE</span>:
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr0</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_BMR</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr6</span> <span class="o">=</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">OMR_ST</span> <span class="o">|</span> <span class="n">OMR_SR</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr7</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_IMR</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">DE4X5_RESTORE_STATE</span>:
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr0</span><span class="p">,</span> <span class="n">DE4X5_BMR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr6</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr7</span><span class="p">,</span> <span class="n">DE4X5_IMR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	    <span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">reset_init_sia</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span><span class="p">,</span>
			                                      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_put_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_putb_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">de4x5_get_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Check the Auto Negotiation State. Return OK when a link pass interrupt</span>
<span class="cm">** is received and the auto-negotiation status is NWAY OK.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_ans</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">s32</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">s32</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">sts</span><span class="p">,</span> <span class="n">ans</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msec</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">,</span> <span class="n">DE4X5_IMR</span><span class="p">);</span>

	<span class="cm">/* clear all pending interrupts */</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">DE4X5_STS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISR_ANS</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">irqs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ans</span> <span class="o">^</span> <span class="n">ANS_NWOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">|</span> <span class="n">TIMER_CB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_setup_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">imr</span><span class="p">,</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OMR_SR</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* Only unmask if TX/RX is enabled */</span>
	<span class="n">imr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UNMASK_IRQs</span><span class="p">;</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">);</span>        <span class="cm">/* Reset any pending (stale) interrupts */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">DE4X5_STS</span><span class="p">);</span>
	<span class="n">ENABLE_IRQs</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_init_sia</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr13</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr14</span><span class="p">,</span> <span class="n">s32</span> <span class="n">csr15</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="n">RESET_SIA</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">rst</span><span class="p">);</span>
	    <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">gep</span><span class="p">);</span>
	    <span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DE4X5_SICR</span><span class="p">);</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">csr15</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span><span class="p">;</span>
	    <span class="n">csr14</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span><span class="p">;</span>
	    <span class="n">csr13</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span><span class="p">;</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">csr15</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span><span class="p">,</span> <span class="n">DE4X5_SIGR</span><span class="p">);</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">csr15</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span><span class="p">,</span> <span class="n">DE4X5_SIGR</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">csr15</span><span class="p">,</span> <span class="n">DE4X5_SIGR</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">csr14</span><span class="p">,</span> <span class="n">DE4X5_STRR</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">csr13</span><span class="p">,</span> <span class="n">DE4X5_SICR</span><span class="p">);</span>

    <span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Create a loopback ethernet packet</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">create_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>             <span class="cm">/* Use this source address */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>             <span class="cm">/* Use this destination address */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                              <span class="cm">/* Packet length (2 bytes) */</span>
    <span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Look for a particular board name in the EISA configuration space</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">EISA_signature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">siglen</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">de4x5_signatures</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">;</span>

    <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">edev</span> <span class="o">=</span> <span class="n">to_eisa_device</span> <span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">edev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">siglen</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">strcpy</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">de4x5_signatures</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	    <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>                         <span class="cm">/* return the device name string */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Look for a particular board name in the PCI configuration space</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">PCI_signature</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">siglen</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">de4x5_signatures</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DE434/5&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                           <span class="cm">/* Search for a DEC name in the SROM */</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">26</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">siglen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">de4x5_signatures</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">siglen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dec_only</span><span class="p">)</span> <span class="p">{</span>
	    <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                        <span class="cm">/* Use chip name to avoid confusion */</span>
	    <span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DC21040&quot;</span> <span class="o">:</span>
			   <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21041</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DC21041&quot;</span> <span class="o">:</span>
			    <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DC21140&quot;</span> <span class="o">:</span>
			     <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21142</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DC21142&quot;</span> <span class="o">:</span>
			      <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21143</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DC21143&quot;</span> <span class="o">:</span> <span class="s">&quot;UNKNOWN&quot;</span>
			     <span class="p">)))))));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="n">DC21041</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>             <span class="cm">/* card is not recognisably DEC */</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Set up the Ethernet PROM counter to the start of the Ethernet address on</span>
<span class="cm">** the DC21040, else  read the SROM for the other chips.</span>
<span class="cm">** The SROM may not be present in a multi-MAC card, so first read the</span>
<span class="cm">** MAC address and check for a bad address. If there is a bad one then exit</span>
<span class="cm">** immediately with the prior srom contents intact (the h/w address will</span>
<span class="cm">** be fixed up later).</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">DevicePresent</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">aprom_addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">EISA</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">enet_addr_rst</span><span class="p">(</span><span class="n">aprom_addr</span><span class="p">);</span> <span class="cm">/* Reset Ethernet Address ROM Pointer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">aprom_addr</span><span class="p">);</span>       <span class="cm">/* Reset Ethernet Address ROM Pointer */</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                           <span class="cm">/* Read new srom */</span>
	<span class="n">u_short</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">SROM_HWADD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">tmp</span> <span class="o">=</span> <span class="n">srom_rd</span><span class="p">(</span><span class="n">aprom_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SROM_HWADD</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	    <span class="n">j</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>	<span class="cm">/* for check for 0:0:0:0:0:0 or ff:ff:ff:ff:ff:ff */</span>
	    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">*</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* could get 0 only from all-0 and 3 * 0xffff only from all-1 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_srom</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">tmp</span> <span class="o">=</span> <span class="n">srom_rd</span><span class="p">(</span><span class="n">aprom_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	    <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">de4x5_dbg_srom</span><span class="p">((</span><span class="k">struct</span> <span class="n">de4x5_srom</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Since the write on the Enet PROM register doesn&#39;t seem to reset the PROM</span>
<span class="cm">** pointer correctly (at least on my DE425 EISA card), this routine should do</span>
<span class="cm">** it...from depca.c.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">enet_addr_rst</span><span class="p">(</span><span class="n">u_long</span> <span class="n">aprom_addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">union</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
	    <span class="n">u32</span> <span class="n">a</span><span class="p">;</span>
	    <span class="n">u32</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">llsig</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">Sig</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">dev</span><span class="p">;</span>
    <span class="kt">short</span> <span class="n">sigLength</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">s8</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">dev</span><span class="p">.</span><span class="n">llsig</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ETH_PROM_SIG</span><span class="p">;</span>
    <span class="n">dev</span><span class="p">.</span><span class="n">llsig</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ETH_PROM_SIG</span><span class="p">;</span>
    <span class="n">sigLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">sigLength</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">PROBE_LENGTH</span><span class="o">+</span><span class="n">sigLength</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">aprom_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">Sig</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>    <span class="cm">/* track signature */</span>
	    <span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                     <span class="cm">/* lost signature; begin search again */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">dev</span><span class="p">.</span><span class="n">Sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>  <span class="cm">/* rare case.... */</span>
		<span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** For the bad status case and no SROM, then add one to the previous</span>
<span class="cm">** address. However, need to add one backwards in case we have 0xff</span>
<span class="cm">** as one or more of the bytes. Only the last 3 bytes should be checked</span>
<span class="cm">** as the first three are invariant - assigned to an organisation.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_hw_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">broken</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_short</span> <span class="n">j</span><span class="p">,</span><span class="n">chksum</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">broken</span> <span class="o">=</span> <span class="n">de4x5_bad_srom</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">k</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="n">k</span><span class="o">-=</span><span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">PCI</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_APROM</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_APROM</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">broken</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">.</span><span class="n">ieee_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">.</span><span class="n">ieee_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">broken</span> <span class="o">==</span> <span class="n">SMC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">broken</span> <span class="o">==</span> <span class="n">ACCTON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EISA_APROM</span><span class="p">));</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	    <span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EISA_APROM</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="n">k</span><span class="o">-=</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">PCI</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_APROM</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="n">chksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	    <span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_APROM</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="n">chksum</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">!=</span> <span class="n">chksum</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dec_only</span><span class="p">))</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">chksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">EISA_APROM</span><span class="p">);</span>
	<span class="n">chksum</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">EISA_APROM</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">!=</span> <span class="n">chksum</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dec_only</span><span class="p">))</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* If possible, try to fix a broken card - SMC only so far */</span>
    <span class="n">srom_repair</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">broken</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
    <span class="cm">/*</span>
<span class="cm">    ** If the address starts with 00 a0, we have to bit-reverse</span>
<span class="cm">    ** each byte of the address.</span>
<span class="cm">    */</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	    <span class="p">{</span>
		    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x33</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

    <span class="cm">/* Test for a bad enet address */</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">test_bad_enet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Test for enet addresses in the first 32 bytes. The built-in strncmp</span>
<span class="cm">** didn&#39;t seem to work here...?</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_bad_srom</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">enet_det</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">de4x5_strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">enet_det</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">de4x5_strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="o">+</span><span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">enet_det</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SMC</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ACCTON</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_strncmp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">;</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="o">++</span> <span class="o">-</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">srom_repair</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">SMC</span>:
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_srom</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">.</span><span class="n">ieee_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">.</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srom_repair_info</span><span class="p">[</span><span class="n">SMC</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Assume that the irq&#39;s do not follow the PCI spec - this is seems</span>
<span class="cm">** to be true so far (2 for 2).</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_bad_enet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">tmp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mh">0x5fa</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">last</span><span class="p">.</span><span class="n">chipset</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">==</span> <span class="n">last</span><span class="p">.</span><span class="n">bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">last</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">ETH_ALEN</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">last</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">an_exception</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">last</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">last</span><span class="p">.</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">;</span>
	<span class="n">last</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">;</span>
	<span class="n">last</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">last</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** List of board exceptions with correctly wired IRQs</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">an_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">.</span><span class="n">sub_vendor_id</span> <span class="o">==</span> <span class="mh">0x00c0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span><span class="p">.</span><span class="n">sub_system_id</span> <span class="o">==</span> <span class="mh">0x95e0</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** SROM Read</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">short</span>
<span class="nf">srom_rd</span><span class="p">(</span><span class="n">u_long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sendto_srom</span><span class="p">(</span><span class="n">SROM_RD</span> <span class="o">|</span> <span class="n">SROM_SR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

    <span class="n">srom_latch</span><span class="p">(</span><span class="n">SROM_RD</span> <span class="o">|</span> <span class="n">SROM_SR</span> <span class="o">|</span> <span class="n">DT_CS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">srom_command</span><span class="p">(</span><span class="n">SROM_RD</span> <span class="o">|</span> <span class="n">SROM_SR</span> <span class="o">|</span> <span class="n">DT_IN</span> <span class="o">|</span> <span class="n">DT_CS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">srom_address</span><span class="p">(</span><span class="n">SROM_RD</span> <span class="o">|</span> <span class="n">SROM_SR</span> <span class="o">|</span> <span class="n">DT_CS</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">srom_data</span><span class="p">(</span><span class="n">SROM_RD</span> <span class="o">|</span> <span class="n">SROM_SR</span> <span class="o">|</span> <span class="n">DT_CS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">srom_latch</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sendto_srom</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">sendto_srom</span><span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="n">DT_CLK</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">sendto_srom</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">srom_command</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">srom_latch</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">srom_latch</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">srom_latch</span><span class="p">((</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">|</span> <span class="n">DT_CS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">srom_address</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">a</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">srom_latch</span><span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="p">((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="n">DT_IN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">getfrom_srom</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span>
<span class="nf">srom_data</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">short</span> <span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sendto_srom</span><span class="p">(</span><span class="n">command</span>  <span class="o">|</span> <span class="n">DT_CLK</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">getfrom_srom</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">sendto_srom</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">sendto_srom</span><span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">word</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">static void</span>
<span class="cm">srom_busy(u_int command, u_long addr)</span>
<span class="cm">{</span>
<span class="cm">   sendto_srom((command &amp; 0x0000ff00) | DT_CS, addr);</span>

<span class="cm">   while (!((getfrom_srom(addr) &gt;&gt; 3) &amp; 0x01)) {</span>
<span class="cm">       mdelay(1);</span>
<span class="cm">   }</span>

<span class="cm">   sendto_srom(command &amp; 0x0000ff00, addr);</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sendto_srom</span><span class="p">(</span><span class="n">u_int</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">getfrom_srom</span><span class="p">(</span><span class="n">u_long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">s32</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">srom_infoleaf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="cm">/* Find the infoleaf decoder function that matches this chipset */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">INFOLEAF_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">infoleaf_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipset</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">INFOLEAF_SIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Cannot find correct chipset for SROM decoding!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	                                                          <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_fn</span> <span class="o">=</span> <span class="n">infoleaf_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fn</span><span class="p">;</span>

    <span class="cm">/* Find the information offset that this function should use */</span>
    <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">19</span><span class="p">);</span>
    <span class="n">p</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="mi">26</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">+=</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useSROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Cannot find correct PCI device [%d] for SROM decoding!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	                                               <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_offset</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** This routine loads any type 1 or 3 MII info into the mii device</span>
<span class="cm">** struct and executes any type 5 code to reset PHY devices for this</span>
<span class="cm">** controller.</span>
<span class="cm">** The info for the MII devices will be valid since the index used</span>
<span class="cm">** will follow the discovery process from MII address 1-31 then 0.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">srom_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_offset</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">count</span><span class="p">;</span>

    <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">|</span> <span class="n">GEP_CTRL</span><span class="p">);</span>
	<span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Block count */</span>
    <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* Jump the infoblocks to find types */</span>
    <span class="k">for</span> <span class="p">(;</span><span class="n">count</span><span class="p">;</span> <span class="o">--</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="n">COMPACT_LEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">type5_infoblock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">type3_infoblock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">type1_infoblock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">p</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** A generic routine that writes GEP control, data and reset information</span>
<span class="cm">** to the GEP register (21140) or csr15 GEP portion (2114[23]).</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">srom_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">?</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">u_short</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="n">DC21140</span><span class="p">)</span> <span class="n">RESET_SIA</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">gep_wr</span><span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="o">==</span><span class="n">DC21140</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span><span class="o">!=</span><span class="mi">5</span><span class="p">)</span> <span class="o">?</span>
		                                   <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">:</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">w</span><span class="o">++</span><span class="p">)),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>                          <span class="cm">/* 2ms per action */</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span><span class="p">,</span> <span class="n">DE4X5_STRR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span><span class="p">,</span> <span class="n">DE4X5_SICR</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Basically this function is a NOP since it will never be called,</span>
<span class="cm">** unless I implement the DC21041 SROM functions. There&#39;s no need</span>
<span class="cm">** since the existing code will be satisfactory for all boards.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21041_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21140_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>

    <span class="cm">/* Read the connection type */</span>
    <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

    <span class="cm">/* GEP control */</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">|</span> <span class="n">GEP_CTRL</span><span class="p">);</span>

    <span class="cm">/* Block count */</span>
    <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21142_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>

    <span class="cm">/* Read the connection type */</span>
    <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

    <span class="cm">/* Block count */</span>
    <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc21143_infoleaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">srom</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoleaf_offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>

    <span class="cm">/* Read the connection type */</span>
    <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

    <span class="cm">/* Block count */</span>
    <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">NC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">de4x5_dbg_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">next_tick</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMER_CB</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** The compact infoblock is only designed for DC21140[A] chips, so</span>
<span class="cm">** we&#39;ll reuse the dc21140m_autoconf function. Non MII media only.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">compact_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">flags</span><span class="p">,</span> <span class="n">csr6</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">COMPACT_LEN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">COMPACT_LEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">COMPACT_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">COMPACT_LEN</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="n">COMPACT</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COMPACT_MC</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">csr6</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">defMedium</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span> <span class="o">=</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_DEF</span> <span class="o">|</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0x71</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** This block describes non MII media for the DC21140[A] only.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">type0_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">flags</span><span class="p">,</span> <span class="n">csr6</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BLOCK0_MC</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">csr6</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">defMedium</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span> <span class="o">=</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_DEF</span> <span class="o">|</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0x71</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* These functions are under construction! */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">type1_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">INITIALISED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">gep</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">?</span> <span class="n">p</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">rst</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">?</span> <span class="n">p</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">mc</span>  <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">ana</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">fdx</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">ttm</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_MII_100</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">=</span> <span class="n">ANS</span><span class="p">;</span>

	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dc21140m_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">type2_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MEDIA_CODE</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXT_FIELD</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span> <span class="o">=</span> <span class="n">CSR13</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span> <span class="o">=</span> <span class="n">CSR14</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span> <span class="o">=</span> <span class="n">CSR15</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span>  <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_SIA</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">type3_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">INITIALISED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MOTO_SROM_BUG</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">gep</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">?</span> <span class="n">p</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">rst</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">?</span> <span class="n">p</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">mc</span>  <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">ana</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">fdx</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">ttm</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">mci</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MOTO_SROM_BUG</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_MII_100</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">=</span> <span class="n">ANS</span><span class="p">;</span>

	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">type4_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">flags</span><span class="p">,</span> <span class="n">csr6</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ibn</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_media</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MEDIA_CODE</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span> <span class="o">=</span> <span class="n">CSR13</span><span class="p">;</span>              <span class="cm">/* Hard coded defaults */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span> <span class="o">=</span> <span class="n">CSR14</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span> <span class="o">=</span> <span class="n">CSR15</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span>  <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">csr6</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBitValid</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">defMedium</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">asPolarity</span> <span class="o">=</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">asBit</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span> <span class="o">=</span> <span class="n">OMR_DEF</span> <span class="o">|</span> <span class="p">((</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0x71</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">de4x5_switch_mac_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dc2114x_autoconf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** This block type provides information for resetting external devices</span>
<span class="cm">** (chips) through the General Purpose Register.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">type5_infoblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">count</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">BLOCK_LEN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Recursively figure out the info blocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="n">COMPACT</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">dc_infoblock</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)](</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Must be initializing to run this code */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">INITIALISED</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">INIT</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rst</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
        <span class="n">srom_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">DE4X5_AUTOSENSE_MS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** MII Read/Write</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_rd</span><span class="p">(</span><span class="n">u_char</span> <span class="n">phyreg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">MII_PREAMBLE</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>   <span class="cm">/* Start of 34 bit preamble...    */</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">MII_PREAMBLE</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>   <span class="cm">/* ...continued                   */</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">MII_STRD</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>        <span class="cm">/* SFD and Read operation         */</span>
    <span class="n">mii_address</span><span class="p">(</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>          <span class="cm">/* PHY address to be accessed     */</span>
    <span class="n">mii_address</span><span class="p">(</span><span class="n">phyreg</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>           <span class="cm">/* PHY Register to read           */</span>
    <span class="n">mii_ta</span><span class="p">(</span><span class="n">MII_STRD</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>              <span class="cm">/* Turn around time - 2 MDC       */</span>

    <span class="k">return</span> <span class="n">mii_rdata</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>              <span class="cm">/* Read data                      */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mii_wr</span><span class="p">(</span><span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">phyreg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">MII_PREAMBLE</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>   <span class="cm">/* Start of 34 bit preamble...    */</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">MII_PREAMBLE</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>   <span class="cm">/* ...continued                   */</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">MII_STWR</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>        <span class="cm">/* SFD and Write operation        */</span>
    <span class="n">mii_address</span><span class="p">(</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>          <span class="cm">/* PHY address to be accessed     */</span>
    <span class="n">mii_address</span><span class="p">(</span><span class="n">phyreg</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>           <span class="cm">/* PHY Register to write          */</span>
    <span class="n">mii_ta</span><span class="p">(</span><span class="n">MII_STWR</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>              <span class="cm">/* Turn around time - 2 MDC       */</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mii_swap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>             <span class="cm">/* Swap data bit ordering         */</span>
    <span class="n">mii_wdata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>           <span class="cm">/* Write data                     */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_rdata</span><span class="p">(</span><span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">getfrom_mii</span><span class="p">(</span><span class="n">MII_MRD</span> <span class="o">|</span> <span class="n">MII_RD</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mii_wdata</span><span class="p">(</span><span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sendto_mii</span><span class="p">(</span><span class="n">MII_MWR</span> <span class="o">|</span> <span class="n">MII_WR</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mii_address</span><span class="p">(</span><span class="n">u_char</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">addr</span> <span class="o">=</span> <span class="n">mii_swap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sendto_mii</span><span class="p">(</span><span class="n">MII_MWR</span> <span class="o">|</span> <span class="n">MII_WR</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mii_ta</span><span class="p">(</span><span class="n">u_long</span> <span class="n">rw</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">MII_STWR</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sendto_mii</span><span class="p">(</span><span class="n">MII_MWR</span> <span class="o">|</span> <span class="n">MII_WR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">sendto_mii</span><span class="p">(</span><span class="n">MII_MWR</span> <span class="o">|</span> <span class="n">MII_WR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">getfrom_mii</span><span class="p">(</span><span class="n">MII_MRD</span> <span class="o">|</span> <span class="n">MII_RD</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>        <span class="cm">/* Tri-state MDIO */</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_swap</span><span class="p">(</span><span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sendto_mii</span><span class="p">(</span><span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="n">j</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="n">MII_MDC</span> <span class="o">|</span> <span class="n">j</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">getfrom_mii</span><span class="p">(</span><span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="n">MII_MDC</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Here&#39;s 3 ways to calculate the OUI from the ID registers.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_get_oui</span><span class="p">(</span><span class="n">u_char</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">    union {</span>
<span class="cm">	u_short reg;</span>
<span class="cm">	u_char breg[2];</span>
<span class="cm">    } a;</span>
<span class="cm">    int i, r2, r3, ret=0;*/</span>
    <span class="kt">int</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">;</span>

    <span class="cm">/* Read r2 and r3 */</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ID0</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ID1</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
                                                <span class="cm">/* SEEQ and Cypress way * /</span>
<span class="cm">    / * Shuffle r2 and r3 * /</span>
<span class="cm">    a.reg=0;</span>
<span class="cm">    r3 = ((r3&gt;&gt;10)|(r2&lt;&lt;6))&amp;0x0ff;</span>
<span class="cm">    r2 = ((r2&gt;&gt;2)&amp;0x3fff);</span>

<span class="cm">    / * Bit reverse r3 * /</span>
<span class="cm">    for (i=0;i&lt;8;i++) {</span>
<span class="cm">	ret&lt;&lt;=1;</span>
<span class="cm">	ret |= (r3&amp;1);</span>
<span class="cm">	r3&gt;&gt;=1;</span>
<span class="cm">    }</span>

<span class="cm">    / * Bit reverse r2 * /</span>
<span class="cm">    for (i=0;i&lt;16;i++) {</span>
<span class="cm">	a.reg&lt;&lt;=1;</span>
<span class="cm">	a.reg |= (r2&amp;1);</span>
<span class="cm">	r2&gt;&gt;=1;</span>
<span class="cm">    }</span>

<span class="cm">    / * Swap r2 bytes * /</span>
<span class="cm">    i=a.breg[0];</span>
<span class="cm">    a.breg[0]=a.breg[1];</span>
<span class="cm">    a.breg[1]=i;</span>

<span class="cm">    return (a.reg&lt;&lt;8)|ret; */</span>                 <span class="cm">/* SEEQ and Cypress way */</span>
<span class="cm">/*    return (r2&lt;&lt;6)|(u_int)(r3&gt;&gt;10); */</span>      <span class="cm">/* NATIONAL and BROADCOM way */</span>
    <span class="k">return</span> <span class="n">r2</span><span class="p">;</span>                                  <span class="cm">/* (I did it) My way */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** The SROM spec forces us to search addresses [1-31 0]. Bummer.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_get_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="cm">/* Search the MII address space for possible PHY devices */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="o">!</span><span class="p">((</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="mi">1</span><span class="p">));</span> <span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">DE4X5_MAX_MII</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="n">n</span><span class="o">++</span><span class="p">;</span>                             <span class="cm">/* Count cycles */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">de4x5_reset_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="cm">/* Wait for reset */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">mii_get_oui</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">65535</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>  <span class="cm">/* Valid ID? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>                  <span class="cm">/* Search PHY table */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">phy_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>    <span class="cm">/* ID match? */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">DE4X5_MAX_PHY</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">DE4X5_MAX_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_table</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">purgatory</span><span class="p">;</span>                    <span class="cm">/* Stop the search */</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">==</span> <span class="n">limit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">DE4X5_MAX_MII</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">DE4X5_MAX_PHY</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">spd</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">GENERIC_REG</span><span class="p">;</span>      <span class="cm">/* ANLPA register         */</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">spd</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">GENERIC_MASK</span><span class="p">;</span>    <span class="cm">/* 100Mb/s technologies   */</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">spd</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">GENERIC_VALUE</span><span class="p">;</span>  <span class="cm">/* TX &amp; T4, H/F Duplex    */</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_cnt</span><span class="o">++</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">++</span><span class="p">;</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Using generic MII device control. If the board doesn&#39;t operate,</span><span class="se">\n</span><span class="s">please mail the following dump to the author:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	    <span class="n">j</span> <span class="o">=</span> <span class="n">de4x5_debug</span><span class="p">;</span>
	    <span class="n">de4x5_debug</span> <span class="o">|=</span> <span class="n">DEBUG_MII</span><span class="p">;</span>
	    <span class="n">de4x5_dbg_mii</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
	    <span class="n">de4x5_debug</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="nl">purgatory:</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>                           <span class="cm">/* Reset the PHY devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">DE4X5_MAX_PHY</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*For each PHY*/</span>
	    <span class="n">mii_wr</span><span class="p">(</span><span class="n">MII_CR_RST</span><span class="p">,</span> <span class="n">MII_CR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">);</span>
	    <span class="k">while</span> <span class="p">(</span><span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_CR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DE4X5_MII</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MII_CR_RST</span><span class="p">);</span>

	    <span class="n">de4x5_dbg_mii</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_cnt</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">useMII</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">build_setup_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">;</span>

    <span class="cm">/* Initialise the setup frame */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SETUP_FRAME_LEN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_f</span> <span class="o">==</span> <span class="n">HASH_PERF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pa</span><span class="o">=</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="o">+</span><span class="n">IMPERF_PA_OFFSET</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                 <span class="cm">/* Host address */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">pa</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span> <span class="o">+</span> <span class="p">(</span><span class="n">HASH_TABLE_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Host address */</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">pa</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Broadcast address */</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0xff</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">pa</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>                     <span class="cm">/* Points to the next entry */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">disable_ast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">de4x5_switch_mac_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">omr</span><span class="p">;</span>

    <span class="n">STOP_DE4X5</span><span class="p">;</span>

    <span class="cm">/* Assert the OMR_PS bit in CSR6 */</span>
    <span class="n">omr</span> <span class="o">=</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">OMR_PS</span> <span class="o">|</span> <span class="n">OMR_HBD</span> <span class="o">|</span> <span class="n">OMR_TTM</span> <span class="o">|</span> <span class="n">OMR_PCS</span> <span class="o">|</span> <span class="n">OMR_SCR</span> <span class="o">|</span>
			                                             <span class="n">OMR_FDX</span><span class="p">));</span>
    <span class="n">omr</span> <span class="o">|=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">infoblock_csr6</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">omr</span> <span class="o">&amp;</span> <span class="n">OMR_PS</span><span class="p">)</span> <span class="n">omr</span> <span class="o">|=</span> <span class="n">OMR_HBD</span><span class="p">;</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>

    <span class="cm">/* Soft Reset */</span>
    <span class="n">RESET_DE4X5</span><span class="p">;</span>

    <span class="cm">/* Restore the GEP - especially for COMPACT and Type 0 Infoblocks */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gepc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">gep_wr</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">gep</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">reset_init_sia</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr13</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr14</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Restore CSR6 */</span>
    <span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>

    <span class="cm">/* Reset CSR8 */</span>
    <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_MFC</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">omr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gep_wr</span><span class="p">(</span><span class="n">s32</span> <span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DE4X5_GEP</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">data</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">csr15</span><span class="p">,</span> <span class="n">DE4X5_SIGR</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gep_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_GEP</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">DC2114x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SIGR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">yawn</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21040</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">DC21140</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">EISA</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">case</span> <span class="n">WAKEUP</span>:
	    <span class="n">outb</span><span class="p">(</span><span class="n">WAKEUP</span><span class="p">,</span> <span class="n">PCI_CFPM</span><span class="p">);</span>
	    <span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>

	  <span class="k">case</span> <span class="n">SNOOZE</span>:
	    <span class="n">outb</span><span class="p">(</span><span class="n">SNOOZE</span><span class="p">,</span> <span class="n">PCI_CFPM</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>

	  <span class="k">case</span> <span class="n">SLEEP</span>:
	    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DE4X5_SICR</span><span class="p">);</span>
	    <span class="n">outb</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">,</span> <span class="n">PCI_CFPM</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">case</span> <span class="n">WAKEUP</span>:
	    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CFDA_PSM</span><span class="p">,</span> <span class="n">WAKEUP</span><span class="p">);</span>
	    <span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>

	  <span class="k">case</span> <span class="n">SNOOZE</span>:
	    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CFDA_PSM</span><span class="p">,</span> <span class="n">SNOOZE</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>

	  <span class="k">case</span> <span class="n">SLEEP</span>:
	    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DE4X5_SICR</span><span class="p">);</span>
	    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CFDA_PSM</span><span class="p">,</span> <span class="n">SLEEP</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_parse_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;eth&quot;</span><span class="p">)))</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;fdx&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;FDX&quot;</span><span class="p">))</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fdx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;autosense&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;AUTOSENSE&quot;</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;TP&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">TP</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;TP_NW&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">TP_NW</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;BNC&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;AUI&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">AUI</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;BNC_AUI&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;10Mb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">_10Mb</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;100Mb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">_100Mb</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;AUTO&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">autosense</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_dbg_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_OPEN</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: de4x5 opening with irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">physical address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Descriptor head addresses:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%8.8lx  0x%8.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">u_long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,(</span><span class="n">u_long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Descriptor addresses:</span><span class="se">\n</span><span class="s">RX: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%8.8lx  &quot;</span><span class="p">,(</span><span class="n">u_long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...0x%8.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">u_long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%8.8lx  &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...0x%8.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Descriptor buffers:</span><span class="se">\n</span><span class="s">RX: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%8.8x  &quot;</span><span class="p">,</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">));</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...0x%8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%8.8x  &quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">));</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...0x%8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Ring size:</span><span class="se">\n</span><span class="s">RX: %d</span><span class="se">\n</span><span class="s">TX: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxRingSize</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_dbg_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_MII</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">MII device address: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII CR:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_CR</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII SR:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_SR</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII ID0: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ID0</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII ID1: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="n">MII_ID1</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="n">BROADCOM_T4</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII ANA: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII ANC: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII 16:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="n">BROADCOM_T4</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII 17:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII 18:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MII 20:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mii_rd</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span><span class="n">DE4X5_MII</span><span class="p">));</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_dbg_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_MEDIA</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: media is %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">NC</span>  <span class="o">?</span> <span class="s">&quot;unconnected, link down or incompatible connection&quot;</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">TP</span>  <span class="o">?</span> <span class="s">&quot;TP&quot;</span> <span class="o">:</span>
		     <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ANS</span> <span class="o">?</span> <span class="s">&quot;TP/Nway&quot;</span> <span class="o">:</span>
		      <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">BNC</span> <span class="o">?</span> <span class="s">&quot;BNC&quot;</span> <span class="o">:</span>
		       <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">AUI</span> <span class="o">?</span> <span class="s">&quot;AUI&quot;</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">BNC_AUI</span> <span class="o">?</span> <span class="s">&quot;BNC/AUI&quot;</span> <span class="o">:</span>
			 <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">EXT_SIA</span> <span class="o">?</span> <span class="s">&quot;EXT SIA&quot;</span> <span class="o">:</span>
			  <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">_100Mb</span>  <span class="o">?</span> <span class="s">&quot;100Mb/s&quot;</span> <span class="o">:</span>
			   <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">_10Mb</span>   <span class="o">?</span> <span class="s">&quot;10Mb/s&quot;</span> <span class="o">:</span>
			    <span class="s">&quot;???&quot;</span>
			    <span class="p">))))))))),</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fdx</span><span class="o">?</span><span class="s">&quot; full duplex.&quot;</span><span class="o">:</span><span class="s">&quot;.&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">c_media</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_dbg_srom</span><span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_srom</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_SROM</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sub-system Vendor ID: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sub_vendor_id</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sub-system ID:        %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sub_system_id</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ID Block CRC:         %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id_block_crc</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SROM version:         %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;# controllers:        %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_controllers</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hardware Address:     %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ieee_addr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CRC checksum:         %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chksum</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%3d %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">+</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">de4x5_dbg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de4x5_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_RX</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;R: %pM &lt;- %pM len/SAP:%02x%02x [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
	       <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
	       <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
	       <span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">len</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">+=</span><span class="mi">16</span><span class="p">,</span> <span class="n">len</span><span class="o">-=</span><span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;    %03x: &quot;</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,(</span><span class="n">u_char</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span>
	  <span class="p">}</span>
	  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Perform IOCTL call functions here. Some are privileged operations and the</span>
<span class="cm">** effective uid is checked in those cases. In the normal course of events</span>
<span class="cm">** this function is only used for my testing.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">de4x5_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">de4x5_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">de4x5_ioctl</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">de4x5_ioctl</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">s32</span> <span class="n">omr</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
	<span class="n">u8</span>  <span class="n">addr</span><span class="p">[</span><span class="mi">144</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">sval</span><span class="p">[</span><span class="mi">72</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">lval</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">DE4X5_GET_HWADDR</span>:           <span class="cm">/* Get the hardware address */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_SET_HWADDR</span>:           <span class="cm">/* Set the hardware address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">build_setup_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PHYS_ADDR_ONLY</span><span class="p">);</span>
	<span class="cm">/* Set up the descriptor and give ownership to the card */</span>
	<span class="n">load_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">,</span> <span class="n">TD_IC</span> <span class="o">|</span> <span class="n">PERFECT_F</span> <span class="o">|</span> <span class="n">TD_SET</span> <span class="o">|</span>
		                                       <span class="n">SETUP_FRAME_LEN</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txRingSize</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">POLL_DEMAND</span><span class="p">,</span> <span class="n">DE4X5_TPD</span><span class="p">);</span>                <span class="cm">/* Start the TX */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>                      <span class="cm">/* Unlock the TX ring */</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_SAY_BOO</span>:              <span class="cm">/* Say &quot;Boo!&quot; to the kernel log file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Boo!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_MCA_EN</span>:               <span class="cm">/* Enable pass all multicast addressing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">omr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="n">omr</span> <span class="o">|=</span> <span class="n">OMR_PM</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">omr</span><span class="p">,</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_GET_STATS</span>:            <span class="cm">/* Get the driver statistics */</span>
    <span class="p">{</span>
        <span class="k">struct</span> <span class="n">pkt_stats</span> <span class="n">statbuf</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">statbuf</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">statbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statbuf</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">DE4X5_CLR_STATS</span>:            <span class="cm">/* Zero out the driver statistics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pktStats</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_GET_OMR</span>:              <span class="cm">/* Get the OMR Register contents */</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_SET_OMR</span>:              <span class="cm">/* Set the OMR Register contents */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DE4X5_OMR</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DE4X5_GET_REG</span>:              <span class="cm">/* Get the DE4X5 Registers */</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STS</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_BMR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_IMR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_OMR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SISR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SICR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_STRR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">DE4X5_SIGR</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">lval</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

<span class="cp">#define DE4X5_DUMP              0x0f </span><span class="cm">/* Dump the DE4X5 Status */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm">      case DE4X5_DUMP:</span>
<span class="cm">	j = 0;</span>
<span class="cm">	tmp.addr[j++] = dev-&gt;irq;</span>
<span class="cm">	for (i=0; i&lt;ETH_ALEN; i++) {</span>
<span class="cm">	    tmp.addr[j++] = dev-&gt;dev_addr[i];</span>
<span class="cm">	}</span>
<span class="cm">	tmp.addr[j++] = lp-&gt;rxRingSize;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = (long)lp-&gt;rx_ring; j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = (long)lp-&gt;tx_ring; j+=4;</span>

<span class="cm">	for (i=0;i&lt;lp-&gt;rxRingSize-1;i++){</span>
<span class="cm">	    if (i &lt; 3) {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2] = (long)&amp;lp-&gt;rx_ring[i].status; j+=4;</span>
<span class="cm">	    }</span>
<span class="cm">	}</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = (long)&amp;lp-&gt;rx_ring[i].status; j+=4;</span>
<span class="cm">	for (i=0;i&lt;lp-&gt;txRingSize-1;i++){</span>
<span class="cm">	    if (i &lt; 3) {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2] = (long)&amp;lp-&gt;tx_ring[i].status; j+=4;</span>
<span class="cm">	    }</span>
<span class="cm">	}</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = (long)&amp;lp-&gt;tx_ring[i].status; j+=4;</span>

<span class="cm">	for (i=0;i&lt;lp-&gt;rxRingSize-1;i++){</span>
<span class="cm">	    if (i &lt; 3) {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2] = (s32)le32_to_cpu(lp-&gt;rx_ring[i].buf); j+=4;</span>
<span class="cm">	    }</span>
<span class="cm">	}</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = (s32)le32_to_cpu(lp-&gt;rx_ring[i].buf); j+=4;</span>
<span class="cm">	for (i=0;i&lt;lp-&gt;txRingSize-1;i++){</span>
<span class="cm">	    if (i &lt; 3) {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2] = (s32)le32_to_cpu(lp-&gt;tx_ring[i].buf); j+=4;</span>
<span class="cm">	    }</span>
<span class="cm">	}</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = (s32)le32_to_cpu(lp-&gt;tx_ring[i].buf); j+=4;</span>

<span class="cm">	for (i=0;i&lt;lp-&gt;rxRingSize;i++){</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = le32_to_cpu(lp-&gt;rx_ring[i].status); j+=4;</span>
<span class="cm">	}</span>
<span class="cm">	for (i=0;i&lt;lp-&gt;txRingSize;i++){</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = le32_to_cpu(lp-&gt;tx_ring[i].status); j+=4;</span>
<span class="cm">	}</span>

<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_BMR);  j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_TPD);  j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_RPD);  j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_RRBA); j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_TRBA); j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_STS);  j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_OMR);  j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = inl(DE4X5_IMR);  j+=4;</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = lp-&gt;chipset; j+=4;</span>
<span class="cm">	if (lp-&gt;chipset == DC21140) {</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = gep_rd(dev);  j+=4;</span>
<span class="cm">	} else {</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = inl(DE4X5_SISR); j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = inl(DE4X5_SICR); j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = inl(DE4X5_STRR); j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = inl(DE4X5_SIGR); j+=4;</span>
<span class="cm">	}</span>
<span class="cm">	tmp.lval[j&gt;&gt;2] = lp-&gt;phy[lp-&gt;active].id; j+=4;</span>
<span class="cm">	if (lp-&gt;phy[lp-&gt;active].id &amp;&amp; (!lp-&gt;useSROM || lp-&gt;useMII)) {</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2] = lp-&gt;active; j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2]=mii_rd(MII_CR,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2]=mii_rd(MII_SR,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2]=mii_rd(MII_ID0,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2]=mii_rd(MII_ID1,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    if (lp-&gt;phy[lp-&gt;active].id != BROADCOM_T4) {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2]=mii_rd(MII_ANA,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">		tmp.lval[j&gt;&gt;2]=mii_rd(MII_ANLPA,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    }</span>
<span class="cm">	    tmp.lval[j&gt;&gt;2]=mii_rd(0x10,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    if (lp-&gt;phy[lp-&gt;active].id != BROADCOM_T4) {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2]=mii_rd(0x11,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">		tmp.lval[j&gt;&gt;2]=mii_rd(0x12,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    } else {</span>
<span class="cm">		tmp.lval[j&gt;&gt;2]=mii_rd(0x14,lp-&gt;phy[lp-&gt;active].addr,DE4X5_MII); j+=4;</span>
<span class="cm">	    }</span>
<span class="cm">	}</span>

<span class="cm">	tmp.addr[j++] = lp-&gt;txRingSize;</span>
<span class="cm">	tmp.addr[j++] = netif_queue_stopped(dev);</span>

<span class="cm">	ioc-&gt;len = j;</span>
<span class="cm">	if (copy_to_user(ioc-&gt;data, tmp.addr, ioc-&gt;len)) return -EFAULT;</span>
<span class="cm">	break;</span>

<span class="cm">*/</span>
    <span class="nl">default:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">de4x5_module_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">de4x5_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">eisa_driver_register</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">de4x5_eisa_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">de4x5_module_exit</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">de4x5_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="n">eisa_driver_unregister</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">de4x5_eisa_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span> <span class="p">(</span><span class="n">de4x5_module_init</span><span class="p">);</span>
<span class="n">module_exit</span> <span class="p">(</span><span class="n">de4x5_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
