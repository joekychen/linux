<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dec › tulip › interrupt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>interrupt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	drivers/net/ethernet/dec/tulip/interrupt.c</span>

<span class="cm">	Copyright 2000,2001  The Linux Kernel Team</span>
<span class="cm">	Written/copyright 1994-2001 by Donald Becker.</span>

<span class="cm">	This software may be used and distributed according to the terms</span>
<span class="cm">	of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">        Please submit bugs to http://bugzilla.kernel.org/ .</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &quot;tulip.h&quot;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>

<span class="kt">int</span> <span class="n">tulip_rx_copybreak</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tulip_max_interrupt_work</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_TULIP_NAPI_HW_MITIGATION</span>
<span class="cp">#define MIT_SIZE 15</span>
<span class="cp">#define MIT_TABLE 15 </span><span class="cm">/* We use 0 or max */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mit_table</span><span class="p">[</span><span class="n">MIT_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
        <span class="cm">/*  CRS11 21143 hardware Mitigation Control Interrupt</span>
<span class="cm">            We use only RX mitigation we other techniques for</span>
<span class="cm">            TX intr. mitigation.</span>

<span class="cm">           31    Cycle Size (timer control)</span>
<span class="cm">           30:27 TX timer in 16 * Cycle size</span>
<span class="cm">           26:24 TX No pkts before Int.</span>
<span class="cm">           23:20 RX timer in Cycle size</span>
<span class="cm">           19:17 RX No pkts before Int.</span>
<span class="cm">           16       Continues Mode (CM)</span>
<span class="cm">        */</span>

        <span class="mh">0x0</span><span class="p">,</span>             <span class="cm">/* IM disabled */</span>
        <span class="mh">0x80150000</span><span class="p">,</span>      <span class="cm">/* RX time = 1, RX pkts = 2, CM = 1 */</span>
        <span class="mh">0x80150000</span><span class="p">,</span>
        <span class="mh">0x80270000</span><span class="p">,</span>
        <span class="mh">0x80370000</span><span class="p">,</span>
        <span class="mh">0x80490000</span><span class="p">,</span>
        <span class="mh">0x80590000</span><span class="p">,</span>
        <span class="mh">0x80690000</span><span class="p">,</span>
        <span class="mh">0x807B0000</span><span class="p">,</span>
        <span class="mh">0x808B0000</span><span class="p">,</span>
        <span class="mh">0x809D0000</span><span class="p">,</span>
        <span class="mh">0x80AD0000</span><span class="p">,</span>
        <span class="mh">0x80BD0000</span><span class="p">,</span>
        <span class="mh">0x80CF0000</span><span class="p">,</span>
        <span class="mh">0x80DF0000</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>  0x80FF0000      /* RX time = 16, RX pkts = 7, CM = 1 */
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="mh">0x80F10000</span>      <span class="cm">/* RX time = 16, RX pkts = 0, CM = 1 */</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="kt">int</span> <span class="nf">tulip_refill_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refilled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Refill the Rx ring buffers. */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span>
				<span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span>
						 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
			<span class="n">refilled</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DescOwned</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">LC82C168</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">17</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx stopped due to out of buffers,</span>
<span class="cm">			 * restart it</span>
<span class="cm">			 */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">refilled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_TULIP_NAPI</span>

<span class="kt">void</span> <span class="nf">oom_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tulip_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tulip_private</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TULIP_NAPI_HW_MITIGATION</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TULIP_NAPI_HW_MITIGATION</span>

<span class="cm">/* that one buffer is needed for mit activation; or might be a</span>
<span class="cm">   bug in the ring buffer code; check later -- JHS*/</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">budget</span> <span class="o">&gt;=</span><span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="n">budget</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; In tulip_rx(), entry %d %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">entry</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>

       <span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; In tulip_poll(), hardware disappeared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
               <span class="cm">/* Acknowledge current RX interrupt sources. */</span>
               <span class="n">iowrite32</span><span class="p">((</span><span class="n">RxIntr</span> <span class="o">|</span> <span class="n">RxNoBuf</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>


               <span class="cm">/* If we own the next entry, it is a new packet. Send it up. */</span>
               <span class="k">while</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DescOwned</span><span class="p">)))</span> <span class="p">{</span>
                       <span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		       <span class="kt">short</span> <span class="n">pkt_len</span><span class="p">;</span>

                       <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+</span> <span class="n">RX_RING_SIZE</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span>
                               <span class="k">break</span><span class="p">;</span>

		       <span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;In tulip_rx(), entry %d %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">entry</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		       <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">)</span>
                               <span class="k">goto</span> <span class="n">not_done</span><span class="p">;</span>

		       <span class="cm">/*</span>
<span class="cm">			* Omit the four octet CRC from the length.</span>
<span class="cm">			* (May not be considered valid until we have</span>
<span class="cm">			* checked status for RxLengthOver2047 bits)</span>
<span class="cm">			*/</span>
		       <span class="n">pkt_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

		       <span class="cm">/*</span>
<span class="cm">			* Maximum pkt_len is 1518 (1514 + vlan header)</span>
<span class="cm">			* Anything higher than this is always invalid</span>
<span class="cm">			* regardless of RxLengthOver2047 bits</span>
<span class="cm">			*/</span>

		       <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxLengthOver2047</span> <span class="o">|</span>
				      <span class="n">RxDescCRCError</span> <span class="o">|</span>
				      <span class="n">RxDescCollisionSeen</span> <span class="o">|</span>
				      <span class="n">RxDescRunt</span> <span class="o">|</span>
				      <span class="n">RxDescDescErr</span> <span class="o">|</span>
				      <span class="n">RxWholePkt</span><span class="p">))</span> <span class="o">!=</span> <span class="n">RxWholePkt</span> <span class="o">||</span>
			   <span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">1518</span><span class="p">)</span> <span class="p">{</span>
			       <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxLengthOver2047</span> <span class="o">|</span>
					      <span class="n">RxWholePkt</span><span class="p">))</span> <span class="o">!=</span> <span class="n">RxWholePkt</span><span class="p">)</span> <span class="p">{</span>
                                <span class="cm">/* Ingore earlier buffers. */</span>
                                       <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
                                               <span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                                                       <span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
								<span class="s">&quot;Oversized Ethernet frame spanned multiple buffers, status %08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">status</span><span class="p">);</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
			       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="cm">/* There was a fatal error. */</span>
				       <span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Receive error, Rx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							   <span class="n">status</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* end of a packet.*/</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">1518</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxDescRunt</span><span class="p">))</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
                               <span class="p">}</span>
                       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                               <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

                               <span class="cm">/* Check if the packet is long enough to accept without copying</span>
<span class="cm">                                  to a minimally-sized skbuff. */</span>
                               <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">tulip_rx_copybreak</span> <span class="o">&amp;&amp;</span>
                                   <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                       <span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>    <span class="cm">/* 16 byte align the IP header */</span>
                                       <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
								   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
								   <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="cp">#if ! defined(__alpha__)</span>
                                       <span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
                                                        <span class="n">pkt_len</span><span class="p">);</span>
                                       <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#else</span>
                                       <span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
                                              <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
                                              <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#endif</span>
                                       <span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
								      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
								      <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
                               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="cm">/* Pass up the skb already on the Rx ring. */</span>
                                       <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span>
                                                            <span class="n">pkt_len</span><span class="p">);</span>

<span class="cp">#ifndef final_version</span>
                                       <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">!=</span>
                                           <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span><span class="p">))</span> <span class="p">{</span>
                                               <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						       <span class="s">&quot;Internal fault: The skbuff addresses do not match in tulip_rx: %08x vs. %08llx %p / %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span><span class="p">),</span>
						       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
                                       <span class="p">}</span>
<span class="cp">#endif</span>

                                       <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
                                                        <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

                                       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                                       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                               <span class="p">}</span>
                               <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

                               <span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
                       <span class="p">}</span>
<span class="cp">#ifdef CONFIG_TULIP_NAPI_HW_MITIGATION</span>
		       <span class="n">received</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

                       <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
                       <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="n">RX_RING_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                               <span class="n">tulip_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

                <span class="p">}</span>

               <span class="cm">/* New ack strategy... irq does not ack Rx any longer</span>
<span class="cm">                  hopefully this helps */</span>

               <span class="cm">/* Really bad things can happen here... If new packet arrives</span>
<span class="cm">                * and an irq arrives (tx or just due to occasionally unset</span>
<span class="cm">                * mask), it will be acked by irq handler, but new thread</span>
<span class="cm">                * is not scheduled. It is major hole in design.</span>
<span class="cm">                * No idea how to fix this if &quot;playing with fire&quot; will fail</span>
<span class="cm">                * tomorrow (night 011029). If it will not fail, we won</span>
<span class="cm">                * finally: amount of IO did not increase at all. */</span>
       <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RxIntr</span><span class="p">));</span>

 <span class="cp">#ifdef CONFIG_TULIP_NAPI_HW_MITIGATION</span>

          <span class="cm">/* We use this simplistic scheme for IM. It&#39;s proven by</span>
<span class="cm">             real life installations. We can have IM enabled</span>
<span class="cm">            continuesly but this would cause unnecessary latency.</span>
<span class="cm">            Unfortunely we can&#39;t use all the NET_RX_* feedback here.</span>
<span class="cm">            This would turn on IM for devices that is not contributing</span>
<span class="cm">            to backlog congestion with unnecessary latency.</span>

<span class="cm">             We monitor the device RX-ring and have:</span>

<span class="cm">             HW Interrupt Mitigation either ON or OFF.</span>

<span class="cm">            ON:  More then 1 pkt received (per intr.) OR we are dropping</span>
<span class="cm">             OFF: Only 1 pkt received</span>

<span class="cm">             Note. We only use min and max (0, 15) settings from mit_table */</span>


          <span class="k">if</span><span class="p">(</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>  <span class="n">HAS_INTR_MITIGATION</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">received</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                         <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mit_on</span> <span class="p">)</span> <span class="p">{</span>
                                 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mit_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                                 <span class="n">iowrite32</span><span class="p">(</span><span class="n">mit_table</span><span class="p">[</span><span class="n">MIT_TABLE</span><span class="p">],</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR11</span><span class="p">);</span>
                         <span class="p">}</span>
                  <span class="p">}</span>
                 <span class="k">else</span> <span class="p">{</span>
                         <span class="k">if</span><span class="p">(</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mit_on</span> <span class="p">)</span> <span class="p">{</span>
                                 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mit_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                 <span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR11</span><span class="p">);</span>
                         <span class="p">}</span>
                  <span class="p">}</span>
          <span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_TULIP_NAPI_HW_MITIGATION */</span><span class="cp"></span>

         <span class="n">tulip_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

         <span class="cm">/* If RX ring is not full we are out of memory. */</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		 <span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>

         <span class="cm">/* Remove us from polling list and enable RX intr. */</span>

         <span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
         <span class="n">iowrite32</span><span class="p">(</span><span class="n">tulip_tbl</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">].</span><span class="n">valid_intrs</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">CSR7</span><span class="p">);</span>

         <span class="cm">/* The last op happens after poll completion. Which means the following:</span>
<span class="cm">          * 1. it can race with disabling irqs in irq handler</span>
<span class="cm">          * 2. it can race with dise/enabling irqs in other poll threads</span>
<span class="cm">          * 3. if an irq raised after beginning loop, it will be immediately</span>
<span class="cm">          *    triggered here.</span>
<span class="cm">          *</span>
<span class="cm">          * Summarizing: the logic results in some redundant irqs both</span>
<span class="cm">          * due to races in masking and due to too late acking of already</span>
<span class="cm">          * processed irqs. But it must not result in losing events.</span>
<span class="cm">          */</span>

         <span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>

 <span class="nl">not_done:</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="n">RX_RING_SIZE</span><span class="o">/</span><span class="mi">2</span> <span class="o">||</span>
             <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                 <span class="n">tulip_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		 <span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>

         <span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>

 <span class="nl">oom:</span>    <span class="cm">/* Executed with RX ints disabled */</span>

         <span class="cm">/* Start timer, stop polling, but do not enable rx interrupts. */</span>
         <span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">oom_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

         <span class="cm">/* Think: timer_pending() was an explicit signature of bug.</span>
<span class="cm">          * Timer can be pending now but fired and completed</span>
<span class="cm">          * before we did napi_complete(). See? We would lose it. */</span>

         <span class="cm">/* remove ourselves from the polling list */</span>
         <span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

         <span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_TULIP_NAPI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tulip_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_work_limit</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+</span> <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;In tulip_rx(), entry %d %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">entry</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	<span class="cm">/* If we own the next entry, it is a new packet. Send it up. */</span>
	<span class="k">while</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DescOwned</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="kt">short</span> <span class="n">pkt_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;In tulip_rx(), entry %d %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">entry</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">rx_work_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		  Omit the four octet CRC from the length.</span>
<span class="cm">		  (May not be considered valid until we have</span>
<span class="cm">		  checked status for RxLengthOver2047 bits)</span>
<span class="cm">		*/</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		  Maximum pkt_len is 1518 (1514 + vlan header)</span>
<span class="cm">		  Anything higher than this is always invalid</span>
<span class="cm">		  regardless of RxLengthOver2047 bits</span>
<span class="cm">		*/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxLengthOver2047</span> <span class="o">|</span>
			       <span class="n">RxDescCRCError</span> <span class="o">|</span>
			       <span class="n">RxDescCollisionSeen</span> <span class="o">|</span>
			       <span class="n">RxDescRunt</span> <span class="o">|</span>
			       <span class="n">RxDescDescErr</span> <span class="o">|</span>
			       <span class="n">RxWholePkt</span><span class="p">))</span>        <span class="o">!=</span> <span class="n">RxWholePkt</span> <span class="o">||</span>
		    <span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">1518</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxLengthOver2047</span> <span class="o">|</span>
			     <span class="n">RxWholePkt</span><span class="p">))</span>         <span class="o">!=</span> <span class="n">RxWholePkt</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Ingore earlier buffers. */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							    <span class="s">&quot;Oversized Ethernet frame spanned multiple buffers, status %08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							    <span class="n">status</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* There was a fatal error. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Receive error, Rx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">status</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* end of a packet.*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">1518</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxDescRunt</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="cm">/* Check if the packet is long enough to accept without copying</span>
<span class="cm">			   to a minimally-sized skbuff. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">tulip_rx_copybreak</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 16 byte align the IP header */</span>
				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
							    <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="cp">#if ! defined(__alpha__)</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						 <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
							       <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 	<span class="cm">/* Pass up the skb already on the Rx ring. */</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span>
						     <span class="n">pkt_len</span><span class="p">);</span>

<span class="cp">#ifndef final_version</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">!=</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;Internal fault: The skbuff addresses do not match in tulip_rx: %08x vs. %Lx %p / %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span><span class="p">),</span>
						<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>

				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						 <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">received</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_TULIP_NAPI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">phy_interrupt</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef __hppa__</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">csr12</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr12</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr12_shadow</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ack interrupt */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">csr12</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr12_shadow</span> <span class="o">=</span> <span class="n">csr12</span><span class="p">;</span>
		<span class="cm">/* do link change stuff */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tulip_check_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/* clear irq ack bit */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">csr12</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR12</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>
<span class="n">irqreturn_t</span> <span class="nf">tulip_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tulip_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">csr5</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">missed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxrx</span> <span class="o">=</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxtx</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxoi</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TULIP_NAPI</span>
	<span class="kt">int</span> <span class="n">rxd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">work_count</span> <span class="o">=</span> <span class="n">tulip_max_interrupt_work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Let&#39;s see whether the interrupt really is for us */</span>
	<span class="n">csr5</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HAS_PHY_IRQ</span><span class="p">)</span>
	        <span class="n">handled</span> <span class="o">=</span> <span class="n">phy_interrupt</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NormalIntr</span><span class="o">|</span><span class="n">AbnormalIntr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nir</span><span class="o">++</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_TULIP_NAPI</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxIntr</span> <span class="o">|</span> <span class="n">RxNoBuf</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rxd</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Mask RX intrs and add the device to poll list. */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">tulip_tbl</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">].</span><span class="n">valid_intrs</span><span class="o">&amp;~</span><span class="n">RxPollInt</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR7</span><span class="p">);</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr5</span><span class="o">&amp;~</span><span class="p">(</span><span class="n">AbnormalIntr</span><span class="o">|</span><span class="n">NormalIntr</span><span class="o">|</span><span class="n">RxPollInt</span><span class="o">|</span><span class="n">TPLnkPass</span><span class="p">)))</span>
                               <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

               <span class="cm">/* Acknowledge the interrupt sources we handle here ASAP</span>
<span class="cm">                  the poll function does Rx and RxNoBuf acking */</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="mh">0x0001ff3f</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>

<span class="cp">#else</span>
		<span class="cm">/* Acknowledge all of the current interrupt sources ASAP. */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="mh">0x0001ffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxIntr</span> <span class="o">|</span> <span class="n">RxNoBuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rx</span> <span class="o">+=</span> <span class="n">tulip_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tulip_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/*  CONFIG_TULIP_NAPI */</span><span class="cp"></span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt  csr5=%#8.8x new csr5=%#8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">csr5</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">));</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxNoBuf</span> <span class="o">|</span> <span class="n">TxDied</span> <span class="o">|</span> <span class="n">TxIntr</span> <span class="o">|</span> <span class="n">TimerInt</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty_tx</span><span class="p">;</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
				 <span class="n">dirty_tx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>			<span class="cm">/* It still has not been Txed */</span>

				<span class="cm">/* Check for Rx filter setup frames. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* test because dummy frames not mapped */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">)</span>
						<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">setup_frame</span><span class="p">),</span>
							 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* There was an major error, log it. */</span>
<span class="cp">#ifndef final_version</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit error, Tx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							   <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4104</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0C00</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span>
						<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

				<span class="cm">/* Free the original skb. */</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

<span class="cp">#ifndef final_version</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Out-of-sync dirty pointer, %d vs. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dirty_tx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>
				<span class="n">dirty_tx</span> <span class="o">+=</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">dirty_tx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">TxDied</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="s">&quot;The transmitter stopped.  CSR5 is %x, CSR6 %x, new CSR6 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">csr5</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR6</span><span class="p">),</span>
						 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">);</span>
				<span class="n">tulip_restart_rxtx</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Log errors. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">AbnormalIntr</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Abnormal error summary bit. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">TxJabber</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">TxFIFOUnderflow</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xC000</span><span class="p">)</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">;</span>	<span class="cm">/* Bump up the Tx threshold */</span>
				<span class="k">else</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">|=</span> <span class="mh">0x00200000</span><span class="p">;</span>  <span class="cm">/* Store-n-forward. */</span>
				<span class="cm">/* Restart the transmit process. */</span>
				<span class="n">tulip_restart_rxtx</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxDied</span> <span class="o">|</span> <span class="n">RxNoBuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">COMET_MAC_ADDR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">iowrite32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xAC</span><span class="p">);</span>
					<span class="n">iowrite32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xB0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">RxDied</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Missed a Rx frame. */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">tulip_start_rxtx</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * NB: t21142_lnk_change() does a del_timer_sync(), so be careful if this</span>
<span class="cm">			 * call is ever done under the spinlock</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPLnkPass</span> <span class="o">|</span> <span class="n">TPLnkFail</span> <span class="o">|</span> <span class="mh">0x08000000</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">)</span>
					<span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">)(</span><span class="n">dev</span><span class="p">,</span> <span class="n">csr5</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">SystemError</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="cm">/* oops, we hit a PCI error.  The code produced corresponds</span>
<span class="cm">				 * to the reason:</span>
<span class="cm">				 *  0 - parity error</span>
<span class="cm">				 *  1 - master abort</span>
<span class="cm">				 *  2 - target abort</span>
<span class="cm">				 * Note that on parity error, we should do a software reset</span>
<span class="cm">				 * of the chip to get it back into a sane state (according</span>
<span class="cm">				 * to the 21142/3 docs that is).</span>
<span class="cm">				 *   -- rmk</span>
<span class="cm">				 */</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;(%lu) System Error occurred (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nir</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Clear all error sources, included undocumented ones! */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0800f7ba</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>
			<span class="n">oi</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="n">TimerInt</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Re-enabling interrupts, %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">csr5</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">tulip_tbl</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">].</span><span class="n">valid_intrs</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR7</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ttimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">oi</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">&gt;</span> <span class="n">maxtx</span> <span class="o">||</span> <span class="n">rx</span> <span class="o">&gt;</span> <span class="n">maxrx</span> <span class="o">||</span> <span class="n">oi</span> <span class="o">&gt;</span> <span class="n">maxoi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Too much work during an interrupt, csr5=0x%08x. (%lu) (%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">csr5</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nir</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">oi</span><span class="p">);</span>

                       <span class="cm">/* Acknowledge all interrupt sources. */</span>
                        <span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x8001ffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HAS_INTR_MITIGATION</span><span class="p">)</span> <span class="p">{</span>
                     <span class="cm">/* Josip Loncaric at ICASE did extensive experimentation</span>
<span class="cm">			to develop a good interrupt mitigation setting.*/</span>
                                <span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x8b240000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR11</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">LC82C168</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the LC82C168 doesn&#39;t have a hw timer.*/</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR7</span><span class="p">);</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                          <span class="cm">/* Mask all interrupting sources, set timer to</span>
<span class="cm">				re-enable. */</span>
                                <span class="n">iowrite32</span><span class="p">(((</span><span class="o">~</span><span class="n">csr5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0001ebef</span><span class="p">)</span> <span class="o">|</span> <span class="n">AbnormalIntr</span> <span class="o">|</span> <span class="n">TimerInt</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR7</span><span class="p">);</span>
                                <span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0012</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR11</span><span class="p">);</span>
                        <span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">work_count</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">csr5</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TULIP_NAPI</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="p">)</span>
			<span class="n">csr5</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxPollInt</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxNoBuf</span> <span class="o">|</span>
			  <span class="n">TxDied</span> <span class="o">|</span>
			  <span class="n">TxIntr</span> <span class="o">|</span>
			  <span class="n">TimerInt</span> <span class="o">|</span>
			  <span class="cm">/* Abnormal intr. */</span>
			  <span class="n">RxDied</span> <span class="o">|</span>
			  <span class="n">TxFIFOUnderflow</span> <span class="o">|</span>
			  <span class="n">TxJabber</span> <span class="o">|</span>
			  <span class="n">TPLnkFail</span> <span class="o">|</span>
			  <span class="n">SystemError</span> <span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">csr5</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NormalIntr</span><span class="o">|</span><span class="n">AbnormalIntr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tulip_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* check if the card is in suspend mode */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;in rx suspend mode: (%lu) (tp-&gt;cur_rx = %u, ttimer = %d, rx = %d) go/stay in suspend mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nir</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ttimer</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">LC82C168</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR7</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ttimer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="s">&quot;in rx suspend mode: (%lu) set timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nir</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">tulip_tbl</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">].</span><span class="n">valid_intrs</span> <span class="o">|</span> <span class="n">TimerInt</span><span class="p">,</span>
					<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR7</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">TimerInt</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR11</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ttimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TULIP_NAPI */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">((</span><span class="n">missed</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">missed</span> <span class="o">&amp;</span> <span class="mh">0x10000</span> <span class="o">?</span> <span class="mh">0x10000</span> <span class="o">:</span> <span class="n">missed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tulip_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;exiting interrupt, csr5=%#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR5</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
