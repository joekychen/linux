<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dec › tulip › winbond-840.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>winbond-840.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* winbond-840.c: A Linux PCI network adapter device driver. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1998-2001 by Donald Becker.</span>

<span class="cm">	This software may be used and distributed according to the terms of</span>
<span class="cm">	the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">	Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm">	retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm">	a complete program and may only be used when the entire operating</span>
<span class="cm">	system is licensed under the GPL.</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>

<span class="cm">	Support and updates available at</span>
<span class="cm">	http://www.scyld.com/network/drivers.html</span>

<span class="cm">	Do not remove the copyright information.</span>
<span class="cm">	Do not change the version information unless an improvement has been made.</span>
<span class="cm">	Merely removing my name, as Compex has done in the past, does not count</span>
<span class="cm">	as an improvement.</span>

<span class="cm">	Changelog:</span>
<span class="cm">	* ported to 2.4</span>
<span class="cm">		???</span>
<span class="cm">	* spin lock update, memory barriers, new style dma mappings</span>
<span class="cm">		limit each tx buffer to &lt; 1024 bytes</span>
<span class="cm">		remove DescIntr from Rx descriptors (that&#39;s an Tx flag)</span>
<span class="cm">		remove next pointer from Tx descriptors</span>
<span class="cm">		synchronize tx_q_bytes</span>
<span class="cm">		software reset in tx_timeout</span>
<span class="cm">			Copyright (C) 2000 Manfred Spraul</span>
<span class="cm">	* further cleanups</span>
<span class="cm">		power management.</span>
<span class="cm">		support for big endian descriptors</span>
<span class="cm">			Copyright (C) 2001 Manfred Spraul</span>
<span class="cm">  	* ethtool support (jgarzik)</span>
<span class="cm">	* Replace some MII-related magic numbers with constants (jgarzik)</span>

<span class="cm">	TODO:</span>
<span class="cm">	* enable pci_power_off</span>
<span class="cm">	* Wake-On-LAN</span>
<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define DRV_NAME	&quot;winbond-840&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.01-e&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;Sep-11-2006&quot;</span>


<span class="cm">/* Automatically extracted configuration info:</span>
<span class="cm">probe-func: winbond840_probe</span>
<span class="cm">config-in: tristate &#39;Winbond W89c840 Ethernet support&#39; CONFIG_WINBOND_840</span>

<span class="cm">c-help-name: Winbond W89c840 PCI Ethernet support</span>
<span class="cm">c-help-symbol: CONFIG_WINBOND_840</span>
<span class="cm">c-help: This driver is for the Winbond W89c840 chip.  It also works with</span>
<span class="cm">c-help: the TX9882 chip on the Compex RL100-ATX board.</span>
<span class="cm">c-help: More specific information and updates are available from</span>
<span class="cm">c-help: http://www.scyld.com/network/drivers.html</span>
<span class="cm">*/</span>

<span class="cm">/* The user-configurable values.</span>
<span class="cm">   These may be modified when a driver module is loaded.*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* 1 normal messages, 0 quiet .. 7 verbose. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="cm">/* Maximum number of multicast addresses to filter (vs. Rx-all-multicast).</span>
<span class="cm">   The &#39;840 uses a 64 element hash table based on the Ethernet CRC.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="cm">/* Set the copy breakpoint for the copy-only-tiny-frames scheme.</span>
<span class="cm">   Setting to &gt; 1518 effectively disables this feature. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span><span class="p">;</span>

<span class="cm">/* Used to pass the media type, etc.</span>
<span class="cm">   Both &#39;options[]&#39; and &#39;full_duplex[]&#39; should exist for driver</span>
<span class="cm">   interoperability.</span>
<span class="cm">   The media type is usually passed in &#39;options[]&#39;.</span>
<span class="cm">*/</span>
<span class="cp">#define MAX_UNITS 8		</span><span class="cm">/* More are supported, limit only on options */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>

<span class="cm">/* Operational parameters that are set at compile time. */</span>

<span class="cm">/* Keep the ring sizes a power of two for compile efficiency.</span>
<span class="cm">   The compiler will convert &lt;unsigned&gt;&#39;%&#39;&lt;2^N&gt; into a bit mask.</span>
<span class="cm">   Making the Tx ring too large decreases the effectiveness of channel</span>
<span class="cm">   bonding and packet priority.</span>
<span class="cm">   There are no ill effects from too-large receive rings. */</span>
<span class="cp">#define TX_QUEUE_LEN	10		</span><span class="cm">/* Limit ring entries actually used.  */</span><span class="cp"></span>
<span class="cp">#define TX_QUEUE_LEN_RESTART	5</span>

<span class="cp">#define TX_BUFLIMIT	(1024-128)</span>

<span class="cm">/* The presumed FIFO size for working around the Tx-FIFO-overflow bug.</span>
<span class="cm">   To avoid overflowing we don&#39;t queue again until we have room for a</span>
<span class="cm">   full-size packet.</span>
<span class="cm"> */</span>
<span class="cp">#define TX_FIFO_SIZE (2048)</span>
<span class="cp">#define TX_BUG_FIFO_LIMIT (TX_FIFO_SIZE-1514-16)</span>


<span class="cm">/* Operational parameters that usually are not changed. */</span>
<span class="cm">/* Time in jiffies before concluding the transmitter is hung. */</span>
<span class="cp">#define TX_TIMEOUT  (2*HZ)</span>

<span class="cm">/* Include files, designed to support most kernel versions 2.0.0 and later. */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;		</span><span class="cm">/* Processor type for cache alignment. */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &quot;tulip.h&quot;</span>

<span class="cp">#undef PKT_BUF_SZ			</span><span class="cm">/* tulip.h also defines this */</span><span class="cp"></span>
<span class="cp">#define PKT_BUF_SZ		1536	</span><span class="cm">/* Size of each temporary Rx buffer.*/</span><span class="cp"></span>

<span class="cm">/* These identify the driver base version and may not be removed. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="s">&quot;v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; (2.4 port) &quot;</span>
	<span class="n">DRV_RELDATE</span> <span class="s">&quot;  Donald Becker &lt;becker@scyld.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;  http://www.scyld.com/network/drivers.html</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Winbond W89c840 Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">multicast_filter_limit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;winbond-840 maximum events handled per interrupt&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;winbond-840 debug level (0-6)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;winbond-840 copy breakpoint for copy-only-tiny-frames&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">multicast_filter_limit</span><span class="p">,</span> <span class="s">&quot;winbond-840 maximum number of filtered multicast addresses&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;winbond-840: Bits 0-3: media type, bit 17: full duplex&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="s">&quot;winbond-840 full duplex setting(s) (1)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">				Theory of Operation</span>

<span class="cm">I. Board Compatibility</span>

<span class="cm">This driver is for the Winbond w89c840 chip.</span>

<span class="cm">II. Board-specific settings</span>

<span class="cm">None.</span>

<span class="cm">III. Driver operation</span>

<span class="cm">This chip is very similar to the Digital 21*4* &quot;Tulip&quot; family.  The first</span>
<span class="cm">twelve registers and the descriptor format are nearly identical.  Read a</span>
<span class="cm">Tulip manual for operational details.</span>

<span class="cm">A significant difference is that the multicast filter and station address are</span>
<span class="cm">stored in registers rather than loaded through a pseudo-transmit packet.</span>

<span class="cm">Unlike the Tulip, transmit buffers are limited to 1KB.  To transmit a</span>
<span class="cm">full-sized packet we must use both data buffers in a descriptor.  Thus the</span>
<span class="cm">driver uses ring mode where descriptors are implicitly sequential in memory,</span>
<span class="cm">rather than using the second descriptor address as a chain pointer to</span>
<span class="cm">subsequent descriptors.</span>

<span class="cm">IV. Notes</span>

<span class="cm">If you are going to almost clone a Tulip, why not go all the way and avoid</span>
<span class="cm">the need for a new driver?</span>

<span class="cm">IVb. References</span>

<span class="cm">http://www.scyld.com/expert/100mbps.html</span>
<span class="cm">http://www.scyld.com/expert/NWay.html</span>
<span class="cm">http://www.winbond.com.tw/</span>

<span class="cm">IVc. Errata</span>

<span class="cm">A horrible bug exists in the transmit FIFO.  Apparently the chip doesn&#39;t</span>
<span class="cm">correctly detect a full FIFO, and queuing more than 2048 bytes may result in</span>
<span class="cm">silent data corruption.</span>

<span class="cm">Test with &#39;ping -s 10000&#39; on a fast computer.</span>

<span class="cm">*/</span>



<span class="cm">/*</span>
<span class="cm">  PCI probe table.</span>
<span class="cm">*/</span>
<span class="k">enum</span> <span class="n">chip_capability_flags</span> <span class="p">{</span>
	<span class="n">CanHaveMII</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">HasBrokenTx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">AlwaysFDX</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">FDXOnNoMII</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">w840_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x1050</span><span class="p">,</span> <span class="mh">0x0840</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x8153</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1050</span><span class="p">,</span> <span class="mh">0x0840</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11f6</span><span class="p">,</span> <span class="mh">0x2011</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">w840_pci_tbl</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">netdev_res_size</span>		<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>	<span class="cm">/* size of PCI BAR resource */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pci_id_info</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">drv_flags</span><span class="p">;</span>		<span class="cm">/* Driver use, intended as capability flags. */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_info</span> <span class="n">pci_id_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> 				<span class="cm">/* Sometime a Level-One switch card. */</span>
	  <span class="s">&quot;Winbond W89c840&quot;</span><span class="p">,</span>	<span class="n">CanHaveMII</span> <span class="o">|</span> <span class="n">HasBrokenTx</span> <span class="o">|</span> <span class="n">FDXOnNoMII</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Winbond W89c840&quot;</span><span class="p">,</span>	<span class="n">CanHaveMII</span> <span class="o">|</span> <span class="n">HasBrokenTx</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compex RL100-ATX&quot;</span><span class="p">,</span>	<span class="n">CanHaveMII</span> <span class="o">|</span> <span class="n">HasBrokenTx</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list. */</span>
<span class="p">};</span>

<span class="cm">/* This driver was written to use PCI memory space, however some x86 systems</span>
<span class="cm">   work only with I/O space accesses. See CONFIG_TULIP_MMIO in .config</span>
<span class="cm">*/</span>

<span class="cm">/* Offsets to the Command and Status Registers, &quot;CSRs&quot;.</span>
<span class="cm">   While similar to the Tulip, these registers are longword aligned.</span>
<span class="cm">   Note: It&#39;s not useful to define symbolic names for every register bit in</span>
<span class="cm">   the device.  The name can only partially document the semantics and make</span>
<span class="cm">   the driver longer and more difficult to read.</span>
<span class="cm">*/</span>
<span class="k">enum</span> <span class="n">w840_offsets</span> <span class="p">{</span>
	<span class="n">PCIBusCfg</span><span class="o">=</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TxStartDemand</span><span class="o">=</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">RxStartDemand</span><span class="o">=</span><span class="mh">0x08</span><span class="p">,</span>
	<span class="n">RxRingPtr</span><span class="o">=</span><span class="mh">0x0C</span><span class="p">,</span> <span class="n">TxRingPtr</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span>
	<span class="n">IntrStatus</span><span class="o">=</span><span class="mh">0x14</span><span class="p">,</span> <span class="n">NetworkConfig</span><span class="o">=</span><span class="mh">0x18</span><span class="p">,</span> <span class="n">IntrEnable</span><span class="o">=</span><span class="mh">0x1C</span><span class="p">,</span>
	<span class="n">RxMissed</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">EECtrl</span><span class="o">=</span><span class="mh">0x24</span><span class="p">,</span> <span class="n">MIICtrl</span><span class="o">=</span><span class="mh">0x24</span><span class="p">,</span> <span class="n">BootRom</span><span class="o">=</span><span class="mh">0x28</span><span class="p">,</span> <span class="n">GPTimer</span><span class="o">=</span><span class="mh">0x2C</span><span class="p">,</span>
	<span class="n">CurRxDescAddr</span><span class="o">=</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">CurRxBufAddr</span><span class="o">=</span><span class="mh">0x34</span><span class="p">,</span>			<span class="cm">/* Debug use */</span>
	<span class="n">MulticastFilter0</span><span class="o">=</span><span class="mh">0x38</span><span class="p">,</span> <span class="n">MulticastFilter1</span><span class="o">=</span><span class="mh">0x3C</span><span class="p">,</span> <span class="n">StationAddr</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span>
	<span class="n">CurTxDescAddr</span><span class="o">=</span><span class="mh">0x4C</span><span class="p">,</span> <span class="n">CurTxBufAddr</span><span class="o">=</span><span class="mh">0x50</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the NetworkConfig register. */</span>
<span class="k">enum</span> <span class="n">rx_mode_bits</span> <span class="p">{</span>
	<span class="n">AcceptErr</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span>
	<span class="n">RxAcceptBroadcast</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">AcceptMulticast</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span>
	<span class="n">RxAcceptAllPhys</span><span class="o">=</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">AcceptMyPhys</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">mii_reg_bits</span> <span class="p">{</span>
	<span class="n">MDIO_ShiftClk</span><span class="o">=</span><span class="mh">0x10000</span><span class="p">,</span> <span class="n">MDIO_DataIn</span><span class="o">=</span><span class="mh">0x80000</span><span class="p">,</span> <span class="n">MDIO_DataOut</span><span class="o">=</span><span class="mh">0x20000</span><span class="p">,</span>
	<span class="n">MDIO_EnbOutput</span><span class="o">=</span><span class="mh">0x40000</span><span class="p">,</span> <span class="n">MDIO_EnbIn</span> <span class="o">=</span> <span class="mh">0x00000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The Tulip Rx and Tx buffer descriptors. */</span>
<span class="k">struct</span> <span class="n">w840_rx_desc</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">w840_tx_desc</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer1</span><span class="p">,</span> <span class="n">buffer2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MII_CNT		1 </span><span class="cm">/* winbond only supports one MII */</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">netdev_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">w840_rx_desc</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">rx_addr</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">w840_tx_desc</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">tx_addr</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_dma_addr</span><span class="p">;</span>
	<span class="cm">/* The addresses of receive-in-place skbuffs. */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">rx_skbuff</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="cm">/* The saved address of a sent-in-place packet/buffer, for later free(). */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">tx_skbuff</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* Media monitoring timer. */</span>
	<span class="cm">/* Frequently used values: keep some adjacent for cache effect. */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">drv_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">csr6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w840_rx_desc</span> <span class="o">*</span><span class="n">rx_head_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_rx</span><span class="p">,</span> <span class="n">dirty_rx</span><span class="p">;</span>		<span class="cm">/* Producer/consumer ring indices */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_buf_sz</span><span class="p">;</span>				<span class="cm">/* Based on MTU+slack. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_tx</span><span class="p">,</span> <span class="n">dirty_tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_q_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_full</span><span class="p">;</span>				<span class="cm">/* The Tx queue is full. */</span>
	<span class="cm">/* MII transceiver section. */</span>
	<span class="kt">int</span> <span class="n">mii_cnt</span><span class="p">;</span>						<span class="cm">/* MII device addresses. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="n">MII_CNT</span><span class="p">];</span>		<span class="cm">/* MII device addresses, but only the first is used */</span>
	<span class="n">u32</span> <span class="n">mii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii_if</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">eeprom_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">update_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netdev_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_rxtx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_rxtx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">alloc_ringdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_ringdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netdev_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">netdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">netdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">netdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">netdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">w840_probe1</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">find_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_idx</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">find_cnt</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span> <span class="o">?</span> <span class="n">options</span><span class="p">[</span><span class="n">find_cnt</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Device %s disabled due to DMA limitations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_netdev</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TULIP_BAR</span><span class="p">,</span> <span class="n">netdev_res_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">eeprom_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* Reset the chip to erase previous misconfiguration.</span>
<span class="cm">	   No hold time required! */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PCIBusCfg</span><span class="p">);</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">chip_idx</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">=</span> <span class="n">pci_id_tbl</span><span class="p">[</span><span class="n">chip_idx</span><span class="p">].</span><span class="n">drv_flags</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span>
		<span class="n">option</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>

	<span class="cm">/* The lower four bits are the media type. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;ignoring user supplied media type %d&quot;</span><span class="p">,</span>
				 <span class="n">option</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_cnt</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span>  <span class="o">&amp;&amp;</span>  <span class="n">full_duplex</span><span class="p">[</span><span class="n">find_cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">force_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* The chip-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_cleardev</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s at %p, %pM, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pci_id_tbl</span><span class="p">[</span><span class="n">chip_idx</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">CanHaveMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">phy</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">MII_CNT</span><span class="p">;</span> <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mii_status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0xffff</span>  <span class="o">&amp;&amp;</span>  <span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">phy_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">+</span>
						<span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;MII PHY %08xh found at address %d, status 0x%04x advertising %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">mii_status</span><span class="p">,</span>
					 <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_cnt</span> <span class="o">=</span> <span class="n">phy_idx</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;MII PHY not found -- this device may not operate correctly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">find_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_cleardev:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_netdev:</span>
	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Read the EEPROM and MII Management Data I/O (MDIO) interfaces.  These are</span>
<span class="cm">   often serial bit streams generated by the host processor.</span>
<span class="cm">   The example below is for the common 93c46 EEPROM, 64 16 bit words. */</span>

<span class="cm">/* Delay between EEPROM clock transitions.</span>
<span class="cm">   No extra delay is needed with 33Mhz PCI, but future 66Mhz access may need</span>
<span class="cm">   a delay.  Note that pre-2.0.34 kernels had a cache-alignment bug that</span>
<span class="cm">   made udelay() unreliable.</span>
<span class="cm">   The old method of using an ISA access as a delay, __SLOW_DOWN_IO__, is</span>
<span class="cm">   deprecated.</span>
<span class="cm">*/</span>
<span class="cp">#define eeprom_delay(ee_addr)	ioread32(ee_addr)</span>

<span class="k">enum</span> <span class="n">EEPROM_Ctrl_Bits</span> <span class="p">{</span>
	<span class="n">EE_ShiftClk</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">EE_Write0</span><span class="o">=</span><span class="mh">0x801</span><span class="p">,</span> <span class="n">EE_Write1</span><span class="o">=</span><span class="mh">0x805</span><span class="p">,</span>
	<span class="n">EE_ChipSelect</span><span class="o">=</span><span class="mh">0x801</span><span class="p">,</span> <span class="n">EE_DataIn</span><span class="o">=</span><span class="mh">0x08</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The EEPROM commands include the alway-set leading bit. */</span>
<span class="k">enum</span> <span class="n">EEPROM_Cmds</span> <span class="p">{</span>
	<span class="n">EE_WriteCmd</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="n">EE_ReadCmd</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="n">EE_EraseCmd</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ee_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EECtrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_cmd</span> <span class="o">=</span> <span class="n">location</span> <span class="o">|</span> <span class="n">EE_ReadCmd</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">EE_ChipSelect</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>

	<span class="cm">/* Shift the read command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">EE_Write1</span> <span class="o">:</span> <span class="n">EE_Write0</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dataval</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dataval</span> <span class="o">|</span> <span class="n">EE_ShiftClk</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">EE_ChipSelect</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
	<span class="n">eeprom_delay</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">EE_ChipSelect</span> <span class="o">|</span> <span class="n">EE_ShiftClk</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EE_DataIn</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">EE_ChipSelect</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Terminate the EEPROM access. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  MII transceiver control section.</span>
<span class="cm">	Read and write the MII registers using software-generated serial</span>
<span class="cm">	MDIO protocol.  See the MII specifications or DP83840A data sheet</span>
<span class="cm">	for details.</span>

<span class="cm">	The maximum data clock rate is 2.5 Mhz.  The minimum timing is usually</span>
<span class="cm">	met by back-to-back 33Mhz PCI cycles. */</span>
<span class="cp">#define mdio_delay(mdio_addr) ioread32(mdio_addr)</span>

<span class="cm">/* Set iff a MII transceiver on any interface requires mdio preamble.</span>
<span class="cm">   This only set with older transceivers, so the extra</span>
<span class="cm">   code size of a per-interface flag is not worthwhile. */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">mii_preamble_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#define MDIO_WRITE0 (MDIO_EnbOutput)</span>
<span class="cp">#define MDIO_WRITE1 (MDIO_DataOut | MDIO_EnbOutput)</span>

<span class="cm">/* Generate the preamble required for initial synchronization and</span>
<span class="cm">   a few older transceivers. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_sync</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mdio_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* Establish sync by sending at least 32 logic ones. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">bits</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">MDIO_WRITE1</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">MDIO_WRITE1</span> <span class="o">|</span> <span class="n">MDIO_ShiftClk</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mdio_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">MIICtrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mii_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xf6</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">location</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_preamble_required</span><span class="p">)</span>
		<span class="n">mdio_sync</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>

	<span class="cm">/* Shift the read command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">mii_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">MDIO_WRITE1</span> <span class="o">:</span> <span class="n">MDIO_WRITE0</span><span class="p">;</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dataval</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dataval</span> <span class="o">|</span> <span class="n">MDIO_ShiftClk</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Read the two transition, 16 data, and wire-idle bits. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">MDIO_EnbIn</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDIO_DataIn</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">MDIO_EnbIn</span> <span class="o">|</span> <span class="n">MDIO_ShiftClk</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mdio_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">MIICtrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mii_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x5002</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">location</span><span class="o">&lt;&lt;</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">==</span> <span class="mi">4</span>  <span class="o">&amp;&amp;</span>  <span class="n">phy_id</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_preamble_required</span><span class="p">)</span>
		<span class="n">mdio_sync</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>

	<span class="cm">/* Shift the command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">mii_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">MDIO_WRITE1</span> <span class="o">:</span> <span class="n">MDIO_WRITE0</span><span class="p">;</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dataval</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dataval</span> <span class="o">|</span> <span class="n">MDIO_ShiftClk</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Clear out extra bits. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">MDIO_EnbIn</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">MDIO_EnbIn</span> <span class="o">|</span> <span class="n">MDIO_ShiftClk</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PCIBusCfg</span><span class="p">);</span>		<span class="cm">/* Reset */</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">intr_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;w89c840_open() irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">i</span><span class="o">=</span><span class="n">alloc_ringdesc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Done netdev_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set the timer to check for link beat. */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">netdev_timer</span><span class="p">;</span>				<span class="cm">/* timer handler */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MII_DAVICOM_DM9101	0x0181b800</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">fasteth</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">mii_reg</span><span class="p">;</span>

	<span class="cm">/* BSMR */</span>
	<span class="n">mii_reg</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_reg</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">;</span>
	<span class="cm">/* reread: the link status bit is sticky */</span>
	<span class="n">mii_reg</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mii_reg</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;MII #%d reports no link. Disabling watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;MII #%d link is back. Enabling watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">MII_DAVICOM_DM9101</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the link partner doesn&#39;t support autonegotiation</span>
<span class="cm">		 * the MII detects it&#39;s abilities with the &quot;parallel detection&quot;.</span>
<span class="cm">		 * Some MIIs update the LPA register to the result of the parallel</span>
<span class="cm">		 * detection, some don&#39;t.</span>
<span class="cm">		 * The Davicom PHY [at least 0181b800] doesn&#39;t.</span>
<span class="cm">		 * Instead bit 9 and 13 of the BMCR are updated to the result</span>
<span class="cm">		 * of the negotiation..</span>
<span class="cm">		 */</span>
		<span class="n">mii_reg</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="n">duplex</span> <span class="o">=</span> <span class="n">mii_reg</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="n">fasteth</span> <span class="o">=</span> <span class="n">mii_reg</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">negotiated</span><span class="p">;</span>
		<span class="n">mii_reg</span>	<span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_LPA</span><span class="p">);</span>
		<span class="n">negotiated</span> <span class="o">=</span> <span class="n">mii_reg</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>

		<span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">negotiated</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">negotiated</span> <span class="o">&amp;</span> <span class="mh">0x02C0</span><span class="p">)</span> <span class="o">==</span> <span class="n">LPA_10FULL</span><span class="p">);</span>
		<span class="n">fasteth</span> <span class="o">=</span> <span class="n">negotiated</span> <span class="o">&amp;</span> <span class="mh">0x380</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">duplex</span> <span class="o">|=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">force_media</span><span class="p">;</span>
	<span class="cm">/* remove fastether and fullduplex */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20000200</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fasteth</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;&amp;</span> <span class="n">debug</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Setting %dMBit-%s-duplex based on MII#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">fasteth</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">,</span>
			 <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RXTX_TIMEOUT	2000</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_csr6</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">RXTX_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">==</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* stop both Tx and Rx processes */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2002</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NetworkConfig</span><span class="p">);</span>
	<span class="cm">/* wait until they have really stopped */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">csr5</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="o">||</span><span class="n">t</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* rx stopped */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr5</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="o">||</span><span class="n">t</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">limit</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;couldn&#39;t stop rxtx, IntrStatus %xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csr5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="cm">/* and restart them with the new configuration */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NetworkConfig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Media selection timer tick, status %08x config %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">),</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NetworkConfig</span><span class="p">));</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">update_csr6</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">update_link</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_rxtx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_head_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">w840_tx_desc</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>

	<span class="cm">/* Initial all Rx descriptors. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Mark the last entry as wrapping the ring. */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">|=</span> <span class="n">DescEndRing</span><span class="p">;</span>

	<span class="cm">/* Fill in the Rx buffers.  Handle allocation failure gracefully. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span><span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer1</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">DescOwned</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">i</span> <span class="o">-</span> <span class="n">RX_RING_SIZE</span><span class="p">);</span>

	<span class="cm">/* Initialize the Tx descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_q_bytes</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_dma_addr</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">RxRingPtr</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_dma_addr</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w840_rx_desc</span><span class="p">)</span><span class="o">*</span><span class="n">RX_RING_SIZE</span><span class="p">,</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TxRingPtr</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rxtx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span><span class="o">*</span> <span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* Free all the skbuffs in the Rx queue. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">StationAddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Initialize other registers. */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">);</span>	<span class="cm">/* Big-endian descriptors */</span>
<span class="cp">#else</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x04</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* skip length 4 u32 */</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>		<span class="cm">/* give Rx priority */</span>

	<span class="cm">/* Configure the PCI bus bursts and FIFO thresholds.</span>
<span class="cm">	   486: Set 8 longword cache alignment, 8 longword burst.</span>
<span class="cm">	   586: Set 16 longword cache alignment, no burst limit.</span>
<span class="cm">	   Cache alignment bits 15:14	     Burst length 13:8</span>
<span class="cm">		0000	&lt;not allowed&gt; 		0000 align to cache	0800 8 longwords</span>
<span class="cm">		4000	8  longwords		0100 1 longword		1000 16 longwords</span>
<span class="cm">		8000	16 longwords		0200 2 longwords	2000 32 longwords</span>
<span class="cm">		C000	32  longwords		0400 4 longwords */</span>

<span class="cp">#if defined (__i386__) &amp;&amp; !defined(MODULE)</span>
	<span class="cm">/* When not a module we can work around broken &#39;486 PCI boards. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x4800</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;This is a 386/486 PCI system, setting cache alignment to 8 longwords</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">|=</span> <span class="mh">0xE000</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#elif defined(__powerpc__) || defined(__i386__) || defined(__alpha__) || defined(__ia64__) || defined(__x86_64__)</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="mh">0xE000</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_SPARC) || defined (CONFIG_PARISC)</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x4800</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#warning Processor architecture undefined</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x4800</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PCIBusCfg</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* 128 byte Tx threshold;</span>
<span class="cm">		Transmit on; Receive on; */</span>
	<span class="n">update_csr6</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00022002</span> <span class="o">|</span> <span class="n">update_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">__set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/* Clear and Enable interrupts by setting the interrupt mask. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x1A0F5</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x1A0F5</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStartDemand</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit timed out, status %08x, resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">));</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Rx ring %p: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Tx ring %p: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Tx cur %d Tx dirty %d Tx Full %d, q bytes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_q_bytes</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Tx Descriptor addr %xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4C</span><span class="p">));</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Under high load dirty_tx and the internal tx descriptor pointer</span>
<span class="cm">	 * come out of sync, thus perform a software reset and reinitialize</span>
<span class="cm">	 * everything.</span>
<span class="cm">	 */</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">PCIBusCfg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">free_rxtx_rings</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">init_rxtx_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the Rx and Tx rings, along with various &#39;dev&#39; bits. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_ringdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="mi">1500</span> <span class="o">?</span> <span class="n">PKT_BUF_SZ</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w840_rx_desc</span><span class="p">)</span><span class="o">*</span><span class="n">RX_RING_SIZE</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w840_tx_desc</span><span class="p">)</span><span class="o">*</span><span class="n">TX_RING_SIZE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_dma_addr</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">init_rxtx_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_ringdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w840_rx_desc</span><span class="p">)</span><span class="o">*</span><span class="n">RX_RING_SIZE</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w840_tx_desc</span><span class="p">)</span><span class="o">*</span><span class="n">TX_RING_SIZE</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_dma_addr</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">entry</span><span class="p">;</span>

	<span class="cm">/* Caution: the write order is important here, set the field</span>
<span class="cm">	   with the &quot;ownership&quot; bits last. */</span>

	<span class="cm">/* Calculate the next Tx descriptor entry. */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">TX_BUFLIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">DescWholePkt</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">TX_BUFLIMIT</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer2</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">+</span><span class="n">TX_BUFLIMIT</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">DescWholePkt</span> <span class="o">|</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">TX_BUFLIMIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">TX_RING_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">|=</span> <span class="n">DescEndRing</span><span class="p">;</span>

	<span class="cm">/* Now acquire the irq spinlock.</span>
<span class="cm">	 * The difficult race is the ordering between</span>
<span class="cm">	 * increasing np-&gt;cur_tx and setting DescOwned:</span>
<span class="cm">	 * - if np-&gt;cur_tx is increased first the interrupt</span>
<span class="cm">	 *   handler could consider the packet as transmitted</span>
<span class="cm">	 *   since DescOwned is cleared.</span>
<span class="cm">	 * - If DescOwned is set first the NIC could report the</span>
<span class="cm">	 *   packet as sent, but the interrupt handler would ignore it</span>
<span class="cm">	 *   since the np-&gt;cur_tx was not yet increased.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span> <span class="cm">/* flush length, buffer1, buffer2 */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">DescOwned</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span> <span class="cm">/* flush status and kick the hardware */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TxStartDemand</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_q_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="cm">/* Work around horrible bug in the chip by marking the queue as full</span>
<span class="cm">	   when we do not have FIFO room for a maximum sized packet. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="n">TX_QUEUE_LEN</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HasBrokenTx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_q_bytes</span> <span class="o">&gt;</span> <span class="n">TX_BUG_FIFO_LIMIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit frame #%d queued in slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span> 	<span class="cm">/* There was an error, log it. */</span>
<span class="cp">#ifndef final_version</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit error, Tx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">tx_status</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0104</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0C80</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifndef final_version</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit slot %d ok, Tx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">entry</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Free the original skb. */</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_q_bytes</span> <span class="o">-=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">&amp;&amp;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&lt;</span> <span class="n">TX_QUEUE_LEN_RESTART</span> <span class="o">&amp;&amp;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_q_bytes</span> <span class="o">&lt;</span> <span class="n">TX_BUG_FIFO_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The ring is no longer full, clear tbusy. */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_limit</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">intr_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">);</span>

		<span class="cm">/* Acknowledge all of the current interrupt sources ASAP. */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="mh">0x001ffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Interrupt, status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NormalIntr</span><span class="o">|</span><span class="n">AbnormalIntr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxIntr</span> <span class="o">|</span> <span class="n">RxNoBuf</span><span class="p">))</span>
			<span class="n">netdev_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">RxNoBuf</span><span class="p">)</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStartDemand</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxNoBuf</span> <span class="o">|</span> <span class="n">TxIntr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">netdev_tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Abnormal error summary/uncommon events handlers. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AbnormalIntr</span> <span class="o">|</span> <span class="n">TxFIFOUnderflow</span> <span class="o">|</span> <span class="n">SystemError</span> <span class="o">|</span>
						   <span class="n">TimerInt</span> <span class="o">|</span> <span class="n">TxDied</span><span class="p">))</span>
			<span class="n">netdev_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">work_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Too much work at interrupt, status=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">intr_status</span><span class="p">);</span>
			<span class="cm">/* Set the timer to re-enable the other interrupts after</span>
<span class="cm">			   10*82usec ticks. */</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">AbnormalIntr</span> <span class="o">|</span> <span class="n">TimerInt</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GPTimer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;exiting interrupt, status=%#4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This routine is logically part of the interrupt handler, but separated</span>
<span class="cm">   for clarity and better register allocation. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+</span> <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; In netdev_rx(), entry %d status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">entry</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If EOP is set on the next entry, it&#39;s a new packet. Send it up. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">work_limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">w840_rx_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_head_desc</span><span class="p">;</span>
		<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  netdev_rx() status was %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x38008300</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x38000300</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Ingore earlier buffers. */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="s">&quot;Oversized Ethernet frame spanned multiple buffers, entry %#x status %04x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* There was a fatal error. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Receive error, Rx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">status</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* end of a packet.*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0890</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x004C</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="cm">/* Omit the four octet CRC from the length. */</span>
			<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#ifndef final_version</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  netdev_rx() normal Rx pkt length %d status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">pkt_len</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* Check if the packet is long enough to accept without copying</span>
<span class="cm">			   to a minimally-sized skbuff. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">rx_copybreak</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 16 byte align the IP header */</span>
				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
							    <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
							    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
							       <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
							       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
							<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
							<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifndef final_version				</span><span class="cm">/* Remove after testing. */</span><span class="cp"></span>
			<span class="cm">/* You will want this info for the initial debug. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  Rx data %pM %pM %02x%02x %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
					   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
					   <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_head_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Refill the Rx ring buffers. */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>			<span class="cm">/* Better luck next round. */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">buffer1</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">DescOwned</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Abnormal event, %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">TxFIFOUnderflow</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">new</span><span class="p">;</span>
		<span class="cm">/* Bump up the Tx threshold */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* This causes lots of dropped packets,</span>
<span class="c">		 * and under high load even tx_timeouts</span>
<span class="c">		 */</span>
<span class="c">		new = np-&gt;csr6 + 0x4000;</span>
<span class="cp">#else</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">new</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		 <span class="k">else</span>
		 	<span class="n">new</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span> <span class="cm">/* load full packet before starting */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7F</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">new</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx underflow, new csr6 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="n">update_csr6</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">RxDied</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Missed a Rx frame. */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">TimerInt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Re-enable other interrupts. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x1A0F5</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxMissed</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStartDemand</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* The chip only need report frame silently dropped. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxMissed</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u32</span> <span class="nf">__set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="cm">/* Multicast hash filter */</span>
	<span class="n">u32</span> <span class="n">rx_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* Set promiscuous. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">RxAcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">RxAcceptAllPhys</span>
			<span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to match, or accept all multicasts. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">RxAcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">filbit</span><span class="p">;</span>

			<span class="n">filbit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x3F</span><span class="p">;</span>
			<span class="n">filbit</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">filbit</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">filbit</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">RxAcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MulticastFilter0</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MulticastFilter1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rx_mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_mode</span> <span class="o">=</span> <span class="n">__set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">update_csr6</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00F8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rx_mode</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_get_drvinfo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netdev_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netdev_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">netdev_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">netdev_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">netdev_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">netdev_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">netdev_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">netdev_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">netdev_set_msglevel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:		<span class="cm">/* Get address of MII PHY in use. */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="cm">/* Fall Through */</span>

	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:		<span class="cm">/* Read MII PHY register. */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:		<span class="cm">/* Write MII PHY register. */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Shutting down ethercard, status was %08x Config %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">),</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NetworkConfig</span><span class="p">));</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Queue pointers were Tx %d / %d,  Rx %d / %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="p">);</span>
	<span class="p">}</span>

 	<span class="cm">/* Stop the chip&#39;s Tx and Rx processes. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">update_csr6</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NetworkConfig</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxMissed</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

<span class="cp">#ifdef __i386__</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;  Tx ring at %p:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; #%d desc. %04x %04x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
			       <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Rx ring %p:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; #%d desc. %04x %04x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
			       <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __i386__ debugging only */</span><span class="cp"></span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">free_rxtx_rings</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">free_ringdesc</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">w840_remove1</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/*</span>
<span class="cm"> * suspend/resume synchronization:</span>
<span class="cm"> * - open, close, do_ioctl:</span>
<span class="cm"> * 	rtnl_lock, &amp; netif_device_detach after the rtnl_unlock.</span>
<span class="cm"> * - get_stats:</span>
<span class="cm"> * 	spin_lock_irq(np-&gt;lock), doesn&#39;t touch hw if not present</span>
<span class="cm"> * - start_xmit:</span>
<span class="cm"> * 	synchronize_irq + netif_tx_disable;</span>
<span class="cm"> * - tx_timeout:</span>
<span class="cm"> * 	netif_device_detach + netif_tx_disable;</span>
<span class="cm"> * - set_multicast_list</span>
<span class="cm"> * 	netif_device_detach + netif_tx_disable;</span>
<span class="cm"> * - interrupt handler</span>
<span class="cm"> * 	doesn&#39;t touch hw if not present, synchronize_irq waits for</span>
<span class="cm"> * 	running instances of the interrupt handler.</span>
<span class="cm"> *</span>
<span class="cm"> * Disabling hw requires clearing csr6 &amp; IntrEnable.</span>
<span class="cm"> * update_csr6 &amp; all function that write IntrEnable check netif_device_present</span>
<span class="cm"> * before settings any bits.</span>
<span class="cm"> *</span>
<span class="cm"> * Detach must occur under spin_unlock_irq(), interrupts from a detached</span>
<span class="cm"> * device would cause an irq storm.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w840_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">update_csr6</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxMissed</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="cm">/* no more hardware accesses behind this line. */</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">csr6</span> <span class="o">||</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">));</span>

		<span class="cm">/* pci_power_off(pdev, -1); */</span>

		<span class="n">free_rxtx_rings</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w840_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* device not suspended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pci_enable_device failed in resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">PCIBusCfg</span><span class="p">);</span>
		<span class="n">ioread32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">PCIBusCfg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">init_rxtx_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">init_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">w840_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">w840_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">w840_probe1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">w840_remove1</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">w840_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">w840_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">w840_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w840_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">w840_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w840_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">w840_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">w840_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
