<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › tundra › tsi108_eth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tsi108_eth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Copyright(c) 2006 Tundra Semiconductor Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms of the GNU General Public License as published by the Free</span>
<span class="cm">  Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm">  any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm">  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>

<span class="cm">*******************************************************************************/</span>

<span class="cm">/* This driver is based on the driver code originally developed</span>
<span class="cm"> * for the Intel IOC80314 (ForestLake) Gigabit Ethernet by</span>
<span class="cm"> * scott.wood@timesys.com  * Copyright (C) 2003 TimeSys Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Currently changes from original version are:</span>
<span class="cm"> * - porting to Tsi108-based platform and kernel 2.6 (kong.lai@tundra.com)</span>
<span class="cm"> * - modifications to handle two ports independently and support for</span>
<span class="cm"> *   additional PHY devices (alexandre.bounine@tundra.com)</span>
<span class="cm"> * - Get hardware information from platform device. (tie-fei.zang@freescale.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/tsi108.h&gt;</span>

<span class="cp">#include &quot;tsi108_eth.h&quot;</span>

<span class="cp">#define MII_READ_DELAY 10000	</span><span class="cm">/* max link wait time in msec */</span><span class="cp"></span>

<span class="cp">#define TSI108_RXRING_LEN     256</span>

<span class="cm">/* NOTE: The driver currently does not support receiving packets</span>
<span class="cm"> * larger than the buffer size, so don&#39;t decrease this (unless you</span>
<span class="cm"> * want to add such support).</span>
<span class="cm"> */</span>
<span class="cp">#define TSI108_RXBUF_SIZE     1536</span>

<span class="cp">#define TSI108_TXRING_LEN     256</span>

<span class="cp">#define TSI108_TX_INT_FREQ    64</span>

<span class="cm">/* Check the phy status every half a second. */</span>
<span class="cp">#define CHECK_PHY_INTERVAL (HZ/2)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tsi108_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tsi108_ether_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="p">{</span>
	<span class="kt">void</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>	<span class="cm">/* Base of normal regs */</span>
	<span class="kt">void</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="n">phyregs</span><span class="p">;</span>	<span class="cm">/* Base of register bank used for PHY access */</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">;</span>		<span class="cm">/* Index of PHY for this interface */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_type</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span><span class="cm">/* Timer that triggers the check phy function */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxtail</span><span class="p">;</span>	<span class="cm">/* Next entry in rxring to read */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxhead</span><span class="p">;</span>	<span class="cm">/* Next entry in rxring to give a new buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxfree</span><span class="p">;</span>	<span class="cm">/* Number of free, allocated RX buffers */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxpending</span><span class="p">;</span>	<span class="cm">/* Non-zero if there are still descriptors</span>
<span class="cm">				 * to be processed from a previous descriptor</span>
<span class="cm">				 * interrupt condition that has been cleared */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txtail</span><span class="p">;</span>	<span class="cm">/* Next TX descriptor to check status on */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txhead</span><span class="p">;</span>	<span class="cm">/* Next TX descriptor to use */</span>

	<span class="cm">/* Number of free TX descriptors.  This could be calculated from</span>
<span class="cm">	 * rxhead and rxtail if one descriptor were left unused to disambiguate</span>
<span class="cm">	 * full and empty conditions, but it&#39;s simpler to just keep track</span>
<span class="cm">	 * explicitly. */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txfree</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_ok</span><span class="p">;</span>		<span class="cm">/* The PHY is currently powered on. */</span>

	<span class="cm">/* PHY status (duplex is 1 for half, 2 for full,</span>
<span class="cm">	 * so that the default 0 indicates that neither has</span>
<span class="cm">	 * yet been configured). */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>

	<span class="n">tx_desc</span> <span class="o">*</span><span class="n">txring</span><span class="p">;</span>
	<span class="n">rx_desc</span> <span class="o">*</span><span class="n">rxring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txskbs</span><span class="p">[</span><span class="n">TSI108_TXRING_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">TSI108_RXRING_LEN</span><span class="p">];</span>

	<span class="n">dma_addr_t</span> <span class="n">txdma</span><span class="p">,</span> <span class="n">rxdma</span><span class="p">;</span>

	<span class="cm">/* txlock nests in misclock and phy_lock */</span>

	<span class="n">spinlock_t</span> <span class="n">txlock</span><span class="p">,</span> <span class="n">misclock</span><span class="p">;</span>

	<span class="cm">/* stats is used to hold the upper bits of each hardware counter,</span>
<span class="cm">	 * and tmpstats is used to hold the full values for returning</span>
<span class="cm">	 * to the caller of get_stats().  They must be separate in case</span>
<span class="cm">	 * an overflow interrupt occurs before the stats are consumed.</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">tmpstats</span><span class="p">;</span>

	<span class="cm">/* These stats are kept separate in hardware, thus require individual</span>
<span class="cm">	 * fields for handling carry.  They are combined in get_stats.</span>
<span class="cm">	 */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_fcs</span><span class="p">;</span>	<span class="cm">/* Add to rx_frame_errors */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_short_fcs</span><span class="p">;</span>	<span class="cm">/* Add to rx_frame_errors */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_long_fcs</span><span class="p">;</span>	<span class="cm">/* Add to rx_frame_errors */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_underruns</span><span class="p">;</span>	<span class="cm">/* Add to rx_length_errors */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_overruns</span><span class="p">;</span>	<span class="cm">/* Add to rx_length_errors */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_coll_abort</span><span class="p">;</span>	<span class="cm">/* Add to tx_aborted_errors/collisions */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_pause_drop</span><span class="p">;</span>	<span class="cm">/* Add to tx_aborted_errors */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mc_hash</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>			<span class="cm">/* debug message level */</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii_if</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init_media</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Structure for a device driver */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">tsi_eth_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tsi108_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">tsi108_ether_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tsi-ethernet&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tsi108_timed_checker</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_ptr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_eth_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Dumping %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;intstat %x intmask %x phy_ok %d&quot;</span>
	       <span class="s">&quot; link %d speed %d duplex %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">),</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_ok</span><span class="p">,</span>
	       <span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX: head %d, tail %d, free %d, stat %x, estat %x, err %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span><span class="p">,</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXSTAT</span><span class="p">),</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXESTAT</span><span class="p">),</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXERR</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RX: head %d, tail %d, free %d, stat %x,&quot;</span>
	       <span class="s">&quot; estat %x, err %x, pending %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxhead</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span><span class="p">,</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXSTAT</span><span class="p">),</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXESTAT</span><span class="p">),</span>
	       <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXERR</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxpending</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Synchronization is needed between the thread and up/down events.</span>
<span class="cm"> * Note that the PHY is accessed through the same registers for both</span>
<span class="cm"> * interfaces, so this can&#39;t be made interface-specific.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">phy_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_read_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">TSI_WRITE_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_ADDR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_MAC_MII_ADDR_PHY</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_MAC_MII_ADDR_REG</span><span class="p">));</span>
	<span class="n">TSI_WRITE_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">TSI_WRITE_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_CMD</span><span class="p">,</span> <span class="n">TSI108_MAC_MII_CMD_READ</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_IND</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="n">TSI108_MAC_MII_IND_NOTVALID</span> <span class="o">|</span> <span class="n">TSI108_MAC_MII_IND_BUSY</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">TSI_READ_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_DATAIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_write_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">TSI_WRITE_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_ADDR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_MAC_MII_ADDR_PHY</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_MAC_MII_ADDR_REG</span><span class="p">));</span>
	<span class="n">TSI_WRITE_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_DATAOUT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ_PHY</span><span class="p">(</span><span class="n">TSI108_MAC_MII_IND</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">TSI108_MAC_MII_IND_BUSY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tsi108_read_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tsi108_write_tbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_MII_ADDR</span><span class="p">,</span>
			     <span class="p">(</span><span class="mh">0x1e</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_MAC_MII_ADDR_PHY</span><span class="p">)</span>
			     <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_MAC_MII_ADDR_REG</span><span class="p">));</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_MII_DATAOUT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_MAC_MII_IND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSI108_MAC_MII_IND_BUSY</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s function time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_if_info</span> <span class="o">*</span><span class="n">mii</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">advert</span><span class="p">,</span> <span class="n">lpa</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">media</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lpa2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mii_link_ok</span><span class="p">(</span><span class="n">mii</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">mdio_read</span><span class="p">)</span> <span class="p">(</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mii</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCOMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">advert</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">mdio_read</span><span class="p">)</span> <span class="p">(</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mii</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="n">lpa</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">mdio_read</span><span class="p">)</span> <span class="p">(</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mii</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
	<span class="n">media</span> <span class="o">=</span> <span class="n">mii_nway_result</span><span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">lpa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">supports_gmii</span><span class="p">)</span>
		<span class="n">lpa2</span> <span class="o">=</span> <span class="n">mii</span><span class="o">-&gt;</span><span class="n">mdio_read</span><span class="p">(</span><span class="n">mii</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mii</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">);</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="n">lpa2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_1000FULL</span> <span class="o">|</span> <span class="n">LPA_1000HALF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">media</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_100FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_100HALF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_check_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mac_cfg2_reg</span><span class="p">,</span> <span class="n">portctrl_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_ok</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">duplex</span> <span class="o">=</span> <span class="n">mii_check_media</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">netif_msg_link</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">init_media</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">init_media</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">speed</span> <span class="o">=</span> <span class="n">mii_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="o">||</span> <span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">mac_cfg2_reg</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_MAC_CFG2</span><span class="p">);</span>
			<span class="n">portctrl_reg</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_PORTCTRL</span><span class="p">);</span>

			<span class="n">mac_cfg2_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI108_MAC_CFG2_IFACE_MASK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_cfg2_reg</span> <span class="o">|=</span> <span class="n">TSI108_MAC_CFG2_GIG</span><span class="p">;</span>
				<span class="n">portctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI108_EC_PORTCTRL_NOGIG</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mac_cfg2_reg</span> <span class="o">|=</span> <span class="n">TSI108_MAC_CFG2_NOGIG</span><span class="p">;</span>
				<span class="n">portctrl_reg</span> <span class="o">|=</span> <span class="n">TSI108_EC_PORTCTRL_NOGIG</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_cfg2_reg</span> <span class="o">|=</span> <span class="n">TSI108_MAC_CFG2_FULLDUPLEX</span><span class="p">;</span>
				<span class="n">portctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI108_EC_PORTCTRL_HALFDUPLEX</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mac_cfg2_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI108_MAC_CFG2_FULLDUPLEX</span><span class="p">;</span>
				<span class="n">portctrl_reg</span> <span class="o">|=</span> <span class="n">TSI108_EC_PORTCTRL_HALFDUPLEX</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG2</span><span class="p">,</span> <span class="n">mac_cfg2_reg</span><span class="p">);</span>
			<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_PORTCTRL</span><span class="p">,</span> <span class="n">portctrl_reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The manual says it can take 3-4 usecs for the speed change</span>
<span class="cm">			 * to take effect.</span>
<span class="cm">			 */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s : link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>


<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">tsi108_stat_carry_one</span><span class="p">(</span><span class="kt">int</span> <span class="n">carry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">carry_bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">carry_shift</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">upper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">carry</span> <span class="o">&amp;</span> <span class="n">carry_bit</span><span class="p">)</span>
		<span class="o">*</span><span class="n">upper</span> <span class="o">+=</span> <span class="n">carry_shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_stat_carry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">carry1</span><span class="p">,</span> <span class="n">carry2</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>

	<span class="n">carry1</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_STAT_CARRY1</span><span class="p">);</span>
	<span class="n">carry2</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_STAT_CARRY2</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_STAT_CARRY1</span><span class="p">,</span> <span class="n">carry1</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_STAT_CARRY2</span><span class="p">,</span> <span class="n">carry2</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXBYTES</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXBYTES_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXPKTS</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXPKTS_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXFCS</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXFCS_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_fcs</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXMCAST</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXMCAST_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXALIGN</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXALIGN_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXLENGTH</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXLENGTH_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXRUNT</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXRUNT_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_underruns</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXJUMBO</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXJUMBO_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_overruns</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXFRAG</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXFRAG_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_short_fcs</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXJABBER</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXJABBER_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_long_fcs</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry1</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY1_RXDROP</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_RXDROP_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry2</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY2_TXBYTES</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_TXBYTES_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry2</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY2_TXPKTS</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_TXPKTS_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry2</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY2_TXEXDEF</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_TXEXDEF_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry2</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY2_TXEXCOL</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_TXEXCOL_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tx_coll_abort</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry2</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY2_TXTCOL</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_TXTCOL_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="p">);</span>

	<span class="n">tsi108_stat_carry_one</span><span class="p">(</span><span class="n">carry2</span><span class="p">,</span> <span class="n">TSI108_STAT_CARRY2_TXPAUSE</span><span class="p">,</span>
			      <span class="n">TSI108_STAT_TXPAUSEDROP_CARRY</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tx_pause_drop</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read a stat counter atomically with respect to carries.</span>
<span class="cm"> * data-&gt;misclock must be held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">tsi108_read_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">carry_bit</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">carry_shift</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">upper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">carryreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xb0</span><span class="p">)</span>
		<span class="n">carryreg</span> <span class="o">=</span> <span class="n">TSI108_STAT_CARRY1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">carryreg</span> <span class="o">=</span> <span class="n">TSI108_STAT_CARRY2</span><span class="p">;</span>

      <span class="nl">again:</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="n">upper</span><span class="p">;</span>

	<span class="cm">/* Check to see if it overflowed, but the interrupt hasn&#39;t</span>
<span class="cm">	 * been serviced yet.  If so, handle the carry here, and</span>
<span class="cm">	 * try again.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">carryreg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">carry_bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">upper</span> <span class="o">+=</span> <span class="n">carry_shift</span><span class="p">;</span>
		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">carryreg</span><span class="p">,</span> <span class="n">carry_bit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">tsi108_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">excol</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXPKTS</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXPKTS</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXPKTS_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_TXPKTS</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY2_TXPKTS</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_TXPKTS_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXBYTES</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXBYTES</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXBYTES_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_TXBYTES</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY2_TXBYTES</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_TXBYTES_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXMCAST</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXMCAST</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXMCAST_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">);</span>

	<span class="n">excol</span> <span class="o">=</span> <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_TXEXCOL</span><span class="p">,</span>
				 <span class="n">TSI108_STAT_CARRY2_TXEXCOL</span><span class="p">,</span>
				 <span class="n">TSI108_STAT_TXEXCOL_CARRY</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tx_coll_abort</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_TXTCOL</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY2_TXTCOL</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_TXTCOL_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">excol</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXLENGTH</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXLENGTH</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXLENGTH_CARRY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXRUNT</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXRUNT</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXRUNT_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_underruns</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXJUMBO</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXJUMBO</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXJUMBO_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_overruns</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXALIGN</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXALIGN</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXALIGN_CARRY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXFCS</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXFCS</span><span class="p">,</span> <span class="n">TSI108_STAT_RXFCS_CARRY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_fcs</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXFRAG</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXFRAG</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXFRAG_CARRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_short_fcs</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_RXDROP</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY1_RXDROP</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_RXDROP_CARRY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="p">);</span>

	<span class="cm">/* These three are maintained by software. */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_TXEXDEF</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY2_TXEXDEF</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_TXEXDEF_CARRY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span>
	    <span class="n">tsi108_read_stat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TSI108_STAT_TXPAUSEDROP</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_CARRY2_TXPAUSE</span><span class="p">,</span>
			     <span class="n">TSI108_STAT_TXPAUSEDROP_CARRY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tx_pause_drop</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">excol</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tmpstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_restart_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXQ_PTRHIGH</span><span class="p">,</span>
			     <span class="n">TSI108_EC_RXQ_PTRHIGH_VALID</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXCTRL</span><span class="p">,</span> <span class="n">TSI108_EC_RXCTRL_GO</span>
			     <span class="o">|</span> <span class="n">TSI108_EC_RXCTRL_QUEUE0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_restart_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXQ_PTRHIGH</span><span class="p">,</span>
			     <span class="n">TSI108_EC_TXQ_PTRHIGH_VALID</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXCTRL</span><span class="p">,</span> <span class="n">TSI108_EC_TXCTRL_IDLEINT</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_TXCTRL_GO</span> <span class="o">|</span> <span class="n">TSI108_EC_TXCTRL_QUEUE0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* txlock must be held by caller, with IRQs disabled, and</span>
<span class="cm"> * with permission to re-enable them when the lock is dropped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_complete_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_TX_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txskbs</span><span class="p">[</span><span class="n">tx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_TX_OK</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bad tx packet, misc %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">misc</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TSI108_TXRING_LEN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_TX_EOF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">release</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_ok</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Transmit while PHY is down!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Transmit while link is down!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span> <span class="o">&lt;</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Transmit with full tx ring!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span> <span class="o">-</span> <span class="n">frags</span> <span class="o">&lt;</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span><span class="p">;</span>

		<span class="cm">/* This is done to mark every TSI108_TX_INT_FREQ tx buffers with</span>
<span class="cm">		 * the interrupt bit.  TX descriptor-complete interrupts are</span>
<span class="cm">		 * enabled when the queue fills up, and masked when there is</span>
<span class="cm">		 * still free space.  This way, when saturating the outbound</span>
<span class="cm">		 * link, the tx interrupts are kept to a reasonable level.</span>
<span class="cm">		 * When the queue is not full, reclamation of skbs still occurs</span>
<span class="cm">		 * as new packets are transmitted, or on a queue-empty</span>
<span class="cm">		 * interrupt.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tx</span> <span class="o">%</span> <span class="n">TSI108_TX_INT_FREQ</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">TSI108_TXRING_LEN</span> <span class="o">-</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TSI108_TX_INT_FREQ</span><span class="p">))</span>
			<span class="n">misc</span> <span class="o">=</span> <span class="n">TSI108_TX_INT</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txskbs</span><span class="p">[</span><span class="n">tx</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">buf0</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">misc</span> <span class="o">|=</span> <span class="n">TSI108_TX_SOF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">buf0</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span>
								 <span class="mi">0</span><span class="p">,</span>
								 <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
								 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">misc</span> <span class="o">|=</span> <span class="n">TSI108_TX_EOF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Tx Frame contents (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2x&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">tx</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span> <span class="o">|</span> <span class="n">TSI108_TX_OWN</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TSI108_TXRING_LEN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tsi108_complete_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* This must be done after the check for completed tx descriptors,</span>
<span class="cm">	 * so that the tail pointer is correct.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSI108_EC_TXSTAT_QUEUE0</span><span class="p">))</span>
		<span class="n">tsi108_restart_tx</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_complete_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span> <span class="o">&amp;&amp;</span> <span class="n">done</span> <span class="o">!=</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_RX_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">rx</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TSI108_RXRING_LEN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span><span class="o">--</span><span class="p">;</span>
		<span class="n">done</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_RX_BAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_RX_CRC</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">TSI108_RX_OVER</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>

			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Rx Frame contents (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2x&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_refill_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span> <span class="o">!=</span> <span class="n">TSI108_RXRING_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">done</span> <span class="o">!=</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxhead</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TSI108_RXBUF_SIZE</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">buf0</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							<span class="n">TSI108_RX_SKB_SIZE</span><span class="p">,</span>
							<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="cm">/* Sometimes the hardware sets blen to zero after packet</span>
<span class="cm">		 * reception, even though the manual says that it&#39;s only ever</span>
<span class="cm">		 * modified by the driver.</span>
<span class="cm">		 */</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">blen</span> <span class="o">=</span> <span class="n">TSI108_RX_SKB_SIZE</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="n">TSI108_RX_OWN</span> <span class="o">|</span> <span class="n">TSI108_RX_INT</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TSI108_RXRING_LEN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span><span class="o">++</span><span class="p">;</span>
		<span class="n">done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="n">TSI108_EC_RXSTAT_QUEUE0</span><span class="p">))</span>
		<span class="n">tsi108_restart_rx</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsi108_prv_data</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">estat</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXESTAT</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">intstat</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intstat</span> <span class="o">&amp;=</span> <span class="n">TSI108_INT_RXQUEUE0</span> <span class="o">|</span> <span class="n">TSI108_INT_RXTHRESH</span> <span class="o">|</span>
	    <span class="n">TSI108_INT_RXOVERRUN</span> <span class="o">|</span> <span class="n">TSI108_INT_RXERROR</span> <span class="o">|</span> <span class="n">TSI108_INT_RXWAIT</span><span class="p">;</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXESTAT</span><span class="p">,</span> <span class="n">estat</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxpending</span> <span class="o">||</span> <span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">TSI108_EC_RXESTAT_Q0_DESCINT</span><span class="p">))</span>
		<span class="n">num_received</span> <span class="o">=</span> <span class="n">tsi108_complete_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="cm">/* This should normally fill no more slots than the number of</span>
<span class="cm">	 * packets received in tsi108_complete_rx().  The exception</span>
<span class="cm">	 * is when we previously ran out of memory for RX SKBs.  In that</span>
<span class="cm">	 * case, it&#39;s helpful to obey the budget, not only so that the</span>
<span class="cm">	 * CPU isn&#39;t hogged, but so that memory (which may still be low)</span>
<span class="cm">	 * is not hogged by one device.</span>
<span class="cm">	 *</span>
<span class="cm">	 * A work unit is considered to be two SKBs to allow us to catch</span>
<span class="cm">	 * up when the ring has shrunk due to out-of-memory but we&#39;re</span>
<span class="cm">	 * still removing the full budget&#39;s worth of packets each time.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span> <span class="o">&lt;</span> <span class="n">TSI108_RXRING_LEN</span><span class="p">)</span>
		<span class="n">num_filled</span> <span class="o">=</span> <span class="n">tsi108_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">budget</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">TSI108_INT_RXERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">err</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXERR</span><span class="p">);</span>
		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXERR</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">TSI108_EC_RXSTAT_QUEUE0</span><span class="p">))</span>
				<span class="n">tsi108_restart_rx</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">TSI108_INT_RXOVERRUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_received</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">,</span>
				     <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">)</span>
				     <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TSI108_INT_RXQUEUE0</span>
					 <span class="o">|</span> <span class="n">TSI108_INT_RXTHRESH</span> <span class="o">|</span>
					 <span class="n">TSI108_INT_RXOVERRUN</span> <span class="o">|</span>
					 <span class="n">TSI108_INT_RXERROR</span> <span class="o">|</span>
					 <span class="n">TSI108_INT_RXWAIT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_received</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_rx_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* A race could cause dev to already be scheduled, so it&#39;s not an</span>
<span class="cm">	 * error if that happens (and interrupts shouldn&#39;t be re-masked,</span>
<span class="cm">	 * because that can cause harmful races, if poll has already</span>
<span class="cm">	 * unmasked them but not cleared LINK_STATE_SCHED).</span>
<span class="cm">	 *</span>
<span class="cm">	 * This can happen if this code races with tsi108_poll(), which masks</span>
<span class="cm">	 * the interrupts after tsi108_irq_one() read the mask, but before</span>
<span class="cm">	 * napi_schedule is called.  It could also happen due to calls</span>
<span class="cm">	 * from tsi108_check_rxring().</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Mask, rather than ack, the receive interrupts.  The ack</span>
<span class="cm">		 * will happen in tsi108_poll().</span>
<span class="cm">		 */</span>

		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">,</span>
				     <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">TSI108_INT_RXQUEUE0</span>
				     <span class="o">|</span> <span class="n">TSI108_INT_RXTHRESH</span> <span class="o">|</span>
				     <span class="n">TSI108_INT_RXOVERRUN</span> <span class="o">|</span> <span class="n">TSI108_INT_RXERROR</span> <span class="o">|</span>
				     <span class="n">TSI108_INT_RXWAIT</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This can happen if an interrupt occurs while the</span>
<span class="cm">			 * interface is being brought down, as the START</span>
<span class="cm">			 * bit is cleared before the stop function is called.</span>
<span class="cm">			 *</span>
<span class="cm">			 * In this case, the interrupts must be masked, or</span>
<span class="cm">			 * they will continue indefinitely.</span>
<span class="cm">			 *</span>
<span class="cm">			 * There&#39;s a race here if the interface is brought down</span>
<span class="cm">			 * and then up in rapid succession, as the device could</span>
<span class="cm">			 * be made running after the above check and before</span>
<span class="cm">			 * the masking below.  This will only happen if the IRQ</span>
<span class="cm">			 * thread has a lower priority than the task brining</span>
<span class="cm">			 * up the interface.  Fixing this race would likely</span>
<span class="cm">			 * require changes in generic code.</span>
<span class="cm">			 */</span>

			<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">,</span>
					     <span class="n">TSI_READ</span>
					     <span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">)</span> <span class="o">|</span>
					     <span class="n">TSI108_INT_RXQUEUE0</span> <span class="o">|</span>
					     <span class="n">TSI108_INT_RXTHRESH</span> <span class="o">|</span>
					     <span class="n">TSI108_INT_RXOVERRUN</span> <span class="o">|</span>
					     <span class="n">TSI108_INT_RXERROR</span> <span class="o">|</span>
					     <span class="n">TSI108_INT_RXWAIT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* If the RX ring has run out of memory, try periodically</span>
<span class="cm"> * to allocate some more, as otherwise poll would never</span>
<span class="cm"> * get called (apart from the initial end-of-queue condition).</span>
<span class="cm"> *</span>
<span class="cm"> * This is called once per second (by default) from the thread.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_check_rxring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* A poll is scheduled, as opposed to caling tsi108_refill_rx</span>
<span class="cm">	 * directly, so as to keep the receive path single-threaded</span>
<span class="cm">	 * (and thus not needing a lock).</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span> <span class="o">&lt;</span> <span class="n">TSI108_RXRING_LEN</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">tsi108_rx_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_tx_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">estat</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXESTAT</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXESTAT</span><span class="p">,</span> <span class="n">estat</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">,</span> <span class="n">TSI108_INT_TXQUEUE0</span> <span class="o">|</span>
			     <span class="n">TSI108_INT_TXIDLE</span> <span class="o">|</span> <span class="n">TSI108_INT_TXERROR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">TSI108_EC_TXESTAT_Q0_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">err</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXERR</span><span class="p">);</span>
		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXERR</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: TX error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI108_EC_TXESTAT_Q0_DESCINT</span> <span class="o">|</span> <span class="n">TSI108_EC_TXESTAT_Q0_EOQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
		<span class="n">tsi108_complete_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi108_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI108_INT_ANY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* Not our interrupt */</span>

	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI108_INT_TXQUEUE0</span> <span class="o">|</span> <span class="n">TSI108_INT_TXIDLE</span> <span class="o">|</span>
		    <span class="n">TSI108_INT_TXERROR</span><span class="p">))</span>
		<span class="n">tsi108_tx_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI108_INT_RXQUEUE0</span> <span class="o">|</span> <span class="n">TSI108_INT_RXTHRESH</span> <span class="o">|</span>
		    <span class="n">TSI108_INT_RXWAIT</span> <span class="o">|</span> <span class="n">TSI108_INT_RXOVERRUN</span> <span class="o">|</span>
		    <span class="n">TSI108_INT_RXERROR</span><span class="p">))</span>
		<span class="n">tsi108_rx_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI108_INT_SFN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: SFN error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">,</span> <span class="n">TSI108_INT_SFN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI108_INT_STATCARRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsi108_stat_carry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">,</span> <span class="n">TSI108_INT_STATCARRY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_stop_ethernet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="cm">/* Disable all TX and RX queues ... */</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ...and wait for them to become idle */</span>
	<span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSI108_EC_TXSTAT_ACTIVE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSI108_EC_RXSTAT_ACTIVE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s function time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_reset_ether</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG1</span><span class="p">,</span> <span class="n">TSI108_MAC_CFG1_SOFTRST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_PORTCTRL</span><span class="p">,</span> <span class="n">TSI108_EC_PORTCTRL_STATRST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_PORTCTRL</span><span class="p">,</span>
			     <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_PORTCTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="n">TSI108_EC_PORTCTRL_STATRST</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXCFG</span><span class="p">,</span> <span class="n">TSI108_EC_TXCFG_RST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXCFG</span><span class="p">,</span>
			     <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_TXCFG</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="n">TSI108_EC_TXCFG_RST</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG</span><span class="p">,</span> <span class="n">TSI108_EC_RXCFG_RST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG</span><span class="p">,</span>
			     <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="n">TSI108_EC_RXCFG_RST</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_MII_MGMT_CFG</span><span class="p">,</span>
			     <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_MAC_MII_MGMT_CFG</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">TSI108_MAC_MII_MGMT_RST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_MII_MGMT_CFG</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_MAC_MII_MGMT_CFG</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">TSI108_MAC_MII_MGMT_RST</span> <span class="o">|</span>
			       <span class="n">TSI108_MAC_MII_MGMT_CLK</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x07</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_get_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">word1</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_MAC_ADDR1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">word2</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_MAC_ADDR2</span><span class="p">);</span>

	<span class="cm">/* Note that the octets are reversed from what the manual says,</span>
<span class="cm">	 * producing an even weirder ordering...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">word2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">word1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd2</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

		<span class="n">word2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="n">word1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_ADDR1</span><span class="p">,</span> <span class="n">word1</span><span class="p">);</span>
		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_ADDR2</span><span class="p">,</span> <span class="n">word2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word2</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word1</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word1</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Invalid MAC address. word1: %08x, word2: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">word1</span><span class="p">,</span> <span class="n">word2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">word1</span><span class="p">,</span> <span class="n">word2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* +2 is for the offset of the HW addr type */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">)[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">word2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">word1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_ADDR1</span><span class="p">,</span> <span class="n">word1</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_ADDR2</span><span class="p">,</span> <span class="n">word2</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Protected by dev-&gt;xmit_lock. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rxcfg</span> <span class="o">=</span> <span class="n">TSI_READ</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG_UC_HASH</span> <span class="o">|</span> <span class="n">TSI108_EC_RXCFG_MC_HASH</span><span class="p">);</span>
		<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">TSI108_EC_RXCFG_UFE</span> <span class="o">|</span> <span class="n">TSI108_EC_RXCFG_MFE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rxcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG_UFE</span> <span class="o">|</span> <span class="n">TSI108_EC_RXCFG_MFE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">TSI108_EC_RXCFG_MFE</span> <span class="o">|</span> <span class="n">TSI108_EC_RXCFG_MC_HASH</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mc_hash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mc_hash</span><span class="p">));</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">hash</span><span class="p">,</span> <span class="n">crc</span><span class="p">;</span>

			<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">;</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mc_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_HASHADDR</span><span class="p">,</span>
				     <span class="n">TSI108_EC_HASHADDR_AUTOINC</span> <span class="o">|</span>
				     <span class="n">TSI108_EC_HASHADDR_MCAST</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The manual says that the hardware may drop</span>
<span class="cm">			 * back-to-back writes to the data register.</span>
<span class="cm">			 */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_HASHDATA</span><span class="p">,</span>
					     <span class="n">data</span><span class="o">-&gt;</span><span class="n">mc_hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG</span><span class="p">,</span> <span class="n">rxcfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phyval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tsi108_read_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s function time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">TSI108_PHY_BCM54XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">);</span>
		<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">);</span>
		<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x8c00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">MII_BMCR</span><span class="p">,</span>
			 <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tsi108_read_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMCR_ANRESTART</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* Set G/MII mode and receive clock select in TBI control #2.  The</span>
<span class="cm">	 * second port won&#39;t work if this isn&#39;t done, even though we don&#39;t</span>
<span class="cm">	 * use TBI mode.</span>
<span class="cm">	 */</span>

	<span class="n">tsi108_write_tbi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="cm">/* FIXME: It seems to take more than 2 back-to-back reads to the</span>
<span class="cm">	 * PHY_STAT register before the link up status bit is set.</span>
<span class="cm">	 */</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">phyval</span> <span class="o">=</span> <span class="n">tsi108_read_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">))</span> <span class="o">&amp;</span>
		 <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MII_READ_DELAY</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">supports_gmii</span> <span class="o">=</span> <span class="n">mii_check_gmii_support</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PHY_STAT reg contains %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phyval</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">init_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_kill_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tsi108_write_mii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_PDOWN</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxring_size</span> <span class="o">=</span> <span class="n">TSI108_RXRING_LEN</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txring_size</span> <span class="o">=</span> <span class="n">TSI108_TXRING_LEN</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_desc</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">,</span> <span class="n">tsi108_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tsi108_eth%d: Could not allocate IRQ%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;tsi108_open : Port %d Assigned IRQ %d to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">rxring_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;TSI108_ETH: failed to allocate memory for rxring!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxring_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">txring_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;TSI108_ETH: failed to allocate memory for txring!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rxring_size</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txring_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI108_RXRING_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next0</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxdma</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blen</span> <span class="o">=</span> <span class="n">TSI108_RXBUF_SIZE</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">TSI108_RXRING_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next0</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI108_RXRING_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TSI108_RXBUF_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Bah.  No memory for now, but maybe we&#39;ll get</span>
<span class="cm">			 * some more later.</span>
<span class="cm">			 * For now, we&#39;ll live with the smaller ring.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: Could only allocate %d receive skb(s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxhead</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf0</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="n">TSI108_RX_OWN</span> <span class="o">|</span> <span class="n">TSI108_RX_INT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXQ_PTRLOW</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI108_TXRING_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next0</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txdma</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_desc</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">TSI108_TXRING_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next0</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span> <span class="o">=</span> <span class="n">TSI108_TXRING_LEN</span><span class="p">;</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXQ_PTRLOW</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">);</span>
	<span class="n">tsi108_init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">tsi108_timed_checker</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tsi108_restart_rx</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTSTAT</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">,</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">TSI108_INT_TXQUEUE0</span> <span class="o">|</span> <span class="n">TSI108_INT_RXERROR</span> <span class="o">|</span>
			       <span class="n">TSI108_INT_RXTHRESH</span> <span class="o">|</span> <span class="n">TSI108_INT_RXQUEUE0</span> <span class="o">|</span>
			       <span class="n">TSI108_INT_RXOVERRUN</span> <span class="o">|</span> <span class="n">TSI108_INT_RXWAIT</span> <span class="o">|</span>
			       <span class="n">TSI108_INT_SFN</span> <span class="o">|</span> <span class="n">TSI108_INT_STATCARRY</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG1</span><span class="p">,</span>
			     <span class="n">TSI108_MAC_CFG1_RXEN</span> <span class="o">|</span> <span class="n">TSI108_MAC_CFG1_TXEN</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">tsi108_stop_ethernet</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tsi108_kill_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Check for any pending TX packets, and drop them. */</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txhead</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txskbs</span><span class="p">[</span><span class="n">tx</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TSI108_TXRING_LEN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">txfree</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Discard the RX ring. */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxskbs</span><span class="p">[</span><span class="n">rx</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rxtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TSI108_RXRING_LEN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rxfree</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			    <span class="n">TSI108_RXRING_LEN</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">),</span>
			    <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			    <span class="n">TSI108_TXRING_LEN</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_desc</span><span class="p">),</span>
			    <span class="n">data</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG2</span><span class="p">,</span> <span class="n">TSI108_MAC_CFG2_DFLT_PREAMBLE</span> <span class="o">|</span>
			     <span class="n">TSI108_MAC_CFG2_PADCRC</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXTHRESH</span><span class="p">,</span>
			     <span class="p">(</span><span class="mi">192</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_EC_TXTHRESH_STARTFILL</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">192</span> <span class="o">&lt;&lt;</span> <span class="n">TSI108_EC_TXTHRESH_STOPFILL</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_STAT_CARRYMASK1</span><span class="p">,</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">TSI108_STAT_CARRY1_RXBYTES</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXPKTS</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXFCS</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXMCAST</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXALIGN</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXLENGTH</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXRUNT</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXJUMBO</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXFRAG</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXJABBER</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY1_RXDROP</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_STAT_CARRYMASK2</span><span class="p">,</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">TSI108_STAT_CARRY2_TXBYTES</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY2_TXPKTS</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY2_TXEXDEF</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY2_TXEXCOL</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY2_TXTCOL</span> <span class="o">|</span>
			       <span class="n">TSI108_STAT_CARRY2_TXPAUSE</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_PORTCTRL</span><span class="p">,</span> <span class="n">TSI108_EC_PORTCTRL_STATEN</span><span class="p">);</span>
	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_MAC_CFG1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXCFG</span><span class="p">,</span>
			     <span class="n">TSI108_EC_RXCFG_SE</span> <span class="o">|</span> <span class="n">TSI108_EC_RXCFG_BFE</span><span class="p">);</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXQ_CFG</span><span class="p">,</span> <span class="n">TSI108_EC_TXQ_CFG_DESC_INT</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_TXQ_CFG_EOQ_OWN_INT</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_TXQ_CFG_WSWP</span> <span class="o">|</span> <span class="p">(</span><span class="n">TSI108_PBM_PORT</span> <span class="o">&lt;&lt;</span>
						<span class="n">TSI108_EC_TXQ_CFG_SFNPORT</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXQ_CFG</span><span class="p">,</span> <span class="n">TSI108_EC_RXQ_CFG_DESC_INT</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_RXQ_CFG_EOQ_OWN_INT</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_RXQ_CFG_WSWP</span> <span class="o">|</span> <span class="p">(</span><span class="n">TSI108_PBM_PORT</span> <span class="o">&lt;&lt;</span>
						<span class="n">TSI108_EC_RXQ_CFG_SFNPORT</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_TXQ_BUFCFG</span><span class="p">,</span>
			     <span class="n">TSI108_EC_TXQ_BUFCFG_BURST256</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_TXQ_BUFCFG_BSWP</span> <span class="o">|</span> <span class="p">(</span><span class="n">TSI108_PBM_PORT</span> <span class="o">&lt;&lt;</span>
						<span class="n">TSI108_EC_TXQ_BUFCFG_SFNPORT</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_RXQ_BUFCFG</span><span class="p">,</span>
			     <span class="n">TSI108_EC_RXQ_BUFCFG_BURST256</span> <span class="o">|</span>
			     <span class="n">TSI108_EC_RXQ_BUFCFG_BSWP</span> <span class="o">|</span> <span class="p">(</span><span class="n">TSI108_PBM_PORT</span> <span class="o">&lt;&lt;</span>
						<span class="n">TSI108_EC_RXQ_BUFCFG_SFNPORT</span><span class="p">));</span>

	<span class="n">TSI_WRITE</span><span class="p">(</span><span class="n">TSI108_EC_INTMASK</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">tsi108_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_link</span> 	<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">tsi108_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">tsi108_set_settings</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">tsi108_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">tsi108_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">tsi108_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">tsi108_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">tsi108_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">tsi108_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">tsi108_do_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">tsi108_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tsi108_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hw_info</span> <span class="o">*</span><span class="n">einfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">einfo</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">einfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tsi-eth %d: Missing additional data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create an ethernet device instance */</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi108_prv_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tsi108_eth%d: probe...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tsi108_eth%d:regs:phyresgs:phy:irq_num=0x%x:0x%x:0x%x:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">phyregs</span><span class="p">,</span>
			<span class="n">einfo</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">einfo</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">regs_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">phyregs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">einfo</span><span class="o">-&gt;</span><span class="n">phyregs</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phyregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">phyregs_fail</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/* MII setup */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">tsi108_mdio_read</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">tsi108_mdio_write</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_num</span> <span class="o">=</span> <span class="n">einfo</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">tsi108_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tsi108_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tsi108_ethtool_ops</span><span class="p">;</span>

	<span class="cm">/* Apparently, the Linux networking code won&#39;t use scatter-gather</span>
<span class="cm">	 * if the hardware doesn&#39;t do checksums.  However, it&#39;s faster</span>
<span class="cm">	 * to checksum in place and use SG, as (among other reasons)</span>
<span class="cm">	 * the cache won&#39;t be dirtied (which then has to be flushed</span>
<span class="cm">	 * before DMA).  The checksumming is done by the driver (via</span>
<span class="cm">	 * a new function skb_csum_dev() in net/core/skbuff.c).</span>
<span class="cm">	 */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">txlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">misclock</span><span class="p">);</span>

	<span class="n">tsi108_reset_ether</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">tsi108_kill_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">tsi108_get_mac</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid MAC address.  Please correct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">register_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tsi108_init_mac</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Cannot register net device, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">register_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Tsi108 Gigabit Ethernet, MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">DEBUG</span><span class="p">;</span>
	<span class="n">dump_eth_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">register_fail:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phyregs</span><span class="p">);</span>

<span class="nl">phyregs_fail:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

<span class="nl">regs_fail:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* There&#39;s no way to either get interrupts from the PHY when</span>
<span class="cm"> * something changes, or to have the Tsi108 automatically communicate</span>
<span class="cm"> * with the PHY to reconfigure itself.</span>
<span class="cm"> *</span>
<span class="cm"> * Thus, we have to do it using a timer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi108_timed_checker</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tsi108_check_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tsi108_check_rxring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">CHECK_PHY_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi108_ether_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tsi108_prv_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tsi108_stop_ethernet</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phyregs</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">tsi_eth_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Tundra Semiconductor Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Tsi108 Gigabit Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:tsi-ethernet&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
