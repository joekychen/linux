<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › freescale › ucc_geth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ucc_geth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2006-2009 Freescale Semicondutor, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Shlomi Gridish &lt;gridish@freescale.com&gt;</span>
<span class="cm"> *	   Li Yang &lt;leoli@freescale.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * QE UCC Gigabit Ethernet Driver</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/of_mdio.h&gt;</span>
<span class="cp">#include &lt;linux/of_net.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/immap_qe.h&gt;</span>
<span class="cp">#include &lt;asm/qe.h&gt;</span>
<span class="cp">#include &lt;asm/ucc.h&gt;</span>
<span class="cp">#include &lt;asm/ucc_fast.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>

<span class="cp">#include &quot;ucc_geth.h&quot;</span>
<span class="cp">#include &quot;fsl_pq_mdio.h&quot;</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#define ugeth_printk(level, format, arg...)  \</span>
<span class="cp">        printk(level format &quot;\n&quot;, ## arg)</span>

<span class="cp">#define ugeth_dbg(format, arg...)            \</span>
<span class="cp">        ugeth_printk(KERN_DEBUG , format , ## arg)</span>
<span class="cp">#define ugeth_err(format, arg...)            \</span>
<span class="cp">        ugeth_printk(KERN_ERR , format , ## arg)</span>
<span class="cp">#define ugeth_info(format, arg...)           \</span>
<span class="cp">        ugeth_printk(KERN_INFO , format , ## arg)</span>
<span class="cp">#define ugeth_warn(format, arg...)           \</span>
<span class="cp">        ugeth_printk(KERN_WARNING , format , ## arg)</span>

<span class="cp">#ifdef UGETH_VERBOSE_DEBUG</span>
<span class="cp">#define ugeth_vdbg ugeth_dbg</span>
<span class="cp">#else</span>
<span class="cp">#define ugeth_vdbg(fmt, args...) do { } while (0)</span>
<span class="cp">#endif				</span><span class="cm">/* UGETH_VERBOSE_DEBUG */</span><span class="cp"></span>
<span class="cp">#define UGETH_MSG_DEFAULT	(NETIF_MSG_IFUP &lt;&lt; 1 ) - 1</span>


<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ugeth_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span> <span class="n">debug</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug verbosity level (0=none, ..., 0xffff=all)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="n">ugeth_primary_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uf_info</span> <span class="o">=</span> <span class="p">{</span>
		    <span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">=</span> <span class="n">MEM_PART_SYSTEM</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">rtsm</span> <span class="o">=</span> <span class="n">UCC_FAST_SEND_IDLES_BETWEEN_FRAMES</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">max_rx_buf_length</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">,</span>
		    <span class="cm">/* adjusted at startup if max-speed 1000 */</span>
		    <span class="p">.</span><span class="n">urfs</span> <span class="o">=</span> <span class="n">UCC_GETH_URFS_INIT</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">urfet</span> <span class="o">=</span> <span class="n">UCC_GETH_URFET_INIT</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">urfset</span> <span class="o">=</span> <span class="n">UCC_GETH_URFSET_INIT</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">utfs</span> <span class="o">=</span> <span class="n">UCC_GETH_UTFS_INIT</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">utfet</span> <span class="o">=</span> <span class="n">UCC_GETH_UTFET_INIT</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">utftt</span> <span class="o">=</span> <span class="n">UCC_GETH_UTFTT_INIT</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ufpt</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">UCC_FAST_PROTOCOL_MODE_ETHERNET</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">ttx_trx</span> <span class="o">=</span> <span class="n">UCC_FAST_GUMR_TRANSPARENT_TTX_TRX_NORMAL</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">tenc</span> <span class="o">=</span> <span class="n">UCC_FAST_TX_ENCODING_NRZ</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">renc</span> <span class="o">=</span> <span class="n">UCC_FAST_RX_ENCODING_NRZ</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">tcrc</span> <span class="o">=</span> <span class="n">UCC_FAST_16_BIT_CRC</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">synl</span> <span class="o">=</span> <span class="n">UCC_FAST_SYNC_LEN_NOT_USED</span><span class="p">,</span>
		    <span class="p">},</span>
	<span class="p">.</span><span class="n">numQueuesTx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">numQueuesRx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extendedFilteringChainPointer</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="p">.</span><span class="n">typeorlen</span> <span class="o">=</span> <span class="mi">3072</span> <span class="cm">/*1536 */</span> <span class="p">,</span>
	<span class="p">.</span><span class="n">nonBackToBackIfgPart1</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nonBackToBackIfgPart2</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">miminumInterFrameGapEnforcement</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="p">.</span><span class="n">backToBackInterFrameGap</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mblinterval</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nortsrbytetime</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fracsiz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">strictpriorityq</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">altBebTruncation</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">excessDefer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxRetransmission</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">collisionWindow</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receiveFlowControl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">transmitFlowControl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxGroupAddrInHash</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxIndAddrInHash</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prel</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxFrameLength</span> <span class="o">=</span> <span class="mi">1518</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="cm">/* Add extra bytes for VLANs etc. */</span>
	<span class="p">.</span><span class="n">minFrameLength</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxD1Length</span> <span class="o">=</span> <span class="mi">1520</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="cm">/* Add extra bytes for VLANs etc. */</span>
	<span class="p">.</span><span class="n">maxD2Length</span> <span class="o">=</span> <span class="mi">1520</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="cm">/* Add extra bytes for VLANs etc. */</span>
	<span class="p">.</span><span class="n">vlantype</span> <span class="o">=</span> <span class="mh">0x8100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ecamptr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="p">.</span><span class="n">eventRegMask</span> <span class="o">=</span> <span class="n">UCCE_OTHER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pausePeriod</span> <span class="o">=</span> <span class="mh">0xf000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interruptcoalescingmaxvalue</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">.</span><span class="n">bdRingLenTx</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">TX_BD_RING_LEN</span><span class="p">},</span>

	<span class="p">.</span><span class="n">bdRingLenRx</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">,</span>
			<span class="n">RX_BD_RING_LEN</span><span class="p">},</span>

	<span class="p">.</span><span class="n">numStationAddresses</span> <span class="o">=</span> <span class="n">UCC_GETH_NUM_OF_STATION_ADDRESSES_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">largestexternallookupkeysize</span> <span class="o">=</span>
	    <span class="n">QE_FLTR_LARGEST_EXTERNAL_TABLE_LOOKUP_KEY_SIZE_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statisticsMode</span> <span class="o">=</span> <span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_HARDWARE</span> <span class="o">|</span>
		<span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_FIRMWARE_TX</span> <span class="o">|</span>
		<span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_FIRMWARE_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vlanOperationTagged</span> <span class="o">=</span> <span class="n">UCC_GETH_VLAN_OPERATION_TAGGED_NOP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vlanOperationNonTagged</span> <span class="o">=</span> <span class="n">UCC_GETH_VLAN_OPERATION_NON_TAGGED_NOP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxQoSMode</span> <span class="o">=</span> <span class="n">UCC_GETH_QOS_MODE_DEFAULT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aufc</span> <span class="o">=</span> <span class="n">UPSMR_AUTOMATIC_FLOW_CONTROL_MODE_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">padAndCrc</span> <span class="o">=</span> <span class="n">MACCFG2_PAD_AND_CRC_MODE_PAD_AND_CRC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">numThreadsTx</span> <span class="o">=</span> <span class="n">UCC_GETH_NUM_OF_THREADS_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">numThreadsRx</span> <span class="o">=</span> <span class="n">UCC_GETH_NUM_OF_THREADS_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">riscTx</span> <span class="o">=</span> <span class="n">QE_RISC_ALLOCATION_RISC1_AND_RISC2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">riscRx</span> <span class="o">=</span> <span class="n">QE_RISC_ALLOCATION_RISC1_AND_RISC2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="n">ugeth_info</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mem_disp</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size16Aling</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size4Aling</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">notAlign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">notAlign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size16Aling</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x: %08x %08x %08x %08x</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span>
		       <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span><span class="p">)),</span>
		       <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
		       <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)),</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notAlign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size4Aling</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%08x &quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notAlign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="nf">dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">lh</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">lh</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">get_new_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				      <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">max_rx_buf_length</span> <span class="o">+</span>
				      <span class="n">UCC_GETH_RX_DATA_BUF_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* We need the data buffer to be aligned properly.  We will reserve</span>
<span class="cm">	 * as many bytes as needed to align the data properly</span>
<span class="cm">	 */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
		    <span class="n">UCC_GETH_RX_DATA_BUF_ALIGNMENT</span> <span class="o">-</span>
		    <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UCC_GETH_RX_DATA_BUF_ALIGNMENT</span> <span class="o">-</span>
					      <span class="mi">1</span><span class="p">)));</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		      <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				     <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">max_rx_buf_length</span> <span class="o">+</span>
				     <span class="n">UCC_GETH_RX_DATA_BUF_ALIGNMENT</span><span class="p">,</span>
				     <span class="n">DMA_FROM_DEVICE</span><span class="p">));</span>

	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span>
			<span class="p">(</span><span class="n">R_E</span> <span class="o">|</span> <span class="n">R_I</span> <span class="o">|</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span><span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_bd_buffer_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxQ</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bd_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">rxQ</span><span class="p">];</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bd_status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">get_new_skb</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>	<span class="cm">/* If can not allocate data buffer,</span>
<span class="cm">				abort. Cleanup will be elsewhere */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">rxQ</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* advance the BD pointer */</span>
		<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_init_enet_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="o">*</span><span class="n">p_start</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">num_entries</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">thread_size</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">thread_alignment</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">risc</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">skip_page_for_first_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">init_enet_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">snum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snum</span> <span class="o">=</span> <span class="n">qe_get_snum</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;fill_init_enet_entries: Can not get SNUM.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">snum</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">skip_page_for_first_entry</span><span class="p">)</span>
		<span class="cm">/* First entry of Rx does not have page */</span>
			<span class="n">init_enet_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">init_enet_offset</span> <span class="o">=</span>
			    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">thread_size</span><span class="p">,</span> <span class="n">thread_alignment</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">init_enet_offset</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
					<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;fill_init_enet_entries: Can not allocate DPRAM memory.&quot;</span><span class="p">);</span>
				<span class="n">qe_put_snum</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">snum</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p_start</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">snum</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_INIT_PARAM_SNUM_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">init_enet_offset</span>
		    <span class="o">|</span> <span class="n">risc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">return_init_enet_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="o">*</span><span class="n">p_start</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">num_entries</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">risc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">skip_page_for_first_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">init_enet_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">snum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_start</span><span class="p">;</span>

		<span class="cm">/* Check that this entry was actually valid --</span>
<span class="cm">		needed in case failed in allocations */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_INIT_PARAM_RISC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">risc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snum</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_INIT_PARAM_SNUM_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			    <span class="n">ENET_INIT_PARAM_SNUM_SHIFT</span><span class="p">;</span>
			<span class="n">qe_put_snum</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">snum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">skip_page_for_first_entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* First entry of Rx does not have page */</span>
				<span class="n">init_enet_offset</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_INIT_PARAM_PTR_MASK</span><span class="p">);</span>
				<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">init_enet_offset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p_start</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_init_enet_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_start</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">num_entries</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">thread_size</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">risc</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">skip_page_for_first_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">init_enet_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">snum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">p_start</span><span class="p">);</span>

		<span class="cm">/* Check that this entry was actually valid --</span>
<span class="cm">		needed in case failed in allocations */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_INIT_PARAM_RISC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">risc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snum</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_INIT_PARAM_SNUM_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			    <span class="n">ENET_INIT_PARAM_SNUM_SHIFT</span><span class="p">;</span>
			<span class="n">qe_put_snum</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">snum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">skip_page_for_first_entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* First entry of Rx does not have page */</span>
				<span class="n">init_enet_offset</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">p_start</span><span class="p">)</span> <span class="o">&amp;</span>
				     <span class="n">ENET_INIT_PARAM_PTR_MASK</span><span class="p">);</span>
				<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Init enet entry %d:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
					   <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">init_enet_offset</span><span class="p">));</span>
				<span class="n">mem_disp</span><span class="p">(</span><span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">init_enet_offset</span><span class="p">),</span>
					 <span class="n">thread_size</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">p_start</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_enet_addr_container</span><span class="p">(</span><span class="k">struct</span> <span class="n">enet_addr_container</span> <span class="o">*</span><span class="n">enet_addr_cont</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">enet_addr_cont</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_mac_addr</span><span class="p">(</span><span class="n">__be16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_clear_addr_in_paddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">u8</span> <span class="n">paddr_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_82xx_addr_filt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">paddr_num</span> <span class="o">&lt;</span> <span class="n">NUM_OF_PADDRS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ugeth_warn</span><span class="p">(</span><span class="s">&quot;%s: Illagel paddr_num.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p_82xx_addr_filt</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span>
	    <span class="n">addressfiltering</span><span class="p">;</span>

	<span class="cm">/* Writing address ff.ff.ff.ff.ff.ff disables address</span>
<span class="cm">	recognition for this register */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">paddr_num</span><span class="p">].</span><span class="n">h</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">paddr_num</span><span class="p">].</span><span class="n">m</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">paddr_num</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_add_addr_in_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
                                <span class="n">u8</span> <span class="o">*</span><span class="n">p_enet_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_82xx_addr_filt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cecr_subblock</span><span class="p">;</span>

	<span class="n">p_82xx_addr_filt</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span>
	    <span class="n">addressfiltering</span><span class="p">;</span>

	<span class="n">cecr_subblock</span> <span class="o">=</span>
	    <span class="n">ucc_fast_get_qe_cr_subblock</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span><span class="p">);</span>

	<span class="cm">/* Ethernet frames are defined in Little Endian mode,</span>
<span class="cm">	therefore to insert */</span>
	<span class="cm">/* the address to the hash (Big Endian mode), we reverse the bytes.*/</span>

	<span class="n">set_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">taddr</span><span class="p">.</span><span class="n">h</span><span class="p">,</span> <span class="n">p_enet_addr</span><span class="p">);</span>

	<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_SET_GROUP_ADDRESS</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span>
		     <span class="n">QE_CR_PROTOCOL_ETHERNET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">compare_addr</span><span class="p">(</span><span class="n">u8</span> <span class="o">**</span><span class="n">addr1</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">addr2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ucc_geth_tx_firmware_statistics</span> <span class="o">*</span>
			   <span class="n">tx_firmware_statistics</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ucc_geth_rx_firmware_statistics</span> <span class="o">*</span>
			   <span class="n">rx_firmware_statistics</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ucc_geth_hardware_statistics</span> <span class="o">*</span><span class="n">hardware_statistics</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uf_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_tx_firmware_statistics_pram</span> <span class="o">*</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_rx_firmware_statistics_pram</span> <span class="o">*</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">;</span>

	<span class="n">ug_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="n">uf_regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_fast</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ug_regs</span><span class="p">;</span>
	<span class="n">p_tx_fw_statistics_pram</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">;</span>
	<span class="n">p_rx_fw_statistics_pram</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">;</span>

	<span class="cm">/* Tx firmware only if user handed pointer and driver actually</span>
<span class="cm">	gathers Tx firmware statistics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_firmware_statistics</span> <span class="o">&amp;&amp;</span> <span class="n">p_tx_fw_statistics_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">sicoltx</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">sicoltx</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">mulcoltx</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">mulcoltx</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">latecoltxfr</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">latecoltxfr</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">frabortduecol</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">frabortduecol</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">frlostinmactxer</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">frlostinmactxer</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">carriersenseertx</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">carriersenseertx</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">frtxok</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">frtxok</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">txfrexcessivedefer</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">txfrexcessivedefer</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">txpkts256</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">txpkts256</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">txpkts512</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">txpkts512</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">txpkts1024</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">txpkts1024</span><span class="p">);</span>
		<span class="n">tx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">txpktsjumbo</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_tx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">txpktsjumbo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Rx firmware only if user handed pointer and driver actually</span>
<span class="cm">	 * gathers Rx firmware statistics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_firmware_statistics</span> <span class="o">&amp;&amp;</span> <span class="n">p_rx_fw_statistics_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">frrxfcser</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">frrxfcser</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">fraligner</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">fraligner</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">inrangelenrxer</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">inrangelenrxer</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">outrangelenrxer</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">outrangelenrxer</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">frtoolong</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">frtoolong</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">runt</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">runt</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">verylongevent</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">verylongevent</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">symbolerror</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">symbolerror</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">dropbsy</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">dropbsy</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">mismatchdrop</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">mismatchdrop</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">underpkts</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">underpkts</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">pkts256</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">pkts256</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">pkts512</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">pkts512</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">pkts1024</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">pkts1024</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">pktsjumbo</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">pktsjumbo</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">frlossinmacer</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">frlossinmacer</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">pausefr</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">pausefr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">res1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">res1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">removevlan</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">removevlan</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">replacevlan</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">replacevlan</span><span class="p">);</span>
		<span class="n">rx_firmware_statistics</span><span class="o">-&gt;</span><span class="n">insertvlan</span> <span class="o">=</span>
		    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_rx_fw_statistics_pram</span><span class="o">-&gt;</span><span class="n">insertvlan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware only if user handed pointer and driver actually</span>
<span class="cm">	gathers hardware statistics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hardware_statistics</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UCC_GETH_UPSMR_HSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">tx64</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx64</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">tx127</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx127</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">tx255</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx255</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rx64</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx64</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rx127</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx127</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rx255</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx255</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">txok</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">txok</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">txcf</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">txcf</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">tmca</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tmca</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">tbca</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tbca</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rxfok</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rxfok</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rxbok</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rxbok</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rbyt</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rbyt</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rmca</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rmca</span><span class="p">);</span>
		<span class="n">hardware_statistics</span><span class="o">-&gt;</span><span class="n">rbca</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rbca</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_bds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">));</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;TX BDs[%d]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">mem_disp</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">));</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX BDs[%d]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">mem_disp</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;UCC%d Geth registers:&quot;</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">);</span>

	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;maccfg1    : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg1</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg1</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;maccfg2    : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;ipgifg     : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ipgifg</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ipgifg</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;hafdup     : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">hafdup</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">hafdup</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;ifctl      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ifctl</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ifctl</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;ifstat     : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ifstat</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ifstat</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;macstnaddr1: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr1</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr1</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;macstnaddr2: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr2</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr2</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;uempr      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uempr</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uempr</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;utbipar    : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">utbipar</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">utbipar</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;uescr      : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uescr</span><span class="p">,</span>
		   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uescr</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tx64       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx64</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx64</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tx127      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx127</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx127</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tx255      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx255</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tx255</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rx64       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx64</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx64</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rx127      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx127</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx127</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rx255      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx255</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rx255</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;txok       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">txok</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">txok</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;txcf       : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">txcf</span><span class="p">,</span>
		   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">txcf</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tmca       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tmca</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tmca</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tbca       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tbca</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">tbca</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rxfok      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rxfok</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rxfok</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rxbok      : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rxbok</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rxbok</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rbyt       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rbyt</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rbyt</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rmca       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rmca</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rmca</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rbca       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rbca</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">rbca</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;scar       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">scar</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">scar</span><span class="p">));</span>
	<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;scam       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">scam</span><span class="p">,</span>
		   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">scam</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">numThreadsTxNumerical</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsTx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_1</span>:
			<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_2</span>:
			<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_4</span>:
			<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_6</span>:
			<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_8</span>:
			<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Thread data TXs:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreadsTxNumerical</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Thread data TX[%d]:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_data_tx</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">numThreadsRxNumerical</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsRx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_1</span>:
			<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_2</span>:
			<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_4</span>:
			<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_6</span>:
			<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_8</span>:
			<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Thread data RX:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreadsRxNumerical</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Thread data RX[%d]:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_data_rx</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;EXF global param:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span><span class="p">);</span>
		<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;TX global param:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;temoder      : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">temoder</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">temoder</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;sqptr        : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">sqptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">sqptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;schedulerbasepointer: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">schedulerbasepointer</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span>
				   <span class="n">schedulerbasepointer</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;txrmonbaseptr: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">txrmonbaseptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">txrmonbaseptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tstate       : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[0] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[1] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[2] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[3] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[4] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[5] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[6] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;iphoffset[7] : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[0] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[1] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[2] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[3] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[4] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[5] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[6] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vtagtable[7] : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;tqptr        : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">tqptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">tqptr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX global param:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;remoder         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">remoder</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">remoder</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rqptr           : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rqptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rqptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;typeorlen       : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">typeorlen</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">typeorlen</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rxgstpack       : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxgstpack</span><span class="p">,</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxgstpack</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rxrmonbaseptr   : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxrmonbaseptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxrmonbaseptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;intcoalescingptr: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">intcoalescingptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">intcoalescingptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rstate          : addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rstate</span><span class="p">,</span>
			   <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rstate</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;mrblr           : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mrblr</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mrblr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;rbdqptr         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rbdqptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rbdqptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;mflr            : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mflr</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mflr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;minflr          : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">minflr</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">minflr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;maxd1           : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">maxd1</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">maxd1</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;maxd2           : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">maxd2</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">maxd2</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;ecamptr         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">ecamptr</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">ecamptr</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l2qt            : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l2qt</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l2qt</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[0]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[1]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[2]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[3]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[4]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[5]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[6]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;l3qt[7]         : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vlantype        : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vlantype</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vlantype</span><span class="p">));</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;vlantci         : addr - 0x%08x, val - 0x%04x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vlantci</span><span class="p">,</span>
			   <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vlantci</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ugeth_info</span>
		    <span class="p">(</span><span class="s">&quot;addressfiltering[%d]: addr - 0x%08x, val - 0x%02x&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">addressfiltering</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			     <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">addressfiltering</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;exfGlobalParam  : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">exfGlobalParam</span><span class="p">,</span>
			   <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">exfGlobalParam</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Send Q memory registers:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;SQQD[%d]:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="o">-&gt;</span><span class="n">sqqd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="o">-&gt;</span><span class="n">sqqd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_send_queue_qd</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Scheduler:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">);</span>
		<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;TX FW statistics pram:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">);</span>
		<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX FW statistics pram:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">);</span>
		<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX IRQ coalescing tables:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX IRQ coalescing table entry[%d]:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span>
				   <span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ugeth_info</span>
		<span class="p">(</span><span class="s">&quot;interruptcoalescingmaxvalue: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span>
			     <span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interruptcoalescingmaxvalue</span><span class="p">,</span>
			     <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span>
				     <span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
				     <span class="n">interruptcoalescingmaxvalue</span><span class="p">));</span>
			<span class="n">ugeth_info</span>
		<span class="p">(</span><span class="s">&quot;interruptcoalescingcounter : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span>
			     <span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interruptcoalescingcounter</span><span class="p">,</span>
			     <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span>
				     <span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
				     <span class="n">interruptcoalescingcounter</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX BD QS tables:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;RX BD QS table[%d]:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ugeth_info</span>
			    <span class="p">(</span><span class="s">&quot;bdbaseptr        : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdbaseptr</span><span class="p">,</span>
			     <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdbaseptr</span><span class="p">));</span>
			<span class="n">ugeth_info</span>
			    <span class="p">(</span><span class="s">&quot;bdptr            : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdptr</span><span class="p">,</span>
			     <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdptr</span><span class="p">));</span>
			<span class="n">ugeth_info</span>
			    <span class="p">(</span><span class="s">&quot;externalbdbaseptr: addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">externalbdbaseptr</span><span class="p">,</span>
			     <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
				     <span class="n">externalbdbaseptr</span><span class="p">));</span>
			<span class="n">ugeth_info</span>
			    <span class="p">(</span><span class="s">&quot;externalbdptr    : addr - 0x%08x, val - 0x%08x&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">externalbdptr</span><span class="p">,</span>
			     <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">externalbdptr</span><span class="p">));</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;ucode RX Prefetched BDs:&quot;</span><span class="p">);</span>
			<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
				   <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">in_be32</span>
						 <span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						  <span class="n">bdbaseptr</span><span class="p">)));</span>
			<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>
				 <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">in_be32</span>
					       <span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">bdbaseptr</span><span class="p">)),</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_prefetched_bds</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Init enet param shadow:&quot;</span><span class="p">);</span>
		<span class="n">ugeth_info</span><span class="p">(</span><span class="s">&quot;Base address: 0x%08x&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">);</span>
		<span class="n">mem_disp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">));</span>

		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_rx_pram</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rxExtendedFiltering</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">+=</span>
			    <span class="n">THREAD_RX_PRAM_ADDITIONAL_FOR_EXTENDED_FILTERING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">==</span>
			    <span class="n">QE_FLTR_TABLE_LOOKUP_KEY_SIZE_8_BYTES</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">+=</span>
			<span class="n">THREAD_RX_PRAM_ADDITIONAL_FOR_EXTENDED_FILTERING_8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">==</span>
			    <span class="n">QE_FLTR_TABLE_LOOKUP_KEY_SIZE_16_BYTES</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">+=</span>
			<span class="n">THREAD_RX_PRAM_ADDITIONAL_FOR_EXTENDED_FILTERING_16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dump_init_enet_entries</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span>
					 <span class="n">txthread</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				       <span class="n">ENET_INIT_PARAM_MAX_ENTRIES_TX</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_tx_pram</span><span class="p">),</span>
				       <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscTx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dump_init_enet_entries</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span>
					 <span class="n">rxthread</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				       <span class="n">ENET_INIT_PARAM_MAX_ENTRIES_RX</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				       <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscRx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_default_reg_vals</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">upsmr_register</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">maccfg1_register</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">maccfg2_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">upsmr_register</span><span class="p">,</span> <span class="n">UCC_GETH_UPSMR_INIT</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">maccfg1_register</span><span class="p">,</span> <span class="n">UCC_GETH_MACCFG1_INIT</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">maccfg2_register</span><span class="p">,</span> <span class="n">UCC_GETH_MACCFG2_INIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_half_duplex_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">alt_beb</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">back_pressure_no_backoff</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">no_backoff</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">excess_defer</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">alt_beb_truncation</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">max_retransmissions</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">collision_window</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hafdup_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">alt_beb_truncation</span> <span class="o">&gt;</span> <span class="n">HALFDUP_ALT_BEB_TRUNCATION_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">max_retransmissions</span> <span class="o">&gt;</span> <span class="n">HALFDUP_MAX_RETRANSMISSION_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">collision_window</span> <span class="o">&gt;</span> <span class="n">HALFDUP_COLLISION_WINDOW_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">alt_beb_truncation</span> <span class="o">&lt;&lt;</span> <span class="n">HALFDUP_ALT_BEB_TRUNCATION_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt_beb</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">HALFDUP_ALT_BEB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">back_pressure_no_backoff</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">HALFDUP_BACK_PRESSURE_NO_BACKOFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_backoff</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">HALFDUP_NO_BACKOFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">excess_defer</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">HALFDUP_EXCESSIVE_DEFER</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">max_retransmissions</span> <span class="o">&lt;&lt;</span> <span class="n">HALFDUP_MAX_RETRANSMISSION_SHIFT</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">|=</span> <span class="n">collision_window</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">hafdup_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_inter_frame_gap_params</span><span class="p">(</span><span class="n">u8</span> <span class="n">non_btb_cs_ipg</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">non_btb_ipg</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">min_ifg</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">btb_ipg</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ipgifg_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Non-Back-to-back IPG part 1 should be &lt;= Non-Back-to-back</span>
<span class="cm">	IPG part 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">non_btb_cs_ipg</span> <span class="o">&gt;</span> <span class="n">non_btb_ipg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">non_btb_cs_ipg</span> <span class="o">&gt;</span> <span class="n">IPGIFG_NON_BACK_TO_BACK_IFG_PART1_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">non_btb_ipg</span> <span class="o">&gt;</span> <span class="n">IPGIFG_NON_BACK_TO_BACK_IFG_PART2_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="cm">/*(min_ifg        &gt; IPGIFG_MINIMUM_IFG_ENFORCEMENT_MAX) || */</span>
	    <span class="p">(</span><span class="n">btb_ipg</span> <span class="o">&gt;</span> <span class="n">IPGIFG_BACK_TO_BACK_IFG_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">non_btb_cs_ipg</span> <span class="o">&lt;&lt;</span> <span class="n">IPGIFG_NON_BACK_TO_BACK_IFG_PART1_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">IPGIFG_NBTB_CS_IPG_MASK</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">non_btb_ipg</span> <span class="o">&lt;&lt;</span> <span class="n">IPGIFG_NON_BACK_TO_BACK_IFG_PART2_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">IPGIFG_NBTB_IPG_MASK</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">min_ifg</span> <span class="o">&lt;&lt;</span> <span class="n">IPGIFG_MINIMUM_IFG_ENFORCEMENT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">IPGIFG_MIN_IFG_MASK</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">btb_ipg</span> <span class="o">&amp;</span> <span class="n">IPGIFG_BTB_IPG_MASK</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">ipgifg_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">init_flow_control_params</span><span class="p">(</span><span class="n">u32</span> <span class="n">automatic_flow_control_mode</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rx_flow_control_enable</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">tx_flow_control_enable</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">pause_period</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">extension_field</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">upsmr_register</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uempr_register</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">maccfg1_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set UEMPR register */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pause_period</span> <span class="o">&lt;&lt;</span> <span class="n">UEMPR_PAUSE_TIME_VALUE_SHIFT</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">extension_field</span> <span class="o">&lt;&lt;</span> <span class="n">UEMPR_EXTENDED_PAUSE_TIME_VALUE_SHIFT</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">uempr_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Set UPSMR register */</span>
	<span class="n">setbits32</span><span class="p">(</span><span class="n">upsmr_register</span><span class="p">,</span> <span class="n">automatic_flow_control_mode</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">maccfg1_register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_flow_control_enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MACCFG1_FLOW_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flow_control_enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MACCFG1_FLOW_TX</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">maccfg1_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_hw_statistics_gathering_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable_hardware_statistics</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">auto_zero_hardware_statistics</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">upsmr_register</span><span class="p">,</span>
					     <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uescr_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">uescr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable hardware statistics gathering if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_hardware_statistics</span><span class="p">)</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="n">upsmr_register</span><span class="p">,</span> <span class="n">UCC_GETH_UPSMR_HSE</span><span class="p">);</span>

	<span class="cm">/* Clear hardware statistics counters */</span>
	<span class="n">uescr_value</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="n">uescr_register</span><span class="p">);</span>
	<span class="n">uescr_value</span> <span class="o">|=</span> <span class="n">UESCR_CLRCNT</span><span class="p">;</span>
	<span class="cm">/* Automatically zero hardware statistics counters on read,</span>
<span class="cm">	if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auto_zero_hardware_statistics</span><span class="p">)</span>
		<span class="n">uescr_value</span> <span class="o">|=</span> <span class="n">UESCR_AUTOZ</span><span class="p">;</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">uescr_register</span><span class="p">,</span> <span class="n">uescr_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_firmware_statistics_gathering_mode</span><span class="p">(</span><span class="kt">int</span>
		<span class="n">enable_tx_firmware_statistics</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">enable_rx_firmware_statistics</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tx_rmon_base_ptr</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">tx_firmware_statistics_structure_address</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rx_rmon_base_ptr</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">rx_firmware_statistics_structure_address</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">temoder_register</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">remoder_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Note: this function does not check if */</span>
	<span class="cm">/* the parameters it receives are NULL   */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_tx_firmware_statistics</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">tx_rmon_base_ptr</span><span class="p">,</span>
			 <span class="n">tx_firmware_statistics_structure_address</span><span class="p">);</span>
		<span class="n">setbits16</span><span class="p">(</span><span class="n">temoder_register</span><span class="p">,</span> <span class="n">TEMODER_TX_RMON_STATISTICS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_rx_firmware_statistics</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">rx_rmon_base_ptr</span><span class="p">,</span>
			 <span class="n">rx_firmware_statistics_structure_address</span><span class="p">);</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="n">remoder_register</span><span class="p">,</span> <span class="n">REMODER_RX_RMON_STATISTICS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_mac_station_addr_regs</span><span class="p">(</span><span class="n">u8</span> <span class="n">address_byte_0</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">address_byte_1</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">address_byte_2</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">address_byte_3</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">address_byte_4</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">address_byte_5</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">macstnaddr1_register</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">macstnaddr2_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Example: for a station address of 0x12345678ABCD, */</span>
	<span class="cm">/* 0x12 is byte 0, 0x34 is byte 1 and so on and 0xCD is byte 5 */</span>

	<span class="cm">/* MACSTNADDR1 Register: */</span>

	<span class="cm">/* 0                      7   8                      15  */</span>
	<span class="cm">/* station address byte 5     station address byte 4     */</span>
	<span class="cm">/* 16                     23  24                     31  */</span>
	<span class="cm">/* station address byte 3     station address byte 2     */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">address_byte_2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">address_byte_3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">address_byte_4</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">address_byte_5</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">macstnaddr1_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* MACSTNADDR2 Register: */</span>

	<span class="cm">/* 0                      7   8                      15  */</span>
	<span class="cm">/* station address byte 1     station address byte 0     */</span>
	<span class="cm">/* 16                     23  24                     31  */</span>
	<span class="cm">/*         reserved                   reserved           */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">address_byte_0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">address_byte_1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">macstnaddr2_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_check_frame_length_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">length_check</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">maccfg2_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">maccfg2_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length_check</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MACCFG2_LC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MACCFG2_LC</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">maccfg2_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_preamble_length</span><span class="p">(</span><span class="n">u8</span> <span class="n">preamble_length</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">maccfg2_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">preamble_length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">preamble_length</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">clrsetbits_be32</span><span class="p">(</span><span class="n">maccfg2_register</span><span class="p">,</span> <span class="n">MACCFG2_PREL_MASK</span><span class="p">,</span>
			<span class="n">preamble_length</span> <span class="o">&lt;&lt;</span> <span class="n">MACCFG2_PREL_SHIFT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_rx_parameters</span><span class="p">(</span><span class="kt">int</span> <span class="n">reject_broadcast</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">receive_short_frames</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">promiscuous</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">upsmr_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">upsmr_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reject_broadcast</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_BRO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UCC_GETH_UPSMR_BRO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">receive_short_frames</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_RSH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UCC_GETH_UPSMR_RSH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">promiscuous</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_PRO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UCC_GETH_UPSMR_PRO</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">upsmr_register</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_max_rx_buff_len</span><span class="p">(</span><span class="n">u16</span> <span class="n">max_rx_buf_len</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mrblr_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* max_rx_buf_len value must be a multiple of 128 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">max_rx_buf_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">max_rx_buf_len</span> <span class="o">%</span> <span class="n">UCC_GETH_MRBLR_ALIGNMENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="n">mrblr_register</span><span class="p">,</span> <span class="n">max_rx_buf_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_min_frame_len</span><span class="p">(</span><span class="n">u16</span> <span class="n">min_frame_length</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">minflr_register</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mrblr_register</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mrblr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mrblr_value</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="n">mrblr_register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_frame_length</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">mrblr_value</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="n">minflr_register</span><span class="p">,</span> <span class="n">min_frame_length</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adjust_enet_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uf_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">upsmr</span><span class="p">,</span> <span class="n">maccfg2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">ug_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="n">uf_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">uf_regs</span><span class="p">;</span>

	<span class="cm">/*                    Set MACCFG2                    */</span>
	<span class="n">maccfg2</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">);</span>
	<span class="n">maccfg2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MACCFG2_INTERFACE_MODE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">))</span>
		<span class="n">maccfg2</span> <span class="o">|=</span> <span class="n">MACCFG2_INTERFACE_MODE_NIBBLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="n">maccfg2</span> <span class="o">|=</span> <span class="n">MACCFG2_INTERFACE_MODE_BYTE</span><span class="p">;</span>
	<span class="n">maccfg2</span> <span class="o">|=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">padAndCrc</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">,</span> <span class="n">maccfg2</span><span class="p">);</span>

	<span class="cm">/*                    Set UPSMR                      */</span>
	<span class="n">upsmr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">);</span>
	<span class="n">upsmr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UCC_GETH_UPSMR_RPM</span> <span class="o">|</span> <span class="n">UCC_GETH_UPSMR_R10M</span> <span class="o">|</span>
		   <span class="n">UCC_GETH_UPSMR_TBIM</span> <span class="o">|</span> <span class="n">UCC_GETH_UPSMR_RMM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII_ID</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII_RXID</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII_TXID</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">!=</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">)</span>
			<span class="n">upsmr</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_RPM</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="n">upsmr</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_R10M</span><span class="p">;</span>
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">!=</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">)</span>
				<span class="n">upsmr</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_RMM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_TBI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">upsmr</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_TBIM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_SGMII</span><span class="p">))</span>
		<span class="n">upsmr</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_SGMM</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span> <span class="n">upsmr</span><span class="p">);</span>

	<span class="cm">/* Disable autonegotiation in tbi mode, because by default it</span>
<span class="cm">	comes up in autonegotiation mode. */</span>
	<span class="cm">/* Note that this depends on proper setting in utbipar register. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_TBI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">tbiphy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">tbi_node</span><span class="p">)</span>
			<span class="n">ugeth_warn</span><span class="p">(</span><span class="s">&quot;TBI mode requires that the device &quot;</span>
				<span class="s">&quot;tree specify a tbi-handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">tbiphy</span> <span class="o">=</span> <span class="n">of_phy_find_device</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">tbi_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbiphy</span><span class="p">)</span>
			<span class="n">ugeth_warn</span><span class="p">(</span><span class="s">&quot;Could not get TBI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">tbiphy</span><span class="p">,</span> <span class="n">ENET_TBI_MII_CR</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>	<span class="cm">/* Turn off autonegotiation */</span>
		<span class="n">phy_write</span><span class="p">(</span><span class="n">tbiphy</span><span class="p">,</span> <span class="n">ENET_TBI_MII_CR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_check_frame_length_mode</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">lengthCheckRx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">init_preamble_length</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">prel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Preamble length must be between 3 and 7 inclusive.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_graceful_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cecr_subblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="cm">/* Mask GRACEFUL STOP TX interrupt bit and clear it */</span>
	<span class="n">clrbits32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">,</span> <span class="n">UCC_GETH_UCCE_GRA</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_ucce</span><span class="p">,</span> <span class="n">UCC_GETH_UCCE_GRA</span><span class="p">);</span>  <span class="cm">/* clear by writing 1 */</span>

	<span class="cm">/* Issue host command */</span>
	<span class="n">cecr_subblock</span> <span class="o">=</span>
	    <span class="n">ucc_fast_get_qe_cr_subblock</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span><span class="p">);</span>
	<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_GRACEFUL_STOP_TX</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span>
		     <span class="n">QE_CR_PROTOCOL_ETHERNET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Wait for command to complete */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_ucce</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">UCC_GETH_UCCE_GRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">i</span><span class="p">);</span>

	<span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_graceful_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cecr_subblock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="cm">/* Clear acknowledge bit */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxgstpack</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GRACEFUL_STOP_ACKNOWLEDGE_RX</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxgstpack</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Keep issuing command and checking acknowledge bit until</span>
<span class="cm">	it is asserted, according to spec */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Issue host command */</span>
		<span class="n">cecr_subblock</span> <span class="o">=</span>
		    <span class="n">ucc_fast_get_qe_cr_subblock</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span>
						<span class="n">ucc_num</span><span class="p">);</span>
		<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_GRACEFUL_STOP_RX</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span>
			     <span class="n">QE_CR_PROTOCOL_ETHERNET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxgstpack</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">GRACEFUL_STOP_ACKNOWLEDGE_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">i</span><span class="p">);</span>

	<span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_restart_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cecr_subblock</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="n">cecr_subblock</span> <span class="o">=</span>
	    <span class="n">ucc_fast_get_qe_cr_subblock</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span><span class="p">);</span>
	<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_RESTART_TX</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span> <span class="n">QE_CR_PROTOCOL_ETHERNET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_restart_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cecr_subblock</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="n">cecr_subblock</span> <span class="o">=</span>
	    <span class="n">ucc_fast_get_qe_cr_subblock</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span><span class="p">);</span>
	<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_RESTART_RX</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span> <span class="n">QE_CR_PROTOCOL_ETHERNET</span><span class="p">,</span>
		     <span class="mi">0</span><span class="p">);</span>
	<span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span> <span class="k">enum</span> <span class="n">comm_dir</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enabled_tx</span><span class="p">,</span> <span class="n">enabled_rx</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="cm">/* check if the UCC number is in range. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span> <span class="o">&gt;=</span> <span class="n">UCC_MAX_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: ucc_num out of range.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">enabled_tx</span> <span class="o">=</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">enabled_tx</span><span class="p">;</span>
	<span class="n">enabled_rx</span> <span class="o">=</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">enabled_rx</span><span class="p">;</span>

	<span class="cm">/* Get Tx and Rx going again, in case this channel was actively</span>
<span class="cm">	disabled. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">COMM_DIR_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled_tx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_tx</span><span class="p">)</span>
		<span class="n">ugeth_restart_tx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">COMM_DIR_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled_rx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_rx</span><span class="p">)</span>
		<span class="n">ugeth_restart_rx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>

	<span class="n">ucc_fast_enable</span><span class="p">(</span><span class="n">uccf</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>	<span class="cm">/* OK to do even if not disabled */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span> <span class="k">enum</span> <span class="n">comm_dir</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="cm">/* check if the UCC number is in range. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span> <span class="o">&gt;=</span> <span class="n">UCC_MAX_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: ucc_num out of range.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stop any transmissions */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">COMM_DIR_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">enabled_tx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_tx</span><span class="p">)</span>
		<span class="n">ugeth_graceful_stop_tx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>

	<span class="cm">/* Stop any receptions */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">COMM_DIR_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">enabled_rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">stopped_rx</span><span class="p">)</span>
		<span class="n">ugeth_graceful_stop_rx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>

	<span class="n">ucc_fast_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span> <span class="cm">/* OK to do even if not enabled */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ugeth_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Prevent any further xmits, plus detach the device. */</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Wait for any current xmits to finish. */</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Disable the interrupt to avoid NAPI rescheduling. */</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Stop NAPI, and possibly wait for its completion. */</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ugeth_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called every time the controller might need to be made</span>
<span class="cm"> * aware of new link state.  The PHY code conveys this</span>
<span class="cm"> * information through variables in the ugeth structure, and this</span>
<span class="cm"> * function converts those variables into the appropriate</span>
<span class="cm"> * register values, and can bring down the device if needed.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uf_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ug_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="n">uf_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">uf_regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tempval</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">upsmr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">);</span>
		<span class="cm">/* Now we make sure that we can be in full duplex mode.</span>
<span class="cm">		 * If not, we operate in half-duplex mode. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldduplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">))</span>
				<span class="n">tempval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MACCFG2_FDX</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tempval</span> <span class="o">|=</span> <span class="n">MACCFG2_FDX</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldduplex</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldspeed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SPEED_1000</span>:
				<span class="n">tempval</span> <span class="o">=</span> <span class="p">((</span><span class="n">tempval</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="p">(</span><span class="n">MACCFG2_INTERFACE_MODE_MASK</span><span class="p">))</span> <span class="o">|</span>
					    <span class="n">MACCFG2_INTERFACE_MODE_BYTE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="k">case</span> <span class="n">SPEED_10</span>:
				<span class="n">tempval</span> <span class="o">=</span> <span class="p">((</span><span class="n">tempval</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="p">(</span><span class="n">MACCFG2_INTERFACE_MODE_MASK</span><span class="p">))</span> <span class="o">|</span>
					    <span class="n">MACCFG2_INTERFACE_MODE_NIBBLE</span><span class="p">);</span>
				<span class="cm">/* if reduced mode, re-set UPSMR.R10M */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII_ID</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII_RXID</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RGMII_TXID</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
						<span class="n">upsmr</span> <span class="o">|=</span> <span class="n">UCC_GETH_UPSMR_R10M</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">upsmr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UCC_GETH_UPSMR_R10M</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
					<span class="n">ugeth_warn</span><span class="p">(</span>
						<span class="s">&quot;%s: Ack!  Speed (%d) is not 10/100/1000!&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldspeed</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldlink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldlink</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * To change the MAC configuration we need to disable</span>
<span class="cm">			 * the controller. To do so, we have to either grab</span>
<span class="cm">			 * ugeth-&gt;lock, which is a bad idea since &#39;graceful</span>
<span class="cm">			 * stop&#39; commands might take quite a while, or we can</span>
<span class="cm">			 * quiesce driver&#39;s activity.</span>
<span class="cm">			 */</span>
			<span class="n">ugeth_quiesce</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
			<span class="n">ugeth_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>

			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">,</span> <span class="n">tempval</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span> <span class="n">upsmr</span><span class="p">);</span>

			<span class="n">ugeth_enable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>
			<span class="n">ugeth_activate</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldlink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldlink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldduplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_link</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
		<span class="n">phy_print_status</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize TBI PHY interface for communicating with the</span>
<span class="cm"> * SERDES lynx PHY on the chip.  We communicate with this PHY</span>
<span class="cm"> * through the MDIO bus on each controller, treating it as a</span>
<span class="cm"> * &quot;normal&quot; PHY at the address found in the UTBIPA register.  We assume</span>
<span class="cm"> * that the UTBIPA register is valid.  Either the MDIO bus code will set</span>
<span class="cm"> * it to a value that doesn&#39;t conflict with other PHYs on the bus, or the</span>
<span class="cm"> * value doesn&#39;t matter, as there are no other PHYs on the bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uec_configure_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">tbiphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">tbi_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SGMII mode requires that the device &quot;</span>
			<span class="s">&quot;tree specify a tbi-handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tbiphy</span> <span class="o">=</span> <span class="n">of_phy_find_device</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">tbi_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbiphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error: Could not get TBI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the link is already up, we must already be ok, and don&#39;t need to</span>
<span class="cm">	 * configure and reset the TBI&lt;-&gt;SerDes link.  Maybe U-Boot configured</span>
<span class="cm">	 * everything for us?  Resetting it takes the link down and requires</span>
<span class="cm">	 * several seconds for it to come back.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_read</span><span class="p">(</span><span class="n">tbiphy</span><span class="p">,</span> <span class="n">ENET_TBI_MII_SR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TBISR_LSTATUS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Single clk mode, mii mode off(for serdes communication) */</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">tbiphy</span><span class="p">,</span> <span class="n">ENET_TBI_MII_ANA</span><span class="p">,</span> <span class="n">TBIANA_SETTINGS</span><span class="p">);</span>

	<span class="n">phy_write</span><span class="p">(</span><span class="n">tbiphy</span><span class="p">,</span> <span class="n">ENET_TBI_MII_TBICON</span><span class="p">,</span> <span class="n">TBICON_CLK_SELECT</span><span class="p">);</span>

	<span class="n">phy_write</span><span class="p">(</span><span class="n">tbiphy</span><span class="p">,</span> <span class="n">ENET_TBI_MII_CR</span><span class="p">,</span> <span class="n">TBICR_SETTINGS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Configure the PHY for dev.</span>
<span class="cm"> * returns 0 if success.  -1 if failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldlink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldduplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="n">of_phy_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adjust_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phydev</span><span class="p">)</span>
		<span class="n">phydev</span> <span class="o">=</span> <span class="n">of_phy_connect_fixed_link</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adjust_link</span><span class="p">,</span>
						   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phydev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not attach to PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_SGMII</span><span class="p">)</span>
		<span class="n">uec_configure_serdes</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_MII</span> <span class="o">|</span>
			      <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			      <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
			      <span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
			      <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
			      <span class="n">ADVERTISED_100baseT_Full</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>

	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">phydev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ugeth_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">ucc_fast_dump_regs</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">);</span>
	<span class="n">dump_regs</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="n">dump_bds</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_82xx_filtering_clear_all_addr_in_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span>
						       <span class="n">ugeth</span><span class="p">,</span>
						       <span class="k">enum</span> <span class="n">enet_addr_type</span>
						       <span class="n">enet_addr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_82xx_addr_filt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">comm_dir</span> <span class="n">comm_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p_lh</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr_h</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr_l</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p_counter</span><span class="p">;</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>

	<span class="n">p_82xx_addr_filt</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">addressfiltering</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enet_addr_type</span> <span class="o">==</span> <span class="n">ENET_ADDR_TYPE_GROUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">gaddr_h</span><span class="p">);</span>
		<span class="n">addr_l</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">gaddr_l</span><span class="p">);</span>
		<span class="n">p_lh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">group_hash_q</span><span class="p">;</span>
		<span class="n">p_counter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">numGroupAddrInHash</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enet_addr_type</span> <span class="o">==</span> <span class="n">ENET_ADDR_TYPE_INDIVIDUAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">iaddr_h</span><span class="p">);</span>
		<span class="n">addr_l</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">iaddr_l</span><span class="p">);</span>
		<span class="n">p_lh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ind_hash_q</span><span class="p">;</span>
		<span class="n">p_counter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">numIndAddrInHash</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">comm_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">enabled_tx</span><span class="p">)</span>
		<span class="n">comm_dir</span> <span class="o">|=</span> <span class="n">COMM_DIR_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">enabled_rx</span><span class="p">)</span>
		<span class="n">comm_dir</span> <span class="o">|=</span> <span class="n">COMM_DIR_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comm_dir</span><span class="p">)</span>
		<span class="n">ugeth_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">comm_dir</span><span class="p">);</span>

	<span class="cm">/* Clear the hash table. */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">addr_h</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">addr_l</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_lh</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_counter</span><span class="p">;</span>

	<span class="cm">/* Delete all remaining CQ elements */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_enet_addr_container</span><span class="p">(</span><span class="n">ENET_ADDR_CONT_ENTRY</span><span class="p">(</span><span class="n">dequeue</span><span class="p">(</span><span class="n">p_lh</span><span class="p">)));</span>

	<span class="o">*</span><span class="n">p_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comm_dir</span><span class="p">)</span>
		<span class="n">ugeth_enable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">comm_dir</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ugeth_82xx_filtering_clear_addr_in_paddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span>
						    <span class="n">u8</span> <span class="n">paddr_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">indAddrRegUsed</span><span class="p">[</span><span class="n">paddr_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mark this paddr as not used */</span>
	<span class="k">return</span> <span class="n">hw_clear_addr_in_paddr</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">paddr_num</span><span class="p">);</span><span class="cm">/* clear in hardware */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_free_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_info</span> <span class="o">*</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>


	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">uf_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* Return existing data buffers in ring */</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">),</span>
						<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span>
						<span class="n">uf_info</span><span class="p">.</span><span class="n">max_rx_buf_length</span> <span class="o">+</span>
						<span class="n">UCC_GETH_RX_DATA_BUF_ALIGNMENT</span><span class="p">,</span>
						<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span>
						<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
					<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span>
			    <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span>
				 <span class="n">MEM_PART_MURAM</span><span class="p">)</span>
				<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_free_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_info</span> <span class="o">*</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">uf_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">),</span>
						 <span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span> <span class="o">&amp;</span>
						  <span class="n">BD_LENGTH_MASK</span><span class="p">),</span>
						 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span>
			    <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span>
				 <span class="n">MEM_PART_MURAM</span><span class="p">)</span>
				<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_memclean</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeth</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucc_fast_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_tx_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_rx_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">exf_glbl_param_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_glbl_pram_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_glbl_pram_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">send_q_mem_reg_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">scheduler_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_fw_statistics_pram_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_fw_statistics_pram_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_irq_coalescing_tbl_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_qs_tbl_offset</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">return_init_enet_entries</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span>
					   <span class="n">rxthread</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
					 <span class="n">ENET_INIT_PARAM_MAX_ENTRIES_RX</span><span class="p">,</span>
					 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscRx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">return_init_enet_entries</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span>
					   <span class="n">txthread</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
					 <span class="n">ENET_INIT_PARAM_MAX_ENTRIES_TX</span><span class="p">,</span>
					 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscTx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucc_geth_free_tx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="n">ucc_geth_free_rx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">group_hash_q</span><span class="p">))</span>
		<span class="n">put_enet_addr_container</span><span class="p">(</span><span class="n">ENET_ADDR_CONT_ENTRY</span>
					<span class="p">(</span><span class="n">dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">group_hash_q</span><span class="p">)));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ind_hash_q</span><span class="p">))</span>
		<span class="n">put_enet_addr_container</span><span class="p">(</span><span class="n">ENET_ADDR_CONT_ENTRY</span>
					<span class="p">(</span><span class="n">dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ind_hash_q</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uf_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_82xx_addr_filt</span><span class="p">;</span>

	<span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">uf_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">uf_regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span> <span class="n">UCC_GETH_UPSMR_PRO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clrbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span> <span class="n">UCC_GETH_UPSMR_PRO</span><span class="p">);</span>

		<span class="n">p_82xx_addr_filt</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span>
		    <span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">addressfiltering</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Catch all multicast addresses, so set the</span>
<span class="cm">			 * filter to all 1&#39;s.</span>
<span class="cm">			 */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">gaddr_h</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">gaddr_l</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Clear filter and add the addresses in the list.</span>
<span class="cm">			 */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">gaddr_h</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_82xx_addr_filt</span><span class="o">-&gt;</span><span class="n">gaddr_l</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

			<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Ask CPM to run CRC and set bit in</span>
<span class="cm">				 * filter mask.</span>
<span class="cm">				 */</span>
				<span class="n">hw_add_addr_in_hash</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ug_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the kernel the link is down.</span>
<span class="cm">	 * Must be done before disabling the controller</span>
<span class="cm">	 * or deadlock may happen.</span>
<span class="cm">	 */</span>
	<span class="n">phy_stop</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>

	<span class="cm">/* Disable the controller */</span>
	<span class="n">ugeth_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>

	<span class="cm">/* Mask all interrupts */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* Clear all interrupts */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_ucce</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* Disable Rx and Tx */</span>
	<span class="n">clrbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg1</span><span class="p">,</span> <span class="n">MACCFG1_ENABLE_RX</span> <span class="o">|</span> <span class="n">MACCFG1_ENABLE_TX</span><span class="p">);</span>

	<span class="n">ucc_geth_memclean</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_struct_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_info</span> <span class="o">*</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">uf_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_MURAM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Bad memory partition value.&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Rx BD lengths */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_RX_BD_RING_SIZE_MIN</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span>
		     <span class="n">UCC_GETH_RX_BD_RING_SIZE_ALIGNMENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: Rx BD ring length must be multiple of 4, no smaller than 8.&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Tx BD lengths */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_TX_BD_RING_SIZE_MIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: Tx BD ring length must be no smaller than 2.&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* mrblr */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">max_rx_buf_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">max_rx_buf_length</span> <span class="o">%</span> <span class="n">UCC_GETH_MRBLR_ALIGNMENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: max_rx_buf_length must be non-zero multiple of 128.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* num Tx queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span> <span class="o">&gt;</span> <span class="n">NUM_TX_QUEUES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: number of tx queues too large.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* num Rx queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span> <span class="o">&gt;</span> <span class="n">NUM_RX_QUEUES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: number of rx queues too large.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* l2qt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_VLAN_PRIORITY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">l2qt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: VLAN priority table entry must not be&quot;</span>
					<span class="s">&quot; larger than number of Rx queues.&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* l3qt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_IP_PRIORITY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: IP priority table entry must not be&quot;</span>
					<span class="s">&quot; larger than number of Rx queues.&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">cam</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ecamptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: If cam mode is chosen, must supply cam ptr.&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numStationAddresses</span> <span class="o">!=</span>
	     <span class="n">UCC_GETH_NUM_OF_STATION_ADDRESSES_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rxExtendedFiltering</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Number of station addresses greater than 1 &quot;</span>
				  <span class="s">&quot;not allowed in extended parsing mode.&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Generate uccm_mask for receive */</span>
	<span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">uccm_mask</span> <span class="o">=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">eventRegMask</span> <span class="o">&amp;</span> <span class="n">UCCE_OTHER</span><span class="p">;</span><span class="cm">/* Errors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">uccm_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UCC_GETH_UCCE_RXF0</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">uccm_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UCC_GETH_UCCE_TXB0</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="cm">/* Initialize the general fast UCC block. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucc_fast_init</span><span class="p">(</span><span class="n">uf_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to init uccf.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read the number of risc engines, update the riscTx and riscRx</span>
<span class="cm">	 * if there are 4 riscs in QE</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qe_get_num_of_risc</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscTx</span> <span class="o">=</span> <span class="n">QE_RISC_ALLOCATION_FOUR_RISCS</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscRx</span> <span class="o">=</span> <span class="n">QE_RISC_ALLOCATION_FOUR_RISCS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to ioremap regs.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_alloc_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_info</span> <span class="o">*</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">uf_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">;</span>

	<span class="cm">/* Allocate Tx bds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate in multiple of</span>
<span class="cm">		   UCC_GETH_TX_BD_RING_SIZE_MEMORY_ALIGNMENT,</span>
<span class="cm">		   according to spec */</span>
		<span class="n">length</span> <span class="o">=</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">))</span>
			  <span class="o">/</span> <span class="n">UCC_GETH_TX_BD_RING_SIZE_MEMORY_ALIGNMENT</span><span class="p">)</span>
		    <span class="o">*</span> <span class="n">UCC_GETH_TX_BD_RING_SIZE_MEMORY_ALIGNMENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">))</span> <span class="o">%</span>
		    <span class="n">UCC_GETH_TX_BD_RING_SIZE_MEMORY_ALIGNMENT</span><span class="p">)</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="n">UCC_GETH_TX_BD_RING_SIZE_MEMORY_ALIGNMENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">UCC_GETH_TX_BD_RING_ALIGNMENT</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">align</span> <span class="o">=</span> <span class="n">UCC_GETH_TX_BD_RING_ALIGNMENT</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">align</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
					<span class="n">align</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_MURAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">length</span><span class="p">,</span>
					   <span class="n">UCC_GETH_TX_BD_RING_ALIGNMENT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
				<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							 <span class="n">tx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: Can not allocate memory for Tx bd rings.&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Zero unused end of bd ring, according to spec */</span>
		<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
		       <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">length</span> <span class="o">-</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Init Tx bds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup the skbuff rings */</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
					      <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Could not allocate tx_skbuff&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_curtx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_dirtytx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">confBd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">txBd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear bd buffer */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* set bd status and length */</span>
			<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bd</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="cm">/* set bd status and length */</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">T_W</span><span class="p">);</span> <span class="cm">/* for last BD set Wrap bit */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_alloc_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_info</span> <span class="o">*</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">uf_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">;</span>

	<span class="cm">/* Allocate Rx bds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">UCC_GETH_RX_BD_RING_ALIGNMENT</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">align</span> <span class="o">=</span> <span class="n">UCC_GETH_RX_BD_RING_ALIGNMENT</span><span class="p">;</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">align</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
					<span class="n">align</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_MURAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">length</span><span class="p">,</span>
					   <span class="n">UCC_GETH_RX_BD_RING_ALIGNMENT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
				<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							 <span class="n">rx_bd_ring_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: Can not allocate memory for Rx bd rings.&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Init Rx bds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup the skbuff rings */</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
					      <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Could not allocate rx_skbuff&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_currx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rxBd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set bd status and length */</span>
			<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">R_I</span><span class="p">);</span>
			<span class="cm">/* clear bd buffer */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bd</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="cm">/* set bd status and length */</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">R_W</span><span class="p">);</span> <span class="cm">/* for last BD set Wrap bit */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_82xx_addr_filt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_init_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_init_enet_pram</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast_info</span> <span class="o">*</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_fast</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uf_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ug_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">remoder</span> <span class="o">=</span> <span class="n">UCC_GETH_REMODER_INIT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">init_enet_pram_offset</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifstat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">l2qt</span><span class="p">,</span> <span class="n">l3qt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temoder</span> <span class="o">=</span> <span class="n">UCC_GETH_TEMODER_INIT</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">test</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">endOfRing</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">numThreadsRxNumerical</span><span class="p">,</span> <span class="n">numThreadsTxNumerical</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="n">uf_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">;</span>
	<span class="n">uf_regs</span> <span class="o">=</span> <span class="n">uccf</span><span class="o">-&gt;</span><span class="n">uf_regs</span><span class="p">;</span>
	<span class="n">ug_regs</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsRx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_1</span>:
		<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_2</span>:
		<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_4</span>:
		<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_6</span>:
		<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_8</span>:
		<span class="n">numThreadsRxNumerical</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Bad number of Rx threads value.&quot;</span><span class="p">,</span>
				       	<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsTx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_1</span>:
		<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_2</span>:
		<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_4</span>:
		<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_6</span>:
		<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UCC_GETH_NUM_OF_THREADS_8</span>:
		<span class="n">numThreadsTxNumerical</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Bad number of Tx threads value.&quot;</span><span class="p">,</span>
				       	<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate rx_extended_features */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_non_dynamic_extended_features</span> <span class="o">=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ipCheckSumCheck</span> <span class="o">||</span>
	    <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ipAddressAlignment</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numStationAddresses</span> <span class="o">!=</span>
	     <span class="n">UCC_GETH_NUM_OF_STATION_ADDRESSES_1</span><span class="p">);</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_extended_features</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_non_dynamic_extended_features</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">vlanOperationTagged</span> <span class="o">!=</span> <span class="n">UCC_GETH_VLAN_OPERATION_TAGGED_NOP</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">vlanOperationNonTagged</span> <span class="o">!=</span>
		 <span class="n">UCC_GETH_VLAN_OPERATION_NON_TAGGED_NOP</span><span class="p">);</span>

	<span class="n">init_default_reg_vals</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">);</span>

	<span class="cm">/*                    Set UPSMR                      */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">init_rx_parameters</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bro</span><span class="p">,</span>
			   <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rsh</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">pro</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">);</span>

	<span class="cm">/* We&#39;re going to ignore other registers for now, */</span>
	<span class="cm">/* except as needed to get up and running         */</span>

	<span class="cm">/*                    Set MACCFG1                    */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">init_flow_control_params</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">aufc</span><span class="p">,</span>
				 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">receiveFlowControl</span><span class="p">,</span>
				 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">transmitFlowControl</span><span class="p">,</span>
				 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">pausePeriod</span><span class="p">,</span>
				 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">extensionField</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uempr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg1</span><span class="p">);</span>

	<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg1</span><span class="p">,</span> <span class="n">MACCFG1_ENABLE_RX</span> <span class="o">|</span> <span class="n">MACCFG1_ENABLE_TX</span><span class="p">);</span>

	<span class="cm">/*                    Set IPGIFG                     */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">init_inter_frame_gap_params</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">nonBackToBackIfgPart1</span><span class="p">,</span>
					      <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">nonBackToBackIfgPart2</span><span class="p">,</span>
					      <span class="n">ug_info</span><span class="o">-&gt;</span>
					      <span class="n">miminumInterFrameGapEnforcement</span><span class="p">,</span>
					      <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">backToBackInterFrameGap</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ipgifg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: IPGIFG initialization parameter too large.&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*                    Set HAFDUP                     */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">init_half_duplex_params</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">altBeb</span><span class="p">,</span>
					  <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">backPressureNoBackoff</span><span class="p">,</span>
					  <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">noBackoff</span><span class="p">,</span>
					  <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">excessDefer</span><span class="p">,</span>
					  <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">altBebTruncation</span><span class="p">,</span>
					  <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">maxRetransmission</span><span class="p">,</span>
					  <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">collisionWindow</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">hafdup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Half Duplex initialization parameter too large.&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*                    Set IFSTAT                     */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="cm">/* Read only - resets upon read                      */</span>
	<span class="n">ifstat</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">ifstat</span><span class="p">);</span>

	<span class="cm">/*                    Clear UEMPR                    */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uempr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*                    Set UESCR                      */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">init_hw_statistics_gathering_mode</span><span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">statisticsMode</span> <span class="o">&amp;</span>
				<span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_HARDWARE</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf_regs</span><span class="o">-&gt;</span><span class="n">upsmr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">uescr</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">ucc_geth_alloc_tx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">ucc_geth_alloc_rx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Global PRAM</span>
<span class="cm">	 */</span>
	<span class="cm">/* Tx global PRAM */</span>
	<span class="cm">/* Allocate global tx parameter RAM page */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_glbl_pram_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_tx_global_pram</span><span class="p">),</span>
			   <span class="n">UCC_GETH_TX_GLOBAL_PRAM_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_glbl_pram_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_tx_glbl_pram.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_tx_global_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							<span class="n">tx_glbl_pram_offset</span><span class="p">);</span>
	<span class="cm">/* Zero out p_tx_glbl_pram */</span>
	<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_tx_global_pram</span><span class="p">));</span>

	<span class="cm">/* Fill global PRAM */</span>

	<span class="cm">/* TQPTR */</span>
	<span class="cm">/* Size varies with number of Tx threads */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_tx_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">numThreadsTxNumerical</span> <span class="o">*</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_data_tx</span><span class="p">)</span> <span class="o">+</span>
			   <span class="mi">32</span> <span class="o">*</span> <span class="p">(</span><span class="n">numThreadsTxNumerical</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
			   <span class="n">UCC_GETH_THREAD_DATA_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_tx_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_thread_data_tx.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_tx</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_data_tx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							<span class="n">thread_dat_tx_offset</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">tqptr</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_tx_offset</span><span class="p">);</span>

	<span class="cm">/* vtagtable */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_TX_VTAG_TABLE_ENTRY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">vtagtable</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* iphoffset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_IP_OFFSET_ENTRY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">iphoffset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* SQPTR */</span>
	<span class="cm">/* Size varies with number of Tx queues */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">send_q_mem_reg_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span> <span class="o">*</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_send_queue_qd</span><span class="p">),</span>
			   <span class="n">UCC_GETH_SEND_QUEUE_QUEUE_DESCRIPTOR_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">send_q_mem_reg_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_send_q_mem_reg.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_send_queue_mem_region</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
			<span class="n">send_q_mem_reg_offset</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">sqptr</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">send_q_mem_reg_offset</span><span class="p">);</span>

	<span class="cm">/* Setup the table */</span>
	<span class="cm">/* Assume BD rings are already established */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endOfRing</span> <span class="o">=</span>
		    <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span>
					      <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="o">-&gt;</span><span class="n">sqqd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bd_ring_base</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="o">-&gt;</span><span class="n">sqqd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
				 <span class="n">last_bd_completed_address</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">endOfRing</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span>
			   <span class="n">MEM_PART_MURAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="o">-&gt;</span><span class="n">sqqd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bd_ring_base</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">immrbar_virt_to_phys</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							    <span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_send_q_mem_reg</span><span class="o">-&gt;</span><span class="n">sqqd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
				 <span class="n">last_bd_completed_address</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">immrbar_virt_to_phys</span><span class="p">(</span><span class="n">endOfRing</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* schedulerbasepointer */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* scheduler exists only if more than 1 tx queue */</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">scheduler_offset</span> <span class="o">=</span>
		    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_scheduler</span><span class="p">),</span>
				   <span class="n">UCC_GETH_SCHEDULER_ALIGNMENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">scheduler_offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				 <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_scheduler.&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_scheduler</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							   <span class="n">scheduler_offset</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">schedulerbasepointer</span><span class="p">,</span>
			 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">scheduler_offset</span><span class="p">);</span>
		<span class="cm">/* Zero out p_scheduler */</span>
		<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_scheduler</span><span class="p">));</span>

		<span class="cm">/* Set values in scheduler */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">mblinterval</span><span class="p">,</span>
			 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">mblinterval</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">nortsrbytetime</span><span class="p">,</span>
			 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">nortsrbytetime</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">fracsiz</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">fracsiz</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">strictpriorityq</span><span class="p">,</span>
				<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">strictpriorityq</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">txasap</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">txasap</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">extrabw</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">extrabw</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">weightfactor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			    <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">weightfactor</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Set pointers to cpucount registers in scheduler */</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount0</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount1</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount2</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount3</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount4</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount5</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount6</span><span class="p">);</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="o">-&gt;</span><span class="n">cpucount7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* schedulerbasepointer */</span>
	<span class="cm">/* TxRMON_PTR (statistics) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span>
	    <span class="n">statisticsMode</span> <span class="o">&amp;</span> <span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_FIRMWARE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_fw_statistics_pram_offset</span> <span class="o">=</span>
		    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span>
				   <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_tx_firmware_statistics_pram</span><span class="p">),</span>
				   <span class="n">UCC_GETH_TX_STATISTICS_ALIGNMENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_fw_statistics_pram_offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
				    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for&quot;</span>
					<span class="s">&quot; p_tx_fw_statistics_pram.&quot;</span><span class="p">,</span>
				       	<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_tx_firmware_statistics_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_fw_statistics_pram_offset</span><span class="p">);</span>
		<span class="cm">/* Zero out p_tx_fw_statistics_pram */</span>
		<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_fw_statistics_pram</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_tx_firmware_statistics_pram</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* temoder */</span>
	<span class="cm">/* Already has speed set */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">temoder</span> <span class="o">|=</span> <span class="n">TEMODER_SCHEDULER_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ipCheckSumGenerate</span><span class="p">)</span>
		<span class="n">temoder</span> <span class="o">|=</span> <span class="n">TEMODER_IP_CHECKSUM_GENERATE</span><span class="p">;</span>
	<span class="n">temoder</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TEMODER_NUM_OF_QUEUES_SHIFT</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">temoder</span><span class="p">,</span> <span class="n">temoder</span><span class="p">);</span>

	<span class="n">test</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">temoder</span><span class="p">);</span>

	<span class="cm">/* Function code register value to be used later */</span>
	<span class="n">function_code</span> <span class="o">=</span> <span class="n">UCC_BMR_BO_BE</span> <span class="o">|</span> <span class="n">UCC_BMR_GBL</span><span class="p">;</span>
	<span class="cm">/* Required for QE */</span>

	<span class="cm">/* function code register */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">function_code</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="cm">/* Rx global PRAM */</span>
	<span class="cm">/* Allocate global rx parameter RAM page */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_glbl_pram_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_global_pram</span><span class="p">),</span>
			   <span class="n">UCC_GETH_RX_GLOBAL_PRAM_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_glbl_pram_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_rx_glbl_pram.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_global_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							<span class="n">rx_glbl_pram_offset</span><span class="p">);</span>
	<span class="cm">/* Zero out p_rx_glbl_pram */</span>
	<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_global_pram</span><span class="p">));</span>

	<span class="cm">/* Fill global PRAM */</span>

	<span class="cm">/* RQPTR */</span>
	<span class="cm">/* Size varies with number of Rx threads */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_rx_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">numThreadsRxNumerical</span> <span class="o">*</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_data_rx</span><span class="p">),</span>
			   <span class="n">UCC_GETH_THREAD_DATA_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_rx_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_thread_data_rx.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_thread_data_rx</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_data_rx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							<span class="n">thread_dat_rx_offset</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rqptr</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">thread_dat_rx_offset</span><span class="p">);</span>

	<span class="cm">/* typeorlen */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">typeorlen</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">typeorlen</span><span class="p">);</span>

	<span class="cm">/* rxrmonbaseptr (statistics) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span>
	    <span class="n">statisticsMode</span> <span class="o">&amp;</span> <span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_FIRMWARE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_fw_statistics_pram_offset</span> <span class="o">=</span>
		    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span>
				   <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_firmware_statistics_pram</span><span class="p">),</span>
				   <span class="n">UCC_GETH_RX_STATISTICS_ALIGNMENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_fw_statistics_pram_offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
					<span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for&quot;</span>
					<span class="s">&quot; p_rx_fw_statistics_pram.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_firmware_statistics_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_fw_statistics_pram_offset</span><span class="p">);</span>
		<span class="cm">/* Zero out p_rx_fw_statistics_pram */</span>
		<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_fw_statistics_pram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_firmware_statistics_pram</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* intCoalescingPtr */</span>

	<span class="cm">/* Size varies with number of Rx queues */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_irq_coalescing_tbl_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span> <span class="o">*</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_interrupt_coalescing_entry</span><span class="p">)</span>
			   <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">UCC_GETH_RX_INTERRUPT_COALESCING_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_irq_coalescing_tbl_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for&quot;</span>
				<span class="s">&quot; p_rx_irq_coalescing_tbl.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_interrupt_coalescing_table</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_irq_coalescing_tbl_offset</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">intcoalescingptr</span><span class="p">,</span>
		 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_irq_coalescing_tbl_offset</span><span class="p">);</span>

	<span class="cm">/* Fill interrupt coalescing table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span><span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
			 <span class="n">interruptcoalescingmaxvalue</span><span class="p">,</span>
			 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">interruptcoalescingmaxvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_irq_coalescing_tbl</span><span class="o">-&gt;</span><span class="n">coalescingentry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
			 <span class="n">interruptcoalescingcounter</span><span class="p">,</span>
			 <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">interruptcoalescingmaxvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* MRBLR */</span>
	<span class="n">init_max_rx_buff_len</span><span class="p">(</span><span class="n">uf_info</span><span class="o">-&gt;</span><span class="n">max_rx_buf_length</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mrblr</span><span class="p">);</span>
	<span class="cm">/* MFLR */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mflr</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">maxFrameLength</span><span class="p">);</span>
	<span class="cm">/* MINFLR */</span>
	<span class="n">init_min_frame_len</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">minFrameLength</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">minflr</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">mrblr</span><span class="p">);</span>
	<span class="cm">/* MAXD1 */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">maxd1</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">maxD1Length</span><span class="p">);</span>
	<span class="cm">/* MAXD2 */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">maxd2</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">maxD2Length</span><span class="p">);</span>

	<span class="cm">/* l2qt */</span>
	<span class="n">l2qt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_VLAN_PRIORITY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">l2qt</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">l2qt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">28</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l2qt</span><span class="p">,</span> <span class="n">l2qt</span><span class="p">);</span>

	<span class="cm">/* l3qt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">UCC_GETH_IP_PRIORITY_MAX</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3qt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">l3qt</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">28</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">l3qt</span><span class="p">[</span><span class="n">j</span><span class="o">/</span><span class="mi">8</span><span class="p">],</span> <span class="n">l3qt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* vlantype */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vlantype</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">vlantype</span><span class="p">);</span>

	<span class="cm">/* vlantci */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">vlantci</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">vlantci</span><span class="p">);</span>

	<span class="cm">/* ecamptr */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">ecamptr</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ecamptr</span><span class="p">);</span>

	<span class="cm">/* RBDQPTR */</span>
	<span class="cm">/* Size varies with number of Rx queues */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_qs_tbl_offset</span> <span class="o">=</span>
	    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span> <span class="o">*</span>
			   <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_bd_queues_entry</span><span class="p">)</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_prefetched_bds</span><span class="p">)),</span>
			   <span class="n">UCC_GETH_RX_BD_QUEUES_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_qs_tbl_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_rx_bd_qs_tbl.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_bd_queues_entry</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
				    <span class="n">rx_bd_qs_tbl_offset</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rbdqptr</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_bd_qs_tbl_offset</span><span class="p">);</span>
	<span class="cm">/* Zero out p_rx_bd_qs_tbl */</span>
	<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">,</span>
	       <span class="mi">0</span><span class="p">,</span>
	       <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_bd_queues_entry</span><span class="p">)</span> <span class="o">+</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_rx_prefetched_bds</span><span class="p">)));</span>

	<span class="cm">/* Setup the table */</span>
	<span class="cm">/* Assume BD rings are already established */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span> <span class="n">MEM_PART_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">externalbdbaseptr</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">bd_mem_part</span> <span class="o">==</span>
			   <span class="n">MEM_PART_MURAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_qs_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">externalbdbaseptr</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">immrbar_virt_to_phys</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
							    <span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="cm">/* rest of fields handled by QE */</span>
	<span class="p">}</span>

	<span class="cm">/* remoder */</span>
	<span class="cm">/* Already has speed set */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_extended_features</span><span class="p">)</span>
		<span class="n">remoder</span> <span class="o">|=</span> <span class="n">REMODER_RX_EXTENDED_FEATURES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rxExtendedFiltering</span><span class="p">)</span>
		<span class="n">remoder</span> <span class="o">|=</span> <span class="n">REMODER_RX_EXTENDED_FILTERING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">dynamicMaxFrameLength</span><span class="p">)</span>
		<span class="n">remoder</span> <span class="o">|=</span> <span class="n">REMODER_DYNAMIC_MAX_FRAME_LENGTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">dynamicMinFrameLength</span><span class="p">)</span>
		<span class="n">remoder</span> <span class="o">|=</span> <span class="n">REMODER_DYNAMIC_MIN_FRAME_LENGTH</span><span class="p">;</span>
	<span class="n">remoder</span> <span class="o">|=</span>
	    <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">vlanOperationTagged</span> <span class="o">&lt;&lt;</span> <span class="n">REMODER_VLAN_OPERATION_TAGGED_SHIFT</span><span class="p">;</span>
	<span class="n">remoder</span> <span class="o">|=</span>
	    <span class="n">ug_info</span><span class="o">-&gt;</span>
	    <span class="n">vlanOperationNonTagged</span> <span class="o">&lt;&lt;</span> <span class="n">REMODER_VLAN_OPERATION_NON_TAGGED_SHIFT</span><span class="p">;</span>
	<span class="n">remoder</span> <span class="o">|=</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rxQoSMode</span> <span class="o">&lt;&lt;</span> <span class="n">REMODER_RX_QOS_MODE_SHIFT</span><span class="p">;</span>
	<span class="n">remoder</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">REMODER_NUM_OF_QUEUES_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ipCheckSumCheck</span><span class="p">)</span>
		<span class="n">remoder</span> <span class="o">|=</span> <span class="n">REMODER_IP_CHECKSUM_CHECK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">ipAddressAlignment</span><span class="p">)</span>
		<span class="n">remoder</span> <span class="o">|=</span> <span class="n">REMODER_IP_ADDRESS_ALIGNMENT</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">remoder</span><span class="p">,</span> <span class="n">remoder</span><span class="p">);</span>

	<span class="cm">/* Note that this function must be called */</span>
	<span class="cm">/* ONLY AFTER p_tx_fw_statistics_pram */</span>
	<span class="cm">/* andp_UccGethRxFirmwareStatisticsPram are allocated ! */</span>
	<span class="n">init_firmware_statistics_gathering_mode</span><span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span>
		<span class="n">statisticsMode</span> <span class="o">&amp;</span>
		<span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_FIRMWARE_TX</span><span class="p">),</span>
		<span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">statisticsMode</span> <span class="o">&amp;</span>
		<span class="n">UCC_GETH_STATISTICS_GATHERING_MODE_FIRMWARE_RX</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">txrmonbaseptr</span><span class="p">,</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_fw_statistics_pram_offset</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rxrmonbaseptr</span><span class="p">,</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_fw_statistics_pram_offset</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_glbl_pram</span><span class="o">-&gt;</span><span class="n">temoder</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">remoder</span><span class="p">);</span>

	<span class="cm">/* function code register */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">rstate</span><span class="p">,</span> <span class="n">function_code</span><span class="p">);</span>

	<span class="cm">/* initialize extended filtering */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rxExtendedFiltering</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">extendedFilteringChainPointer</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Null Extended Filtering Chain Pointer.&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Allocate memory for extended filtering Mode Global</span>
<span class="cm">		Parameters */</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">exf_glbl_param_offset</span> <span class="o">=</span>
		    <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_exf_global_pram</span><span class="p">),</span>
		<span class="n">UCC_GETH_RX_EXTENDED_FILTERING_GLOBAL_PARAMETERS_ALIGNMENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">exf_glbl_param_offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span>
					<span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for&quot;</span>
					<span class="s">&quot; p_exf_glbl_param.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_exf_global_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
				 <span class="n">exf_glbl_param_offset</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">exfGlobalParam</span><span class="p">,</span>
			 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">exf_glbl_param_offset</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_exf_glbl_param</span><span class="o">-&gt;</span><span class="n">l2pcdptr</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">extendedFilteringChainPointer</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* initialize 82xx style address filtering */</span>

		<span class="cm">/* Init individual address recognition registers to disabled */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_OF_PADDRS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ugeth_82xx_filtering_clear_addr_in_paddr</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">j</span><span class="p">);</span>

		<span class="n">p_82xx_addr_filt</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_82xx_address_filtering_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ugeth</span><span class="o">-&gt;</span>
		    <span class="n">p_rx_glbl_pram</span><span class="o">-&gt;</span><span class="n">addressfiltering</span><span class="p">;</span>

		<span class="n">ugeth_82xx_filtering_clear_all_addr_in_hash</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
			<span class="n">ENET_ADDR_TYPE_GROUP</span><span class="p">);</span>
		<span class="n">ugeth_82xx_filtering_clear_all_addr_in_hash</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
			<span class="n">ENET_ADDR_TYPE_INDIVIDUAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize UCC at QE level</span>
<span class="cm">	 */</span>

	<span class="n">command</span> <span class="o">=</span> <span class="n">QE_INIT_TX_RX</span><span class="p">;</span>

	<span class="cm">/* Allocate shadow InitEnet command parameter structure.</span>
<span class="cm">	 * This is needed because after the InitEnet command is executed,</span>
<span class="cm">	 * the structure in DPRAM is released, because DPRAM is a premium</span>
<span class="cm">	 * resource.</span>
<span class="cm">	 * This shadow structure keeps a copy of what was done so that the</span>
<span class="cm">	 * allocated resources can be released when the channel is freed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span> <span class="o">=</span>
	      <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_init_pram</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate memory for&quot;</span>
				<span class="s">&quot; p_UccInitEnetParamShadows.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Zero out *p_init_enet_param_shadow */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="p">,</span>
	       <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_init_pram</span><span class="p">));</span>

	<span class="cm">/* Fill shadow InitEnet command parameter structure */</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit1</span> <span class="o">=</span>
	    <span class="n">ENET_INIT_PARAM_MAGIC_RES_INIT1</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit2</span> <span class="o">=</span>
	    <span class="n">ENET_INIT_PARAM_MAGIC_RES_INIT2</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit3</span> <span class="o">=</span>
	    <span class="n">ENET_INIT_PARAM_MAGIC_RES_INIT3</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit4</span> <span class="o">=</span>
	    <span class="n">ENET_INIT_PARAM_MAGIC_RES_INIT4</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit5</span> <span class="o">=</span>
	    <span class="n">ENET_INIT_PARAM_MAGIC_RES_INIT5</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">rgftgfrxglobal</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsRx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_INIT_PARAM_RGF_SHIFT</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">rgftgfrxglobal</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsTx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_INIT_PARAM_TGF_SHIFT</span><span class="p">;</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">rgftgfrxglobal</span> <span class="o">|=</span>
	    <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_glbl_pram_offset</span> <span class="o">|</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscRx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">!=</span>
	     <span class="n">QE_FLTR_LARGEST_EXTERNAL_TABLE_LOOKUP_KEY_SIZE_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">!=</span>
	     <span class="n">QE_FLTR_LARGEST_EXTERNAL_TABLE_LOOKUP_KEY_SIZE_8_BYTES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">!=</span>
	     <span class="n">QE_FLTR_LARGEST_EXTERNAL_TABLE_LOOKUP_KEY_SIZE_16_BYTES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid largest External Lookup Key Size.&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">=</span>
	    <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_rx_pram</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">rxExtendedFiltering</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">THREAD_RX_PRAM_ADDITIONAL_FOR_EXTENDED_FILTERING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">==</span>
		    <span class="n">QE_FLTR_TABLE_LOOKUP_KEY_SIZE_8_BYTES</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">+=</span>
			    <span class="n">THREAD_RX_PRAM_ADDITIONAL_FOR_EXTENDED_FILTERING_8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span> <span class="o">==</span>
		    <span class="n">QE_FLTR_TABLE_LOOKUP_KEY_SIZE_16_BYTES</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">+=</span>
			    <span class="n">THREAD_RX_PRAM_ADDITIONAL_FOR_EXTENDED_FILTERING_16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret_val</span> <span class="o">=</span> <span class="n">fill_init_enet_entries</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span>
		<span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">rxthread</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">numThreadsRxNumerical</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* Rx needs one extra for terminator */</span>
		<span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">UCC_GETH_THREAD_RX_PRAM_ALIGNMENT</span><span class="p">,</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscRx</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Can not fill p_init_enet_param_shadow.&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">txglobal</span> <span class="o">=</span>
	    <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_glbl_pram_offset</span> <span class="o">|</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscTx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret_val</span> <span class="o">=</span>
	     <span class="n">fill_init_enet_entries</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span>
				      <span class="n">txthread</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">numThreadsTxNumerical</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_thread_tx_pram</span><span class="p">),</span>
				    <span class="n">UCC_GETH_THREAD_TX_PRAM_ALIGNMENT</span><span class="p">,</span>
				    <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">riscTx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Can not fill p_init_enet_param_shadow.&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load Rx bds with buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret_val</span> <span class="o">=</span> <span class="n">rx_bd_buffer_set</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Can not fill Rx bds with buffers.&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate InitEnet command parameter structure */</span>
	<span class="n">init_enet_pram_offset</span> <span class="o">=</span> <span class="n">qe_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_init_pram</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">init_enet_pram_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span>
			    <span class="p">(</span><span class="s">&quot;%s: Can not allocate DPRAM memory for p_init_enet_pram.&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p_init_enet_pram</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_init_pram</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe_muram_addr</span><span class="p">(</span><span class="n">init_enet_pram_offset</span><span class="p">);</span>

	<span class="cm">/* Copy shadow InitEnet command parameter structure into PRAM */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">resinit1</span><span class="p">,</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit1</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">resinit2</span><span class="p">,</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit2</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">resinit3</span><span class="p">,</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit3</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">resinit4</span><span class="p">,</span>
			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit4</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">resinit5</span><span class="p">,</span>
		 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">resinit5</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span><span class="p">,</span>
	    <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">largestexternallookupkeysize</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">rgftgfrxglobal</span><span class="p">,</span>
		 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">rgftgfrxglobal</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENET_INIT_PARAM_MAX_ENTRIES_RX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">rxthread</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">rxthread</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">txglobal</span><span class="p">,</span>
		 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">txglobal</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENET_INIT_PARAM_MAX_ENTRIES_TX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_init_enet_pram</span><span class="o">-&gt;</span><span class="n">txthread</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			 <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_init_enet_param_shadow</span><span class="o">-&gt;</span><span class="n">txthread</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Issue QE command */</span>
	<span class="n">cecr_subblock</span> <span class="o">=</span>
	    <span class="n">ucc_fast_get_qe_cr_subblock</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span><span class="p">);</span>
	<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">cecr_subblock</span><span class="p">,</span> <span class="n">QE_CR_PROTOCOL_ETHERNET</span><span class="p">,</span>
		     <span class="n">init_enet_pram_offset</span><span class="p">);</span>

	<span class="cm">/* Free InitEnet command parameter */</span>
	<span class="n">qe_muram_free</span><span class="p">(</span><span class="n">init_enet_pram_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is called by the kernel when a frame is ready for transmission. */</span>
<span class="cm">/* It is pointed to by the dev-&gt;hard_start_xmit function pointer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_UGETH_TX_ON_DEMAND</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>			<span class="cm">/* BD pointer */</span>
	<span class="n">u32</span> <span class="n">bd_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Start from the next BD that should be filled */</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">txBd</span><span class="p">[</span><span class="n">txQ</span><span class="p">];</span>
	<span class="n">bd_status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="cm">/* Save the skb pointer so we can free it later */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">txQ</span><span class="p">][</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_curtx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Update the current skb pointer (wrapping if this was the last) */</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_curtx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_curtx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span> <span class="o">+</span>
	     <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]);</span>

	<span class="cm">/* set up the buffer descriptor */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		      <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">));</span>

	<span class="cm">/* printk(KERN_DEBUG&quot;skb-&gt;data is 0x%x\n&quot;,skb-&gt;data); */</span>

	<span class="n">bd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">)</span> <span class="o">|</span> <span class="n">T_R</span> <span class="o">|</span> <span class="n">T_I</span> <span class="o">|</span> <span class="n">T_L</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* set bd status and length */</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">bd_status</span><span class="p">);</span>

	<span class="cm">/* Move to next BD in the ring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">))</span>
		<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">txQ</span><span class="p">];</span>

	<span class="cm">/* If the next BD still needs to be cleaned up, then the bds</span>
<span class="cm">	   are full.  We need to tell the kernel to stop sending us stuff. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span> <span class="o">==</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">confBd</span><span class="p">[</span><span class="n">txQ</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">txBd</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_scheduler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">cpucount</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Indicate to QE that there are more Tx bds ready for</span>
<span class="cm">		transmission */</span>
		<span class="cm">/* This is done by writing a running counter of the bd</span>
<span class="cm">		count to the scheduler PRAM. */</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_cpucount</span><span class="p">[</span><span class="n">txQ</span><span class="p">],</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">cpucount</span><span class="p">[</span><span class="n">txQ</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_UGETH_TX_ON_DEMAND</span>
	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_utodr</span><span class="p">,</span> <span class="n">UCC_FAST_TOD</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxQ</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_work_limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">howmany</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bd_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bdBuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="cm">/* collect received buffers */</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rxBd</span><span class="p">[</span><span class="n">rxQ</span><span class="p">];</span>

	<span class="n">bd_status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>

	<span class="cm">/* while there are received buffers and BD is full (~R_E) */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">R_E</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">--</span><span class="n">rx_work_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bdBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">rxQ</span><span class="p">][</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_currx</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]];</span>

		<span class="cm">/* determine whether buffer is first, last, first and last</span>
<span class="cm">		(single buffer frame) or middle (not first and not last) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">R_F</span> <span class="o">|</span> <span class="n">R_L</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">R_ERRORS_FATAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s, %d: ERROR!!! skb - 0x%08x&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="n">NET_SKB_PAD</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">rxQ</span><span class="p">][</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_currx</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">howmany</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Prep the skb for the packet */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

			<span class="cm">/* Tell the skb what kind of packet this is */</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="cm">/* Send the packet up the stack */</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">get_new_skb</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
				<span class="n">ugeth_warn</span><span class="p">(</span><span class="s">&quot;%s: No Rx Data Buffer&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">rxQ</span><span class="p">][</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_currx</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* update to point at the next skb */</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_currx</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_currx</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]</span> <span class="o">+</span>
		     <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_RING_MOD_MASK</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenRx</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_rx_bd_ring</span><span class="p">[</span><span class="n">rxQ</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>

		<span class="n">bd_status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rxBd</span><span class="p">[</span><span class="n">rxQ</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">howmany</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txQ</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Start from the next BD that should be filled */</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>		<span class="cm">/* BD pointer */</span>
	<span class="n">u32</span> <span class="n">bd_status</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">confBd</span><span class="p">[</span><span class="n">txQ</span><span class="p">];</span>
	<span class="n">bd_status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>

	<span class="cm">/* Normal processing. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">T_R</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* BD contains already transmitted buffer.   */</span>
		<span class="cm">/* Handle the transmitted buffer and release */</span>
		<span class="cm">/* the BD to be used with the current frame  */</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">txQ</span><span class="p">][</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_dirtytx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RX_BD_RING_LEN</span> <span class="o">&amp;&amp;</span>
			     <span class="n">skb_recycle_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				    <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">max_rx_buf_length</span> <span class="o">+</span>
				    <span class="n">UCC_GETH_RX_DATA_BUF_ALIGNMENT</span><span class="p">))</span>
			<span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">txQ</span><span class="p">][</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_dirtytx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_dirtytx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">skb_dirtytx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span> <span class="o">+</span>
		     <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">bdRingLenTx</span><span class="p">[</span><span class="n">txQ</span><span class="p">]);</span>

		<span class="cm">/* We freed a buffer, so now we can restart transmission */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Advance the confirmation BD pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bd_status</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">))</span>
			<span class="n">bd</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">p_tx_bd_ring</span><span class="p">[</span><span class="n">txQ</span><span class="p">];</span>
		<span class="n">bd_status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">confBd</span><span class="p">[</span><span class="n">txQ</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ucc_geth_private</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">howmany</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>

	<span class="cm">/* Tx event processing */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesTx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ucc_geth_tx</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">howmany</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numQueuesRx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">howmany</span> <span class="o">+=</span> <span class="n">ucc_geth_rx</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">howmany</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">howmany</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">,</span> <span class="n">UCCE_RX_EVENTS</span> <span class="o">|</span> <span class="n">UCCE_TX_EVENTS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">howmany</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ucc_geth_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_fast_private</span> <span class="o">*</span><span class="n">uccf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u32</span> <span class="n">ucce</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u32</span> <span class="n">uccm</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">uccf</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">;</span>
	<span class="n">ug_info</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="p">;</span>

	<span class="cm">/* read and clear events */</span>
	<span class="n">ucce</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_ucce</span><span class="p">);</span>
	<span class="n">uccm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">);</span>
	<span class="n">ucce</span> <span class="o">&amp;=</span> <span class="n">uccm</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_ucce</span><span class="p">,</span> <span class="n">ucce</span><span class="p">);</span>

	<span class="cm">/* check for receive events that require processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucce</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UCCE_RX_EVENTS</span> <span class="o">|</span> <span class="n">UCCE_TX_EVENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">uccm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UCCE_RX_EVENTS</span> <span class="o">|</span> <span class="n">UCCE_TX_EVENTS</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">,</span> <span class="n">uccm</span><span class="p">);</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Errors and other events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucce</span> <span class="o">&amp;</span> <span class="n">UCCE_OTHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucce</span> <span class="o">&amp;</span> <span class="n">UCC_GETH_UCCE_BSY</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucce</span> <span class="o">&amp;</span> <span class="n">UCC_GETH_UCCE_TXE</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling &#39;interrupt&#39; - used by things like netconsole to send skbs</span>
<span class="cm"> * without having to re-enable interrupts. It&#39;s not called while</span>
<span class="cm"> * the interrupt routine is executing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">ucc_geth_irq_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NET_POLL_CONTROLLER */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If device is not running, we will set mac addr register</span>
<span class="cm">	 * when opening the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_mac_station_addr_regs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr1</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr2</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ucc_struct_init</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot configure internal struct, &quot;</span>
				  <span class="s">&quot;aborting.&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ucc_geth_startup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot configure net device, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adjust_enet_interface</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot configure net device, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*       Set MACSTNADDR1, MACSTNADDR2                */</span>
	<span class="cm">/* For more details see the hardware spec.           */</span>
	<span class="n">init_mac_station_addr_regs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr1</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">macstnaddr2</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ugeth_enable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot enable net device, aborting.&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">ucc_geth_stop</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when something needs to use the ethernet device */</span>
<span class="cm">/* Returns 0 for success. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Test station address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ENET_GROUP_ADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Multicast address used for station &quot;</span>
				  <span class="s">&quot;address - is this what you wanted?&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot initialize PHY, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ucc_geth_init_mac</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot initialize MAC, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">ucc_geth_irq_handler</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UCC Geth&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot get IRQ for net device, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phy_start</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">qe_alive_during_sleep</span><span class="p">()</span> <span class="o">||</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">wol_en</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">ucc_geth_stop</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Stops the kernel queue, and halts the controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">);</span>
	<span class="n">ucc_geth_stop</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reopen device. This will reset the MAC and PHY. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_timeout_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ugeth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ucc_geth_private</span><span class="p">,</span> <span class="n">timeout_work</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ugeth_dump_regs</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Must reset MAC *and* PHY. This is done by reopening</span>
<span class="cm">		 * the device.</span>
<span class="cm">		 */</span>
		<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ucc_geth_stop</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
		<span class="n">ucc_geth_init_mac</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
		<span class="cm">/* Must start PHY here */</span>
		<span class="n">phy_start</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
		<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_tx_schedule_all</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ucc_geth_timeout gets called when a packet has not been</span>
<span class="cm"> * transmitted after a set amount of time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ucc_geth_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the controller, otherwise we&#39;ll wakeup on any network</span>
<span class="cm">	 * activity.</span>
<span class="cm">	 */</span>
	<span class="n">ugeth_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">wol_en</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">,</span> <span class="n">UCC_GETH_UCCE_MPD</span><span class="p">);</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">,</span> <span class="n">MACCFG2_MPE</span><span class="p">);</span>
		<span class="n">ucc_fast_enable</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">wol_en</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy_stop</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qe_alive_during_sleep</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">wol_en</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ucc_fast_disable</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>
			<span class="n">clrbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_regs</span><span class="o">-&gt;</span><span class="n">maccfg2</span><span class="p">,</span> <span class="n">MACCFG2_MPE</span><span class="p">);</span>
			<span class="n">clrbits32</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">uccf</span><span class="o">-&gt;</span><span class="n">p_uccm</span><span class="p">,</span> <span class="n">UCC_GETH_UCCE_MPD</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ugeth_enable</span><span class="p">(</span><span class="n">ugeth</span><span class="p">,</span> <span class="n">COMM_DIR_RX_AND_TX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Full reinitialization is required if QE shuts down</span>
<span class="cm">		 * during sleep.</span>
<span class="cm">		 */</span>
		<span class="n">ucc_geth_memclean</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ucc_geth_init_mac</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot initialize MAC, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldlink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">oldduplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">phy_stop</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">phy_start</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define ucc_geth_suspend NULL</span>
<span class="cp">#define ucc_geth_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">phy_interface_t</span> <span class="nf">to_phy_interface</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phy_connection_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;mii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;gmii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_GMII</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;tbi&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_TBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;rmii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;rgmii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;rgmii-id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_RGMII_ID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;rgmii-txid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_RGMII_TXID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;rgmii-rxid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_RGMII_RXID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;rtbi&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">phy_connection_type</span><span class="p">,</span> <span class="s">&quot;sgmii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_SGMII</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ucc_geth_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ucc_geth_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ucc_geth_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ucc_geth_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ucc_geth_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ucc_geth_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ucc_geth_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">ucc_geth_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">ucc_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span><span class="o">*</span> <span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucc_geth_info</span> <span class="o">*</span><span class="n">ug_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ucc_num</span><span class="p">,</span> <span class="n">max_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sprop</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="n">phy_interface_t</span> <span class="n">phy_interface</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">enet_to_speed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SPEED_10</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">,</span>
		<span class="n">SPEED_100</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">,</span>
		<span class="n">SPEED_1000</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">phy_interface_t</span> <span class="n">enet_to_phy_interface</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">,</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">,</span>
		<span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">,</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">,</span>
		<span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">,</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">,</span>
		<span class="n">PHY_INTERFACE_MODE_GMII</span><span class="p">,</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">,</span>
		<span class="n">PHY_INTERFACE_MODE_TBI</span><span class="p">,</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span><span class="p">,</span>
		<span class="n">PHY_INTERFACE_MODE_SGMII</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">ugeth_vdbg</span><span class="p">(</span><span class="s">&quot;%s: IN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;device-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucc_num</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ucc_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ucc_num</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ug_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ugeth_info</span><span class="p">[</span><span class="n">ucc_num</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ug_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: [%d] Missing additional data!&quot;</span><span class="p">,</span>
				       	<span class="n">__func__</span><span class="p">,</span> <span class="n">ucc_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span> <span class="o">=</span> <span class="n">ucc_num</span><span class="p">;</span>

	<span class="n">sprop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx-clock-name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sprop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">rx_clock</span> <span class="o">=</span> <span class="n">qe_clock_source</span><span class="p">(</span><span class="n">sprop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">rx_clock</span> <span class="o">&lt;</span> <span class="n">QE_CLK_NONE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">rx_clock</span> <span class="o">&gt;</span> <span class="n">QE_CLK24</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;ucc_geth: invalid rx-clock-name property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx-clock&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If both rx-clock-name and rx-clock are missing,</span>
<span class="cm">			   we want to tell people to use rx-clock-name. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;ucc_geth: missing rx-clock-name property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">prop</span> <span class="o">&lt;</span> <span class="n">QE_CLK_NONE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">prop</span> <span class="o">&gt;</span> <span class="n">QE_CLK24</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;ucc_geth: invalid rx-clock propperty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">rx_clock</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx-clock-name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sprop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">tx_clock</span> <span class="o">=</span> <span class="n">qe_clock_source</span><span class="p">(</span><span class="n">sprop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">tx_clock</span> <span class="o">&lt;</span> <span class="n">QE_CLK_NONE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">tx_clock</span> <span class="o">&gt;</span> <span class="n">QE_CLK24</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;ucc_geth: invalid tx-clock-name property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx-clock&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;ucc_geth: missing tx-clock-name property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">prop</span> <span class="o">&lt;</span> <span class="n">QE_CLK_NONE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">prop</span> <span class="o">&gt;</span> <span class="n">QE_CLK24</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;ucc_geth: invalid tx-clock property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">tx_clock</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">phy_node</span> <span class="o">=</span> <span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;phy-handle&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Find the TBI PHY node.  If it&#39;s not there, we don&#39;t support SGMII */</span>
	<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">tbi_node</span> <span class="o">=</span> <span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tbi-handle&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* get the phy interface type, or default to MII */</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;phy-connection-type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* handle interface property present in old trees */</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">,</span> <span class="s">&quot;interface&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_interface</span> <span class="o">=</span> <span class="n">enet_to_phy_interface</span><span class="p">[</span><span class="o">*</span><span class="n">prop</span><span class="p">];</span>
			<span class="n">max_speed</span> <span class="o">=</span> <span class="n">enet_to_speed</span><span class="p">[</span><span class="o">*</span><span class="n">prop</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">phy_interface</span> <span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy_interface</span> <span class="o">=</span> <span class="n">to_phy_interface</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">prop</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get speed, or derive from PHY interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy_interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_GMII</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_RGMII_ID</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_RGMII_RXID</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_RGMII_TXID</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_TBI</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_RTBI</span>:
		<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_SGMII</span>:
			<span class="n">max_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">max_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snums</span> <span class="o">=</span> <span class="n">qe_get_num_of_snums</span><span class="p">();</span>

		<span class="cm">/* configure muram FIFOs for gigabit operation */</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">urfs</span> <span class="o">=</span> <span class="n">UCC_GETH_URFS_GIGA_INIT</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">urfet</span> <span class="o">=</span> <span class="n">UCC_GETH_URFET_GIGA_INIT</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">urfset</span> <span class="o">=</span> <span class="n">UCC_GETH_URFSET_GIGA_INIT</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">utfs</span> <span class="o">=</span> <span class="n">UCC_GETH_UTFS_GIGA_INIT</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">utfet</span> <span class="o">=</span> <span class="n">UCC_GETH_UTFET_GIGA_INIT</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">utftt</span> <span class="o">=</span> <span class="n">UCC_GETH_UTFTT_GIGA_INIT</span><span class="p">;</span>
		<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsTx</span> <span class="o">=</span> <span class="n">UCC_GETH_NUM_OF_THREADS_4</span><span class="p">;</span>

		<span class="cm">/* If QE&#39;s snum number is 46/76 which means we need to support</span>
<span class="cm">		 * 4 UECs at 1000Base-T simultaneously, we need to allocate</span>
<span class="cm">		 * more Threads to Rx.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snums</span> <span class="o">==</span> <span class="mi">76</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">snums</span> <span class="o">==</span> <span class="mi">46</span><span class="p">))</span>
			<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsRx</span> <span class="o">=</span> <span class="n">UCC_GETH_NUM_OF_THREADS_6</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">numThreadsRx</span> <span class="o">=</span> <span class="n">UCC_GETH_NUM_OF_THREADS_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ucc_geth: UCC%1d at 0x%8x (irq = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">ucc_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">regs</span><span class="p">,</span>
			<span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Create an ethernet device instance */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ugeth</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Create CQs for hash tables */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">group_hash_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ind_hash_q</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Set the dev-&gt;base_addr to the gfar reg region */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">ug_info</span><span class="o">-&gt;</span><span class="n">uf_info</span><span class="p">.</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="cm">/* Fill in the dev structure */</span>
	<span class="n">uec_set_ethtool_ops</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ucc_geth_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">,</span> <span class="n">ucc_geth_timeout_work</span><span class="p">);</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">ucc_geth_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="n">UGETH_MSG_DEFAULT</span><span class="p">);</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">phy_interface</span> <span class="o">=</span> <span class="n">phy_interface</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">max_speed</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">ugeth</span><span class="p">))</span>
			<span class="n">ugeth_err</span><span class="p">(</span><span class="s">&quot;%s: Cannot register net device, aborting.&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">of_get_mac_address</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ug_info</span> <span class="o">=</span> <span class="n">ug_info</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ugeth</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ucc_geth_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span><span class="o">*</span> <span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ucc_geth_private</span> <span class="o">*</span><span class="n">ugeth</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ucc_geth_memclean</span><span class="p">(</span><span class="n">ugeth</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">ucc_geth_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ucc_geth&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">ucc_geth_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ucc_geth_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">ucc_geth_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ucc_geth_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ucc_geth_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ucc_geth_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ucc_geth_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ucc_geth_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ucc_geth: &quot;</span> <span class="n">DRV_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ugeth_info</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">ugeth_primary_info</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">ugeth_primary_info</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucc_geth_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ucc_geth_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucc_geth_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ucc_geth_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ucc_geth_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Freescale Semiconductor, Inc&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
