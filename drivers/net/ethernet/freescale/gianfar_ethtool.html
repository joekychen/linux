<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › freescale › gianfar_ethtool.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>gianfar_ethtool.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/net/ethernet/freescale/gianfar_ethtool.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Gianfar Ethernet Driver</span>
<span class="cm"> *  Ethtool support for Gianfar Enet</span>
<span class="cm"> *  Based on e1000 ethtool support</span>
<span class="cm"> *</span>
<span class="cm"> *  Author: Andy Fleming</span>
<span class="cm"> *  Maintainer: Kumar Gala</span>
<span class="cm"> *  Modifier: Sandeep Gopalpet &lt;sandeep.kumar@freescale.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2003-2006, 2008-2009, 2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  This software may be used and distributed according to</span>
<span class="cm"> *  the terms of the GNU Public License, Version 2, incorporated herein</span>
<span class="cm"> *  by reference.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/net_tstamp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &quot;gianfar.h&quot;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">gfar_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gfar_clean_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_priv_rx_q</span> <span class="o">*</span><span class="n">rx_queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_work_limit</span><span class="p">);</span>

<span class="cp">#define GFAR_MAX_COAL_USECS 0xffff</span>
<span class="cp">#define GFAR_MAX_COAL_FRAMES 0xff</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gfar_fill_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="o">*</span> <span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gfar_gstrings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gfar_gcoalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">cvals</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gfar_scoalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">cvals</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gfar_gringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">rvals</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gfar_sringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">rvals</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gfar_gdrvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">stat_gstrings</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;rx-dropped-by-kernel&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-large-frame-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-short-frame-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-non-octet-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-crc-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-overrun-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-busy-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-babbling-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-truncated-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;ethernet-bus-error&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-babbling-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-underrun-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-skb-missing-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-timeout-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-64-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-65-127-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-128-255-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-256-511-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-512-1023-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-1024-1518-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-rx-1519-1522-good-vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-bytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-fcs-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;receive-multicast-packet&quot;</span><span class="p">,</span>
	<span class="s">&quot;receive-broadcast-packet&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-control-frame-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-pause-frame-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-unknown-op-code&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-alignment-error&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-frame-length-error&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-code-error&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-carrier-sense-error&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-undersize-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-oversize-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-fragmented-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-jabber-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx-dropped-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-byte-counter&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-multicast-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-broadcast-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-pause-control-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-deferral-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-excessive-deferral-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-single-collision-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-multiple-collision-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-late-collision-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-excessive-collision-packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-total-collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-dropped-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-jabber-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-fcs-errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-control-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-oversize-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-undersize-frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx-fragmented-frames&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Fill in a buffer with the strings which correspond to the</span>
<span class="cm"> * stats */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_gstrings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_RMON</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">stat_gstrings</span><span class="p">,</span> <span class="n">GFAR_STATS_LEN</span> <span class="o">*</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">stat_gstrings</span><span class="p">,</span>
				<span class="n">GFAR_EXTRA_STATS_LEN</span> <span class="o">*</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fill in an array of 64-bit statistics from various sources.</span>
<span class="cm"> * This array will be appended to the end of the ethtool_stats</span>
<span class="cm"> * structure, and returned to user space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_fill_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfar</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gfargrp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">extra_stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_RMON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rmon</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rmon</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gfar_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfar_stats</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GFAR_RMON_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">gfar_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmon</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GFAR_EXTRA_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GFAR_EXTRA_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_RMON</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">GFAR_STATS_LEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">GFAR_EXTRA_STATS_LEN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Fills in the drvinfo structure with some basic info */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_gdrvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span>
	      <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">GFAR_INFOSTR_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">gfar_driver_version</span><span class="p">,</span> <span class="n">GFAR_INFOSTR_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">GFAR_INFOSTR_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">GFAR_INFOSTR_LEN</span><span class="p">);</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_ssettings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Return the current settings in the ethtool_cmd structure */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_gsettings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_priv_rx_q</span> <span class="o">*</span><span class="n">rx_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_priv_tx_q</span> <span class="o">*</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">tx_queue</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rx_queue</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* etsec-1.7 and older versions have only one txic</span>
<span class="cm">	 * and rxic regs although they support multiple queues */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="n">get_icft_value</span><span class="p">(</span><span class="n">tx_queue</span><span class="o">-&gt;</span><span class="n">txic</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="n">get_icft_value</span><span class="p">(</span><span class="n">rx_queue</span><span class="o">-&gt;</span><span class="n">rxic</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return the length of the register structure */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_reglen</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfar</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return a dump of the GFAR register space */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">regbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">theregs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gfargrp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">regbuf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfar</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfar_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">theregs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Convert microseconds to ethernet clock ticks, which changes</span>
<span class="cm"> * depending on what speed the controller is running at */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gfar_usecs2ticks</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* The timer is different, depending on the interface speed */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">GFAR_GBIT_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">GFAR_100_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
	<span class="nl">default:</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">GFAR_10_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we return a number greater than 0</span>
<span class="cm">	 * if usecs &gt; 0 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">usecs</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert ethernet clock ticks to microseconds */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gfar_ticks2usecs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* The timer is different, depending on the interface speed */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">GFAR_GBIT_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">GFAR_100_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
	<span class="nl">default:</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">GFAR_10_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we return a number greater than 0 */</span>
	<span class="cm">/* if ticks is &gt; 0 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the coalescing parameters, and put them in the cvals</span>
<span class="cm"> * structure.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_gcoalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">cvals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfar_priv_rx_q</span> <span class="o">*</span><span class="n">rx_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_priv_tx_q</span> <span class="o">*</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rxtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rxcount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_COALESCE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rx_queue</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">tx_queue</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">rxtime</span>  <span class="o">=</span> <span class="n">get_ictt_value</span><span class="p">(</span><span class="n">rx_queue</span><span class="o">-&gt;</span><span class="n">rxic</span><span class="p">);</span>
	<span class="n">rxcount</span> <span class="o">=</span> <span class="n">get_icft_value</span><span class="p">(</span><span class="n">rx_queue</span><span class="o">-&gt;</span><span class="n">rxic</span><span class="p">);</span>
	<span class="n">txtime</span>  <span class="o">=</span> <span class="n">get_ictt_value</span><span class="p">(</span><span class="n">tx_queue</span><span class="o">-&gt;</span><span class="n">txic</span><span class="p">);</span>
	<span class="n">txcount</span> <span class="o">=</span> <span class="n">get_icft_value</span><span class="p">(</span><span class="n">tx_queue</span><span class="o">-&gt;</span><span class="n">txic</span><span class="p">);</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">gfar_ticks2usecs</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxtime</span><span class="p">);</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">rxcount</span><span class="p">;</span>

	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">gfar_ticks2usecs</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">txtime</span><span class="p">);</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">txcount</span><span class="p">;</span>

	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">use_adaptive_tx_coalesce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">pkt_rate_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* When the packet rate is below pkt_rate_high but above</span>
<span class="cm">	 * pkt_rate_low (both measured in packets per second) the</span>
<span class="cm">	 * normal {rx,tx}_* coalescing parameters are used.</span>
<span class="cm">	 */</span>

	<span class="cm">/* When the packet rate is (measured in packets per second)</span>
<span class="cm">	 * is above pkt_rate_high, the {rx,tx}_*_high parameters are</span>
<span class="cm">	 * used.</span>
<span class="cm">	 */</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">pkt_rate_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* How often to do adaptive coalescing packet rate sampling,</span>
<span class="cm">	 * measured in seconds.  Must not be zero.</span>
<span class="cm">	 */</span>
	<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rate_sample_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change the coalescing values.</span>
<span class="cm"> * Both cvals-&gt;*_usecs and cvals-&gt;*_frames have to be &gt; 0</span>
<span class="cm"> * in order for coalescing to be active</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_scoalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">cvals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_COALESCE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* Set up rx coalescing */</span>
	<span class="cm">/* As of now, we will enable/disable coalescing for all</span>
<span class="cm">	 * queues together in case of eTSEC2, this will be modified</span>
<span class="cm">	 * along with the ethtool interface */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxcoalescing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxcoalescing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Check the bounds of the values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">GFAR_MAX_COAL_USECS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Coalescing is limited to %d microseconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GFAR_MAX_COAL_USECS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">&gt;</span> <span class="n">GFAR_MAX_COAL_FRAMES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Coalescing is limited to %d frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GFAR_MAX_COAL_FRAMES</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxic</span> <span class="o">=</span> <span class="n">mk_ic_value</span><span class="p">(</span>
			<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">,</span>
			<span class="n">gfar_usecs2ticks</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cvals</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Set up tx coalescing */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">txcoalescing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">txcoalescing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the bounds of the values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">GFAR_MAX_COAL_USECS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Coalescing is limited to %d microseconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GFAR_MAX_COAL_USECS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">&gt;</span> <span class="n">GFAR_MAX_COAL_FRAMES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Coalescing is limited to %d frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GFAR_MAX_COAL_FRAMES</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">txic</span> <span class="o">=</span> <span class="n">mk_ic_value</span><span class="p">(</span>
			<span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span><span class="p">,</span>
			<span class="n">gfar_usecs2ticks</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cvals</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">gfar_configure_coalescing</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fills in rvals with the current ring parameters.  Currently,</span>
<span class="cm"> * rx, rx_mini, and rx_jumbo rings are the same size, as mini and</span>
<span class="cm"> * jumbo are ignored by the driver */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_gringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">rvals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfar_priv_tx_q</span> <span class="o">*</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_priv_rx_q</span> <span class="o">*</span><span class="n">rx_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tx_queue</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rx_queue</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">GFAR_RX_MAX_RING_SIZE</span><span class="p">;</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_mini_max_pending</span> <span class="o">=</span> <span class="n">GFAR_RX_MAX_RING_SIZE</span><span class="p">;</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="n">GFAR_RX_MAX_RING_SIZE</span><span class="p">;</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">GFAR_TX_MAX_RING_SIZE</span><span class="p">;</span>

	<span class="cm">/* Values changeable by the user.  The valid values are</span>
<span class="cm">	 * in the range 1 to the &quot;*_max_pending&quot; counterpart above.</span>
<span class="cm">	 */</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">rx_queue</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">=</span> <span class="n">rx_queue</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">rx_queue</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="n">rvals</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">tx_queue</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change the current ring parameters, stopping the controller if</span>
<span class="cm"> * necessary so that we don&#39;t mess things up while we&#39;re in</span>
<span class="cm"> * motion.  We wait for the ring to be clean before reallocating</span>
<span class="cm"> * the rings. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_sringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">rvals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">GFAR_RX_MAX_RING_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ring sizes must be a power of 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rvals</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">GFAR_TX_MAX_RING_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">rvals</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ring sizes must be a power of 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="cm">/* Halt TX and RX, and process the frames which</span>
<span class="cm">		 * have already been received */</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">lock_tx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">lock_rx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="n">gfar_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unlock_rx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">unlock_tx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gfar_clean_rx_ring</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>

		<span class="cm">/* Now we take down the rings to rebuild them */</span>
		<span class="n">stop_gfar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Change the size */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">rvals</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">rvals</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">num_txbdfree</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Rebuild the rings with the new size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">startup_gfar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfar_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="o">|</span><span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span>
		<span class="n">gfar_vlan_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Halt TX and RX, and process the frames which</span>
<span class="cm">		 * have already been received */</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">lock_tx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">lock_rx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="n">gfar_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unlock_tx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">unlock_rx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gfar_clean_rx_ring</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>

		<span class="cm">/* Now we take down the rings to rebuild them */</span>
		<span class="n">stop_gfar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">startup_gfar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">gfar_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_MAGIC_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_en</span> <span class="o">?</span> <span class="n">WAKE_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_MAGIC_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_en</span> <span class="o">=</span>  <span class="o">!!</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ethflow_to_filer_rules</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ethflow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fcr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">fpr</span> <span class="o">=</span> <span class="n">FPR_FILER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L2DA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_DAH</span> <span class="o">|</span><span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span>
			<span class="n">RQFCR_HASH</span> <span class="o">|</span> <span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_DAL</span> <span class="o">|</span> <span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span>
				<span class="n">RQFCR_HASH</span> <span class="o">|</span> <span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_VID</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span> <span class="n">RQFCR_HASH</span> <span class="o">|</span>
				<span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_IP_SRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_SIA</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span> <span class="n">RQFCR_HASH</span> <span class="o">|</span>
			<span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXH_IP_DST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_DIA</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span> <span class="n">RQFCR_HASH</span> <span class="o">|</span>
			<span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L3_PROTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_L4P</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span> <span class="n">RQFCR_HASH</span> <span class="o">|</span>
			<span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L4_B_0_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_SPT</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span> <span class="n">RQFCR_HASH</span> <span class="o">|</span>
			<span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L4_B_2_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">RQFCR_PID_DPT</span> <span class="o">|</span> <span class="n">RQFCR_CMP_NOMATCH</span> <span class="o">|</span> <span class="n">RQFCR_HASH</span> <span class="o">|</span>
			<span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_HASHTBL_0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span> <span class="n">fcr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_ethflow_to_filer_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ethflow</span><span class="p">,</span> <span class="n">u64</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_rule_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmp_rqfpr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">local_rqfpr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">local_rqfcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">MAX_FILER_IDX</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">local_rqfpr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX_FILER_IDX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">local_rqfcr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX_FILER_IDX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_rqfpr</span> <span class="o">||</span> <span class="o">!</span><span class="n">local_rqfcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
		<span class="n">cmp_rqfpr</span> <span class="o">=</span> <span class="n">RQFPR_IPV4</span> <span class="o">|</span><span class="n">RQFPR_TCP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
		<span class="n">cmp_rqfpr</span> <span class="o">=</span> <span class="n">RQFPR_IPV4</span> <span class="o">|</span><span class="n">RQFPR_UDP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_V6_FLOW</span>:
		<span class="n">cmp_rqfpr</span> <span class="o">=</span> <span class="n">RQFPR_IPV6</span> <span class="o">|</span><span class="n">RQFPR_TCP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_V6_FLOW</span>:
		<span class="n">cmp_rqfpr</span> <span class="o">=</span> <span class="n">RQFPR_IPV6</span> <span class="o">|</span><span class="n">RQFPR_UDP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Right now this class is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_IDX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_rqfpr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">local_rqfcr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">j</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">RQFCR_PID_PARSE</span> <span class="o">|</span>
			<span class="n">RQFCR_CLE</span> <span class="o">|</span><span class="n">RQFCR_AND</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cmp_rqfpr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_FILER_IDX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No parse rule found, can&#39;t create hash rules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If a match was found, then it begins the starting of a cluster rule</span>
<span class="cm">	 * if it was already programmed, we need to overwrite these rules</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_IDX</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RQFCR_CLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RQFCR_AND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">RQFCR_CLE</span> <span class="o">|</span> <span class="n">RQFCR_CMP_EXACT</span> <span class="o">|</span>
				<span class="n">RQFCR_HASHTBL_0</span> <span class="o">|</span> <span class="n">RQFCR_PID_MASK</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPR_FILER_MASK</span><span class="p">;</span>
			<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">],</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">l</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RQFCR_CLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RQFCR_AND</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">local_rqfpr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
			<span class="n">local_rqfcr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
			<span class="n">j</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">last_rule_idx</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* hash rules */</span>
	<span class="n">ethflow_to_filer_rules</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ethflow</span><span class="p">);</span>

	<span class="cm">/* Write back the popped out rules again */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_IDX</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfpr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_rqfpr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ftp_rqfcr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_rqfcr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">,</span>
				<span class="n">local_rqfcr</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">local_rqfpr</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_filer_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">local_rqfcr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">local_rqfpr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_set_hash_opts</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* write the filer rules here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfar_ethflow_to_filer_table</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_check_filer_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gfargrp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regs</span><span class="p">;</span>

	<span class="cm">/* Check if we are in FIFO mode */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">gfar_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ecntrl</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="n">ECNTRL_FIFM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ECNTRL_FIFM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Interface in FIFO mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">gfar_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rctrl</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">&amp;=</span> <span class="n">RCTRL_PRSDEP_MASK</span> <span class="o">|</span> <span class="n">RCTRL_PRSFM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">RCTRL_PRSDEP_MASK</span> <span class="o">|</span> <span class="n">RCTRL_PRSFM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;Receive Queue Filtering enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;Receive Queue Filtering disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Or in standard mode */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">gfar_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rctrl</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">&amp;=</span> <span class="n">RCTRL_PRSDEP_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RCTRL_PRSDEP_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;Receive Queue Filtering enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;Receive Queue Filtering disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Sets the properties for arbitrary filer rule</span>
<span class="cm">	 * to the first 4 Layer 4 Bytes */</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">rbifx</span> <span class="o">=</span> <span class="mh">0xC0C1C2C3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_comp_asc</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_comp_desc</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_swap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">_b</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">swap</span><span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">swap</span><span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">swap</span><span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">swap</span><span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Write a mask to filer cache */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_mask</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_PID_MASK</span> <span class="o">|</span> <span class="n">RQFCR_CMP_EXACT</span><span class="p">;</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets parse bits (e.g. IP or TCP) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_parse_bits</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfar_set_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">RQFCR_CMP_EXACT</span> <span class="o">|</span> <span class="n">RQFCR_PID_PARSE</span>
			<span class="o">|</span> <span class="n">RQFCR_AND</span><span class="p">;</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_general_attribute</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfar_set_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">RQFCR_CMP_EXACT</span> <span class="o">|</span> <span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For setting a tuple of value and mask of type flag</span>
<span class="cm"> * Example:</span>
<span class="cm"> * IP-Src = 10.0.0.0/255.0.0.0</span>
<span class="cm"> * value: 0x0A000000 mask: FF000000 flag: RQFPR_IPV4</span>
<span class="cm"> *</span>
<span class="cm"> * Ethtool gives us a value=0 and mask=~0 for don&#39;t care a tuple</span>
<span class="cm"> * For a don&#39;t care mask it gives us a 0</span>
<span class="cm"> *</span>
<span class="cm"> * The check if don&#39;t care and the mask adjustment if mask=0 is done for VLAN</span>
<span class="cm"> * and MAC stuff on an upper level (due to missing information on this level).</span>
<span class="cm"> * For these guys we can discard them if they are value=0 and mask=0.</span>
<span class="cm"> *</span>
<span class="cm"> * Further the all masks are one-padded for better hardware efficiency.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_attribute</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 3bit */</span>
	<span class="k">case</span> <span class="n">RQFCR_PID_PRI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">|</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">RQFCR_PID_PRI_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* 8bit */</span>
	<span class="k">case</span> <span class="n">RQFCR_PID_L4P</span>:
	<span class="k">case</span> <span class="n">RQFCR_PID_TOS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!~</span><span class="p">(</span><span class="n">mask</span> <span class="o">|</span> <span class="n">RQFCR_PID_L4P_MASK</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">RQFCR_PID_L4P_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* 12bit */</span>
	<span class="k">case</span> <span class="n">RQFCR_PID_VID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">|</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">RQFCR_PID_VID_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* 16bit */</span>
	<span class="k">case</span> <span class="n">RQFCR_PID_DPT</span>:
	<span class="k">case</span> <span class="n">RQFCR_PID_SPT</span>:
	<span class="k">case</span> <span class="n">RQFCR_PID_ETY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!~</span><span class="p">(</span><span class="n">mask</span> <span class="o">|</span> <span class="n">RQFCR_PID_PORT_MASK</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">RQFCR_PID_PORT_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* 24bit */</span>
	<span class="k">case</span> <span class="n">RQFCR_PID_DAH</span>:
	<span class="k">case</span> <span class="n">RQFCR_PID_DAL</span>:
	<span class="k">case</span> <span class="n">RQFCR_PID_SAH</span>:
	<span class="k">case</span> <span class="n">RQFCR_PID_SAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">|</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">RQFCR_PID_MAC_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* for all real 32bit masks */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!~</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gfar_set_general_attribute</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Translates value and mask for UDP, TCP or SCTP */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_basic_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_tcpip4_spec</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_tcpip4_spec</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">ip4src</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">ip4src</span><span class="p">,</span> <span class="n">RQFCR_PID_SIA</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">ip4dst</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">ip4dst</span><span class="p">,</span> <span class="n">RQFCR_PID_DIA</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">pdst</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">pdst</span><span class="p">,</span> <span class="n">RQFCR_PID_DPT</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">psrc</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">psrc</span><span class="p">,</span> <span class="n">RQFCR_PID_SPT</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">,</span> <span class="n">RQFCR_PID_TOS</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Translates value and mask for RAW-IP4 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_user_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_usrip4_spec</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_usrip4_spec</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">ip4src</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">ip4src</span><span class="p">,</span> <span class="n">RQFCR_PID_SIA</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">ip4dst</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">ip4dst</span><span class="p">,</span> <span class="n">RQFCR_PID_DIA</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">,</span> <span class="n">RQFCR_PID_TOS</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">RQFCR_PID_L4P</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">l4_4_bytes</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">l4_4_bytes</span><span class="p">,</span> <span class="n">RQFCR_PID_ARB</span><span class="p">,</span>
			<span class="n">tab</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Translates value and mask for ETHER spec */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_set_ether</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">upper_temp_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lower_temp_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Source address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">upper_temp_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
			<span class="n">lower_temp_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">upper_temp_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
					<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
					<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">lower_temp_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
					<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
					<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="cm">/* Upper 24bit */</span>
		<span class="n">gfar_set_attribute</span><span class="p">(</span>
				<span class="n">value</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
						<span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">upper_temp_mask</span><span class="p">,</span> <span class="n">RQFCR_PID_SAH</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="cm">/* And the same for the lower part */</span>
		<span class="n">gfar_set_attribute</span><span class="p">(</span>
				<span class="n">value</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
						<span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				<span class="n">lower_temp_mask</span><span class="p">,</span> <span class="n">RQFCR_PID_SAL</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Destination address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Special for destination is limited broadcast */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">gfar_set_parse_bits</span><span class="p">(</span><span class="n">RQFPR_EBC</span><span class="p">,</span> <span class="n">RQFPR_EBC</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">upper_temp_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">lower_temp_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">upper_temp_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
						<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
						<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">lower_temp_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
						<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
						<span class="o">|</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="cm">/* Upper 24bit */</span>
			<span class="n">gfar_set_attribute</span><span class="p">(</span>
					<span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
							<span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
							<span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					<span class="n">upper_temp_mask</span><span class="p">,</span> <span class="n">RQFCR_PID_DAH</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
			<span class="cm">/* And the same for the lower part */</span>
			<span class="n">gfar_set_attribute</span><span class="p">(</span>
					<span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
							<span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
							<span class="o">|</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
					<span class="n">lower_temp_mask</span><span class="p">,</span> <span class="n">RQFCR_PID_DAL</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">,</span> <span class="n">RQFCR_PID_ETY</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Convert a rule to binary filter format of gianfar */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_convert_to_filer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">rule</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vlan_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cfi_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prio_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">old_index</span> <span class="o">=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Check if vlan is wanted */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">&amp;</span> <span class="n">FLOW_EXT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span><span class="p">)</span>
			<span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

		<span class="n">vlan</span> <span class="o">=</span> <span class="n">RQFPR_VLN</span><span class="p">;</span>
		<span class="n">vlan_mask</span> <span class="o">=</span> <span class="n">RQFPR_VLN</span><span class="p">;</span>

		<span class="cm">/* Separate the fields */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">;</span>
		<span class="n">id_mask</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">;</span>
		<span class="n">cfi</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_CFI_MASK</span><span class="p">;</span>
		<span class="n">cfi_mask</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_CFI_MASK</span><span class="p">;</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_PRIO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">;</span>
		<span class="n">prio_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_PRIO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cfi</span> <span class="o">==</span> <span class="n">VLAN_TAG_PRESENT</span> <span class="o">&amp;&amp;</span> <span class="n">cfi_mask</span> <span class="o">==</span> <span class="n">VLAN_TAG_PRESENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vlan</span> <span class="o">|=</span> <span class="n">RQFPR_CFI</span><span class="p">;</span>
			<span class="n">vlan_mask</span> <span class="o">|=</span> <span class="n">RQFPR_CFI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfi</span> <span class="o">!=</span> <span class="n">VLAN_TAG_PRESENT</span> <span class="o">&amp;&amp;</span> <span class="n">cfi_mask</span> <span class="o">==</span> <span class="n">VLAN_TAG_PRESENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vlan_mask</span> <span class="o">|=</span> <span class="n">RQFPR_CFI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FLOW_EXT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
		<span class="n">gfar_set_parse_bits</span><span class="p">(</span><span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">RQFPR_TCP</span> <span class="o">|</span> <span class="n">vlan</span><span class="p">,</span>
				<span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">RQFPR_TCP</span> <span class="o">|</span> <span class="n">vlan_mask</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_basic_ip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
		<span class="n">gfar_set_parse_bits</span><span class="p">(</span><span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">RQFPR_UDP</span> <span class="o">|</span> <span class="n">vlan</span><span class="p">,</span>
				<span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">RQFPR_UDP</span> <span class="o">|</span> <span class="n">vlan_mask</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_basic_ip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">udp_ip4_spec</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">udp_ip4_spec</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
		<span class="n">gfar_set_parse_bits</span><span class="p">(</span><span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">vlan_mask</span><span class="p">,</span>
				<span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RQFCR_PID_L4P</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_basic_ip</span><span class="p">((</span><span class="k">struct</span> <span class="n">ethtool_tcpip4_spec</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_tcpip4_spec</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IP_USER_FLOW</span>:
		<span class="n">gfar_set_parse_bits</span><span class="p">(</span><span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">RQFPR_IPV4</span> <span class="o">|</span> <span class="n">vlan_mask</span><span class="p">,</span>
				<span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_user_ip</span><span class="p">((</span><span class="k">struct</span> <span class="n">ethtool_usrip4_spec</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_usrip4_spec</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHER_FLOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan</span><span class="p">)</span>
			<span class="n">gfar_set_parse_bits</span><span class="p">(</span><span class="n">vlan</span><span class="p">,</span> <span class="n">vlan_mask</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_ether</span><span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the vlan attributes in the end */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">id_mask</span><span class="p">,</span> <span class="n">RQFCR_PID_VID</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="n">gfar_set_attribute</span><span class="p">(</span><span class="n">prio</span><span class="p">,</span> <span class="n">prio_mask</span><span class="p">,</span> <span class="n">RQFCR_PID_PRI</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If there has been nothing written till now, it must be a default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">old_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfar_set_mask</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remove last AND */</span>
	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">RQFCR_AND</span><span class="p">);</span>

	<span class="cm">/* Specify which queue to use or to drop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">==</span> <span class="n">RX_CLS_FLOW_DISC</span><span class="p">)</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">RQFCR_RJE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Only big enough entries can be clustered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">old_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">old_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">RQFCR_CLE</span><span class="p">;</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">RQFCR_CLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In rare cases the cache can be full while there is free space in hw */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">MAX_FILER_CACHE_IDX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Copy size filer entries */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_copy_filer_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_filer_entry</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="k">struct</span> <span class="n">gfar_filer_entry</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">size</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">size</span><span class="p">].</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">size</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">size</span><span class="p">].</span><span class="n">prop</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Delete the contents of the filer-table between start and end</span>
<span class="cm"> * and collapse them */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_trim_filer_entries</span><span class="p">(</span><span class="n">u32</span> <span class="n">begin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">MAX_FILER_CACHE_IDX</span> <span class="o">||</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">begin</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">end</span><span class="o">++</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">;</span>

	<span class="cm">/* Copy */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">begin</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">end</span><span class="p">].</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">begin</span><span class="o">++</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">end</span><span class="o">++</span><span class="p">].</span><span class="n">prop</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* Fill up with don&#39;t cares */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">begin</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">begin</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">begin</span><span class="p">].</span><span class="n">prop</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">begin</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Make space on the wanted location */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_expand_filer_entries</span><span class="p">(</span><span class="n">u32</span> <span class="n">begin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">length</span> <span class="o">+</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">MAX_FILER_CACHE_IDX</span> <span class="o">||</span> <span class="n">begin</span>
			<span class="o">&gt;</span> <span class="n">MAX_FILER_CACHE_IDX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gfar_copy_filer_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">begin</span> <span class="o">+</span> <span class="n">length</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">begin</span><span class="p">]),</span>
			<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_get_next_cluster_start</span><span class="p">(</span><span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_CACHE_IDX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">start</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_CLE</span><span class="p">))</span>
				<span class="o">==</span> <span class="p">(</span><span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_CLE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_get_next_cluster_end</span><span class="p">(</span><span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_CACHE_IDX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">start</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RQFCR_AND</span> <span class="o">|</span> <span class="n">RQFCR_CLE</span><span class="p">))</span>
				<span class="o">==</span> <span class="p">(</span><span class="n">RQFCR_CLE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Uses hardwares clustering option to reduce</span>
<span class="cm"> * the number of filer table entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_cluster_filer</span><span class="p">(</span><span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">iend</span><span class="p">,</span> <span class="n">jend</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">gfar_get_next_cluster_start</span><span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">tab</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">gfar_get_next_cluster_start</span><span class="p">(</span><span class="o">++</span><span class="n">j</span><span class="p">,</span> <span class="n">tab</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The cluster entries self and the previous one</span>
<span class="cm">			 * (a mask) must be identical!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ctrl</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prop</span> <span class="o">!=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prop</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">prop</span> <span class="o">!=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">prop</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">iend</span> <span class="o">=</span> <span class="n">gfar_get_next_cluster_end</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
			<span class="n">jend</span> <span class="o">=</span> <span class="n">gfar_get_next_cluster_end</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">jend</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">iend</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * First we make some free space, where our cluster</span>
<span class="cm">			 * element should be. Then we copy it there and finally</span>
<span class="cm">			 * delete in from its old location.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gfar_expand_filer_entries</span><span class="p">(</span><span class="n">iend</span><span class="p">,</span> <span class="p">(</span><span class="n">jend</span> <span class="o">-</span> <span class="n">j</span><span class="p">),</span> <span class="n">tab</span><span class="p">)</span>
					<span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">gfar_copy_filer_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">iend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">jend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">jend</span> <span class="o">-</span> <span class="n">j</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gfar_trim_filer_entries</span><span class="p">(</span><span class="n">jend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">jend</span> <span class="o">+</span> <span class="p">(</span><span class="n">jend</span> <span class="o">-</span> <span class="n">j</span><span class="p">),</span> <span class="n">tab</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="cm">/* Mask out cluster bit */</span>
			<span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">iend</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RQFCR_CLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Swaps the masked bits of a1&lt;&gt;a2 and b1&lt;&gt;b2 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_swap_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_filer_entry</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">gfar_filer_entry</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfar_filer_entry</span> <span class="o">*</span><span class="n">b1</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">gfar_filer_entry</span> <span class="o">*</span><span class="n">b2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">a1</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">a2</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">b1</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">b2</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">a1</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">a2</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">b1</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">b2</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a list consisting of masks values with their start and</span>
<span class="cm"> * end of validity and block as indicator for parts belonging</span>
<span class="cm"> * together (glued by ANDs) in mask_table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">gfar_generate_mask_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_mask_entry</span> <span class="o">*</span><span class="n">mask_table</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">and_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* LSByte of control = 0 sets a mask */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask_table</span><span class="p">[</span><span class="n">and_index</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prop</span><span class="p">;</span>
			<span class="n">mask_table</span><span class="p">[</span><span class="n">and_index</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">mask_table</span><span class="p">[</span><span class="n">and_index</span><span class="p">].</span><span class="n">block</span> <span class="o">=</span> <span class="n">block_index</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">and_index</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">mask_table</span><span class="p">[</span><span class="n">and_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">and_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* cluster starts and ends will be separated because they should</span>
<span class="cm">		 * hold their position */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">RQFCR_CLE</span><span class="p">)</span>
			<span class="n">block_index</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* A not set AND indicates the end of a depended block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">RQFCR_AND</span><span class="p">))</span>
			<span class="n">block_index</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">mask_table</span><span class="p">[</span><span class="n">and_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">and_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sorts the entries of mask_table by the values of the masks.</span>
<span class="cm"> * Important: The 0xFF80 flags of the first and last entry of a</span>
<span class="cm"> * block must hold their position (which queue, CLusterEnable, ReJEct,</span>
<span class="cm"> * AND)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_sort_mask_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_mask_entry</span> <span class="o">*</span><span class="n">mask_table</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">temp_table</span><span class="p">,</span> <span class="n">u32</span> <span class="n">and_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Pointer to compare function (_asc or _desc) */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">gfar_comp</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_first</span><span class="p">,</span> <span class="n">old_last</span><span class="p">,</span> <span class="n">new_first</span><span class="p">,</span> <span class="n">new_last</span><span class="p">;</span>

	<span class="n">gfar_comp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfar_comp_desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">and_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">old_first</span> <span class="o">=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">old_last</span> <span class="o">=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">end</span><span class="p">;</span>
			<span class="n">sort</span><span class="p">(</span><span class="n">mask_table</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_mask_entry</span><span class="p">),</span>
					<span class="n">gfar_comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfar_swap</span><span class="p">);</span>

			<span class="cm">/* Toggle order for every block. This makes the</span>
<span class="cm">			 * thing more efficient! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gfar_comp</span> <span class="o">==</span> <span class="n">gfar_comp_desc</span><span class="p">)</span>
				<span class="n">gfar_comp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfar_comp_asc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">gfar_comp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfar_comp_desc</span><span class="p">;</span>

			<span class="n">new_first</span> <span class="o">=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">new_last</span> <span class="o">=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">end</span><span class="p">;</span>

			<span class="n">gfar_swap_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_table</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">new_first</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">temp_table</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">old_first</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">temp_table</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">new_last</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">temp_table</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">old_last</span><span class="p">],</span>
					<span class="n">RQFCR_QUEUE</span> <span class="o">|</span> <span class="n">RQFCR_CLE</span> <span class="o">|</span>
						<span class="n">RQFCR_RJE</span> <span class="o">|</span> <span class="n">RQFCR_AND</span>
					<span class="p">);</span>

			<span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size</span><span class="o">++</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">block</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reduces the number of masks needed in the filer table to save entries</span>
<span class="cm"> * This is done by sorting the masks of a depended block. A depended block is</span>
<span class="cm"> * identified by gluing ANDs or CLE. The sorting order toggles after every</span>
<span class="cm"> * block. Of course entries in scope of a mask must change their location with</span>
<span class="cm"> * it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_optimize_filer_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">temp_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfar_mask_entry</span> <span class="o">*</span><span class="n">mask_table</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">and_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">previous_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We need a copy of the filer table because</span>
<span class="cm">	 * we want to change its order */</span>
	<span class="n">temp_table</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">temp_table</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mask_table</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">MAX_FILER_CACHE_IDX</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_mask_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">and_index</span> <span class="o">=</span> <span class="n">gfar_generate_mask_table</span><span class="p">(</span><span class="n">mask_table</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>

	<span class="n">gfar_sort_mask_table</span><span class="p">(</span><span class="n">mask_table</span><span class="p">,</span> <span class="n">temp_table</span><span class="p">,</span> <span class="n">and_index</span><span class="p">);</span>

	<span class="cm">/* Now we can copy the data from our duplicated filer table to</span>
<span class="cm">	 * the real one in the order the mask table says */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">and_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gfar_copy_filer_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="n">temp_table</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">]),</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* And finally we just have to check for duplicated masks and drop the</span>
<span class="cm">	 * second ones */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_CACHE_IDX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">previous_mask</span> <span class="o">=</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_CACHE_IDX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prop</span> <span class="o">==</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">previous_mask</span><span class="p">].</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Two identical ones found!</span>
<span class="cm">				 * So drop the second one! */</span>
				<span class="n">gfar_trim_filer_entries</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* Not identical! */</span>
				<span class="n">previous_mask</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mask_table</span><span class="p">);</span>
<span class="nl">end:</span>	<span class="n">kfree</span><span class="p">(</span><span class="n">temp_table</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write the bit-pattern from software&#39;s buffer to hardware registers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_write_filer_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">MAX_FILER_IDX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Avoid inconsistent filer table to be processed */</span>
	<span class="n">lock_rx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Fill regular entries */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_IDX</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prop</span><span class="p">);</span>
	<span class="cm">/* Fill the rest with fall-troughs */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FILER_IDX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="cm">/* Last entry must be default accept</span>
<span class="cm">	 * because that&#39;s what people expect */</span>
	<span class="n">gfar_write_filer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">unlock_rx_qs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_check_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">flow</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">&amp;</span> <span class="n">FLOW_EXT</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">~</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;User-specific data not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_etype</span><span class="p">)</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;VLAN-etype not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">IP_USER_FLOW</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">ip_ver</span> <span class="o">!=</span> <span class="n">ETH_RX_NFC_IP4</span><span class="p">)</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="s">&quot;IP-Version differing from IPv4 not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_process_filer_changes</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_flow_spec_container</span> <span class="o">*</span><span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filer_table</span> <span class="o">*</span><span class="n">tab</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* So index is set to zero, too! */</span>
	<span class="n">tab</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tab</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Now convert the existing filer data from flow_spec into</span>
<span class="cm">	 * filer tables binary format */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_convert_to_filer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Rule not added: No free space!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Rule not added: Unsupported Flow-type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Optimizations to save entries */</span>
	<span class="n">gfar_cluster_filer</span><span class="p">(</span><span class="n">tab</span><span class="p">);</span>
	<span class="n">gfar_optimize_filer_masks</span><span class="p">(</span><span class="n">tab</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Summary:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">Data on hardware: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">Compression rate: %d%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">tab</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">/</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Write everything to hardware */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_write_filer_table</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Rule not added: No free space!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">end:</span>	<span class="n">kfree</span><span class="p">(</span><span class="n">tab</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfar_invert_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">hdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_etype</span> <span class="o">^=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">vlan_tci</span> <span class="o">^=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">flow</span><span class="o">-&gt;</span><span class="n">m_ext</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_add_cls</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_flow_spec_container</span> <span class="o">*</span><span class="n">temp</span><span class="p">,</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">temp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">));</span>

	<span class="n">gfar_invert_masks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_check_capability</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_mem</span><span class="p">;</span>
	<span class="cm">/* Link in the new element at the right @location */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_check_filer_hardware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">clean_mem</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">process</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span> <span class="o">&gt;</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">location</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">process</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">flow</span><span class="o">-&gt;</span><span class="n">location</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						<span class="s">&quot;Rule not added: ID %d not free!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">flow</span><span class="o">-&gt;</span><span class="n">location</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">clean_mem</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">process:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_process_filer_changes</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_list</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">clean_list:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="nl">clean_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_del_cls</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_flow_spec_container</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">comp</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">gfar_process_filer_changes</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_get_cls</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_flow_spec_container</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">));</span>
			<span class="n">gfar_invert_masks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_get_cls_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rule_locs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_flow_spec_container</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rule_cnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="n">rule_locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">MAX_FILER_IDX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rule_cnt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_set_nfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue_access</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_SRXFH</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_set_hash_opts</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_SRXCLSRLINS</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">ring_cookie</span> <span class="o">!=</span> <span class="n">RX_CLS_FLOW_DISC</span> <span class="o">&amp;&amp;</span>
		     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">ring_cookie</span> <span class="o">&gt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span> <span class="o">&gt;=</span> <span class="n">MAX_FILER_IDX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_add_cls</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_SRXCLSRLDEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_del_cls</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue_access</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_get_nfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">rule_locs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXRINGS</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXCLSRLCNT</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rule_cnt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXCLSRULE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_get_cls</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXCLSRLALL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfar_get_cls_all</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rule_locs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">gfar_phc_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfar_get_ts_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ethtool_ts_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfar_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">FSL_GIANFAR_DEV_HAS_TIMER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">so_timestamping</span> <span class="o">=</span>
			<span class="n">SOF_TIMESTAMPING_RX_SOFTWARE</span> <span class="o">|</span>
			<span class="n">SOF_TIMESTAMPING_SOFTWARE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phc_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">so_timestamping</span> <span class="o">=</span>
		<span class="n">SOF_TIMESTAMPING_TX_HARDWARE</span> <span class="o">|</span>
		<span class="n">SOF_TIMESTAMPING_RX_HARDWARE</span> <span class="o">|</span>
		<span class="n">SOF_TIMESTAMPING_RAW_HARDWARE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">phc_index</span> <span class="o">=</span> <span class="n">gfar_phc_index</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_types</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_TX_OFF</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_TX_ON</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_filters</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_FILTER_NONE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_FILTER_ALL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">gfar_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">gfar_gsettings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">gfar_ssettings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">gfar_gdrvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span> <span class="o">=</span> <span class="n">gfar_reglen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span> <span class="o">=</span> <span class="n">gfar_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span> <span class="o">=</span> <span class="n">gfar_gcoalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span> <span class="o">=</span> <span class="n">gfar_scoalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span> <span class="o">=</span> <span class="n">gfar_gringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span> <span class="o">=</span> <span class="n">gfar_sringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">gfar_gstrings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">gfar_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">gfar_fill_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">gfar_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">gfar_set_msglevel</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">gfar_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span> <span class="o">=</span> <span class="n">gfar_set_wol</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">set_rxnfc</span> <span class="o">=</span> <span class="n">gfar_set_nfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxnfc</span> <span class="o">=</span> <span class="n">gfar_get_nfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span> <span class="o">=</span> <span class="n">gfar_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
