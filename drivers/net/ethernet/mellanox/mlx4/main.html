<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › mellanox › mlx4 › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005, 2006, 2007, 2008 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2006, 2007 Cisco Systems, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/io-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/mlx4/device.h&gt;</span>
<span class="cp">#include &lt;linux/mlx4/doorbell.h&gt;</span>

<span class="cp">#include &quot;mlx4.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;icm.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Roland Dreier&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Mellanox ConnectX HCA low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">mlx4_wq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MLX4_DEBUG</span>

<span class="kt">int</span> <span class="n">mlx4_debug_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">mlx4_debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="s">&quot;Enable debug tracing if &gt; 0&quot;</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MLX4_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">msi_x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msi_x</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi_x</span><span class="p">,</span> <span class="s">&quot;attempt to use MSI-X if nonzero&quot;</span><span class="p">);</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="cp">#define msi_x (0)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">num_vfs</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">num_vfs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_vfs</span><span class="p">,</span> <span class="s">&quot;enable #num_vfs functions if num_vfs &gt; 0&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">probe_vf</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">probe_vf</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">probe_vf</span><span class="p">,</span> <span class="s">&quot;number of vfs to probe by pf driver (num_vfs &gt; 0)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">mlx4_log_num_mgm_entry_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">log_num_mgm_entry_size</span><span class="p">,</span>
			<span class="n">mlx4_log_num_mgm_entry_size</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_num_mgm_entry_size</span><span class="p">,</span> <span class="s">&quot;log mgm size, that defines the num&quot;</span>
					 <span class="s">&quot; of qp per mcg, for example:&quot;</span>
					 <span class="s">&quot; 10 gives 248.range: 9&lt;=&quot;</span>
					 <span class="s">&quot; log_num_mgm_entry_size &lt;= 12&quot;</span><span class="p">);</span>

<span class="cp">#define MLX4_VF                                        (1 &lt;&lt; 0)</span>

<span class="cp">#define HCA_GLOBAL_CAP_MASK            0</span>
<span class="cp">#define PF_CONTEXT_BEHAVIOUR_MASK      0</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">mlx4_version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
	<span class="n">DRV_NAME</span> <span class="s">&quot;: Mellanox ConnectX core driver v&quot;</span>
	<span class="n">DRV_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mlx4_profile</span> <span class="n">default_profile</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_qp</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_srq</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rdmarc_per_qp</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_cq</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_mcg</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_mpt</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_mtt</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="cm">/* It is really num mtt segements */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">log_num_mac</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">log_num_mac</span><span class="p">,</span> <span class="n">log_num_mac</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_num_mac</span><span class="p">,</span> <span class="s">&quot;Log2 max number of MACs per ETH port (1-7)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">log_num_vlan</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">log_num_vlan</span><span class="p">,</span> <span class="n">log_num_vlan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_num_vlan</span><span class="p">,</span> <span class="s">&quot;Log2 max number of VLANs per ETH port (0-7)&quot;</span><span class="p">);</span>
<span class="cm">/* Log2 max number of VLANs per ETH port (0-7) */</span>
<span class="cp">#define MLX4_LOG_NUM_VLANS 7</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">use_prio</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">use_prio</span><span class="p">,</span> <span class="n">use_prio</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_prio</span><span class="p">,</span> <span class="s">&quot;Enable steering by VLAN priority on ETH ports &quot;</span>
		  <span class="s">&quot;(0/1, default 0)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">log_mtts_per_seg</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">MLX4_MTT_ENTRY_PER_SEG</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="s">&quot;Log2 number of MTT entries per segment (1-7)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">port_type_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">,</span> <span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arr_argc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">port_type_array</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr_argc</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">port_type_array</span><span class="p">,</span> <span class="s">&quot;Array of port types: HW_DEFAULT (0) is default &quot;</span>
				<span class="s">&quot;1 for IB, 2 for Ethernet&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mlx4_port_config</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mlx4_port_type</span> <span class="n">port_type</span><span class="p">[</span><span class="n">MLX4_MAX_PORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">mlx4_check_port_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">mlx4_port_type</span> <span class="o">*</span><span class="n">port_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">port_type</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_DPDP</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Only same port types supported &quot;</span>
					 <span class="s">&quot;on this HCA, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_ETH</span> <span class="o">&amp;&amp;</span>
			    <span class="n">port_type</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_IB</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">supported_type</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested port type for port %d is not &quot;</span>
				      <span class="s">&quot;supported on this HCA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_set_port_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_dev_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_dev_cap</span> <span class="o">*</span><span class="n">dev_cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_QUERY_DEV_CAP</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_DEV_CAP command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">min_page_sz</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA minimum page size of %d bigger than &quot;</span>
			 <span class="s">&quot;kernel PAGE_SIZE of %ld, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">min_page_sz</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">&gt;</span> <span class="n">MLX4_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA has %d ports, but we only support %d, &quot;</span>
			 <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">,</span> <span class="n">MLX4_MAX_PORTS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">uar_size</span> <span class="o">&gt;</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA reported UAR size of 0x%x bigger than &quot;</span>
			 <span class="s">&quot;PCI resource 2 size of 0x%llx, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">uar_size</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys_caps</span><span class="p">.</span><span class="n">num_phys_eqs</span>  <span class="o">=</span> <span class="n">MLX4_MAX_EQ_NUM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">vl_cap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>	    <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_vl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">ib_mtu_cap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>	    <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">ib_mtu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">gid_table_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_gids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">pkey_table_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_pkeys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_width_cap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_port_width</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">eth_mtu_cap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">eth_mtu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">def_mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>        <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">def_mac</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">supported_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">supported_port_types</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">suggested_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">suggested_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">default_sense</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">default_sense</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">trans_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>	    <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">trans_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">vendor_oui</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">vendor_oui</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">wavelength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">wavelength</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">trans_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">trans_code</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">uar_page_size</span>	     <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_uars</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">uar_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">local_ca_ack_delay</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">bf_reg_size</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">bf_reg_size</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">bf_regs_per_page</span>   <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">bf_regs_per_page</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_sq_sg</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_sq_sg</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_rq_sg</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_rq_sg</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_wqes</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_qp_sz</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_qp_init_rdma</span>   <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_requester_per_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_srq_wqes</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_srq_sz</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_srq_sge</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_rq_sg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_srqs</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_srqs</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_sq_desc_sz</span>     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_sq_desc_sz</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_rq_desc_sz</span>     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_rq_desc_sz</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qp_per_mgm</span>     <span class="o">=</span> <span class="n">mlx4_get_qp_per_mgm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Subtract 1 from the limit because we need to allocate a</span>
<span class="cm">	 * spare CQE so the HCA HW can tell the difference between an</span>
<span class="cm">	 * empty CQ and a full CQ.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_cqes</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_cq_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_cqs</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_cqs</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_eqs</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_eqs</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_mtts</span>      <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_mtts</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_mrws</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_mrws</span><span class="p">;</span>

	<span class="cm">/* The first 128 UARs are used for EQ doorbells */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_uars</span>	     <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_uars</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_pds</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_pds</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_xrcds</span>     <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_XRC</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_xrcds</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_xrcds</span>          <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_XRC</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_xrcds</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">mtt_entry_sz</span>       <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">mtt_entry_sz</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_msg_sz</span>         <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">page_size_cap</span>	     <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">min_page_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span>		     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags2</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">bmme_flags</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">bmme_flags</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_lkey</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_lkey</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">stat_rate_support</span>  <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">stat_rate_support</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_gso_sz</span>	     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_gso_sz</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_rss_tbl_sz</span>     <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_rss_tbl_sz</span><span class="p">;</span>

	<span class="cm">/* Sense port always allowed on supported devices for ConnectX1 and 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x1003</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MLX4_DEV_CAP_FLAG_SENSE_SUPPORT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_macs</span>  <span class="o">=</span> <span class="n">log_num_mac</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_vlans</span> <span class="o">=</span> <span class="n">MLX4_LOG_NUM_VLANS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_prios</span> <span class="o">=</span> <span class="n">use_prio</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">supported_type</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* if only ETH is supported - assign ETH */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">supported_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_ETH</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_ETH</span><span class="p">;</span>
			<span class="cm">/* if only IB is supported,</span>
<span class="cm">			 * assign IB only if SRIOV is off*/</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">supported_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span>
				 <span class="n">MLX4_PORT_TYPE_IB</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_SRIOV</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">MLX4_PORT_TYPE_IB</span><span class="p">;</span>
			<span class="cm">/* if IB and ETH are supported,</span>
<span class="cm">			 * first of all check if SRIOV is on */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_SRIOV</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_ETH</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* In non-SRIOV mode, we set the port type</span>
<span class="cm">				 * according to user selection of port type,</span>
<span class="cm">				 * if usere selected none, take the FW hint */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port_type_array</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">suggested_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span>
						<span class="n">MLX4_PORT_TYPE_ETH</span> <span class="o">:</span> <span class="n">MLX4_PORT_TYPE_IB</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_type_array</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Link sensing is allowed on the port if 3 conditions are true:</span>
<span class="cm">		 * 1. Both protocols are supported on the port.</span>
<span class="cm">		 * 2. Different types are supported on the port</span>
<span class="cm">		 * 3. FW declared that it supports link sensing</span>
<span class="cm">		 */</span>
		<span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">.</span><span class="n">sense_allowed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">supported_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_DPDP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_SENSE_SUPPORT</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * If &quot;default_sense&quot; bit is set, we move the port to &quot;AUTO&quot; mode</span>
<span class="cm">		 * and perform sense_port FW command to try and set the correct</span>
<span class="cm">		 * port type from beginning</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">.</span><span class="n">sense_allowed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">default_sense</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">mlx4_port_type</span> <span class="n">sensed_port</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_AUTO</span><span class="p">;</span>
			<span class="n">mlx4_SENSE_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensed_port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sensed_port</span> <span class="o">!=</span> <span class="n">MLX4_PORT_TYPE_NONE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensed_port</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_macs</span> <span class="o">&gt;</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">log_max_macs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_macs</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">log_max_macs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested number of MACs is too much &quot;</span>
				  <span class="s">&quot;for port %d, reducing to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_macs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_vlans</span> <span class="o">&gt;</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">log_max_vlans</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_vlans</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">log_max_vlans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested number of VLANs is too much &quot;</span>
				  <span class="s">&quot;for port %d, reducing to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_vlans</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_counters</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">max_counters</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">reserved_qps</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_ETH_ADDR</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FC_ADDR</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_macs</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_vlans</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">log_num_prios</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FC_EXCH</span><span class="p">]</span> <span class="o">=</span> <span class="n">MLX4_NUM_FEXCH</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_ETH_ADDR</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FC_ADDR</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FC_EXCH</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*The function checks if there are live vf, return the num of them*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_how_many_lives_vf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_slave_state</span> <span class="o">*</span><span class="n">s_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="cm">/*the ppf is 0*/</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_slaves</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mfunc</span><span class="p">.</span><span class="n">master</span><span class="p">.</span><span class="n">slave_state</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s_state</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">s_state</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">!=</span>
		    <span class="n">MLX4_COMM_CMD_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: slave: %d is still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ret</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_is_slave_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_slave_state</span> <span class="o">*</span><span class="n">s_slave</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s_slave</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mfunc</span><span class="p">.</span><span class="n">master</span><span class="p">.</span><span class="n">slave_state</span><span class="p">[</span><span class="n">slave</span><span class="p">];</span>
	<span class="k">return</span> <span class="o">!!</span><span class="n">s_slave</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mlx4_is_slave_active</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_slave_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			   <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span>			   <span class="n">page_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_dev_cap</span>	   <span class="n">dev_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_func_cap</span>	   <span class="n">func_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_init_hca_param</span> <span class="n">hca_param</span><span class="p">;</span>
	<span class="kt">int</span>			   <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hca_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hca_param</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_QUERY_HCA</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hca_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_HCA command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*fail if the hca has an unknown capability */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hca_param</span><span class="p">.</span><span class="n">global_caps</span> <span class="o">|</span> <span class="n">HCA_GLOBAL_CAP_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">HCA_GLOBAL_CAP_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown hca global capabilities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_log_num_mgm_entry_size</span> <span class="o">=</span> <span class="n">hca_param</span><span class="p">.</span><span class="n">log_mc_entry_sz</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev_cap</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_qp_dest_rdma</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hca_param</span><span class="p">.</span><span class="n">log_rd_per_qp</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_dev_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_DEV_CAP command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_QUERY_FW</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_FW command failed: could not get FW version.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">page_size</span> <span class="o">=</span> <span class="o">~</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">page_size_cap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA minimum page size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA minimum page size of %d bigger than &quot;</span>
			 <span class="s">&quot;kernel PAGE_SIZE of %ld, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">page_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* slave gets uar page size from QUERY_HCA fw command */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">uar_page_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hca_param</span><span class="p">.</span><span class="n">uar_page_sz</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* TODO: relax this assumption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">uar_page_size</span> <span class="o">!=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UAR size:%d != kernel PAGE_SIZE of %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">uar_page_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func_cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">func_cap</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_QUERY_FUNC_CAP</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_FUNC_CAP command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">func_cap</span><span class="p">.</span><span class="n">pf_context_behaviour</span> <span class="o">|</span> <span class="n">PF_CONTEXT_BEHAVIOUR_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">PF_CONTEXT_BEHAVIOUR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown pf context behaviour</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span>		<span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qps</span>		<span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">qp_quota</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_srqs</span>		<span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">srq_quota</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_cqs</span>		<span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">cq_quota</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_eqs</span>               <span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">max_eq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_eqs</span>          <span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">reserved_eq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mpts</span>		<span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">mpt_quota</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mtts</span>		<span class="o">=</span> <span class="n">func_cap</span><span class="p">.</span><span class="n">mtt_quota</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_pds</span>               <span class="o">=</span> <span class="n">MLX4_NUM_PDS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mgms</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_amgms</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span> <span class="o">&gt;</span> <span class="n">MLX4_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA has %d ports, but we only support %d, &quot;</span>
			 <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">,</span> <span class="n">MLX4_MAX_PORTS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">uar_page_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_uars</span> <span class="o">-</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_uars</span><span class="p">)</span> <span class="o">&gt;</span>
				       <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA reported UAR region size of 0x%x bigger than &quot;</span>
			 <span class="s">&quot;PCI resource 2 size of 0x%llx, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">uar_page_size</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_uars</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change the port configuration of the device.</span>
<span class="cm"> * Every user of this function must hold the port mutex.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mlx4_change_port_types</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">mlx4_port_type</span> <span class="o">*</span><span class="n">port_types</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Change the port type only if the new type is different</span>
<span class="cm">		 * from the current, and not set to Auto */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_types</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_CLOSE_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_types</span><span class="p">[</span><span class="n">port</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_SET_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set port %d, &quot;</span>
					      <span class="s">&quot;aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mlx4_set_port_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_port_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_port_info</span><span class="p">,</span>
						   <span class="n">port_attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_IB</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;ib&quot;</span> <span class="o">:</span> <span class="s">&quot;eth&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_AUTO</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;auto (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_port_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_port_info</span><span class="p">,</span>
						   <span class="n">port_attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">mlx4_port_type</span> <span class="n">types</span><span class="p">[</span><span class="n">MLX4_MAX_PORTS</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">mlx4_port_type</span> <span class="n">new_types</span><span class="p">[</span><span class="n">MLX4_MAX_PORTS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ib</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_type</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_IB</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;eth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_type</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_ETH</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_type</span> <span class="o">=</span> <span class="n">MLX4_PORT_TYPE_AUTO</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;%s is not supported port type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_stop_sense</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_mutex</span><span class="p">);</span>
	<span class="cm">/* Possible type is always the one that was delivered */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_type</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">tmp_type</span> <span class="o">?</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">tmp_type</span> <span class="o">:</span>
					<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_AUTO</span><span class="p">)</span>
			<span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_DPDP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_SENSE_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_AUTO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">possible_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Auto sensing is not supported on this HCA. &quot;</span>
			       <span class="s">&quot;Set only &#39;eth&#39; or &#39;ib&#39; for both ports &quot;</span>
			       <span class="s">&quot;(should be the same)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_do_sense_ports</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">new_types</span><span class="p">,</span> <span class="n">types</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_check_port_params</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">new_types</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* We are about to apply the changes after the configuration</span>
<span class="cm">	 * was verified, no need to remember the temporary types</span>
<span class="cm">	 * any more */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">tmp_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_change_port_types</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">new_types</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mlx4_start_sense</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">ibta_mtu</span> <span class="p">{</span>
	<span class="n">IB_MTU_256</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">IB_MTU_512</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">IB_MTU_1024</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">IB_MTU_2048</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">IB_MTU_4096</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">int_to_ibta_mtu</span><span class="p">(</span><span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">256</span>:  <span class="k">return</span> <span class="n">IB_MTU_256</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:  <span class="k">return</span> <span class="n">IB_MTU_512</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>: <span class="k">return</span> <span class="n">IB_MTU_1024</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>: <span class="k">return</span> <span class="n">IB_MTU_2048</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>: <span class="k">return</span> <span class="n">IB_MTU_4096</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ibta_mtu_to_int</span><span class="p">(</span><span class="k">enum</span> <span class="n">ibta_mtu</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_MTU_256</span>:  <span class="k">return</span>  <span class="mi">256</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_MTU_512</span>:  <span class="k">return</span>  <span class="mi">512</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_MTU_1024</span>: <span class="k">return</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_MTU_2048</span>: <span class="k">return</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_MTU_4096</span>: <span class="k">return</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_port_ib_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_port_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_port_info</span><span class="p">,</span>
						   <span class="n">port_mtu_attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_ETH</span><span class="p">)</span>
		<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;port level mtu is only used for IB ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ibta_mtu_to_int</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_ib_mtu</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]));</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_port_ib_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_port_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_port_info</span><span class="p">,</span>
						   <span class="n">port_mtu_attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">mtu</span><span class="p">,</span> <span class="n">ibta_mtu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="n">MLX4_PORT_TYPE_ETH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;port level mtu is only used for IB ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ibta_mtu</span> <span class="o">=</span> <span class="n">int_to_ibta_mtu</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ibta_mtu</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;%s is invalid IBTA mtu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_ib_mtu</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibta_mtu</span><span class="p">;</span>

	<span class="n">mlx4_stop_sense</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_mutex</span><span class="p">);</span>
	<span class="n">mlx4_unregister_device</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_CLOSE_PORT</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_SET_PORT</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to set port %d, &quot;</span>
				      <span class="s">&quot;aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_set_port</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_register_device</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">err_set_port:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_mutex</span><span class="p">);</span>
	<span class="n">mlx4_start_sense</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_icm</span> <span class="o">=</span> <span class="n">mlx4_alloc_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_pages</span><span class="p">,</span>
					 <span class="n">GFP_HIGHUSER</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate FW area, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_MAP_FA</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAP_FA command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_RUN_FW</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RUN_FW command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_fa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap_fa:</span>
	<span class="n">mlx4_UNMAP_FA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_free:</span>
	<span class="n">mlx4_free_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_cmpt_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cmpt_base</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">cmpt_entry_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_eqs</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">,</span>
				  <span class="n">cmpt_base</span> <span class="o">+</span>
				  <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">MLX4_CMPT_TYPE_QP</span> <span class="o">*</span>
					  <span class="n">cmpt_entry_sz</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MLX4_CMPT_SHIFT</span><span class="p">),</span>
				  <span class="n">cmpt_entry_sz</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">],</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">,</span>
				  <span class="n">cmpt_base</span> <span class="o">+</span>
				  <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">MLX4_CMPT_TYPE_SRQ</span> <span class="o">*</span>
					  <span class="n">cmpt_entry_sz</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MLX4_CMPT_SHIFT</span><span class="p">),</span>
				  <span class="n">cmpt_entry_sz</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_srqs</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_srqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_qp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">,</span>
				  <span class="n">cmpt_base</span> <span class="o">+</span>
				  <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">MLX4_CMPT_TYPE_CQ</span> <span class="o">*</span>
					  <span class="n">cmpt_entry_sz</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MLX4_CMPT_SHIFT</span><span class="p">),</span>
				  <span class="n">cmpt_entry_sz</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_cqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_srq</span><span class="p">;</span>

	<span class="n">num_eqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys_caps</span><span class="p">.</span><span class="n">num_phys_eqs</span> <span class="o">:</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_eqs</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">,</span>
				  <span class="n">cmpt_base</span> <span class="o">+</span>
				  <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">MLX4_CMPT_TYPE_EQ</span> <span class="o">*</span>
					  <span class="n">cmpt_entry_sz</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MLX4_CMPT_SHIFT</span><span class="p">),</span>
				  <span class="n">cmpt_entry_sz</span><span class="p">,</span> <span class="n">num_eqs</span><span class="p">,</span> <span class="n">num_eqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_cq:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>

<span class="nl">err_srq:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>

<span class="nl">err_qp:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_icm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_dev_cap</span> <span class="o">*</span><span class="n">dev_cap</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mlx4_init_hca_param</span> <span class="o">*</span><span class="n">init_hca</span><span class="p">,</span> <span class="n">u64</span> <span class="n">icm_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">aux_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_eqs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_SET_ICM_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">icm_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aux_pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET_ICM_SIZE command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%lld KB of HCA context requires %lld KB aux memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">icm_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aux_pages</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">aux_icm</span> <span class="o">=</span> <span class="n">mlx4_alloc_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">aux_pages</span><span class="p">,</span>
					  <span class="n">GFP_HIGHUSER</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate aux memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_MAP_ICM_AUX</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAP_ICM_AUX command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_aux</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_cmpt_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">cmpt_base</span><span class="p">,</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">cmpt_entry_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map cMPT context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_aux</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">num_eqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys_caps</span><span class="p">.</span><span class="n">num_phys_eqs</span> <span class="o">:</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_eqs</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">eqc_base</span><span class="p">,</span> <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">eqc_entry_sz</span><span class="p">,</span>
				  <span class="n">num_eqs</span><span class="p">,</span> <span class="n">num_eqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map EQ context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_cmpt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserved MTT entries must be aligned up to a cacheline</span>
<span class="cm">	 * boundary, since the FW will write to them, while the driver</span>
<span class="cm">	 * writes to all other MTT entries. (The variable</span>
<span class="cm">	 * dev-&gt;caps.mtt_entry_sz below is really the MTT segment</span>
<span class="cm">	 * size, not the raw entry size)</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_mtts</span> <span class="o">=</span>
		<span class="n">ALIGN</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_mtts</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">mtt_entry_sz</span><span class="p">,</span>
		      <span class="n">dma_get_cache_alignment</span><span class="p">())</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">mtt_entry_sz</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">mtt_base</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">mtt_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mtts</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_mtts</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map MTT context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_eq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">dmpt_table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">dmpt_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">dmpt_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mpts</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_mrws</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map dMPT context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_mtt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">qpc_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">qpc_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">],</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map QP context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_dmpt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">auxc_table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">auxc_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">aux_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">],</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map AUXC context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_qp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">altc_table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">altc_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">altc_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">],</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map ALTC context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_auxc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdmarc_table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">rdmarc_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">rdmarc_entry_sz</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdmarc_shift</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_cnt</span><span class="p">[</span><span class="n">MLX4_QP_REGION_FW</span><span class="p">],</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map RDMARC context memory, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_altc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">cqc_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">cqc_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_cqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map CQ context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_rdmarc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">srqc_base</span><span class="p">,</span>
				  <span class="n">dev_cap</span><span class="o">-&gt;</span><span class="n">srq_entry_sz</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_srqs</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_srqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map SRQ context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_cq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s not strictly required, but for simplicity just map the</span>
<span class="cm">	 * whole multicast group table now.  The table isn&#39;t very big</span>
<span class="cm">	 * and it&#39;s a lot easier than trying to track ref counts.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcg_table</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
				  <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">mc_base</span><span class="p">,</span>
				  <span class="n">mlx4_get_mgm_entry_size</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mgms</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_amgms</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mgms</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_amgms</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map MCG context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_srq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap_srq:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>

<span class="nl">err_unmap_cq:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>

<span class="nl">err_unmap_rdmarc:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdmarc_table</span><span class="p">);</span>

<span class="nl">err_unmap_altc:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">altc_table</span><span class="p">);</span>

<span class="nl">err_unmap_auxc:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">auxc_table</span><span class="p">);</span>

<span class="nl">err_unmap_qp:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span><span class="p">);</span>

<span class="nl">err_unmap_dmpt:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">dmpt_table</span><span class="p">);</span>

<span class="nl">err_unmap_mtt:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span><span class="p">);</span>

<span class="nl">err_unmap_eq:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>

<span class="nl">err_unmap_cmpt:</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>

<span class="nl">err_unmap_aux:</span>
	<span class="n">mlx4_UNMAP_ICM_AUX</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_free_aux:</span>
	<span class="n">mlx4_free_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_free_icms</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcg_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdmarc_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">altc_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">auxc_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">dmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_icm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">cmpt_table</span><span class="p">);</span>

	<span class="n">mlx4_UNMAP_ICM_AUX</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_free_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_slave_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">slave_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MLX4_COMM_TIME</span><span class="p">))</span>
		<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to close slave function.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">slave_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_bf_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">resource_size_t</span> <span class="n">bf_start</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">bf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">bf_reg_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">bf_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_uars</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="n">bf_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_uars</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bf_mapping</span> <span class="o">=</span> <span class="n">io_mapping_create_wc</span><span class="p">(</span><span class="n">bf_start</span><span class="p">,</span> <span class="n">bf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bf_mapping</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unmap_bf_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bf_mapping</span><span class="p">)</span>
		<span class="n">io_mapping_free</span><span class="p">(</span><span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bf_mapping</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_close_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unmap_bf_area</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_slave_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mlx4_CLOSE_HCA</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mlx4_free_icms</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_UNMAP_FA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_free_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mfunc</span><span class="p">.</span><span class="n">vhcr_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_of_reset_retries</span> <span class="o">=</span> <span class="n">NUM_OF_RESET_RETRIES</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_from_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slave_read</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_channel_ver</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">slave_sem</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sending reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret_from_reset</span> <span class="o">=</span> <span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">MLX4_COMM_TIME</span><span class="p">);</span>
	<span class="cm">/* if we are in the middle of flr the slave will try</span>
<span class="cm">	 * NUM_OF_RESET_RETRIES times before leaving.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_from_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MLX4_DELAY_RESET_SLAVE</span> <span class="o">==</span> <span class="n">ret_from_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_IN_RESET</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ret_from_reset</span> <span class="o">&amp;&amp;</span> <span class="n">num_of_reset_retries</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slave is currently in the&quot;</span>
					  <span class="s">&quot;middle of FLR. retrying...&quot;</span>
					  <span class="s">&quot;(try num:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">NUM_OF_RESET_RETRIES</span> <span class="o">-</span>
					   <span class="n">num_of_reset_retries</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">ret_from_reset</span> <span class="o">=</span>
					<span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_RESET</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">,</span> <span class="n">MLX4_COMM_TIME</span><span class="p">);</span>
				<span class="n">num_of_reset_retries</span> <span class="o">=</span> <span class="n">num_of_reset_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the driver version - the slave I/F revision</span>
<span class="cm">	 * must match the master&#39;s */</span>
	<span class="n">slave_read</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mfunc</span><span class="p">.</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">slave_read</span><span class="p">));</span>
	<span class="n">cmd_channel_ver</span> <span class="o">=</span> <span class="n">mlx4_comm_get_version</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MLX4_COMM_GET_IF_REV</span><span class="p">(</span><span class="n">cmd_channel_ver</span><span class="p">)</span> <span class="o">!=</span>
		<span class="n">MLX4_COMM_GET_IF_REV</span><span class="p">(</span><span class="n">slave_read</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slave driver version is not supported&quot;</span>
			 <span class="s">&quot; by the master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sending vhcr0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_VHCR0</span><span class="p">,</span> <span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">,</span>
						    <span class="n">MLX4_COMM_TIME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_VHCR1</span><span class="p">,</span> <span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
						    <span class="n">MLX4_COMM_TIME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_VHCR2</span><span class="p">,</span> <span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
						    <span class="n">MLX4_COMM_TIME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_VHCR_EN</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">MLX4_COMM_TIME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">slave_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">mlx4_comm_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MLX4_COMM_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">slave_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span>	  <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_adapter</span>	   <span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_dev_cap</span>	   <span class="n">dev_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_mod_stat_cfg</span>   <span class="n">mlx4_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_profile</span>	   <span class="n">profile</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_init_hca_param</span> <span class="n">init_hca</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">icm_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_QUERY_FW</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
				<span class="n">mlx4_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;non-primary physical function, skipping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_FW command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unmap_bf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_load_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to start FW, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unmap_bf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mlx4_cfg</span><span class="p">.</span><span class="n">log_pg_sz_m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mlx4_cfg</span><span class="p">.</span><span class="n">log_pg_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_MOD_STAT_CFG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlx4_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to override log_pg_sz parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_dev_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_cap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_DEV_CAP command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_stop_fw</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">profile</span> <span class="o">=</span> <span class="n">default_profile</span><span class="p">;</span>

		<span class="n">icm_size</span> <span class="o">=</span> <span class="n">mlx4_make_profile</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_cap</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">icm_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">icm_size</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_stop_fw</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_fmr_maps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_mpts</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">init_hca</span><span class="p">.</span><span class="n">log_uar_sz</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_uars</span><span class="p">);</span>
		<span class="n">init_hca</span><span class="p">.</span><span class="n">uar_page_sz</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_cap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">,</span> <span class="n">icm_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_stop_fw</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_INIT_HCA</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;INIT_HCA command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_icm</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unmap_bf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_slave_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to obtain slave caps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map_bf_area</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map blue flame area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*Only the master set the ports, all the rest got it from it.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_set_port_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_QUERY_ADAPTER</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUERY_ADAPTER command failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">inta_pin</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="n">inta_pin</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">,</span> <span class="n">adapter</span><span class="p">.</span><span class="n">board_id</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_close:</span>
	<span class="n">mlx4_close_hca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_free_icm:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_free_icms</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_stop_fw:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_UNMAP_FA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_free_icm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">unmap_bf:</span>
	<span class="n">unmap_bf_area</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_counters_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_COUNTERS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">nent</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_counters</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mlx4_bitmap_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">counters_bitmap</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">nent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_cleanup_counters_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlx4_bitmap_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">counters_bitmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__mlx4_counter_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_COUNTERS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">mlx4_bitmap_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">counters_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_counter_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">out_param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_cmd_imm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_param</span><span class="p">,</span> <span class="n">RES_COUNTER</span><span class="p">,</span>
				   <span class="n">RES_OP_RESERVE</span><span class="p">,</span> <span class="n">MLX4_CMD_ALLOC_RES</span><span class="p">,</span>
				   <span class="n">MLX4_CMD_TIME_CLASS_A</span><span class="p">,</span> <span class="n">MLX4_CMD_WRAPPED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">get_param_l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_param</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">__mlx4_counter_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mlx4_counter_alloc</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__mlx4_counter_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlx4_bitmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">counters_bitmap</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mlx4_counter_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">in_param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_param_l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_param</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">mlx4_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="n">RES_COUNTER</span><span class="p">,</span> <span class="n">RES_OP_RESERVE</span><span class="p">,</span>
			 <span class="n">MLX4_CMD_FREE_RES</span><span class="p">,</span> <span class="n">MLX4_CMD_TIME_CLASS_A</span><span class="p">,</span>
			 <span class="n">MLX4_CMD_WRAPPED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__mlx4_counter_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mlx4_counter_free</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_setup_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ib_port_default_caps</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_uar_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;user access region table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_uar_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate driver access region, &quot;</span>
			 <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_uar_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">kar</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">.</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">kar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map kernel access region, &quot;</span>
			 <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_uar_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_pd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;protection domain table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_kar_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_xrcd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;reliable connection domain table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pd_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_mr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;memory region table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_xrcd_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;event queue table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mr_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_cmd_use_events</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to switch to event-driven &quot;</span>
			 <span class="s">&quot;firmware commands, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_eq_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_NOP</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_MSI_X</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOP command failed to generate MSI-X &quot;</span>
				  <span class="s">&quot;interrupt IRQ %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_comp_vectors</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Trying again without MSI-X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOP command failed to generate interrupt &quot;</span>
				 <span class="s">&quot;(IRQ %d), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_comp_vectors</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BIOS or ACPI interrupt routing problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">err_cmd_poll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOP command IRQ test passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_cq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;completion queue table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cmd_poll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_srq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;shared receive queue table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cq_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_qp_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			 <span class="s">&quot;queue pair table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_srq_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_mcg_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
				 <span class="s">&quot;multicast group table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_qp_table_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_counters_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize counters table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mcg_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ib_port_default_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_get_port_ib_caps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ib_port_default_caps</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get port %d default &quot;</span>
					  <span class="s">&quot;ib capabilities (%d). Continuing &quot;</span>
					  <span class="s">&quot;with caps = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">ib_port_def_cap</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib_port_default_caps</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_ib_mtu</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_MTU_2048</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">port_ib_mtu</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_MTU_4096</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_SET_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set port %d, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">port</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_counters_table_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_counters_table_free:</span>
	<span class="n">mlx4_cleanup_counters_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_mcg_table_free:</span>
	<span class="n">mlx4_cleanup_mcg_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_qp_table_free:</span>
	<span class="n">mlx4_cleanup_qp_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_srq_table_free:</span>
	<span class="n">mlx4_cleanup_srq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_cq_table_free:</span>
	<span class="n">mlx4_cleanup_cq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_cmd_poll:</span>
	<span class="n">mlx4_cmd_use_polling</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_eq_table_free:</span>
	<span class="n">mlx4_cleanup_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_mr_table_free:</span>
	<span class="n">mlx4_cleanup_mr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_xrcd_table_free:</span>
	<span class="n">mlx4_cleanup_xrcd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_pd_table_free:</span>
	<span class="n">mlx4_cleanup_pd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_kar_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">kar</span><span class="p">);</span>

<span class="nl">err_uar_free:</span>
	<span class="n">mlx4_uar_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">);</span>

<span class="nl">err_uar_table_free:</span>
	<span class="n">mlx4_cleanup_uar_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_enable_msi_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nreq</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span> <span class="o">*</span>
			 <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">num_online_cpus</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MAX_MSIX_P_PORT</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">MSIX_LEGACY_SZ</span><span class="p">,</span> <span class="n">MAX_MSIX</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msi_x</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In multifunction mode each function gets 2 msi-X vectors</span>
<span class="cm">		 * one for data path completions anf the other for asynch events</span>
<span class="cm">		 * or command completions */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nreq</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nreq</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_eqs</span> <span class="o">-</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_eqs</span><span class="p">,</span> <span class="n">nreq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">entries</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">nreq</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_msi</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nreq</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="nl">retry:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">nreq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Try again if at least 2 vectors are available */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mlx4_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested %d vectors, &quot;</span>
					  <span class="s">&quot;but only %d MSI-X vectors available, &quot;</span>
					  <span class="s">&quot;trying again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nreq</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">nreq</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">no_msi</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nreq</span> <span class="o">&lt;</span>
		    <span class="n">MSIX_LEGACY_SZ</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span> <span class="o">*</span> <span class="n">MIN_MSIX_P_PORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*Working in legacy mode , all EQ&#39;s shared*/</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">comp_pool</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_comp_vectors</span> <span class="o">=</span> <span class="n">nreq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">comp_pool</span>           <span class="o">=</span> <span class="n">nreq</span> <span class="o">-</span> <span class="n">MSIX_LEGACY_SZ</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_comp_vectors</span> <span class="o">=</span> <span class="n">MSIX_LEGACY_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nreq</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MLX4_FLAG_MSI_X</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">no_msi:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_comp_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">comp_pool</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_port_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_port_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_RADIX_TREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mac_tree</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">mlx4_init_mac_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mac_table</span><span class="p">);</span>
		<span class="n">mlx4_init_vlan_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vlan_table</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">base_qpn</span> <span class="o">=</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">reserved_qps_base</span><span class="p">[</span><span class="n">MLX4_QP_REGION_ETH_ADDR</span><span class="p">]</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">port</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_num_mac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;mlx4_port%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">.</span><span class="n">store</span>     <span class="o">=</span> <span class="n">set_port_type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">.</span><span class="n">show</span>      <span class="o">=</span> <span class="n">show_port_type</span><span class="p">;</span>
	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create file for port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_mtu_name</span><span class="p">,</span> <span class="s">&quot;mlx4_port%d_mtu&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_mtu_name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">.</span><span class="n">store</span>     <span class="o">=</span> <span class="n">set_port_ib_mtu</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">.</span><span class="n">show</span>      <span class="o">=</span> <span class="n">show_port_ib_mtu</span><span class="p">;</span>
	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create mtu file for port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_cleanup_port_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_port_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_mtu_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_init_steering</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_entries</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_steer</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_entries</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MLX4_NUM_STEERS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promisc_qps</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">steer_entries</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_clear_steering</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_steer_index</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_promisc_qp</span> <span class="o">*</span><span class="n">pqp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pqp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_entries</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MLX4_NUM_STEERS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pqp</span><span class="p">,</span> <span class="n">tmp_pqp</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promisc_qps</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						 <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pqp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pqp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">tmp_entry</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">steer_entries</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						 <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pqp</span><span class="p">,</span> <span class="n">tmp_pqp</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">duplicates</span><span class="p">,</span>
							 <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pqp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">pqp</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">steer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">extended_func_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MLX4_OWNER_BASE	0x8069c</span>
<span class="cp">#define MLX4_OWNER_SIZE	4</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_get_ownership</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">owner</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">MLX4_OWNER_BASE</span><span class="p">,</span>
			<span class="n">MLX4_OWNER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to obtain ownership bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">!!</span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_free_ownership</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>

	<span class="n">owner</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">MLX4_OWNER_BASE</span><span class="p">,</span>
			<span class="n">MLX4_OWNER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to obtain ownership bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__mlx4_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Initializing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device, &quot;</span>
			<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_vfs</span> <span class="o">&gt;</span> <span class="n">MLX4_MAX_NUM_VF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;There are more VF&#39;s (%d) than allowed(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">num_vfs</span><span class="p">,</span> <span class="n">MLX4_MAX_NUM_VF</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check for BARs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">MLX4_VF</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing DCS, aborting.&quot;</span>
			<span class="s">&quot;(id == 0X%p, id-&gt;driver_data: 0x%lx,&quot;</span>
			<span class="s">&quot; pci_resource_flags(pdev, 0):0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
			<span class="n">id</span> <span class="o">?</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing UAR, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t get PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Warning: couldn&#39;t set 64-bit PCI DMA mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t set PCI DMA mask, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_release_regions</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Warning: couldn&#39;t set 64-bit &quot;</span>
			 <span class="s">&quot;consistent PCI DMA mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t set consistent PCI DMA mask, &quot;</span>
				<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_release_regions</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Allow large DMA segments, up to the firmware limit of 1 GB */</span>
	<span class="n">dma_set_max_seg_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device struct alloc failed, &quot;</span>
			<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctx_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_mutex</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pgdir_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pgdir_mutex</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bf_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bf_mutex</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rev_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="cm">/* Detect if this device is a virtual function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">MLX4_VF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* When acting as pf, we normally skip vfs unless explicitly</span>
<span class="cm">		 * requested to probe them. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_vfs</span> <span class="o">&amp;&amp;</span> <span class="n">extended_func_num</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">probe_vf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Skipping virtual function:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">extended_func_num</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected virtual function - running in slave mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MLX4_FLAG_SLAVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We reset the device and enable SRIOV only for physical</span>
<span class="cm">		 * devices.  Try to claim ownership on the device;</span>
<span class="cm">		 * if already taken, skip -- do not allow multiple PFs */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_get_ownership</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Multiple PFs not yet supported.&quot;</span>
					  <span class="s">&quot; Skipping PF.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_vfs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling sriov with:%d vfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_vfs</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">num_vfs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to enable sriov,&quot;</span>
					 <span class="s">&quot;continuing without sriov enabled&quot;</span>
					 <span class="s">&quot; (err = %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Running in master mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MLX4_FLAG_SRIOV</span> <span class="o">|</span>
					      <span class="n">MLX4_FLAG_MASTER</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">=</span> <span class="n">num_vfs</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now reset the HCA before we touch the PCI capabilities or</span>
<span class="cm">		 * attempt a firmware command, since a boot ROM may have left</span>
<span class="cm">		 * the HCA in an undefined state.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to reset HCA, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_rel_own</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">slave_start:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_cmd_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to init command interface, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_sriov</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In slave functions, the communication channel must be initialized</span>
<span class="cm">	 * before posting commands. Also, init num_slaves before calling</span>
<span class="cm">	 * mlx4_init_hca */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_slaves</span> <span class="o">=</span> <span class="n">MLX4_MAX_NUM_SLAVES</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_slaves</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_multi_func_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to init slave mfunc&quot;</span>
					 <span class="s">&quot; interface, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_cmd</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_hca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not primary Physical function</span>
<span class="cm">			 * Running in slave mode */</span>
			<span class="n">mlx4_cmd_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MLX4_FLAG_SLAVE</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MLX4_FLAG_MASTER</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">slave_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_mfunc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In master functions, the communication channel must be initialized</span>
<span class="cm">	 * after obtaining its address from fw */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_multi_func_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to init master mfunc&quot;</span>
				 <span class="s">&quot;interface, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_alloc_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_master_mfunc</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix_ctl</span><span class="p">.</span><span class="n">pool_bm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix_ctl</span><span class="p">.</span><span class="n">pool_lock</span><span class="p">);</span>

	<span class="n">mlx4_enable_msi_x</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_MSI_X</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;INTx is not supported in multi-function mode.&quot;</span>
			 <span class="s">&quot; aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_eq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_steering</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_eq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_setup_hca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_MSI_X</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">mlx4_is_mfunc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MLX4_FLAG_MSI_X</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_comp_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">comp_pool</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_setup_hca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_steer</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_init_port_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_port</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_port</span><span class="p">;</span>

	<span class="n">mlx4_sense_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_start_sense</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_port:</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">port</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">--</span><span class="n">port</span><span class="p">)</span>
		<span class="n">mlx4_cleanup_port_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>

	<span class="n">mlx4_cleanup_counters_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_mcg_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_qp_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_srq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_cq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cmd_use_polling</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_mr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_xrcd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_pd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mlx4_cleanup_uar_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_steer:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_clear_steering</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_free_eq:</span>
	<span class="n">mlx4_free_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_master_mfunc:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_multi_func_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_close:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_MSI_X</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mlx4_close_hca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_mfunc:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_multi_func_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_cmd:</span>
	<span class="n">mlx4_cmd_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_sriov:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_SRIOV</span><span class="p">)</span>
		<span class="n">pci_disable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_rel_own:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mlx4_free_ownership</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_free_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

<span class="nl">err_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mlx4_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">mlx4_version</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__mlx4_init_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_dev</span>  <span class="o">*</span><span class="n">dev</span>  <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mlx4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* in SRIOV it is not allowed to unload the pf&#39;s</span>
<span class="cm">		 * driver while there are alive vf&#39;s */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_how_many_lives_vf</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Removing PF when there are assigned VF&#39;s !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mlx4_stop_sense</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_cleanup_port_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">p</span><span class="p">]);</span>
			<span class="n">mlx4_CLOSE_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">mlx4_free_resource_tracker</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">RES_TR_FREE_SLAVES_ONLY</span><span class="p">);</span>

		<span class="n">mlx4_cleanup_counters_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_mcg_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_qp_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_srq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_cq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cmd_use_polling</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_mr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_xrcd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_pd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">mlx4_free_resource_tracker</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">RES_TR_FREE_STRUCTS_ONLY</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">kar</span><span class="p">);</span>
		<span class="n">mlx4_uar_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">);</span>
		<span class="n">mlx4_cleanup_uar_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">mlx4_clear_steering</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_free_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_master</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">mlx4_multi_func_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_close_hca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">mlx4_multi_func_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mlx4_cmd_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_MSI_X</span><span class="p">)</span>
			<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_FLAG_SRIOV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling sriov</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_is_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">mlx4_free_ownership</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_restart_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlx4_remove_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__mlx4_init_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">mlx4_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; SDR */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6340</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; DDR */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x634a</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; QDR */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6354</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; DDR PCIe gen2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6732</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; QDR PCIe gen2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x673c</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; EN 10GigE */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6368</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25408 &quot;Hermon&quot; EN 10GigE PCIe gen2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6750</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25458 ConnectX EN 10GBASE-T 10GigE */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6372</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25458 ConnectX EN 10GBASE-T+Gen2 10GigE */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x675a</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT26468 ConnectX EN 10GigE PCIe gen2*/</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6764</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT26438 ConnectX EN 40GigE PCIe gen2 5GT/s */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x6746</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT26478 ConnectX2 40GigE PCIe gen2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x676e</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT25400 Family [ConnectX-2 Virtual Function] */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">),</span> <span class="n">MLX4_VF</span> <span class="p">},</span>
	<span class="cm">/* MT27500 Family [ConnectX-3] */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1003</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* MT27500 Family [ConnectX-3 Virtual Function] */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1004</span><span class="p">),</span> <span class="n">MLX4_VF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1005</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27510 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1006</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27511 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1007</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27520 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27521 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1009</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27530 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x100a</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27531 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x100b</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27540 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x100c</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27541 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x100d</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27550 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x100e</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27551 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x100f</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27560 Family */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MELLANOX</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* MT27561 Family */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mlx4_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mlx4_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mlx4_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mlx4_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mlx4_remove_one</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mlx4_verify_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">log_num_mac</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">log_num_mac</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;mlx4_core: bad num_mac: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_num_mac</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">log_num_vlan</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;mlx4_core: log_num_vlan - obsolete module param, using %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">MLX4_LOG_NUM_VLANS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">log_mtts_per_seg</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">log_mtts_per_seg</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;mlx4_core: bad log_mtts_per_seg: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_mtts_per_seg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if module param for ports type has legal combination */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_type_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="n">port_type_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Module parameter configuration ETH/IB is not supported. Switching to default configuration IB/IB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">port_type_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mlx4_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_verify_params</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mlx4_catas_init</span><span class="p">();</span>

	<span class="n">mlx4_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;mlx4&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlx4_wq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlx4_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mlx4_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlx4_driver</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">mlx4_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mlx4_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mlx4_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
