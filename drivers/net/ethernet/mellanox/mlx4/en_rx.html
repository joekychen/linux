<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › mellanox › mlx4 › en_rx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>en_rx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2007 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mlx4/cq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mlx4/qp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;mlx4_en.h&quot;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_alloc_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">skb_frags</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mlx4_en_rx_alloc</span> <span class="o">*</span><span class="n">ring_alloc</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_frag_info</span> <span class="o">*</span><span class="n">frag_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_alloc</span> <span class="o">*</span><span class="n">page_alloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">frag_info</span><span class="o">-&gt;</span><span class="n">last_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate new page */</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">__GFP_COMP</span><span class="p">,</span> <span class="n">MLX4_EN_ALLOC_ORDER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">frag_info</span><span class="o">-&gt;</span><span class="n">frag_align</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">frag_info</span><span class="o">-&gt;</span><span class="n">frag_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span>
			     <span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">frag_info</span><span class="o">-&gt;</span><span class="n">frag_size</span><span class="p">,</span>
			     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_init_allocator</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_alloc</span> <span class="o">*</span><span class="n">page_alloc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_alloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">page_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">__GFP_COMP</span><span class="p">,</span>
					       <span class="n">MLX4_EN_ALLOC_ORDER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_align</span><span class="p">;</span>
		<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Initialized allocator:%d with page:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_alloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">page_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_en_destroy_allocator</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_alloc</span> <span class="o">*</span><span class="n">page_alloc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_alloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">page_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Freeing allocator:%d count:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">page_count</span><span class="p">(</span><span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">));</span>

		<span class="n">put_page</span><span class="p">(</span><span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_alloc</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_en_init_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">*</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">skb_frags</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">+</span>
					    <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">log_rx_info</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">possible_frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set size and memtype fields */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_size</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">byte_count</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_size</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the number of used fragments does not fill up the ring stride,</span>
<span class="cm">	 * remaining (unused) fragments must be padded with null address/size</span>
<span class="cm">	 * and a special memory key */</span>
	<span class="n">possible_frags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span><span class="p">))</span> <span class="o">/</span> <span class="n">DS_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">possible_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MLX4_EN_MEMTYPE_PAD</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_prepare_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">skb_frags</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">+</span>
				      <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">log_rx_info</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_en_alloc_frag</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb_frags</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">page_alloc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">skb_frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mlx4_en_update_rx_prod_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_en_free_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">skb_frags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">log_stride</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">skb_frags</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">log_rx_info</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">nr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Freeing fragment:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Unmapping buffer at dma:0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">skb_frags</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">size</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">skb_frags</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_fill_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring_ind</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_ind</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">buf_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf_ind</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prof</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">buf_ind</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ring_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring_ind</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">ring_ind</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_en_prepare_rx_desc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span>
						    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">&lt;</span> <span class="n">MLX4_EN_MIN_RX_SIZE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to allocate &quot;</span>
						     <span class="s">&quot;enough rx buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">new_size</span> <span class="o">=</span> <span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>
					<span class="n">en_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Only %d buffers allocated &quot;</span>
						      <span class="s">&quot;reducing ring size to %d&quot;</span><span class="p">,</span>
						<span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">reduce_rings</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">reduce_rings:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ring_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring_ind</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">ring_ind</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">&gt;</span> <span class="n">new_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span><span class="o">--</span><span class="p">;</span>
			<span class="n">mlx4_en_free_rx_desc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_en_free_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Freeing Rx buf - cons:%d prod:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">);</span>

	<span class="cm">/* Unmap and free Rx buffers */</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">!=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size_mask</span><span class="p">;</span>
		<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Processing descriptor:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">mlx4_en_free_rx_desc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="o">++</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_en_create_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">stride</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>


	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">size_mask</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">log_stride</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">+</span> <span class="n">TXBB_SIZE</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">MLX4_EN_MAX_RX_FRAGS</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">skb_frag_struct</span><span class="p">));</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Allocated rx_info ring at addr:%p size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_alloc_hwq_res</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">,</span>
				 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ring</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_en_map_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to map RX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_hwq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">direct</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_hwq:</span>
	<span class="n">mlx4_free_hwq_res</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
<span class="nl">err_ring:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_en_activate_rx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring_ind</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">DS_SIZE</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring_ind</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">ring_ind</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">];</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">cqn</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_cq</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">].</span><span class="n">mcq</span><span class="p">.</span><span class="n">cqn</span><span class="p">;</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">&lt;=</span> <span class="n">TXBB_SIZE</span><span class="p">)</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">TXBB_SIZE</span><span class="p">;</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">log_stride</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">mlx4_en_update_rx_prod_db</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

		<span class="cm">/* Initailize all descriptors */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mlx4_en_init_rx_desc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* Initialize page allocators */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_en_init_allocator</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed initializing ring allocator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">&lt;=</span> <span class="n">TXBB_SIZE</span><span class="p">)</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">-=</span> <span class="n">TXBB_SIZE</span><span class="p">;</span>
			<span class="n">ring_ind</span><span class="o">--</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_allocator</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_en_fill_rx_buffers</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_buffers</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring_ind</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">ring_ind</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">];</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">size_mask</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mlx4_en_update_rx_prod_db</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_buffers:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ring_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring_ind</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">ring_ind</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mlx4_en_free_rx_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">]);</span>

	<span class="n">ring_ind</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">err_allocator:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ring_ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">].</span><span class="n">stride</span> <span class="o">&lt;=</span> <span class="n">TXBB_SIZE</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">].</span><span class="n">buf</span> <span class="o">-=</span> <span class="n">TXBB_SIZE</span><span class="p">;</span>
		<span class="n">mlx4_en_destroy_allocator</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_ind</span><span class="p">]);</span>
		<span class="n">ring_ind</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mlx4_en_destroy_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">stride</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>

	<span class="n">mlx4_en_unmap_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">mlx4_free_hwq_res</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="n">stride</span> <span class="o">+</span> <span class="n">TXBB_SIZE</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mlx4_en_deactivate_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlx4_en_free_rx_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">&lt;=</span> <span class="n">TXBB_SIZE</span><span class="p">)</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">-=</span> <span class="n">TXBB_SIZE</span><span class="p">;</span>
	<span class="n">mlx4_en_destroy_allocator</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Unmap a completed descriptor and free unused pages */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_complete_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">skb_frags</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mlx4_en_rx_alloc</span> <span class="o">*</span><span class="n">page_alloc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">skb_frags_rx</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_frag_info</span> <span class="o">*</span><span class="n">frag_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* Collect used fragments while replacing them in the HW descirptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">nr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frag_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">frag_info</span><span class="o">-&gt;</span><span class="n">frag_prefix_size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Save page reference in skb */</span>
		<span class="n">__skb_frag_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_frags_rx</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">skb_frags</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
		<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_frags_rx</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">skb_frags</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="n">skb_frags_rx</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">skb_frags</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">frag_info</span><span class="o">-&gt;</span><span class="n">frag_stride</span><span class="p">;</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>

		<span class="cm">/* Allocate a replacement page */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlx4_en_alloc_frag</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb_frags</span><span class="p">,</span> <span class="n">page_alloc</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="cm">/* Unmap buffer */</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_frags_rx</span><span class="p">[</span><span class="n">nr</span><span class="p">]),</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Adjust size of last fragment to match actual length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_frags_rx</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
			<span class="n">length</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">frag_prefix_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* Drop all accumulated fragments (which have already been replaced in</span>
<span class="cm">	 * the descriptor) of this packet; remaining fragments are reused... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
		<span class="n">__skb_frag_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_frags_rx</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">mlx4_en_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">skb_frags</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">mlx4_en_rx_alloc</span> <span class="o">*</span><span class="n">page_alloc</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used_frags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SMALL_PACKET_SIZE</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_dbg</span><span class="p">(</span><span class="n">RX_ERR</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed allocating skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* Get pointer to first fragment so we could copy the headers into the</span>
<span class="cm">	 * (linear part of the) skb */</span>
	<span class="n">va</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">skb_frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb_frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">SMALL_PACKET_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are copying all relevant data to the skb - temporarily</span>
<span class="cm">		 * synch buffers for the copy */</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					   <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Move relevant fragments to skb */</span>
		<span class="n">used_frags</span> <span class="o">=</span> <span class="n">mlx4_en_complete_rx_desc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb_frags</span><span class="p">,</span>
						      <span class="n">skb</span><span class="p">,</span> <span class="n">page_alloc</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">used_frags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">used_frags</span><span class="p">;</span>

		<span class="cm">/* Copy headers into the skb linear buffer */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">HEADER_COPY_SIZE</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">HEADER_COPY_SIZE</span><span class="p">;</span>

		<span class="cm">/* Skip headers in first fragment */</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">+=</span> <span class="n">HEADER_COPY_SIZE</span><span class="p">;</span>

		<span class="cm">/* Adjust size of first fragment */</span>
		<span class="n">skb_frag_size_sub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">HEADER_COPY_SIZE</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">HEADER_COPY_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">validate_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MLX4_LOOPBACK_TEST_PAYLOAD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_loopback</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Loopback found */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">loopback_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out_loopback:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_en_process_rx_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_en_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">skb_frags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">polled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ip_summed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ethh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">s_mac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_up</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We assume a 1:1 mapping between CQEs and Rx descriptors, so Rx</span>
<span class="cm">	 * descriptor offset can be deduced from the CQE index instead of</span>
<span class="cm">	 * reading &#39;cqe-&gt;index&#39; */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size_mask</span><span class="p">;</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* Process all completed CQEs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">XNOR</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OWNER_MASK</span><span class="p">,</span>
		    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">skb_frags</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_info</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">log_rx_info</span><span class="p">);</span>
		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">log_stride</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * make sure we read the CQE after we read the ownership bit</span>
<span class="cm">		 */</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="cm">/* Drop packet on bad receive or bad checksum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span>
						<span class="n">MLX4_CQE_OPCODE_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;CQE completed in error - vendor &quot;</span>
				  <span class="s">&quot;syndrom:%d syndrom:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="p">((</span><span class="k">struct</span> <span class="n">mlx4_err_cqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vendor_err_syndrome</span><span class="p">,</span>
				  <span class="p">((</span><span class="k">struct</span> <span class="n">mlx4_err_cqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syndrome</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">badfcs_enc</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_BAD_FCS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">en_dbg</span><span class="p">(</span><span class="n">RX_ERR</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Accepted frame with bad FCS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Get pointer to first fragment since we haven&#39;t skb yet and</span>
<span class="cm">		 * cast it to ethhdr struct */</span>
		<span class="n">ethh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">page_address</span><span class="p">(</span><span class="n">skb_frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span>
					 <span class="n">skb_frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">s_mac</span> <span class="o">=</span> <span class="n">mlx4_en_mac_to_u64</span><span class="p">(</span><span class="n">ethh</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">);</span>

		<span class="cm">/* If source MAC is equal to our own MAC and not performing</span>
<span class="cm">		 * the selftest or flb disabled - drop the packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s_mac</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span> <span class="o">||</span>
			 <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">validate_loopback</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Packet is OK - process it.</span>
<span class="cm">		 */</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">fcs_del</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">MLX4_CQE_STATUS_IPOK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">csum_ok</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* This packet is eligible for LRO if it is:</span>
<span class="cm">				 * - DIX Ethernet (type interpretation)</span>
<span class="cm">				 * - TCP/IP (v4)</span>
<span class="cm">				 * - without IP options</span>
<span class="cm">				 * - not an IP fragment */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_GRO</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">gro_skb</span> <span class="o">=</span> <span class="n">napi_get_frags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gro_skb</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

					<span class="n">nr</span> <span class="o">=</span> <span class="n">mlx4_en_complete_rx_desc</span><span class="p">(</span>
						<span class="n">priv</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span>
						<span class="n">skb_frags</span><span class="p">,</span> <span class="n">gro_skb</span><span class="p">,</span>
						<span class="n">ring</span><span class="o">-&gt;</span><span class="n">page_alloc</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

					<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">gro_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
					<span class="n">gro_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
					<span class="n">gro_skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
					<span class="n">gro_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_my_qpn</span> <span class="o">&amp;</span>
					    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MLX4_CQE_VLAN_PRESENT_MASK</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">u16</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">sl_vid</span><span class="p">);</span>

						<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">gro_skb</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
						<span class="n">gro_skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immed_rss_invalid</span><span class="p">);</span>

					<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">gro_skb</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
					<span class="n">napi_gro_frags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

					<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* LRO not possible, complete processing here */</span>
				<span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">csum_none</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">csum_none</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">mlx4_en_rx_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb_frags</span><span class="p">,</span>
				     <span class="n">ring</span><span class="o">-&gt;</span><span class="n">page_alloc</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">validate_loopback</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">validate_loopback</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">ip_summed</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immed_rss_invalid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_my_qpn</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MLX4_CQE_VLAN_PRESENT_MASK</span><span class="p">)</span>
			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">sl_vid</span><span class="p">));</span>

		<span class="cm">/* Push it up the stack */</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="nl">next:</span>
		<span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size_mask</span><span class="p">;</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">polled</span> <span class="o">==</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We are here because we reached the NAPI budget -</span>
<span class="cm">			 * flush only pending LRO sessions */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">AVG_PERF_COUNTER</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pstats</span><span class="p">.</span><span class="n">rx_coal_avg</span><span class="p">,</span> <span class="n">polled</span><span class="p">);</span>
	<span class="n">mlx4_cq_set_ci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span> <span class="cm">/* ensure HW sees CQ consumer before we post new buffers */</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">+=</span> <span class="n">polled</span><span class="p">;</span> <span class="cm">/* Polled descriptors were realocated in place */</span>
	<span class="n">mlx4_en_update_rx_prod_db</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">polled</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">mlx4_en_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cq</span> <span class="o">*</span><span class="n">mcq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_cq</span> <span class="o">*</span><span class="n">cq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mcq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_en_cq</span><span class="p">,</span> <span class="n">mcq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_up</span><span class="p">)</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mlx4_en_arm_cq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Rx CQ polling - called by NAPI */</span>
<span class="kt">int</span> <span class="nf">mlx4_en_poll_rx_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_cq</span> <span class="o">*</span><span class="n">cq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_en_cq</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">done</span> <span class="o">=</span> <span class="n">mlx4_en_process_rx_cq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="cm">/* If we used up all the quota - we&#39;re probably not done yet... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="n">budget</span><span class="p">)</span>
		<span class="n">INC_PERF_COUNTER</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pstats</span><span class="p">.</span><span class="n">napi_quota</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Done for now */</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">mlx4_en_arm_cq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Calculate the last offset position that accommodates a full fragment</span>
<span class="cm"> * (assuming fagment size = stride-align) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_last_alloc_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">stride</span><span class="p">,</span> <span class="n">u16</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">res</span> <span class="o">=</span> <span class="n">MLX4_EN_ALLOC_SIZE</span> <span class="o">%</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MLX4_EN_ALLOC_SIZE</span> <span class="o">-</span> <span class="n">stride</span> <span class="o">-</span> <span class="n">res</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>

	<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Calculated last offset for stride:%d align:%d &quot;</span>
			    <span class="s">&quot;res:%d offset:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">frag_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FRAG_SZ0</span><span class="p">,</span>
	<span class="n">FRAG_SZ1</span><span class="p">,</span>
	<span class="n">FRAG_SZ2</span><span class="p">,</span>
	<span class="n">FRAG_SZ3</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">mlx4_en_calc_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">eff_mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span> <span class="o">+</span> <span class="n">ETH_LLC_SNAP_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">&lt;</span> <span class="n">eff_mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_size</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">eff_mtu</span> <span class="o">&gt;</span> <span class="n">buf_size</span> <span class="o">+</span> <span class="n">frag_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">?</span>
				<span class="n">frag_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">eff_mtu</span> <span class="o">-</span> <span class="n">buf_size</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_prefix_size</span> <span class="o">=</span> <span class="n">buf_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_align</span> <span class="o">=</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_stride</span> <span class="o">=</span>
				<span class="n">ALIGN</span><span class="p">(</span><span class="n">frag_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">,</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_stride</span> <span class="o">=</span>
				<span class="n">ALIGN</span><span class="p">(</span><span class="n">frag_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_offset</span> <span class="o">=</span> <span class="n">mlx4_en_last_alloc_offset</span><span class="p">(</span>
						<span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_stride</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_align</span><span class="p">);</span>
		<span class="n">buf_size</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_size</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span> <span class="o">=</span> <span class="n">eff_mtu</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">log_rx_info</span> <span class="o">=</span> <span class="n">ROUNDUP_LOG2</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">skb_frag_struct</span><span class="p">));</span>

	<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Rx buffer scatter-list (effective-mtu:%d &quot;</span>
		  <span class="s">&quot;num_frags:%d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eff_mtu</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;  frag:%d - size:%d prefix:%d align:%d &quot;</span>
				<span class="s">&quot;stride:%d last_offset:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_size</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_prefix_size</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_align</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_stride</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* RSS related functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_en_config_rss_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qpn</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mlx4_en_rx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">mlx4_qp_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mlx4_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_qp_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">context</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">context</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to allocate qp context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_qp_alloc</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qpn</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to allocate qp #%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">mlx4_en_sqp_event</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
	<span class="n">mlx4_en_fill_qp_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">qpn</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">cqn</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">db_rec_addr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* Cancel FCS removal if FW allows */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MLX4_DEV_CAP_FLAG_FCS_KEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">param3</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">fcs_del</span> <span class="o">=</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">fcs_del</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_qp_to_ready</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wqres</span><span class="p">.</span><span class="n">mtt</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_qp_remove</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
		<span class="n">mlx4_qp_free</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mlx4_en_update_rx_prod_db</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocate rx qp&#39;s and configure them according to rss map */</span>
<span class="kt">int</span> <span class="nf">mlx4_en_config_rss_steer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rss_map</span> <span class="o">*</span><span class="n">rss_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rss_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_qp_context</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_rss_context</span> <span class="o">*</span><span class="n">rss_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rss_rings</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rss_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">MLX4_RSS_IPV4</span> <span class="o">|</span> <span class="n">MLX4_RSS_TCP_IPV4</span> <span class="o">|</span> <span class="n">MLX4_RSS_IPV6</span> <span class="o">|</span>
			<span class="n">MLX4_RSS_TCP_IPV6</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">qpn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">good_qps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">rsskey</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xD181C62C</span><span class="p">,</span> <span class="mh">0xF7F4DB5B</span><span class="p">,</span> <span class="mh">0x1983A2FC</span><span class="p">,</span>
				<span class="mh">0x943E1ADB</span><span class="p">,</span> <span class="mh">0xD9389E6B</span><span class="p">,</span> <span class="mh">0xD1039C2C</span><span class="p">,</span> <span class="mh">0xA74499AD</span><span class="p">,</span>
				<span class="mh">0x593D56D9</span><span class="p">,</span> <span class="mh">0xF3253C06</span><span class="p">,</span> <span class="mh">0x2ADC1FFC</span><span class="p">};</span>

	<span class="n">en_dbg</span><span class="p">(</span><span class="n">DRV</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Configuring rss steering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_qp_reserve_range</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed reserving %d qps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qpn</span> <span class="o">=</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">base_qpn</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_en_config_rss_qp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">qpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rss_err</span><span class="p">;</span>

		<span class="o">++</span><span class="n">good_qps</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure RSS indirection qp */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_qp_alloc</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en_err</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to allocate RSS indirection QP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rss_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">mlx4_en_sqp_event</span><span class="p">;</span>
	<span class="n">mlx4_en_fill_qp_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cqn</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prof</span><span class="o">-&gt;</span><span class="n">rss_rings</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prof</span><span class="o">-&gt;</span><span class="n">rss_rings</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">)</span>
		<span class="n">rss_rings</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rss_rings</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prof</span><span class="o">-&gt;</span><span class="n">rss_rings</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_qp_context</span><span class="p">,</span> <span class="n">pri_path</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">MLX4_RSS_OFFSET_IN_QPC_PRI_PATH</span><span class="p">;</span>
	<span class="n">rss_context</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">base_qpn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">rss_rings</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">));</span>
	<span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">default_qpn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">udp_rss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rss_mask</span> <span class="o">|=</span>  <span class="n">MLX4_RSS_UDP_IPV4</span> <span class="o">|</span> <span class="n">MLX4_RSS_UDP_IPV6</span><span class="p">;</span>
		<span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">base_qpn_udp</span> <span class="o">=</span> <span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">default_qpn</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">rss_mask</span><span class="p">;</span>
	<span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">hash_fn</span> <span class="o">=</span> <span class="n">MLX4_RSS_HASH_TOP</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rss_context</span><span class="o">-&gt;</span><span class="n">rss_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rsskey</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_qp_to_ready</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">mtt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">indir_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">indir_err:</span>
	<span class="n">mlx4_qp_modify</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_state</span><span class="p">,</span>
		       <span class="n">MLX4_QP_STATE_RST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>
	<span class="n">mlx4_qp_remove</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>
	<span class="n">mlx4_qp_free</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>
<span class="nl">rss_err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">good_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_qp_modify</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">MLX4_QP_STATE_RST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">mlx4_qp_remove</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">mlx4_qp_free</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">mlx4_qp_release_range</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mlx4_en_release_rss_steer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_en_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_en_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_en_rss_map</span> <span class="o">*</span><span class="n">rss_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rss_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mlx4_qp_modify</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_state</span><span class="p">,</span>
		       <span class="n">MLX4_QP_STATE_RST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>
	<span class="n">mlx4_qp_remove</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>
	<span class="n">mlx4_qp_free</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">indir_qp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_qp_modify</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">MLX4_QP_STATE_RST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">mlx4_qp_remove</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">mlx4_qp_free</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">qps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">mlx4_qp_release_range</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rss_map</span><span class="o">-&gt;</span><span class="n">base_qpn</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
