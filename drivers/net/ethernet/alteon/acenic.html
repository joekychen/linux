<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › alteon › acenic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>acenic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * acenic.c: Linux driver for the Alteon AceNIC Gigabit Ethernet card</span>
<span class="cm"> *           and other Tigon based cards.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1998-2002 by Jes Sorensen, &lt;jes@trained-monkey.org&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Alteon and 3Com for providing hardware and documentation</span>
<span class="cm"> * enabling me to write this driver.</span>
<span class="cm"> *</span>
<span class="cm"> * A mailing list for discussing the use of this driver has been</span>
<span class="cm"> * setup, please subscribe to the lists if you have any questions</span>
<span class="cm"> * about the driver. Send mail to linux-acenic-help@sunsite.auc.dk to</span>
<span class="cm"> * see how to subscribe.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Additional credits:</span>
<span class="cm"> *   Pete Wyckoff &lt;wyckoff@ca.sandia.gov&gt;: Initial Linux/Alpha and trace</span>
<span class="cm"> *       dump support. The trace dump support has not been</span>
<span class="cm"> *       integrated yet however.</span>
<span class="cm"> *   Troy Benjegerdes: Big Endian (PPC) patches.</span>
<span class="cm"> *   Nate Stahl: Better out of memory handling and stats support.</span>
<span class="cm"> *   Aman Singla: Nasty race between interrupt handler and tx code dealing</span>
<span class="cm"> *                with &#39;testing the tx_ret_csm and setting tx_full&#39;</span>
<span class="cm"> *   David S. Miller &lt;davem@redhat.com&gt;: conversion to new PCI dma mapping</span>
<span class="cm"> *                                       infrastructure and Sparc support</span>
<span class="cm"> *   Pierrick Pinasseau (CERN): For lending me an Ultra 5 to test the</span>
<span class="cm"> *                              driver under Linux/Sparc64</span>
<span class="cm"> *   Matt Domsch &lt;Matt_Domsch@dell.com&gt;: Detect Alteon 1000baseT cards</span>
<span class="cm"> *                                       ETHTOOL_GDRVINFO support</span>
<span class="cm"> *   Chip Salzenberg &lt;chip@valinux.com&gt;: Fix race condition between tx</span>
<span class="cm"> *                                       handler and close() cleanup.</span>
<span class="cm"> *   Ken Aaker &lt;kdaaker@rchland.vnet.ibm.com&gt;: Correct check for whether</span>
<span class="cm"> *                                       memory mapped IO is enabled to</span>
<span class="cm"> *                                       make the driver work on RS/6000.</span>
<span class="cm"> *   Takayoshi Kouchi &lt;kouchi@hpc.bs1.fc.nec.co.jp&gt;: Identifying problem</span>
<span class="cm"> *                                       where the driver would disable</span>
<span class="cm"> *                                       bus master mode if it had to disable</span>
<span class="cm"> *                                       write and invalidate.</span>
<span class="cm"> *   Stephen Hack &lt;stephen_hack@hp.com&gt;: Fixed ace_set_mac_addr for little</span>
<span class="cm"> *                                       endian systems.</span>
<span class="cm"> *   Val Henson &lt;vhenson@esscom.com&gt;:    Reset Jumbo skb producer and</span>
<span class="cm"> *                                       rx producer index when</span>
<span class="cm"> *                                       flushing the Jumbo ring.</span>
<span class="cm"> *   Hans Grobler &lt;grobh@sun.ac.za&gt;:     Memory leak fixes in the</span>
<span class="cm"> *                                       driver init path.</span>
<span class="cm"> *   Grant Grundler &lt;grundler@cup.hp.com&gt;: PCI write posting fixes.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#ifdef SIOCETHTOOL</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>


<span class="cp">#define DRV_NAME &quot;acenic&quot;</span>

<span class="cp">#undef INDEX_DEBUG</span>

<span class="cp">#ifdef CONFIG_ACENIC_OMIT_TIGON_I</span>
<span class="cp">#define ACE_IS_TIGON_I(ap)	0</span>
<span class="cp">#define ACE_TX_RING_ENTRIES(ap)	MAX_TX_RING_ENTRIES</span>
<span class="cp">#else</span>
<span class="cp">#define ACE_IS_TIGON_I(ap)	(ap-&gt;version == 1)</span>
<span class="cp">#define ACE_TX_RING_ENTRIES(ap)	ap-&gt;tx_ring_entries</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PCI_VENDOR_ID_ALTEON</span>
<span class="cp">#define PCI_VENDOR_ID_ALTEON		0x12ae</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_ALTEON_ACENIC_FIBRE</span>
<span class="cp">#define PCI_DEVICE_ID_ALTEON_ACENIC_FIBRE  0x0001</span>
<span class="cp">#define PCI_DEVICE_ID_ALTEON_ACENIC_COPPER 0x0002</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_3COM_3C985</span>
<span class="cp">#define PCI_DEVICE_ID_3COM_3C985	0x0001</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_VENDOR_ID_NETGEAR</span>
<span class="cp">#define PCI_VENDOR_ID_NETGEAR		0x1385</span>
<span class="cp">#define PCI_DEVICE_ID_NETGEAR_GA620	0x620a</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NETGEAR_GA620T</span>
<span class="cp">#define PCI_DEVICE_ID_NETGEAR_GA620T	0x630a</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Farallon used the DEC vendor ID by mistake and they seem not</span>
<span class="cm"> * to care - stinky!</span>
<span class="cm"> */</span>
<span class="cp">#ifndef PCI_DEVICE_ID_FARALLON_PN9000SX</span>
<span class="cp">#define PCI_DEVICE_ID_FARALLON_PN9000SX	0x1a</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_FARALLON_PN9100T</span>
<span class="cp">#define PCI_DEVICE_ID_FARALLON_PN9100T  0xfa</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_VENDOR_ID_SGI</span>
<span class="cp">#define PCI_VENDOR_ID_SGI		0x10a9</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_SGI_ACENIC</span>
<span class="cp">#define PCI_DEVICE_ID_SGI_ACENIC	0x0009</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">acenic_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ALTEON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ALTEON_ACENIC_FIBRE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ALTEON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ALTEON_ACENIC_COPPER</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3C985</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETGEAR</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETGEAR_GA620</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETGEAR</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETGEAR_GA620T</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * Farallon used the DEC vendor ID on their cards incorrectly,</span>
<span class="cm">	 * then later Alteon&#39;s ID.</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARALLON_PN9000SX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ALTEON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARALLON_PN9100T</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SGI_ACENIC</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">acenic_pci_tbl</span><span class="p">);</span>

<span class="cp">#define ace_sync_irq(irq)	synchronize_irq(irq)</span>

<span class="cp">#ifndef offset_in_page</span>
<span class="cp">#define offset_in_page(ptr)	((unsigned long)(ptr) &amp; ~PAGE_MASK)</span>
<span class="cp">#endif</span>

<span class="cp">#define ACE_MAX_MOD_PARMS	8</span>
<span class="cp">#define BOARD_IDX_STATIC	0</span>
<span class="cp">#define BOARD_IDX_OVERFLOW	-1</span>

<span class="cp">#include &quot;acenic.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * These must be defined before the firmware is included.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_TEXT_LEN	96*1024</span>
<span class="cp">#define MAX_RODATA_LEN	8*1024</span>
<span class="cp">#define MAX_DATA_LEN	2*1024</span>

<span class="cp">#ifndef tigon2FwReleaseLocal</span>
<span class="cp">#define tigon2FwReleaseLocal 0</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This driver currently supports Tigon I and Tigon II based cards</span>
<span class="cm"> * including the Alteon AceNIC, the 3Com 3C985[B] and NetGear</span>
<span class="cm"> * GA620. The driver should also work on the SGI, DEC and Farallon</span>
<span class="cm"> * versions of the card, however I have not been able to test that</span>
<span class="cm"> * myself.</span>
<span class="cm"> *</span>
<span class="cm"> * This card is really neat, it supports receive hardware checksumming</span>
<span class="cm"> * and jumbo frames (up to 9000 bytes) and does a lot of work in the</span>
<span class="cm"> * firmware. Also the programming interface is quite neat, except for</span>
<span class="cm"> * the parts dealing with the i2c eeprom on the card ;-)</span>
<span class="cm"> *</span>
<span class="cm"> * Using jumbo frames:</span>
<span class="cm"> *</span>
<span class="cm"> * To enable jumbo frames, simply specify an mtu between 1500 and 9000</span>
<span class="cm"> * bytes to ifconfig. Jumbo frames can be enabled or disabled at any time</span>
<span class="cm"> * by running `ifconfig eth&lt;X&gt; mtu &lt;MTU&gt;&#39; with &lt;X&gt; being the Ethernet</span>
<span class="cm"> * interface number and &lt;MTU&gt; being the MTU value.</span>
<span class="cm"> *</span>
<span class="cm"> * Module parameters:</span>
<span class="cm"> *</span>
<span class="cm"> * When compiled as a loadable module, the driver allows for a number</span>
<span class="cm"> * of module parameters to be specified. The driver supports the</span>
<span class="cm"> * following module parameters:</span>
<span class="cm"> *</span>
<span class="cm"> *  trace=&lt;val&gt; - Firmware trace level. This requires special traced</span>
<span class="cm"> *                firmware to replace the firmware supplied with</span>
<span class="cm"> *                the driver - for debugging purposes only.</span>
<span class="cm"> *</span>
<span class="cm"> *  link=&lt;val&gt;  - Link state. Normally you want to use the default link</span>
<span class="cm"> *                parameters set by the driver. This can be used to</span>
<span class="cm"> *                override these in case your switch doesn&#39;t negotiate</span>
<span class="cm"> *                the link properly. Valid values are:</span>
<span class="cm"> *         0x0001 - Force half duplex link.</span>
<span class="cm"> *         0x0002 - Do not negotiate line speed with the other end.</span>
<span class="cm"> *         0x0010 - 10Mbit/sec link.</span>
<span class="cm"> *         0x0020 - 100Mbit/sec link.</span>
<span class="cm"> *         0x0040 - 1000Mbit/sec link.</span>
<span class="cm"> *         0x0100 - Do not negotiate flow control.</span>
<span class="cm"> *         0x0200 - Enable RX flow control Y</span>
<span class="cm"> *         0x0400 - Enable TX flow control Y (Tigon II NICs only).</span>
<span class="cm"> *                Default value is 0x0270, ie. enable link+flow</span>
<span class="cm"> *                control negotiation. Negotiating the highest</span>
<span class="cm"> *                possible link speed with RX flow control enabled.</span>
<span class="cm"> *</span>
<span class="cm"> *                When disabling link speed negotiation, only one link</span>
<span class="cm"> *                speed is allowed to be specified!</span>
<span class="cm"> *</span>
<span class="cm"> *  tx_coal_tick=&lt;val&gt; - number of coalescing clock ticks (us) allowed</span>
<span class="cm"> *                to wait for more packets to arive before</span>
<span class="cm"> *                interrupting the host, from the time the first</span>
<span class="cm"> *                packet arrives.</span>
<span class="cm"> *</span>
<span class="cm"> *  rx_coal_tick=&lt;val&gt; - number of coalescing clock ticks (us) allowed</span>
<span class="cm"> *                to wait for more packets to arive in the transmit ring,</span>
<span class="cm"> *                before interrupting the host, after transmitting the</span>
<span class="cm"> *                first packet in the ring.</span>
<span class="cm"> *</span>
<span class="cm"> *  max_tx_desc=&lt;val&gt; - maximum number of transmit descriptors</span>
<span class="cm"> *                (packets) transmitted before interrupting the host.</span>
<span class="cm"> *</span>
<span class="cm"> *  max_rx_desc=&lt;val&gt; - maximum number of receive descriptors</span>
<span class="cm"> *                (packets) received before interrupting the host.</span>
<span class="cm"> *</span>
<span class="cm"> *  tx_ratio=&lt;val&gt; - 7 bit value (0 - 63) specifying the split in 64th</span>
<span class="cm"> *                increments of the NIC&#39;s on board memory to be used for</span>
<span class="cm"> *                transmit and receive buffers. For the 1MB NIC app. 800KB</span>
<span class="cm"> *                is available, on the 1/2MB NIC app. 300KB is available.</span>
<span class="cm"> *                68KB will always be available as a minimum for both</span>
<span class="cm"> *                directions. The default value is a 50/50 split.</span>
<span class="cm"> *  dis_pci_mem_inval=&lt;val&gt; - disable PCI memory write and invalidate</span>
<span class="cm"> *                operations, default (1) is to always disable this as</span>
<span class="cm"> *                that is what Alteon does on NT. I have not been able</span>
<span class="cm"> *                to measure any real performance differences with</span>
<span class="cm"> *                this on my systems. Set &lt;val&gt;=0 if you want to</span>
<span class="cm"> *                enable these operations.</span>
<span class="cm"> *</span>
<span class="cm"> * If you use more than one NIC, specify the parameters for the</span>
<span class="cm"> * individual NICs with a comma, ie. trace=0,0x00001fff,0 you want to</span>
<span class="cm"> * run tracing on NIC #2 but not on NIC #1 and #3.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *</span>
<span class="cm"> * - Proper multicast support.</span>
<span class="cm"> * - NIC dump support.</span>
<span class="cm"> * - More tuning parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * The mini ring is not used under Linux and I am not sure it makes sense</span>
<span class="cm"> * to actually use it.</span>
<span class="cm"> *</span>
<span class="cm"> * New interrupt handler strategy:</span>
<span class="cm"> *</span>
<span class="cm"> * The old interrupt handler worked using the traditional method of</span>
<span class="cm"> * replacing an skbuff with a new one when a packet arrives. However</span>
<span class="cm"> * the rx rings do not need to contain a static number of buffer</span>
<span class="cm"> * descriptors, thus it makes sense to move the memory allocation out</span>
<span class="cm"> * of the main interrupt handler and do it in a bottom half handler</span>
<span class="cm"> * and only allocate new buffers when the number of buffers in the</span>
<span class="cm"> * ring is below a certain threshold. In order to avoid starving the</span>
<span class="cm"> * NIC under heavy load it is however necessary to force allocation</span>
<span class="cm"> * when hitting a minimum threshold. The strategy for alloction is as</span>
<span class="cm"> * follows:</span>
<span class="cm"> *</span>
<span class="cm"> *     RX_LOW_BUF_THRES    - allocate buffers in the bottom half</span>
<span class="cm"> *     RX_PANIC_LOW_THRES  - we are very low on buffers, allocate</span>
<span class="cm"> *                           the buffers in the interrupt handler</span>
<span class="cm"> *     RX_RING_THRES       - maximum number of buffers in the rx ring</span>
<span class="cm"> *     RX_MINI_THRES       - maximum number of buffers in the mini ring</span>
<span class="cm"> *     RX_JUMBO_THRES      - maximum number of buffers in the jumbo ring</span>
<span class="cm"> *</span>
<span class="cm"> * One advantagous side effect of this allocation approach is that the</span>
<span class="cm"> * entire rx processing can be done without holding any spin lock</span>
<span class="cm"> * since the rx rings and registers are totally independent of the tx</span>
<span class="cm"> * ring and its registers.  This of course includes the kmalloc&#39;s of</span>
<span class="cm"> * new skb&#39;s. Thus start_xmit can run in parallel with rx processing</span>
<span class="cm"> * and the memory allocation on SMP systems.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that running the skb reallocation in a bottom half opens up</span>
<span class="cm"> * another can of races which needs to be handled properly. In</span>
<span class="cm"> * particular it can happen that the interrupt handler tries to run</span>
<span class="cm"> * the reallocation while the bottom half is either running on another</span>
<span class="cm"> * CPU or was interrupted on the same CPU. To get around this the</span>
<span class="cm"> * driver uses bitops to prevent the reallocation routines from being</span>
<span class="cm"> * reentered.</span>
<span class="cm"> *</span>
<span class="cm"> * TX handling can also be done without holding any spin lock, wheee</span>
<span class="cm"> * this is fun! since tx_ret_csm is only written to by the interrupt</span>
<span class="cm"> * handler. The case to be aware of is when shutting down the device</span>
<span class="cm"> * and cleaning up where it is necessary to make sure that</span>
<span class="cm"> * start_xmit() is not running while this is happening. Well DaveM</span>
<span class="cm"> * informs me that this case is already protected against ... bye bye</span>
<span class="cm"> * Mr. Spin Lock, it was nice to know you.</span>
<span class="cm"> *</span>
<span class="cm"> * TX interrupts are now partly disabled so the NIC will only generate</span>
<span class="cm"> * TX interrupts for the number of coal ticks, not for the number of</span>
<span class="cm"> * TX packets in the queue. This should reduce the number of TX only,</span>
<span class="cm"> * ie. when no RX processing is done, interrupts seen.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Threshold values for RX buffer allocation - the low water marks for</span>
<span class="cm"> * when to start refilling the rings are set to 75% of the ring</span>
<span class="cm"> * sizes. It seems to make sense to refill the rings entirely from the</span>
<span class="cm"> * intrrupt handler once it gets below the panic threshold, that way</span>
<span class="cm"> * we don&#39;t risk that the refilling is moved to another CPU when the</span>
<span class="cm"> * one running the interrupt handler just got the slab code hot in its</span>
<span class="cm"> * cache.</span>
<span class="cm"> */</span>
<span class="cp">#define RX_RING_SIZE		72</span>
<span class="cp">#define RX_MINI_SIZE		64</span>
<span class="cp">#define RX_JUMBO_SIZE		48</span>

<span class="cp">#define RX_PANIC_STD_THRES	16</span>
<span class="cp">#define RX_PANIC_STD_REFILL	(3*RX_PANIC_STD_THRES)/2</span>
<span class="cp">#define RX_LOW_STD_THRES	(3*RX_RING_SIZE)/4</span>
<span class="cp">#define RX_PANIC_MINI_THRES	12</span>
<span class="cp">#define RX_PANIC_MINI_REFILL	(3*RX_PANIC_MINI_THRES)/2</span>
<span class="cp">#define RX_LOW_MINI_THRES	(3*RX_MINI_SIZE)/4</span>
<span class="cp">#define RX_PANIC_JUMBO_THRES	6</span>
<span class="cp">#define RX_PANIC_JUMBO_REFILL	(3*RX_PANIC_JUMBO_THRES)/2</span>
<span class="cp">#define RX_LOW_JUMBO_THRES	(3*RX_JUMBO_SIZE)/4</span>


<span class="cm">/*</span>
<span class="cm"> * Size of the mini ring entries, basically these just should be big</span>
<span class="cm"> * enough to take TCP ACKs</span>
<span class="cm"> */</span>
<span class="cp">#define ACE_MINI_SIZE		100</span>

<span class="cp">#define ACE_MINI_BUFSIZE	ACE_MINI_SIZE</span>
<span class="cp">#define ACE_STD_BUFSIZE		(ACE_STD_MTU + ETH_HLEN + 4)</span>
<span class="cp">#define ACE_JUMBO_BUFSIZE	(ACE_JUMBO_MTU + ETH_HLEN + 4)</span>

<span class="cm">/*</span>
<span class="cm"> * There seems to be a magic difference in the effect between 995 and 996</span>
<span class="cm"> * but little difference between 900 and 995 ... no idea why.</span>
<span class="cm"> *</span>
<span class="cm"> * There is now a default set of tuning parameters which is set, depending</span>
<span class="cm"> * on whether or not the user enables Jumbo frames. It&#39;s assumed that if</span>
<span class="cm"> * Jumbo frames are enabled, the user wants optimal tuning for that case.</span>
<span class="cm"> */</span>
<span class="cp">#define DEF_TX_COAL		400 </span><span class="cm">/* 996 */</span><span class="cp"></span>
<span class="cp">#define DEF_TX_MAX_DESC		60  </span><span class="cm">/* was 40 */</span><span class="cp"></span>
<span class="cp">#define DEF_RX_COAL		120 </span><span class="cm">/* 1000 */</span><span class="cp"></span>
<span class="cp">#define DEF_RX_MAX_DESC		25</span>
<span class="cp">#define DEF_TX_RATIO		21 </span><span class="cm">/* 24 */</span><span class="cp"></span>

<span class="cp">#define DEF_JUMBO_TX_COAL	20</span>
<span class="cp">#define DEF_JUMBO_TX_MAX_DESC	60</span>
<span class="cp">#define DEF_JUMBO_RX_COAL	30</span>
<span class="cp">#define DEF_JUMBO_RX_MAX_DESC	6</span>
<span class="cp">#define DEF_JUMBO_TX_RATIO	21</span>

<span class="cp">#if tigon2FwReleaseLocal &lt; 20001118</span>
<span class="cm">/*</span>
<span class="cm"> * Standard firmware and early modifications duplicate</span>
<span class="cm"> * IRQ load without this flag (coal timer is never reset).</span>
<span class="cm"> * Note that with this flag tx_coal should be less than</span>
<span class="cm"> * time to xmit full tx ring.</span>
<span class="cm"> * 400usec is not so bad for tx ring size of 128.</span>
<span class="cm"> */</span>
<span class="cp">#define TX_COAL_INTS_ONLY	1	</span><span class="cm">/* worth it */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cm">/*</span>
<span class="cm"> * With modified firmware, this is not necessary, but still useful.</span>
<span class="cm"> */</span>
<span class="cp">#define TX_COAL_INTS_ONLY	1</span>
<span class="cp">#endif</span>

<span class="cp">#define DEF_TRACE		0</span>
<span class="cp">#define DEF_STAT		(2 * TICKS_PER_SEC)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">link_state</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">trace</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_coal_tick</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_coal_tick</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_tx_desc</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_rx_desc</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_ratio</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dis_pci_mem_inval</span><span class="p">[</span><span class="n">ACE_MAX_MOD_PARMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jes Sorensen &lt;jes@trained-monkey.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AceNIC/3C985/GA620 Gigabit Ethernet driver&quot;</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_ACENIC_OMIT_TIGON_I</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;acenic/tg1.bin&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;acenic/tg2.bin&quot;</span><span class="p">);</span>

<span class="n">module_param_array_named</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link_state</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">tx_coal_tick</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">max_tx_desc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rx_coal_tick</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">max_rx_desc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">tx_ratio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/NetGear link state&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/NetGear firmware trace level&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tx_coal_tick</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/GA620 max clock ticks to wait from first tx descriptor arrives&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_tx_desc</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/GA620 max number of transmit descriptors to wait&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_coal_tick</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/GA620 max clock ticks to wait from first rx descriptor arrives&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_rx_desc</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/GA620 max number of receive descriptors to wait&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tx_ratio</span><span class="p">,</span> <span class="s">&quot;AceNIC/3C985/GA620 ratio of NIC memory used for TX/RX descriptors (range 0-63)&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span>
  <span class="s">&quot;acenic.c: v0.92 08/05/2002  Jes Sorensen, linux-acenic@SunSITE.dk</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                            http://home.cern.ch/~jes/gige/acenic.html</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ace_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ace_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ace_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ace_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">ace_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">ace_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ace_get_drvinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ace_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ace_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ace_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ace_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ace_watchdog</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">ace_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ace_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ace_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ace_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">ace_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acenic_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">boards_found</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ace_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ace_ethtool_ops</span><span class="p">);</span>

	<span class="cm">/* we only display this string ONCE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boards_found</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_free_netdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable master mode before we start playing with the</span>
<span class="cm">	 * pci_command word since pci_set_master() will modify</span>
<span class="cm">	 * it.</span>
<span class="cm">	 */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span><span class="p">);</span>

	<span class="cm">/* OpenFirmware on Mac&#39;s does not set this - DOH.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Enabling PCI Memory Mapped &quot;</span>
		       <span class="s">&quot;access - was not enabled by BIOS/Firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
				      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_latency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_latency</span> <span class="o">&lt;=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_latency</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_latency</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remap the regs into kernel space - this is abuse of</span>
<span class="cm">	 * dev-&gt;base_addr since it was means for I/O port</span>
<span class="cm">	 * addresses but who gives a damn.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:  Unable to map I/O register, &quot;</span>
		       <span class="s">&quot;AceNIC %i will be disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">boards_found</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_ALTEON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_FARALLON_PN9100T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Farallon PN9100-T &quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Alteon AceNIC &quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_3COM</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: 3Com 3C985 &quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_NETGEAR</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: NetGear GA620 &quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_DEC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_FARALLON_PN9000SX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Farallon PN9000-SX &quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_SGI</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: SGI AceNIC &quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Unknown AceNIC &quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Gigabit Ethernet at 0x%08lx, &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ACENIC_OMIT_TIGON_I</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Driver compiled without Tigon I&quot;</span>
		       <span class="s">&quot; support - NIC disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_uninit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ace_allocate_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_free_netdev</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boards_found</span> <span class="o">&gt;=</span> <span class="n">ACE_MAX_MOD_PARMS</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">board_idx</span> <span class="o">=</span> <span class="n">BOARD_IDX_OVERFLOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">board_idx</span> <span class="o">=</span> <span class="n">boards_found</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">board_idx</span> <span class="o">=</span> <span class="n">BOARD_IDX_STATIC</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ace_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_free_netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;acenic: device registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_uninit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_using_dac</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">boards_found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail_uninit:</span>
	<span class="n">ace_init_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">fail_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">acenic_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_HALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_HALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This clears any pending interrupts</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure no other CPUs are processing interrupts</span>
<span class="cm">	 * on the card before the buffers are being released.</span>
<span class="cm">	 * Otherwise one might experience some `interesting&#39;</span>
<span class="cm">	 * effects.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Then release the RX buffers - jumbo buffers were</span>
<span class="cm">	 * already released in ace_close().</span>
<span class="cm">	 */</span>
	<span class="n">ace_sync_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_STD_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_std_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ringp</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

			<span class="n">ringp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_std_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ringp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
				       <span class="n">ACE_STD_BUFSIZE</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_std_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_MINI_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_mini_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ringp</span><span class="p">;</span>
				<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

				<span class="n">ringp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_mini_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ringp</span><span class="p">,</span><span class="n">mapping</span><span class="p">);</span>
				<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
					       <span class="n">ACE_MINI_BUFSIZE</span><span class="p">,</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_mini_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_JUMBO_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ringp</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

			<span class="n">ringp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ringp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
				       <span class="n">ACE_JUMBO_BUFSIZE</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ace_init_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">acenic_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;acenic&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">acenic_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">acenic_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">acenic_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acenic_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acenic_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">acenic_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acenic_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">acenic_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">acenic_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_free_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">RX_STD_RING_ENTRIES</span> <span class="o">+</span>
			 <span class="n">RX_JUMBO_RING_ENTRIES</span> <span class="o">+</span>
			 <span class="n">RX_MINI_RING_ENTRIES</span> <span class="o">+</span>
			 <span class="n">RX_RETURN_RING_ENTRIES</span><span class="p">));</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span><span class="p">,</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ring_base_dma</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_return_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span><span class="p">)</span> <span class="o">*</span> <span class="n">EVT_RING_ENTRIES</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">,</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring_dma</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_TX_RING_ENTRIES</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd_dma</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span><span class="p">,</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd_dma</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm_dma</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_allocate_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">RX_STD_RING_ENTRIES</span> <span class="o">+</span>
		 <span class="n">RX_JUMBO_RING_ENTRIES</span> <span class="o">+</span>
		 <span class="n">RX_MINI_RING_ENTRIES</span> <span class="o">+</span>
		 <span class="n">RX_RETURN_RING_ENTRIES</span><span class="p">));</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ring_base_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span> <span class="o">+</span> <span class="n">RX_STD_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span> <span class="o">+</span> <span class="n">RX_JUMBO_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_return_ring</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span> <span class="o">+</span> <span class="n">RX_MINI_RING_ENTRIES</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span><span class="p">)</span> <span class="o">*</span> <span class="n">EVT_RING_ENTRIES</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only allocate a host TX ring for the Tigon II, the Tigon I</span>
<span class="cm">	 * has to use PCI registers for this ;-(</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_TX_RING_ENTRIES</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
					      <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* Clean up. */</span>
	<span class="n">ace_init_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Generic cleanup handling data allocated during init. Used when the</span>
<span class="cm"> * module is unloaded or if an error occurs during initialization</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_init_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ace_free_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_info</span><span class="p">),</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">trace_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Commands are considered to be slow.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ace_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdPrd</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdRng</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdPrd</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ace_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">myjif</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tig_ver</span><span class="p">,</span> <span class="n">mac1</span><span class="p">,</span> <span class="n">mac2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pci_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board_idx</span><span class="p">,</span> <span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cache_size</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">board_idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">board_idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * aman@sgi.com - its useful to do a NIC reset here to</span>
<span class="cm">	 * address the `Firmware not running&#39; problem subsequent</span>
<span class="cm">	 * to any crashes involving the NIC</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">HW_RESET</span> <span class="o">|</span> <span class="p">(</span><span class="n">HW_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>		<span class="cm">/* PCI write posting */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t access any other registers before this point!</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/*</span>
<span class="cm">	 * This will most likely need BYTE_SWAP once we switch</span>
<span class="cm">	 * to using __raw_writel()</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">WORD_SWAP</span> <span class="o">|</span> <span class="n">CLR_INT</span> <span class="o">|</span> <span class="p">((</span><span class="n">WORD_SWAP</span> <span class="o">|</span> <span class="n">CLR_INT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)),</span>
	       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">CLR_INT</span> <span class="o">|</span> <span class="n">WORD_SWAP</span> <span class="o">|</span> <span class="p">((</span><span class="n">CLR_INT</span> <span class="o">|</span> <span class="n">WORD_SWAP</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)),</span>
	       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>		<span class="cm">/* PCI write posting */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop the NIC CPU and clear pending interrupts</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_HALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>		<span class="cm">/* PCI write posting */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>

	<span class="n">tig_ver</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">tig_ver</span><span class="p">){</span>
<span class="cp">#ifndef CONFIG_ACENIC_OMIT_TIGON_I</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Tigon I  (Rev. %i), Firmware: %i.%i.%i, &quot;</span><span class="p">,</span>
		       <span class="n">tig_ver</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_major</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_minor</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_fix</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring_entries</span> <span class="o">=</span> <span class="n">TIGON_I_TX_RING_ENTRIES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Tigon II (Rev. %i), Firmware: %i.%i.%i, &quot;</span><span class="p">,</span>
		       <span class="n">tig_ver</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_major</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_minor</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_fix</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_HALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">);</span>		<span class="cm">/* PCI write posting */</span>
		<span class="cm">/*</span>
<span class="cm">		 * The SRAM bank size does _not_ indicate the amount</span>
<span class="cm">		 * of memory on the card, it controls the _bank_ size!</span>
<span class="cm">		 * Ie. a 1MB AceNIC will have two banks of 512KB.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">SRAM_BANK_512K</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">SYNC_SRAM_TIMING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MiscCfg</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring_entries</span> <span class="o">=</span> <span class="n">MAX_TX_RING_ENTRIES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;  Unsupported Tigon version detected &quot;</span>
		       <span class="s">&quot;(%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tig_ver</span><span class="p">);</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ModeStat _must_ be set after the SRAM settings as this change</span>
<span class="cm">	 * seems to corrupt the ModeStat and possible other registers.</span>
<span class="cm">	 * The SRAM settings survive resets and setting it to the same</span>
<span class="cm">	 * value a second time works as well. This is what caused the</span>
<span class="cm">	 * `Firmware not running&#39; problem on the Tigon II.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ACE_BYTE_SWAP_DMA</span> <span class="o">|</span> <span class="n">ACE_WARN</span> <span class="o">|</span> <span class="n">ACE_FATAL</span> <span class="o">|</span> <span class="n">ACE_BYTE_SWAP_BD</span> <span class="o">|</span>
	       <span class="n">ACE_WORD_SWAP_BD</span> <span class="o">|</span> <span class="n">ACE_NO_JUMBO_FRAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ModeStat</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ACE_BYTE_SWAP_DMA</span> <span class="o">|</span> <span class="n">ACE_WARN</span> <span class="o">|</span> <span class="n">ACE_FATAL</span> <span class="o">|</span>
	       <span class="n">ACE_WORD_SWAP_BD</span> <span class="o">|</span> <span class="n">ACE_NO_JUMBO_FRAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ModeStat</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ModeStat</span><span class="p">);</span>		<span class="cm">/* PCI write posting */</span>

	<span class="n">mac1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">mac1</span> <span class="o">=</span> <span class="n">mac1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">read_eeprom_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8c</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mac1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mac2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">mac2</span> <span class="o">=</span> <span class="n">mac2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">read_eeprom_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8c</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mac2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">mac1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MacAddrHi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mac2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MacAddrLo</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac2</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Looks like this is necessary to deal with on all architectures,</span>
<span class="cm">	 * even this %$#%$# N440BX Intel based thing doesn&#39;t get it right.</span>
<span class="cm">	 * Ie. having two NICs in the machine, one will have the cache</span>
<span class="cm">	 * line set at boot time, the other will not.</span>
<span class="cm">	 */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache_size</span><span class="p">);</span>
	<span class="n">cache_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_size</span> <span class="o">!=</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  PCI cache line size set incorrectly &quot;</span>
		       <span class="s">&quot;(%i bytes) by BIOS/FW, &quot;</span><span class="p">,</span> <span class="n">cache_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cache_size</span> <span class="o">&gt;</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;expecting %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;correcting to %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span>
					      <span class="n">SMP_CACHE_BYTES</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">PciState</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  PCI bus width: %i bits, speed: %iMHz, &quot;</span>
	       <span class="s">&quot;latency: %i clks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       	<span class="p">(</span><span class="n">pci_state</span> <span class="o">&amp;</span> <span class="n">PCI_32BIT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">(</span><span class="n">pci_state</span> <span class="o">&amp;</span> <span class="n">PCI_66MHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">66</span> <span class="o">:</span> <span class="mi">33</span><span class="p">,</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_latency</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the max DMA transfer size. Seems that for most systems</span>
<span class="cm">	 * the performance is better when no MAX parameter is</span>
<span class="cm">	 * set. However for systems enabling PCI write and invalidate,</span>
<span class="cm">	 * DMA writes must be set to the L1 cache line size to get</span>
<span class="cm">	 * optimal performance.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The default is now to turn the PCI write and invalidate off</span>
<span class="cm">	 * - that is what Alteon does for NT.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">READ_CMD_MEM</span> <span class="o">|</span> <span class="n">WRITE_CMD_MEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MEM_READ_MULTIPLE</span> <span class="o">|</span> <span class="p">(</span><span class="n">pci_state</span> <span class="o">&amp;</span> <span class="n">PCI_66MHZ</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Tuning parameters only supported for 8 cards</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board_idx</span> <span class="o">==</span> <span class="n">BOARD_IDX_OVERFLOW</span> <span class="o">||</span>
		    <span class="n">dis_pci_mem_inval</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">;</span>
				<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
						      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Disabling PCI memory &quot;</span>
				       <span class="s">&quot;write and invalidate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  PCI memory write &amp; invalidate &quot;</span>
			       <span class="s">&quot;enabled by BIOS, enabling counter measures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">SMP_CACHE_BYTES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_WRITE_MAX_16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">32</span>:
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_WRITE_MAX_32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">64</span>:
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_WRITE_MAX_64</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">128</span>:
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_WRITE_MAX_128</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Cache line size %i not &quot;</span>
				       <span class="s">&quot;supported, PCI write and invalidate &quot;</span>
				       <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">);</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">;</span>
				<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
						      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_command</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef __sparc__</span>
	<span class="cm">/*</span>
<span class="cm">	 * On this platform, we know what the best dma settings</span>
<span class="cm">	 * are.  We use 64-byte maximum bursts, because if we</span>
<span class="cm">	 * burst larger than the cache line size (or even cross</span>
<span class="cm">	 * a 64byte boundary in a single burst) the UltraSparc</span>
<span class="cm">	 * PCI controller will disconnect at 64-byte multiples.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Read-multiple will be properly enabled above, and when</span>
<span class="cm">	 * set will give the PCI controller proper hints about</span>
<span class="cm">	 * prefetching.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_READ_WRITE_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_READ_MAX_64</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_WRITE_MAX_64</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __alpha__</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_READ_WRITE_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_READ_MAX_128</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * All the docs say MUST NOT. Well, I did.</span>
<span class="cm">	 * Nothing terrible happens, if we load wrong size.</span>
<span class="cm">	 * Bit w&amp;i still works better!</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DMA_WRITE_MAX_128</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">PciState</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * The Host PCI bus controller driver has to set FBB.</span>
<span class="c">	 * If all devices on that PCI bus support FBB, then the controller</span>
<span class="c">	 * can enable FBB support in the Host PCI Bus controller (or on</span>
<span class="c">	 * the PCI-PCI bridge if that applies).</span>
<span class="c">	 * -ggg</span>
<span class="c">	 */</span>
<span class="c">	/*</span>
<span class="c">	 * I have received reports from people having problems when this</span>
<span class="c">	 * bit is enabled.</span>
<span class="c">	 */</span>
<span class="c">	if (!(ap-&gt;pci_command &amp; PCI_COMMAND_FAST_BACK)) {</span>
<span class="c">		printk(KERN_INFO &quot;  Enabling PCI Fast Back to Back\n&quot;);</span>
<span class="c">		ap-&gt;pci_command |= PCI_COMMAND_FAST_BACK;</span>
<span class="c">		pci_write_config_word(pdev, PCI_COMMAND, ap-&gt;pci_command);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure DMA attributes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the generic info block and the command+event rings</span>
<span class="cm">	 * and the control blocks for the transmit and receive rings</span>
<span class="cm">	 * as they need to be setup once and for all.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_info</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the memory for the skb rings.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_skb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecode</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ace_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			    <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Requested IRQ %d is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef INDEX_DEBUG</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">debug_lock</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_std_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_mini_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_skb</span><span class="p">));</span>

	<span class="n">ecode</span> <span class="o">=</span> <span class="n">ace_load_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">fw_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp_ptr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp_ptr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">InfoPtrHi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp_ptr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">InfoPtrLo</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EVT_RING_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span><span class="p">));</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring_dma</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_prd_ptr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd_dma</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtCsm</span><span class="p">);</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdRng</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdPrd</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdCsm</span><span class="p">);</span>

	<span class="n">tmp_ptr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">;</span>
	<span class="n">tmp_ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ace_info</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">stats2_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">tmp_ptr</span><span class="p">);</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_std_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ring_base_dma</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_std_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">ACE_STD_BUFSIZE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_std_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
	  <span class="n">RCB_FLG_TCP_UDP_SUM</span> <span class="o">|</span> <span class="n">RCB_FLG_NO_PSEUDO_HDR</span> <span class="o">|</span> <span class="n">RCB_FLG_VLAN_ASSIST</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">RX_STD_RING_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_STD_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BD_FLG_TCP_UDP_SUM</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_skbprd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ring_base_dma</span> <span class="o">+</span>
		     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_STD_RING_ENTRIES</span><span class="p">)));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
	  <span class="n">RCB_FLG_TCP_UDP_SUM</span> <span class="o">|</span> <span class="n">RCB_FLG_NO_PSEUDO_HDR</span> <span class="o">|</span> <span class="n">RCB_FLG_VLAN_ASSIST</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">RX_JUMBO_RING_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_JUMBO_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BD_FLG_TCP_UDP_SUM</span> <span class="o">|</span> <span class="n">BD_FLG_JUMBO</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbprd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_jumbo_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">RX_MINI_RING_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_mini_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ring_base_dma</span> <span class="o">+</span>
			     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">)</span> <span class="o">*</span>
			      <span class="p">(</span><span class="n">RX_STD_RING_ENTRIES</span> <span class="o">+</span>
			       <span class="n">RX_JUMBO_RING_ENTRIES</span><span class="p">))));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_mini_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">ACE_MINI_SIZE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_mini_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		  <span class="n">RCB_FLG_TCP_UDP_SUM</span><span class="o">|</span><span class="n">RCB_FLG_NO_PSEUDO_HDR</span><span class="o">|</span><span class="n">RCB_FLG_VLAN_ASSIST</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_MINI_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span>
				<span class="n">BD_FLG_TCP_UDP_SUM</span> <span class="o">|</span> <span class="n">BD_FLG_MINI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_mini_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_mini_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RCB_FLG_RNG_DISABLE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_mini_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_skbprd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_return_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ring_base_dma</span> <span class="o">+</span>
		     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">)</span> <span class="o">*</span>
		      <span class="p">(</span><span class="n">RX_STD_RING_ENTRIES</span> <span class="o">+</span>
		       <span class="n">RX_JUMBO_RING_ENTRIES</span> <span class="o">+</span>
		       <span class="n">RX_MINI_RING_ENTRIES</span><span class="p">))));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_return_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_return_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">RX_RETURN_RING_ENTRIES</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_return_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">RX_RETURN_RING_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">));</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ret_prd_ptr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd_dma</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">TX_RING_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">Window</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">TIGON_I_TX_RING_ENTRIES</span>
				 <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span>  <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">TX_RING_BASE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">MAX_TX_RING_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">));</span>

		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">RCB_FLG_TCP_UDP_SUM</span> <span class="o">|</span> <span class="n">RCB_FLG_NO_PSEUDO_HDR</span> <span class="o">|</span> <span class="n">RCB_FLG_VLAN_ASSIST</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Tigon I does not like having the TX ring in host memory ;-(</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">RCB_FLG_TX_HOST_RING</span><span class="p">;</span>
<span class="cp">#if TX_COAL_INTS_ONLY</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">RCB_FLG_COAL_INT_ONLY</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_csm_ptr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm_dma</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Potential item for tuning parameter</span>
<span class="cm">	 */</span>
<span class="cp">#if 0</span><span class="c"> /* NO */</span>
<span class="c">	writel(DMA_THRESH_16W, &amp;regs-&gt;DmaReadCfg);</span>
<span class="c">	writel(DMA_THRESH_16W, &amp;regs-&gt;DmaWriteCfg);</span>
<span class="cp">#else</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DMA_THRESH_8W</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadCfg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DMA_THRESH_8W</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteCfg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MaskInt</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IfIdx</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * McKinley boxes do not like us fiddling with AssistState</span>
<span class="c">	 * this early</span>
<span class="c">	 */</span>
<span class="c">	writel(1, &amp;regs-&gt;AssistState);</span>
<span class="cp">#endif</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">DEF_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneStatTicks</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DEF_TRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneTrace</span><span class="p">);</span>

	<span class="n">ace_set_rxtx_parms</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_idx</span> <span class="o">==</span> <span class="n">BOARD_IDX_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: more than %i NICs detected, &quot;</span>
		       <span class="s">&quot;ignoring module parameters!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ACE_MAX_MOD_PARMS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">board_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">],</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneTxCoalTicks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_tx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">max_tx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxTxDesc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">rx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">],</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneRxCoalTicks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_rx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">max_rx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxRxDesc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">board_idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneTrace</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tx_ratio</span><span class="p">[</span><span class="n">board_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_ratio</span><span class="p">[</span><span class="n">board_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">))</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tx_ratio</span><span class="p">[</span><span class="n">board_idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxBufRat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Default link parameters</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">LNK_ENABLE</span> <span class="o">|</span> <span class="n">LNK_FULL_DUPLEX</span> <span class="o">|</span> <span class="n">LNK_1000MB</span> <span class="o">|</span> <span class="n">LNK_100MB</span> <span class="o">|</span>
		<span class="n">LNK_10MB</span> <span class="o">|</span> <span class="n">LNK_RX_FLOW_CTL_Y</span> <span class="o">|</span> <span class="n">LNK_NEG_FCTL</span> <span class="o">|</span> <span class="n">LNK_NEGOTIATE</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_TX_FLOW_CTL_Y</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Override link default parameters</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">board_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">link_state</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="n">link_state</span><span class="p">[</span><span class="n">board_idx</span><span class="p">];</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">LNK_ENABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Setting half duplex link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LNK_FULL_DUPLEX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LNK_NEGOTIATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_10MB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_100MB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_1000MB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: No media speed specified, &quot;</span>
			       <span class="s">&quot;forcing auto negotiation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_NEGOTIATE</span> <span class="o">|</span> <span class="n">LNK_1000MB</span> <span class="o">|</span>
				<span class="n">LNK_100MB</span> <span class="o">|</span> <span class="n">LNK_10MB</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_NEG_FCTL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Disabling flow control &quot;</span>
			       <span class="s">&quot;negotiation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_RX_FLOW_CTL_Y</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Enabling TX flow control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LNK_TX_FLOW_CTL_Y</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneLink</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneFastLink</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Pc</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set tx_csm before we start receiving interrupts, otherwise</span>
<span class="cm">	 * the interrupt handler might think it is supposed to process</span>
<span class="cm">	 * tx ints before we are up and running, which may cause a null</span>
<span class="cm">	 * pointer access in the int handler.</span>
<span class="cm">	 */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_prd</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span><span class="p">)</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ace_set_txprd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxRetCsm</span><span class="p">);</span>

       <span class="cm">/*</span>
<span class="cm">	* Enable DMA engine now.</span>
<span class="cm">	* If we do this sooner, Mckinley box pukes.</span>
<span class="cm">	* I assume it&#39;s because Tigon II DMA engine wants to check</span>
<span class="cm">	* *something* even before the CPU is started.</span>
<span class="cm">	*/</span>
       <span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">AssistState</span><span class="p">);</span>  <span class="cm">/* enable DMA */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start the NIC CPU</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CPU_HALT</span><span class="o">|</span><span class="n">CPU_TRACE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the firmware to spin up - max 3 seconds.</span>
<span class="cm">	 */</span>
	<span class="n">myjif</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">myjif</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">fw_running</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">fw_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Firmware NOT running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ace_dump_trace</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_HALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">);</span>

		<span class="cm">/* aman@sgi.com - account for badly behaving firmware/NIC:</span>
<span class="cm">		 * - have observed that the NIC may continue to generate</span>
<span class="cm">		 *   interrupts for some reason; attempt to stop it - halt</span>
<span class="cm">		 *   second CPU for Tigon II cards, and also clear Mb0</span>
<span class="cm">		 * - if we&#39;re a module, we&#39;ll fail to load if this was</span>
<span class="cm">		 *   the only GbE card in the system =&gt; if the kernel does</span>
<span class="cm">		 *   see an interrupt from the NIC, code to handle it is</span>
<span class="cm">		 *   gone and OOps! - so free_irq also</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_HALT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuBCtrl</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>

		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We load the ring here as there seem to be no way to tell the</span>
<span class="cm">	 * firmware to wipe the ring without re-initializing it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">std_refill_busy</span><span class="p">))</span>
		<span class="n">ace_load_std_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_RING_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Someone is busy refilling the RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mini_refill_busy</span><span class="p">))</span>
			<span class="n">ace_load_mini_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_MINI_SIZE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Someone is busy refilling &quot;</span>
			       <span class="s">&quot;the RX mini ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">init_error:</span>
	<span class="n">ace_init_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_set_rxtx_parms</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">jumbo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board_idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">board_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jumbo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_TX_COAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneTxCoalTicks</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_tx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_TX_MAX_DESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxTxDesc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_RX_COAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneRxCoalTicks</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_rx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_RX_MAX_DESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxRxDesc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ratio</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_TX_RATIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxBufRat</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_JUMBO_TX_COAL</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneTxCoalTicks</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_tx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_JUMBO_TX_MAX_DESC</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxTxDesc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_coal_tick</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_JUMBO_RX_COAL</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneRxCoalTicks</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_rx_desc</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_JUMBO_RX_MAX_DESC</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxRxDesc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ratio</span><span class="p">[</span><span class="n">board_idx</span><span class="p">])</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">DEF_JUMBO_TX_RATIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxBufRat</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We haven&#39;t received a stats update event for more than 2.5</span>
<span class="cm">	 * seconds and there is data in the transmit queue, thus we</span>
<span class="cm">	 * assume the card is stuck.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Transmitter is stuck, %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">));</span>
		<span class="cm">/* This can happen due to ieee flow control. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: BUG... transmitter died. Kicking it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		netif_wake_queue(dev);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cur_size</span><span class="p">;</span>

	<span class="n">cur_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_LOW_STD_THRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">std_refill_busy</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;refilling buffers (current %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_size</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">ace_load_std_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_LOW_MINI_THRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mini_refill_busy</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;refilling mini buffers (current %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cur_size</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ace_load_mini_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_MINI_SIZE</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cur_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_jumbo_bufs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_LOW_JUMBO_THRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;refilling jumbo buffers (current %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_size</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">ace_load_jumbo_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_JUMBO_SIZE</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tasklet_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Copy the contents of the NIC&#39;s trace buffer to kernel memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_dump_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (!ap-&gt;trace_buf)</span>
<span class="c">		if (!(ap-&gt;trace_buf = kmalloc(ACE_TRACE_SIZE, GFP_KERNEL)))</span>
<span class="c">		    return;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Load the standard rx ring.</span>
<span class="cm"> *</span>
<span class="cm"> * Loading rings is safe without holding the spin lock since this is</span>
<span class="cm"> * done only before the device is enabled, thus no interrupts are</span>
<span class="cm"> * generated and by the interrupt handler/tasklet handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_load_std_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>


	<span class="n">prefetchw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_skbprd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACE_STD_BUFSIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">ACE_STD_BUFSIZE</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_std_skbuff</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_std_skbuff</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
				   <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>

		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ACE_STD_BUFSIZE</span><span class="p">;</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_STD_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_skbprd</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_RX_PRD_IDX</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_skbprd</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxStdPrd</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">std_refill_busy</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">error_out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Out of memory when allocating &quot;</span>
	       <span class="s">&quot;standard receive buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_load_mini_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">prefetchw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_skbprd</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACE_MINI_BUFSIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">ACE_MINI_BUFSIZE</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_mini_skbuff</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_mini_skbuff</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
				   <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>

		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ACE_MINI_BUFSIZE</span><span class="p">;</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_MINI_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_skbprd</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxMiniPrd</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

 <span class="nl">out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mini_refill_busy</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
 <span class="nl">error_out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Out of memory when allocating &quot;</span>
	       <span class="s">&quot;mini receive buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Load the jumbo rx ring, this may happen at any time if the MTU</span>
<span class="cm"> * is changed to a value &gt; 1500.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_load_jumbo_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbprd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACE_JUMBO_BUFSIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">ACE_JUMBO_BUFSIZE</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
				   <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>

		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ACE_JUMBO_BUFSIZE</span><span class="p">;</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_JUMBO_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_jumbo_bufs</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbprd</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_RX_JUMBO_PRD_IDX</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbprd</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxJumboPrd</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
 <span class="nl">error_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Out of memory when allocating &quot;</span>
		       <span class="s">&quot;jumbo receive buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * All events are considered to be slow (RX/TX ints do not generate</span>
<span class="cm"> * events) and are handled here, outside the main interrupt handler,</span>
<span class="cm"> * to reduce the size of the handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ace_handle_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">evtcsm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">evtprd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">evtcsm</span> <span class="o">!=</span> <span class="n">evtprd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">evtcsm</span><span class="p">].</span><span class="n">evt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">E_FW_RUNNING</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Firmware up and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">fw_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_STATS_UPDATED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_LNK_STATE</span>:
		<span class="p">{</span>
			<span class="n">u16</span> <span class="n">code</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">evtcsm</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">E_C_LINK_UP</span>:
			<span class="p">{</span>
				<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">GigLnkState</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Optical link UP &quot;</span>
				       <span class="s">&quot;(%s Duplex, Flow Control: %s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">state</span> <span class="o">&amp;</span> <span class="n">LNK_FULL_DUPLEX</span> <span class="o">?</span> <span class="s">&quot;Full&quot;</span><span class="o">:</span><span class="s">&quot;Half&quot;</span><span class="p">,</span>
				       <span class="n">state</span> <span class="o">&amp;</span> <span class="n">LNK_TX_FLOW_CTL_Y</span> <span class="o">?</span> <span class="s">&quot;TX &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				       <span class="n">state</span> <span class="o">&amp;</span> <span class="n">LNK_RX_FLOW_CTL_Y</span> <span class="o">?</span> <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">E_C_LINK_DOWN</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Optical link DOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">E_C_LINK_10_100</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: 10/100BaseT link &quot;</span>
				       <span class="s">&quot;UP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unknown optical link &quot;</span>
				       <span class="s">&quot;state %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">E_ERROR</span>:
			<span class="k">switch</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">evtcsm</span><span class="p">].</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">E_C_ERR_INVAL_CMD</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid command error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">E_C_ERR_UNIMP_CMD</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unimplemented command &quot;</span>
				       <span class="s">&quot;error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">E_C_ERR_BAD_CFG</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bad config error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown error %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">evtcsm</span><span class="p">].</span><span class="n">code</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_RESET_JUMBO_RNG</span>:
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_JUMBO_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">set_aceaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

 			<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
 				<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>
 				<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_RX_JUMBO_PRD_IDX</span><span class="p">;</span>
 				<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 				<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 				<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
 			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">RxJumboPrd</span><span class="p">));</span>
 				<span class="n">wmb</span><span class="p">();</span>
 			<span class="p">}</span>

			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbprd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Jumbo ring flushed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unhandled event 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">evtcsm</span><span class="p">].</span><span class="n">evt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">evtcsm</span> <span class="o">=</span> <span class="p">(</span><span class="n">evtcsm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">EVT_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">evtcsm</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_rx_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rxretprd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rxretcsm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mini_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">std_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">rxretcsm</span><span class="p">;</span>

	<span class="n">prefetchw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">);</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">rxretprd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">rip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">,</span> <span class="o">*</span><span class="n">retdesc</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">skbidx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bd_flags</span><span class="p">,</span> <span class="n">desc_type</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">csum</span><span class="p">;</span>


		<span class="cm">/* make sure the rx descriptor isn&#39;t read before rxretprd */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">rxretcsm</span><span class="p">)</span>
			<span class="n">rmb</span><span class="p">();</span>

		<span class="n">retdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_return_ring</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">skbidx</span> <span class="o">=</span> <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">bd_flags</span> <span class="o">=</span> <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">desc_type</span> <span class="o">=</span> <span class="n">bd_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BD_FLG_JUMBO</span> <span class="o">|</span> <span class="n">BD_FLG_MINI</span><span class="p">);</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">desc_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Normal frames do not have any flags set</span>
<span class="cm">			 *</span>
<span class="cm">			 * Mini and normal frames arrive frequently,</span>
<span class="cm">			 * so use a local counter to avoid doing</span>
<span class="cm">			 * atomic operations for each packet arriving.</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">rip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_std_skbuff</span><span class="p">[</span><span class="n">skbidx</span><span class="p">];</span>
			<span class="n">mapsize</span> <span class="o">=</span> <span class="n">ACE_STD_BUFSIZE</span><span class="p">;</span>
			<span class="n">rxdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_std_ring</span><span class="p">[</span><span class="n">skbidx</span><span class="p">];</span>
			<span class="n">std_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BD_FLG_JUMBO</span>:
			<span class="n">rip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_jumbo_skbuff</span><span class="p">[</span><span class="n">skbidx</span><span class="p">];</span>
			<span class="n">mapsize</span> <span class="o">=</span> <span class="n">ACE_JUMBO_BUFSIZE</span><span class="p">;</span>
			<span class="n">rxdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_jumbo_ring</span><span class="p">[</span><span class="n">skbidx</span><span class="p">];</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_jumbo_bufs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BD_FLG_MINI</span>:
			<span class="n">rip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rx_mini_skbuff</span><span class="p">[</span><span class="n">skbidx</span><span class="p">];</span>
			<span class="n">mapsize</span> <span class="o">=</span> <span class="n">ACE_MINI_BUFSIZE</span><span class="p">;</span>
			<span class="n">rxdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_mini_ring</span><span class="p">[</span><span class="n">skbidx</span><span class="p">];</span>
			<span class="n">mini_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: unknown frame type (0x%02x) &quot;</span>
			       <span class="s">&quot;returned by NIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">rip</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">rip</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">rip</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
			       <span class="n">mapsize</span><span class="p">,</span>
			       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fly baby, fly!</span>
<span class="cm">		 */</span>
		<span class="n">csum</span> <span class="o">=</span> <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">tcp_udp_csum</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Instead of forcing the poor tigon mips cpu to calculate</span>
<span class="cm">		 * pseudo hdr checksum, we do this ourselves.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd_flags</span> <span class="o">&amp;</span> <span class="n">BD_FLG_TCP_UDP_SUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* send it up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bd_flags</span> <span class="o">&amp;</span> <span class="n">BD_FLG_VLAN_TAG</span><span class="p">))</span>
			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">retdesc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RETURN_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">std_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">mini_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * According to the documentation RxRetCsm is obsolete with</span>
<span class="cm">	 * the 12.3.x Firmware - my Tigon I NICs seem to disagree!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxRetCsm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">rxretprd</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ace_tx_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">txcsm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
				       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">txcsm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span> <span class="o">=</span> <span class="n">txcsm</span><span class="p">;</span>

	<span class="cm">/* So... tx_ret_csm is advanced _after_ check for device wakeup.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We could try to make it before. In this case we would get</span>
<span class="cm">	 * the following race condition: hard_start_xmit on other cpu</span>
<span class="cm">	 * enters after we advanced tx_ret_csm and fills space,</span>
<span class="cm">	 * which we have just freed, so that we make illegal device wakeup.</span>
<span class="cm">	 * There is no good way to workaround this (at entry</span>
<span class="cm">	 * to ace_start_xmit detects this condition and prevents</span>
<span class="cm">	 * ring corruption, but it is not a good workaround.)</span>
<span class="cm">	 *</span>
<span class="cm">	 * When tx_ret_csm is advanced after, we wake up device _only_</span>
<span class="cm">	 * if we really have some space in ring (though the core doing</span>
<span class="cm">	 * hard_start_xmit can see full ring for some period and has to</span>
<span class="cm">	 * synchronize.) Superb.</span>
<span class="cm">	 * BUT! We get another subtle race condition. hard_start_xmit</span>
<span class="cm">	 * may think that ring is full between wakeup and advancing</span>
<span class="cm">	 * tx_ret_csm and will stop device instantly! It is not so bad.</span>
<span class="cm">	 * We are guaranteed that there is something in ring, so that</span>
<span class="cm">	 * the next irq will resume transmission. To speedup this we could</span>
<span class="cm">	 * mark descriptor, which closes ring with BD_FLG_COAL_NOW</span>
<span class="cm">	 * (see ace_start_xmit).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Well, this dilemma exists in all lock-free devices.</span>
<span class="cm">	 * We, following scheme used in drivers by Donald Becker,</span>
<span class="cm">	 * select the least dangerous.</span>
<span class="cm">	 *							--ANK</span>
<span class="cm">	 */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ace_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txcsm</span><span class="p">,</span> <span class="n">rxretcsm</span><span class="p">,</span> <span class="n">rxretprd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">evtcsm</span><span class="p">,</span> <span class="n">evtprd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case of PCI shared interrupts or spurious interrupts,</span>
<span class="cm">	 * we want to make sure it is actually our interrupt before</span>
<span class="cm">	 * spending any time in here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IN_INT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ACK intr now. Otherwise we will lose updates to rx_ret_prd,</span>
<span class="cm">	 * which happened _after_ rxretprd = *ap-&gt;rx_ret_prd; but before</span>
<span class="cm">	 * writel(0, &amp;regs-&gt;Mb0Lo).</span>
<span class="cm">	 *</span>
<span class="cm">	 * &quot;IRQ avoidance&quot; recommended in docs applies to IRQs served</span>
<span class="cm">	 * threads and it is wrong even for that case.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mb0Lo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There is no conflict between transmit handling in</span>
<span class="cm">	 * start_xmit and receive processing, thus there is no reason</span>
<span class="cm">	 * to take a spin lock for RX handling. Wait until we start</span>
<span class="cm">	 * working on the other stuff - hey we don&#39;t need a spin lock</span>
<span class="cm">	 * anymore.</span>
<span class="cm">	 */</span>
	<span class="n">rxretprd</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rx_ret_prd</span><span class="p">;</span>
	<span class="n">rxretcsm</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxretprd</span> <span class="o">!=</span> <span class="n">rxretcsm</span><span class="p">)</span>
		<span class="n">ace_rx_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rxretprd</span><span class="p">,</span> <span class="n">rxretcsm</span><span class="p">);</span>

	<span class="n">txcsm</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_csm</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txcsm</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If each skb takes only one descriptor this check degenerates</span>
<span class="cm">		 * to identity, because new space has just been opened.</span>
<span class="cm">		 * But if skbs are fragmented we must check that this index</span>
<span class="cm">		 * update releases enough of space, otherwise we just</span>
<span class="cm">		 * wait for device to make more work.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring_full</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">txcsm</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_prd</span><span class="p">))</span>
			<span class="n">ace_tx_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txcsm</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">evtcsm</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtCsm</span><span class="p">);</span>
	<span class="n">evtprd</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">evt_prd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evtcsm</span> <span class="o">!=</span> <span class="n">evtprd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evtcsm</span> <span class="o">=</span> <span class="n">ace_handle_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">evtcsm</span><span class="p">,</span> <span class="n">evtprd</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">evtcsm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtCsm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This has to go last in the interrupt handler and run with</span>
<span class="cm">	 * the spin lock released ... what lock?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cur_size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">run_tasklet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cur_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_rx_bufs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_LOW_STD_THRES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_PANIC_STD_THRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">std_refill_busy</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;low on std buffers %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_size</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">ace_load_std_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">run_tasklet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cur_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_mini_bufs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_LOW_MINI_THRES</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_PANIC_MINI_THRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mini_refill_busy</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;low on mini buffers %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">cur_size</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">ace_load_mini_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							      <span class="n">RX_MINI_SIZE</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">run_tasklet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_jumbo_bufs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_LOW_JUMBO_THRES</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cur_size</span> <span class="o">&lt;</span> <span class="n">RX_PANIC_JUMBO_THRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">)){</span>
<span class="cp">#ifdef DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;low on jumbo buffers %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">cur_size</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">ace_load_jumbo_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							       <span class="n">RX_JUMBO_SIZE</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">run_tasklet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run_tasklet</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tasklet_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tasklet_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ace_tasklet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">fw_running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Firmware not running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IfMtu</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_CLEAR_STATS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_HOST_STATE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_STACK_UP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">))</span>
		<span class="n">ace_load_jumbo_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_JUMBO_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_PROMISC_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_PROMISC_ENABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	cmd.evt = C_LNK_NEGOTIATION;</span>
<span class="c">	cmd.code = 0;</span>
<span class="c">	cmd.idx = 0;</span>
<span class="c">	ace_issue_cmd(regs, &amp;cmd);</span>
<span class="cp">#endif</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup the bottom half rx ring refill handler</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ace_tasklet</span><span class="p">,</span> <span class="n">ace_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Without (or before) releasing irq and stopping hardware, this</span>
<span class="cm">	 * is an absolute non-sense, by the way. It will be reset instantly</span>
<span class="cm">	 * by the first irq.</span>
<span class="cm">	 */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_PROMISC_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_PROMISC_DISABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_HOST_STATE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_STACK_DOWN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ace_tasklet</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure one CPU is not processing packets while</span>
<span class="cm">	 * buffers are being released by another.</span>
<span class="cm">	 */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ace_mask_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* NB: TIGON_1 is special, tx_ring is in io space */</span>
				<span class="k">struct</span> <span class="n">tx_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="k">struct</span> <span class="n">tx_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrhi</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">flagsize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">));</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
				       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_RESET_JUMBO_RNG</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ace_unmask_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span>
<span class="nf">ace_map_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tail</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
			       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mapping</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ace_load_tx_bd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
	       <span class="n">u32</span> <span class="n">flagsize</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vlan_tag</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if !USE_TX_COAL_NOW</span>
	<span class="n">flagsize</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BD_FLG_COAL_NOW</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="k">struct</span> <span class="n">tx_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrhi</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">flagsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flagsize</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">vlan_tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">vlanres</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrhi</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">flagsize</span> <span class="o">=</span> <span class="n">flagsize</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">vlanres</span> <span class="o">=</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ace_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">flagsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxjiff</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_prd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring_full</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">overflow</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">ace_map_tx_skb</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">flagsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BD_FLG_END</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_TCP_UDP_SUM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_VLAN_TAG</span><span class="p">;</span>
			<span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="cm">/* Look at ace_tx_int for explanations. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring_full</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
			<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_COAL_NOW</span><span class="p">;</span>

		<span class="n">ace_load_tx_bd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">flagsize</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">ace_map_tx_skb</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">flagsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_TCP_UDP_SUM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_VLAN_TAG</span><span class="p">;</span>
			<span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ace_load_tx_bd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">flagsize</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>

			<span class="n">mapping</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						   <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

			<span class="n">flagsize</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
				<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_TCP_UDP_SUM</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ACE_TX_RING_ENTRIES</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_END</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring_full</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
					<span class="n">flagsize</span> <span class="o">|=</span> <span class="n">BD_FLG_COAL_NOW</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Only the last fragment frees</span>
<span class="cm">				 * the skb!</span>
<span class="cm">				 */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
			<span class="n">ace_load_tx_bd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">flagsize</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 	<span class="n">wmb</span><span class="p">();</span>
 	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_prd</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
 	<span class="n">ace_set_txprd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flagsize</span> <span class="o">&amp;</span> <span class="n">BD_FLG_COAL_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * A TX-descriptor producer (an IRQ) might have gotten</span>
<span class="cm">		 * between, making the ring free again. Since xmit is</span>
<span class="cm">		 * serialized, this is the only situation we have to</span>
<span class="cm">		 * re-test.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring_full</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_ret_csm</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">overflow:</span>
	<span class="cm">/*</span>
<span class="cm">	 * This race condition is unavoidable with lock-free drivers.</span>
<span class="cm">	 * We wake up the queue _before_ tx_prd is advanced, so that we can</span>
<span class="cm">	 * enter hard_start_xmit too early, while tx ring still looks closed.</span>
<span class="cm">	 * This happens ~1-4 times per 100000 packets, so that we can allow</span>
<span class="cm">	 * to loop syncing to other CPU. Probably, we need an additional</span>
<span class="cm">	 * wmb() in ace_tx_intr as well.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that this race is relieved by reserving one more entry</span>
<span class="cm">	 * in tx ring than it is necessary (see original non-SG driver).</span>
<span class="cm">	 * However, with SG we need to reserve 2*MAX_SKB_FRAGS+1, which</span>
<span class="cm">	 * is already overkill.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Alternative is to return with 1 not throttling queue. In this</span>
<span class="cm">	 * case loop becomes longer, no more useful effects.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">maxjiff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The ring is stuck full. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Transmit ring stuck full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ACE_JUMBO_MTU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IfMtu</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ACE_STD_MTU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Enabling Jumbo frame &quot;</span>
			       <span class="s">&quot;support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">))</span>
				<span class="n">ace_load_jumbo_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_JUMBO_SIZE</span><span class="p">);</span>
			<span class="n">ace_set_rxtx_parms</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo_refill_busy</span><span class="p">));</span>
		<span class="n">ace_sync_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">ace_set_rxtx_parms</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">jumbo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>

			<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_RESET_JUMBO_RNG</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_cmd</span><span class="p">));</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
		 <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
		 <span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
		 <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">);</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">GigLnkState</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_1000MB</span><span class="p">)</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">link</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">FastLnkState</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_100MB</span><span class="p">)</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_10MB</span><span class="p">)</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_FULL_DUPLEX</span><span class="p">)</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_NEGOTIATE</span><span class="p">)</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * Current struct ethtool_cmd is insufficient</span>
<span class="c">	 */</span>
<span class="c">	ecmd-&gt;trace = readl(&amp;regs-&gt;TuneTrace);</span>

<span class="c">	ecmd-&gt;txcoal = readl(&amp;regs-&gt;TuneTxCoalTicks);</span>
<span class="c">	ecmd-&gt;rxcoal = readl(&amp;regs-&gt;TuneRxCoalTicks);</span>
<span class="cp">#endif</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxTxDesc</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneMaxRxDesc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link</span><span class="p">,</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">GigLnkState</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_1000MB</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">link</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">FastLnkState</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_100MB</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">LNK_10MB</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">LNK_ENABLE</span> <span class="o">|</span> <span class="n">LNK_1000MB</span> <span class="o">|</span> <span class="n">LNK_100MB</span> <span class="o">|</span> <span class="n">LNK_10MB</span> <span class="o">|</span>
		<span class="n">LNK_RX_FLOW_CTL_Y</span> <span class="o">|</span> <span class="n">LNK_NEG_FCTL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">link</span> <span class="o">|=</span> <span class="n">LNK_TX_FLOW_CTL_Y</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="n">link</span> <span class="o">|=</span> <span class="n">LNK_NEGOTIATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ecmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LNK_1000MB</span> <span class="o">|</span> <span class="n">LNK_100MB</span> <span class="o">|</span> <span class="n">LNK_10MB</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ecmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">link</span> <span class="o">|=</span> <span class="n">LNK_1000MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">link</span> <span class="o">|=</span> <span class="n">LNK_100MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="n">link</span> <span class="o">|=</span> <span class="n">LNK_10MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">link</span> <span class="o">|=</span> <span class="n">LNK_FULL_DUPLEX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Renegotiating link state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneLink</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TuneFastLink</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_LNK_NEGOTIATION</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;acenic&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span> <span class="s">&quot;%i.%i.%i&quot;</span><span class="p">,</span>
		 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_major</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_minor</span><span class="p">,</span>
		 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_fix</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the hardware MAC address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ace_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">da</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">da</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MacAddrHi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">da</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">da</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MacAddrLo</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_MAC_ADDR</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ace_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_MULTICAST_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_MCAST_ENABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_MULTICAST_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_MCAST_DISABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_PROMISC_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_PROMISC_ENABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_PROMISC_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_PROMISC_DISABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the time being multicast relies on the upper layers</span>
<span class="cm">	 * filtering it properly. The Firmware does not allow one to</span>
<span class="cm">	 * set the entire multicast list at a time and keeping track of</span>
<span class="cm">	 * it here is going to be messy.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_MULTICAST_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_MCAST_ENABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mcast_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">C_SET_MULTICAST_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_C_MCAST_DISABLE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ace_issue_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">ace_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_mac_stats</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mac_stats</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ace_mac_stats</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Stats</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">drop_space</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">kept_mc</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">coll</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ace_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tdest</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="p">((</span><span class="o">~</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACE_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			    <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ACE_WINDOW_SIZE</span><span class="p">));</span>
		<span class="n">tdest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Window</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACE_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ACE_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tsize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Firmware is big-endian */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">tdest</span><span class="p">);</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tdest</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">dest</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ace_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tdest</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">tsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="p">((</span><span class="o">~</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACE_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ACE_WINDOW_SIZE</span><span class="p">));</span>
		<span class="n">tdest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Window</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACE_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ACE_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tsize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tdest</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dest</span> <span class="o">+=</span> <span class="n">tsize</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">tsize</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Download the firmware into the SRAM on the NIC</span>
<span class="cm"> *</span>
<span class="cm"> * This operation requires the NIC to be halted and is performed with</span>
<span class="cm"> * interrupts disabled and with the spinlock hold.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ace_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;acenic/tg2.bin&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">load_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CpuCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPU_HALTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: trying to download firmware while the &quot;</span>
		       <span class="s">&quot;CPU is running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACE_IS_TIGON_I</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;acenic/tg1.bin&quot;</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Firmware blob starts with version numbers, followed by</span>
<span class="cm">	   load and start address. Remainder is the blob to be loaded</span>
<span class="cm">	   contiguously from load address. We don&#39;t bother to represent</span>
<span class="cm">	   the BSS/SBSS sections any more, since we were clearing the</span>
<span class="cm">	   whole thing anyway. */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_major</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_minor</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_fix</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_start</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_start</span> <span class="o">&lt;</span> <span class="mh">0x4000</span> <span class="o">||</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_start</span> <span class="o">&gt;=</span> <span class="mh">0x80000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bogus load address %08x in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">firmware_start</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">load_addr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">load_addr</span> <span class="o">&lt;</span> <span class="mh">0x4000</span> <span class="o">||</span> <span class="n">load_addr</span> <span class="o">&gt;=</span> <span class="mh">0x80000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bogus load address %08x in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">load_addr</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not try to clear more than 512KiB or we end up seeing</span>
<span class="cm">	 * funny things on NICs with only 512KiB SRAM</span>
<span class="cm">	 */</span>
	<span class="n">ace_clear</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x80000</span><span class="o">-</span><span class="mh">0x2000</span><span class="p">);</span>
	<span class="n">ace_copy</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">load_addr</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="mi">12</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * The eeprom on the AceNIC is an Atmel i2c EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> * Accessing the EEPROM is `interesting&#39; to say the least - don&#39;t read</span>
<span class="cm"> * this code right after dinner.</span>
<span class="cm"> *</span>
<span class="cm"> * This is all about black magic and bit-banging the device .... I</span>
<span class="cm"> * wonder in what hospital they have put the guy who designed the i2c</span>
<span class="cm"> * specs.</span>
<span class="cm"> *</span>
<span class="cm"> * Oh yes, this is only the beginning!</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Stevarino Webinski for helping tracking down the bugs in the</span>
<span class="cm"> * code i2c readout code by beta testing all my hacks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">eeprom_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_DATA_OUT</span> <span class="o">|</span> <span class="n">EEPROM_WRITE_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">eeprom_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u8</span> <span class="n">magic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_WRITE_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">magic</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>

		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EEPROM_CLK_OUT</span> <span class="o">|</span> <span class="n">EEPROM_DATA_OUT</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eeprom_check_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_WRITE_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_LONG_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="cm">/* sample data in middle of high clk */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEPROM_DATA_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_CLK_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">eeprom_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_WRITE_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_LONG_DELAY</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read a whole byte from the EEPROM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">read_eeprom_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ace_private</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ace_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t take interrupts on this CPU will bit banging</span>
<span class="cm">	 * the %#%#@$ I2C device</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">eeprom_start</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">eeprom_prep</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">EEPROM_WRITE_SELECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_check_ack</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to sync eeprom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eeprom_read_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eeprom_prep</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_check_ack</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to set address byte 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eeprom_read_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eeprom_prep</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_check_ack</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to set address byte 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eeprom_read_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eeprom_start</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">eeprom_prep</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">EEPROM_READ_SELECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_check_ack</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to set READ_SELECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eeprom_read_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_WRITE_ENABLE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_LONG_DELAY</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="cm">/* sample data mid high clk */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEPROM_DATA_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">local</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">local</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_CLK_OUT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_WRITE_ENABLE</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">local</span> <span class="o">|=</span> <span class="n">EEPROM_DATA_OUT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">EEPROM_CLK_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_LONG_DELAY</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_CLK_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ACE_SHORT_DELAY</span><span class="p">);</span>
	<span class="n">eeprom_stop</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

 <span class="nl">eeprom_read_error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to read eeprom byte 0x%02lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
