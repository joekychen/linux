<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › nvidia › forcedeth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>forcedeth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * forcedeth: Ethernet driver for NVIDIA nForce media access controllers.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: This driver is a cleanroom reimplementation based on reverse</span>
<span class="cm"> *      engineered documentation written by Carl-Daniel Hailfinger</span>
<span class="cm"> *      and Andrew de Quincey.</span>
<span class="cm"> *</span>
<span class="cm"> * NVIDIA, nForce and other NVIDIA marks are trademarks or registered</span>
<span class="cm"> * trademarks of NVIDIA Corporation in the United States and other</span>
<span class="cm"> * countries.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003,4,5 Manfred Spraul</span>
<span class="cm"> * Copyright (C) 2004 Andrew de Quincey (wol support)</span>
<span class="cm"> * Copyright (C) 2004 Carl-Daniel Hailfinger (invalid MAC handling, insane</span>
<span class="cm"> *		IRQ rate fixes, bigendian fixes, cleanups, verification)</span>
<span class="cm"> * Copyright (c) 2004,2005,2006,2007,2008,2009 NVIDIA Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * Known bugs:</span>
<span class="cm"> * We suspect that on some hardware no TX done interrupts are generated.</span>
<span class="cm"> * This means recovery from netif_stop_queue only happens if the hw timer</span>
<span class="cm"> * interrupt fires (100 times/second, configurable with NVREG_POLL_DEFAULT)</span>
<span class="cm"> * and the timer is active in the IRQMask, or if a rx packet arrives by chance.</span>
<span class="cm"> * If your hardware reliably generates tx done interrupts, then you can remove</span>
<span class="cm"> * DEV_NEED_TIMERIRQ from the driver_data flags.</span>
<span class="cm"> * DEV_NEED_TIMERIRQ will not harm you on sane hardware, only generating a few</span>
<span class="cm"> * superfluous timer interrupts from the nic.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define FORCEDETH_VERSION		&quot;0.64&quot;</span>
<span class="cp">#define DRV_NAME			&quot;forcedeth&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/u64_stats_sync.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#define TX_WORK_PER_LOOP  64</span>
<span class="cp">#define RX_WORK_PER_LOOP  64</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware access:</span>
<span class="cm"> */</span>

<span class="cp">#define DEV_NEED_TIMERIRQ          0x0000001  </span><span class="cm">/* set the timer irq flag in the irq mask */</span><span class="cp"></span>
<span class="cp">#define DEV_NEED_LINKTIMER         0x0000002  </span><span class="cm">/* poll link settings. Relies on the timer irq */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_LARGEDESC          0x0000004  </span><span class="cm">/* device supports jumbo frames and needs packet format 2 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_HIGH_DMA           0x0000008  </span><span class="cm">/* device supports 64bit dma */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_CHECKSUM           0x0000010  </span><span class="cm">/* device supports tx and rx checksum offloads */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_VLAN               0x0000020  </span><span class="cm">/* device supports vlan tagging and striping */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_MSI                0x0000040  </span><span class="cm">/* device supports MSI */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_MSI_X              0x0000080  </span><span class="cm">/* device supports MSI-X */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_POWER_CNTRL        0x0000100  </span><span class="cm">/* device supports power savings */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_STATISTICS_V1      0x0000200  </span><span class="cm">/* device supports hw statistics version 1 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_STATISTICS_V2      0x0000400  </span><span class="cm">/* device supports hw statistics version 2 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_STATISTICS_V3      0x0000800  </span><span class="cm">/* device supports hw statistics version 3 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_STATISTICS_V12     0x0000600  </span><span class="cm">/* device supports hw statistics version 1 and 2 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_STATISTICS_V123    0x0000e00  </span><span class="cm">/* device supports hw statistics version 1, 2, and 3 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_TEST_EXTENDED      0x0001000  </span><span class="cm">/* device supports extended diagnostic test */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_MGMT_UNIT          0x0002000  </span><span class="cm">/* device supports management unit */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_CORRECT_MACADDR    0x0004000  </span><span class="cm">/* device supports correct mac address order */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_COLLISION_FIX      0x0008000  </span><span class="cm">/* device supports tx collision fix */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_PAUSEFRAME_TX_V1   0x0010000  </span><span class="cm">/* device supports tx pause frames version 1 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_PAUSEFRAME_TX_V2   0x0020000  </span><span class="cm">/* device supports tx pause frames version 2 */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_PAUSEFRAME_TX_V3   0x0040000  </span><span class="cm">/* device supports tx pause frames version 3 */</span><span class="cp"></span>
<span class="cp">#define DEV_NEED_TX_LIMIT          0x0080000  </span><span class="cm">/* device needs to limit tx */</span><span class="cp"></span>
<span class="cp">#define DEV_NEED_TX_LIMIT2         0x0180000  </span><span class="cm">/* device needs to limit tx, expect for some revs */</span><span class="cp"></span>
<span class="cp">#define DEV_HAS_GEAR_MODE          0x0200000  </span><span class="cm">/* device supports gear mode */</span><span class="cp"></span>
<span class="cp">#define DEV_NEED_PHY_INIT_FIX      0x0400000  </span><span class="cm">/* device needs specific phy workaround */</span><span class="cp"></span>
<span class="cp">#define DEV_NEED_LOW_POWER_FIX     0x0800000  </span><span class="cm">/* device needs special power up workaround */</span><span class="cp"></span>
<span class="cp">#define DEV_NEED_MSI_FIX           0x1000000  </span><span class="cm">/* device needs msi workaround */</span><span class="cp"></span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NvRegIrqStatus</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">,</span>
<span class="cp">#define NVREG_IRQSTAT_MIIEVENT	0x040</span>
<span class="cp">#define NVREG_IRQSTAT_MASK		0x83ff</span>
	<span class="n">NvRegIrqMask</span> <span class="o">=</span> <span class="mh">0x004</span><span class="p">,</span>
<span class="cp">#define NVREG_IRQ_RX_ERROR		0x0001</span>
<span class="cp">#define NVREG_IRQ_RX			0x0002</span>
<span class="cp">#define NVREG_IRQ_RX_NOBUF		0x0004</span>
<span class="cp">#define NVREG_IRQ_TX_ERR		0x0008</span>
<span class="cp">#define NVREG_IRQ_TX_OK			0x0010</span>
<span class="cp">#define NVREG_IRQ_TIMER			0x0020</span>
<span class="cp">#define NVREG_IRQ_LINK			0x0040</span>
<span class="cp">#define NVREG_IRQ_RX_FORCED		0x0080</span>
<span class="cp">#define NVREG_IRQ_TX_FORCED		0x0100</span>
<span class="cp">#define NVREG_IRQ_RECOVER_ERROR		0x8200</span>
<span class="cp">#define NVREG_IRQMASK_THROUGHPUT	0x00df</span>
<span class="cp">#define NVREG_IRQMASK_CPU		0x0060</span>
<span class="cp">#define NVREG_IRQ_TX_ALL		(NVREG_IRQ_TX_ERR|NVREG_IRQ_TX_OK|NVREG_IRQ_TX_FORCED)</span>
<span class="cp">#define NVREG_IRQ_RX_ALL		(NVREG_IRQ_RX_ERROR|NVREG_IRQ_RX|NVREG_IRQ_RX_NOBUF|NVREG_IRQ_RX_FORCED)</span>
<span class="cp">#define NVREG_IRQ_OTHER			(NVREG_IRQ_TIMER|NVREG_IRQ_LINK|NVREG_IRQ_RECOVER_ERROR)</span>

	<span class="n">NvRegUnknownSetupReg6</span> <span class="o">=</span> <span class="mh">0x008</span><span class="p">,</span>
<span class="cp">#define NVREG_UNKSETUP6_VAL		3</span>

<span class="cm">/*</span>
<span class="cm"> * NVREG_POLL_DEFAULT is the interval length of the timer source on the nic</span>
<span class="cm"> * NVREG_POLL_DEFAULT=97 would result in an interval length of 1 ms</span>
<span class="cm"> */</span>
	<span class="n">NvRegPollingInterval</span> <span class="o">=</span> <span class="mh">0x00c</span><span class="p">,</span>
<span class="cp">#define NVREG_POLL_DEFAULT_THROUGHPUT	65535 </span><span class="cm">/* backup tx cleanup if loop max reached */</span><span class="cp"></span>
<span class="cp">#define NVREG_POLL_DEFAULT_CPU	13</span>
	<span class="n">NvRegMSIMap0</span> <span class="o">=</span> <span class="mh">0x020</span><span class="p">,</span>
	<span class="n">NvRegMSIMap1</span> <span class="o">=</span> <span class="mh">0x024</span><span class="p">,</span>
	<span class="n">NvRegMSIIrqMask</span> <span class="o">=</span> <span class="mh">0x030</span><span class="p">,</span>
<span class="cp">#define NVREG_MSI_VECTOR_0_ENABLED 0x01</span>
	<span class="n">NvRegMisc1</span> <span class="o">=</span> <span class="mh">0x080</span><span class="p">,</span>
<span class="cp">#define NVREG_MISC1_PAUSE_TX	0x01</span>
<span class="cp">#define NVREG_MISC1_HD		0x02</span>
<span class="cp">#define NVREG_MISC1_FORCE	0x3b0f3c</span>

	<span class="n">NvRegMacReset</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>
<span class="cp">#define NVREG_MAC_RESET_ASSERT	0x0F3</span>
	<span class="n">NvRegTransmitterControl</span> <span class="o">=</span> <span class="mh">0x084</span><span class="p">,</span>
<span class="cp">#define NVREG_XMITCTL_START	0x01</span>
<span class="cp">#define NVREG_XMITCTL_MGMT_ST	0x40000000</span>
<span class="cp">#define NVREG_XMITCTL_SYNC_MASK		0x000f0000</span>
<span class="cp">#define NVREG_XMITCTL_SYNC_NOT_READY	0x0</span>
<span class="cp">#define NVREG_XMITCTL_SYNC_PHY_INIT	0x00040000</span>
<span class="cp">#define NVREG_XMITCTL_MGMT_SEMA_MASK	0x00000f00</span>
<span class="cp">#define NVREG_XMITCTL_MGMT_SEMA_FREE	0x0</span>
<span class="cp">#define NVREG_XMITCTL_HOST_SEMA_MASK	0x0000f000</span>
<span class="cp">#define NVREG_XMITCTL_HOST_SEMA_ACQ	0x0000f000</span>
<span class="cp">#define NVREG_XMITCTL_HOST_LOADED	0x00004000</span>
<span class="cp">#define NVREG_XMITCTL_TX_PATH_EN	0x01000000</span>
<span class="cp">#define NVREG_XMITCTL_DATA_START	0x00100000</span>
<span class="cp">#define NVREG_XMITCTL_DATA_READY	0x00010000</span>
<span class="cp">#define NVREG_XMITCTL_DATA_ERROR	0x00020000</span>
	<span class="n">NvRegTransmitterStatus</span> <span class="o">=</span> <span class="mh">0x088</span><span class="p">,</span>
<span class="cp">#define NVREG_XMITSTAT_BUSY	0x01</span>

	<span class="n">NvRegPacketFilterFlags</span> <span class="o">=</span> <span class="mh">0x8c</span><span class="p">,</span>
<span class="cp">#define NVREG_PFF_PAUSE_RX	0x08</span>
<span class="cp">#define NVREG_PFF_ALWAYS	0x7F0000</span>
<span class="cp">#define NVREG_PFF_PROMISC	0x80</span>
<span class="cp">#define NVREG_PFF_MYADDR	0x20</span>
<span class="cp">#define NVREG_PFF_LOOPBACK	0x10</span>

	<span class="n">NvRegOffloadConfig</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">,</span>
<span class="cp">#define NVREG_OFFLOAD_HOMEPHY	0x601</span>
<span class="cp">#define NVREG_OFFLOAD_NORMAL	RX_NIC_BUFSIZE</span>
	<span class="n">NvRegReceiverControl</span> <span class="o">=</span> <span class="mh">0x094</span><span class="p">,</span>
<span class="cp">#define NVREG_RCVCTL_START	0x01</span>
<span class="cp">#define NVREG_RCVCTL_RX_PATH_EN	0x01000000</span>
	<span class="n">NvRegReceiverStatus</span> <span class="o">=</span> <span class="mh">0x98</span><span class="p">,</span>
<span class="cp">#define NVREG_RCVSTAT_BUSY	0x01</span>

	<span class="n">NvRegSlotTime</span> <span class="o">=</span> <span class="mh">0x9c</span><span class="p">,</span>
<span class="cp">#define NVREG_SLOTTIME_LEGBF_ENABLED	0x80000000</span>
<span class="cp">#define NVREG_SLOTTIME_10_100_FULL	0x00007f00</span>
<span class="cp">#define NVREG_SLOTTIME_1000_FULL	0x0003ff00</span>
<span class="cp">#define NVREG_SLOTTIME_HALF		0x0000ff00</span>
<span class="cp">#define NVREG_SLOTTIME_DEFAULT		0x00007f00</span>
<span class="cp">#define NVREG_SLOTTIME_MASK		0x000000ff</span>

	<span class="n">NvRegTxDeferral</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span>
<span class="cp">#define NVREG_TX_DEFERRAL_DEFAULT		0x15050f</span>
<span class="cp">#define NVREG_TX_DEFERRAL_RGMII_10_100		0x16070f</span>
<span class="cp">#define NVREG_TX_DEFERRAL_RGMII_1000		0x14050f</span>
<span class="cp">#define NVREG_TX_DEFERRAL_RGMII_STRETCH_10	0x16190f</span>
<span class="cp">#define NVREG_TX_DEFERRAL_RGMII_STRETCH_100	0x16300f</span>
<span class="cp">#define NVREG_TX_DEFERRAL_MII_STRETCH		0x152000</span>
	<span class="n">NvRegRxDeferral</span> <span class="o">=</span> <span class="mh">0xA4</span><span class="p">,</span>
<span class="cp">#define NVREG_RX_DEFERRAL_DEFAULT	0x16</span>
	<span class="n">NvRegMacAddrA</span> <span class="o">=</span> <span class="mh">0xA8</span><span class="p">,</span>
	<span class="n">NvRegMacAddrB</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">,</span>
	<span class="n">NvRegMulticastAddrA</span> <span class="o">=</span> <span class="mh">0xB0</span><span class="p">,</span>
<span class="cp">#define NVREG_MCASTADDRA_FORCE	0x01</span>
	<span class="n">NvRegMulticastAddrB</span> <span class="o">=</span> <span class="mh">0xB4</span><span class="p">,</span>
	<span class="n">NvRegMulticastMaskA</span> <span class="o">=</span> <span class="mh">0xB8</span><span class="p">,</span>
<span class="cp">#define NVREG_MCASTMASKA_NONE		0xffffffff</span>
	<span class="n">NvRegMulticastMaskB</span> <span class="o">=</span> <span class="mh">0xBC</span><span class="p">,</span>
<span class="cp">#define NVREG_MCASTMASKB_NONE		0xffff</span>

	<span class="n">NvRegPhyInterface</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
<span class="cp">#define PHY_RGMII		0x10000000</span>
	<span class="n">NvRegBackOffControl</span> <span class="o">=</span> <span class="mh">0xC4</span><span class="p">,</span>
<span class="cp">#define NVREG_BKOFFCTRL_DEFAULT			0x70000000</span>
<span class="cp">#define NVREG_BKOFFCTRL_SEED_MASK		0x000003ff</span>
<span class="cp">#define NVREG_BKOFFCTRL_SELECT			24</span>
<span class="cp">#define NVREG_BKOFFCTRL_GEAR			12</span>

	<span class="n">NvRegTxRingPhysAddr</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">NvRegRxRingPhysAddr</span> <span class="o">=</span> <span class="mh">0x104</span><span class="p">,</span>
	<span class="n">NvRegRingSizes</span> <span class="o">=</span> <span class="mh">0x108</span><span class="p">,</span>
<span class="cp">#define NVREG_RINGSZ_TXSHIFT 0</span>
<span class="cp">#define NVREG_RINGSZ_RXSHIFT 16</span>
	<span class="n">NvRegTransmitPoll</span> <span class="o">=</span> <span class="mh">0x10c</span><span class="p">,</span>
<span class="cp">#define NVREG_TRANSMITPOLL_MAC_ADDR_REV	0x00008000</span>
	<span class="n">NvRegLinkSpeed</span> <span class="o">=</span> <span class="mh">0x110</span><span class="p">,</span>
<span class="cp">#define NVREG_LINKSPEED_FORCE 0x10000</span>
<span class="cp">#define NVREG_LINKSPEED_10	1000</span>
<span class="cp">#define NVREG_LINKSPEED_100	100</span>
<span class="cp">#define NVREG_LINKSPEED_1000	50</span>
<span class="cp">#define NVREG_LINKSPEED_MASK	(0xFFF)</span>
	<span class="n">NvRegUnknownSetupReg5</span> <span class="o">=</span> <span class="mh">0x130</span><span class="p">,</span>
<span class="cp">#define NVREG_UNKSETUP5_BIT31	(1&lt;&lt;31)</span>
	<span class="n">NvRegTxWatermark</span> <span class="o">=</span> <span class="mh">0x13c</span><span class="p">,</span>
<span class="cp">#define NVREG_TX_WM_DESC1_DEFAULT	0x0200010</span>
<span class="cp">#define NVREG_TX_WM_DESC2_3_DEFAULT	0x1e08000</span>
<span class="cp">#define NVREG_TX_WM_DESC2_3_1000	0xfe08000</span>
	<span class="n">NvRegTxRxControl</span> <span class="o">=</span> <span class="mh">0x144</span><span class="p">,</span>
<span class="cp">#define NVREG_TXRXCTL_KICK	0x0001</span>
<span class="cp">#define NVREG_TXRXCTL_BIT1	0x0002</span>
<span class="cp">#define NVREG_TXRXCTL_BIT2	0x0004</span>
<span class="cp">#define NVREG_TXRXCTL_IDLE	0x0008</span>
<span class="cp">#define NVREG_TXRXCTL_RESET	0x0010</span>
<span class="cp">#define NVREG_TXRXCTL_RXCHECK	0x0400</span>
<span class="cp">#define NVREG_TXRXCTL_DESC_1	0</span>
<span class="cp">#define NVREG_TXRXCTL_DESC_2	0x002100</span>
<span class="cp">#define NVREG_TXRXCTL_DESC_3	0xc02200</span>
<span class="cp">#define NVREG_TXRXCTL_VLANSTRIP 0x00040</span>
<span class="cp">#define NVREG_TXRXCTL_VLANINS	0x00080</span>
	<span class="n">NvRegTxRingPhysAddrHigh</span> <span class="o">=</span> <span class="mh">0x148</span><span class="p">,</span>
	<span class="n">NvRegRxRingPhysAddrHigh</span> <span class="o">=</span> <span class="mh">0x14C</span><span class="p">,</span>
	<span class="n">NvRegTxPauseFrame</span> <span class="o">=</span> <span class="mh">0x170</span><span class="p">,</span>
<span class="cp">#define NVREG_TX_PAUSEFRAME_DISABLE	0x0fff0080</span>
<span class="cp">#define NVREG_TX_PAUSEFRAME_ENABLE_V1	0x01800010</span>
<span class="cp">#define NVREG_TX_PAUSEFRAME_ENABLE_V2	0x056003f0</span>
<span class="cp">#define NVREG_TX_PAUSEFRAME_ENABLE_V3	0x09f00880</span>
	<span class="n">NvRegTxPauseFrameLimit</span> <span class="o">=</span> <span class="mh">0x174</span><span class="p">,</span>
<span class="cp">#define NVREG_TX_PAUSEFRAMELIMIT_ENABLE	0x00010000</span>
	<span class="n">NvRegMIIStatus</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">,</span>
<span class="cp">#define NVREG_MIISTAT_ERROR		0x0001</span>
<span class="cp">#define NVREG_MIISTAT_LINKCHANGE	0x0008</span>
<span class="cp">#define NVREG_MIISTAT_MASK_RW		0x0007</span>
<span class="cp">#define NVREG_MIISTAT_MASK_ALL		0x000f</span>
	<span class="n">NvRegMIIMask</span> <span class="o">=</span> <span class="mh">0x184</span><span class="p">,</span>
<span class="cp">#define NVREG_MII_LINKCHANGE		0x0008</span>

	<span class="n">NvRegAdapterControl</span> <span class="o">=</span> <span class="mh">0x188</span><span class="p">,</span>
<span class="cp">#define NVREG_ADAPTCTL_START	0x02</span>
<span class="cp">#define NVREG_ADAPTCTL_LINKUP	0x04</span>
<span class="cp">#define NVREG_ADAPTCTL_PHYVALID	0x40000</span>
<span class="cp">#define NVREG_ADAPTCTL_RUNNING	0x100000</span>
<span class="cp">#define NVREG_ADAPTCTL_PHYSHIFT	24</span>
	<span class="n">NvRegMIISpeed</span> <span class="o">=</span> <span class="mh">0x18c</span><span class="p">,</span>
<span class="cp">#define NVREG_MIISPEED_BIT8	(1&lt;&lt;8)</span>
<span class="cp">#define NVREG_MIIDELAY	5</span>
	<span class="n">NvRegMIIControl</span> <span class="o">=</span> <span class="mh">0x190</span><span class="p">,</span>
<span class="cp">#define NVREG_MIICTL_INUSE	0x08000</span>
<span class="cp">#define NVREG_MIICTL_WRITE	0x00400</span>
<span class="cp">#define NVREG_MIICTL_ADDRSHIFT	5</span>
	<span class="n">NvRegMIIData</span> <span class="o">=</span> <span class="mh">0x194</span><span class="p">,</span>
	<span class="n">NvRegTxUnicast</span> <span class="o">=</span> <span class="mh">0x1a0</span><span class="p">,</span>
	<span class="n">NvRegTxMulticast</span> <span class="o">=</span> <span class="mh">0x1a4</span><span class="p">,</span>
	<span class="n">NvRegTxBroadcast</span> <span class="o">=</span> <span class="mh">0x1a8</span><span class="p">,</span>
	<span class="n">NvRegWakeUpFlags</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_VAL		0x7770</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_BUSYSHIFT	24</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_ENABLESHIFT	16</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_D3SHIFT	12</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_D2SHIFT	8</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_D1SHIFT	4</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_D0SHIFT	0</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_ACCEPT_MAGPAT		0x01</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_ACCEPT_WAKEUPPAT	0x02</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_ACCEPT_LINKCHANGE	0x04</span>
<span class="cp">#define NVREG_WAKEUPFLAGS_ENABLE	0x1111</span>

	<span class="n">NvRegMgmtUnitGetVersion</span> <span class="o">=</span> <span class="mh">0x204</span><span class="p">,</span>
<span class="cp">#define NVREG_MGMTUNITGETVERSION	0x01</span>
	<span class="n">NvRegMgmtUnitVersion</span> <span class="o">=</span> <span class="mh">0x208</span><span class="p">,</span>
<span class="cp">#define NVREG_MGMTUNITVERSION		0x08</span>
	<span class="n">NvRegPowerCap</span> <span class="o">=</span> <span class="mh">0x268</span><span class="p">,</span>
<span class="cp">#define NVREG_POWERCAP_D3SUPP	(1&lt;&lt;30)</span>
<span class="cp">#define NVREG_POWERCAP_D2SUPP	(1&lt;&lt;26)</span>
<span class="cp">#define NVREG_POWERCAP_D1SUPP	(1&lt;&lt;25)</span>
	<span class="n">NvRegPowerState</span> <span class="o">=</span> <span class="mh">0x26c</span><span class="p">,</span>
<span class="cp">#define NVREG_POWERSTATE_POWEREDUP	0x8000</span>
<span class="cp">#define NVREG_POWERSTATE_VALID		0x0100</span>
<span class="cp">#define NVREG_POWERSTATE_MASK		0x0003</span>
<span class="cp">#define NVREG_POWERSTATE_D0		0x0000</span>
<span class="cp">#define NVREG_POWERSTATE_D1		0x0001</span>
<span class="cp">#define NVREG_POWERSTATE_D2		0x0002</span>
<span class="cp">#define NVREG_POWERSTATE_D3		0x0003</span>
	<span class="n">NvRegMgmtUnitControl</span> <span class="o">=</span> <span class="mh">0x278</span><span class="p">,</span>
<span class="cp">#define NVREG_MGMTUNITCONTROL_INUSE	0x20000</span>
	<span class="n">NvRegTxCnt</span> <span class="o">=</span> <span class="mh">0x280</span><span class="p">,</span>
	<span class="n">NvRegTxZeroReXmt</span> <span class="o">=</span> <span class="mh">0x284</span><span class="p">,</span>
	<span class="n">NvRegTxOneReXmt</span> <span class="o">=</span> <span class="mh">0x288</span><span class="p">,</span>
	<span class="n">NvRegTxManyReXmt</span> <span class="o">=</span> <span class="mh">0x28c</span><span class="p">,</span>
	<span class="n">NvRegTxLateCol</span> <span class="o">=</span> <span class="mh">0x290</span><span class="p">,</span>
	<span class="n">NvRegTxUnderflow</span> <span class="o">=</span> <span class="mh">0x294</span><span class="p">,</span>
	<span class="n">NvRegTxLossCarrier</span> <span class="o">=</span> <span class="mh">0x298</span><span class="p">,</span>
	<span class="n">NvRegTxExcessDef</span> <span class="o">=</span> <span class="mh">0x29c</span><span class="p">,</span>
	<span class="n">NvRegTxRetryErr</span> <span class="o">=</span> <span class="mh">0x2a0</span><span class="p">,</span>
	<span class="n">NvRegRxFrameErr</span> <span class="o">=</span> <span class="mh">0x2a4</span><span class="p">,</span>
	<span class="n">NvRegRxExtraByte</span> <span class="o">=</span> <span class="mh">0x2a8</span><span class="p">,</span>
	<span class="n">NvRegRxLateCol</span> <span class="o">=</span> <span class="mh">0x2ac</span><span class="p">,</span>
	<span class="n">NvRegRxRunt</span> <span class="o">=</span> <span class="mh">0x2b0</span><span class="p">,</span>
	<span class="n">NvRegRxFrameTooLong</span> <span class="o">=</span> <span class="mh">0x2b4</span><span class="p">,</span>
	<span class="n">NvRegRxOverflow</span> <span class="o">=</span> <span class="mh">0x2b8</span><span class="p">,</span>
	<span class="n">NvRegRxFCSErr</span> <span class="o">=</span> <span class="mh">0x2bc</span><span class="p">,</span>
	<span class="n">NvRegRxFrameAlignErr</span> <span class="o">=</span> <span class="mh">0x2c0</span><span class="p">,</span>
	<span class="n">NvRegRxLenErr</span> <span class="o">=</span> <span class="mh">0x2c4</span><span class="p">,</span>
	<span class="n">NvRegRxUnicast</span> <span class="o">=</span> <span class="mh">0x2c8</span><span class="p">,</span>
	<span class="n">NvRegRxMulticast</span> <span class="o">=</span> <span class="mh">0x2cc</span><span class="p">,</span>
	<span class="n">NvRegRxBroadcast</span> <span class="o">=</span> <span class="mh">0x2d0</span><span class="p">,</span>
	<span class="n">NvRegTxDef</span> <span class="o">=</span> <span class="mh">0x2d4</span><span class="p">,</span>
	<span class="n">NvRegTxFrame</span> <span class="o">=</span> <span class="mh">0x2d8</span><span class="p">,</span>
	<span class="n">NvRegRxCnt</span> <span class="o">=</span> <span class="mh">0x2dc</span><span class="p">,</span>
	<span class="n">NvRegTxPause</span> <span class="o">=</span> <span class="mh">0x2e0</span><span class="p">,</span>
	<span class="n">NvRegRxPause</span> <span class="o">=</span> <span class="mh">0x2e4</span><span class="p">,</span>
	<span class="n">NvRegRxDropFrame</span> <span class="o">=</span> <span class="mh">0x2e8</span><span class="p">,</span>
	<span class="n">NvRegVlanControl</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>
<span class="cp">#define NVREG_VLANCONTROL_ENABLE	0x2000</span>
	<span class="n">NvRegMSIXMap0</span> <span class="o">=</span> <span class="mh">0x3e0</span><span class="p">,</span>
	<span class="n">NvRegMSIXMap1</span> <span class="o">=</span> <span class="mh">0x3e4</span><span class="p">,</span>
	<span class="n">NvRegMSIXIrqStatus</span> <span class="o">=</span> <span class="mh">0x3f0</span><span class="p">,</span>

	<span class="n">NvRegPowerState2</span> <span class="o">=</span> <span class="mh">0x600</span><span class="p">,</span>
<span class="cp">#define NVREG_POWERSTATE2_POWERUP_MASK		0x0F15</span>
<span class="cp">#define NVREG_POWERSTATE2_POWERUP_REV_A3	0x0001</span>
<span class="cp">#define NVREG_POWERSTATE2_PHY_RESET		0x0004</span>
<span class="cp">#define NVREG_POWERSTATE2_GATE_CLOCKS		0x0F00</span>
<span class="p">};</span>

<span class="cm">/* Big endian: should work, but is untested */</span>
<span class="k">struct</span> <span class="n">ring_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">flaglen</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">bufhigh</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buflow</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">txvlan</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">flaglen</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">ring_type</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">orig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">ex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FLAG_MASK_V1 0xffff0000</span>
<span class="cp">#define FLAG_MASK_V2 0xffffc000</span>
<span class="cp">#define LEN_MASK_V1 (0xffffffff ^ FLAG_MASK_V1)</span>
<span class="cp">#define LEN_MASK_V2 (0xffffffff ^ FLAG_MASK_V2)</span>

<span class="cp">#define NV_TX_LASTPACKET	(1&lt;&lt;16)</span>
<span class="cp">#define NV_TX_RETRYERROR	(1&lt;&lt;19)</span>
<span class="cp">#define NV_TX_RETRYCOUNT_MASK	(0xF&lt;&lt;20)</span>
<span class="cp">#define NV_TX_FORCED_INTERRUPT	(1&lt;&lt;24)</span>
<span class="cp">#define NV_TX_DEFERRED		(1&lt;&lt;26)</span>
<span class="cp">#define NV_TX_CARRIERLOST	(1&lt;&lt;27)</span>
<span class="cp">#define NV_TX_LATECOLLISION	(1&lt;&lt;28)</span>
<span class="cp">#define NV_TX_UNDERFLOW		(1&lt;&lt;29)</span>
<span class="cp">#define NV_TX_ERROR		(1&lt;&lt;30)</span>
<span class="cp">#define NV_TX_VALID		(1&lt;&lt;31)</span>

<span class="cp">#define NV_TX2_LASTPACKET	(1&lt;&lt;29)</span>
<span class="cp">#define NV_TX2_RETRYERROR	(1&lt;&lt;18)</span>
<span class="cp">#define NV_TX2_RETRYCOUNT_MASK	(0xF&lt;&lt;19)</span>
<span class="cp">#define NV_TX2_FORCED_INTERRUPT	(1&lt;&lt;30)</span>
<span class="cp">#define NV_TX2_DEFERRED		(1&lt;&lt;25)</span>
<span class="cp">#define NV_TX2_CARRIERLOST	(1&lt;&lt;26)</span>
<span class="cp">#define NV_TX2_LATECOLLISION	(1&lt;&lt;27)</span>
<span class="cp">#define NV_TX2_UNDERFLOW	(1&lt;&lt;28)</span>
<span class="cm">/* error and valid are the same for both */</span>
<span class="cp">#define NV_TX2_ERROR		(1&lt;&lt;30)</span>
<span class="cp">#define NV_TX2_VALID		(1&lt;&lt;31)</span>
<span class="cp">#define NV_TX2_TSO		(1&lt;&lt;28)</span>
<span class="cp">#define NV_TX2_TSO_SHIFT	14</span>
<span class="cp">#define NV_TX2_TSO_MAX_SHIFT	14</span>
<span class="cp">#define NV_TX2_TSO_MAX_SIZE	(1&lt;&lt;NV_TX2_TSO_MAX_SHIFT)</span>
<span class="cp">#define NV_TX2_CHECKSUM_L3	(1&lt;&lt;27)</span>
<span class="cp">#define NV_TX2_CHECKSUM_L4	(1&lt;&lt;26)</span>

<span class="cp">#define NV_TX3_VLAN_TAG_PRESENT (1&lt;&lt;18)</span>

<span class="cp">#define NV_RX_DESCRIPTORVALID	(1&lt;&lt;16)</span>
<span class="cp">#define NV_RX_MISSEDFRAME	(1&lt;&lt;17)</span>
<span class="cp">#define NV_RX_SUBSTRACT1	(1&lt;&lt;18)</span>
<span class="cp">#define NV_RX_ERROR1		(1&lt;&lt;23)</span>
<span class="cp">#define NV_RX_ERROR2		(1&lt;&lt;24)</span>
<span class="cp">#define NV_RX_ERROR3		(1&lt;&lt;25)</span>
<span class="cp">#define NV_RX_ERROR4		(1&lt;&lt;26)</span>
<span class="cp">#define NV_RX_CRCERR		(1&lt;&lt;27)</span>
<span class="cp">#define NV_RX_OVERFLOW		(1&lt;&lt;28)</span>
<span class="cp">#define NV_RX_FRAMINGERR	(1&lt;&lt;29)</span>
<span class="cp">#define NV_RX_ERROR		(1&lt;&lt;30)</span>
<span class="cp">#define NV_RX_AVAIL		(1&lt;&lt;31)</span>
<span class="cp">#define NV_RX_ERROR_MASK	(NV_RX_ERROR1|NV_RX_ERROR2|NV_RX_ERROR3|NV_RX_ERROR4|NV_RX_CRCERR|NV_RX_OVERFLOW|NV_RX_FRAMINGERR)</span>

<span class="cp">#define NV_RX2_CHECKSUMMASK	(0x1C000000)</span>
<span class="cp">#define NV_RX2_CHECKSUM_IP	(0x10000000)</span>
<span class="cp">#define NV_RX2_CHECKSUM_IP_TCP	(0x14000000)</span>
<span class="cp">#define NV_RX2_CHECKSUM_IP_UDP	(0x18000000)</span>
<span class="cp">#define NV_RX2_DESCRIPTORVALID	(1&lt;&lt;29)</span>
<span class="cp">#define NV_RX2_SUBSTRACT1	(1&lt;&lt;25)</span>
<span class="cp">#define NV_RX2_ERROR1		(1&lt;&lt;18)</span>
<span class="cp">#define NV_RX2_ERROR2		(1&lt;&lt;19)</span>
<span class="cp">#define NV_RX2_ERROR3		(1&lt;&lt;20)</span>
<span class="cp">#define NV_RX2_ERROR4		(1&lt;&lt;21)</span>
<span class="cp">#define NV_RX2_CRCERR		(1&lt;&lt;22)</span>
<span class="cp">#define NV_RX2_OVERFLOW		(1&lt;&lt;23)</span>
<span class="cp">#define NV_RX2_FRAMINGERR	(1&lt;&lt;24)</span>
<span class="cm">/* error and avail are the same for both */</span>
<span class="cp">#define NV_RX2_ERROR		(1&lt;&lt;30)</span>
<span class="cp">#define NV_RX2_AVAIL		(1&lt;&lt;31)</span>
<span class="cp">#define NV_RX2_ERROR_MASK	(NV_RX2_ERROR1|NV_RX2_ERROR2|NV_RX2_ERROR3|NV_RX2_ERROR4|NV_RX2_CRCERR|NV_RX2_OVERFLOW|NV_RX2_FRAMINGERR)</span>

<span class="cp">#define NV_RX3_VLAN_TAG_PRESENT (1&lt;&lt;16)</span>
<span class="cp">#define NV_RX3_VLAN_TAG_MASK	(0x0000FFFF)</span>

<span class="cm">/* Miscellaneous hardware related defines: */</span>
<span class="cp">#define NV_PCI_REGSZ_VER1	0x270</span>
<span class="cp">#define NV_PCI_REGSZ_VER2	0x2d4</span>
<span class="cp">#define NV_PCI_REGSZ_VER3	0x604</span>
<span class="cp">#define NV_PCI_REGSZ_MAX	0x604</span>

<span class="cm">/* various timeout delays: all in usec */</span>
<span class="cp">#define NV_TXRX_RESET_DELAY	4</span>
<span class="cp">#define NV_TXSTOP_DELAY1	10</span>
<span class="cp">#define NV_TXSTOP_DELAY1MAX	500000</span>
<span class="cp">#define NV_TXSTOP_DELAY2	100</span>
<span class="cp">#define NV_RXSTOP_DELAY1	10</span>
<span class="cp">#define NV_RXSTOP_DELAY1MAX	500000</span>
<span class="cp">#define NV_RXSTOP_DELAY2	100</span>
<span class="cp">#define NV_SETUP5_DELAY		5</span>
<span class="cp">#define NV_SETUP5_DELAYMAX	50000</span>
<span class="cp">#define NV_POWERUP_DELAY	5</span>
<span class="cp">#define NV_POWERUP_DELAYMAX	5000</span>
<span class="cp">#define NV_MIIBUSY_DELAY	50</span>
<span class="cp">#define NV_MIIPHY_DELAY	10</span>
<span class="cp">#define NV_MIIPHY_DELAYMAX	10000</span>
<span class="cp">#define NV_MAC_RESET_DELAY	64</span>

<span class="cp">#define NV_WAKEUPPATTERNS	5</span>
<span class="cp">#define NV_WAKEUPMASKENTRIES	4</span>

<span class="cm">/* General driver defaults */</span>
<span class="cp">#define NV_WATCHDOG_TIMEO	(5*HZ)</span>

<span class="cp">#define RX_RING_DEFAULT		512</span>
<span class="cp">#define TX_RING_DEFAULT		256</span>
<span class="cp">#define RX_RING_MIN		128</span>
<span class="cp">#define TX_RING_MIN		64</span>
<span class="cp">#define RING_MAX_DESC_VER_1	1024</span>
<span class="cp">#define RING_MAX_DESC_VER_2_3	16384</span>

<span class="cm">/* rx/tx mac addr + type + vlan + align + slack*/</span>
<span class="cp">#define NV_RX_HEADERS		(64)</span>
<span class="cm">/* even more slack. */</span>
<span class="cp">#define NV_RX_ALLOC_PAD		(64)</span>

<span class="cm">/* maximum mtu size */</span>
<span class="cp">#define NV_PKTLIMIT_1	ETH_DATA_LEN	</span><span class="cm">/* hard limit not known */</span><span class="cp"></span>
<span class="cp">#define NV_PKTLIMIT_2	9100	</span><span class="cm">/* Actual limit according to NVidia: 9202 */</span><span class="cp"></span>

<span class="cp">#define OOM_REFILL	(1+HZ/20)</span>
<span class="cp">#define POLL_WAIT	(1+HZ/100)</span>
<span class="cp">#define LINK_TIMEOUT	(3*HZ)</span>
<span class="cp">#define STATS_INTERVAL	(10*HZ)</span>

<span class="cm">/*</span>
<span class="cm"> * desc_ver values:</span>
<span class="cm"> * The nic supports three different descriptor types:</span>
<span class="cm"> * - DESC_VER_1: Original</span>
<span class="cm"> * - DESC_VER_2: support for jumbo frames.</span>
<span class="cm"> * - DESC_VER_3: 64-bit format.</span>
<span class="cm"> */</span>
<span class="cp">#define DESC_VER_1	1</span>
<span class="cp">#define DESC_VER_2	2</span>
<span class="cp">#define DESC_VER_3	3</span>

<span class="cm">/* PHY defines */</span>
<span class="cp">#define PHY_OUI_MARVELL		0x5043</span>
<span class="cp">#define PHY_OUI_CICADA		0x03f1</span>
<span class="cp">#define PHY_OUI_VITESSE		0x01c1</span>
<span class="cp">#define PHY_OUI_REALTEK		0x0732</span>
<span class="cp">#define PHY_OUI_REALTEK2	0x0020</span>
<span class="cp">#define PHYID1_OUI_MASK	0x03ff</span>
<span class="cp">#define PHYID1_OUI_SHFT	6</span>
<span class="cp">#define PHYID2_OUI_MASK	0xfc00</span>
<span class="cp">#define PHYID2_OUI_SHFT	10</span>
<span class="cp">#define PHYID2_MODEL_MASK		0x03f0</span>
<span class="cp">#define PHY_MODEL_REALTEK_8211		0x0110</span>
<span class="cp">#define PHY_REV_MASK			0x0001</span>
<span class="cp">#define PHY_REV_REALTEK_8211B		0x0000</span>
<span class="cp">#define PHY_REV_REALTEK_8211C		0x0001</span>
<span class="cp">#define PHY_MODEL_REALTEK_8201		0x0200</span>
<span class="cp">#define PHY_MODEL_MARVELL_E3016		0x0220</span>
<span class="cp">#define PHY_MARVELL_E3016_INITMASK	0x0300</span>
<span class="cp">#define PHY_CICADA_INIT1	0x0f000</span>
<span class="cp">#define PHY_CICADA_INIT2	0x0e00</span>
<span class="cp">#define PHY_CICADA_INIT3	0x01000</span>
<span class="cp">#define PHY_CICADA_INIT4	0x0200</span>
<span class="cp">#define PHY_CICADA_INIT5	0x0004</span>
<span class="cp">#define PHY_CICADA_INIT6	0x02000</span>
<span class="cp">#define PHY_VITESSE_INIT_REG1	0x1f</span>
<span class="cp">#define PHY_VITESSE_INIT_REG2	0x10</span>
<span class="cp">#define PHY_VITESSE_INIT_REG3	0x11</span>
<span class="cp">#define PHY_VITESSE_INIT_REG4	0x12</span>
<span class="cp">#define PHY_VITESSE_INIT_MSK1	0xc</span>
<span class="cp">#define PHY_VITESSE_INIT_MSK2	0x0180</span>
<span class="cp">#define PHY_VITESSE_INIT1	0x52b5</span>
<span class="cp">#define PHY_VITESSE_INIT2	0xaf8a</span>
<span class="cp">#define PHY_VITESSE_INIT3	0x8</span>
<span class="cp">#define PHY_VITESSE_INIT4	0x8f8a</span>
<span class="cp">#define PHY_VITESSE_INIT5	0xaf86</span>
<span class="cp">#define PHY_VITESSE_INIT6	0x8f86</span>
<span class="cp">#define PHY_VITESSE_INIT7	0xaf82</span>
<span class="cp">#define PHY_VITESSE_INIT8	0x0100</span>
<span class="cp">#define PHY_VITESSE_INIT9	0x8f82</span>
<span class="cp">#define PHY_VITESSE_INIT10	0x0</span>
<span class="cp">#define PHY_REALTEK_INIT_REG1	0x1f</span>
<span class="cp">#define PHY_REALTEK_INIT_REG2	0x19</span>
<span class="cp">#define PHY_REALTEK_INIT_REG3	0x13</span>
<span class="cp">#define PHY_REALTEK_INIT_REG4	0x14</span>
<span class="cp">#define PHY_REALTEK_INIT_REG5	0x18</span>
<span class="cp">#define PHY_REALTEK_INIT_REG6	0x11</span>
<span class="cp">#define PHY_REALTEK_INIT_REG7	0x01</span>
<span class="cp">#define PHY_REALTEK_INIT1	0x0000</span>
<span class="cp">#define PHY_REALTEK_INIT2	0x8e00</span>
<span class="cp">#define PHY_REALTEK_INIT3	0x0001</span>
<span class="cp">#define PHY_REALTEK_INIT4	0xad17</span>
<span class="cp">#define PHY_REALTEK_INIT5	0xfb54</span>
<span class="cp">#define PHY_REALTEK_INIT6	0xf5c7</span>
<span class="cp">#define PHY_REALTEK_INIT7	0x1000</span>
<span class="cp">#define PHY_REALTEK_INIT8	0x0003</span>
<span class="cp">#define PHY_REALTEK_INIT9	0x0008</span>
<span class="cp">#define PHY_REALTEK_INIT10	0x0005</span>
<span class="cp">#define PHY_REALTEK_INIT11	0x0200</span>
<span class="cp">#define PHY_REALTEK_INIT_MSK1	0x0003</span>

<span class="cp">#define PHY_GIGABIT	0x0100</span>

<span class="cp">#define PHY_TIMEOUT	0x1</span>
<span class="cp">#define PHY_ERROR	0x2</span>

<span class="cp">#define PHY_100	0x1</span>
<span class="cp">#define PHY_1000	0x2</span>
<span class="cp">#define PHY_HALF	0x100</span>

<span class="cp">#define NV_PAUSEFRAME_RX_CAPABLE 0x0001</span>
<span class="cp">#define NV_PAUSEFRAME_TX_CAPABLE 0x0002</span>
<span class="cp">#define NV_PAUSEFRAME_RX_ENABLE  0x0004</span>
<span class="cp">#define NV_PAUSEFRAME_TX_ENABLE  0x0008</span>
<span class="cp">#define NV_PAUSEFRAME_RX_REQ     0x0010</span>
<span class="cp">#define NV_PAUSEFRAME_TX_REQ     0x0020</span>
<span class="cp">#define NV_PAUSEFRAME_AUTONEG    0x0040</span>

<span class="cm">/* MSI/MSI-X defines */</span>
<span class="cp">#define NV_MSI_X_MAX_VECTORS  8</span>
<span class="cp">#define NV_MSI_X_VECTORS_MASK 0x000f</span>
<span class="cp">#define NV_MSI_CAPABLE        0x0010</span>
<span class="cp">#define NV_MSI_X_CAPABLE      0x0020</span>
<span class="cp">#define NV_MSI_ENABLED        0x0040</span>
<span class="cp">#define NV_MSI_X_ENABLED      0x0080</span>

<span class="cp">#define NV_MSI_X_VECTOR_ALL   0x0</span>
<span class="cp">#define NV_MSI_X_VECTOR_RX    0x0</span>
<span class="cp">#define NV_MSI_X_VECTOR_TX    0x1</span>
<span class="cp">#define NV_MSI_X_VECTOR_OTHER 0x2</span>

<span class="cp">#define NV_MSI_PRIV_OFFSET 0x68</span>
<span class="cp">#define NV_MSI_PRIV_VALUE  0xffffffff</span>

<span class="cp">#define NV_RESTART_TX         0x1</span>
<span class="cp">#define NV_RESTART_RX         0x2</span>

<span class="cp">#define NV_TX_LIMIT_COUNT     16</span>

<span class="cp">#define NV_DYNAMIC_THRESHOLD        4</span>
<span class="cp">#define NV_DYNAMIC_MAX_QUIET_COUNT  2048</span>

<span class="cm">/* statistics */</span>
<span class="k">struct</span> <span class="n">nv_ethtool_str</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nv_ethtool_str</span> <span class="n">nv_estats_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tx_bytes&quot;</span> <span class="p">},</span> <span class="cm">/* includes Ethernet FCS CRC */</span>
	<span class="p">{</span> <span class="s">&quot;tx_zero_rexmt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_one_rexmt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_many_rexmt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_late_collision&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_fifo_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_carrier_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_excess_deferral&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_retry_error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_frame_error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_extra_byte&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_late_collision&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_runt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_frame_too_long&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_over_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_crc_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_frame_align_error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_length_error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_unicast&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_multicast&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_broadcast&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_errors_total&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_errors_total&quot;</span> <span class="p">},</span>

	<span class="cm">/* version 2 stats */</span>
	<span class="p">{</span> <span class="s">&quot;tx_deferral&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bytes&quot;</span> <span class="p">},</span> <span class="cm">/* includes Ethernet FCS CRC */</span>
	<span class="p">{</span> <span class="s">&quot;tx_pause&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_pause&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_drop_frame&quot;</span> <span class="p">},</span>

	<span class="cm">/* version 3 stats */</span>
	<span class="p">{</span> <span class="s">&quot;tx_unicast&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_multicast&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_broadcast&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nv_ethtool_stats</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">tx_bytes</span><span class="p">;</span> <span class="cm">/* should be ifconfig-&gt;tx_bytes + 4*tx_packets */</span>
	<span class="n">u64</span> <span class="n">tx_zero_rexmt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_one_rexmt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_many_rexmt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_late_collision</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_fifo_errors</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_carrier_errors</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_excess_deferral</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_retry_error</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_frame_error</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_extra_byte</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_late_collision</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_runt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_frame_too_long</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_over_errors</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_frame_align_error</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_length_error</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_unicast</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_multicast</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_broadcast</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_packets</span><span class="p">;</span> <span class="cm">/* should be ifconfig-&gt;rx_packets */</span>
	<span class="n">u64</span> <span class="n">rx_errors_total</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_errors_total</span><span class="p">;</span>

	<span class="cm">/* version 2 stats */</span>
	<span class="n">u64</span> <span class="n">tx_deferral</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_packets</span><span class="p">;</span> <span class="cm">/* should be ifconfig-&gt;tx_packets */</span>
	<span class="n">u64</span> <span class="n">rx_bytes</span><span class="p">;</span>   <span class="cm">/* should be ifconfig-&gt;rx_bytes + 4*rx_packets */</span>
	<span class="n">u64</span> <span class="n">tx_pause</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_pause</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_drop_frame</span><span class="p">;</span>

	<span class="cm">/* version 3 stats */</span>
	<span class="n">u64</span> <span class="n">tx_unicast</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_multicast</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_broadcast</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define NV_DEV_STATISTICS_V3_COUNT (sizeof(struct nv_ethtool_stats)/sizeof(u64))</span>
<span class="cp">#define NV_DEV_STATISTICS_V2_COUNT (NV_DEV_STATISTICS_V3_COUNT - 3)</span>
<span class="cp">#define NV_DEV_STATISTICS_V1_COUNT (NV_DEV_STATISTICS_V2_COUNT - 6)</span>

<span class="cm">/* diagnostics */</span>
<span class="cp">#define NV_TEST_COUNT_BASE 3</span>
<span class="cp">#define NV_TEST_COUNT_EXTENDED 4</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nv_ethtool_str</span> <span class="n">nv_etests_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;link      (online/offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;register  (offline)       &quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;interrupt (offline)       &quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;loopback  (offline)       &quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">register_test</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">register_test</span> <span class="n">nv_registers_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">NvRegUnknownSetupReg6</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">NvRegMisc1</span><span class="p">,</span> <span class="mh">0x03c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">NvRegOffloadConfig</span><span class="p">,</span> <span class="mh">0x03ff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">NvRegMulticastAddrA</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">NvRegTxWatermark</span><span class="p">,</span> <span class="mh">0x0ff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">NvRegWakeUpFlags</span><span class="p">,</span> <span class="mh">0x07777</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_len</span><span class="o">:</span><span class="mi">31</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_single</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">first_tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">next_tx_ctx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SMP locking:</span>
<span class="cm"> * All hardware access under netdev_priv(dev)-&gt;lock, except the performance</span>
<span class="cm"> * critical parts:</span>
<span class="cm"> * - rx is (pseudo-) lockless: it relies on the single-threading provided</span>
<span class="cm"> *	by the arch code for interrupts.</span>
<span class="cm"> * - tx setup is lockless: it relies on netif_tx_lock. Actual submission</span>
<span class="cm"> *	needs netdev_priv(dev)-&gt;lock :-(</span>
<span class="cm"> * - set_multicast_list: preparation lockless, relies on netif_tx_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware stats updates are protected by hwstats_lock:</span>
<span class="cm"> * - updated by nv_do_stats_poll (timer). This is meant to avoid</span>
<span class="cm"> *   integer wraparound in the NIC stats registers, at low frequency</span>
<span class="cm"> *   (0.1 Hz)</span>
<span class="cm"> * - updated by nv_get_ethtool_stats + nv_get_stats64</span>
<span class="cm"> *</span>
<span class="cm"> * Software stats are accessed only through 64b synchronization points</span>
<span class="cm"> * and are not subject to other synchronization techniques (single</span>
<span class="cm"> * update thread on the TX or RX paths).</span>
<span class="cm"> */</span>

<span class="cm">/* in dev: base, irq */</span>
<span class="k">struct</span> <span class="n">fe_priv</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>

	<span class="cm">/* hardware stats are updated in syscall and timer */</span>
	<span class="n">spinlock_t</span> <span class="n">hwstats_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_ethtool_stats</span> <span class="n">estats</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">in_shutdown</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">linkspeed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fixed_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phyaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wolenabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_oui</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_model</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gigabit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_test</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recover_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quiet_count</span><span class="p">;</span>

	<span class="cm">/* General data: RO fields */</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">events</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqmask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txrxctl_bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlanctl_bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">driver_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">register_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_in_use</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mgmt_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mgmt_sema</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* rx specific fields.</span>
<span class="cm">	 * Locking: Within irq hander or disable_irq+spin_lock(&amp;np-&gt;lock);</span>
<span class="cm">	 */</span>
	<span class="k">union</span> <span class="n">ring_type</span> <span class="n">get_rx</span><span class="p">,</span> <span class="n">put_rx</span><span class="p">,</span> <span class="n">first_rx</span><span class="p">,</span> <span class="n">last_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">get_rx_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">put_rx_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">first_rx_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">last_rx_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">ring_type</span> <span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_buf_sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">oom_kick</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">nic_poll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">stats_poll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_poll_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_ring_size</span><span class="p">;</span>

	<span class="cm">/* RX software stats */</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span> <span class="n">swstats_rx_syncp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat_rx_packets</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat_rx_bytes</span><span class="p">;</span> <span class="cm">/* not always available in HW */</span>
	<span class="n">u64</span> <span class="n">stat_rx_missed_errors</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat_rx_dropped</span><span class="p">;</span>

	<span class="cm">/* media detection workaround.</span>
<span class="cm">	 * Locking: Within irq hander or disable_irq+spin_lock(&amp;np-&gt;lock);</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">need_linktimer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">link_timeout</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * tx specific fields.</span>
<span class="cm">	 */</span>
	<span class="k">union</span> <span class="n">ring_type</span> <span class="n">get_tx</span><span class="p">,</span> <span class="n">put_tx</span><span class="p">,</span> <span class="n">first_tx</span><span class="p">,</span> <span class="n">last_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">get_tx_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">put_tx_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">first_tx_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">last_tx_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">ring_type</span> <span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_pkts_in_progress</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">tx_change_owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">tx_end_flip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_stop</span><span class="p">;</span>

	<span class="cm">/* TX software stats */</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span> <span class="n">swstats_tx_syncp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat_tx_packets</span><span class="p">;</span> <span class="cm">/* not always available in HW */</span>
	<span class="n">u64</span> <span class="n">stat_tx_bytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat_tx_dropped</span><span class="p">;</span>

	<span class="cm">/* msi/msi-x fields */</span>
	<span class="n">u32</span> <span class="n">msi_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_MAX_VECTORS</span><span class="p">];</span>

	<span class="cm">/* flow control */</span>
	<span class="n">u32</span> <span class="n">pause_flags</span><span class="p">;</span>

	<span class="cm">/* power saved state */</span>
	<span class="n">u32</span> <span class="n">saved_config_space</span><span class="p">[</span><span class="n">NV_PCI_REGSZ_MAX</span><span class="o">/</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* for different msi-x irq type */</span>
	<span class="kt">char</span> <span class="n">name_rx</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>       <span class="cm">/* -rx    */</span>
	<span class="kt">char</span> <span class="n">name_tx</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>       <span class="cm">/* -tx    */</span>
	<span class="kt">char</span> <span class="n">name_other</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">+</span> <span class="mi">6</span><span class="p">];</span>    <span class="cm">/* -other */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum number of loops until we assume that a bit in the irq mask</span>
<span class="cm"> * is stuck. Overridable with module param.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Optimization can be either throuput mode or cpu mode</span>
<span class="cm"> *</span>
<span class="cm"> * Throughput Mode: Every tx and rx packet will generate an interrupt.</span>
<span class="cm"> * CPU Mode: Interrupts are controlled by a timer.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NV_OPTIMIZATION_MODE_THROUGHPUT</span><span class="p">,</span>
	<span class="n">NV_OPTIMIZATION_MODE_CPU</span><span class="p">,</span>
	<span class="n">NV_OPTIMIZATION_MODE_DYNAMIC</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">optimization_mode</span> <span class="o">=</span> <span class="n">NV_OPTIMIZATION_MODE_DYNAMIC</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Poll interval for timer irq</span>
<span class="cm"> *</span>
<span class="cm"> * This interval determines how frequent an interrupt is generated.</span>
<span class="cm"> * The is value is determined by [(time_in_micro_secs * 100) / (2^10)]</span>
<span class="cm"> * Min = 0, and Max = 65535</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll_interval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * MSI interrupts</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NV_MSI_INT_DISABLED</span><span class="p">,</span>
	<span class="n">NV_MSI_INT_ENABLED</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msi</span> <span class="o">=</span> <span class="n">NV_MSI_INT_ENABLED</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * MSIX interrupts</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NV_MSIX_INT_DISABLED</span><span class="p">,</span>
	<span class="n">NV_MSIX_INT_ENABLED</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msix</span> <span class="o">=</span> <span class="n">NV_MSIX_INT_ENABLED</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * DMA 64bit</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NV_DMA_64BIT_DISABLED</span><span class="p">,</span>
	<span class="n">NV_DMA_64BIT_ENABLED</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_64bit</span> <span class="o">=</span> <span class="n">NV_DMA_64BIT_ENABLED</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Debug output control for tx_timeout</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug_tx_timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Crossover Detection</span>
<span class="cm"> * Realtek 8201 phy + some OEM boards do not work properly.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NV_CROSSOVER_DETECTION_DISABLED</span><span class="p">,</span>
	<span class="n">NV_CROSSOVER_DETECTION_ENABLED</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">phy_cross</span> <span class="o">=</span> <span class="n">NV_CROSSOVER_DETECTION_DISABLED</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Power down phy when interface is down (persists through reboot;</span>
<span class="cm"> * older Linux and other OSes may not power it up again)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">phy_power_down</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="nf">get_nvpriv</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">get_hwbase</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pci_push</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* force out pending posted writes */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nv_descr_getlength</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">prd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prd</span><span class="o">-&gt;</span><span class="n">flaglen</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="p">((</span><span class="n">v</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="o">?</span> <span class="n">LEN_MASK_V1</span> <span class="o">:</span> <span class="n">LEN_MASK_V2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nv_descr_getlength_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">prd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prd</span><span class="o">-&gt;</span><span class="n">flaglen</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LEN_MASK_V2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nv_optimized</span><span class="p">(</span><span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span> <span class="o">||</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">target</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">delay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delaymax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="n">delaymax</span> <span class="o">-=</span> <span class="n">delay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delaymax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NV_SETUP_RX_RING 0x01</span>
<span class="cp">#define NV_SETUP_TX_RING 0x02</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dma_low</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dma_high</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">31</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 0 if 32bit, shift down by 32 if 64bit */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_hw_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxtx_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxtx_flags</span> <span class="o">&amp;</span> <span class="n">NV_SETUP_RX_RING</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxRingPhysAddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxtx_flags</span> <span class="o">&amp;</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span><span class="p">)),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRingPhysAddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxtx_flags</span> <span class="o">&amp;</span> <span class="n">NV_SETUP_RX_RING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxRingPhysAddr</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dma_high</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxRingPhysAddrHigh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxtx_flags</span> <span class="o">&amp;</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span><span class="p">)),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRingPhysAddr</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dma_high</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span><span class="p">)),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRingPhysAddrHigh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
					    <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">)</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
					    <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">using_multi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_VECTORS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_txrx_gate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">powerstate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_POWER_CNTRL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">powerstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gate</span><span class="p">)</span>
			<span class="n">powerstate</span> <span class="o">|=</span> <span class="n">NVREG_POWERSTATE2_GATE_CLOCKS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">powerstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_POWERSTATE2_GATE_CLOCKS</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">powerstate</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_multi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_ALL</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_OTHER</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_multi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_ALL</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_OTHER</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* In MSIX mode, a write to irqmask behaves as XOR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_enable_hw_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_disable_hw_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_ENABLED</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIIrqMask</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_napi_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_napi_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MII_READ	(-1)</span>
<span class="cm">/* mii_rw: read/write a register on the PHY.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must guarantee serialization</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">miireg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISTAT_MASK_RW</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">NVREG_MIICTL_INUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIICTL_INUSE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIControl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">NV_MIIBUSY_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_MIICTL_ADDRSHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">miireg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">MII_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIData</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">NVREG_MIICTL_WRITE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIControl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NvRegMIIControl</span><span class="p">,</span> <span class="n">NVREG_MIICTL_INUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">NV_MIIPHY_DELAY</span><span class="p">,</span> <span class="n">NV_MIIPHY_DELAYMAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">MII_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* it was a write operation - fewer failures are detectable */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_MIISTAT_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIData</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bmcr_setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">miicontrol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">miicontrol</span> <span class="o">=</span> <span class="n">BMCR_RESET</span> <span class="o">|</span> <span class="n">bmcr_setup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">miicontrol</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* wait for 500ms */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="cm">/* must wait till reset is deasserted */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">miicontrol</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
		<span class="n">miicontrol</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="cm">/* FIXME: 100 tries seem excessive */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_realtek_8211b</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">init</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ri</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT3</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG3</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG4</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT5</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG5</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT6</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT1</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_realtek_8211c</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">powerstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>

	<span class="cm">/* need to perform hw phy reset */</span>
	<span class="n">powerstate</span> <span class="o">|=</span> <span class="n">NVREG_POWERSTATE2_PHY_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">powerstate</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>

	<span class="n">powerstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_POWERSTATE2_PHY_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">powerstate</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG6</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_REALTEK_INIT9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG6</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT10</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG7</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PHY_REALTEK_INIT11</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_REALTEK_INIT11</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG7</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_realtek_8201</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_reserved</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
				      <span class="n">PHY_REALTEK_INIT_REG6</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_REALTEK_INIT7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			   <span class="n">PHY_REALTEK_INIT_REG6</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_realtek_8201_cross</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_reserved</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_cross</span> <span class="o">==</span> <span class="n">NV_CROSSOVER_DETECTION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			   <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT3</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
				      <span class="n">PHY_REALTEK_INIT_REG2</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_REALTEK_INIT_MSK1</span><span class="p">;</span>
		<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_REALTEK_INIT3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			   <span class="n">PHY_REALTEK_INIT_REG2</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			   <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT1</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_cicada</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">phyinterface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_reserved</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phyinterface</span> <span class="o">&amp;</span> <span class="n">PHY_RGMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_RESV1</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHY_CICADA_INIT1</span> <span class="o">|</span> <span class="n">PHY_CICADA_INIT2</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PHY_CICADA_INIT3</span> <span class="o">|</span> <span class="n">PHY_CICADA_INIT4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_RESV1</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_NCONFIG</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_CICADA_INIT5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_NCONFIG</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_SREVISION</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_CICADA_INIT6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_SREVISION</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_vitesse</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_reserved</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			      <span class="n">PHY_VITESSE_INIT_REG4</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT_REG4</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			      <span class="n">PHY_VITESSE_INIT_REG3</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">phy_reserved</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_VITESSE_INIT_MSK1</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_VITESSE_INIT3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT_REG3</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT5</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			      <span class="n">PHY_VITESSE_INIT_REG4</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">phy_reserved</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_VITESSE_INIT_MSK1</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_VITESSE_INIT3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT_REG4</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			      <span class="n">PHY_VITESSE_INIT_REG3</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT_REG3</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT6</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT7</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			      <span class="n">PHY_VITESSE_INIT_REG4</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT_REG4</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
			      <span class="n">PHY_VITESSE_INIT_REG3</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">phy_reserved</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_VITESSE_INIT_MSK2</span><span class="p">;</span>
	<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_VITESSE_INIT8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT_REG3</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG2</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT9</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
		   <span class="n">PHY_VITESSE_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_VITESSE_INIT10</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phyinterface</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mii_status</span><span class="p">,</span> <span class="n">mii_control</span><span class="p">,</span> <span class="n">mii_control_1000</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* phy errata for E3016 phy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_MARVELL_E3016</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_NCONFIG</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_MARVELL_E3016_INITMASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_NCONFIG</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy write to errata reg failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_REALTEK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8211</span> <span class="o">&amp;&amp;</span>
		    <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_rev</span> <span class="o">==</span> <span class="n">PHY_REV_REALTEK_8211B</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init_realtek_8211b</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8211</span> <span class="o">&amp;&amp;</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_rev</span> <span class="o">==</span> <span class="n">PHY_REV_REALTEK_8211C</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init_realtek_8211c</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8201</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init_realtek_8201</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set advertise register */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_10HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">|</span>
		<span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_100FULL</span> <span class="o">|</span>
		<span class="n">ADVERTISE_PAUSE_ASYM</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy write to advertise failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get phy interface type */</span>
	<span class="n">phyinterface</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPhyInterface</span><span class="p">);</span>

	<span class="cm">/* see if gigabit phy */</span>
	<span class="n">mii_status</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">=</span> <span class="n">PHY_GIGABIT</span><span class="p">;</span>
		<span class="n">mii_control_1000</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span>
					  <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">mii_control_1000</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADVERTISE_1000HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phyinterface</span> <span class="o">&amp;</span> <span class="n">PHY_RGMII</span><span class="p">)</span>
			<span class="n">mii_control_1000</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mii_control_1000</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">mii_control_1000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mii_control</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">mii_control</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_REALTEK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8211</span> <span class="o">&amp;&amp;</span>
	    <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_rev</span> <span class="o">==</span> <span class="n">PHY_REV_REALTEK_8211C</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start autoneg since we already performed hw reset above */</span>
		<span class="n">mii_control</span> <span class="o">|=</span> <span class="n">BMCR_ANRESTART</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">mii_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* reset the phy</span>
<span class="cm">		 * (certain phys need bmcr to be setup with reset)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mii_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* phy vendor specific configuration */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_CICADA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_cicada</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">phyinterface</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_VITESSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_vitesse</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_REALTEK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8211</span> <span class="o">&amp;&amp;</span>
		    <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_rev</span> <span class="o">==</span> <span class="n">PHY_REV_REALTEK_8211B</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset could have cleared these out, set them back */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init_realtek_8211b</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8201</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init_realtek_8201</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">init_realtek_8201_cross</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* some phys clear out pause advertisement on reset, set it back */</span>
	<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* restart auto negotiation, power down phy */</span>
	<span class="n">mii_control</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">mii_control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANRESTART</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_power_down</span><span class="p">)</span>
		<span class="n">mii_control</span> <span class="o">|=</span> <span class="n">BMCR_PDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">mii_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_start_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">);</span>

	<span class="cm">/* Already running? Stop it. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_RCVCTL_START</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_RCVCTL_START</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">);</span>
		<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegLinkSpeed</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">NVREG_RCVCTL_START</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span>
		<span class="n">rx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_RCVCTL_RX_PATH_EN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span>
		<span class="n">rx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_RCVCTL_START</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">NVREG_RCVCTL_RX_PATH_EN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NvRegReceiverStatus</span><span class="p">,</span> <span class="n">NVREG_RCVSTAT_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">NV_RXSTOP_DELAY1</span><span class="p">,</span> <span class="n">NV_RXSTOP_DELAY1MAX</span><span class="p">))</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ReceiverStatus remained busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">NV_RXSTOP_DELAY2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegLinkSpeed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>

	<span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">NVREG_XMITCTL_START</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span>
		<span class="n">tx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_XMITCTL_TX_PATH_EN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span>
		<span class="n">tx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_XMITCTL_START</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">NVREG_XMITCTL_TX_PATH_EN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NvRegTransmitterStatus</span><span class="p">,</span> <span class="n">NVREG_XMITSTAT_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">NV_TXSTOP_DELAY1</span><span class="p">,</span> <span class="n">NV_TXSTOP_DELAY1MAX</span><span class="p">))</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: TransmitterStatus remained busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">NV_TXSTOP_DELAY2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_TRANSMITPOLL_MAC_ADDR_REV</span><span class="p">,</span>
		       <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_start_rxtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_stop_rxtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nv_stop_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_stop_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_txrx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_BIT2</span> <span class="o">|</span> <span class="n">NVREG_TXRXCTL_RESET</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">NV_TXRX_RESET_DELAY</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_BIT2</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_mac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">temp3</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_BIT2</span> <span class="o">|</span> <span class="n">NVREG_TXRXCTL_RESET</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/* save registers since they will be cleared on reset */</span>
	<span class="n">temp1</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrA</span><span class="p">);</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrB</span><span class="p">);</span>
	<span class="n">temp3</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MAC_RESET_ASSERT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacReset</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">NV_MAC_RESET_DELAY</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacReset</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">NV_MAC_RESET_DELAY</span><span class="p">);</span>

	<span class="cm">/* restore saved registers */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">temp2</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">temp3</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_BIT2</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Caller must appropriately lock netdev_priv(dev)-&gt;hwstats_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If it happens that this is run in top-half context, then</span>
<span class="cm">	 * replace the spin_lock of hwstats_lock with</span>
<span class="cm">	 * spin_lock_irqsave() in calling functions. */</span>
	<span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">in_irq</span><span class="p">(),</span> <span class="s">&quot;forcedeth: estats spin_lock(_bh) from top-half&quot;</span><span class="p">);</span>
	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>

	<span class="cm">/* query hardware */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxCnt</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_zero_rexmt</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxZeroReXmt</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_one_rexmt</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxOneReXmt</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_many_rexmt</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxManyReXmt</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_late_collision</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxLateCol</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_fifo_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxUnderflow</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxLossCarrier</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_excess_deferral</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxExcessDef</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_retry_error</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRetryErr</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_error</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxFrameErr</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_extra_byte</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxExtraByte</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_late_collision</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxLateCol</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_runt</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxRunt</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_too_long</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxFrameTooLong</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxOverflow</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxFCSErr</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_align_error</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxFrameAlignErr</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_length_error</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxLenErr</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_unicast</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxUnicast</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_multicast</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxMulticast</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_broadcast</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxBroadcast</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_unicast</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_multicast</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_broadcast</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_errors_total</span> <span class="o">=</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_error</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_align_error</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_extra_byte</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_late_collision</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_runt</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_too_long</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_errors_total</span> <span class="o">=</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_late_collision</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_fifo_errors</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_excess_deferral</span> <span class="o">+</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_retry_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_deferral</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxDef</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxFrame</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxCnt</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_pause</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxPause</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_pause</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxPause</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_drop_frame</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxDropFrame</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_errors_total</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_drop_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_unicast</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxUnicast</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_multicast</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxMulticast</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_broadcast</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxBroadcast</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_get_stats64: dev-&gt;ndo_get_stats64 function</span>
<span class="cm"> * Get latest stats value from the nic.</span>
<span class="cm"> * Called with read_lock(&amp;dev_base_lock) held for read -</span>
<span class="cm"> * only synchronized against unregister_netdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span><span class="o">*</span>
<span class="nf">nv_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">storage</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">syncp_start</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: because HW stats are not always available and for</span>
<span class="cm">	 * consistency reasons, the following ifconfig stats are</span>
<span class="cm">	 * managed by software: rx_bytes, tx_bytes, rx_packets and</span>
<span class="cm">	 * tx_packets. The related hardware stats reported by ethtool</span>
<span class="cm">	 * should be equivalent to these ifconfig stats, with 4</span>
<span class="cm">	 * additional bytes per packet (Ethernet FCS CRC), except for</span>
<span class="cm">	 * tx_packets when TSO kicks in.</span>
<span class="cm">	 */</span>

	<span class="cm">/* software stats */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">syncp_start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_packets</span>       <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_packets</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_bytes</span>         <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_bytes</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_dropped</span>       <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_dropped</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_missed_errors</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">,</span> <span class="n">syncp_start</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">syncp_start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_packets</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">tx_bytes</span>   <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_bytes</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_dropped</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">,</span> <span class="n">syncp_start</span><span class="p">));</span>

	<span class="cm">/* If the nic supports hw counters then retrieve latest values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V123</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>

		<span class="n">nv_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* generic stats */</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_errors_total</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_errors_total</span><span class="p">;</span>

		<span class="cm">/* meaningful only when NIC supports stats v3 */</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_multicast</span><span class="p">;</span>

		<span class="cm">/* detailed rx_errors */</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_length_error</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span>   <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span>    <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span>  <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_frame_align_error</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span>   <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_drop_frame</span><span class="p">;</span>

		<span class="cm">/* detailed tx_errors */</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="p">;</span>
		<span class="n">storage</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span>    <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="p">;</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">storage</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_alloc_rx: fill rx ring entries.</span>
<span class="cm"> * Return 1 if the allocations for the skbs failed and the</span>
<span class="cm"> * rx engine is without Available descriptors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_alloc_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">less_rx</span><span class="p">;</span>

	<span class="n">less_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">less_rx</span><span class="o">--</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span>
		<span class="n">less_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">orig</span> <span class="o">!=</span> <span class="n">less_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="n">NV_RX_ALLOC_PAD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							     <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
							     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">|</span> <span class="n">NV_RX_AVAIL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">orig</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx_ctx</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx_ctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_alloc_rx_optimized</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">less_rx</span><span class="p">;</span>

	<span class="n">less_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">less_rx</span><span class="o">--</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">)</span>
		<span class="n">less_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span> <span class="o">!=</span> <span class="n">less_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="n">NV_RX_ALLOC_PAD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							     <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
							     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_high</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">buflow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">|</span> <span class="n">NV_RX2_AVAIL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx_ctx</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx_ctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If rx bufs are exhausted called after 50ms to attempt to refresh */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_do_rx_refill</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Just reschedule NAPI rx processing */</span>
	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_init_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txvlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_init_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">netdev_reset_queue</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_end_flip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txvlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_single</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first_tx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_tx_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">nv_init_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_init_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nv_alloc_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">nv_alloc_rx_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_unmap_txskb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma_single</span><span class="p">)</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					 <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">,</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				       <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">,</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_release_txskb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nv_unmap_txskb</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_drain_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txvlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_release_txskb</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_single</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first_tx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_tx_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_end_flip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_drain_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txvlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span>
					  <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_drain_rxtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nv_drain_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_drain_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nv_get_empty_tx_slots</span><span class="p">(</span><span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="p">))</span> <span class="o">%</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_legacybackoff_reseed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NVREG_SLOTTIME_MASK</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">low</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">low</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">low</span> <span class="o">&amp;</span> <span class="n">NVREG_SLOTTIME_MASK</span><span class="p">;</span>

	<span class="cm">/* Need to stop tx before change takes effect.</span>
<span class="cm">	 * Caller has already gained np-&gt;lock.</span>
<span class="cm">	 */</span>
	<span class="n">tx_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_START</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="p">)</span>
		<span class="n">nv_stop_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_stop_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="p">)</span>
		<span class="n">nv_start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Gear Backoff Seeds */</span>
<span class="cp">#define BACKOFF_SEEDSET_ROWS	8</span>
<span class="cp">#define BACKOFF_SEEDSET_LFSRS	15</span>

<span class="cm">/* Known Good seed sets */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">main_seedset</span><span class="p">[</span><span class="n">BACKOFF_SEEDSET_ROWS</span><span class="p">][</span><span class="n">BACKOFF_SEEDSET_LFSRS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">145</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">275</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">660</span><span class="p">,</span> <span class="mi">690</span><span class="p">,</span> <span class="mi">874</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">245</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">575</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">298</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">345</span><span class="p">,</span> <span class="mi">355</span><span class="p">,</span> <span class="mi">366</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">761</span><span class="p">,</span> <span class="mi">790</span><span class="p">,</span> <span class="mi">974</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">145</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">275</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">660</span><span class="p">,</span> <span class="mi">690</span><span class="p">,</span> <span class="mi">874</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">245</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">575</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">298</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">345</span><span class="p">,</span> <span class="mi">355</span><span class="p">,</span> <span class="mi">366</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">386</span><span class="p">,</span> <span class="mi">761</span><span class="p">,</span> <span class="mi">790</span><span class="p">,</span> <span class="mi">974</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">266</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">276</span><span class="p">,</span> <span class="mi">585</span><span class="p">,</span> <span class="mi">397</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">345</span><span class="p">,</span> <span class="mi">355</span><span class="p">,</span> <span class="mi">365</span><span class="p">,</span> <span class="mi">376</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">396</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">984</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">266</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">276</span><span class="p">,</span> <span class="mi">586</span><span class="p">,</span> <span class="mi">397</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">346</span><span class="p">,</span> <span class="mi">355</span><span class="p">,</span> <span class="mi">365</span><span class="p">,</span> <span class="mi">376</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">396</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">984</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">366</span><span class="p">,</span> <span class="mi">365</span><span class="p">,</span> <span class="mi">376</span><span class="p">,</span> <span class="mi">686</span><span class="p">,</span> <span class="mi">497</span><span class="p">,</span> <span class="mi">308</span><span class="p">,</span> <span class="mi">447</span><span class="p">,</span> <span class="mi">455</span><span class="p">,</span> <span class="mi">466</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">485</span><span class="p">,</span> <span class="mi">496</span><span class="p">,</span> <span class="mi">871</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span>  <span class="mi">84</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">466</span><span class="p">,</span> <span class="mi">465</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">786</span><span class="p">,</span> <span class="mi">597</span><span class="p">,</span> <span class="mi">408</span><span class="p">,</span> <span class="mi">547</span><span class="p">,</span> <span class="mi">555</span><span class="p">,</span> <span class="mi">566</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">585</span><span class="p">,</span> <span class="mi">597</span><span class="p">,</span> <span class="mi">971</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">184</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">gear_seedset</span><span class="p">[</span><span class="n">BACKOFF_SEEDSET_ROWS</span><span class="p">][</span><span class="n">BACKOFF_SEEDSET_LFSRS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">251</span><span class="p">,</span> <span class="mi">262</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">319</span><span class="p">,</span> <span class="mi">508</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">364</span><span class="p">,</span> <span class="mi">341</span><span class="p">,</span> <span class="mi">371</span><span class="p">,</span> <span class="mi">398</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span> <span class="mi">295</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">351</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span> <span class="mi">469</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">639</span><span class="p">,</span> <span class="mi">477</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">441</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">293</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">395</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">351</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span> <span class="mi">469</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">639</span><span class="p">,</span> <span class="mi">477</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">441</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">293</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">397</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">251</span><span class="p">,</span> <span class="mi">262</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">319</span><span class="p">,</span> <span class="mi">508</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">364</span><span class="p">,</span> <span class="mi">341</span><span class="p">,</span> <span class="mi">371</span><span class="p">,</span> <span class="mi">398</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span> <span class="mi">295</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">251</span><span class="p">,</span> <span class="mi">262</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">319</span><span class="p">,</span> <span class="mi">508</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">364</span><span class="p">,</span> <span class="mi">341</span><span class="p">,</span> <span class="mi">371</span><span class="p">,</span> <span class="mi">398</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span> <span class="mi">295</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">351</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span> <span class="mi">469</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">639</span><span class="p">,</span> <span class="mi">477</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">441</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">293</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">395</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">351</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span> <span class="mi">469</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">639</span><span class="p">,</span> <span class="mi">477</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">441</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">293</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">395</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">351</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span> <span class="mi">469</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">639</span><span class="p">,</span> <span class="mi">477</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">441</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">293</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">395</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_gear_backoff_reseed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">miniseed1</span><span class="p">,</span> <span class="n">miniseed2</span><span class="p">,</span> <span class="n">miniseed2_reversed</span><span class="p">,</span> <span class="n">miniseed3</span><span class="p">,</span> <span class="n">miniseed3_reversed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">seedset</span><span class="p">,</span> <span class="n">combinedSeed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Setup seed for free running LFSR */</span>
	<span class="cm">/* We are going to read the time stamp counter 3 times</span>
<span class="cm">	   and swizzle bits around to increase randomness */</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">miniseed1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">miniseed1</span><span class="p">));</span>
	<span class="n">miniseed1</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">miniseed1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">miniseed1</span> <span class="o">=</span> <span class="mh">0xabc</span><span class="p">;</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">miniseed2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">miniseed2</span><span class="p">));</span>
	<span class="n">miniseed2</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">miniseed2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">miniseed2</span> <span class="o">=</span> <span class="mh">0xabc</span><span class="p">;</span>
	<span class="n">miniseed2_reversed</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">miniseed2</span> <span class="o">&amp;</span> <span class="mh">0xF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">miniseed2</span> <span class="o">&amp;</span> <span class="mh">0x0F0</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">((</span><span class="n">miniseed2</span> <span class="o">&amp;</span> <span class="mh">0x00F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">miniseed3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">miniseed3</span><span class="p">));</span>
	<span class="n">miniseed3</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">miniseed3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">miniseed3</span> <span class="o">=</span> <span class="mh">0xabc</span><span class="p">;</span>
	<span class="n">miniseed3_reversed</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">miniseed3</span> <span class="o">&amp;</span> <span class="mh">0xF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">miniseed3</span> <span class="o">&amp;</span> <span class="mh">0x0F0</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">((</span><span class="n">miniseed3</span> <span class="o">&amp;</span> <span class="mh">0x00F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">combinedSeed</span> <span class="o">=</span> <span class="p">((</span><span class="n">miniseed1</span> <span class="o">^</span> <span class="n">miniseed2_reversed</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">miniseed2</span> <span class="o">^</span> <span class="n">miniseed3_reversed</span><span class="p">);</span>

	<span class="cm">/* Seeds can not be zero */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">combinedSeed</span> <span class="o">&amp;</span> <span class="n">NVREG_BKOFFCTRL_SEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">combinedSeed</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">combinedSeed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NVREG_BKOFFCTRL_SEED_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_BKOFFCTRL_GEAR</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">combinedSeed</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="cm">/* No need to disable tx here */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">NVREG_BKOFFCTRL_DEFAULT</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_BKOFFCTRL_SELECT</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">combinedSeed</span> <span class="o">&amp;</span> <span class="n">NVREG_BKOFFCTRL_SEED_MASK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">combinedSeed</span> <span class="o">&gt;&gt;</span> <span class="n">NVREG_BKOFFCTRL_GEAR</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegBackOffControl</span><span class="p">);</span>

	<span class="cm">/* Setup seeds for all gear LFSRs. */</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seedset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seedset</span><span class="p">));</span>
	<span class="n">seedset</span> <span class="o">=</span> <span class="n">seedset</span> <span class="o">%</span> <span class="n">BACKOFF_SEEDSET_ROWS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">BACKOFF_SEEDSET_LFSRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">NVREG_BKOFFCTRL_DEFAULT</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_BKOFFCTRL_SELECT</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">main_seedset</span><span class="p">[</span><span class="n">seedset</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">gear_seedset</span><span class="p">[</span><span class="n">seedset</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_BKOFFCTRL_GEAR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegBackOffControl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_start_xmit: dev-&gt;hard_start_xmit function</span>
<span class="cm"> * Called with netif_tx_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">nv_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_flags_extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span> <span class="o">?</span> <span class="n">NV_TX_LASTPACKET</span> <span class="o">:</span> <span class="n">NV_TX2_LASTPACKET</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragments</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">NV_TX2_TSO_MAX_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">empty_slots</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">put_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">start_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">prev_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">prev_tx_ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* add fragments to entries count */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fragments</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">frag_size</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">entries</span> <span class="o">+=</span> <span class="p">(</span><span class="n">frag_size</span> <span class="o">&gt;&gt;</span> <span class="n">NV_TX2_TSO_MAX_SHIFT</span><span class="p">)</span> <span class="o">+</span>
			   <span class="p">((</span><span class="n">frag_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">empty_slots</span> <span class="o">=</span> <span class="n">nv_get_empty_tx_slots</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">empty_slots</span> <span class="o">&lt;=</span> <span class="n">entries</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">start_tx</span> <span class="o">=</span> <span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>

	<span class="cm">/* setup the header buffer */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prev_tx</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>
		<span class="n">prev_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">,</span>
						<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_single</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">bcnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">tx_flags</span><span class="p">);</span>

		<span class="n">tx_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">put_tx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">))</span>
			<span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* setup the fragments */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fragments</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">frag_size</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">prev_tx</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>
			<span class="n">prev_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>
			<span class="n">bcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">frag_size</span> <span class="o">&gt;</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span> <span class="o">:</span> <span class="n">frag_size</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span>
							<span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">frag</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							<span class="n">bcnt</span><span class="p">,</span>
							<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_single</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">bcnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">tx_flags</span><span class="p">);</span>

			<span class="n">offset</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
			<span class="n">frag_size</span> <span class="o">-=</span> <span class="n">bcnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">put_tx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">))</span>
				<span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">frag_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set last fragment flag  */</span>
	<span class="n">prev_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tx_flags_extra</span><span class="p">);</span>

	<span class="cm">/* save skb in this slot&#39;s context area */</span>
	<span class="n">prev_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">tx_flags_extra</span> <span class="o">=</span> <span class="n">NV_TX2_TSO</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&lt;&lt;</span> <span class="n">NV_TX2_TSO_SHIFT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tx_flags_extra</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span> <span class="o">?</span>
			 <span class="n">NV_TX2_CHECKSUM_L3</span> <span class="o">|</span> <span class="n">NV_TX2_CHECKSUM_L4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* set tx flags */</span>
	<span class="n">start_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tx_flags</span> <span class="o">|</span> <span class="n">tx_flags_extra</span><span class="p">);</span>

	<span class="n">netdev_sent_queue</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">nv_start_xmit_optimized</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_flags_extra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragments</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">NV_TX2_TSO_MAX_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">empty_slots</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">put_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">start_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">prev_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">prev_tx_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="n">start_tx_ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* add fragments to entries count */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fragments</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">frag_size</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">entries</span> <span class="o">+=</span> <span class="p">(</span><span class="n">frag_size</span> <span class="o">&gt;&gt;</span> <span class="n">NV_TX2_TSO_MAX_SHIFT</span><span class="p">)</span> <span class="o">+</span>
			   <span class="p">((</span><span class="n">frag_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">empty_slots</span> <span class="o">=</span> <span class="n">nv_get_empty_tx_slots</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">empty_slots</span> <span class="o">&lt;=</span> <span class="n">entries</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">start_tx</span> <span class="o">=</span> <span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
	<span class="n">start_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>

	<span class="cm">/* setup the header buffer */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prev_tx</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>
		<span class="n">prev_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">,</span>
						<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_single</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_high</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
		<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">buflow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
		<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">bcnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">tx_flags</span><span class="p">);</span>

		<span class="n">tx_flags</span> <span class="o">=</span> <span class="n">NV_TX2_VALID</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">put_tx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">))</span>
			<span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* setup the fragments */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fragments</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">frag_size</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">prev_tx</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>
			<span class="n">prev_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>
			<span class="n">bcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">frag_size</span> <span class="o">&gt;</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">NV_TX2_TSO_MAX_SIZE</span> <span class="o">:</span> <span class="n">frag_size</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span>
							<span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">frag</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							<span class="n">bcnt</span><span class="p">,</span>
							<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma_single</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_high</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
			<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">buflow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
			<span class="n">put_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">bcnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">tx_flags</span><span class="p">);</span>

			<span class="n">offset</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
			<span class="n">frag_size</span> <span class="o">-=</span> <span class="n">bcnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">put_tx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">))</span>
				<span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">frag_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set last fragment flag  */</span>
	<span class="n">prev_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NV_TX2_LASTPACKET</span><span class="p">);</span>

	<span class="cm">/* save skb in this slot&#39;s context area */</span>
	<span class="n">prev_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">tx_flags_extra</span> <span class="o">=</span> <span class="n">NV_TX2_TSO</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&lt;&lt;</span> <span class="n">NV_TX2_TSO_SHIFT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tx_flags_extra</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span> <span class="o">?</span>
			 <span class="n">NV_TX2_CHECKSUM_L3</span> <span class="o">|</span> <span class="n">NV_TX2_CHECKSUM_L4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* vlan tag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">start_tx</span><span class="o">-&gt;</span><span class="n">txvlan</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NV_TX3_VLAN_TAG_PRESENT</span> <span class="o">|</span>
					<span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">start_tx</span><span class="o">-&gt;</span><span class="n">txvlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Limit the number of outstanding tx. Setup all fragments, but</span>
<span class="cm">		 * do not set the VALID bit on the first descriptor. Save a pointer</span>
<span class="cm">		 * to that descriptor and also for next skb_map element.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_progress</span> <span class="o">==</span> <span class="n">NV_TX_LIMIT_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span> <span class="o">=</span> <span class="n">start_tx_ctx</span><span class="p">;</span>

			<span class="cm">/* remove VALID bit */</span>
			<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_TX2_VALID</span><span class="p">;</span>
			<span class="n">start_tx_ctx</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span> <span class="o">=</span> <span class="n">start_tx</span><span class="p">;</span>
			<span class="n">start_tx_ctx</span><span class="o">-&gt;</span><span class="n">next_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_end_flip</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx_ctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_progress</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set tx flags */</span>
	<span class="n">start_tx</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tx_flags</span> <span class="o">|</span> <span class="n">tx_flags_extra</span><span class="p">);</span>

	<span class="n">netdev_sent_queue</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nv_tx_flip_ownership</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_progress</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span><span class="o">-&gt;</span><span class="n">flaglen</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NV_TX2_VALID</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_progress</span><span class="o">++</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span><span class="o">-&gt;</span><span class="n">next_tx_ctx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_end_flip</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_tx_done: check for completed packets, release the skbs.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must own np-&gt;lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="n">orig_get_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_compl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">orig</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">((</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">flaglen</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">NV_TX_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">tx_work</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">nv_unmap_txskb</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX_LASTPACKET</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX_ERROR</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX_RETRYERROR</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX_RETRYCOUNT_MASK</span><span class="p">))</span>
						<span class="n">nv_legacybackoff_reseed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_bytes</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">bytes_compl</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">tx_work</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_LASTPACKET</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_ERROR</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_RETRYERROR</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_RETRYCOUNT_MASK</span><span class="p">))</span>
						<span class="n">nv_legacybackoff_reseed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_bytes</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">bytes_compl</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">tx_work</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">orig</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_completed_queue</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">,</span> <span class="n">bytes_compl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">orig</span> <span class="o">!=</span> <span class="n">orig_get_tx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tx_work</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_tx_done_optimized</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="n">orig_get_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes_cleaned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">ex</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">((</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">flaglen</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">NV_TX2_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">tx_work</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">nv_unmap_txskb</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_LASTPACKET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_RETRYERROR</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_TX2_RETRYCOUNT_MASK</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_GEAR_MODE</span><span class="p">)</span>
						<span class="n">nv_gear_backoff_reseed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">nv_legacybackoff_reseed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_tx_bytes</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_tx_syncp</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">bytes_cleaned</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">tx_work</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span><span class="p">)</span>
				<span class="n">nv_tx_flip_ownership</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">ex</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_tx_ctx</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_tx_ctx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_completed_queue</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">,</span> <span class="n">bytes_cleaned</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span><span class="p">.</span><span class="n">ex</span> <span class="o">!=</span> <span class="n">orig_get_tx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tx_work</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_tx_timeout: dev-&gt;tx_timeout function</span>
<span class="cm"> * Called with netif_tx_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ring_type</span> <span class="n">put_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_tx_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQSTAT_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQSTAT_MASK</span><span class="p">;</span>

	<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Got tx_timeout. irq status: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">debug_tx_timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ring at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dumping tx registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;%3x: %08x %08x %08x %08x &quot;</span>
				    <span class="s">&quot;%08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">i</span><span class="p">,</span>
				    <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
				    <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span>
				    <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">20</span><span class="p">),</span>
				    <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">24</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">28</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dumping tx ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;%03x: %08x %08x // %08x %08x &quot;</span>
					    <span class="s">&quot;// %08x %08x // %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">i</span><span class="p">,</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flaglen</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">buf</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">flaglen</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">].</span><span class="n">buf</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">].</span><span class="n">flaglen</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;%03x: %08x %08x %08x &quot;</span>
					    <span class="s">&quot;// %08x %08x %08x &quot;</span>
					    <span class="s">&quot;// %08x %08x %08x &quot;</span>
					    <span class="s">&quot;// %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">i</span><span class="p">,</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bufhigh</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buflow</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flaglen</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">bufhigh</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buflow</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flaglen</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">bufhigh</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">buflow</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">flaglen</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">].</span><span class="n">bufhigh</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">].</span><span class="n">buflow</span><span class="p">),</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">].</span><span class="n">flaglen</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* 1) stop tx engine */</span>
	<span class="n">nv_stop_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* 2) complete any outstanding tx and do not give HW any limited tx pkts */</span>
	<span class="n">saved_tx_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* prevent giving HW any limited pkts */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* prevent waking tx queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="n">nv_tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nv_tx_done_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>

	<span class="cm">/* save current HW position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span><span class="p">)</span>
		<span class="n">put_tx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_change_owner</span><span class="o">-&gt;</span><span class="n">first_tx_desc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">put_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span><span class="p">;</span>

	<span class="cm">/* 3) clear all tx state */</span>
	<span class="n">nv_drain_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_init_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* 4) restore state to current HW position */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_tx</span> <span class="o">=</span> <span class="n">put_tx</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span> <span class="o">=</span> <span class="n">saved_tx_limit</span><span class="p">;</span>

	<span class="cm">/* 5) restart tx engine */</span>
	<span class="n">nv_start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when the nic notices a mismatch between the actual data len on the</span>
<span class="cm"> * wire and the len indicated in the 802 header</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_getlen</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>	<span class="cm">/* length of the 802 header */</span>
	<span class="kt">int</span> <span class="n">protolen</span><span class="p">;</span>	<span class="cm">/* length as stored in the proto field */</span>

	<span class="cm">/* 1) calculate len according to header */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_vlan_proto</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">protolen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">protolen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protolen</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">datalen</span><span class="p">;</span> <span class="cm">/* Value in proto field not a len, no checks possible */</span>

	<span class="n">protolen</span> <span class="o">+=</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="cm">/* consistency checks: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;=</span> <span class="n">protolen</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* more data on wire than in 802 header, trim of</span>
<span class="cm">			 * additional data.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">protolen</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* less data on wire than mentioned in header.</span>
<span class="cm">			 * Discard the packet.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* short packet. Accept only if 802 values are also short */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">protolen</span> <span class="o">&gt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_rx_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">orig</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="o">!</span><span class="p">((</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">flaglen</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">NV_RX_AVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">rx_work</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * the packet is for us - immediately tear down the pci mapping.</span>
<span class="cm">		 * TODO: check if a prefetch of the first cacheline improves</span>
<span class="cm">		 * the performance.</span>
<span class="cm">		 */</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">,</span>
				<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* look at what we actually got: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_DESCRIPTORVALID</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEN_MASK_V1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_ERROR</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_ERROR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX_ERROR4</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">len</span> <span class="o">=</span> <span class="n">nv_getlen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
							<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="cm">/* framing errors are soft errors */</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_ERROR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX_FRAMINGERR</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_SUBSTRACT1</span><span class="p">)</span>
							<span class="n">len</span><span class="o">--</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* the rest are hard errors */</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_MISSEDFRAME</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
							<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_missed_errors</span><span class="o">++</span><span class="p">;</span>
							<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_DESCRIPTORVALID</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEN_MASK_V2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_ERROR4</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">len</span> <span class="o">=</span> <span class="n">nv_getlen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
							<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="cm">/* framing errors are soft errors */</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_FRAMINGERR</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_SUBSTRACT1</span><span class="p">)</span>
							<span class="n">len</span><span class="o">--</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* the rest are hard errors */</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_CHECKSUMMASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_CHECKSUM_IP_TCP</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/*ip and tcp */</span>
				    <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_CHECKSUMMASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_CHECKSUM_IP_UDP</span><span class="p">))</span>   <span class="cm">/*ip and udp */</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* got a valid packet - forward it to the network core */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
<span class="nl">next_pkt:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">orig</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx_ctx</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx_ctx</span><span class="p">;</span>

		<span class="n">rx_work</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rx_work</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_rx_process_optimized</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlanflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">ex</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">put_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="o">!</span><span class="p">((</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">flaglen</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">NV_RX2_AVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">rx_work</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * the packet is for us - immediately tear down the pci mapping.</span>
<span class="cm">		 * TODO: check if a prefetch of the first cacheline improves</span>
<span class="cm">		 * the performance.</span>
<span class="cm">		 */</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">,</span>
				<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* look at what we actually got: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_DESCRIPTORVALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEN_MASK_V2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_ERROR4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">len</span> <span class="o">=</span> <span class="n">nv_getlen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="cm">/* framing errors are soft errors */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_FRAMINGERR</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_SUBSTRACT1</span><span class="p">)</span>
						<span class="n">len</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* the rest are hard errors */</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_CHECKSUMMASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_CHECKSUM_IP_TCP</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/*ip and tcp */</span>
			    <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_CHECKSUMMASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NV_RX2_CHECKSUM_IP_UDP</span><span class="p">))</span>   <span class="cm">/*ip and udp */</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>

			<span class="cm">/* got a valid packet - forward it to the network core */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

			<span class="n">vlanflags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">buflow</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * There&#39;s need to check for NETIF_F_HW_VLAN_RX here.</span>
<span class="cm">			 * Even if vlan rx accel is disabled,</span>
<span class="cm">			 * NV_RX3_VLAN_TAG_PRESENT is pseudo randomly set.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vlanflags</span> <span class="o">&amp;</span> <span class="n">NV_RX3_VLAN_TAG_PRESENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">vlanflags</span> <span class="o">&amp;</span> <span class="n">NV_RX3_VLAN_TAG_MASK</span><span class="p">;</span>

				<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stat_rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">swstats_rx_syncp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">next_pkt:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">ex</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx</span><span class="p">.</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span><span class="o">++</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">last_rx_ctx</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">get_rx_ctx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">first_rx_ctx</span><span class="p">;</span>

		<span class="n">rx_work</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rx_work</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_bufsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">ETH_DATA_LEN</span> <span class="o">+</span> <span class="n">NV_RX_HEADERS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">NV_RX_HEADERS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_change_mtu: dev-&gt;change_mtu function</span>
<span class="cm"> * Called with dev_base_lock held for read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">old_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pkt_limit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">old_mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="cm">/* return early if the buffer sizes will not change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_mtu</span> <span class="o">&lt;=</span> <span class="n">ETH_DATA_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">new_mtu</span> <span class="o">&lt;=</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_mtu</span> <span class="o">==</span> <span class="n">new_mtu</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* synchronized against open : rtnl_lock() held by caller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * It seems that the nic preloads valid ring entries into an</span>
<span class="cm">		 * internal buffer. The procedure for flushing everything is</span>
<span class="cm">		 * guessed, there is probably a simpler approach.</span>
<span class="cm">		 * Changing the MTU is a rare event, it shouldn&#39;t matter.</span>
<span class="cm">		 */</span>
		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_napi_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/* stop engines */</span>
		<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* drain rx queue */</span>
		<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* reinit driver view of the rx queue */</span>
		<span class="n">set_bufsize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* reinit nic view of the rx queue */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegOffloadConfig</span><span class="p">);</span>
		<span class="n">setup_hw_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_SETUP_RX_RING</span> <span class="o">|</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_RXSHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_TXSHIFT</span><span class="p">),</span>
			<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRingSizes</span><span class="p">);</span>
		<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
		<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

		<span class="cm">/* restart rx engine */</span>
		<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_napi_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_copy_mac_to_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_set_mac_address: dev-&gt;set_mac_address function</span>
<span class="cm"> * Called with rtnl_lock() held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">macaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">macaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="cm">/* synchronized against open : rtnl_lock() held by caller */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">macaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_assign_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NET_ADDR_RANDOM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/* stop rx engine */</span>
		<span class="n">nv_stop_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* set mac address */</span>
		<span class="n">nv_copy_mac_to_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* restart rx engine */</span>
		<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nv_copy_mac_to_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nv_set_multicast: dev-&gt;set_multicast function</span>
<span class="cm"> * Called with netif_tx_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pff</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_PFF_PAUSE_RX</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pff</span> <span class="o">|=</span> <span class="n">NVREG_PFF_PROMISC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pff</span> <span class="o">|=</span> <span class="n">NVREG_PFF_MYADDR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

			<span class="n">alwaysOn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">alwaysOn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

				<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
					<span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

					<span class="n">a</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_addr</span><span class="p">);</span>
					<span class="n">b</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
					<span class="n">alwaysOn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">a</span><span class="p">;</span>
					<span class="n">alwaysOff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">a</span><span class="p">;</span>
					<span class="n">alwaysOn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">b</span><span class="p">;</span>
					<span class="n">alwaysOff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">b</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alwaysOn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">alwaysOff</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVREG_MCASTMASKA_NONE</span><span class="p">;</span>
			<span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVREG_MCASTMASKB_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">NVREG_MCASTADDRA_FORCE</span><span class="p">;</span>
	<span class="n">pff</span> <span class="o">|=</span> <span class="n">NVREG_PFF_ALWAYS</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nv_stop_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastAddrA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastAddrB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastMaskA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastMaskB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
	<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_update_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pause_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_PAUSEFRAME_TX_ENABLE</span> <span class="o">|</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_RX_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pff</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NVREG_PFF_PAUSE_RX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pff</span><span class="o">|</span><span class="n">NVREG_PFF_PAUSE_RX</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">regmisc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NVREG_MISC1_PAUSE_TX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pause_enable</span> <span class="o">=</span> <span class="n">NVREG_TX_PAUSEFRAME_ENABLE_V1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_PAUSEFRAME_TX_V2</span><span class="p">)</span>
				<span class="n">pause_enable</span> <span class="o">=</span> <span class="n">NVREG_TX_PAUSEFRAME_ENABLE_V2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pause_enable</span> <span class="o">=</span> <span class="n">NVREG_TX_PAUSEFRAME_ENABLE_V3</span><span class="p">;</span>
				<span class="cm">/* limit the number of tx pause frames to a default of 8 */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxPauseFrameLimit</span><span class="p">)</span><span class="o">|</span><span class="n">NVREG_TX_PAUSEFRAMELIMIT_ENABLE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxPauseFrameLimit</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pause_enable</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxPauseFrame</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">regmisc</span><span class="o">|</span><span class="n">NVREG_MISC1_PAUSE_TX</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TX_PAUSEFRAME_DISABLE</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxPauseFrame</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">regmisc</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_force_linkspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phyreg</span><span class="p">,</span> <span class="n">txreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mii_status</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">duplex</span><span class="p">;</span>

	<span class="cm">/* see if gigabit phy */</span>
	<span class="n">mii_status</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">=</span> <span class="n">PHY_GIGABIT</span><span class="p">;</span>
		<span class="n">phyreg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
		<span class="n">phyreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3FF00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_10</span><span class="p">)</span>
			<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">NVREG_SLOTTIME_10_100_FULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_100</span><span class="p">)</span>
			<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">NVREG_SLOTTIME_10_100_FULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
			<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">NVREG_SLOTTIME_1000_FULL</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">phyreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">phyreg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPhyInterface</span><span class="p">);</span>
	<span class="n">phyreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHY_HALF</span><span class="o">|</span><span class="n">PHY_100</span><span class="o">|</span><span class="n">PHY_1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">PHY_HALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_100</span><span class="p">)</span>
		<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">PHY_100</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span>
							<span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
		<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">PHY_1000</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phyreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPhyInterface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phyreg</span> <span class="o">&amp;</span> <span class="n">PHY_RGMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span>
							<span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_RGMII_1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_RGMII_10_100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">txreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxDeferral</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_WM_DESC1_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span>
					 <span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_WM_DESC2_3_1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_WM_DESC2_3_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">txreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxWatermark</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MISC1_FORCE</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">NVREG_MISC1_HD</span><span class="p">),</span>
			<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegLinkSpeed</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nv_update_linkspeed: Setup the MAC according to the link partner</span>
<span class="cm"> * @dev: Network device to be configured</span>
<span class="cm"> *</span>
<span class="cm"> * The function queries the PHY and checks if there is a link partner.</span>
<span class="cm"> * If yes, then it sets up the MAC accordingly. Otherwise, the MAC is</span>
<span class="cm"> * set to 10 MBit HD.</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns 0 if there is no link partner and 1 if there is</span>
<span class="cm"> * a good link partner.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_update_linkspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adv_lpa</span><span class="p">,</span> <span class="n">adv_pause</span><span class="p">,</span> <span class="n">lpa_pause</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newls</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newdup</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mii_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control_1000</span><span class="p">,</span> <span class="n">status_1000</span><span class="p">,</span> <span class="n">phyreg</span><span class="p">,</span> <span class="n">pause_flags</span><span class="p">,</span> <span class="n">txreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txrxFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_exp</span><span class="p">;</span>

	<span class="cm">/* If device loopback is enabled, set carrier on and enable max link</span>
<span class="cm">	 * speed.</span>
<span class="cm">	 */</span>
	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv_force_linkspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BMSR_LSTATUS is latched, read it twice:</span>
<span class="cm">	 * we want the current value.</span>
<span class="cm">	 */</span>
	<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">mii_status</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">fixed_mode</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_100</span><span class="p">;</span>
			<span class="n">newdup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">fixed_mode</span> <span class="o">&amp;</span> <span class="n">LPA_100HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_100</span><span class="p">;</span>
			<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">fixed_mode</span> <span class="o">&amp;</span> <span class="n">LPA_10FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
			<span class="n">newdup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
			<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check auto negotiation is complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCOMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* still in autonegotiation - configure nic for 10 MBit HD and wait. */</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">lpa</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control_1000</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">status_1000</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">control_1000</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">status_1000</span> <span class="o">&amp;</span> <span class="n">LPA_1000FULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_1000</span><span class="p">;</span>
			<span class="n">newdup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_speed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: handle parallel detection properly */</span>
	<span class="n">adv_lpa</span> <span class="o">=</span> <span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">adv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adv_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_100</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adv_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_100</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adv_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_10FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adv_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_10HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">newls</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">set_speed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">newdup</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">newls</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">newdup</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">=</span> <span class="n">newls</span><span class="p">;</span>

	<span class="cm">/* The transmitter and receiver must be restarted for safe update */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txrxFlags</span> <span class="o">|=</span> <span class="n">NV_RESTART_TX</span><span class="p">;</span>
		<span class="n">nv_stop_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_RCVCTL_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txrxFlags</span> <span class="o">|=</span> <span class="n">NV_RESTART_RX</span><span class="p">;</span>
		<span class="n">nv_stop_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phyreg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
		<span class="n">phyreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3FF00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_10</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_100</span><span class="p">))</span>
			<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">NVREG_SLOTTIME_10_100_FULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
			<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">NVREG_SLOTTIME_1000_FULL</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">phyreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">phyreg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPhyInterface</span><span class="p">);</span>
	<span class="n">phyreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHY_HALF</span><span class="o">|</span><span class="n">PHY_100</span><span class="o">|</span><span class="n">PHY_1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">PHY_HALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_100</span><span class="p">)</span>
		<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">PHY_100</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
		<span class="n">phyreg</span> <span class="o">|=</span> <span class="n">PHY_1000</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phyreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPhyInterface</span><span class="p">);</span>

	<span class="n">phy_exp</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_EXPANSION</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXPANSION_NWAY</span><span class="p">;</span> <span class="cm">/* autoneg capable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phyreg</span> <span class="o">&amp;</span> <span class="n">PHY_RGMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_RGMII_1000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_exp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_COLLISION_FIX</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_10</span><span class="p">)</span>
					<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_RGMII_STRETCH_10</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_RGMII_STRETCH_100</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_RGMII_10_100</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_exp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_COLLISION_FIX</span><span class="p">))</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_MII_STRETCH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_DEFERRAL_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">txreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxDeferral</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_WM_DESC1_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="n">NVREG_LINKSPEED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">)</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_WM_DESC2_3_1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">txreg</span> <span class="o">=</span> <span class="n">NVREG_TX_WM_DESC2_3_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">txreg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxWatermark</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MISC1_FORCE</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">NVREG_MISC1_HD</span><span class="p">),</span>
		<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegLinkSpeed</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="n">pause_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* setup pause frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_AUTONEG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adv_pause</span> <span class="o">=</span> <span class="n">adv</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>
			<span class="n">lpa_pause</span> <span class="o">=</span> <span class="n">lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_PAUSE_CAP</span> <span class="o">|</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">adv_pause</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ADVERTISE_PAUSE_CAP</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">lpa_pause</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">)</span>
						<span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ADVERTISE_PAUSE_ASYM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">lpa_pause</span> <span class="o">==</span> <span class="p">(</span><span class="n">LPA_PAUSE_CAP</span> <span class="o">|</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">))</span>
					<span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">lpa_pause</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pause_flags</span> <span class="o">|=</span>  <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">)</span>
						<span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lpa_pause</span> <span class="o">==</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">)</span>
					<span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pause_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nv_update_pause</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pause_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrxFlags</span> <span class="o">&amp;</span> <span class="n">NV_RESTART_TX</span><span class="p">)</span>
		<span class="n">nv_start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txrxFlags</span> <span class="o">&amp;</span> <span class="n">NV_RESTART_RX</span><span class="p">)</span>
		<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_linkchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_update_linkspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nv_txrx_gate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nv_txrx_gate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">nv_stop_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_link_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">miistat</span><span class="p">;</span>

	<span class="n">miistat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISTAT_LINKCHANGE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">miistat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NVREG_MIISTAT_LINKCHANGE</span><span class="p">))</span>
		<span class="n">nv_linkchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_msi_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Need to toggle the msi irq mask within the ethernet device,</span>
<span class="cm">	 * otherwise, future interrupts will not be detected.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIIrqMask</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MSI_VECTOR_0_ENABLED</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIIrqMask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nv_change_interrupt_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">total_work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optimization_mode</span> <span class="o">==</span> <span class="n">NV_OPTIMIZATION_MODE_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_work</span> <span class="o">&gt;</span> <span class="n">NV_DYNAMIC_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* transition to poll based interrupts */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">quiet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">!=</span> <span class="n">NVREG_IRQMASK_CPU</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">NVREG_IRQMASK_CPU</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">quiet_count</span> <span class="o">&lt;</span> <span class="n">NV_DYNAMIC_MAX_QUIET_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">quiet_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* reached a period of low activity, switch</span>
<span class="cm">				   to per tx/rx packet interrupts */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">!=</span> <span class="n">NVREG_IRQMASK_THROUGHPUT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">NVREG_IRQMASK_THROUGHPUT</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nic_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">nv_msi_workaround</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable further irq&#39;s (msix not enabled with napi)</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * All _optimized functions are used to help increase performance</span>
<span class="cm"> * (reduce CPU and increase throughput). They use descripter version 3,</span>
<span class="cm"> * compiler directives, and reduce memory accesses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nic_irq_optimized</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">nv_msi_workaround</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable further irq&#39;s (msix not enabled with napi)</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nic_irq_tx</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_TX_ALL</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx irq events: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nv_tx_done_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_WORK_PER_LOOP</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_interrupt_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* disable interrupts on the nic */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQ_TX_ALL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_TX_ALL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_WAIT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: too many iterations (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_napi_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fe_priv</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_count</span><span class="p">,</span> <span class="n">tx_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tx_work</span> <span class="o">+=</span> <span class="n">nv_tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">rx_count</span> <span class="o">=</span> <span class="n">nv_rx_process</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">rx_work</span><span class="p">);</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">nv_alloc_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tx_work</span> <span class="o">+=</span> <span class="n">nv_tx_done_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">rx_count</span> <span class="o">=</span> <span class="n">nv_rx_process_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="n">budget</span> <span class="o">-</span> <span class="n">rx_work</span><span class="p">);</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">nv_alloc_rx_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">rx_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_work</span> <span class="o">+=</span> <span class="n">rx_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nv_change_interrupt_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_work</span> <span class="o">+</span> <span class="n">rx_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_LINK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nv_link_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">need_linktimer</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">link_timeout</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nv_linkchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">LINK_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_RECOVER_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">recover_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_WAIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rx_work</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_work</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* re-enable interrupts</span>
<span class="cm">		   (msix not enabled in napi) */</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rx_work</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nic_irq_rx</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_RX_ALL</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx irq events: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nv_rx_process_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_WORK_PER_LOOP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nv_alloc_rx_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
					<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_interrupt_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* disable interrupts on the nic */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQ_RX_ALL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_RX_ALL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_WAIT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: too many iterations (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nic_irq_other</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq events: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* check tx in case we reached max loop limit in tx isr */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nv_tx_done_optimized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_WORK_PER_LOOP</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nv_link_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">need_linktimer</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">link_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nv_linkchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">LINK_TIMEOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_RECOVER_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="cm">/* disable interrupts on the nic */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQ_OTHER</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">recover_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_WAIT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_interrupt_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* disable interrupts on the nic */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQ_OTHER</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_WAIT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: too many iterations (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nic_irq_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQSTAT_MASK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_TIMER</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQSTAT_MASK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_TIMER</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_TIMER</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">nv_msi_workaround</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_test</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_msix_vector_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vector</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msixmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Each interrupt bit can be mapped to a MSIX vector (4 bits).</span>
<span class="cm">	 * MSIXMap0 represents the first 8 interrupts and MSIXMap1 represents</span>
<span class="cm">	 * the remaining 8 interrupts.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irqmask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">msixmap</span> <span class="o">|=</span> <span class="n">vector</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap0</span><span class="p">)</span> <span class="o">|</span> <span class="n">msixmap</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap0</span><span class="p">);</span>

	<span class="n">msixmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irqmask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">msixmap</span> <span class="o">|=</span> <span class="n">vector</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap1</span><span class="p">)</span> <span class="o">|</span> <span class="n">msixmap</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">nv_nic_irq_test</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">nv_nic_irq_optimized</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">nv_nic_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_VECTORS_MASK</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_VECTORS_MASK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">|=</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optimization_mode</span> <span class="o">==</span> <span class="n">NV_OPTIMIZATION_MODE_THROUGHPUT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">intr_test</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Request irq for rx handling */</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name_rx</span><span class="p">,</span> <span class="s">&quot;%s-rx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
						<span class="n">nv_nic_irq_rx</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">name_rx</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="s">&quot;request_irq failed for rx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">ret</span><span class="p">);</span>
					<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_ENABLED</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Request irq for tx handling */</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name_tx</span><span class="p">,</span> <span class="s">&quot;%s-tx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
						<span class="n">nv_nic_irq_tx</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">name_tx</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="s">&quot;request_irq failed for tx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">ret</span><span class="p">);</span>
					<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_ENABLED</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_free_rx</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Request irq for link and timer handling */</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name_other</span><span class="p">,</span> <span class="s">&quot;%s-other&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_OTHER</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
						<span class="n">nv_nic_irq_other</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">name_other</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="s">&quot;request_irq failed for link %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">ret</span><span class="p">);</span>
					<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_ENABLED</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_free_tx</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* map interrupts to their respective vector */</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap0</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap1</span><span class="p">);</span>
				<span class="n">set_msix_vector_map</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">,</span> <span class="n">NVREG_IRQ_RX_ALL</span><span class="p">);</span>
				<span class="n">set_msix_vector_map</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">,</span> <span class="n">NVREG_IRQ_TX_ALL</span><span class="p">);</span>
				<span class="n">set_msix_vector_map</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_MSI_X_VECTOR_OTHER</span><span class="p">,</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Request irq for all interrupts */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_ALL</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="s">&quot;request_irq failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">ret</span><span class="p">);</span>
					<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_ENABLED</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* map interrupts to vector 0 */</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap0</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXMap1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI-X enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">|=</span> <span class="n">NV_MSI_ENABLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">ret</span><span class="p">);</span>
				<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_ENABLED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* map interrupts to vector 0 */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIMap0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIMap1</span><span class="p">);</span>
			<span class="cm">/* enable msi vector 0 */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MSI_VECTOR_0_ENABLED</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIIrqMask</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free_tx:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">out_free_rx:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_VECTORS_MASK</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_ENABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_ENABLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_do_nic_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First disable irq(s) and then</span>
<span class="cm">	 * reenable interrupts on the nic, we have to do this before calling</span>
<span class="cm">	 * nv_nic_irq because that may decide to do otherwise</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_multi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span>
			<span class="n">disable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_ALL</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">disable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_RX_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_RX_ALL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_TX_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_TX_ALL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_OTHER</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* disable_irq() contains synchronize_irq, thus no irq handler can run now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">recover_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">recover_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC in recoverable error state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="cm">/* stop engines */</span>
			<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_POWER_CNTRL</span><span class="p">)</span>
				<span class="n">nv_mac_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* drain rx queue */</span>
			<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* reinit driver view of the rx queue */</span>
			<span class="n">set_bufsize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nv_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
					<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* reinit nic view of the rx queue */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegOffloadConfig</span><span class="p">);</span>
			<span class="n">setup_hw_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_SETUP_RX_RING</span> <span class="o">|</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_RXSHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_TXSHIFT</span><span class="p">),</span>
				<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRingSizes</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
			<span class="cm">/* clear interrupts */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">))</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>

			<span class="cm">/* restart rx engine */</span>
			<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqMask</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_multi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
			<span class="n">nv_nic_irq_optimized</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nv_nic_irq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">)</span>
			<span class="n">enable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_ALL</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">enable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_RX_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_IRQ_RX_ALL</span><span class="p">;</span>
			<span class="n">nv_nic_irq_rx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">enable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_RX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_TX_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_IRQ_TX_ALL</span><span class="p">;</span>
			<span class="n">nv_nic_irq_tx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">enable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_TX</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;</span> <span class="n">NVREG_IRQ_OTHER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll_irq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_IRQ_OTHER</span><span class="p">;</span>
			<span class="n">nv_nic_irq_other</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">enable_irq_lockdep</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">NV_MSI_X_VECTOR_OTHER</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nv_do_nic_poll</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_do_stats_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If lock is currently taken, the stats are being refreshed</span>
<span class="cm">	 * and hence fresh enough */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">stats_poll</span><span class="p">,</span>
			<span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">STATS_INTERVAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">FORCEDETH_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span><span class="p">)</span>
		<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">NVREG_WAKEUPFLAGS_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegWakeUpFlags</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adv</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We do not track link speed / duplex setting if the</span>
<span class="cm">		 * interface is disabled. Force a link check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_update_linkspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NVREG_LINKSPEED_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NVREG_LINKSPEED_10</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NVREG_LINKSPEED_100</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NVREG_LINKSPEED_1000</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_MII</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
		<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10HALF</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10FULL</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100HALF</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">)</span>
				<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
		<span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
		<span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
		<span class="n">SUPPORTED_MII</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>

	<span class="cm">/* ignore maxtxpkt, maxrxpkt for now */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ecmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">PORT_MII</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">!=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: support switching between multiple phys. Should be</span>
<span class="cm">		 * trivial, but not enabled due to lack of test hardware. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span> <span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
			  <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note: autonegotiation disable, speed 1000 intentionally</span>
<span class="cm">		 * forbidden - no one should need that. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* with plain spinlock lockdep complains */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* stop engines */</span>
		<span class="cm">/* FIXME:</span>
<span class="cm">		 * this can take some time, and interrupts are disabled</span>
<span class="cm">		 * due to spin_lock_irqsave, but let&#39;s hope no daemon</span>
<span class="cm">		 * is going to change the settings very often...</span>
<span class="cm">		 * Worst case:</span>
<span class="cm">		 * NV_RXSTOP_DELAY1MAX + NV_TXSTOP_DELAY1MAX</span>
<span class="cm">		 * + some minor delays, which is up to a second approximately</span>
<span class="cm">		 */</span>
		<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">adv</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* advertise only what has been requested */</span>
		<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_ALL</span> <span class="o">|</span> <span class="n">ADVERTISE_100BASE4</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_RX_REQ</span><span class="p">)</span>  <span class="cm">/* for rx we set both advertisements but disable tx pause */</span>
			<span class="n">adv</span> <span class="o">|=</span>  <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span>  <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
			<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
			<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_MARVELL_E3016</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span><span class="p">;</span>
			<span class="cm">/* reset the phy in order for settings to stick,</span>
<span class="cm">			 * and cause autoneg to start */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;phy reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
			<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">adv</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_ALL</span> <span class="o">|</span> <span class="n">ADVERTISE_100BASE4</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span> <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span> <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_PAUSEFRAME_AUTONEG</span><span class="o">|</span><span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="o">|</span><span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_RX_REQ</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* for rx we set both advertisements but disable tx pause */</span>
			<span class="n">adv</span> <span class="o">|=</span>  <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adv</span> <span class="o">|=</span>  <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">fixed_mode</span> <span class="o">=</span> <span class="n">adv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
			<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
			<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_ANENABLE</span><span class="o">|</span><span class="n">BMCR_SPEED100</span><span class="o">|</span><span class="n">BMCR_SPEED1000</span><span class="o">|</span><span class="n">BMCR_FULLDPLX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">fixed_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_10FULL</span><span class="o">|</span><span class="n">ADVERTISE_100FULL</span><span class="p">))</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">fixed_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_100HALF</span><span class="o">|</span><span class="n">ADVERTISE_100FULL</span><span class="p">))</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_MARVELL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset the phy in order for forced mode settings to stick */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;phy reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Wait a bit and then reconfigure the nic. */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">nv_linkchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FORCEDETH_REGS_VER	1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">rbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">FORCEDETH_REGS_VER</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="cm">/* stop engines */</span>
			<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_MARVELL_E3016</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span><span class="p">;</span>
			<span class="cm">/* reset the phy in order for settings to stick*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;phy reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
			<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span><span class="o">*</span> <span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="o">?</span> <span class="n">RING_MAX_DESC_VER_1</span> <span class="o">:</span> <span class="n">RING_MAX_DESC_VER_2_3</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="o">?</span> <span class="n">RING_MAX_DESC_VER_1</span> <span class="o">:</span> <span class="n">RING_MAX_DESC_VER_2_3</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span><span class="o">*</span> <span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxtx_ring</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_skbuff</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_skbuff</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="n">RX_RING_MIN</span> <span class="o">||</span>
	    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;</span> <span class="n">TX_RING_MIN</span> <span class="o">||</span>
	    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">RING_MAX_DESC_VER_1</span> <span class="o">||</span>
	      <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">RING_MAX_DESC_VER_1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">!=</span> <span class="n">DESC_VER_1</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">RING_MAX_DESC_VER_2_3</span> <span class="o">||</span>
	      <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">RING_MAX_DESC_VER_2_3</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate new rings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rxtx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">ring_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxtx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">ring_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rx_skbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span><span class="p">)</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">tx_skbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span><span class="p">)</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxtx_ring</span> <span class="o">||</span> <span class="o">!</span><span class="n">rx_skbuff</span> <span class="o">||</span> <span class="o">!</span><span class="n">tx_skbuff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fall back to old rings */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxtx_ring</span><span class="p">)</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">),</span>
						    <span class="n">rxtx_ring</span><span class="p">,</span> <span class="n">ring_addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxtx_ring</span><span class="p">)</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">),</span>
						    <span class="n">rxtx_ring</span><span class="p">,</span> <span class="n">ring_addr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">rx_skbuff</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tx_skbuff</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_napi_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/* stop engines */</span>
		<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* drain queues */</span>
		<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* delete queues */</span>
		<span class="n">free_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set new values */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">rxtx_ring</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span> <span class="o">*</span><span class="p">)</span><span class="n">rxtx_ring</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_skbuff</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_skbuff</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span> <span class="o">=</span> <span class="n">ring_addr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reinit driver view of the queues */</span>
		<span class="n">set_bufsize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* reinit nic view of the queues */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegOffloadConfig</span><span class="p">);</span>
		<span class="n">setup_hw_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_SETUP_RX_RING</span> <span class="o">|</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_RXSHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_TXSHIFT</span><span class="p">),</span>
			<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRingSizes</span><span class="p">);</span>
		<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
		<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

		<span class="cm">/* restart engines */</span>
		<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_napi_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_pauseparam</span><span class="o">*</span> <span class="n">pause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_AUTONEG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_pauseparam</span><span class="o">*</span> <span class="n">pause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">adv</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can not set pause settings when forced link is in half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hardware does not support tx pause frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/* stop engines */</span>
		<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_PAUSEFRAME_RX_REQ</span><span class="o">|</span><span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_RX_REQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="n">pause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_AUTONEG</span><span class="p">;</span>

		<span class="n">adv</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_RX_REQ</span><span class="p">)</span> <span class="cm">/* for rx we set both advertisements but disable tx pause */</span>
			<span class="n">adv</span> <span class="o">|=</span>  <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span>  <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_PAUSEFRAME_AUTONEG</span><span class="o">|</span><span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="o">|</span><span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_RX_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_ENABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">nv_update_linkspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nv_update_pause</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">miicontrol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">miicontrol</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">miicontrol</span> <span class="o">&amp;</span> <span class="n">BMCR_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Loopback already enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* Turn on loopback mode */</span>
		<span class="n">miicontrol</span> <span class="o">|=</span> <span class="n">BMCR_LOOPBACK</span> <span class="o">|</span> <span class="n">BMCR_FULLDPLX</span> <span class="o">|</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">miicontrol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">PHY_ERROR</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">phy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Force 1000 Mbps full-duplex */</span>
				<span class="n">nv_force_linkspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVREG_LINKSPEED_1000</span><span class="p">,</span>
									 <span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* Force link up */</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Internal PHY loopback mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">miicontrol</span> <span class="o">&amp;</span> <span class="n">BMCR_LOOPBACK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Loopback already disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* Turn off loopback */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Internal PHY loopback mode disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">phy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">nv_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* vlan is dependent on rx checksum offload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="o">|</span><span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_vlan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">get_nvpriv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">|=</span> <span class="n">NVREG_TXRXCTL_VLANSTRIP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_TXRXCTL_VLANSTRIP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">|=</span> <span class="n">NVREG_TXRXCTL_VLANINS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_TXRXCTL_VLANINS</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">nv_set_loopback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">|=</span> <span class="n">NVREG_TXRXCTL_RXCHECK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_TXRXCTL_RXCHECK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span>
		<span class="n">nv_vlan_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_TEST_EXTENDED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NV_TEST_COUNT_EXTENDED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">NV_TEST_COUNT_BASE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V3</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NV_DEV_STATISTICS_V3_COUNT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NV_DEV_STATISTICS_V2_COUNT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NV_DEV_STATISTICS_V1_COUNT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">estats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>
	<span class="n">nv_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">,</span>
	       <span class="n">nv_get_sset_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_link_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mii_status</span><span class="p">;</span>

	<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
	<span class="n">mii_status</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>

	<span class="cm">/* check phy link status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_register_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_read</span><span class="p">,</span> <span class="n">new_read</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">orig_read</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* xor with mask to toggle bits */</span>
		<span class="n">orig_read</span> <span class="o">^=</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">orig_read</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

		<span class="n">new_read</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">new_read</span> <span class="o">&amp;</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">orig_read</span> <span class="o">&amp;</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* restore original value */</span>
		<span class="n">orig_read</span> <span class="o">^=</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">orig_read</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">nv_registers_test</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nv_registers_test</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_interrupt_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">testcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_msi_flags</span><span class="p">,</span> <span class="n">save_poll_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* free current irq */</span>
		<span class="n">nv_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">save_poll_interval</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="n">NvRegPollingInterval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* flag to test interrupt handler */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup test irq */</span>
	<span class="n">save_msi_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_VECTORS_MASK</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">|=</span> <span class="mh">0x001</span><span class="p">;</span> <span class="cm">/* setup 1 vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup timer interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_POLL_DEFAULT_CPU</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPollingInterval</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_UNKSETUP6_VAL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegUnknownSetupReg6</span><span class="p">);</span>

	<span class="n">nv_enable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVREG_IRQ_TIMER</span><span class="p">);</span>

	<span class="cm">/* wait for at least one interrupt */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* flag should be set within ISR */</span>
	<span class="n">testcnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_test</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">testcnt</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">nv_disable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVREG_IRQ_TIMER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">nv_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">=</span> <span class="n">save_msi_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">save_poll_interval</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPollingInterval</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_UNKSETUP6_VAL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegUnknownSetupReg6</span><span class="p">);</span>
		<span class="cm">/* restore original irq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_loopback_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">test_dma_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_flags_extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span> <span class="o">?</span> <span class="n">NV_TX_LASTPACKET</span> <span class="o">:</span> <span class="n">NV_TX2_LASTPACKET</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pkt_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">filter_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc1_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv_disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">filter_flags</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
		<span class="n">misc1_flags</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reinit driver view of the rx queue */</span>
	<span class="n">set_bufsize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* setup hardware for loopback */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MISC1_FORCE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_PFF_ALWAYS</span> <span class="o">|</span> <span class="n">NVREG_PFF_LOOPBACK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>

	<span class="cm">/* reinit nic view of the rx queue */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegOffloadConfig</span><span class="p">);</span>
	<span class="n">setup_hw_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_SETUP_RX_RING</span> <span class="o">|</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_RXSHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_TXSHIFT</span><span class="p">),</span>
		<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRingSizes</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/* restart rx engine */</span>
	<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* setup packet for tx */</span>
	<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">ETH_DATA_LEN</span><span class="p">;</span>
	<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;netdev_alloc_skb() failed during loopback test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">test_dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">),</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">pkt_data</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pkt_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">test_dma_addr</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">pkt_len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|</span> <span class="n">tx_flags_extra</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bufhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_high</span><span class="p">(</span><span class="n">test_dma_addr</span><span class="p">));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buflow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_low</span><span class="p">(</span><span class="n">test_dma_addr</span><span class="p">));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flaglen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">pkt_len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|</span> <span class="n">tx_flags_extra</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="cm">/* check for rx of the packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flaglen</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">nv_descr_getlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flaglen</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">nv_descr_getlength_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_AVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX_ERROR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_RX2_ERROR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">pkt_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">test_dma_addr</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="cm">/* stop engines */</span>
	<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* drain rx queue */</span>
	<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">misc1_flags</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">filter_flags</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
		<span class="n">nv_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_self_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_test</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nv_get_sset_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ETH_SS_TEST</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_link_test</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">nv_napi_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">nv_disable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_ENABLED</span><span class="p">))</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMSIXIrqStatus</span><span class="p">);</span>
			<span class="cm">/* stop engines */</span>
			<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* drain rx queue */</span>
			<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_register_test</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">nv_interrupt_test</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* bail out */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_loopback_test</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* reinit driver view of the rx queue */</span>
			<span class="n">set_bufsize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nv_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
					<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* reinit nic view of the rx queue */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegOffloadConfig</span><span class="p">);</span>
			<span class="n">setup_hw_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_SETUP_RX_RING</span> <span class="o">|</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_RXSHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_TXSHIFT</span><span class="p">),</span>
				<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRingSizes</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_KICK</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
			<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
			<span class="cm">/* restart rx engine */</span>
			<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">nv_napi_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">nv_enable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_estats_str</span><span class="p">,</span> <span class="n">nv_get_sset_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_ethtool_str</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_etests_str</span><span class="p">,</span> <span class="n">nv_get_sset_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ETH_SS_TEST</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_ethtool_str</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">nv_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">nv_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span> <span class="o">=</span> <span class="n">nv_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">nv_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">nv_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span> <span class="o">=</span> <span class="n">nv_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span> <span class="o">=</span> <span class="n">nv_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">nv_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span> <span class="o">=</span> <span class="n">nv_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span> <span class="o">=</span> <span class="n">nv_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">nv_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span> <span class="o">=</span> <span class="n">nv_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">nv_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">nv_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">nv_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">self_test</span> <span class="o">=</span> <span class="n">nv_self_test</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The mgmt unit and driver use a semaphore to access the phy during init */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_mgmt_acquire_sema</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_ctrl</span><span class="p">,</span> <span class="n">mgmt_sema</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt_sema</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_MGMT_SEMA_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_sema</span> <span class="o">==</span> <span class="n">NVREG_XMITCTL_MGMT_SEMA_FREE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_sema</span> <span class="o">!=</span> <span class="n">NVREG_XMITCTL_MGMT_SEMA_FREE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
		<span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">NVREG_XMITCTL_HOST_SEMA_ACQ</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>

		<span class="cm">/* verify that semaphore was acquired */</span>
		<span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">tx_ctrl</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_HOST_SEMA_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_XMITCTL_HOST_SEMA_ACQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">tx_ctrl</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_MGMT_SEMA_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NVREG_XMITCTL_MGMT_SEMA_FREE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mgmt_sema</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_mgmt_release_sema</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tx_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_MGMT_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mgmt_sema</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
			<span class="n">tx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_XMITCTL_HOST_SEMA_ACQ</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tx_ctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_mgmt_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data_ready</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data_ready2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MGMTUNITGETVERSION</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMgmtUnitGetVersion</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data_ready</span> <span class="o">^</span> <span class="n">NVREG_XMITCTL_DATA_START</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data_ready2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data_ready</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_DATA_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">data_ready2</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_DATA_READY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ready</span> <span class="o">||</span> <span class="p">(</span><span class="n">data_ready2</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_DATA_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mgmt_version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMgmtUnitVersion</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_MGMTUNITVERSION</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oom</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>

	<span class="cm">/* power up phy */</span>
	<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
	       <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BMCR_PDOWN</span><span class="p">);</span>

	<span class="n">nv_txrx_gate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="cm">/* erase previous misconfiguration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_POWER_CNTRL</span><span class="p">)</span>
		<span class="n">nv_mac_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MCASTADDRA_FORCE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastAddrA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastAddrB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MCASTMASKA_NONE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastMaskA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MCASTMASKB_NONE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastMaskB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverControl</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegAdapterControl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">NV_PAUSEFRAME_TX_CAPABLE</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TX_PAUSEFRAME_DISABLE</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxPauseFrame</span><span class="p">);</span>

	<span class="cm">/* initialize descriptor rings */</span>
	<span class="n">set_bufsize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">oom</span> <span class="o">=</span> <span class="n">nv_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegLinkSpeed</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_TRANSMITPOLL_MAC_ADDR_REV</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>
	<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegUnknownSetupReg6</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* give hw rings */</span>
	<span class="n">setup_hw_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_SETUP_RX_RING</span> <span class="o">|</span> <span class="n">NV_SETUP_TX_RING</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_RXSHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_RINGSZ_TXSHIFT</span><span class="p">),</span>
		<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRingSizes</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegLinkSpeed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TX_WM_DESC1_DEFAULT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxWatermark</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TX_WM_DESC2_3_DEFAULT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxWatermark</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlanctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegVlanControl</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TXRXCTL_BIT1</span><span class="o">|</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxRxControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NvRegUnknownSetupReg5</span><span class="p">,</span>
		      <span class="n">NVREG_UNKSETUP5_BIT31</span><span class="p">,</span> <span class="n">NVREG_UNKSETUP5_BIT31</span><span class="p">,</span>
		      <span class="n">NV_SETUP5_DELAY</span><span class="p">,</span> <span class="n">NV_SETUP5_DELAYMAX</span><span class="p">))</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;%s: SetupReg5, Bit 31 remained off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIMask</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISTAT_MASK_ALL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MISC1_FORCE</span> <span class="o">|</span> <span class="n">NVREG_MISC1_HD</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMisc1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterStatus</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterStatus</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_PFF_ALWAYS</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegOffloadConfig</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverStatus</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegReceiverStatus</span><span class="p">);</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">low</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">low</span><span class="p">));</span>
	<span class="n">low</span> <span class="o">&amp;=</span> <span class="n">NVREG_SLOTTIME_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">low</span><span class="o">|</span><span class="n">NVREG_SLOTTIME_DEFAULT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_GEAR_MODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* setup legacy backoff */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_SLOTTIME_LEGBF_ENABLED</span><span class="o">|</span><span class="n">NVREG_SLOTTIME_10_100_FULL</span><span class="o">|</span><span class="n">low</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_SLOTTIME_10_100_FULL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegSlotTime</span><span class="p">);</span>
			<span class="n">nv_gear_backoff_reseed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_TX_DEFERRAL_DEFAULT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTxDeferral</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_RX_DEFERRAL_DEFAULT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegRxDeferral</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poll_interval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optimization_mode</span> <span class="o">==</span> <span class="n">NV_OPTIMIZATION_MODE_THROUGHPUT</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_POLL_DEFAULT_THROUGHPUT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPollingInterval</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_POLL_DEFAULT_CPU</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPollingInterval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">poll_interval</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPollingInterval</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_UNKSETUP6_VAL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegUnknownSetupReg6</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span> <span class="o">&lt;&lt;</span> <span class="n">NVREG_ADAPTCTL_PHYSHIFT</span><span class="p">)</span><span class="o">|</span><span class="n">NVREG_ADAPTCTL_PHYVALID</span><span class="o">|</span><span class="n">NVREG_ADAPTCTL_RUNNING</span><span class="p">,</span>
			<span class="n">base</span> <span class="o">+</span> <span class="n">NvRegAdapterControl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISPEED_BIT8</span><span class="o">|</span><span class="n">NVREG_MIIDELAY</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIISpeed</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MII_LINKCHANGE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIMask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_WAKEUPFLAGS_ENABLE</span> <span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegWakeUpFlags</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">NVREG_POWERSTATE_POWEREDUP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_POWERSTATE_POWEREDUP</span><span class="o">|</span><span class="n">i</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState</span><span class="p">);</span>

	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState</span><span class="p">)</span> <span class="o">|</span> <span class="n">NVREG_POWERSTATE_VALID</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState</span><span class="p">);</span>

	<span class="n">nv_disable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISTAT_MASK_ALL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_IRQSTAT_MASK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegIrqStatus</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_drain</span><span class="p">;</span>

	<span class="cm">/* ask for interrupts */</span>
	<span class="n">nv_enable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MCASTADDRA_FORCE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastAddrA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastAddrB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MCASTMASKA_NONE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastMaskA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MCASTMASKB_NONE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMulticastMaskB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_PFF_ALWAYS</span><span class="o">|</span><span class="n">NVREG_PFF_MYADDR</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
	<span class="cm">/* One manual link speed update: Interrupts are enabled, future link</span>
<span class="cm">	 * speed changes cause interrupts and are handled by nv_link_irq().</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">miistat</span><span class="p">;</span>
		<span class="n">miistat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISTAT_MASK_ALL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set linkspeed to invalid value, thus force nv_update_linkspeed</span>
<span class="cm">	 * to init hw */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nv_update_linkspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_start_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_napi_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no link during initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oom</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">OOM_REFILL</span><span class="p">);</span>

	<span class="cm">/* start statistics timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V2</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V3</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">stats_poll</span><span class="p">,</span>
			<span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">STATS_INTERVAL</span><span class="p">));</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* If the loopback feature was set while the device was down, make sure</span>
<span class="cm">	 * that it&#39;s set correctly now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span>
		<span class="n">nv_set_loopback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_drain:</span>
	<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">in_shutdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nv_napi_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">stats_poll</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nv_stop_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_txrx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* disable interrupts on the nic or we will lock up */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nv_disable_hw_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">);</span>
	<span class="n">pci_push</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">nv_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">nv_drain_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">phy_power_down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_txrx_gate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_PFF_ALWAYS</span><span class="o">|</span><span class="n">NVREG_PFF_MYADDR</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPacketFilterFlags</span><span class="p">);</span>
		<span class="n">nv_start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* power down phy */</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
		       <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">)</span><span class="o">|</span><span class="n">BMCR_PDOWN</span><span class="p">);</span>
		<span class="n">nv_txrx_gate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: power down nic */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">nv_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">nv_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">nv_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">nv_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">nv_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">nv_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">nv_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">nv_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">nv_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">nv_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">nv_set_multicast</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">nv_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">nv_netdev_ops_optimized</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">nv_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">nv_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">nv_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">nv_start_xmit_optimized</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">nv_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">nv_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">nv_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">nv_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">nv_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">nv_set_multicast</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">nv_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">nv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">powerstate</span><span class="p">,</span> <span class="n">txreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phystate_orig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phystate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phyinitialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Reverse Engineered nForce ethernet driver. Version %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FORCEDETH_VERSION</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fe_priv</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">hwstats_lock</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">oom_kick</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nv_do_rx_refill</span><span class="p">;</span>	<span class="cm">/* timer handler */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">nic_poll</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nv_do_nic_poll</span><span class="p">;</span>	<span class="cm">/* timer handler */</span>
	<span class="n">init_timer_deferrable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">stats_poll</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats_poll</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats_poll</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nv_do_stats_poll</span><span class="p">;</span>	<span class="cm">/* timer handler */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEV_HAS_VLAN</span><span class="o">|</span><span class="n">DEV_HAS_MSI_X</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V2</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V3</span><span class="p">))</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span> <span class="o">=</span> <span class="n">NV_PCI_REGSZ_VER3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_STATISTICS_V1</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span> <span class="o">=</span> <span class="n">NV_PCI_REGSZ_VER2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span> <span class="o">=</span> <span class="n">NV_PCI_REGSZ_VER1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span> <span class="o">&amp;&amp;</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find register window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_relreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy of driver data */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="cm">/* copy of device id */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/* handle different descriptor versions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_HIGH_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* packet format 3: supports 40-bit addressing */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">=</span> <span class="n">DESC_VER_3</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">=</span> <span class="n">NVREG_TXRXCTL_DESC_3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_64bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">39</span><span class="p">)))</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;64-bit DMA failed, using 32-bit addressing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">39</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;64-bit DMA (consistent) failed, using 32-bit ring buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_LARGEDESC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* packet format 2: supports jumbo frames */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">=</span> <span class="n">DESC_VER_2</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">=</span> <span class="n">NVREG_TXRXCTL_DESC_2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* original packet format */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">=</span> <span class="n">DESC_VER_1</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">=</span> <span class="n">NVREG_TXRXCTL_DESC_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pkt_limit</span> <span class="o">=</span> <span class="n">NV_PKTLIMIT_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_LARGEDESC</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pkt_limit</span> <span class="o">=</span> <span class="n">NV_PKTLIMIT_2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_CHECKSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">txrxctl_bits</span> <span class="o">|=</span> <span class="n">NVREG_TXRXCTL_RXCHECK</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span>
			<span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">vlanctl_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vlanctl_bits</span> <span class="o">=</span> <span class="n">NVREG_VLANCONTROL_ENABLE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>

	<span class="cm">/* Add loopback capability to the device. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">=</span> <span class="n">NV_PAUSEFRAME_RX_CAPABLE</span> <span class="o">|</span> <span class="n">NV_PAUSEFRAME_RX_REQ</span> <span class="o">|</span> <span class="n">NV_PAUSEFRAME_AUTONEG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_PAUSEFRAME_TX_V2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pause_flags</span> <span class="o">|=</span> <span class="n">NV_PAUSEFRAME_TX_CAPABLE</span> <span class="o">|</span> <span class="n">NV_PAUSEFRAME_TX_REQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_relreg</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">RX_RING_DEFAULT</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">TX_RING_DEFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">orig</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_desc_ex</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ring_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">ex</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_skb_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">||</span> <span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freering</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_optimized</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_netdev_ops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_netdev_ops_optimized</span><span class="p">;</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">nv_napi_poll</span><span class="p">,</span> <span class="n">RX_WORK_PER_LOOP</span><span class="p">);</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">NV_WATCHDOG_TIMEO</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* read the mac address */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrA</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrB</span><span class="p">);</span>

	<span class="cm">/* check the workaround bit for correct mac address order */</span>
	<span class="n">txreg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mac address is already in correct order */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txreg</span> <span class="o">&amp;</span> <span class="n">NVREG_TRANSMITPOLL_MAC_ADDR_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mac address is already in correct order */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set orig mac address back to the reversed version.</span>
<span class="cm">		 * This flag will be cleared during low power transition.</span>
<span class="cm">		 * Therefore, we should always put back the reversed address.</span>
<span class="cm">		 */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* need to reverse mac address to correct order */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">txreg</span><span class="o">|</span><span class="n">NVREG_TRANSMITPOLL_MAC_ADDR_REV</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: set workaround bit for reversed mac addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bad mac address. At least one bios sets the mac address</span>
<span class="cm">		 * to 01:23:45:67:89:ab</span>
<span class="cm">		 */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Invalid MAC address detected: %pM - Please complain to your hardware vendor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Using random MAC address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set mac address */</span>
	<span class="n">nv_copy_mac_to_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* disable WOL */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegWakeUpFlags</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_POWER_CNTRL</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* take phy and nic out of low power mode */</span>
		<span class="n">powerstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>
		<span class="n">powerstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_POWERSTATE2_POWERUP_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_LOW_POWER_FIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0xA3</span><span class="p">)</span>
			<span class="n">powerstate</span> <span class="o">|=</span> <span class="n">NVREG_POWERSTATE2_POWERUP_REV_A3</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">powerstate</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegPowerState2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span> <span class="o">==</span> <span class="n">DESC_VER_1</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">NV_TX_VALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">NV_TX2_VALID</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_MSI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">msi</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">|=</span> <span class="n">NV_MSI_CAPABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_MSI_X</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* msix has had reported issues when modifying irqmask</span>
<span class="cm">		   as in the case of napi, therefore, disable for now</span>
<span class="cm">		*/</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		np-&gt;msi_flags |= NV_MSI_X_CAPABLE;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optimization_mode</span> <span class="o">==</span> <span class="n">NV_OPTIMIZATION_MODE_CPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">NVREG_IRQMASK_CPU</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_CAPABLE</span><span class="p">)</span> <span class="cm">/* set number of vectors */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optimization_mode</span> <span class="o">==</span> <span class="n">NV_OPTIMIZATION_MODE_DYNAMIC</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* start off in throughput mode */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">NVREG_IRQMASK_THROUGHPUT</span><span class="p">;</span>
		<span class="cm">/* remove support for msix mode */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MSI_X_CAPABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">optimization_mode</span> <span class="o">=</span> <span class="n">NV_OPTIMIZATION_MODE_THROUGHPUT</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">NVREG_IRQMASK_THROUGHPUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_CAPABLE</span><span class="p">)</span> <span class="cm">/* set number of vectors */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">|=</span> <span class="mh">0x0003</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">|=</span> <span class="n">NVREG_IRQ_TIMER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">need_linktimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">LINK_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">need_linktimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Limit the number of tx&#39;s outstanding for hw bug */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_TX_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_TX_LIMIT2</span><span class="p">)</span> <span class="o">==</span> <span class="n">DEV_NEED_TX_LIMIT2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0xA2</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear phy state and temporarily halt phy interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIMask</span><span class="p">);</span>
	<span class="n">phystate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegAdapterControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phystate</span> <span class="o">&amp;</span> <span class="n">NVREG_ADAPTCTL_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phystate_orig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">phystate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVREG_ADAPTCTL_RUNNING</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">phystate</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegAdapterControl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NVREG_MIISTAT_MASK_ALL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMIIStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_MGMT_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* management unit running on the mac? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_MGMT_ST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_SYNC_PHY_INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nv_mgmt_acquire_sema</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nv_mgmt_get_version</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mgmt_version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMgmtUnitControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_MGMTUNITCONTROL_INUSE</span><span class="p">;</span>
			<span class="cm">/* management unit setup the phy already? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_in_use</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitterControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVREG_XMITCTL_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">NVREG_XMITCTL_SYNC_PHY_INIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* phy is inited by mgmt unit */</span>
				<span class="n">phyinitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* we need to init the phy */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* find a suitable phy */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">phyaddr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">id1</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id1</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">id2</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id2</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">=</span> <span class="n">id2</span> <span class="o">&amp;</span> <span class="n">PHYID2_MODEL_MASK</span><span class="p">;</span>
		<span class="n">id1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id1</span> <span class="o">&amp;</span> <span class="n">PHYID1_OUI_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PHYID1_OUI_SHFT</span><span class="p">;</span>
		<span class="n">id2</span> <span class="o">=</span> <span class="p">(</span><span class="n">id2</span> <span class="o">&amp;</span> <span class="n">PHYID2_OUI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PHYID2_OUI_SHFT</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span> <span class="o">=</span> <span class="n">phyaddr</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">=</span> <span class="n">id1</span> <span class="o">|</span> <span class="n">id2</span><span class="p">;</span>

		<span class="cm">/* Realtek hardcoded phy id1 to all zero&#39;s on certain phys */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_REALTEK2</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">=</span> <span class="n">PHY_OUI_REALTEK</span><span class="p">;</span>
		<span class="cm">/* Setup phy revision for Realtek */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_REALTEK</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8211</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_rev</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_RESV1</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHY_REV_MASK</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;open: Could not find a valid PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phyinitialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset it */</span>
		<span class="n">phy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* see if it is a gigabit phy */</span>
		<span class="n">u32</span> <span class="n">mii_status</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="n">PHY_GIGABIT</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">=</span> <span class="n">PHY_GIGABIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set default link speed settings */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">=</span> <span class="n">NVREG_LINKSPEED_FORCE</span><span class="o">|</span><span class="n">NVREG_LINKSPEED_10</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register netdev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_VLAN</span><span class="p">)</span>
		<span class="n">nv_vlan_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ifname %s, PHY OUI 0x%x @ %d, addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s%s%s%s%s%s%s%s%s%s%sdesc-v%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HIGHDMA</span> <span class="o">?</span> <span class="s">&quot;highdma &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;csum &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;vlan &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;loopback &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_POWER_CNTRL</span> <span class="o">?</span> <span class="s">&quot;pwrctl &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_HAS_MGMT_UNIT</span> <span class="o">?</span> <span class="s">&quot;mgmt &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_TIMERIRQ</span> <span class="o">?</span> <span class="s">&quot;timirq &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">np</span><span class="o">-&gt;</span><span class="n">gigabit</span> <span class="o">==</span> <span class="n">PHY_GIGABIT</span> <span class="o">?</span> <span class="s">&quot;gbit &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">np</span><span class="o">-&gt;</span><span class="n">need_linktimer</span> <span class="o">?</span> <span class="s">&quot;lnktim &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_CAPABLE</span> <span class="o">?</span> <span class="s">&quot;msi &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">np</span><span class="o">-&gt;</span><span class="n">msi_flags</span> <span class="o">&amp;</span> <span class="n">NV_MSI_X_CAPABLE</span> <span class="o">?</span> <span class="s">&quot;msi-x &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">np</span><span class="o">-&gt;</span><span class="n">desc_ver</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phystate_orig</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">phystate</span><span class="o">|</span><span class="n">NVREG_ADAPTCTL_RUNNING</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegAdapterControl</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out_freering:</span>
	<span class="n">free_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="nl">out_relreg:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="nl">out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_restore_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">phy_reserved</span><span class="p">,</span> <span class="n">mii_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_oui</span> <span class="o">==</span> <span class="n">PHY_OUI_REALTEK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_model</span> <span class="o">==</span> <span class="n">PHY_MODEL_REALTEK_8201</span> <span class="o">&amp;&amp;</span>
	    <span class="n">phy_cross</span> <span class="o">==</span> <span class="n">NV_CROSSOVER_DETECTION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT3</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG2</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">phy_reserved</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_REALTEK_INIT_MSK1</span><span class="p">;</span>
		<span class="n">phy_reserved</span> <span class="o">|=</span> <span class="n">PHY_REALTEK_INIT8</span><span class="p">;</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG2</span><span class="p">,</span> <span class="n">phy_reserved</span><span class="p">);</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT_REG1</span><span class="p">,</span> <span class="n">PHY_REALTEK_INIT1</span><span class="p">);</span>

		<span class="cm">/* restart auto negotiation */</span>
		<span class="n">mii_control</span> <span class="o">=</span> <span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_READ</span><span class="p">);</span>
		<span class="n">mii_control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANRESTART</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
		<span class="n">mii_rw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">mii_control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_restore_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* special op: write back the misordered MAC address - otherwise</span>
<span class="cm">	 * the next nv_probe would see a wrong address.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegMacAddrB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NVREG_TRANSMITPOLL_MAC_ADDR_REV</span><span class="p">,</span>
	       <span class="n">base</span> <span class="o">+</span> <span class="n">NvRegTransmitPoll</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">nv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">nv_restore_mac_addr</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* restore any phy related changes */</span>
	<span class="n">nv_restore_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">nv_mgmt_release_sema</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* free all structures */</span>
	<span class="n">free_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Gross. */</span>
		<span class="n">nv_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* save non-pci configuration space */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">saved_config_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_hwbase</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* restore non-pci configuration space */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">register_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">saved_config_space</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">base</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">DEV_NEED_MSI_FIX</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MSI_PRIV_OFFSET</span><span class="p">,</span> <span class="n">NV_MSI_PRIV_VALUE</span><span class="p">);</span>

	<span class="cm">/* restore phy state, including autoneg */</span>
	<span class="n">phy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">nv_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">nv_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">nv_pm_ops</span><span class="p">,</span> <span class="n">nv_suspend</span><span class="p">,</span> <span class="n">nv_resume</span><span class="p">);</span>
<span class="cp">#define NV_PM_OPS (&amp;nv_pm_ops)</span>

<span class="cp">#else</span>
<span class="cp">#define NV_PM_OPS NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM_SLEEP */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fe_priv</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">nv_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore the MAC so a kernel started by kexec won&#39;t get confused.</span>
<span class="cm">	 * If we really go for poweroff, we must not restore the MAC,</span>
<span class="cm">	 * otherwise the MAC for WOL will be reversed at least on some boards.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">system_state</span> <span class="o">!=</span> <span class="n">SYSTEM_POWER_OFF</span><span class="p">)</span>
		<span class="n">nv_restore_mac_addr</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Apparently it is not possible to reinitialise from D3 hot,</span>
<span class="cm">	 * only put the device into D3 if we really go for poweroff.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">system_state</span> <span class="o">==</span> <span class="n">SYSTEM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">wolenabled</span><span class="p">);</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define nv_shutdown NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* nForce Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x01C3</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* nForce2 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* nForce3 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x00D6</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* nForce3 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0086</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* nForce3 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x008C</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* nForce3 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x00E6</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* nForce3 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x00DF</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_TIMERIRQ</span><span class="o">|</span><span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* CK804 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* CK804 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0057</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP04 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP04 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP51 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0268</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_NEED_LOW_POWER_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP51 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0269</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V1</span><span class="o">|</span><span class="n">DEV_NEED_LOW_POWER_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP55 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0372</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_VLAN</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_MSI_X</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP55 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0373</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_VLAN</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_MSI_X</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP61 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x03E5</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP61 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP61 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x03EE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP61 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x03EF</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP65 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0450</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP65 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0451</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP65 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0452</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP65 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0453</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP67 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x054C</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP67 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x054D</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP67 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x054E</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP67 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x054F</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP73 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x07DC</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP73 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x07DD</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP73 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x07DE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP73 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x07DF</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V1</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V12</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP77 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0760</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V2</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP77 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0761</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V2</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP77 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0762</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V2</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP77 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0763</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V2</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_MGMT_UNIT</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP79 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0AB0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP79 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0AB1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP79 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0AB2</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP79 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0AB3</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_NEED_TX_LIMIT2</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="o">|</span><span class="n">DEV_NEED_MSI_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* MCP89 Ethernet Controller */</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10DE</span><span class="p">,</span> <span class="mh">0x0D7D</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">DEV_NEED_LINKTIMER</span><span class="o">|</span><span class="n">DEV_HAS_LARGEDESC</span><span class="o">|</span><span class="n">DEV_HAS_CHECKSUM</span><span class="o">|</span><span class="n">DEV_HAS_HIGH_DMA</span><span class="o">|</span><span class="n">DEV_HAS_MSI</span><span class="o">|</span><span class="n">DEV_HAS_POWER_CNTRL</span><span class="o">|</span><span class="n">DEV_HAS_PAUSEFRAME_TX_V3</span><span class="o">|</span><span class="n">DEV_HAS_STATISTICS_V123</span><span class="o">|</span><span class="n">DEV_HAS_TEST_EXTENDED</span><span class="o">|</span><span class="n">DEV_HAS_CORRECT_MACADDR</span><span class="o">|</span><span class="n">DEV_HAS_COLLISION_FIX</span><span class="o">|</span><span class="n">DEV_HAS_GEAR_MODE</span><span class="o">|</span><span class="n">DEV_NEED_PHY_INIT_FIX</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">nv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">nv_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">nv_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">NV_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_nic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_nic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;forcedeth maximum events handled per interrupt&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">optimization_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">optimization_mode</span><span class="p">,</span> <span class="s">&quot;In throughput mode (0), every tx &amp; rx packet will generate an interrupt. In CPU mode (1), interrupts are controlled by a timer. In dynamic mode (2), the mode toggles between throughput and CPU mode based on network load.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">,</span> <span class="s">&quot;Interval determines how frequent timer interrupt is generated by [(time_in_micro_secs * 100) / (2^10)]. Min is 0 and Max is 65535.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="s">&quot;MSI interrupts are enabled by setting to 1 and disabled by setting to 0.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msix</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msix</span><span class="p">,</span> <span class="s">&quot;MSIX interrupts are enabled by setting to 1 and disabled by setting to 0.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma_64bit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma_64bit</span><span class="p">,</span> <span class="s">&quot;High DMA is enabled by setting to 1 and disabled by setting to 0.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">phy_cross</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">phy_cross</span><span class="p">,</span> <span class="s">&quot;Phy crossover detection for Realtek 8201 phy is enabled by setting to 1 and disabled by setting to 0.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">phy_power_down</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">phy_power_down</span><span class="p">,</span> <span class="s">&quot;Power down phy and disable link when interface is down (1), or leave phy powered up (0).&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_tx_timeout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_tx_timeout</span><span class="p">,</span>
		 <span class="s">&quot;Dump tx related registers and ring when tx_timeout happens&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Manfred Spraul &lt;manfred@colorfullife.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Reverse Engineered nForce ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_tbl</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_nic</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_nic</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
