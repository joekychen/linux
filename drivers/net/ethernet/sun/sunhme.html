<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sun › sunhme.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sunhme.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* sunhme.c: Sparc HME/BigMac 10/100baseT half/full duplex auto switching,</span>
<span class="cm"> *           auto carrier detecting ethernet driver.  Also known as the</span>
<span class="cm"> *           &quot;Happy Meal Ethernet&quot; found on SunSwift SBUS cards.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996, 1998, 1999, 2002, 2003,</span>
<span class="cm"> *		2006, 2008 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> *</span>
<span class="cm"> * Changes :</span>
<span class="cm"> * 2000/11/11 Willy Tarreau &lt;willy AT meta-x.org&gt;</span>
<span class="cm"> *   - port to non-sparc architectures. Tested only on x86 and</span>
<span class="cm"> *     only currently works with QFE PCI cards.</span>
<span class="cm"> *   - ability to specify the MAC address at module load time by passing this</span>
<span class="cm"> *     argument : macaddr=0x00,0x10,0x20,0x30,0x40,0x50</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/openprom.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/auxio.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;sunhme.h&quot;</span>

<span class="cp">#define DRV_NAME	&quot;sunhme&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;3.10&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;August 26, 2008&quot;</span>
<span class="cp">#define DRV_AUTHOR	&quot;David S. Miller (davem@davemloft.net)&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">DRV_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_AUTHOR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun HappyMealEthernet(HME) 10/100baseT ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">macaddr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="cm">/* accept MAC address of the form macaddr=0x08,0x00,0x20,0x30,0x40,0x50 */</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">macaddr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">macaddr</span><span class="p">,</span> <span class="s">&quot;Happy Meal MAC address to set&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qfe_sbus_list</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qfe_pci_list</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#undef HMEDEBUG</span>
<span class="cp">#undef SXDEBUG</span>
<span class="cp">#undef RXDEBUG</span>
<span class="cp">#undef TXDEBUG</span>
<span class="cp">#undef TXLOGGING</span>

<span class="cp">#ifdef TXLOGGING</span>
<span class="k">struct</span> <span class="n">hme_tx_logent</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tstamp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_new</span><span class="p">,</span> <span class="n">tx_old</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">action</span><span class="p">;</span>
<span class="cp">#define TXLOG_ACTION_IRQ	0x01</span>
<span class="cp">#define TXLOG_ACTION_TXMIT	0x02</span>
<span class="cp">#define TXLOG_ACTION_TBUSY	0x04</span>
<span class="cp">#define TXLOG_ACTION_NBUFS	0x08</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define TX_LOG_LEN	128</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hme_tx_logent</span> <span class="n">tx_log</span><span class="p">[</span><span class="n">TX_LOG_LEN</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">txlog_cur_entry</span><span class="p">;</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">tx_add_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hme_tx_logent</span> <span class="o">*</span><span class="n">tlp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tlp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_log</span><span class="p">[</span><span class="n">txlog_cur_entry</span><span class="p">];</span>
	<span class="n">tlp</span><span class="o">-&gt;</span><span class="n">tstamp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">jiffies</span><span class="p">;</span>
	<span class="n">tlp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>
	<span class="n">tlp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>
	<span class="n">tlp</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">tlp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">txlog_cur_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">txlog_cur_entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_LOG_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">tx_dump_log</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">this</span><span class="p">;</span>

	<span class="n">this</span> <span class="o">=</span> <span class="n">txlog_cur_entry</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_LOG_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TXLOG[%d]: j[%08x] tx[N(%d)O(%d)] action[%08x] stat[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">tx_log</span><span class="p">[</span><span class="n">this</span><span class="p">].</span><span class="n">tstamp</span><span class="p">,</span>
		       <span class="n">tx_log</span><span class="p">[</span><span class="n">this</span><span class="p">].</span><span class="n">tx_new</span><span class="p">,</span> <span class="n">tx_log</span><span class="p">[</span><span class="n">this</span><span class="p">].</span><span class="n">tx_old</span><span class="p">,</span>
		       <span class="n">tx_log</span><span class="p">[</span><span class="n">this</span><span class="p">].</span><span class="n">action</span><span class="p">,</span> <span class="n">tx_log</span><span class="p">[</span><span class="n">this</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="n">this</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_LOG_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">tx_dump_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hmeal_init_block</span> <span class="o">*</span><span class="n">hb</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">happy_meal_txd</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TXD[%d..%d]: [%08x:%08x] [%08x:%08x] [%08x:%08x] [%08x:%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_flags</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_addr</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">tx_flags</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">tx_addr</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">tx_flags</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">tx_addr</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">].</span><span class="n">tx_flags</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">].</span><span class="n">tx_addr</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define tx_add_log(hp, a, s)		do { } while(0)</span>
<span class="cp">#define tx_dump_log()			do { } while(0)</span>
<span class="cp">#define tx_dump_ring(hp)		do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HMEDEBUG</span>
<span class="cp">#define HMD(x)  printk x</span>
<span class="cp">#else</span>
<span class="cp">#define HMD(x)</span>
<span class="cp">#endif</span>

<span class="cm">/* #define AUTO_SWITCH_DEBUG */</span>

<span class="cp">#ifdef AUTO_SWITCH_DEBUG</span>
<span class="cp">#define ASD(x)  printk x</span>
<span class="cp">#else</span>
<span class="cp">#define ASD(x)</span>
<span class="cp">#endif</span>

<span class="cp">#define DEFAULT_IPG0      16 </span><span class="cm">/* For lance-mode only */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_IPG1       8 </span><span class="cm">/* For all modes */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_IPG2       4 </span><span class="cm">/* For all modes */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_JAMSIZE    4 </span><span class="cm">/* Toe jam */</span><span class="cp"></span>

<span class="cm">/* NOTE: In the descriptor writes one _must_ write the address</span>
<span class="cm"> *	 member _first_.  The card must not be allowed to see</span>
<span class="cm"> *	 the updated descriptor flags until the address is</span>
<span class="cm"> *	 correct.  I&#39;ve added a write memory barrier between</span>
<span class="cm"> *	 the two stores so that I can sleep well at night... -DaveM</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_SBUS) &amp;&amp; defined(CONFIG_PCI)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbus_hme_write32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sbus_hme_read32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbus_hme_write_rxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbus_hme_write_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sbus_hme_read_desc32</span><span class="p">(</span><span class="n">hme32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_hme_write32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pci_hme_read32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_hme_write_rxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_hme_write_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">hme32</span><span class="p">)</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pci_hme_read_desc32</span><span class="p">(</span><span class="n">hme32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpup</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define hme_write32(__hp, __reg, __val) \</span>
<span class="cp">	((__hp)-&gt;write32((__reg), (__val)))</span>
<span class="cp">#define hme_read32(__hp, __reg) \</span>
<span class="cp">	((__hp)-&gt;read32(__reg))</span>
<span class="cp">#define hme_write_rxd(__hp, __rxd, __flags, __addr) \</span>
<span class="cp">	((__hp)-&gt;write_rxd((__rxd), (__flags), (__addr)))</span>
<span class="cp">#define hme_write_txd(__hp, __txd, __flags, __addr) \</span>
<span class="cp">	((__hp)-&gt;write_txd((__txd), (__flags), (__addr)))</span>
<span class="cp">#define hme_read_desc32(__hp, __p) \</span>
<span class="cp">	((__hp)-&gt;read_desc32(__p))</span>
<span class="cp">#define hme_dma_map(__hp, __ptr, __size, __dir) \</span>
<span class="cp">	((__hp)-&gt;dma_map((__hp)-&gt;dma_dev, (__ptr), (__size), (__dir)))</span>
<span class="cp">#define hme_dma_unmap(__hp, __addr, __size, __dir) \</span>
<span class="cp">	((__hp)-&gt;dma_unmap((__hp)-&gt;dma_dev, (__addr), (__size), (__dir)))</span>
<span class="cp">#define hme_dma_sync_for_cpu(__hp, __addr, __size, __dir) \</span>
<span class="cp">	((__hp)-&gt;dma_sync_for_cpu((__hp)-&gt;dma_dev, (__addr), (__size), (__dir)))</span>
<span class="cp">#define hme_dma_sync_for_device(__hp, __addr, __size, __dir) \</span>
<span class="cp">	((__hp)-&gt;dma_sync_for_device((__hp)-&gt;dma_dev, (__addr), (__size), (__dir)))</span>
<span class="cp">#else</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="cm">/* SBUS only compilation */</span>
<span class="cp">#define hme_write32(__hp, __reg, __val) \</span>
<span class="cp">	sbus_writel((__val), (__reg))</span>
<span class="cp">#define hme_read32(__hp, __reg) \</span>
<span class="cp">	sbus_readl(__reg)</span>
<span class="cp">#define hme_write_rxd(__hp, __rxd, __flags, __addr) \</span>
<span class="cp">do {	(__rxd)-&gt;rx_addr = (__force hme32)(u32)(__addr); \</span>
<span class="cp">	wmb(); \</span>
<span class="cp">	(__rxd)-&gt;rx_flags = (__force hme32)(u32)(__flags); \</span>
<span class="cp">} while(0)</span>
<span class="cp">#define hme_write_txd(__hp, __txd, __flags, __addr) \</span>
<span class="cp">do {	(__txd)-&gt;tx_addr = (__force hme32)(u32)(__addr); \</span>
<span class="cp">	wmb(); \</span>
<span class="cp">	(__txd)-&gt;tx_flags = (__force hme32)(u32)(__flags); \</span>
<span class="cp">} while(0)</span>
<span class="cp">#define hme_read_desc32(__hp, __p)	((__force u32)(hme32)*(__p))</span>
<span class="cp">#define hme_dma_map(__hp, __ptr, __size, __dir) \</span>
<span class="cp">	dma_map_single((__hp)-&gt;dma_dev, (__ptr), (__size), (__dir))</span>
<span class="cp">#define hme_dma_unmap(__hp, __addr, __size, __dir) \</span>
<span class="cp">	dma_unmap_single((__hp)-&gt;dma_dev, (__addr), (__size), (__dir))</span>
<span class="cp">#define hme_dma_sync_for_cpu(__hp, __addr, __size, __dir) \</span>
<span class="cp">	dma_dma_sync_single_for_cpu((__hp)-&gt;dma_dev, (__addr), (__size), (__dir))</span>
<span class="cp">#define hme_dma_sync_for_device(__hp, __addr, __size, __dir) \</span>
<span class="cp">	dma_dma_sync_single_for_device((__hp)-&gt;dma_dev, (__addr), (__size), (__dir))</span>
<span class="cp">#else</span>
<span class="cm">/* PCI only compilation */</span>
<span class="cp">#define hme_write32(__hp, __reg, __val) \</span>
<span class="cp">	writel((__val), (__reg))</span>
<span class="cp">#define hme_read32(__hp, __reg) \</span>
<span class="cp">	readl(__reg)</span>
<span class="cp">#define hme_write_rxd(__hp, __rxd, __flags, __addr) \</span>
<span class="cp">do {	(__rxd)-&gt;rx_addr = (__force hme32)cpu_to_le32(__addr); \</span>
<span class="cp">	wmb(); \</span>
<span class="cp">	(__rxd)-&gt;rx_flags = (__force hme32)cpu_to_le32(__flags); \</span>
<span class="cp">} while(0)</span>
<span class="cp">#define hme_write_txd(__hp, __txd, __flags, __addr) \</span>
<span class="cp">do {	(__txd)-&gt;tx_addr = (__force hme32)cpu_to_le32(__addr); \</span>
<span class="cp">	wmb(); \</span>
<span class="cp">	(__txd)-&gt;tx_flags = (__force hme32)cpu_to_le32(__flags); \</span>
<span class="cp">} while(0)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">hme_read_desc32</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">hme32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpup</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#define hme_dma_map(__hp, __ptr, __size, __dir) \</span>
<span class="cp">	pci_map_single((__hp)-&gt;dma_dev, (__ptr), (__size), (__dir))</span>
<span class="cp">#define hme_dma_unmap(__hp, __addr, __size, __dir) \</span>
<span class="cp">	pci_unmap_single((__hp)-&gt;dma_dev, (__addr), (__size), (__dir))</span>
<span class="cp">#define hme_dma_sync_for_cpu(__hp, __addr, __size, __dir) \</span>
<span class="cp">	pci_dma_sync_single_for_cpu((__hp)-&gt;dma_dev, (__addr), (__size), (__dir))</span>
<span class="cp">#define hme_dma_sync_for_device(__hp, __addr, __size, __dir) \</span>
<span class="cp">	pci_dma_sync_single_for_device((__hp)-&gt;dma_dev, (__addr), (__size), (__dir))</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>


<span class="cm">/* Oh yes, the MIF BitBang is mighty fun to program.  BitBucket is more like it. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">BB_PUT_BIT</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBDATA</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBCLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBCLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static u32 BB_GET_BIT(struct happy_meal *hp, void __iomem *tregs, int internal)</span>
<span class="c">{</span>
<span class="c">	u32 ret;</span>

<span class="c">	hme_write32(hp, tregs + TCVR_BBCLOCK, 0);</span>
<span class="c">	hme_write32(hp, tregs + TCVR_BBCLOCK, 1);</span>
<span class="c">	ret = hme_read32(hp, tregs + TCVR_CFG);</span>
<span class="c">	if (internal)</span>
<span class="c">		ret &amp;= TCV_CFG_MDIO0;</span>
<span class="c">	else</span>
<span class="c">		ret &amp;= TCV_CFG_MDIO1;</span>

<span class="c">	return ret;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">BB_GET_BIT2</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBCLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">&amp;=</span> <span class="n">TCV_CFG_MDIO0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">&amp;=</span> <span class="n">TCV_CFG_MDIO1</span><span class="p">;</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBCLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TCVR_FAILURE      0x80000000     </span><span class="cm">/* Impossible MIF read value */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_bb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_bb_read: reg=%d &quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="cm">/* Enable the MIF BitBang outputs. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBOENAB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Force BitBang into the idle state. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Give it the read sequence. */</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Give it the PHY address. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Tell it what register we want to read. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Close down the MIF BitBang outputs. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBOENAB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Now read in the value. */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">BB_GET_BIT2</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">internal</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">BB_GET_BIT2</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">internal</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">BB_GET_BIT2</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">internal</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">BB_GET_BIT2</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">internal</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">BB_GET_BIT2</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">internal</span><span class="p">));</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;value=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_bb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_bb_write: reg=%d value=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>

	<span class="cm">/* Enable the MIF BitBang outputs. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBOENAB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Force BitBang into the idle state. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Give it write sequence. */</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Give it the PHY address. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Tell it what register we will be writing. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Tell it to become ready for the bits. */</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">BB_PUT_BIT</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Close down the MIF BitBang outputs. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_BBOENAB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TCVR_READ_TRIES   16</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_tcvr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">TCVR_READ_TRIES</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_tcvr_read: reg=0x%02x &quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">none</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;no transceiver, value=TCVR_FAILURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">TCVR_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_FENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;doing bit bang</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">happy_meal_bb_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_FRAME</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">FRAME_READ</span> <span class="o">|</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_FRAME</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Aieee, transceiver MIF read bolixed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TCVR_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_FRAME</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;value=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TCVR_WRITE_TRIES  16</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_tcvr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">TCVR_WRITE_TRIES</span><span class="p">;</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_tcvr_write: reg=0x%02x value=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>

	<span class="cm">/* Welcome to Sun Microsystems, can I take your order please? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_FENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">happy_meal_bb_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Would you like fries with that? */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_FRAME</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">FRAME_WRITE</span> <span class="o">|</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_FRAME</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Anything else? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Aieee, transceiver MIF write bolixed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Fifty-two cents is your change, have a nice day. */</span>
<span class="p">}</span>

<span class="cm">/* Auto negotiation.  The scheme is very simple.  We have a timer routine</span>
<span class="cm"> * that keeps watching the auto negotiation process as it progresses.</span>
<span class="cm"> * The DP83840 is first told to start doing it&#39;s thing, we set up the time</span>
<span class="cm"> * and place the timer state machine in it&#39;s initial state.</span>
<span class="cm"> *</span>
<span class="cm"> * Here the timer peeks at the DP83840 status registers at each click to see</span>
<span class="cm"> * if the auto negotiation has completed, we assume here that the DP83840 PHY</span>
<span class="cm"> * will time out at some point and just tell us what (didn&#39;t) happen.  For</span>
<span class="cm"> * complete coverage we only allow so many of the ticks at this level to run,</span>
<span class="cm"> * when this has expired we print a warning message and try another strategy.</span>
<span class="cm"> * This &quot;other&quot; strategy is to force the interface into various speed/duplex</span>
<span class="cm"> * configurations and we stop when we see a link-up condition before the</span>
<span class="cm"> * maximum number of &quot;peek&quot; ticks have occurred.</span>
<span class="cm"> *</span>
<span class="cm"> * Once a valid link status has been detected we configure the BigMAC and</span>
<span class="cm"> * the rest of the Happy Meal to speak the most efficient protocol we could</span>
<span class="cm"> * get a clean link for.  The priority for link configurations, highest first</span>
<span class="cm"> * is:</span>
<span class="cm"> *                 100 Base-T Full Duplex</span>
<span class="cm"> *                 100 Base-T Half Duplex</span>
<span class="cm"> *                 10 Base-T Full Duplex</span>
<span class="cm"> *                 10 Base-T Half Duplex</span>
<span class="cm"> *</span>
<span class="cm"> * We start a new timer now, after a successful auto negotiation status has</span>
<span class="cm"> * been detected.  This timer just waits for the link-up bit to get set in</span>
<span class="cm"> * the BMCR of the DP83840.  When this occurs we print a kernel log message</span>
<span class="cm"> * describing the link type in use and the fact that it is up.</span>
<span class="cm"> *</span>
<span class="cm"> * If a fatal error of some sort is signalled and detected in the interrupt</span>
<span class="cm"> * service routine, and the chip is reset, or the link is ifconfig&#39;d down</span>
<span class="cm"> * and then back up, this entire process repeats itself all over again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_next_permutation</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>

	<span class="cm">/* Downgrade from full to half duplex.  Only possible</span>
<span class="cm">	 * via ethtool.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_FULLDPLX</span><span class="p">);</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Downgrade from 100 to 10. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_SPEED100</span><span class="p">);</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;ve tried everything. */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">display_link_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link is up using &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">external</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;external &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;internal &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;transceiver at &quot;</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_100HALF</span> <span class="o">|</span> <span class="n">LPA_100FULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;100Mb/s, Full Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;100Mb/s, Half Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_10FULL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;10Mb/s, Full Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;10Mb/s, Half Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">display_forced_link_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link has been forced up using &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">external</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;external &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;internal &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;transceiver at &quot;</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;100Mb/s, &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;10Mb/s, &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Full Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Half Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_happy_link_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">full</span><span class="p">;</span>

	<span class="cm">/* All we care about is making sure the bigmac tx_cfg has a</span>
<span class="cm">	 * proper duplex setting.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">==</span> <span class="n">arbwait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_10HALF</span> <span class="o">|</span> <span class="n">LPA_10FULL</span> <span class="o">|</span> <span class="n">LPA_100HALF</span> <span class="o">|</span> <span class="n">LPA_100FULL</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">no_response</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span>
			<span class="n">full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100HALF</span><span class="p">)</span>
			<span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_10FULL</span><span class="p">)</span>
			<span class="n">full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Forcing a link mode. */</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span>
			<span class="n">full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Before changing other bits in the tx_cfg register, and in</span>
<span class="cm">	 * general any of other the TX config registers too, you</span>
<span class="cm">	 * must:</span>
<span class="cm">	 * 1) Clear Enable</span>
<span class="cm">	 * 2) Poll with reads until that bit reads back as zero</span>
<span class="cm">	 * 3) Make TX configuration changes</span>
<span class="cm">	 * 4) Set Enable once more</span>
<span class="cm">	 */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">,</span>
		    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">BIGMAC_TXCFG_ENABLE</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIGMAC_TXCFG_ENABLE</span><span class="p">)</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">|=</span> <span class="n">HFLAG_FULL</span><span class="p">;</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">BIGMAC_TXCFG_FULLDPLX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFLAG_FULL</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">BIGMAC_TXCFG_FULLDPLX</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">,</span>
		    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">BIGMAC_TXCFG_ENABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">no_response:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">happy_meal_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_lucent_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mr2</span><span class="p">,</span> <span class="n">mr3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mr2</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mr3</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mr2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0180</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">mr3</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1d</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span><span class="o">++</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">arbwait</span>:
		<span class="cm">/* Only allow for 5 ticks, thats 10 seconds and much too</span>
<span class="cm">		 * long to wait for arbitration to complete.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enter force mode. */</span>
	<span class="nl">do_force_mode:</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Auto-Negotiation unsuccessful, trying force link mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
			<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_lucent_phy</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* OK, seems we need do disable the transceiver for the first</span>
<span class="cm">				 * tick to make sure we get an accurate link state at the</span>
<span class="cm">				 * second tick.</span>
<span class="cm">				 */</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">DP83840_CSCONFIG</span><span class="p">);</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSCONFIG_TCVDISAB</span><span class="p">);</span>
				<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">DP83840_CSCONFIG</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">ltrywait</span><span class="p">;</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Anything interesting happen? */</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCOMPLETE</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

				<span class="cm">/* Just what we&#39;ve been waiting for... */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">set_happy_link_modes</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Ooops, something bad happened, go to force</span>
<span class="cm">					 * mode.</span>
<span class="cm">					 *</span>
<span class="cm">					 * XXX Broken hubs which don&#39;t support 802.3u</span>
<span class="cm">					 * XXX auto-negotiation make this happen as well.</span>
<span class="cm">					 */</span>
					<span class="k">goto</span> <span class="n">do_force_mode</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Success, at least so far, advance our state engine. */</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">lupwait</span><span class="p">;</span>
				<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">lupwait</span>:
		<span class="cm">/* Auto negotiation was successful and we are awaiting a</span>
<span class="cm">		 * link up status.  I have decided to let this timer run</span>
<span class="cm">		 * forever until some sort of error is signalled, reporting</span>
<span class="cm">		 * a message to the user at 10 second intervals.</span>
<span class="cm">		 */</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Wheee, it&#39;s up, display the link mode in use and put</span>
<span class="cm">			 * the timer to sleep.</span>
<span class="cm">			 */</span>
			<span class="n">display_link_mode</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">asleep</span><span class="p">;</span>
			<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Auto negotiation successful, link still &quot;</span>
				       <span class="s">&quot;not completely up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ltrywait</span>:
		<span class="cm">/* Making the timeout here too long can make it take</span>
<span class="cm">		 * annoyingly long to attempt all of the link mode</span>
<span class="cm">		 * permutations, but then again this is essentially</span>
<span class="cm">		 * error recovery code for the most part.</span>
<span class="cm">		 */</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">DP83840_CSCONFIG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_lucent_phy</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Re-enable transceiver, we&#39;ll re-enable the transceiver next</span>
<span class="cm">				 * tick, then check link state on the following tick.</span>
<span class="cm">				 */</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">|=</span> <span class="n">CSCONFIG_TCVDISAB</span><span class="p">;</span>
				<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
						      <span class="n">DP83840_CSCONFIG</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_lucent_phy</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSCONFIG_TCVDISAB</span><span class="p">);</span>
				<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
						      <span class="n">DP83840_CSCONFIG</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Force mode selection success. */</span>
			<span class="n">display_forced_link_mode</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
			<span class="n">set_happy_link_modes</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span> <span class="cm">/* XXX error? then what? */</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">asleep</span><span class="p">;</span>
			<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 6 seconds or so... */</span>
				<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">try_next_permutation</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Aieee, tried them all, reset the</span>
<span class="cm">					 * chip and try all over again.</span>
<span class="cm">					 */</span>

					<span class="cm">/* Let the user know... */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Link down, cable problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

					<span class="n">ret</span> <span class="o">=</span> <span class="n">happy_meal_init</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* ho hum... */</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error, cannot re-init the &quot;</span>
						       <span class="s">&quot;Happy Meal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_lucent_phy</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
									       <span class="n">DP83840_CSCONFIG</span><span class="p">);</span>
					<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">|=</span> <span class="n">CSCONFIG_TCVDISAB</span><span class="p">;</span>
					<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
							      <span class="n">DP83840_CSCONFIG</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">asleep</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Can&#39;t happens.... */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Aieee, link timer is asleep but we got one anyways!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">restart_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">asleep</span><span class="p">;</span> <span class="cm">/* foo on you */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="mi">12</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* 1.2 sec. */</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TX_RESET_TRIES     32</span>
<span class="cp">#define RX_RESET_TRIES     32</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_tx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">TX_RESET_TRIES</span><span class="p">;</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_tx_reset: reset, &quot;</span><span class="p">));</span>

	<span class="cm">/* Would you like to try our SMCC Delux? */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXSWRESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXSWRESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Lettuce, tomato, buggy hardware (no extra charge)? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Transceiver BigMac ATTACK!&quot;</span><span class="p">);</span>

	<span class="cm">/* Take care. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_rx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">RX_RESET_TRIES</span><span class="p">;</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_rx_reset: reset, &quot;</span><span class="p">));</span>

	<span class="cm">/* We have a special on GNU/Viking hardware bugs today. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXSWRESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXSWRESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Will that be all? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Receiver BigMac ATTACK!&quot;</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t forget your vik_1137125_wa.  Have a nice day. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define STOP_TRIES         16</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">STOP_TRIES</span><span class="p">;</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_stop: reset, &quot;</span><span class="p">));</span>

	<span class="cm">/* We&#39;re consolidating our STB products, it&#39;s your lucky day. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_SWRESET</span><span class="p">,</span> <span class="n">GREG_RESET_ALL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_SWRESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Come back next week when we are &quot;Sun Microelectronics&quot;. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Fry guys.&quot;</span><span class="p">);</span>

	<span class="cm">/* Remember: &quot;Different name, same old buggy as shit hardware.&quot; */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_get_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RCRCECTR</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RCRCECTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_UNALECTR</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_UNALECTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_GLECTR</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_GLECTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_EXCTR</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">+=</span>
		<span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_EXCTR</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_LTCTR</span><span class="p">));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_EXCTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_LTCTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_poll_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_poll_stop: &quot;</span><span class="p">));</span>

	<span class="cm">/* If polling disabled or not polling already, nothing to do. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFLAG_POLLENABLE</span> <span class="o">|</span> <span class="n">HFLAG_POLL</span><span class="p">))</span> <span class="o">!=</span>
	   <span class="p">(</span><span class="n">HFLAG_POLLENABLE</span> <span class="o">|</span> <span class="n">HFLAG_POLL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;not polling, return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shut up the MIF. */</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;were polling, mif ints off, &quot;</span><span class="p">));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_IMASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* Turn off polling. */</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;polling off, &quot;</span><span class="p">));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
		    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_PENABLE</span><span class="p">));</span>

	<span class="cm">/* We are no longer polling. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFLAG_POLL</span><span class="p">);</span>

	<span class="cm">/* Let the bits set. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Only Sun can take such nice parts and fuck up the programming interface</span>
<span class="cm"> * like this.  Good job guys...</span>
<span class="cm"> */</span>
<span class="cp">#define TCVR_RESET_TRIES       16 </span><span class="cm">/* It should reset quickly        */</span><span class="cp"></span>
<span class="cp">#define TCVR_UNISOLATE_TRIES   32 </span><span class="cm">/* Dis-isolation can take longer. */</span><span class="cp"></span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_tcvr_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tconfig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">TCVR_RESET_TRIES</span><span class="p">;</span>

	<span class="n">tconfig</span> <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">);</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_tcvr_reset: tcfg&lt;%08lx&gt; &quot;</span><span class="p">,</span> <span class="n">tconfig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">external</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;external&lt;&quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span> <span class="n">tconfig</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_PSELECT</span><span class="p">));</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ITX</span><span class="p">;</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;ISOLATE,&quot;</span><span class="p">));</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">BMCR_LOOPBACK</span><span class="o">|</span><span class="n">BMCR_PDOWN</span><span class="o">|</span><span class="n">BMCR_ISOLATE</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">TCVR_FAILURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;phyread_fail&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;phyread_ok,PSELECT&gt;&quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span> <span class="n">tconfig</span> <span class="o">|</span> <span class="n">TCV_CFG_PSELECT</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">external</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ETX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tconfig</span> <span class="o">&amp;</span> <span class="n">TCV_CFG_MDIO1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;internal&lt;PSELECT,&quot;</span><span class="p">));</span>
			<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">tconfig</span> <span class="o">|</span> <span class="n">TCV_CFG_PSELECT</span><span class="p">));</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;ISOLATE,&quot;</span><span class="p">));</span>
			<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">BMCR_LOOPBACK</span><span class="o">|</span><span class="n">BMCR_PDOWN</span><span class="o">|</span><span class="n">BMCR_ISOLATE</span><span class="p">));</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">TCVR_FAILURE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;phyread_fail&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;phyread_ok,~PSELECT&gt;&quot;</span><span class="p">));</span>
			<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">tconfig</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_PSELECT</span><span class="p">)));</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ITX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;BMCR_RESET &quot;</span><span class="p">));</span>
	<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">TCVR_FAILURE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;BMCR RESET FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;RESET_OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="cm">/* Get fresh copies of the PHY registers. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span>      <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_physid1</span>   <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_physid2</span>   <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;UNISOLATE&quot;</span><span class="p">));</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_ISOLATE</span><span class="p">);</span>
	<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>

	<span class="n">tries</span> <span class="o">=</span> <span class="n">TCVR_UNISOLATE_TRIES</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">TCVR_FAILURE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">BMCR_ISOLATE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot; FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot; SUCCESS and CSCONFIG_DFBYPASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_lucent_phy</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
					      <span class="n">DP83840_CSCONFIG</span><span class="p">);</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
				      <span class="n">DP83840_CSCONFIG</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span> <span class="o">|</span> <span class="n">CSCONFIG_DFBYPASS</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Figure out whether we have an internal or external transceiver.</span>
<span class="cm"> *</span>
<span class="cm"> * hp-&gt;happy_lock must be held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_transceiver_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tconfig</span> <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">);</span>

	<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;happy_meal_transceiver_check: tcfg=%08lx &quot;</span><span class="p">,</span> <span class="n">tconfig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_POLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we are polling, we must stop to get the transceiver type. */</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;polling&gt; &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tconfig</span> <span class="o">&amp;</span> <span class="n">TCV_CFG_MDIO1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;internal&gt; &lt;poll stop&gt; &quot;</span><span class="p">));</span>
				<span class="n">happy_meal_poll_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ETX</span><span class="p">;</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">external</span><span class="p">;</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;external&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">tconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_PENABLE</span><span class="p">);</span>
				<span class="n">tconfig</span> <span class="o">|=</span> <span class="n">TCV_CFG_PSELECT</span><span class="p">;</span>
				<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span> <span class="n">tconfig</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">external</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;external&gt; &quot;</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_STATUS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;poll stop&gt; &quot;</span><span class="p">));</span>
					<span class="n">happy_meal_poll_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
					<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ITX</span><span class="p">;</span>
					<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
					<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;internal&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
					<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
						    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)</span> <span class="o">&amp;</span>
						    <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_PSELECT</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;none&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reread</span> <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">);</span>

		<span class="cm">/* Else we can just work off of the MDIO bits. */</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;not polling&gt; &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reread</span> <span class="o">&amp;</span> <span class="n">TCV_CFG_MDIO1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span> <span class="n">tconfig</span> <span class="o">|</span> <span class="n">TCV_CFG_PSELECT</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ETX</span><span class="p">;</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">external</span><span class="p">;</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;external&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reread</span> <span class="o">&amp;</span> <span class="n">TCV_CFG_MDIO0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
					    <span class="n">tconfig</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_PSELECT</span><span class="p">));</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">TCV_PADDR_ITX</span><span class="p">;</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;internal&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Transceiver and a coke please.&quot;</span><span class="p">);</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">=</span> <span class="n">none</span><span class="p">;</span> <span class="cm">/* Grrr... */</span>
				<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;&lt;none&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The receive ring buffers are a bit tricky to get right.  Here goes...</span>
<span class="cm"> *</span>
<span class="cm"> * The buffers we dma into must be 64 byte aligned.  So we use a special</span>
<span class="cm"> * alloc_skb() routine for the happy meal to allocate 64 bytes more than</span>
<span class="cm"> * we really need.</span>
<span class="cm"> *</span>
<span class="cm"> * We use skb_reserve() to align the data block we get in the skb.  We</span>
<span class="cm"> * also program the etxregs-&gt;cfg register to use an offset of 2.  This</span>
<span class="cm"> * imperical constant plus the ethernet header size will always leave</span>
<span class="cm"> * us with a nicely aligned ip header once we pass things up to the</span>
<span class="cm"> * protocol layers.</span>
<span class="cm"> *</span>
<span class="cm"> * The numbers work out to:</span>
<span class="cm"> *</span>
<span class="cm"> *         Max ethernet frame size         1518</span>
<span class="cm"> *         Ethernet header size              14</span>
<span class="cm"> *         Happy Meal base offset             2</span>
<span class="cm"> *</span>
<span class="cm"> * Say a skb data area is at 0xf001b010, and its size alloced is</span>
<span class="cm"> * (ETH_FRAME_LEN + 64 + 2) = (1514 + 64 + 2) = 1580 bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * First our alloc_skb() routine aligns the data base to a 64 byte</span>
<span class="cm"> * boundary.  We now have 0xf001b040 as our skb data address.  We</span>
<span class="cm"> * plug this into the receive descriptor address.</span>
<span class="cm"> *</span>
<span class="cm"> * Next, we skb_reserve() 2 bytes to account for the Happy Meal offset.</span>
<span class="cm"> * So now the data we will end up looking at starts at 0xf001b042.  When</span>
<span class="cm"> * the packet arrives, we will check out the size received and subtract</span>
<span class="cm"> * this from the skb-&gt;length.  Then we just pass the packet up to the</span>
<span class="cm"> * protocols as is, and allocate a new skb to replace this slot we have</span>
<span class="cm"> * just received from.</span>
<span class="cm"> *</span>
<span class="cm"> * The ethernet layer will strip the ether header from the front of the</span>
<span class="cm"> * skb we just sent to it, this leaves us with the ip header sitting</span>
<span class="cm"> * nicely aligned at 0xf001b050.  Also, for tcp and udp packets the</span>
<span class="cm"> * Happy Meal has even checksummed the tcp/udp data for us.  The 16</span>
<span class="cm"> * bit checksum is obtained from the low bits of the receive descriptor</span>
<span class="cm"> * flags, thus:</span>
<span class="cm"> *</span>
<span class="cm"> * 	skb-&gt;csum = rxd-&gt;rx_flags &amp; 0xffff;</span>
<span class="cm"> * 	skb-&gt;ip_summed = CHECKSUM_COMPLETE;</span>
<span class="cm"> *</span>
<span class="cm"> * before sending off the skb to the protocols, and we are good as gold.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_clean_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">happy_meal_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dma_addr</span><span class="p">;</span>

			<span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_rxd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">);</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
					 <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">happy_meal_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>

			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="p">)</span>
					<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
							 <span class="p">(</span><span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">)</span>
							  <span class="o">&amp;</span> <span class="n">TXFLAG_SIZE</span><span class="p">),</span>
							 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
							 <span class="p">(</span><span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">)</span>
							  <span class="o">&amp;</span> <span class="n">TXFLAG_SIZE</span><span class="p">),</span>
							 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hmeal_init_block</span> <span class="o">*</span><span class="n">hb</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init_rings: counters to zero, &quot;</span><span class="p">));</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Free any skippy bufs left around in the rings. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;clean, &quot;</span><span class="p">));</span>
	<span class="n">happy_meal_clean_rings</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="cm">/* Now get new skippy bufs for the receive ring. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;init rxring, &quot;</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">happy_meal_alloc_skb</span><span class="p">(</span><span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hme_write_rxd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">happy_meal_rxd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="cm">/* Because we reserve afterwards. */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="n">RX_OFFSET</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">hme_write_rxd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">happy_meal_rxd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="p">(</span><span class="n">RXFLAG_OWN</span> <span class="o">|</span> <span class="p">((</span><span class="n">RX_BUF_ALLOC_SIZE</span> <span class="o">-</span> <span class="n">RX_OFFSET</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)),</span>
			      <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">,</span>
					     <span class="n">DMA_FROM_DEVICE</span><span class="p">));</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RX_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;init txring, &quot;</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hme_write_txd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_begin_auto_negotiation</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
					      <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* Read all of the registers we are interested in now. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span>      <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span>      <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_physid1</span>   <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_physid2</span>   <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>

	<span class="cm">/* XXX Check BMSR_ANEGCAPABLE, should not be necessary though. */</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Advertise everything we can support. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_10HALF</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_10HALF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">)</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_10FULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_10FULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_100HALF</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_100HALF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">)</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_100FULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_100FULL</span><span class="p">);</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span><span class="p">);</span>

		<span class="cm">/* XXX Currently no Happy Meal cards I know off support 100BaseT4,</span>
<span class="cm">		 * XXX and this is because the DP83840 does not support it, changes</span>
<span class="cm">		 * XXX would need to be made to the tx/rx logic in the driver as well</span>
<span class="cm">		 * XXX so I completely skip checking for it in the BMSR for now.</span>
<span class="cm">		 */</span>

<span class="cp">#ifdef AUTO_SWITCH_DEBUG</span>
		<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;%s: Advertising [ &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10HALF</span><span class="p">)</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;10H &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10FULL</span><span class="p">)</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;10F &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100HALF</span><span class="p">)</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;100H &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span><span class="p">)</span>
			<span class="n">ASD</span><span class="p">((</span><span class="s">&quot;100F &quot;</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="cm">/* Enable Auto-Negotiation, this is usually on already... */</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span><span class="p">;</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>

		<span class="cm">/* Restart it to make sure it is going. */</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_ANRESTART</span><span class="p">;</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>

		<span class="cm">/* BMCR_ANRESTART self clears when the process has begun. */</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>  <span class="cm">/* More than enough. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANRESTART</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* got it. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal would not start auto negotiation &quot;</span>
			       <span class="s">&quot;BMCR=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Performing force link detection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">force_link</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">arbwait</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">force_link:</span>
		<span class="cm">/* Force the link up, trying first a particular mode.</span>
<span class="cm">		 * Either we are here at the request of ethtool or</span>
<span class="cm">		 * because the Happy Meal would not start to autoneg.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Disable auto-negotiation in BMCR, enable the duplex and</span>
<span class="cm">		 * speed setting, init the timer state machine, and fire it off.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_lucent_phy</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* OK, seems we need do disable the transceiver for the first</span>
<span class="cm">			 * tick to make sure we get an accurate link state at the</span>
<span class="cm">			 * second tick.</span>
<span class="cm">			 */</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span>
							       <span class="n">DP83840_CSCONFIG</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSCONFIG_TCVDISAB</span><span class="p">);</span>
			<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">DP83840_CSCONFIG</span><span class="p">,</span>
					      <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_csconfig</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">ltrywait</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>  <span class="cm">/* 1.2 sec. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hp</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">happy_meal_timer</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gregs</span>        <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">etxregs</span>      <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">erxregs</span>      <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bregs</span>        <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span>        <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regtmp</span><span class="p">,</span> <span class="n">rxcfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* If auto-negotiation timer is running, kill it. */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: happy_flags[%08x] &quot;</span><span class="p">,</span>
	     <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;set HFLAG_INIT, &quot;</span><span class="p">));</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">|=</span> <span class="n">HFLAG_INIT</span><span class="p">;</span>
		<span class="n">happy_meal_get_counters</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Stop polling. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;to happy_meal_poll_stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">happy_meal_poll_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>

	<span class="cm">/* Stop transmitter and receiver. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: to happy_meal_stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">happy_meal_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span><span class="p">);</span>

	<span class="cm">/* Alloc and reset the tx/rx descriptor chains. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: to happy_meal_init_rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">happy_meal_init_rings</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="cm">/* Shut up the MIF. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: Disable all MIF irqs (old[%08x]), &quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_IMASK</span><span class="p">)));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_IMASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* See if we can enable the MIF frame on this card to speak to the DP83840. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_FENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;use frame old[%08x], &quot;</span><span class="p">,</span>
		     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_BENABLE</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;use bitbang old[%08x], &quot;</span><span class="p">,</span>
		     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">TCV_CFG_BENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check the state of the transceiver. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;to happy_meal_transceiver_check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">happy_meal_transceiver_check</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>

	<span class="cm">/* Put the Big Mac into a sane state. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: &quot;</span><span class="p">));</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">none</span>:
		<span class="cm">/* Cannot operate if we don&#39;t know the transceiver type! */</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;AAIEEE no transceiver type, EAGAIN&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">internal</span>:
		<span class="cm">/* Using the MII buffers. */</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;internal, using MII, &quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_XIFCFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">external</span>:
		<span class="cm">/* Not using the MII, disable it. */</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;external, disable MII, &quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_XIFCFG</span><span class="p">,</span> <span class="n">BIGMAC_XCFG_MIIDISAB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">happy_meal_tcvr_reset</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* Reset the Happy Meal Big Mac transceiver and the receiver. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;tx/rx reset, &quot;</span><span class="p">));</span>
	<span class="n">happy_meal_tx_reset</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span><span class="p">);</span>
	<span class="n">happy_meal_rx_reset</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span><span class="p">);</span>

	<span class="cm">/* Set jam size and inter-packet gaps to reasonable defaults. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;jsize/ipg1/ipg2, &quot;</span><span class="p">));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_JSIZE</span><span class="p">,</span> <span class="n">DEFAULT_JAMSIZE</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_IGAP1</span><span class="p">,</span> <span class="n">DEFAULT_IPG1</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_IGAP2</span><span class="p">,</span> <span class="n">DEFAULT_IPG2</span><span class="p">);</span>

	<span class="cm">/* Load up the MAC address and random seed. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;rseed/macaddr, &quot;</span><span class="p">));</span>

	<span class="cm">/* The docs recommend to use the 10LSB of our MAC here. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RSEED</span><span class="p">,</span> <span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x3ff</span><span class="p">));</span>

	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_MACADDR2</span><span class="p">,</span> <span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_MACADDR1</span><span class="p">,</span> <span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_MACADDR0</span><span class="p">,</span> <span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;htable, &quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE1</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE2</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE3</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">hash_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hash_table</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">26</span><span class="p">;</span>
			<span class="n">hash_table</span><span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE0</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE1</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE2</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE3</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the RX and TX ring ptrs. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;ring ptrs rxr[%08x] txr[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span> <span class="o">+</span> <span class="n">hblock_offset</span><span class="p">(</span><span class="n">happy_meal_rxd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
	     <span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span> <span class="o">+</span> <span class="n">hblock_offset</span><span class="p">(</span><span class="n">happy_meal_txd</span><span class="p">,</span> <span class="mi">0</span><span class="p">))));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_RING</span><span class="p">,</span>
		    <span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span> <span class="o">+</span> <span class="n">hblock_offset</span><span class="p">(</span><span class="n">happy_meal_rxd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_RING</span><span class="p">,</span>
		    <span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span> <span class="o">+</span> <span class="n">hblock_offset</span><span class="p">(</span><span class="n">happy_meal_txd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>

	<span class="cm">/* Parity issues in the ERX unit of some HME revisions can cause some</span>
<span class="cm">	 * registers to not be written unless their parity is even.  Detect such</span>
<span class="cm">	 * lost writes and simply rewrite with a low bit set (which will be ignored</span>
<span class="cm">	 * since the rxring needs to be 2K aligned).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_RING</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span> <span class="o">+</span> <span class="n">hblock_offset</span><span class="p">(</span><span class="n">happy_meal_rxd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_RING</span><span class="p">,</span>
			    <span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span> <span class="o">+</span> <span class="n">hblock_offset</span><span class="p">(</span><span class="n">happy_meal_rxd</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			    <span class="o">|</span> <span class="mh">0x4</span><span class="p">);</span>

	<span class="cm">/* Set the supported burst sizes. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: old[%08x] bursts&lt;&quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">)));</span>

<span class="cp">#ifndef CONFIG_SPARC</span>
	<span class="cm">/* It is always PCI and can handle 64byte bursts. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">,</span> <span class="n">GREG_CFG_BURST64</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST64</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_PCI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
	     <span class="o">||</span> <span class="n">sbus_can_burst64</span><span class="p">()</span>
<span class="cp">#endif</span>
	     <span class="o">||</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gcfg</span> <span class="o">=</span> <span class="n">GREG_CFG_BURST64</span><span class="p">;</span>

		<span class="cm">/* I have no idea if I should set the extended</span>
<span class="cm">		 * transfer mode bit for Cheerio, so for now I</span>
<span class="cm">		 * do not.  -DaveM</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_PCI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_dev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbus_can_dma_64bit</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">sbus_set_sbus64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_bursts</span><span class="p">);</span>
				<span class="n">gcfg</span> <span class="o">|=</span> <span class="n">GREG_CFG_64BIT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;64&gt;&quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">,</span> <span class="n">gcfg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;32&gt;&quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">,</span> <span class="n">GREG_CFG_BURST32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;16&gt;&quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">,</span> <span class="n">GREG_CFG_BURST16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;XXX&gt;&quot;</span><span class="p">));</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SPARC */</span><span class="cp"></span>

	<span class="cm">/* Turn off interrupts we do not want to hear. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;, enable global interrupts, &quot;</span><span class="p">));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_IMASK</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">GREG_IMASK_GOTFRAME</span> <span class="o">|</span> <span class="n">GREG_IMASK_RCNTEXP</span> <span class="o">|</span>
		     <span class="n">GREG_IMASK_SENTFRAME</span> <span class="o">|</span> <span class="n">GREG_IMASK_TXPERR</span><span class="p">));</span>

	<span class="cm">/* Set the transmit ring buffer size. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;tx rsize=%d oreg[%08x], &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">TX_RING_SIZE</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_RSIZE</span><span class="p">)));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_RSIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">TX_RING_SIZE</span> <span class="o">&gt;&gt;</span> <span class="n">ETX_RSIZE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable transmitter DVMA. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;tx dma enable old[%08x], &quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_CFG</span><span class="p">)));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_CFG</span><span class="p">,</span>
		    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">ETX_CFG_DMAENABLE</span><span class="p">);</span>

	<span class="cm">/* This chip really rots, for the receiver sometimes when you</span>
<span class="cm">	 * write to its control registers not all the bits get there</span>
<span class="cm">	 * properly.  I cannot think of a sane way to provide complete</span>
<span class="cm">	 * coverage for this hardware bug yet.</span>
<span class="cm">	 */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;erx regs bug old[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_CFG</span><span class="p">)));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_CFG</span><span class="p">,</span> <span class="n">ERX_CFG_DEFAULT</span><span class="p">(</span><span class="n">RX_OFFSET</span><span class="p">));</span>
	<span class="n">regtmp</span> <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_CFG</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_CFG</span><span class="p">,</span> <span class="n">ERX_CFG_DEFAULT</span><span class="p">(</span><span class="n">RX_OFFSET</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">erxregs</span> <span class="o">+</span> <span class="n">ERX_CFG</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ERX_CFG_DEFAULT</span><span class="p">(</span><span class="n">RX_OFFSET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Eieee, rx config register gets greasy fries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy meal: Trying to set %08x, reread gives %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ERX_CFG_DEFAULT</span><span class="p">(</span><span class="n">RX_OFFSET</span><span class="p">),</span> <span class="n">regtmp</span><span class="p">);</span>
		<span class="cm">/* XXX Should return failure here... */</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Big Mac hash table filter. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_init: enable hash rx_cfg_old[%08x], &quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">)));</span>
	<span class="n">rxcfg</span> <span class="o">=</span> <span class="n">BIGMAC_RXCFG_HENABLE</span> <span class="o">|</span> <span class="n">BIGMAC_RXCFG_REJME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">BIGMAC_RXCFG_PMISC</span><span class="p">;</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">,</span> <span class="n">rxcfg</span><span class="p">);</span>

	<span class="cm">/* Let the bits settle in the chip. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Ok, configure the Big Mac transmitter. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;BIGMAC init, &quot;</span><span class="p">));</span>
	<span class="n">regtmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_FULL</span><span class="p">)</span>
		<span class="n">regtmp</span> <span class="o">|=</span> <span class="n">BIGMAC_TXCFG_FULLDPLX</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t turn on the &quot;don&#39;t give up&quot; bit for now.  It could cause hme</span>
<span class="cm">	 * to deadlock with the PHY if a Jabber occurs.</span>
<span class="cm">	 */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">,</span> <span class="n">regtmp</span> <span class="cm">/*| BIGMAC_TXCFG_DGIVEUP*/</span><span class="p">);</span>

	<span class="cm">/* Give up after 16 TX attempts. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_ALIMIT</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Enable the output drivers no matter what. */</span>
	<span class="n">regtmp</span> <span class="o">=</span> <span class="n">BIGMAC_XCFG_ODENABLE</span><span class="p">;</span>

	<span class="cm">/* If card can do lance mode, enable it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_LANCE</span><span class="p">)</span>
		<span class="n">regtmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DEFAULT_IPG0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIGMAC_XCFG_LANCE</span><span class="p">;</span>

	<span class="cm">/* Disable the MII buffers if using external transceiver. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span> <span class="o">==</span> <span class="n">external</span><span class="p">)</span>
		<span class="n">regtmp</span> <span class="o">|=</span> <span class="n">BIGMAC_XCFG_MIIDISAB</span><span class="p">;</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;XIF config old[%08x], &quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_XIFCFG</span><span class="p">)));</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_XIFCFG</span><span class="p">,</span> <span class="n">regtmp</span><span class="p">);</span>

	<span class="cm">/* Start things up. */</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;tx old[%08x] and rx [%08x] ON!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">),</span>
	     <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">)));</span>

	<span class="cm">/* Set larger TX/RX size to allow for 802.1q */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXMAX</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXMAX</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">,</span>
		    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIGMAC_TXCFG_ENABLE</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">,</span>
		    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIGMAC_RXCFG_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Get the autonegotiation started, and the watch timer ticking. */</span>
	<span class="n">happy_meal_begin_auto_negotiation</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Success. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_set_initial_advertisement</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span>	<span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bregs</span>	<span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gregs</span>	<span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">;</span>

	<span class="n">happy_meal_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">gregs</span><span class="p">);</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_IMASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_FENABLE</span><span class="p">)</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCV_CFG_BENABLE</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span> <span class="o">+</span> <span class="n">TCVR_CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">TCV_CFG_BENABLE</span><span class="p">);</span>
	<span class="n">happy_meal_transceiver_check</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">none</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">internal</span>:
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_XIFCFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">external</span>:
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_XIFCFG</span><span class="p">,</span> <span class="n">BIGMAC_XCFG_MIIDISAB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">happy_meal_tcvr_reset</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Latch PHY registers as of now. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span>      <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>

	<span class="cm">/* Advertise everything we can support. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_10HALF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_10HALF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_10FULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_10FULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_100HALF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_100HALF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_100FULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_100FULL</span><span class="p">);</span>

	<span class="cm">/* Update the PHY advertisement register. */</span>
	<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_advertise</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Once status is latched (by happy_meal_interrupt) it is cleared by</span>
<span class="cm"> * the hardware, so we cannot re-read it and get a correct value.</span>
<span class="cm"> *</span>
<span class="cm"> * hp-&gt;happy_lock must be held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_is_not_so_happy</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Only print messages for non-counter related interrupts. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GREG_STAT_STSTERR</span> <span class="o">|</span> <span class="n">GREG_STAT_TFIFO_UND</span> <span class="o">|</span>
		      <span class="n">GREG_STAT_MAXPKTERR</span> <span class="o">|</span> <span class="n">GREG_STAT_RXERR</span> <span class="o">|</span>
		      <span class="n">GREG_STAT_RXPERR</span> <span class="o">|</span> <span class="n">GREG_STAT_RXTERR</span> <span class="o">|</span> <span class="n">GREG_STAT_EOPERR</span> <span class="o">|</span>
		      <span class="n">GREG_STAT_MIFIRQ</span> <span class="o">|</span> <span class="n">GREG_STAT_TXEACK</span> <span class="o">|</span> <span class="n">GREG_STAT_TXLERR</span> <span class="o">|</span>
		      <span class="n">GREG_STAT_TXPERR</span> <span class="o">|</span> <span class="n">GREG_STAT_TXTERR</span> <span class="o">|</span> <span class="n">GREG_STAT_SLVERR</span> <span class="o">|</span>
		      <span class="n">GREG_STAT_SLVPERR</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error interrupt for happy meal, status = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RFIFOVF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Receive FIFO overflow is harmless and the hardware will take</span>
<span class="cm">		   care of it, just some packets are lost. Who cares. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Happy Meal receive FIFO overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_STSTERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BigMAC SQE link test failed. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal BigMAC SQE test failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TFIFO_UND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Transmit FIFO underrun, again DMA error likely. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal transmitter FIFO underrun, DMA error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_MAXPKTERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Driver error, tried to transmit something larger</span>
<span class="cm">		 * than ethernet max mtu.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal MAX Packet size error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_NORXD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is harmless, it just means the system is</span>
<span class="cm">		 * quite loaded and the incoming packet rate was</span>
<span class="cm">		 * faster than the interrupt handler could keep up</span>
<span class="cm">		 * with.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Happy Meal out of receive &quot;</span>
		       <span class="s">&quot;descriptors, packet dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GREG_STAT_RXERR</span><span class="o">|</span><span class="n">GREG_STAT_RXPERR</span><span class="o">|</span><span class="n">GREG_STAT_RXTERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* All sorts of DMA receive errors. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal rx DMA errors [ &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GenericError &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXPERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ParityError &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXTERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RxTagBotch &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_EOPERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Driver bug, didn&#39;t set EOP bit in tx descriptor given</span>
<span class="cm">		 * to the happy meal.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: EOP not set in happy meal transmit descriptor!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_MIFIRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MIF signalled an interrupt, were we polling it? */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal MIF interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">GREG_STAT_TXEACK</span><span class="o">|</span><span class="n">GREG_STAT_TXLERR</span><span class="o">|</span><span class="n">GREG_STAT_TXPERR</span><span class="o">|</span><span class="n">GREG_STAT_TXTERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* All sorts of transmit DMA errors. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal tx DMA errors [ &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXEACK</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GenericError &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXLERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;LateError &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXPERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ParityErro &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXTERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TagBotch &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GREG_STAT_SLVERR</span><span class="o">|</span><span class="n">GREG_STAT_SLVPERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Bus or parity error when cpu accessed happy meal registers</span>
<span class="cm">		 * or it&#39;s internal FIFO&#39;s.  Should never see this.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Meal register access SBUS slave (%s) error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_SLVPERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;parity&quot;</span> <span class="o">:</span> <span class="s">&quot;generic&quot;</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">happy_meal_init</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_mif_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tregs</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link status change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>

	<span class="cm">/* Use the fastest transmission protocol possible. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Switching to 100Mbps at full duplex.&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_FULLDPLX</span> <span class="o">|</span> <span class="n">BMCR_SPEED100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Switching to 100MBps at half duplex.&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_10FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Switching to 10MBps at full duplex.&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Using 10Mbps at half duplex.&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">happy_meal_tcvr_write</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span><span class="p">);</span>

	<span class="cm">/* Finally stop polling and shut up the MIF. */</span>
	<span class="n">happy_meal_poll_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef TXDEBUG</span>
<span class="cp">#define TXD(x) printk x</span>
<span class="cp">#else</span>
<span class="cp">#define TXD(x)</span>
<span class="cp">#endif</span>

<span class="cm">/* hp-&gt;happy_lock must be held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal_txd</span> <span class="o">*</span><span class="n">txbase</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">happy_meal_txd</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">elem</span><span class="p">;</span>

	<span class="n">elem</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>
	<span class="n">TXD</span><span class="p">((</span><span class="s">&quot;TX&lt;&quot;</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">elem</span> <span class="o">!=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>

		<span class="n">TXD</span><span class="p">((</span><span class="s">&quot;[%d]&quot;</span><span class="p">,</span> <span class="n">elem</span><span class="p">));</span>
		<span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txbase</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TXFLAG_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">last</span><span class="p">;</span>

			<span class="n">last</span> <span class="o">=</span> <span class="n">elem</span> <span class="o">+</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
			<span class="n">last</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txbase</span><span class="p">[</span><span class="n">last</span><span class="p">].</span><span class="n">tx_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TXFLAG_OWN</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">);</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">);</span>

			<span class="n">dma_len</span> <span class="o">&amp;=</span> <span class="n">TXFLAG_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

			<span class="n">elem</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
			<span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txbase</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
	<span class="n">TXD</span><span class="p">((</span><span class="s">&quot;&gt;&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">hp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef RXDEBUG</span>
<span class="cp">#define RXD(x) printk x</span>
<span class="cp">#else</span>
<span class="cp">#define RXD(x)</span>
<span class="cp">#endif</span>

<span class="cm">/* Originally I used to handle the allocation failure by just giving back just</span>
<span class="cm"> * that one ring buffer to the happy meal.  Problem is that usually when that</span>
<span class="cm"> * condition is triggered, the happy meal expects you to do something reasonable</span>
<span class="cm"> * with all of the packets it has DMA&#39;d in.  So now I just drop the entire</span>
<span class="cm"> * ring when we cannot get a new skb and give them all back to the happy meal,</span>
<span class="cm"> * maybe things will be &quot;happier&quot; now.</span>
<span class="cm"> *</span>
<span class="cm"> * hp-&gt;happy_lock must be held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal_rxd</span> <span class="o">*</span><span class="n">rxbase</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_rxd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">happy_meal_rxd</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">,</span> <span class="n">drops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">RXD</span><span class="p">((</span><span class="s">&quot;RX&lt;&quot;</span><span class="p">));</span>
	<span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxbase</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">flags</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">rx_flags</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RXFLAG_OWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">csum</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXFLAG_CSUM</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">hme_read_desc32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">rx_addr</span><span class="p">);</span>

		<span class="n">RXD</span><span class="p">((</span><span class="s">&quot;[%d &quot;</span><span class="p">,</span> <span class="n">elem</span><span class="p">));</span>

		<span class="cm">/* Check for errors. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXFLAG_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RXD</span><span class="p">((</span><span class="s">&quot;ERR(%08x)]&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">));</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXFLAG_OVERFLOW</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Return it to the Happy meal. */</span>
	<span class="nl">drop_it:</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hme_write_rxd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">RXFLAG_OWN</span><span class="o">|</span><span class="p">((</span><span class="n">RX_BUF_ALLOC_SIZE</span><span class="o">-</span><span class="n">RX_OFFSET</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)),</span>
				      <span class="n">dma_addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RX_COPY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>

			<span class="cm">/* Now refill the entry, if we can. */</span>
			<span class="n">new_skb</span> <span class="o">=</span> <span class="n">happy_meal_alloc_skb</span><span class="p">(</span><span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drops</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
			<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="p">(</span><span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="n">RX_OFFSET</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
			<span class="n">hme_write_rxd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">RXFLAG_OWN</span><span class="o">|</span><span class="p">((</span><span class="n">RX_BUF_ALLOC_SIZE</span><span class="o">-</span><span class="n">RX_OFFSET</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)),</span>
				      <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">,</span>
						     <span class="n">DMA_FROM_DEVICE</span><span class="p">));</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">RX_OFFSET</span><span class="p">);</span>

			<span class="cm">/* Trim the original skb for the netif. */</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">copy_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drops</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">copy_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="cm">/* Reuse original ring buffer. */</span>
			<span class="n">hme_write_rxd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">RXFLAG_OWN</span><span class="o">|</span><span class="p">((</span><span class="n">RX_BUF_ALLOC_SIZE</span><span class="o">-</span><span class="n">RX_OFFSET</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)),</span>
				      <span class="n">dma_addr</span><span class="p">);</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">copy_skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This card is _fucking_ hot... */</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_unfold</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">__force</span> <span class="n">__sum16</span><span class="p">)</span><span class="n">htons</span><span class="p">(</span><span class="n">csum</span><span class="p">));</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>

		<span class="n">RXD</span><span class="p">((</span><span class="s">&quot;len=%d csum=%4x]&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">csum</span><span class="p">));</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="nl">next:</span>
		<span class="n">elem</span> <span class="o">=</span> <span class="n">NEXT_RX</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
		<span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxbase</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drops</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Memory squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">RXD</span><span class="p">((</span><span class="s">&quot;&gt;&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">happy_meal_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">happy_status</span>       <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_STAT</span><span class="p">);</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_interrupt: status=%08x &quot;</span><span class="p">,</span> <span class="n">happy_status</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_ERRORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;ERRORS &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">happy_meal_is_not_so_happy</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="cm">/* un- */</span> <span class="n">happy_status</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_MIFIRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;MIFIRQ &quot;</span><span class="p">));</span>
		<span class="n">happy_meal_mif_interrupt</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;TXALL &quot;</span><span class="p">));</span>
		<span class="n">happy_meal_tx</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXTOHOST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;RXTOHOST &quot;</span><span class="p">));</span>
		<span class="n">happy_meal_rx</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">quattro_sbus_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="p">)</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">happy_status</span>       <span class="o">=</span> <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_STAT</span><span class="p">);</span>

		<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;quattro_interrupt: status=%08x &quot;</span><span class="p">,</span> <span class="n">happy_status</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GREG_STAT_ERRORS</span> <span class="o">|</span>
				      <span class="n">GREG_STAT_MIFIRQ</span> <span class="o">|</span>
				      <span class="n">GREG_STAT_TXALL</span> <span class="o">|</span>
				      <span class="n">GREG_STAT_RXTOHOST</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_ERRORS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;ERRORS &quot;</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">happy_meal_is_not_so_happy</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">happy_status</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_MIFIRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;MIFIRQ &quot;</span><span class="p">));</span>
			<span class="n">happy_meal_mif_interrupt</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;TXALL &quot;</span><span class="p">));</span>
			<span class="n">happy_meal_tx</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">happy_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXTOHOST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;RXTOHOST &quot;</span><span class="p">));</span>
			<span class="n">happy_meal_rx</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="nl">next:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;happy_meal_open: &quot;</span><span class="p">));</span>

	<span class="cm">/* On SBUS Quattro QFE cards, all hme interrupts are concentrated</span>
<span class="cm">	 * into a single source which we register handling at probe time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFLAG_QUATTRO</span><span class="o">|</span><span class="n">HFLAG_PCI</span><span class="p">))</span> <span class="o">!=</span> <span class="n">HFLAG_QUATTRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">happy_meal_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happy_meal(SBUS): Can&#39;t order irq %d to go.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">HMD</span><span class="p">((</span><span class="s">&quot;to happy_meal_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">happy_meal_init</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFLAG_QUATTRO</span><span class="o">|</span><span class="n">HFLAG_PCI</span><span class="p">))</span> <span class="o">!=</span> <span class="n">HFLAG_QUATTRO</span><span class="p">))</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">happy_meal_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">happy_meal_stop</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">);</span>
	<span class="n">happy_meal_clean_rings</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="cm">/* If auto-negotiation timer is running, kill it. */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="cm">/* On Quattro QFE cards, all hme interrupts are concentrated</span>
<span class="cm">	 * into a single source which we register handling at probe</span>
<span class="cm">	 * time and never unregister.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFLAG_QUATTRO</span><span class="o">|</span><span class="n">HFLAG_PCI</span><span class="p">))</span> <span class="o">!=</span> <span class="n">HFLAG_QUATTRO</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SXDEBUG</span>
<span class="cp">#define SXD(x) printk x</span>
<span class="cp">#else</span>
<span class="cp">#define SXD(x)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tx_dump_log</span><span class="p">();</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Happy Status %08x TX[%08x:%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span> <span class="o">+</span> <span class="n">GREG_STAT</span><span class="p">),</span>
		<span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_CFG</span><span class="p">),</span>
		<span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">+</span> <span class="n">BMAC_TXCFG</span><span class="p">));</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">happy_meal_init</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">happy_meal_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
 	<span class="n">u32</span> <span class="n">tx_flags</span><span class="p">;</span>

	<span class="n">tx_flags</span> <span class="o">=</span> <span class="n">TXFLAG_OWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">csum_start_off</span> <span class="o">=</span> <span class="n">skb_checksum_start_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">csum_stuff_off</span> <span class="o">=</span> <span class="n">csum_start_off</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>

		<span class="n">tx_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">TXFLAG_OWN</span> <span class="o">|</span> <span class="n">TXFLAG_CSENABLE</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">csum_start_off</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXFLAG_CSBUFBEGIN</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">csum_stuff_off</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXFLAG_CSLOCATION</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">hp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: BUG! Tx Ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>
	<span class="n">SXD</span><span class="p">((</span><span class="s">&quot;SX&lt;l[%d]e[%d]&gt;&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">));</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TXFLAG_SOP</span> <span class="o">|</span> <span class="n">TXFLAG_EOP</span><span class="p">);</span>
		<span class="n">hme_write_txd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
			      <span class="p">(</span><span class="n">tx_flags</span> <span class="o">|</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">TXFLAG_SIZE</span><span class="p">)),</span>
			      <span class="n">mapping</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">first_len</span><span class="p">,</span> <span class="n">first_mapping</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">first_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

		<span class="cm">/* We must give this initial chunk to the device last.</span>
<span class="cm">		 * Otherwise we could race with the device.</span>
<span class="cm">		 */</span>
		<span class="n">first_len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">first_mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">first_len</span><span class="p">,</span>
					       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">this_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">frag</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">this_txflags</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">this_frag</span><span class="p">);</span>
			<span class="n">mapping</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">this_frag</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">this_txflags</span> <span class="o">=</span> <span class="n">tx_flags</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">this_txflags</span> <span class="o">|=</span> <span class="n">TXFLAG_EOP</span><span class="p">;</span>
			<span class="n">hme_write_txd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
				      <span class="p">(</span><span class="n">this_txflags</span> <span class="o">|</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">TXFLAG_SIZE</span><span class="p">)),</span>
				      <span class="n">mapping</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hme_write_txd</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="o">-&gt;</span><span class="n">happy_meal_txd</span><span class="p">[</span><span class="n">first_entry</span><span class="p">],</span>
			      <span class="p">(</span><span class="n">tx_flags</span> <span class="o">|</span> <span class="n">TXFLAG_SOP</span> <span class="o">|</span> <span class="p">(</span><span class="n">first_len</span> <span class="o">&amp;</span> <span class="n">TXFLAG_SIZE</span><span class="p">)),</span>
			      <span class="n">first_mapping</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">hp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Get it going. */</span>
	<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span> <span class="o">+</span> <span class="n">ETX_PENDING</span><span class="p">,</span> <span class="n">ETX_TP_DMAWAKEUP</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="n">tx_add_log</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">TXLOG_ACTION_TXMIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">happy_meal_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">happy_meal_get_counters</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bregs</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE1</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE2</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE3</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">,</span>
			    <span class="n">hme_read32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_RXCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIGMAC_RXCFG_PMISC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">hash_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hash_table</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">26</span><span class="p">;</span>
			<span class="n">hash_table</span><span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE0</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE1</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE2</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">hme_write32</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">bregs</span> <span class="o">+</span> <span class="n">BMAC_HTABLE3</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Ethtool support... */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hme_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
		 <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
		 <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_MII</span><span class="p">);</span>

	<span class="cm">/* XXX hardcoded stuff for now */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span> <span class="cm">/* XXX no MII support */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span> <span class="cm">/* XXX no external xcvr support */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XXX fixed PHYAD */</span>

	<span class="cm">/* Record PHY settings. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">((</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_100HALF</span> <span class="o">|</span> <span class="n">LPA_100FULL</span><span class="p">))</span> <span class="o">?</span>
			 <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_100FULL</span><span class="p">))</span> <span class="o">?</span>
				<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_10FULL</span><span class="p">))</span> <span class="o">?</span>
				<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span> <span class="o">?</span> <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hme_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Verify the settings we care about. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
	      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Ok, do it to it. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>
	<span class="n">happy_meal_begin_auto_negotiation</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hme_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;sunhme&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;2.02&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">&amp;</span> <span class="n">HFLAG_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_dev</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom_registers</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_dev</span><span class="p">;</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;regs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span>
				<span class="s">&quot;SBUS:%d&quot;</span><span class="p">,</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">which_io</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hme_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmcr</span> <span class="o">=</span> <span class="n">happy_meal_tcvr_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">sw_bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">hme_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">hme_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">hme_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">hme_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">hme_get_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hme_version_printed</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="cm">/* Given a happy meal sbus device, find it&#39;s quattro parent.</span>
<span class="cm"> * If none exist, allocate and return a new one.</span>
<span class="cm"> *</span>
<span class="cm"> * Return NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">quattro_sbus_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">qp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qp</span><span class="p">;</span>

	<span class="n">qp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">quattro</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">quattro_dev</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">qfe_sbus_list</span><span class="p">;</span>
		<span class="n">qfe_sbus_list</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>

		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* After all quattro cards have been probed, we call these functions</span>
<span class="cm"> * to register the IRQ handlers for the cards that have been</span>
<span class="cm"> * successfully probed and skip the cards that failed to initialize</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">quattro_sbus_register_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qfe_sbus_list</span><span class="p">;</span> <span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">quattro_dev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">qfe_slot</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qfe_slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">qfe_slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">])</span>
				<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">quattro_sbus_interrupt</span><span class="p">,</span>
				  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Quattro&quot;</span><span class="p">,</span>
				  <span class="n">qp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Quattro HME: IRQ registration &quot;</span>
			       <span class="s">&quot;error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">quattro_sbus_free_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qfe_sbus_list</span><span class="p">;</span> <span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">quattro_dev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">qfe_slot</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qfe_slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">qfe_slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">])</span>
				<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SBUS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">quattro_pci_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qfe_pci_list</span><span class="p">;</span> <span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">qpdev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">quattro_dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qpdev</span> <span class="o">==</span> <span class="n">bdev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">quattro</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">quattro_dev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">qfe_pci_list</span><span class="p">;</span>
		<span class="n">qfe_pci_list</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>

		<span class="cm">/* No range tricks necessary on PCI. */</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">nranges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">hme_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">happy_meal_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">happy_meal_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">happy_meal_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">happy_meal_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">happy_meal_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">happy_meal_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">happy_meal_sbus_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_qfe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="o">*</span><span class="n">sbus_dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">qfe_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sbus_dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>

	<span class="cm">/* We can match PCI devices too, do not accept those here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sbus_dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sbus&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">sbus_dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sbi&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qfe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qp</span> <span class="o">=</span> <span class="n">quattro_sbus_find</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qfe_slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">qfe_slot</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hme_version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="cm">/* If user did not specify a MAC address specifically, use</span>
<span class="cm">	 * the Quattro local-mac-address property...</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* a mac address was given */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">macaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_dev</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">qfe_parent</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">qfe_ent</span> <span class="o">=</span> <span class="n">qfe_slot</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">GREG_REG_SIZE</span><span class="p">,</span> <span class="s">&quot;HME Global Regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot map global registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">ETX_REG_SIZE</span><span class="p">,</span> <span class="s">&quot;HME TX Regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot map MAC TX registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">ERX_REG_SIZE</span><span class="p">,</span> <span class="s">&quot;HME RX Regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot map MAC RX registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">BMAC_REG_SIZE</span><span class="p">,</span> <span class="s">&quot;HME BIGMAC Regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot map BIGMAC registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">TCVR_REG_SIZE</span><span class="p">,</span> <span class="s">&quot;HME Tranceiver Regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot map TCVR registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;hm-rev&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>

	<span class="cm">/* Now enable the feature flags we can. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">==</span> <span class="mh">0x21</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">=</span> <span class="n">HFLAG_20_21</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">!=</span> <span class="mh">0xa0</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">=</span> <span class="n">HFLAG_NOT_A0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">|=</span> <span class="n">HFLAG_QUATTRO</span><span class="p">;</span>

	<span class="cm">/* Get the supported DVMA burst sizes from our Happy SBUS. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_bursts</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">sbus_dp</span><span class="p">,</span>
						 <span class="s">&quot;burst-sizes&quot;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span>
					     <span class="n">PAGE_SIZE</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span><span class="p">,</span>
					     <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot allocate descriptors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Force check of the link first time we are brought up. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">linkcheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Force timer state to &#39;asleep&#39; with count of zero. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">asleep</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hme_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hme_ethtool_ops</span><span class="p">;</span>

	<span class="cm">/* Happy Meal can do it all... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_CSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="cp">#if defined(CONFIG_SBUS) &amp;&amp; defined(CONFIG_PCI)</span>
	<span class="cm">/* Hook up SBUS register/descriptor accessors. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">read_desc32</span> <span class="o">=</span> <span class="n">sbus_hme_read_desc32</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">write_txd</span> <span class="o">=</span> <span class="n">sbus_hme_write_txd</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">write_rxd</span> <span class="o">=</span> <span class="n">sbus_hme_write_rxd</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">read32</span> <span class="o">=</span> <span class="n">sbus_hme_read32</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">sbus_hme_write32</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Grrr, Happy Meal comes up by default not advertising</span>
<span class="cm">	 * full duplex 100baseT capabilities, fix this.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">happy_meal_set_initial_advertisement</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal: Cannot register net device, &quot;</span>
		       <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_coherent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Quattro HME slot %d (SBUS) 10/100baseT Ethernet &quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">qfe_slot</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: HAPPY MEAL (SBUS) 10/100baseT Ethernet &quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_coherent:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span>
			  <span class="n">PAGE_SIZE</span><span class="p">,</span>
			  <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">,</span>
			  <span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span><span class="p">);</span>

<span class="nl">err_out_iounmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">GREG_REG_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span><span class="p">,</span> <span class="n">ETX_REG_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span><span class="p">,</span> <span class="n">ERX_REG_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">,</span> <span class="n">BMAC_REG_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">,</span> <span class="n">TCVR_REG_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="p">)</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#ifndef CONFIG_SPARC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_quattro_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">busdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">this_pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_hmes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">busdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">busdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_DEC</span> <span class="o">||</span>
	    <span class="n">busdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_DEC_21153</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">n_hmes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">this_pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">this_pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_HAPPYMEAL</span><span class="p">)</span>
			<span class="n">n_hmes</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_hmes</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fetch MAC address from vital product data of PCI ROM. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_eth_addr_in_vpd</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">this_offset</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">this_offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">this_offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">rom_base</span> <span class="o">+</span> <span class="n">this_offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x90</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x09</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4e</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x41</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x06</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">this_offset</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_hme_mac_nonsparc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_quattro_p</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

		<span class="n">found</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span> <span class="o">&amp;&amp;</span>
			<span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span> <span class="o">&amp;&amp;</span>
			<span class="n">find_eth_addr_in_vpd</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">index</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sun MAC prefix then 3 random bytes. */</span>
	<span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !(CONFIG_SPARC) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">happy_meal_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hpreg_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hpreg_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">qfe_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prom_name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Now make sure pci_dev cookie is there. */</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">prom_name</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_quattro_p</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">prom_name</span><span class="p">,</span> <span class="s">&quot;SUNW,qfe&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">prom_name</span><span class="p">,</span> <span class="s">&quot;SUNW,hme&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">prom_name</span><span class="p">,</span> <span class="s">&quot;SUNW,qfe&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">prom_name</span><span class="p">,</span> <span class="s">&quot;qfe&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qp</span> <span class="o">=</span> <span class="n">quattro_pci_find</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qfe_slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">qfe_slot</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">happy_meal</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hme_version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">qfe_parent</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">qfe_ent</span> <span class="o">=</span> <span class="n">qfe_slot</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpreg_res</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal(PCI): Cannot find proper PCI device base address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_clear_quattro</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal(PCI): Cannot obtain PCI resources, &quot;</span>
		       <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_clear_quattro</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hpreg_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hpreg_res</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal(PCI): Unable to remap card memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* a mac address was given */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">macaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
			<span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">get_hme_mac_nonsparc</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Layout registers. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span>      <span class="o">=</span> <span class="p">(</span><span class="n">hpreg_base</span> <span class="o">+</span> <span class="mh">0x0000UL</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hpreg_base</span> <span class="o">+</span> <span class="mh">0x2000UL</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hpreg_base</span> <span class="o">+</span> <span class="mh">0x4000UL</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span> <span class="o">=</span> <span class="p">(</span><span class="n">hpreg_base</span> <span class="o">+</span> <span class="mh">0x6000UL</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hpreg_base</span> <span class="o">+</span> <span class="mh">0x7000UL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;hm-rev&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">=</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/* works with this on non-sparc hosts */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Now enable the feature flags we can. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">==</span> <span class="mh">0x21</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">=</span> <span class="n">HFLAG_20_21</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">!=</span> <span class="mh">0xa0</span> <span class="o">&amp;&amp;</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">hm_revision</span> <span class="o">!=</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">=</span> <span class="n">HFLAG_NOT_A0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">|=</span> <span class="n">HFLAG_QUATTRO</span><span class="p">;</span>

	<span class="cm">/* And of course, indicate this is PCI. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_flags</span> <span class="o">|=</span> <span class="n">HFLAG_PCI</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="cm">/* Assume PCI happy meals can handle all burst sizes. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_bursts</span> <span class="o">=</span> <span class="n">DMA_BURSTBITS</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hmeal_init_block</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal(PCI): Cannot get hme init block.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">linkcheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_state</span> <span class="o">=</span> <span class="n">asleep</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_timer</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hme_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hme_ethtool_ops</span><span class="p">;</span>

	<span class="cm">/* Happy Meal can do it all... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_CSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SBUS) &amp;&amp; defined(CONFIG_PCI)</span>
	<span class="cm">/* Hook up PCI register/descriptor accessors. */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">read_desc32</span> <span class="o">=</span> <span class="n">pci_hme_read_desc32</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">write_txd</span> <span class="o">=</span> <span class="n">pci_hme_write_txd</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">write_rxd</span> <span class="o">=</span> <span class="n">pci_hme_write_rxd</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">read32</span> <span class="o">=</span> <span class="n">pci_hme_read32</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">pci_hme_write32</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Grrr, Happy Meal comes up by default not advertising</span>
<span class="cm">	 * full duplex 100baseT capabilities, fix this.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>
	<span class="n">happy_meal_set_initial_advertisement</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;happymeal(PCI): Cannot register net device, &quot;</span>
		       <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qfe_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">qpdev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">quattro_dev</span><span class="p">;</span>

		<span class="n">prom_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">prom_name</span><span class="p">,</span> <span class="s">&quot;-%d&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%s: Quattro HME (PCI/CheerIO) 10/100baseT Ethernet &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">prom_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qpdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_DEC</span> <span class="o">&amp;&amp;</span>
		    <span class="n">qpdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_DEC_21153</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DEC 21153 PCI Bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unknown bridge %04x.%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">qpdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">qpdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qfe_slot</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Quattro HME slot %d (PCI/CheerIO) 10/100baseT Ethernet &quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">qfe_slot</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: HAPPY MEAL (PCI/CheerIO) 10/100BaseT Ethernet &quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">);</span>

<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_clear_quattro:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">happy_meals</span><span class="p">[</span><span class="n">qfe_slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">happy_meal_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			  <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_dev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">happymeal_pci_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SUN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SUN_HAPPYMEAL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">happymeal_pci_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hme_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hme&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">happymeal_pci_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">happy_meal_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">happy_meal_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">happy_meal_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hme_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_pci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hme_pci_driver</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qfe_pci_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qfe</span> <span class="o">=</span> <span class="n">qfe_pci_list</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">qfe</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">qfe</span><span class="p">);</span>

		<span class="n">qfe_pci_list</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">hme_sbus_match</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hme_sbus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_qfe</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">hme_sbus_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">is_qfe</span> <span class="o">=</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qfe</span> <span class="o">&amp;&amp;</span> <span class="n">model</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;SUNW,sbus-qfe&quot;</span><span class="p">))</span>
		<span class="n">is_qfe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">happy_meal_sbus_probe_one</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">is_qfe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">hme_sbus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">happy_meal</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="cm">/* XXX qfe parent interrupt... */</span>

	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">GREG_REG_SIZE</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">etxregs</span><span class="p">,</span> <span class="n">ETX_REG_SIZE</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">erxregs</span><span class="p">,</span> <span class="n">ERX_REG_SIZE</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">bigmacregs</span><span class="p">,</span> <span class="n">BMAC_REG_SIZE</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">tcvregs</span><span class="p">,</span> <span class="n">TCVR_REG_SIZE</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span>
			  <span class="n">PAGE_SIZE</span><span class="p">,</span>
			  <span class="n">hp</span><span class="o">-&gt;</span><span class="n">happy_block</span><span class="p">,</span>
			  <span class="n">hp</span><span class="o">-&gt;</span><span class="n">hblock_dvma</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">hme_sbus_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,hme&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,qfe&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qfe&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">hme_sbus_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">hme_sbus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hme&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">hme_sbus_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">hme_sbus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hme_sbus_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">happy_meal_sbus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hme_sbus_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">quattro_sbus_register_irqs</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">happy_meal_sbus_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hme_sbus_driver</span><span class="p">);</span>
	<span class="n">quattro_sbus_free_irqs</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qfe_sbus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">qfe</span> <span class="o">=</span> <span class="n">qfe_sbus_list</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">quattro</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">qfe</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">qfe</span><span class="p">);</span>

		<span class="n">qfe_sbus_list</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">happy_meal_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">happy_meal_sbus_init</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">happy_meal_pci_init</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">happy_meal_sbus_exit</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">happy_meal_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
	<span class="n">happy_meal_sbus_exit</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">happy_meal_pci_exit</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">happy_meal_probe</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">happy_meal_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
