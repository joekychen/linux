<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sun › niu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>niu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* niu.c: Neptune ethernet driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007, 2008 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &quot;niu.h&quot;</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;niu&quot;</span>
<span class="cp">#define DRV_MODULE_VERSION	&quot;1.1&quot;</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;Apr 22, 2010&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
	<span class="n">DRV_MODULE_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David S. Miller (davem@davemloft.net)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NIU ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>

<span class="cp">#ifndef readq</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">readq</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">4UL</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">writeq</span><span class="p">(</span><span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0x4UL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">niu_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SUN</span><span class="p">,</span> <span class="mh">0xabcd</span><span class="p">)},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">niu_pci_tbl</span><span class="p">);</span>

<span class="cp">#define NIU_TX_TIMEOUT			(5 * HZ)</span>

<span class="cp">#define nr64(reg)		readq(np-&gt;regs + (reg))</span>
<span class="cp">#define nw64(reg, val)		writeq((val), np-&gt;regs + (reg))</span>

<span class="cp">#define nr64_mac(reg)		readq(np-&gt;mac_regs + (reg))</span>
<span class="cp">#define nw64_mac(reg, val)	writeq((val), np-&gt;mac_regs + (reg))</span>

<span class="cp">#define nr64_ipp(reg)		readq(np-&gt;regs + np-&gt;ipp_off + (reg))</span>
<span class="cp">#define nw64_ipp(reg, val)	writeq((val), np-&gt;regs + np-&gt;ipp_off + (reg))</span>

<span class="cp">#define nr64_pcs(reg)		readq(np-&gt;regs + np-&gt;pcs_off + (reg))</span>
<span class="cp">#define nw64_pcs(reg, val)	writeq((val), np-&gt;regs + np-&gt;pcs_off + (reg))</span>

<span class="cp">#define nr64_xpcs(reg)		readq(np-&gt;regs + np-&gt;xpcs_off + (reg))</span>
<span class="cp">#define nw64_xpcs(reg, val)	writeq((val), np-&gt;regs + np-&gt;xpcs_off + (reg))</span>

<span class="cp">#define NIU_MSG_DEFAULT (NETIF_MSG_DRV | NETIF_MSG_PROBE | NETIF_MSG_LINK)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">niu_debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;NIU debug level&quot;</span><span class="p">);</span>

<span class="cp">#define niu_lock_parent(np, flags) \</span>
<span class="cp">	spin_lock_irqsave(&amp;np-&gt;parent-&gt;lock, flags)</span>
<span class="cp">#define niu_unlock_parent(np, flags) \</span>
<span class="cp">	spin_unlock_irqrestore(&amp;np-&gt;parent-&gt;lock, flags)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">serdes_init_10g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__niu_wait_bits_clear_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__niu_set_and_wait_clear_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
					<span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reg_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__niu_wait_bits_clear_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bits (%llx) of register %s would not clear, val[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bits</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define niu_set_and_wait_clear_mac(NP, REG, BITS, LIMIT, DELAY, REG_NAME) \</span>
<span class="cp">({	BUILD_BUG_ON(LIMIT &lt;= 0 || DELAY &lt; 0); \</span>
<span class="cp">	__niu_set_and_wait_clear_mac(NP, REG, BITS, LIMIT, DELAY, REG_NAME); \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__niu_wait_bits_clear_ipp</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__niu_set_and_wait_clear_ipp</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
					<span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reg_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__niu_wait_bits_clear_ipp</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bits (%llx) of register %s would not clear, val[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bits</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64_ipp</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define niu_set_and_wait_clear_ipp(NP, REG, BITS, LIMIT, DELAY, REG_NAME) \</span>
<span class="cp">({	BUILD_BUG_ON(LIMIT &lt;= 0 || DELAY &lt; 0); \</span>
<span class="cp">	__niu_set_and_wait_clear_ipp(NP, REG, BITS, LIMIT, DELAY, REG_NAME); \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__niu_wait_bits_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define niu_wait_bits_clear(NP, REG, BITS, LIMIT, DELAY) \</span>
<span class="cp">({	BUILD_BUG_ON(LIMIT &lt;= 0 || DELAY &lt; 0); \</span>
<span class="cp">	__niu_wait_bits_clear(NP, REG, BITS, LIMIT, DELAY); \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__niu_set_and_wait_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
				    <span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reg_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__niu_wait_bits_clear</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bits (%llx) of register %s would not clear, val[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bits</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define niu_set_and_wait_clear(NP, REG, BITS, LIMIT, DELAY, REG_NAME) \</span>
<span class="cp">({	BUILD_BUG_ON(LIMIT &lt;= 0 || DELAY &lt; 0); \</span>
<span class="cp">	__niu_set_and_wait_clear(NP, REG, BITS, LIMIT, DELAY, REG_NAME); \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_ldg_rearm</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LDG_IMGMT_ARM</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">LDG_IMGMT</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ldg_num</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_ldn_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ldn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask_reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ldn</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ldn</span> <span class="o">&gt;</span> <span class="n">LDN_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ldn</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask_reg</span> <span class="o">=</span> <span class="n">LD_IM0</span><span class="p">(</span><span class="n">ldn</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">LD_IM0_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask_reg</span> <span class="o">=</span> <span class="n">LD_IM1</span><span class="p">(</span><span class="n">ldn</span> <span class="o">-</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">LD_IM1_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">mask_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">mask_reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_enable_ldn_in_ldg</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LDN_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ldg_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ldg_num</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ldn_irq_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_ldn_in_ldg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">niu_ldg_rearm</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">on</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">phy_encode</span><span class="p">(</span><span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">port</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">phy_decode</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">port</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PORT_TYPE_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">MIF_FRAME_OUTPUT_TA_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_OUTPUT_DATA</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">,</span> <span class="n">MDIO_ADDR_OP</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_wait</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">,</span> <span class="n">MDIO_READ_OP</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">mdio_wait</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">,</span> <span class="n">MDIO_ADDR_OP</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_wait</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">,</span> <span class="n">MDIO_WRITE_OP</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_wait</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">,</span> <span class="n">MII_READ_OP</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">mdio_wait</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_FRAME_OUTPUT</span><span class="p">,</span> <span class="n">MII_WRITE_OP</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_wait</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr2_set_tx_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR2_TI_PLL_TX_CFG_L</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
			 <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
				 <span class="n">ESR2_TI_PLL_TX_CFG_H</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
				 <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr2_set_rx_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR2_TI_PLL_RX_CFG_L</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
			 <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
				 <span class="n">ESR2_TI_PLL_RX_CFG_H</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
				 <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Mode is always 10G fiber.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_niu_10g_fiber</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_cfg</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tx_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_TX_CFG_ENTX</span> <span class="o">|</span> <span class="n">PLL_TX_CFG_SWING_1375MV</span><span class="p">);</span>
	<span class="n">rx_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_RX_CFG_ENRX</span> <span class="o">|</span> <span class="n">PLL_RX_CFG_TERM_0P8VDDT</span> <span class="o">|</span>
		  <span class="n">PLL_RX_CFG_ALIGN_ENA</span> <span class="o">|</span> <span class="n">PLL_RX_CFG_LOS_LTHRESH</span> <span class="o">|</span>
		  <span class="n">PLL_RX_CFG_EQ_LP_ADAPTIVE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">test_cfg</span> <span class="o">=</span> <span class="n">PLL_TEST_CFG_LOOPBACK_CML_DIS</span><span class="p">;</span>

		<span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			   <span class="n">ESR2_TI_PLL_TEST_CFG_L</span><span class="p">,</span> <span class="n">test_cfg</span><span class="p">);</span>

		<span class="n">tx_cfg</span> <span class="o">|=</span> <span class="n">PLL_TX_CFG_ENTEST</span><span class="p">;</span>
		<span class="n">rx_cfg</span> <span class="o">|=</span> <span class="n">PLL_RX_CFG_ENTEST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize all 4 lanes of the SERDES.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">esr2_set_tx_cfg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">esr2_set_rx_cfg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_niu_1g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pll_cfg</span><span class="p">,</span> <span class="n">pll_sts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_retry</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_cfg</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tx_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_TX_CFG_ENTX</span> <span class="o">|</span> <span class="n">PLL_TX_CFG_SWING_1375MV</span> <span class="o">|</span>
		  <span class="n">PLL_TX_CFG_RATE_HALF</span><span class="p">);</span>
	<span class="n">rx_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_RX_CFG_ENRX</span> <span class="o">|</span> <span class="n">PLL_RX_CFG_TERM_0P8VDDT</span> <span class="o">|</span>
		  <span class="n">PLL_RX_CFG_ALIGN_ENA</span> <span class="o">|</span> <span class="n">PLL_RX_CFG_LOS_LTHRESH</span> <span class="o">|</span>
		  <span class="n">PLL_RX_CFG_RATE_HALF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rx_cfg</span> <span class="o">|=</span> <span class="n">PLL_RX_CFG_EQ_LP_ADAPTIVE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">test_cfg</span> <span class="o">=</span> <span class="n">PLL_TEST_CFG_LOOPBACK_CML_DIS</span><span class="p">;</span>

		<span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			   <span class="n">ESR2_TI_PLL_TEST_CFG_L</span><span class="p">,</span> <span class="n">test_cfg</span><span class="p">);</span>

		<span class="n">tx_cfg</span> <span class="o">|=</span> <span class="n">PLL_TX_CFG_ENTEST</span><span class="p">;</span>
		<span class="n">rx_cfg</span> <span class="o">|=</span> <span class="n">PLL_RX_CFG_ENTEST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize PLL for 1G */</span>
	<span class="n">pll_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_CFG_ENPLL</span> <span class="o">|</span> <span class="n">PLL_CFG_MPY_8X</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR2_TI_PLL_CFG_L</span><span class="p">,</span> <span class="n">pll_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NIU Port %d %s() mdio write to ESR2_TI_PLL_CFG_L failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pll_sts</span> <span class="o">=</span> <span class="n">PLL_CFG_ENPLL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR2_TI_PLL_STS_L</span><span class="p">,</span> <span class="n">pll_sts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NIU Port %d %s() mdio write to ESR2_TI_PLL_STS_L failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* Initialize all 4 lanes of the SERDES.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr2_set_tx_cfg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr2_set_rx_cfg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P0</span> <span class="o">|</span> <span class="n">ESR_INT_DET0_P0</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P1</span> <span class="o">|</span> <span class="n">ESR_INT_DET0_P1</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">max_retry</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESR_INT_SIGNALS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u signal bits [%08x] are not [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_niu_10g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_cfg</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">,</span> <span class="n">pll_cfg</span><span class="p">,</span> <span class="n">pll_sts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_retry</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tx_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_TX_CFG_ENTX</span> <span class="o">|</span> <span class="n">PLL_TX_CFG_SWING_1375MV</span><span class="p">);</span>
	<span class="n">rx_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_RX_CFG_ENRX</span> <span class="o">|</span> <span class="n">PLL_RX_CFG_TERM_0P8VDDT</span> <span class="o">|</span>
		  <span class="n">PLL_RX_CFG_ALIGN_ENA</span> <span class="o">|</span> <span class="n">PLL_RX_CFG_LOS_LTHRESH</span> <span class="o">|</span>
		  <span class="n">PLL_RX_CFG_EQ_LP_ADAPTIVE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">test_cfg</span> <span class="o">=</span> <span class="n">PLL_TEST_CFG_LOOPBACK_CML_DIS</span><span class="p">;</span>

		<span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			   <span class="n">ESR2_TI_PLL_TEST_CFG_L</span><span class="p">,</span> <span class="n">test_cfg</span><span class="p">);</span>

		<span class="n">tx_cfg</span> <span class="o">|=</span> <span class="n">PLL_TX_CFG_ENTEST</span><span class="p">;</span>
		<span class="n">rx_cfg</span> <span class="o">|=</span> <span class="n">PLL_RX_CFG_ENTEST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize PLL for 10G */</span>
	<span class="n">pll_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLL_CFG_ENPLL</span> <span class="o">|</span> <span class="n">PLL_CFG_MPY_10X</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR2_TI_PLL_CFG_L</span><span class="p">,</span> <span class="n">pll_cfg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NIU Port %d %s() mdio write to ESR2_TI_PLL_CFG_L failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pll_sts</span> <span class="o">=</span> <span class="n">PLL_CFG_ENPLL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR2_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR2_TI_PLL_STS_L</span><span class="p">,</span> <span class="n">pll_sts</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NIU Port %d %s() mdio write to ESR2_TI_PLL_STS_L failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* Initialize all 4 lanes of the SERDES.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr2_set_tx_cfg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr2_set_rx_cfg</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if serdes is ready */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P0_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P1_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">max_retry</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESR_INT_SIGNALS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;NIU Port %u signal bits [%08x] are not [%08x] for 10G...trying 1G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

		<span class="cm">/* 10G failed, try initializing at 1G */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">serdes_init_niu_1g_serdes</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_PCS</span><span class="p">;</span>
		<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u 10G/1G SERDES Link Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr_read_rxtx_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span> <span class="n">ESR_RXTX_CTRL_L</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
				<span class="n">ESR_RXTX_CTRL_H</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr_read_glue0</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			<span class="n">ESR_GLUE_CTRL0_L</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
				<span class="n">ESR_GLUE_CTRL0_H</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr_read_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			<span class="n">ESR_RXTX_RESET_CTRL_L</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
				<span class="n">ESR_RXTX_RESET_CTRL_H</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr_write_rxtx_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR_RXTX_CTRL_L</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
				 <span class="n">ESR_RXTX_CTRL_H</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr_write_glue0</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			<span class="n">ESR_GLUE_CTRL0_L</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
				 <span class="n">ESR_GLUE_CTRL0_H</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esr_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">reset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR_RXTX_RESET_CTRL_L</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR_RXTX_RESET_CTRL_H</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR_RXTX_RESET_CTRL_L</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">NIU_ESR_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">ESR_RXTX_RESET_CTRL_H</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_reset</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u ESR_RESET did not clear [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_10g</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">test_cfg_reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">test_cfg_val</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_CTRL_CFG</span><span class="p">;</span>
		<span class="n">test_cfg_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_TEST_CFG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_CTRL_CFG</span><span class="p">;</span>
		<span class="n">test_cfg_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_TEST_CFG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctrl_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENET_SERDES_CTRL_SDET_0</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_1</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_2</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_3</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_3_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_3_SHIFT</span><span class="p">));</span>
	<span class="n">test_cfg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_cfg_val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_3_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">test_cfg_reg</span><span class="p">,</span> <span class="n">test_cfg_val</span><span class="p">);</span>

	<span class="cm">/* Initialize all 4 lanes of the SERDES.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rxtx_ctrl</span><span class="p">,</span> <span class="n">glue0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_rxtx_ctrl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxtx_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_glue0</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">glue0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">rxtx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESR_RXTX_CTRL_VMUXLO</span><span class="p">);</span>
		<span class="n">rxtx_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESR_RXTX_CTRL_ENSTRETCH</span> <span class="o">|</span>
			      <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_RXTX_CTRL_VMUXLO_SHIFT</span><span class="p">));</span>

		<span class="n">glue0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESR_GLUE_CTRL0_SRATE</span> <span class="o">|</span>
			   <span class="n">ESR_GLUE_CTRL0_THCNT</span> <span class="o">|</span>
			   <span class="n">ESR_GLUE_CTRL0_BLTIME</span><span class="p">);</span>
		<span class="n">glue0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESR_GLUE_CTRL0_RXLOSENAB</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_GLUE_CTRL0_SRATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_GLUE_CTRL0_THCNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">BLTIME_300_CYCLES</span> <span class="o">&lt;&lt;</span>
			   <span class="n">ESR_GLUE_CTRL0_BLTIME_SHIFT</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_write_rxtx_ctrl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxtx_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_write_glue0</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">glue0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">esr_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sig</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESR_INT_SIGNALS</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P0_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P1_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u signal bits [%08x] are not [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_1g</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ENET_SERDES_1_PLL_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_SERDES_PLL_FBDIV2</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_SERDES_PLL_HRATE0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_SERDES_PLL_HRATE1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_SERDES_PLL_HRATE2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_SERDES_PLL_HRATE3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ENET_SERDES_1_PLL_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_1g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">test_cfg_reg</span><span class="p">,</span> <span class="n">pll_cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">test_cfg_val</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reset_val</span><span class="p">,</span> <span class="n">val_rd</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ENET_SERDES_PLL_HRATE0</span> <span class="o">|</span> <span class="n">ENET_SERDES_PLL_HRATE1</span> <span class="o">|</span>
		<span class="n">ENET_SERDES_PLL_HRATE2</span> <span class="o">|</span> <span class="n">ENET_SERDES_PLL_HRATE3</span> <span class="o">|</span>
		<span class="n">ENET_SERDES_PLL_FBDIV0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">reset_val</span> <span class="o">=</span>  <span class="n">ENET_SERDES_RESET_0</span><span class="p">;</span>
		<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_CTRL_CFG</span><span class="p">;</span>
		<span class="n">test_cfg_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_TEST_CFG</span><span class="p">;</span>
		<span class="n">pll_cfg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_PLL_CFG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reset_val</span> <span class="o">=</span>  <span class="n">ENET_SERDES_RESET_1</span><span class="p">;</span>
		<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_CTRL_CFG</span><span class="p">;</span>
		<span class="n">test_cfg_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_TEST_CFG</span><span class="p">;</span>
		<span class="n">pll_cfg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_PLL_CFG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctrl_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENET_SERDES_CTRL_SDET_0</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_1</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_2</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_3</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_3_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_3_SHIFT</span><span class="p">));</span>
	<span class="n">test_cfg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_cfg_val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_3_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">ENET_SERDES_RESET</span><span class="p">,</span> <span class="n">reset_val</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">val_rd</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ENET_SERDES_RESET</span><span class="p">);</span>
	<span class="n">val_rd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">reset_val</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">pll_cfg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">test_cfg_reg</span><span class="p">,</span> <span class="n">test_cfg_val</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ENET_SERDES_RESET</span><span class="p">,</span> <span class="n">val_rd</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

	<span class="cm">/* Initialize all 4 lanes of the SERDES.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rxtx_ctrl</span><span class="p">,</span> <span class="n">glue0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_rxtx_ctrl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxtx_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_glue0</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">glue0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">rxtx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESR_RXTX_CTRL_VMUXLO</span><span class="p">);</span>
		<span class="n">rxtx_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESR_RXTX_CTRL_ENSTRETCH</span> <span class="o">|</span>
			      <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_RXTX_CTRL_VMUXLO_SHIFT</span><span class="p">));</span>

		<span class="n">glue0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESR_GLUE_CTRL0_SRATE</span> <span class="o">|</span>
			   <span class="n">ESR_GLUE_CTRL0_THCNT</span> <span class="o">|</span>
			   <span class="n">ESR_GLUE_CTRL0_BLTIME</span><span class="p">);</span>
		<span class="n">glue0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESR_GLUE_CTRL0_RXLOSENAB</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_GLUE_CTRL0_SRATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_GLUE_CTRL0_THCNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">BLTIME_300_CYCLES</span> <span class="o">&lt;&lt;</span>
			   <span class="n">ESR_GLUE_CTRL0_BLTIME_SHIFT</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_write_rxtx_ctrl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxtx_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_write_glue0</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">glue0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">sig</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESR_INT_SIGNALS</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P0</span> <span class="o">|</span> <span class="n">ESR_INT_DET0_P0</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P1</span> <span class="o">|</span> <span class="n">ESR_INT_DET0_P1</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u signal bits [%08x] are not [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_1g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_duplex</span><span class="p">;</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
	<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_pcs</span><span class="p">(</span><span class="n">PCS_MII_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCS_MII_STAT_LINK_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">current_duplex</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_10g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_duplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">link_status_1g_serdes</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up_p</span><span class="p">);</span>

	<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
	<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_xpcs</span><span class="p">(</span><span class="n">XPCS_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_INTER2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="mh">0x01000000</span><span class="p">)</span>
		<span class="n">link_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1000ULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">current_duplex</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">advert</span><span class="p">,</span> <span class="n">ctrl1000</span><span class="p">,</span> <span class="n">stat1000</span><span class="p">,</span> <span class="n">lpa</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">estatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">supported</span><span class="p">,</span> <span class="n">advertising</span><span class="p">,</span> <span class="n">active_speed</span><span class="p">,</span> <span class="n">active_duplex</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">advert</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">lpa</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ESTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">estatus</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">ctrl1000</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">stat1000</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">estatus</span> <span class="o">=</span> <span class="n">ctrl1000</span> <span class="o">=</span> <span class="n">stat1000</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCAPABLE</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_100baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">estatus</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_THALF</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">estatus</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_TFULL</span><span class="p">)</span>
		<span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">supported</span><span class="p">;</span>

	<span class="n">advertising</span> <span class="o">=</span> <span class="n">mii_adv_to_ethtool_adv_t</span><span class="p">(</span><span class="n">advert</span><span class="p">);</span>
	<span class="n">advertising</span> <span class="o">|=</span> <span class="n">mii_ctrl1000_to_ethtool_adv_t</span><span class="p">(</span><span class="n">ctrl1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">neg</span><span class="p">,</span> <span class="n">neg1000</span><span class="p">;</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>

		<span class="n">neg</span> <span class="o">=</span> <span class="n">advert</span> <span class="o">&amp;</span> <span class="n">lpa</span><span class="p">;</span>
		<span class="n">neg1000</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl1000</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">stat1000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">neg1000</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_1000FULL</span> <span class="o">|</span> <span class="n">LPA_1000HALF</span><span class="p">))</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">neg</span> <span class="o">&amp;</span> <span class="n">LPA_100</span><span class="p">)</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">neg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_10HALF</span> <span class="o">|</span> <span class="n">LPA_10FULL</span><span class="p">))</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">neg1000</span> <span class="o">&amp;</span> <span class="n">LPA_1000FULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">neg</span> <span class="o">&amp;</span> <span class="n">LPA_DUPLEX</span><span class="p">))</span>
			<span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">active_speed</span> <span class="o">!=</span> <span class="n">SPEED_INVALID</span><span class="p">)</span>
			<span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED1000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">))</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span>
			<span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_advertising</span> <span class="o">=</span> <span class="n">advertising</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">active_speed</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">active_duplex</span><span class="p">;</span>
	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_1g_rgmii</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_speed</span><span class="p">,</span> <span class="n">bmsr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">link_up</span><span class="p">;</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
	<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">adv</span><span class="p">,</span> <span class="n">lpa</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">adv</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">lpa</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ESTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">current_duplex</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_1g</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">link_status_mii</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up_p</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_TP</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_TP</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm8704_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
			<span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
				<span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u PHY will not reset (bmcr=%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* When written, certain PHY registers need to be read back twice</span>
<span class="cm"> * in order for the bits to settle properly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm8704_user_dev3_readback</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm8706_init_user_dev3</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_USER_OPT_DIGITAL_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USER_ODIG_CTRL_GPIOS</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="n">USER_ODIG_CTRL_GPIOS_SHIFT</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span>  <span class="n">USER_ODIG_CTRL_RESV2</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			 <span class="n">BCM8704_USER_OPT_DIGITAL_CTRL</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm8704_init_user_dev3</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
			 <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span> <span class="n">BCM8704_USER_CONTROL</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">USER_CONTROL_OPTXRST_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OPBIASFLT_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OBTMPFLT_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OPPRFLT_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OPTXFLT_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OPRXLOS_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OPRXFLT_LVL</span> <span class="o">|</span>
			  <span class="n">USER_CONTROL_OPTXON_LVL</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="n">USER_CONTROL_RES1_SHIFT</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
			 <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span> <span class="n">BCM8704_USER_PMD_TX_CONTROL</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">USER_PMD_TX_CTL_XFP_CLKEN</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USER_PMD_TX_CTL_TX_DAC_TXD_SH</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">USER_PMD_TX_CTL_TX_DAC_TXCK_SH</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">USER_PMD_TX_CTL_TSCK_LPWREN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bcm8704_user_dev3_readback</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">BCM8704_USER_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bcm8704_user_dev3_readback</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">BCM8704_USER_PMD_TX_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_USER_OPT_DIGITAL_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USER_ODIG_CTRL_GPIOS</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="n">USER_ODIG_CTRL_GPIOS_SHIFT</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			 <span class="n">BCM8704_USER_OPT_DIGITAL_CTRL</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mrvl88x2011_act_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">;</span>

	<span class="n">err</span>  <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV2_ADDR</span><span class="p">,</span>
		<span class="n">MRVL88X2011_LED_8_TO_11_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MRVL88X2011_LED</span><span class="p">(</span><span class="n">MRVL88X2011_LED_ACT</span><span class="p">,</span><span class="n">MRVL88X2011_LED_CTL_MASK</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span>  <span class="n">MRVL88X2011_LED</span><span class="p">(</span><span class="n">MRVL88X2011_LED_ACT</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV2_ADDR</span><span class="p">,</span>
			  <span class="n">MRVL88X2011_LED_8_TO_11_CTL</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mrvl88x2011_led_blink_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV2_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_LED_BLINK_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MRVL88X2011_LED_BLKRATE_MASK</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV2_ADDR</span><span class="p">,</span>
				 <span class="n">MRVL88X2011_LED_BLINK_CTL</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_init_10g_mrvl88x2011</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set LED functions */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mrvl88x2011_led_blink_rate</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">MRVL88X2011_LED_BLKRATE_134MS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* led activity */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mrvl88x2011_act_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">MRVL88X2011_LED_CTL_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_GENERAL_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">MRVL88X2011_ENA_XFPREFCLK</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV3_ADDR</span><span class="p">,</span>
			 <span class="n">MRVL88X2011_GENERAL_CTL</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV1_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_PMA_PMD_CTL_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_MAC</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">MRVL88X2011_LOOPBACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MRVL88X2011_LOOPBACK</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV1_ADDR</span><span class="p">,</span>
			 <span class="n">MRVL88X2011_PMA_PMD_CTL_1</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Enable PMD  */</span>
	<span class="k">return</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV1_ADDR</span><span class="p">,</span>
			  <span class="n">MRVL88X2011_10G_PMD_TX_DIS</span><span class="p">,</span> <span class="n">MRVL88X2011_ENA_PMDTX</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_diag_bcm870x</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">analog_stat0</span><span class="p">,</span> <span class="n">tx_alarm_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 1</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PMA_PMD_DEV_ADDR</span><span class="p">,</span>
			<span class="n">MII_STAT1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Port %u PMA_PMD(MII_STAT1000) [%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Port %u USER_DEV3(0x20) [%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span>
			<span class="n">MII_NWAYTEST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Port %u PHYXS(MII_NWAYTEST) [%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* XXX dig this out it might not be so useful XXX */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_USER_ANALOG_STATUS0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_USER_ANALOG_STATUS0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">analog_stat0</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_USER_TX_ALARM_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_USER_TX_ALARM_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">tx_alarm_status</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">analog_stat0</span> <span class="o">!=</span> <span class="mh">0x03fc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">analog_stat0</span> <span class="o">==</span> <span class="mh">0x43bc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_alarm_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Port %u cable not connected or bad cable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">analog_stat0</span> <span class="o">==</span> <span class="mh">0x639c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Port %u optical module is bad or missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_10g_set_lb_bcm870x</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PCS_DEV_ADDR</span><span class="p">,</span>
			<span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_LOOPBACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_MAC</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">BMCR_LOOPBACK</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PCS_DEV_ADDR</span><span class="p">,</span>
			 <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_init_10g_bcm8706</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_LED_POLARITY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_FORCE_LED_ON</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MIF_CONFIG_INDIRECT_MODE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bcm8704_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xcvr_10g_set_lb_bcm870x</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bcm8706_init_user_dev3</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xcvr_diag_bcm870x</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_init_10g_bcm8704</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bcm8704_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bcm8704_init_user_dev3</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xcvr_10g_set_lb_bcm870x</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span>  <span class="n">xcvr_diag_bcm870x</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_init_10g</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_LED_POLARITY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_FORCE_LED_ON</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* XXX shared resource, lock parent XXX */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MIF_CONFIG_INDIRECT_MODE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_decode</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">phy_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">phy_probe_info</span><span class="p">.</span><span class="n">phy_id</span><span class="p">[</span><span class="n">phy_id</span><span class="p">][</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>

	<span class="cm">/* handle different phy types */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">NIU_PHY_ID_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NIU_PHY_ID_MRVL88X2011</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">xcvr_init_10g_mrvl88x2011</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* bcom 8704 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xcvr_init_10g_bcm8704</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u MII would not reset, bmcr[%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_init_1g_rgmii</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">estat</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIF_CONFIG_INDIRECT_MODE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">estat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ESTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">estat</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl1000</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_TFULL</span><span class="p">)</span>
			<span class="n">ctrl1000</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">ctrl1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BMCR_SPEED1000</span> <span class="o">|</span> <span class="n">BMCR_FULLDPLX</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_init_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">estat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">estat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ESTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">estat</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_MAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_LOOPBACK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">aux</span><span class="p">;</span>

		<span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="n">BCM5464R_AUX_CTL_EXT_LB</span> <span class="o">|</span>
		       <span class="n">BCM5464R_AUX_CTL_WRITE_1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM5464R_AUX_CTL</span><span class="p">,</span> <span class="n">aux</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl1000</span><span class="p">;</span>

		<span class="n">adv</span> <span class="o">=</span> <span class="n">ADVERTISE_CSMA</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">))</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">))</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">))</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">))</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctrl1000</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_THALF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">))</span>
				<span class="n">ctrl1000</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000HALF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_TFULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">))</span>
				<span class="n">ctrl1000</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
					<span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">ctrl1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* !lp-&gt;autoneg */</span>
		<span class="kt">int</span> <span class="n">fulldpx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
			<span class="n">fulldpx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
			<span class="n">fulldpx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if X-full requested while not supported, or</span>
<span class="cm">			   X-half requested while not supported... */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fulldpx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_TFULL</span><span class="p">))</span> <span class="o">||</span>
				<span class="p">(</span><span class="o">!</span><span class="n">fulldpx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_THALF</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fulldpx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">))</span> <span class="o">||</span>
				<span class="p">(</span><span class="o">!</span><span class="n">fulldpx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fulldpx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">))</span> <span class="o">||</span>
				<span class="p">(</span><span class="o">!</span><span class="n">fulldpx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	err = mii_read(np, np-&gt;phy_addr, MII_BMCR);</span>
<span class="c">	if (err &lt; 0)</span>
<span class="c">		return err;</span>
<span class="c">	bmcr = err;</span>

<span class="c">	err = mii_read(np, np-&gt;phy_addr, MII_BMSR);</span>
<span class="c">	if (err &lt; 0)</span>
<span class="c">		return err;</span>
<span class="c">	bmsr = err;</span>

<span class="c">	pr_info(&quot;Port %u after MII init bmcr[%04x] bmsr[%04x]\n&quot;,</span>
<span class="c">		np-&gt;port, bmcr, bmsr);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xcvr_init_1g</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* XXX shared resource, lock parent XXX */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIF_CONFIG_INDIRECT_MODE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_init_common</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_xcvr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">xcvr_init</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">xcvr_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_serdes_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">serdes_init</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">serdes_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">niu_init_xif</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">niu_handle_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_link_status_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link_up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is up at %s, %s duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span> <span class="o">?</span> <span class="s">&quot;10Gb/sec&quot;</span> <span class="o">:</span>
			   <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">?</span> <span class="s">&quot;1Gb/sec&quot;</span> <span class="o">:</span>
			   <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">?</span> <span class="s">&quot;100Mbit/sec&quot;</span> <span class="o">:</span>
			   <span class="s">&quot;10Mbit/sec&quot;</span><span class="p">,</span>
			   <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">niu_init_xif</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">niu_handle_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">niu_handle_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_10g_mrvl</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">pma_status</span><span class="p">,</span> <span class="n">pcs_status</span><span class="p">;</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV1_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_10G_PMD_STATUS_2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check PMA/PMD Register: 1.0001.2 == 1 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV1_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_PMA_PMD_STATUS_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pma_status</span> <span class="o">=</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">MRVL88X2011_LNK_STATUS_OK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

        <span class="cm">/* Check PMC Register : 3.0001.2 == 1: read twice */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_PMA_PMD_STATUS_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV3_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_PMA_PMD_STATUS_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pcs_status</span> <span class="o">=</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">MRVL88X2011_LNK_STATUS_OK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

        <span class="cm">/* Check XGXS Register : 4.0018.[0-3,12] */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">MRVL88X2011_USER_DEV4_ADDR</span><span class="p">,</span>
			<span class="n">MRVL88X2011_10G_XGXS_LANE_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="p">(</span><span class="n">PHYXS_XGXS_LANE_STAT_ALINGED</span> <span class="o">|</span> <span class="n">PHYXS_XGXS_LANE_STAT_LANE3</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE2</span> <span class="o">|</span> <span class="n">PHYXS_XGXS_LANE_STAT_LANE1</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE0</span> <span class="o">|</span> <span class="n">PHYXS_XGXS_LANE_STAT_MAGIC</span> <span class="o">|</span>
		    <span class="mh">0x800</span><span class="p">))</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="p">(</span><span class="n">pma_status</span> <span class="o">&amp;&amp;</span> <span class="n">pcs_status</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mrvl88x2011_act_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">?</span>
				 <span class="n">MRVL88X2011_LED_CTL_PCS_ACT</span> <span class="o">:</span>
				 <span class="n">MRVL88X2011_LED_CTL_OFF</span><span class="p">));</span>

	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_10g_bcm8706</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PMA_PMD_DEV_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_PMD_RCV_SIGDET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">PMD_RCV_SIGDET_GLOBAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PCS_DEV_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_PCS_10G_R_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">PCS_10G_R_STATUS_BLK_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_PHYXS_XGXS_LANE_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="p">(</span><span class="n">PHYXS_XGXS_LANE_STAT_ALINGED</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_MAGIC</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_PATTEST</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE3</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE2</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE1</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_10g_bcom</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">link_up</span><span class="p">;</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PMA_PMD_DEV_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_PMD_RCV_SIGDET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">PMD_RCV_SIGDET_GLOBAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PCS_DEV_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_PCS_10G_R_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">PCS_10G_R_STATUS_BLK_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span>
			<span class="n">BCM8704_PHYXS_XGXS_LANE_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="p">(</span><span class="n">PHYXS_XGXS_LANE_STAT_ALINGED</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_MAGIC</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE3</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE2</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE1</span> <span class="o">|</span>
		    <span class="n">PHYXS_XGXS_LANE_STAT_LANE0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_10g</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy_id</span><span class="p">;</span>

		<span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_decode</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">phy_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">phy_probe_info</span><span class="p">.</span><span class="n">phy_id</span><span class="p">[</span><span class="n">phy_id</span><span class="p">][</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>

		<span class="cm">/* handle different phy types */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">NIU_PHY_ID_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NIU_PHY_ID_MRVL88X2011</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">link_status_10g_mrvl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up_p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span> <span class="cm">/* bcom 8704 */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">link_status_10g_bcom</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up_p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_10g_phy_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sig</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">sig</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESR_INT_SIGNALS</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P0_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P1_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_status_10g_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_present</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_present_prev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_present_prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">)</span> <span class="o">?</span>
			<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy_present</span> <span class="o">=</span> <span class="n">niu_10g_phy_present</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_present</span> <span class="o">!=</span> <span class="n">phy_present_prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* state change */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_present</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* A NEM was just plugged in */</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_ops</span><span class="o">-&gt;</span><span class="n">xcvr_init</span><span class="p">)</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_ops</span><span class="o">-&gt;</span><span class="n">xcvr_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span>
						<span class="n">BCM8704_PHYXS_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* No mdio, back-to-back XAUI */</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* debounce */</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">;</span>
				<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">netif_warn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;Hotplug PHY Removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="nl">out:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY_PRESENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">link_status_10g_bcm8706</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up_p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* No mdio, back-to-back XAUI: it is C10NEM */</span>
				<span class="o">*</span><span class="n">link_up_p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_up_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up_p</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="p">)</span> <span class="n">__opaque</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">link_up</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_link_status</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">niu_link_status_common</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">link_up</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_10g_serdes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_10g_serdes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g_serdes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_10g_serdes_niu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_niu_10g_serdes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g_serdes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_1g_serdes_niu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_niu_1g_serdes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_1g_serdes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_1g_rgmii</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_1g_rgmii</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_1g_rgmii</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_10g_fiber_niu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_niu_10g_fiber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_10g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_10g_fiber</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_10g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_10g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_10g_fiber_hotplug</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_10g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_10g_bcm8706</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g_hotplug</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_niu_10g_hotplug</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_niu_10g_fiber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_10g_bcm8706</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g_hotplug</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_10g_copper</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_10g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_10g</span><span class="p">,</span> <span class="cm">/* XXX */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_1g_fiber</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">serdes_init</span>		<span class="o">=</span> <span class="n">serdes_init_1g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_1g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_1g</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span> <span class="n">phy_ops_1g_copper</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xcvr_init</span>		<span class="o">=</span> <span class="n">xcvr_init_1g</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_status</span>		<span class="o">=</span> <span class="n">link_status_1g</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_ops</span>	<span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">phy_addr_base</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_niu_10g_fiber</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_10g_fiber_niu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_niu_10g_serdes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_10g_serdes_niu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_niu_1g_serdes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_1g_serdes_niu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_10g_fiber</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_10g_fiber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_10g_fiber_hotplug</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_10g_fiber_hotplug</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_niu_10g_hotplug</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_niu_10g_hotplug</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_10g_copper</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_10g_copper</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_1g_fiber</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_1g_fiber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_1g_copper</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_1g_copper</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_1g_rgmii</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_1g_rgmii</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="n">phy_template_10g_serdes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_10g_serdes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_addr_base</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">niu_atca_port_num</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_init_10g_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">test_cfg_reg</span><span class="p">,</span> <span class="n">pll_cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">test_cfg_val</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_CTRL_CFG</span><span class="p">;</span>
		<span class="n">test_cfg_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_TEST_CFG</span><span class="p">;</span>
		<span class="n">pll_cfg</span> <span class="o">=</span> <span class="n">ENET_SERDES_0_PLL_CFG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_CTRL_CFG</span><span class="p">;</span>
		<span class="n">test_cfg_reg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_TEST_CFG</span><span class="p">;</span>
		<span class="n">pll_cfg</span> <span class="o">=</span> <span class="n">ENET_SERDES_1_PLL_CFG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctrl_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENET_SERDES_CTRL_SDET_0</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_1</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_2</span> <span class="o">|</span>
		    <span class="n">ENET_SERDES_CTRL_SDET_3</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_EMPH_3_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_SERDES_CTRL_LADJ_3_SHIFT</span><span class="p">));</span>
	<span class="n">test_cfg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_cfg_val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">ENET_TEST_MD_PAD_LOOPBACK</span> <span class="o">&lt;&lt;</span>
				  <span class="n">ENET_SERDES_TEST_MD_3_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">esr_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">pll_cfg</span><span class="p">,</span> <span class="n">ENET_SERDES_PLL_FBDIV2</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">test_cfg_reg</span><span class="p">,</span> <span class="n">test_cfg_val</span><span class="p">);</span>

	<span class="cm">/* Initialize all 4 lanes of the SERDES.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rxtx_ctrl</span><span class="p">,</span> <span class="n">glue0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_rxtx_ctrl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxtx_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_read_glue0</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">glue0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">rxtx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESR_RXTX_CTRL_VMUXLO</span><span class="p">);</span>
		<span class="n">rxtx_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESR_RXTX_CTRL_ENSTRETCH</span> <span class="o">|</span>
			      <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_RXTX_CTRL_VMUXLO_SHIFT</span><span class="p">));</span>

		<span class="n">glue0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESR_GLUE_CTRL0_SRATE</span> <span class="o">|</span>
			   <span class="n">ESR_GLUE_CTRL0_THCNT</span> <span class="o">|</span>
			   <span class="n">ESR_GLUE_CTRL0_BLTIME</span><span class="p">);</span>
		<span class="n">glue0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESR_GLUE_CTRL0_RXLOSENAB</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_GLUE_CTRL0_SRATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">ESR_GLUE_CTRL0_THCNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">BLTIME_300_CYCLES</span> <span class="o">&lt;&lt;</span>
			   <span class="n">ESR_GLUE_CTRL0_BLTIME_SHIFT</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_write_rxtx_ctrl</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rxtx_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">esr_write_glue0</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">glue0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">sig</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESR_INT_SIGNALS</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P0_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P0</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P0_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ESR_INT_SIGNALS_P1_BITS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESR_INT_SRDY0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_DET0_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XSRDY_P1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH3</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH2</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH1</span> <span class="o">|</span>
		       <span class="n">ESR_INT_XDP_P1_CH0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">serdes_init_1g_serdes</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_PCS</span><span class="p">;</span>
		<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %u 10G/1G SERDES Link Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_determine_phy_disposition</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">plat_type</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">niu_phy_template</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span>
			 <span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			 <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span>:
			<span class="cm">/* 10G Serdes */</span>
			<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_niu_10g_serdes</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span>:
			<span class="cm">/* 1G Serdes */</span>
			<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_niu_1g_serdes</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span>:
			<span class="cm">/* 10G Fiber */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_niu_10g_hotplug</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_niu_10g_fiber</span><span class="p">;</span>
				<span class="n">phy_addr_off</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span>
			 <span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			 <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* 1G copper */</span>
			<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_1g_copper</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_VF_P0</span><span class="p">)</span>
				<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_VF_P1</span><span class="p">)</span>
				<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>

			<span class="n">phy_addr_off</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">^</span> <span class="mh">0x3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span>:
			<span class="cm">/* 10G copper */</span>
			<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_10g_copper</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NIU_FLAGS_FIBER</span>:
			<span class="cm">/* 1G fiber */</span>
			<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_1g_fiber</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span>:
			<span class="cm">/* 10G fiber */</span>
			<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_10g_fiber</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_VF_P0</span> <span class="o">||</span>
			    <span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_VF_P1</span><span class="p">)</span>
				<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">phy_addr_off</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_10g_fiber_hotplug</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span>:
		<span class="k">case</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span>:
		<span class="k">case</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span>:
			<span class="k">switch</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_10g_serdes</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_template_1g_rgmii</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">phy_addr_off</span> <span class="o">=</span> <span class="n">niu_atca_port_num</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_ops</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr_base</span> <span class="o">+</span> <span class="n">phy_addr_off</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_xcvr_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_serdes_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_xcvr_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">))</span>
		<span class="n">niu_link_status</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ignore</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_set_primary_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg0</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">reg1</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADDR0</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADDR1</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADDR2</span><span class="p">,</span> <span class="n">reg2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADDR0</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADDR1</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADDR2</span><span class="p">,</span> <span class="n">reg2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_num_alt_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XMAC_NUM_ALT_ADDR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">BMAC_NUM_ALT_ADDR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_alt_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg0</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">reg1</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">niu_num_alt_addr</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ALT_ADDR0</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg0</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ALT_ADDR1</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg1</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ALT_ADDR2</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ALT_ADDR0</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg0</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ALT_ADDR1</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg1</span><span class="p">);</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ALT_ADDR2</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_enable_alt_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">niu_num_alt_addr</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">XMAC_ADDR_CMPEN</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">BMAC_ADDR_CMPEN</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__set_rdc_table_num_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac_pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HOST_INFO_MACRDCTBLN</span> <span class="o">|</span> <span class="n">HOST_INFO_MPR</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_pref</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HOST_INFO_MPR</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__set_rdc_table_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">xmac_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bmac_index</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">rdc_table_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac_pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdc_table_num</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HOST_INFO_MACRDCTBLN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">XMAC_HOST_INFO</span><span class="p">(</span><span class="n">xmac_index</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">BMAC_HOST_INFO</span><span class="p">(</span><span class="n">bmac_index</span><span class="p">);</span>
	<span class="n">__set_rdc_table_num_hw</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">rdc_table_num</span><span class="p">,</span> <span class="n">mac_pref</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_primary_mac_rdc_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">table_num</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">mac_pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__set_rdc_table_num</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">table_num</span><span class="p">,</span> <span class="n">mac_pref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_multicast_mac_rdc_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">table_num</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">mac_pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__set_rdc_table_num</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">table_num</span><span class="p">,</span> <span class="n">mac_pref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_alt_mac_rdc_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">table_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac_pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">niu_num_alt_addr</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__set_rdc_table_num</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">table_num</span><span class="p">,</span> <span class="n">mac_pref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">vlan_entry_set_parity</span><span class="p">(</span><span class="n">u64</span> <span class="n">reg_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">port01_mask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">port23_mask</span><span class="p">;</span>

	<span class="n">port01_mask</span> <span class="o">=</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="n">port23_mask</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hweight64</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">port01_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">ENET_VLAN_TBL_PARITY0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_VLAN_TBL_PARITY0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hweight64</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">port23_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">ENET_VLAN_TBL_PARITY1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_VLAN_TBL_PARITY1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">reg_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlan_tbl_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rdc_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">reg_val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ENET_VLAN_TBL</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>

	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">ENET_VLAN_TBL_VPR</span> <span class="o">|</span>
		      <span class="n">ENET_VLAN_TBL_VLANRDCTBLN</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">ENET_VLAN_TBL_SHIFT</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpr</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ENET_VLAN_TBL_VPR</span> <span class="o">&lt;&lt;</span>
			    <span class="n">ENET_VLAN_TBL_SHIFT</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rdc_table</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_VLAN_TBL_SHIFT</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">vlan_entry_set_parity</span><span class="p">(</span><span class="n">reg_val</span><span class="p">);</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">ENET_VLAN_TBL</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">reg_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlan_tbl_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENET_VLAN_TBL_NUM_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">ENET_VLAN_TBL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_wait_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr64</span><span class="p">(</span><span class="n">TCAM_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_MASK_0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_CTL</span><span class="p">,</span> <span class="p">(</span><span class="n">TCAM_CTL_RWC_TCAM_WRITE</span> <span class="o">|</span> <span class="n">index</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tcam_wait_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">TCAM_CTL_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int tcam_read(struct niu *np, int index,</span>
<span class="c">		     u64 *key, u64 *mask)</span>
<span class="c">{</span>
<span class="c">	int err;</span>

<span class="c">	nw64(TCAM_CTL, (TCAM_CTL_RWC_TCAM_READ | index));</span>
<span class="c">	err = tcam_wait_bit(np, TCAM_CTL_STAT);</span>
<span class="c">	if (!err) {</span>
<span class="c">		key[0] = nr64(TCAM_KEY_0);</span>
<span class="c">		key[1] = nr64(TCAM_KEY_1);</span>
<span class="c">		key[2] = nr64(TCAM_KEY_2);</span>
<span class="c">		key[3] = nr64(TCAM_KEY_3);</span>
<span class="c">		mask[0] = nr64(TCAM_KEY_MASK_0);</span>
<span class="c">		mask[1] = nr64(TCAM_KEY_MASK_1);</span>
<span class="c">		mask[2] = nr64(TCAM_KEY_MASK_2);</span>
<span class="c">		mask[3] = nr64(TCAM_KEY_MASK_3);</span>
<span class="c">	}</span>
<span class="c">	return err;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_0</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_1</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_2</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_3</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_MASK_0</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_MASK_1</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_MASK_2</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_MASK_3</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_CTL</span><span class="p">,</span> <span class="p">(</span><span class="n">TCAM_CTL_RWC_TCAM_WRITE</span> <span class="o">|</span> <span class="n">index</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tcam_wait_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">TCAM_CTL_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int tcam_assoc_read(struct niu *np, int index, u64 *data)</span>
<span class="c">{</span>
<span class="c">	int err;</span>

<span class="c">	nw64(TCAM_CTL, (TCAM_CTL_RWC_RAM_READ | index));</span>
<span class="c">	err = tcam_wait_bit(np, TCAM_CTL_STAT);</span>
<span class="c">	if (!err)</span>
<span class="c">		*data = nr64(TCAM_KEY_1);</span>

<span class="c">	return err;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_assoc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u64</span> <span class="n">assoc_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY_1</span><span class="p">,</span> <span class="n">assoc_data</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_CTL</span><span class="p">,</span> <span class="p">(</span><span class="n">TCAM_CTL_RWC_RAM_WRITE</span> <span class="o">|</span> <span class="n">index</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tcam_wait_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">TCAM_CTL_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcam_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFLP_CFG_1_TCAM_DIS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">FFLP_CFG_1_TCAM_DIS</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcam_set_lat_and_ratio</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">latency</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FFLP_CFG_1_FFLPINITDONE</span> <span class="o">|</span>
		 <span class="n">FFLP_CFG_1_CAMLAT</span> <span class="o">|</span>
		 <span class="n">FFLP_CFG_1_CAMRATIO</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">latency</span> <span class="o">&lt;&lt;</span> <span class="n">FFLP_CFG_1_CAMLAT_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&lt;&lt;</span> <span class="n">FFLP_CFG_1_CAMRATIO_SHIFT</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">FFLP_CFG_1_FFLPINITDONE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_user_eth_class_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">class</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&lt;</span> <span class="n">CLASS_CODE_ETHERTYPE1</span> <span class="o">||</span>
	    <span class="n">class</span> <span class="o">&gt;</span> <span class="n">CLASS_CODE_ETHERTYPE2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">L2_CLS</span><span class="p">(</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_ETHERTYPE1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">L2_CLS_VLD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">L2_CLS_VLD</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int tcam_user_eth_class_set(struct niu *np, unsigned long class,</span>
<span class="c">				   u64 ether_type)</span>
<span class="c">{</span>
<span class="c">	unsigned long reg;</span>
<span class="c">	u64 val;</span>

<span class="c">	if (class &lt; CLASS_CODE_ETHERTYPE1 ||</span>
<span class="c">	    class &gt; CLASS_CODE_ETHERTYPE2 ||</span>
<span class="c">	    (ether_type &amp; ~(u64)0xffff) != 0)</span>
<span class="c">		return -EINVAL;</span>

<span class="c">	reg = L2_CLS(class - CLASS_CODE_ETHERTYPE1);</span>
<span class="c">	val = nr64(reg);</span>
<span class="c">	val &amp;= ~L2_CLS_ETYPE;</span>
<span class="c">	val |= (ether_type &lt;&lt; L2_CLS_ETYPE_SHIFT);</span>
<span class="c">	nw64(reg, val);</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_user_ip_class_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">class</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&lt;</span> <span class="n">CLASS_CODE_USER_PROG1</span> <span class="o">||</span>
	    <span class="n">class</span> <span class="o">&gt;</span> <span class="n">CLASS_CODE_USER_PROG4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">L3_CLS</span><span class="p">(</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">L3_CLS_VALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">L3_CLS_VALID</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_user_ip_class_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">class</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">ipv6</span><span class="p">,</span> <span class="n">u64</span> <span class="n">protocol_id</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="n">tos_mask</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tos_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&lt;</span> <span class="n">CLASS_CODE_USER_PROG1</span> <span class="o">||</span>
	    <span class="n">class</span> <span class="o">&gt;</span> <span class="n">CLASS_CODE_USER_PROG4</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">protocol_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tos_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tos_val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">L3_CLS</span><span class="p">(</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">L3_CLS_IPVER</span> <span class="o">|</span> <span class="n">L3_CLS_PID</span> <span class="o">|</span>
		 <span class="n">L3_CLS_TOSMASK</span> <span class="o">|</span> <span class="n">L3_CLS_TOS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">L3_CLS_IPVER</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">protocol_id</span> <span class="o">&lt;&lt;</span> <span class="n">L3_CLS_PID_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tos_mask</span> <span class="o">&lt;&lt;</span> <span class="n">L3_CLS_TOSMASK_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tos_val</span> <span class="o">&lt;&lt;</span> <span class="n">L3_CLS_TOS_SHIFT</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tcam_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tcam_set_lat_and_ratio</span><span class="p">(</span><span class="n">np</span><span class="p">,</span>
			       <span class="n">DEFAULT_TCAM_LATENCY</span><span class="p">,</span>
			       <span class="n">DEFAULT_TCAM_ACCESS_RATIO</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CLASS_CODE_ETHERTYPE1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">CLASS_CODE_ETHERTYPE2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_user_eth_class_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">CLASS_CODE_USER_PROG4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_user_ip_class_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcam_flush_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">tcam_flush</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">hash_addr_regval</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">index</span> <span class="o">|</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">HASH_TBL_ADDR_AUTOINC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int hash_read(struct niu *np, unsigned long partition,</span>
<span class="c">		     unsigned long index, unsigned long num_entries,</span>
<span class="c">		     u64 *data)</span>
<span class="c">{</span>
<span class="c">	u64 val = hash_addr_regval(index, num_entries);</span>
<span class="c">	unsigned long i;</span>

<span class="c">	if (partition &gt;= FCRAM_NUM_PARTITIONS ||</span>
<span class="c">	    index + num_entries &gt; FCRAM_SIZE)</span>
<span class="c">		return -EINVAL;</span>

<span class="c">	nw64(HASH_TBL_ADDR(partition), val);</span>
<span class="c">	for (i = 0; i &lt; num_entries; i++)</span>
<span class="c">		data[i] = nr64(HASH_TBL_DATA(partition));</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hash_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">partition</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_entries</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">hash_addr_regval</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">partition</span> <span class="o">&gt;=</span> <span class="n">FCRAM_NUM_PARTITIONS</span> <span class="o">||</span>
	    <span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">FCRAM_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">HASH_TBL_ADDR</span><span class="p">(</span><span class="n">partition</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">HASH_TBL_DATA</span><span class="p">(</span><span class="n">partition</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fflp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">FFLP_CFG_1_PIO_FIO_RST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FFLP_CFG_1_FCRAMOUTDR_NORMAL</span> <span class="o">|</span> <span class="n">FFLP_CFG_1_FFLPINITDONE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fflp_set_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFLP_CFG_1_FFLPINITDONE</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DEFAULT_FCRAMRATIO</span> <span class="o">&lt;&lt;</span> <span class="n">FFLP_CFG_1_FCRAMRATIO_SHIFT</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">FFLP_CFG_1_FFLPINITDONE</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FCRAM_REF_TMR</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FCRAM_REF_TMR_MAX</span> <span class="o">|</span> <span class="n">FCRAM_REF_TMR_MIN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DEFAULT_FCRAM_REFRESH_MAX</span> <span class="o">&lt;&lt;</span> <span class="n">FCRAM_REF_TMR_MAX_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DEFAULT_FCRAM_REFRESH_MIN</span> <span class="o">&lt;&lt;</span> <span class="n">FCRAM_REF_TMR_MIN_SHIFT</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FCRAM_REF_TMR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fflp_set_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">partition</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">partition</span> <span class="o">&gt;=</span> <span class="n">FCRAM_NUM_PARTITIONS</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FLW_PRT_SEL</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FLW_PRT_SEL_EXT</span> <span class="o">|</span> <span class="n">FLW_PRT_SEL_MASK</span> <span class="o">|</span> <span class="n">FLW_PRT_SEL_BASE</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">FLW_PRT_SEL_MASK_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="n">FLW_PRT_SEL_BASE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">FLW_PRT_SEL_EXT</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fflp_disable_all_partitions</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FCRAM_NUM_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">fflp_set_partition</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fflp_llcsnap_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">FFLP_CFG_1_LLCSNAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFLP_CFG_1_LLCSNAP</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fflp_errors_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFLP_CFG_1_ERRORDIS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">FFLP_CFG_1_ERRORDIS</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FFLP_CFG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fflp_hash_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcram_hash_ipv4</span> <span class="n">ent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* IPV4 hash entry with valid bit clear, rest is don&#39;t care.  */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
	<span class="n">ent</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HASH_HEADER_EXT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FCRAM_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">hash_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fflp_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARENT_FLGS_CLS_HWINIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">!=</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fflp_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="n">fflp_set_timings</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fflp_disable_all_partitions</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;fflp_disable_all_partitions failed, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_early_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;tcam_early_init failed, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fflp_llcsnap_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fflp_errors_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">H1POLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">H2POLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_flush_all</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;tcam_flush_all failed, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">!=</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fflp_hash_clear</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;fflp_hash_clear failed, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vlan_tbl_clear</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PARENT_FLGS_CLS_HWINIT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_flow_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">class_code</span><span class="p">,</span> <span class="n">u64</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">&lt;</span> <span class="n">CLASS_CODE_USER_PROG1</span> <span class="o">||</span>
	    <span class="n">class_code</span> <span class="o">&gt;</span> <span class="n">CLASS_CODE_SCTP_IPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">FLOW_KEY</span><span class="p">(</span><span class="n">class_code</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">),</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_tcam_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">class_code</span><span class="p">,</span> <span class="n">u64</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">&lt;</span> <span class="n">CLASS_CODE_USER_PROG1</span> <span class="o">||</span>
	    <span class="n">class_code</span> <span class="o">&gt;</span> <span class="n">CLASS_CODE_SCTP_IPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY</span><span class="p">(</span><span class="n">class_code</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">),</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Entries for the ports are interleaved in the TCAM */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">tcam_get_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* One entry reserved for IP fragment rule */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">.</span><span class="n">tcam_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">.</span><span class="n">tcam_top</span> <span class="o">+</span> <span class="p">((</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">tcam_get_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* One entry reserved for IP fragment rule */</span>
	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">.</span><span class="n">tcam_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">tcam_get_valid_entry_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* One entry reserved for IP fragment rule */</span>
	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">.</span><span class="n">tcam_valid_entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_rx_skb_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">truesize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">truesize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">niu_hash_rxaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span> <span class="o">&gt;&gt;=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">MAX_RBR_RING_SIZE</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAX_RBR_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">niu_find_rxpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">page</span> <span class="o">***</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">niu_hash_rxaddr</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">**</span><span class="n">pp</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BUG</span><span class="p">();</span>

<span class="nl">found:</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_hash_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">niu_hash_rxaddr</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="p">)</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rbr_add_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
			    <span class="n">gfp_t</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">niu_hash_page</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">compound_head</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">rbr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">[</span><span class="n">start_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

		<span class="o">*</span><span class="n">rbr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">RBR_DESCR_ADDR_SHIFT</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_block_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_rbr_refill</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span> <span class="o">%</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">niu_rbr_add_page</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span><span class="o">--</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">&gt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">==</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span><span class="p">)</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span> <span class="o">&gt;=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_kick_thresh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nw64</span><span class="p">(</span><span class="n">RBR_KICK</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span><span class="p">);</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rx_pkt_ignore</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">**</span><span class="n">link</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rcr_size</span><span class="p">;</span>

		<span class="n">num_rcr</span><span class="o">++</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_PKT_BUF_ADDR</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">RCR_ENTRY_PKT_BUF_ADDR_SHIFT</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">niu_find_rxpage</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">);</span>

		<span class="n">rcr_size</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_PKTBUFSZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="n">RCR_ENTRY_PKTBUFSZ_SHIFT</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="n">rcr_size</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
					    <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_refill_pending</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">NEXT_RCR</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_MULTI</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num_rcr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_process_rx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_pkt_hdr1</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">num_rcr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_SKB_ALLOC_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">niu_rx_pkt_ignore</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>

	<span class="n">num_rcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">**</span><span class="n">link</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rcr_size</span><span class="p">,</span> <span class="n">append_size</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>

		<span class="n">num_rcr</span><span class="o">++</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_L2_LEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">RCR_ENTRY_L2_LEN_SHIFT</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_PKT_BUF_ADDR</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">RCR_ENTRY_PKT_BUF_ADDR_SHIFT</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">niu_find_rxpage</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">);</span>

		<span class="n">rcr_size</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_PKTBUFSZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="n">RCR_ENTRY_PKTBUFSZ_SHIFT</span><span class="p">];</span>

		<span class="n">off</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">append_size</span> <span class="o">=</span> <span class="n">rcr_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_rcr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ptype</span><span class="p">;</span>

			<span class="n">ptype</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">RCR_ENTRY_PKT_TYPE_SHIFT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">RCR_PKT_TYPE_TCP</span> <span class="o">||</span>
			     <span class="n">ptype</span> <span class="o">==</span> <span class="n">RCR_PKT_TYPE_UDP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RCR_ENTRY_NOPORT</span> <span class="o">|</span>
				     <span class="n">RCR_ENTRY_ERROR</span><span class="p">)))</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_MULTI</span><span class="p">))</span>
			<span class="n">append_size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">niu_rx_skb_append</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">append_size</span><span class="p">,</span> <span class="n">rcr_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_block_size</span><span class="p">)</span> <span class="o">-</span> <span class="n">rcr_size</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
					    <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_refill_pending</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">NEXT_RCR</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RCR_ENTRY_MULTI</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rh</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rh</span><span class="p">)</span> <span class="o">+</span> <span class="n">VLAN_ETH_HLEN</span><span class="p">);</span>
	<span class="n">__pskb_pull_tail</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_pkt_hdr1</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">hashval2_0</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">hashval2_1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">hashval1_1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">hashval1_2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rh</span><span class="p">));</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">);</span>
	<span class="n">napi_gro_receive</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num_rcr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rbr_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">blocks_per_page</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span> <span class="o">-</span> <span class="n">blocks_per_page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_rbr_add_page</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">index</span> <span class="o">+=</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_rbr_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RBR_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">base</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

			<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

			<span class="n">page</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">release_tx_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_buff_info</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_pkt_hdr</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tx_flags</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">TXHDR_LEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TXHDR_LEN_SHIFT</span><span class="p">)</span> <span class="o">-</span>
			 <span class="p">((</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">TXHDR_PAD</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
			      <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">TX_DESC_MARK</span><span class="p">)</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mark_pending</span><span class="o">--</span><span class="p">;</span>

	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">MAX_TX_DESC_LEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
				    <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NIU_TX_WAKEUP_THRESH(rp)		((rp)-&gt;pending / 4)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pkt_cnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cons</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cs</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">);</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_cs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_CS_MK</span> <span class="o">|</span> <span class="n">TX_CS_MMK</span><span class="p">))))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">pkt_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_PKT_CNT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TX_CS_PKT_CNT_SHIFT</span><span class="p">;</span>
	<span class="n">pkt_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_cnt</span> <span class="o">-</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">last_pkt_cnt</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">TX_CS_PKT_CNT</span> <span class="o">&gt;&gt;</span> <span class="n">TX_CS_PKT_CNT_SHIFT</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">last_pkt_cnt</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">cons</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">cons</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;%s() pkt_cnt[%u] cons[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pkt_cnt</span><span class="p">,</span> <span class="n">cons</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pkt_cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">cons</span> <span class="o">=</span> <span class="n">release_tx_packet</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">cons</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="n">cons</span><span class="p">;</span>
	<span class="n">smp_mb</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">niu_tx_avail</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NIU_TX_WAKEUP_THRESH</span><span class="p">(</span><span class="n">rp</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">niu_tx_avail</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NIU_TX_WAKEUP_THRESH</span><span class="p">(</span><span class="n">rp</span><span class="p">)))</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">niu_sync_rx_discard_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					     <span class="k">const</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This elaborate scheme is needed for reading the RX discard</span>
<span class="cm">	 * counters, as they are only 16-bit and can overflow quickly,</span>
<span class="cm">	 * and because the overflow indication bit is not usable as</span>
<span class="cm">	 * the counter value does not wrap, but remains at max value</span>
<span class="cm">	 * 0xFFFF.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In theory and in practice counters can be lost in between</span>
<span class="cm">	 * reading nr64() and clearing the counter nw64().  For this</span>
<span class="cm">	 * reason, the number of counter clearings nw64() is</span>
<span class="cm">	 * limited/reduced though the limit parameter.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">rx_channel</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc</span><span class="p">,</span> <span class="n">wred</span><span class="p">;</span>

	<span class="cm">/* RXMISC (Receive Miscellaneous Discard Count), covers the</span>
<span class="cm">	 * following discard events: IPP (Input Port Process),</span>
<span class="cm">	 * FFLP/TCAM, Full RCR (Receive Completion Ring) RBR (Receive</span>
<span class="cm">	 * Block Ring) prefetch buffer is empty.</span>
<span class="cm">	 */</span>
	<span class="n">misc</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RXMISC</span><span class="p">(</span><span class="n">rx_channel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">RXMISC_COUNT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">RXMISC</span><span class="p">(</span><span class="n">rx_channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">misc</span> <span class="o">&amp;</span> <span class="n">RXMISC_COUNT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">RXMISC_OFLOW</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;rx-%d: Counter overflow RXMISC discard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rx_channel</span><span class="p">);</span>

		<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;rx-%d: MISC drop=%u over=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">rx_channel</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">misc</span><span class="o">-</span><span class="n">limit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* WRED (Weighted Random Early Discard) by hardware */</span>
	<span class="n">wred</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RED_DIS_CNT</span><span class="p">(</span><span class="n">rx_channel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">wred</span> <span class="o">&amp;</span> <span class="n">RED_DIS_CNT_COUNT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">RED_DIS_CNT</span><span class="p">(</span><span class="n">rx_channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">wred</span> <span class="o">&amp;</span> <span class="n">RED_DIS_CNT_COUNT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wred</span> <span class="o">&amp;</span> <span class="n">RED_DIS_CNT_OFLOW</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;rx-%d: Counter overflow WRED discard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_channel</span><span class="p">);</span>

		<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;rx-%d: WRED drop=%u over=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">rx_channel</span><span class="p">,</span> <span class="n">wred</span><span class="p">,</span> <span class="n">wred</span><span class="o">-</span><span class="n">limit</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qlen</span><span class="p">,</span> <span class="n">rcr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxdma_mailbox</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat</span><span class="p">;</span>

<span class="cp">#if 1</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">));</span>
	<span class="n">qlen</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RCRSTAT_A</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RCRSTAT_A_QLEN</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">rx_dma_ctl_stat</span><span class="p">);</span>
	<span class="n">qlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">le64_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">rcrstat_a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCRSTAT_A_QLEN</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">rx_dma_ctl_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">rcrstat_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;%s(chan[%d]), stat[%llx] qlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">stat</span><span class="p">,</span> <span class="n">qlen</span><span class="p">);</span>

	<span class="n">rcr_done</span> <span class="o">=</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qlen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">qlen</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">qlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcr_done</span> <span class="o">+=</span> <span class="n">niu_process_rx_pkt</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">work_done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_refill_pending</span> <span class="o">&gt;=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_kick_thresh</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_refill_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">niu_rbr_refill</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_refill_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">RX_DMA_CTL_STAT_MEX</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">work_done</span> <span class="o">&lt;&lt;</span> <span class="n">RX_DMA_CTL_STAT_PKTREAD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rcr_done</span> <span class="o">&lt;&lt;</span> <span class="n">RX_DMA_CTL_STAT_PTRREAD_SHIFT</span><span class="p">));</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">),</span> <span class="n">stat</span><span class="p">);</span>

	<span class="cm">/* Only sync discards stats when qlen indicate potential for drops */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">niu_sync_rx_discard_stats</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_poll_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;%s() v0[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">v0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_vec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">))</span>
			<span class="n">niu_tx_work</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">LD_IM0</span><span class="p">(</span><span class="n">LDN_TXDMA</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_vec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">this_work_done</span><span class="p">;</span>

			<span class="n">this_work_done</span> <span class="o">=</span> <span class="n">niu_rx_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span>
						     <span class="n">budget</span><span class="p">);</span>

			<span class="n">budget</span> <span class="o">-=</span> <span class="n">this_work_done</span><span class="p">;</span>
			<span class="n">work_done</span> <span class="o">+=</span> <span class="n">this_work_done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">LD_IM0</span><span class="p">(</span><span class="n">LDN_RXDMA</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_ldg</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="n">niu_poll_core</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">niu_ldg_rearm</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_log_rxchan_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX channel %u errors ( &quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RBR_TMOUT</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RBR_TMOUT &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RSP_CNT_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RSP_CNT &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_BYTE_EN_BUS</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;BYTE_EN_BUS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RSP_DAT_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RSP_DAT &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RCR_ACK_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RCR_ACK &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RCR_SHA_PAR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RCR_SHA_PAR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RBR_PRE_PAR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RBR_PRE_PAR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_CONFIG_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CONFIG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RCRINCON</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RCRINCON &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RCRFULL</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RCRFULL &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RBRFULL</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RBRFULL &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_RBRLOGPAGE</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RBRLOGPAGE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_CFIGLOGPAGE</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CFIGLOGPAGE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_STAT_DC_FIFO_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;DC_FIDO &quot;</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_DMA_CTL_STAT_CHAN_FATAL</span> <span class="o">|</span>
		    <span class="n">RX_DMA_CTL_STAT_PORT_FATAL</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX channel %u error, stat[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat</span><span class="p">);</span>

		<span class="n">niu_log_rxchan_errors</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">),</span>
	     <span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RX_DMA_CTL_WRITE_CLEAR_ERRS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_log_txchan_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX channel %u errors ( &quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_MBOX_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;MBOX &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_PKT_SIZE_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;PKT_SIZE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_TX_RING_OFLOW</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;TX_RING_OFLOW &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_PREF_BUF_PAR_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;PREF_BUF_PAR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_NACK_PREF</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;NACK_PREF &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_NACK_PKT_RD</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;NACK_PKT_RD &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_CONF_PART_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CONF_PART &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&amp;</span> <span class="n">TX_CS_PKT_PRT_ERR</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;PKT_PTR &quot;</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_tx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cs</span><span class="p">,</span> <span class="n">logh</span><span class="p">,</span> <span class="n">logl</span><span class="p">;</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">));</span>
	<span class="n">logh</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_RNG_ERR_LOGH</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">));</span>
	<span class="n">logl</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_RNG_ERR_LOGL</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">));</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX channel %u error, cs[%llx] logh[%llx] logl[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">cs</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">logh</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">logl</span><span class="p">);</span>

	<span class="n">niu_log_txchan_errors</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_mif_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mif_status</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_STATUS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">phy_mdint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">xrxmac_stat</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XRXMAC_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xrxmac_stat</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_PHY_MDINT</span><span class="p">)</span>
			<span class="n">phy_mdint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MIF interrupt, stat[%llx] phy_mdint(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mif_status</span><span class="p">,</span> <span class="n">phy_mdint</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_xmac_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_xmac_stats</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">.</span><span class="n">xmac</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XTXMAC_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XTXMAC_STATUS_FRAME_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">+=</span> <span class="n">TXMAC_FRM_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XTXMAC_STATUS_BYTE_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">TXMAC_BYTE_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XTXMAC_STATUS_TXFIFO_XFR_ERR</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XTXMAC_STATUS_TXMAC_OFLOW</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_overflow_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XTXMAC_STATUS_MAX_PSIZE_ERR</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_max_pkt_size_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XTXMAC_STATUS_TXMAC_UFLOW</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_underflow_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XRXMAC_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_LCL_FLT_STATUS</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_local_faults</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RFLT_DET</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_remote_faults</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_LFLT_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_link_faults</span> <span class="o">+=</span> <span class="n">LINK_FAULT_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_ALIGNERR_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_align_errors</span> <span class="o">+=</span> <span class="n">RXMAC_ALIGN_ERR_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXFRAG_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_frags</span> <span class="o">+=</span> <span class="n">RXMAC_FRAG_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXMULTF_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_mcasts</span> <span class="o">+=</span> <span class="n">RXMAC_MC_FRM_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXBCAST_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_bcasts</span> <span class="o">+=</span> <span class="n">RXMAC_BC_FRM_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXBCAST_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_bcasts</span> <span class="o">+=</span> <span class="n">RXMAC_BC_FRM_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST1_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt1</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT1_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST2_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt2</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT2_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST3_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt3</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT3_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST4_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt4</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT4_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST5_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt5</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT5_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST6_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt6</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT6_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXHIST7_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt7</span> <span class="o">+=</span> <span class="n">RXMAC_HIST_CNT7_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXOCTET_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_octets</span> <span class="o">+=</span> <span class="n">RXMAC_BT_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_CVIOLERR_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_code_violations</span> <span class="o">+=</span> <span class="n">RXMAC_CD_VIO_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_LENERR_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_len_errors</span> <span class="o">+=</span> <span class="n">RXMAC_MPSZER_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_CRCERR_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">RXMAC_CRC_ER_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXUFLOW</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_underflows</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XRXMAC_STATUS_RXOFLOW</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_overflows</span><span class="o">++</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_FC_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XMAC_FC_STAT_TX_MAC_NPAUSE</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">pause_off_state</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XMAC_FC_STAT_TX_MAC_PAUSE</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">pause_on_state</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XMAC_FC_STAT_RX_MAC_RPAUSE</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">pause_received</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_bmac_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_bmac_stats</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">.</span><span class="n">bmac</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BTXMAC_STATUS_UNDERRUN</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_underflow_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BTXMAC_STATUS_MAX_PKT_ERR</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_max_pkt_size_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BTXMAC_STATUS_BYTE_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">BTXMAC_BYTE_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BTXMAC_STATUS_FRAME_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">+=</span> <span class="n">BTXMAC_FRM_CNT_COUNT</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BRXMAC_STATUS_OVERFLOW</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_overflows</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BRXMAC_STATUS_FRAME_CNT_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">+=</span> <span class="n">BRXMAC_FRAME_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BRXMAC_STATUS_ALIGN_ERR_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_align_errors</span> <span class="o">+=</span> <span class="n">BRXMAC_ALIGN_ERR_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BRXMAC_STATUS_CRC_ERR_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">BRXMAC_ALIGN_ERR_CNT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BRXMAC_STATUS_LEN_ERR_EXP</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_len_errors</span> <span class="o">+=</span> <span class="n">BRXMAC_CODE_VIOL_ERR_CNT_COUNT</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BMAC_CTRL_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMAC_CTRL_STATUS_NOPAUSE</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">pause_off_state</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMAC_CTRL_STATUS_PAUSE</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">pause_on_state</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMAC_CTRL_STATUS_PAUSE_RECV</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">pause_received</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_mac_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_xmac_interrupt</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_bmac_interrupt</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_log_device_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Core device errors ( &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_META2</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;META2 &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_META1</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;META1 &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_PEU</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;PEU &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_TXC</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;TXC &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_RDMC</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RDMC &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_TDMC</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;TDMC &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_ZCP</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;ZCP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_FFLP</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;FFLP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_IPP</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;IPP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_MAC</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;MAC &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SYS_ERR_MASK_SMX</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;SMX &quot;</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_device_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">SYS_ERR_STAT</span><span class="p">);</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Core device error, stat[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">stat</span><span class="p">);</span>

	<span class="n">niu_log_device_error</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_slowpath_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">v0</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v2</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rx_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rx_vec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">niu_rx_error</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v0</span><span class="p">)</span>
						<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">),</span>
						     <span class="n">RX_DMA_CTL_STAT_MEX</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff00000000ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tx_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tx_vec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">niu_tx_error</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">v0</span> <span class="o">|</span> <span class="n">v1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000000000000000ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">niu_mif_interrupt</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x01ef</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">niu_mac_interrupt</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x0210</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">niu_device_error</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_rxchan_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">ldn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxdma_mailbox</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat_write</span><span class="p">,</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">rx_dma_ctl_stat</span><span class="p">);</span>

	<span class="n">stat_write</span> <span class="o">=</span> <span class="p">(</span><span class="n">RX_DMA_CTL_STAT_RCRTHRES</span> <span class="o">|</span>
		      <span class="n">RX_DMA_CTL_STAT_RCRTO</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">),</span> <span class="n">stat_write</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;%s() stat[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_txchan_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">ldn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_cs</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">));</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;%s() cs[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__niu_fastpath_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ldg</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_vec</span><span class="p">,</span> <span class="n">tx_vec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tx_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rx_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ldn</span> <span class="o">=</span> <span class="n">LDN_RXDMA</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ldg_map</span><span class="p">[</span><span class="n">ldn</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ldg</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">nw64</span><span class="p">(</span><span class="n">LD_IM0</span><span class="p">(</span><span class="n">ldn</span><span class="p">),</span> <span class="n">LD_IM0_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_vec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">))</span>
			<span class="n">niu_rxchan_intr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">ldn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ldn</span> <span class="o">=</span> <span class="n">LDN_TXDMA</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ldg_map</span><span class="p">[</span><span class="n">ldn</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ldg</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">nw64</span><span class="p">(</span><span class="n">LD_IM0</span><span class="p">(</span><span class="n">ldn</span><span class="p">),</span> <span class="n">LD_IM0_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_vec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">))</span>
			<span class="n">niu_txchan_intr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">ldn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_schedule_napi</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">v0</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
		<span class="n">__niu_fastpath_interrupt</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ldg_num</span><span class="p">,</span> <span class="n">v0</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">niu_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ldg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ldg_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: &quot;</span> <span class="s">&quot;%s() ldg[%p](%d)&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">ldg</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">v0</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">LDSV0</span><span class="p">(</span><span class="n">ldg</span><span class="p">));</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">LDSV1</span><span class="p">(</span><span class="n">ldg</span><span class="p">));</span>
	<span class="n">v2</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">LDSV2</span><span class="p">(</span><span class="n">ldg</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; v0[%llx] v1[%llx] v2[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">v0</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">v1</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">v0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">v1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">v2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LDN_MIF</span><span class="p">))</span> <span class="o">||</span> <span class="n">v1</span> <span class="o">||</span> <span class="n">v2</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">niu_slowpath_interrupt</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LDN_MIF</span><span class="p">)))</span>
		<span class="n">niu_schedule_napi</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_ldg_rearm</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_free_rx_ring_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxdma_mailbox</span><span class="p">),</span>
				       <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				       <span class="n">MAX_RCR_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">),</span>
				       <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_dma</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_table_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">niu_rbr_free</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				       <span class="n">MAX_RBR_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">),</span>
				       <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_dma</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_free_tx_ring_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txdma_mailbox</span><span class="p">),</span>
				       <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">release_tx_packet</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				       <span class="n">MAX_TX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">),</span>
				       <span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr_dma</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">wrap_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_free_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">niu_free_rx_ring_info</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">niu_free_tx_ring_info</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_alloc_rx_ring_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxdma_mailbox</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">MAX_RBR_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span>
			     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxdma_mailbox</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64UL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Coherent alloc gives misaligned RXDMA mailbox %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					  <span class="n">MAX_RCR_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64UL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Coherent alloc gives misaligned RXDMA RCR table %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_table_size</span> <span class="o">=</span> <span class="n">MAX_RCR_RING_SIZE</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					  <span class="n">MAX_RBR_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64UL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Coherent alloc gives misaligned RXDMA RBR table %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span> <span class="o">=</span> <span class="n">MAX_RBR_RING_SIZE</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_set_max_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="cm">/* These values are recommended by the HW designers for fair</span>
<span class="cm">	 * utilization of DRR amongst the rings.</span>
<span class="cm">	 */</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">=</span> <span class="n">mtu</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_alloc_tx_ring_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txdma_mailbox</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txdma_mailbox</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64UL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Coherent alloc gives misaligned TXDMA mailbox %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_coherent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					    <span class="n">MAX_TX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64UL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Coherent alloc gives misaligned TXDMA descr table %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">MAX_TX_RING_SIZE</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">wrap_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* XXX make these configurable... XXX */</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mark_freq</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">niu_set_max_burst</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_size_rbr</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bss</span><span class="p">;</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_block_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bss</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="n">bss</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>:
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_block_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_alloc_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_rx_channel</span><span class="p">,</span> <span class="n">first_tx_channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rx_rings</span><span class="p">,</span> <span class="n">num_tx_rings</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rx_rings</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">tx_rings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">first_rx_channel</span> <span class="o">=</span> <span class="n">first_tx_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_rx_channel</span> <span class="o">+=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">first_tx_channel</span> <span class="o">+=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">num_rx_rings</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">num_tx_rings</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="n">rx_rings</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num_rx_rings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_info</span><span class="p">),</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_rings</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span> <span class="o">=</span> <span class="n">num_rx_rings</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span> <span class="o">=</span> <span class="n">rx_rings</span><span class="p">;</span>

	<span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">num_rx_rings</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span> <span class="o">=</span> <span class="n">first_rx_channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_alloc_rx_ring_info</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="n">niu_size_rbr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>

		<span class="cm">/* XXX better defaults, configurable, etc... XXX */</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">nonsyn_window</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">nonsyn_threshold</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_table_size</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">syn_window</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">syn_threshold</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_table_size</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_pkt_threshold</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_timeout</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_kick_thresh</span> <span class="o">=</span> <span class="n">RBR_REFILL_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_kick_thresh</span> <span class="o">&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span><span class="p">)</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_kick_thresh</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_blocks_per_page</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_rbr_fill</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_rings</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num_tx_rings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_ring_info</span><span class="p">),</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_rings</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span> <span class="o">=</span> <span class="n">num_tx_rings</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span> <span class="o">=</span> <span class="n">tx_rings</span><span class="p">;</span>

	<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">num_tx_rings</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span> <span class="o">=</span> <span class="n">first_tx_channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_alloc_tx_ring_info</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">niu_free_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_tx_cs_sng_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TX_CS_SNG_STATE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_tx_channel_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">TX_CS_STOP_N_GO</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">niu_tx_cs_sng_poll</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_tx_cs_reset_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TX_CS_RST</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_tx_channel_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">TX_CS_RST</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_tx_cs_reset_poll</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">TX_RING_KICK</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_tx_channel_lpage_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_MASK1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_VAL1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_MASK2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_VAL2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_PAGE_RELO1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_PAGE_RELO2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_PAGE_HDL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LOG_PAGE_VLD_FUNC_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TX_LOG_PAGE_VLD_PAGE0</span> <span class="o">|</span> <span class="n">TX_LOG_PAGE_VLD_PAGE1</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_LOG_PAGE_VLD</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* XXX TXDMA 32bit mode? XXX */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_txc_enable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TXC_CONTROL</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TXC_CONTROL_ENABLE</span> <span class="o">|</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXC_CONTROL_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXC_CONTROL_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TXC_CONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_txc_set_imask</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">imask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">TXC_INT_MASK</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXC_INT_MASK_VAL</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">imask</span> <span class="o">&lt;&lt;</span> <span class="n">TXC_INT_MASK_VAL_SHIFT</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_txc_port_dma_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TXC_PORT_DMA</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_one_tx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">ring_len</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_tx_channel_stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_tx_channel_reset</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_tx_channel_lpage_init</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">TXC_DMA_MAX</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_burst</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_ENT_MSK</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr_dma</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TX_RNG_CFIG_STADDR_BASE</span> <span class="o">|</span>
			      <span class="n">TX_RNG_CFIG_STADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX ring channel %d DMA addr (%llx) is not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The length field in TX_RNG_CFIG is measured in 64-byte</span>
<span class="cm">	 * blocks.  rp-&gt;pending is the number of TX descriptors in</span>
<span class="cm">	 * our ring, 8 bytes each, thus we divide by 8 bytes more</span>
<span class="cm">	 * to get the proper value the chip wants.</span>
<span class="cm">	 */</span>
	<span class="n">ring_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">ring_len</span> <span class="o">&lt;&lt;</span> <span class="n">TX_RNG_CFIG_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr_dma</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_RNG_CFIG</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXDMA_MBH_MBADDR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXDMA_MBL_MBADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX ring channel %d MBOX addr (%llx) has invalid bits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TXDMA_MBH</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">TXDMA_MBL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span> <span class="o">&amp;</span> <span class="n">TXDMA_MBL_MBADDR</span><span class="p">);</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_CS</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">last_pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_rdc_groups</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_rdc_tables</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_group_cfg</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">first_table_num</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_table_num</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">num_tables</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rdc_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">this_table</span> <span class="o">=</span> <span class="n">first_table_num</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">NIU_RDC_TABLE_SLOTS</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span>
			<span class="n">nw64</span><span class="p">(</span><span class="n">RDC_TBL</span><span class="p">(</span><span class="n">this_table</span><span class="p">,</span> <span class="n">slot</span><span class="p">),</span>
			     <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rxdma_channel</span><span class="p">[</span><span class="n">slot</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">DEF_RDC</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_default</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_drr_weight</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">phy_decode</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_TYPE_10G</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PT_DRR_WEIGHT_DEFAULT_10G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PORT_TYPE_1G</span>:
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PT_DRR_WEIGHT_DEFAULT_1G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">PT_DRR_WT</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_hostinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_rdc_tables</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_group_cfg</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">num_alt</span> <span class="o">=</span> <span class="n">niu_num_alt_addr</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">first_rdc_table</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_table_num</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_primary_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_multicast_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_alt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_alt_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rx_channel_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">niu_set_and_wait_clear</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">RXDMA_CFIG1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
				      <span class="n">RXDMA_CFIG1_RST</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
				      <span class="s">&quot;RXDMA_CFIG1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_rx_channel_lpage_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_MASK1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_VAL1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_MASK2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_VAL2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_PAGE_RELO1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_PAGE_RELO2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_PAGE_HDL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="n">RX_LOG_PAGE_VLD_FUNC_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RX_LOG_PAGE_VLD_PAGE0</span> <span class="o">|</span> <span class="n">RX_LOG_PAGE_VLD_PAGE1</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_LOG_PAGE_VLD</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_rx_channel_wred_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">nonsyn_window</span> <span class="o">&lt;&lt;</span> <span class="n">RDC_RED_PARA_WIN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">nonsyn_threshold</span> <span class="o">&lt;&lt;</span> <span class="n">RDC_RED_PARA_THRE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">syn_window</span> <span class="o">&lt;&lt;</span> <span class="n">RDC_RED_PARA_WIN_SYN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">syn_threshold</span> <span class="o">&lt;&lt;</span> <span class="n">RDC_RED_PARA_THRE_SYN_SHIFT</span><span class="p">));</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RDC_RED_PARA</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_compute_rbr_cfig_b</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_block_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BLKSIZE_4K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BLKSIZE_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BLKSIZE_8K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BLKSIZE_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BLKSIZE_16K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BLKSIZE_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BLKSIZE_32K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BLKSIZE_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">RBR_CFIG_B_VLD2</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ2_2K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ2_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ2_4K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ2_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ2_8K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ2_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ2_16K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ2_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">RBR_CFIG_B_VLD1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ1_1K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ1_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ1_2K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ1_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ1_4K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ1_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ1_8K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ1_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">RBR_CFIG_B_VLD0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ0_256</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ0_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ0_512</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ0_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ0_1K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ0_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RBR_BUFSZ0_2K</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_B_BUFSZ0_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_enable_rx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RXDMA_CFIG1</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RXDMA_CFIG1_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXDMA_CFIG1_EN</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RXDMA_CFIG1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr64</span><span class="p">(</span><span class="n">RXDMA_CFIG1</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RXDMA_CFIG1_QST</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_one_rx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_rx_channel_reset</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_rx_channel_lpage_init</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">niu_rx_channel_wred_init</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_ENT_MSK</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">RX_DMA_ENT_MSK_RBR_EMPTY</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
	     <span class="p">(</span><span class="n">RX_DMA_CTL_STAT_MEX</span> <span class="o">|</span>
	      <span class="n">RX_DMA_CTL_STAT_RCRTHRES</span> <span class="o">|</span>
	      <span class="n">RX_DMA_CTL_STAT_RCRTO</span> <span class="o">|</span>
	      <span class="n">RX_DMA_CTL_STAT_RBR_EMPTY</span><span class="p">));</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RXDMA_CFIG1</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RXDMA_CFIG2</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
	     <span class="p">((</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mbox_dma</span> <span class="o">&amp;</span> <span class="n">RXDMA_CFIG2_MBADDR_L</span><span class="p">)</span> <span class="o">|</span>
	      <span class="n">RXDMA_CFIG2_FULL_HDR</span><span class="p">));</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RBR_CFIG_A</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span> <span class="o">&lt;&lt;</span> <span class="n">RBR_CFIG_A_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_dma</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RBR_CFIG_A_STADDR_BASE</span> <span class="o">|</span> <span class="n">RBR_CFIG_A_STADDR</span><span class="p">)));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_compute_rbr_cfig_b</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RBR_CFIG_B</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RCRCFIG_A</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_table_size</span> <span class="o">&lt;&lt;</span> <span class="n">RCRCFIG_A_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_dma</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RCRCFIG_A_STADDR_BASE</span> <span class="o">|</span> <span class="n">RCRCFIG_A_STADDR</span><span class="p">)));</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RCRCFIG_B</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_pkt_threshold</span> <span class="o">&lt;&lt;</span> <span class="n">RCRCFIG_B_PTHRES_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">RCRCFIG_B_ENTOUT</span> <span class="o">|</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_timeout</span> <span class="o">&lt;&lt;</span> <span class="n">RCRCFIG_B_TIMEOUT_SHIFT</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_rx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">RBR_KICK</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">RX_DMA_CTL_STAT_RBR_EMPTY</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_rx_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">jiffies_64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CK_DIV</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxdma_clock_divider</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RED_RAN_INIT</span><span class="p">,</span> <span class="n">RED_RAN_INIT_OPMODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">seed</span> <span class="o">&amp;</span> <span class="n">RED_RAN_INIT_VAL</span><span class="p">));</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* XXX RXDMA 32bit mode? XXX */</span>

	<span class="n">niu_init_rdc_groups</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">niu_init_drr_weight</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_hostinfo</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_one_rx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_ip_frag_rule</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_classifier</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">tcam_top</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* Note that the noport bit is the same in both ipv4 and</span>
<span class="cm">	 * ipv6 format TCAM entries.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TCAM_V4KEY1_NOPORT</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TCAM_V4KEY1_NOPORT</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCAM_ASSOCDATA_TRES_USE_OFFSET</span> <span class="o">|</span>
			  <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">TCAM_ASSOCDATA_OFFSET_SHIFT</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_assoc_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">tcam_valid_entries</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_classifier_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_classifier</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">H1POLY</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">h1_init</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">H2POLY</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">h2_init</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_hostinfo</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENET_VLAN_TBL_NUM_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_vlan_rdc</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vlan_mappings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">vlan_tbl_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			       <span class="n">vp</span><span class="o">-&gt;</span><span class="n">vlan_pref</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rdc_num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">num_alt_mac_mappings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_altmac_rdc</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">alt_mac_mappings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_alt_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">alt_mac_num</span><span class="p">,</span>
						<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rdc_num</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_pref</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">CLASS_CODE_SCTP_IPV6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_tcam_key</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_flow_key</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">flow_key</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_ip_frag_rule</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tcam_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_zcp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_BE</span><span class="p">,</span> <span class="n">ZCP_RAM_BE_VAL</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_ACC</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">ZCP_RAM_ACC_WRITE</span> <span class="o">|</span>
	      <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">ZCP_RAM_ACC_ZFCID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ZCP_RAM_SEL_CFIFO</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ZCP_RAM_ACC_RAM_SEL_SHIFT</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">niu_wait_bits_clear</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ZCP_RAM_ACC</span><span class="p">,</span> <span class="n">ZCP_RAM_ACC_BUSY</span><span class="p">,</span>
				   <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_zcp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_wait_bits_clear</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ZCP_RAM_ACC</span><span class="p">,</span> <span class="n">ZCP_RAM_ACC_BUSY</span><span class="p">,</span>
				  <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ZCP read busy won&#39;t clear, ZCP_RAM_ACC[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_ACC</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_RAM_ACC</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">ZCP_RAM_ACC_READ</span> <span class="o">|</span>
	      <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">ZCP_RAM_ACC_ZFCID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ZCP_RAM_SEL_CFIFO</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ZCP_RAM_ACC_RAM_SEL_SHIFT</span><span class="p">)));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_wait_bits_clear</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ZCP_RAM_ACC</span><span class="p">,</span> <span class="n">ZCP_RAM_ACC_BUSY</span><span class="p">,</span>
				  <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ZCP read busy2 won&#39;t clear, ZCP_RAM_ACC[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_ACC</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA0</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA1</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA2</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA3</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_RAM_DATA4</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_zcp_cfifo_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">RESET_CFIFO</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">RESET_CFIFO_RST</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RESET_CFIFO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RESET_CFIFO_RST</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RESET_CFIFO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_zcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">!=</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">ATLAS_P0_P1_CFIFO_ENTRIES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">ATLAS_P2_P3_CFIFO_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">NIU_CFIFO_ENTRIES</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_zcp_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_zcp_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">niu_zcp_cfifo_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">CFIFO_ECC</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_INT_STAT</span><span class="p">,</span> <span class="n">ZCP_INT_STAT_ALL</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ZCP_INT_STAT</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ZCP_INT_MASK</span><span class="p">,</span> <span class="n">ZCP_INT_MASK_ALL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_ipp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">);</span>

	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">IPP_CFIG_DFIFO_PIO_W</span><span class="p">);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR_PTR</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IPP_CFIG_DFIFO_PIO_W</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_ipp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD_PTR</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD0</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD1</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD2</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD3</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_ipp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">niu_set_and_wait_clear_ipp</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">IPP_CFIG</span><span class="p">,</span> <span class="n">IPP_CFIG_SOFT_RST</span><span class="p">,</span>
					  <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">&quot;IPP_CFIG&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_ipp</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">!=</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">ATLAS_P0_P1_DFIFO_ENTRIES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">ATLAS_P2_P3_DFIFO_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">NIU_DFIFO_ENTRIES</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">niu_ipp_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">niu_ipp_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_INT_STAT</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_INT_STAT</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ipp_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_PKT_DIS</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_BAD_CS_CNT</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_ECC</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_INT_STAT</span><span class="p">);</span>

	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_MSK</span><span class="p">,</span> <span class="o">~</span><span class="n">IPP_MSK_ALL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPP_CFIG_IP_MAX_PKT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IPP_CFIG_IPP_ENABLE</span> <span class="o">|</span>
		<span class="n">IPP_CFIG_DFIFO_ECC_EN</span> <span class="o">|</span>
		<span class="n">IPP_CFIG_DROP_BAD_CRC</span> <span class="o">|</span>
		<span class="n">IPP_CFIG_CKSUM_EN</span> <span class="o">|</span>
		<span class="p">(</span><span class="mh">0x1ffff</span> <span class="o">&lt;&lt;</span> <span class="n">IPP_CFIG_IP_MAX_PKT_SHIFT</span><span class="p">));</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_handle_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_LED_POLARITY</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_FORCE_LED_ON</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_FORCE_LED_ON</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_LED_POLARITY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_xif_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MIF_CONFIG_ATCA_GE</span><span class="p">;</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">MIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_SEL_POR_CLK_SRC</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_TX_OUTPUT_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_MAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_SEL_POR_CLK_SRC</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_LOOPBACK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_LOOPBACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_LFS_DISABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_LFS_DISABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_1G_PCS_BYPASS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_1G_PCS_BYPASS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_10G_XPCS_BYPASS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_SEL_CLK_25MHZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_SEL_CLK_25MHZ</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_MODE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_MODE_XGMII</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_MODE_GMII</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_MODE_MII</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_xif_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">BMAC_XIF_CONFIG_TX_OUTPUT_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_MAC</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BMAC_XIF_CONFIG_MII_LOOPBACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMAC_XIF_CONFIG_MII_LOOPBACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BMAC_XIF_CONFIG_GMII_MODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMAC_XIF_CONFIG_GMII_MODE</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMAC_XIF_CONFIG_LINK_LED</span> <span class="o">|</span>
		 <span class="n">BMAC_XIF_CONFIG_LED_POLARITY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BMAC_XIF_CONFIG_25MHZ_CLOCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMAC_XIF_CONFIG_25MHZ_CLOCK</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_XIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_xif</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_init_xif_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_init_xif_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_pcs_mii_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_pcs</span><span class="p">(</span><span class="n">PCS_MII_CTL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">PCS_MII_CTL_RST</span><span class="p">;</span>
	<span class="n">nw64_pcs</span><span class="p">(</span><span class="n">PCS_MII_CTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCS_MII_CTL_RST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_pcs</span><span class="p">(</span><span class="n">PCS_MII_CTL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_xpcs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_xpcs</span><span class="p">(</span><span class="n">XPCS_CONTROL1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">XPCS_CONTROL1_RESET</span><span class="p">;</span>
	<span class="n">nw64_xpcs</span><span class="p">(</span><span class="n">XPCS_CONTROL1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">XPCS_CONTROL1_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_xpcs</span><span class="p">(</span><span class="n">XPCS_CONTROL1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_pcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span>
			     <span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			     <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NIU_FLAGS_FIBER</span>:
		<span class="cm">/* 1G fiber */</span>
		<span class="n">nw64_pcs</span><span class="p">(</span><span class="n">PCS_CONF</span><span class="p">,</span> <span class="n">PCS_CONF_MASK</span> <span class="o">|</span> <span class="n">PCS_CONF_ENABLE</span><span class="p">);</span>
		<span class="n">nw64_pcs</span><span class="p">(</span><span class="n">PCS_DPATH_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">niu_pcs_mii_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span>:
	<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span>:
	<span class="k">case</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span>:
		<span class="cm">/* 10G SERDES */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* 10G copper or fiber */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_10G_XPCS_BYPASS</span><span class="p">;</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">niu_xpcs_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_xpcs</span><span class="p">(</span><span class="n">XPCS_CONTROL1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHY</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">XPCS_CONTROL1_LOOPBACK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPCS_CONTROL1_LOOPBACK</span><span class="p">;</span>
		<span class="n">nw64_xpcs</span><span class="p">(</span><span class="n">XPCS_CONTROL1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">nw64_xpcs</span><span class="p">(</span><span class="n">XPCS_DESKEW_ERR_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_xpcs</span><span class="p">(</span><span class="n">XPCS_SYMERR_CNT01</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nr64_xpcs</span><span class="p">(</span><span class="n">XPCS_SYMERR_CNT23</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span>:
		<span class="cm">/* 1G SERDES */</span>
		<span class="n">niu_pcs_mii_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">nw64_pcs</span><span class="p">(</span><span class="n">PCS_CONF</span><span class="p">,</span> <span class="n">PCS_CONF_MASK</span> <span class="o">|</span> <span class="n">PCS_CONF_ENABLE</span><span class="p">);</span>
		<span class="n">nw64_pcs</span><span class="p">(</span><span class="n">PCS_DPATH_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* 1G copper */</span>
	<span class="k">case</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span>:
		<span class="cm">/* 1G RGMII FIBER */</span>
		<span class="n">nw64_pcs</span><span class="p">(</span><span class="n">PCS_DPATH_MODE</span><span class="p">,</span> <span class="n">PCS_DPATH_MODE_MII</span><span class="p">);</span>
		<span class="n">niu_pcs_mii_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_reset_tx_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">niu_set_and_wait_clear_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">XTXMAC_SW_RST</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">XTXMAC_SW_RST_REG_RS</span> <span class="o">|</span>
					   <span class="n">XTXMAC_SW_RST_SOFT_RST</span><span class="p">),</span>
					  <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">&quot;XTXMAC_SW_RST&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_reset_tx_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BTXMAC_SW_RST</span><span class="p">,</span> <span class="n">BTXMAC_SW_RST_RESET</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_SW_RST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BTXMAC_SW_RST_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Port %u TX BMAC would not reset, BTXMAC_SW_RST[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_SW_RST</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_reset_tx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">niu_reset_tx_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">niu_reset_tx_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_tx_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">min</span><span class="p">,</span> <span class="n">u64</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_MIN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XMAC_MIN_TX_MIN_PKT_SIZE</span> <span class="o">|</span>
		 <span class="n">XMAC_MIN_RX_MIN_PKT_SIZE</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;&lt;</span> <span class="n">XMAC_MIN_RX_MIN_PKT_SIZE_SHFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;&lt;</span> <span class="n">XMAC_MIN_TX_MIN_PKT_SIZE_SHFT</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_MIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_MAX</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XTXMAC_STAT_MSK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_IPG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_IPG_IPG_XGMII</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IPG_12_15_XGMII</span> <span class="o">&lt;&lt;</span> <span class="n">XMAC_IPG_IPG_XGMII_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_IPG_IPG_MII_GMII</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IPG_12_MII_GMII</span> <span class="o">&lt;&lt;</span> <span class="n">XMAC_IPG_IPG_MII_GMII_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_IPG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XMAC_CONFIG_ALWAYS_NO_CRC</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_STRETCH_MODE</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_VAR_MIN_IPG_EN</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_TX_ENABLE</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">TXMAC_FRM_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">TXMAC_BYTE_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_tx_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">min</span><span class="p">,</span> <span class="n">u64</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_MIN_FRAME</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_MAX_FRAME</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BTXMAC_STATUS_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_CTRL_TYPE</span><span class="p">,</span> <span class="mh">0x8808</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_PREAMBLE_SIZE</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BTXMAC_CONFIG_FCS_DISABLE</span> <span class="o">|</span>
		 <span class="n">BTXMAC_CONFIG_ENABLE</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BTXMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_tx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">min</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">9216</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">1522</span><span class="p">;</span>

	<span class="cm">/* The XMAC_MIN register only accepts values for TX min which</span>
<span class="cm">	 * have the low 3 bits cleared.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">min</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_init_tx_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_init_tx_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_reset_rx_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XRXMAC_SW_RST</span><span class="p">,</span>
		 <span class="n">XRXMAC_SW_RST_REG_RS</span> <span class="o">|</span> <span class="n">XRXMAC_SW_RST_SOFT_RST</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nr64_mac</span><span class="p">(</span><span class="n">XRXMAC_SW_RST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XRXMAC_SW_RST_REG_RS</span> <span class="o">|</span>
						 <span class="n">XRXMAC_SW_RST_SOFT_RST</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Port %u RX XMAC would not reset, XRXMAC_SW_RST[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XRXMAC_SW_RST</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_reset_rx_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BRXMAC_SW_RST</span><span class="p">,</span> <span class="n">BRXMAC_SW_RST_RESET</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_SW_RST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BRXMAC_SW_RST_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Port %u RX BMAC would not reset, BRXMAC_SW_RST[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_SW_RST</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_reset_rx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">niu_reset_rx_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">niu_reset_rx_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_rx_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_rdc_tables</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_group_cfg</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">first_rdc_table</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_table_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADD_FILT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADD_FILT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADD_FILT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADD_FILT12_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_ADD_FILT00_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAC_NUM_HASH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_HASH_TBL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XRXMAC_STAT_MSK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">niu_set_primary_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">niu_set_multicast_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XMAC_CONFIG_RX_MAC_ENABLE</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_PROMISCUOUS</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_PROMISC_GROUP</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_ERR_CHK_DIS</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_RX_CRC_CHK_DIS</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_RESERVED_MULTICAST</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_RX_CODEV_CHK_DIS</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_ADDR_FILTER_EN</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_RCV_PAUSE_ENABLE</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_STRIP_CRC</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_PASS_FLOW_CTRL</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_MAC2IPP_PKT_CNT_EN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XMAC_CONFIG_HASH_FILTER_EN</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_BT_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_BC_FRM_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_MC_FRM_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_FRAG_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_MPSZER_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_CRC_ER_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">RXMAC_CD_VIO_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">LINK_FAULT_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_rx_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_rdc_tables</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_group_cfg</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">first_rdc_table</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_table_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADD_FILT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADD_FILT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADD_FILT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADD_FILT12_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADD_FILT00_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAC_NUM_HASH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_HASH_TBL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">niu_set_primary_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">niu_set_multicast_mac_rdc_table</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">first_rdc_table</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BRXMAC_STATUS_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRXMAC_CONFIG_ENABLE</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_STRIP_PAD</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_STRIP_FCS</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_PROMISC</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_PROMISC_GRP</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_ADDR_FILT_EN</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_DISCARD_DIS</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BRXMAC_CONFIG_HASH_FILT_EN</span><span class="p">);</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BRXMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BMAC_ADDR_CMPEN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">BMAC_ADDR_CMPEN_EN0</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_ADDR_CMPEN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_init_rx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">niu_set_primary_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_init_rx_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_init_rx_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_tx_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_TX_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_TX_ENABLE</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_tx_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_CONFIG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BTXMAC_CONFIG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BTXMAC_CONFIG_ENABLE</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BTXMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_tx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_enable_tx_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_enable_tx_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_rx_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XMAC_CONFIG_HASH_FILTER_EN</span> <span class="o">|</span>
		 <span class="n">XMAC_CONFIG_PROMISCUOUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_MCAST</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_HASH_FILTER_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_PROMISC</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_PROMISCUOUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CONFIG_RX_MAC_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_CONFIG_RX_MAC_ENABLE</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_rx_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_CONFIG</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRXMAC_CONFIG_HASH_FILT_EN</span> <span class="o">|</span>
		 <span class="n">BRXMAC_CONFIG_PROMISC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_MCAST</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BRXMAC_CONFIG_HASH_FILT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_PROMISC</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BRXMAC_CONFIG_PROMISC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BRXMAC_CONFIG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BRXMAC_CONFIG_ENABLE</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BRXMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_rx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_enable_rx_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_enable_rx_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">niu_init_xif</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_pcs</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_reset_tx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">niu_init_tx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_reset_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">niu_init_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="cm">/* This looks hookey but the RX MAC reset we just did will</span>
<span class="cm">	 * undo some of the state we setup in niu_init_tx_mac() so we</span>
<span class="cm">	 * have to call it again.  In particular, the RX MAC reset will</span>
<span class="cm">	 * set the XMAC_MAX register back to it&#39;s default value.</span>
<span class="cm">	 */</span>
	<span class="n">niu_init_tx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">niu_enable_tx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">niu_enable_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_stop_one_tx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">niu_tx_channel_stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_stop_tx_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">niu_stop_one_tx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_reset_one_tx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">niu_tx_channel_reset</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_reset_tx_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">niu_reset_one_tx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_stop_one_rx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">niu_enable_rx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_stop_rx_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">niu_stop_one_rx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_reset_one_rx_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">niu_rx_channel_reset</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_ENT_MSK</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">RX_DMA_ENT_MSK_ALL</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">RX_DMA_CTL_STAT</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">niu_enable_rx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_reset_rx_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">niu_reset_one_rx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_disable_ipp</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">rd</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">rd</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD_PTR</span><span class="p">);</span>
	<span class="n">wr</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR_PTR</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="n">wr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD_PTR</span><span class="p">);</span>
		<span class="n">wr</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR_PTR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wr</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IPP would not quiesce, rd_ptr[%llx] wr_ptr[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_RD_PTR</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_DFIFO_WR_PTR</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPP_CFIG_IPP_ENABLE</span> <span class="o">|</span>
		 <span class="n">IPP_CFIG_DFIFO_ECC_EN</span> <span class="o">|</span>
		 <span class="n">IPP_CFIG_DROP_BAD_CRC</span> <span class="o">|</span>
		 <span class="n">IPP_CFIG_CKSUM_EN</span><span class="p">);</span>
	<span class="n">nw64_ipp</span><span class="p">(</span><span class="n">IPP_CFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">niu_ipp_reset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize TXC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_txc_enable_port</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">niu_txc_port_dma_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">niu_txc_set_imask</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize TX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_one_tx_channel</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize RX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_rx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_uninit_tx_channels</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize classifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_classifier_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_uninit_rx_channels</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize ZCP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_zcp</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_uninit_rx_channels</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize IPP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_ipp</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_uninit_rx_channels</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialize MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_mac</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_uninit_ipp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_uninit_ipp:</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Uninit IPP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_disable_ipp</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

<span class="nl">out_uninit_rx_channels:</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Uninit RX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_stop_rx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">niu_reset_rx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

<span class="nl">out_uninit_tx_channels:</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Uninit TX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_stop_tx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">niu_reset_tx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_stop_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disable interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disable RX MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_enable_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disable IPP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_disable_ipp</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Stop TX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_stop_tx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Stop RX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_stop_rx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset TX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_reset_tx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset RX channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">niu_reset_rx_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_set_irq_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;%s:MAC&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;%s:MIF&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;%s:SYSERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;%s-rx-%d&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;%s-tx-%d&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">niu_set_irq_name</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">niu_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">np</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_irqs</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_irqs:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_enable_napi</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_disable_napi</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_alloc_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_channels</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_request_irq</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_channels</span><span class="p">;</span>

	<span class="n">niu_enable_napi</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">np</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">niu_timer</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">niu_stop_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">niu_disable_napi</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">!=</span> <span class="n">LOOPBACK_DISABLED</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_irq:</span>
	<span class="n">niu_free_irq</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

<span class="nl">out_free_channels:</span>
	<span class="n">niu_free_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_full_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>

	<span class="n">niu_disable_napi</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">niu_stop_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">niu_full_shutdown</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">niu_free_irq</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">niu_free_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">niu_handle_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_sync_xmac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_xmac_stats</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">.</span><span class="n">xmac</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">TXMAC_FRM_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">TXMAC_BYTE_CNT</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_link_faults</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">LINK_FAULT_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_align_errors</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_ALIGN_ERR_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_frags</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_FRAG_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_mcasts</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_MC_FRM_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_bcasts</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_BC_FRM_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt1</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT1</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt2</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT2</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt3</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT3</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt4</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT4</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt5</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT5</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt6</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT6</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_hist_cnt7</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_HIST_CNT7</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_octets</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_BT_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_code_violations</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_CD_VIO_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_len_errors</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_MPSZER_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">RXMAC_CRC_ER_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_sync_bmac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_bmac_stats</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">.</span><span class="n">bmac</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_BYTE_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BTXMAC_FRM_CNT</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_FRAME_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_align_errors</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_ALIGN_ERR_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_ALIGN_ERR_CNT</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_len_errors</span> <span class="o">+=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BRXMAC_CODE_VIOL_ERR_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_sync_mac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_sync_xmac_stats</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_sync_bmac_stats</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_rx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">dropped</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rx_rings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pkts</span> <span class="o">=</span> <span class="n">dropped</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rx_rings</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_rings</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_rings</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">niu_sync_rx_discard_stats</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">pkts</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
		<span class="n">dropped</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>
		<span class="n">errors</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">no_rings:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">pkts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">dropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_tx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">tx_rings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pkts</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx_rings</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_rings</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_rings</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">pkts</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
		<span class="n">errors</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">no_rings:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">pkts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">niu_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">niu_get_rx_stats</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
		<span class="n">niu_get_tx_stats</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_load_hash_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_HASH_TBL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_load_hash_bmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_HASH_TBL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_load_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">niu_load_hash_xmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_load_hash_bmac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">alt_cnt</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hash</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">niu_enable_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NIU_FLAGS_MCAST</span> <span class="o">|</span> <span class="n">NIU_FLAGS_PROMISC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_PROMISC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_MCAST</span><span class="p">;</span>

	<span class="n">alt_cnt</span> <span class="o">=</span> <span class="n">netdev_uc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alt_cnt</span> <span class="o">&gt;</span> <span class="n">niu_num_alt_addr</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">alt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_PROMISC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">netdev_for_each_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_alt_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error %d adding alt mac %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">err</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_alt_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error %d enabling alt mac %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">err</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">alt_start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
			<span class="n">alt_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">alt_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">alt_start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niu_num_alt_addr</span><span class="p">(</span><span class="n">np</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_alt_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error %d disabling alt mac %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

			<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">hash</span><span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_MCAST</span><span class="p">)</span>
		<span class="n">niu_load_hash</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>

	<span class="n">niu_enable_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">niu_enable_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">niu_set_primary_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">niu_enable_rx_mac</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_netif_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>	<span class="cm">/* prevent tx timeout */</span>

	<span class="n">niu_disable_napi</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_netif_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NOTE: unconditional netif_wake_queue is only appropriate</span>
<span class="cm">	 * so long as all callers are assured to have free tx slots</span>
<span class="cm">	 * (such as after niu_init_hw).</span>
<span class="cm">	 */</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">niu_enable_napi</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_reset_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_RBR_RING_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

				<span class="n">page</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
					<span class="n">u64</span> <span class="n">base</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="n">RBR_DESCR_ADDR_SHIFT</span><span class="p">;</span>
					<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
					<span class="n">page</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_RBR_RING_SIZE</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">niu_rbr_add_page</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_index</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_table_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rcr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rbr_refill_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_TX_RING_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span>
					<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">release_tx_packet</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">MAX_TX_RING_SIZE</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">wrap_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_reset_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">niu_netif_stop</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">niu_stop_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">niu_reset_buffers</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">niu_netif_start</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s: Transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_set_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mark</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">n_frags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le64</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mark</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">n_frags</span> <span class="o">&lt;&lt;</span> <span class="n">TX_DESC_NUM_PTR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">TX_DESC_TR_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">TX_DESC_SAD</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_compute_tx_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">pad_bytes</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">eth_proto</span><span class="p">,</span> <span class="n">eth_proto_inner</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">csum_bits</span><span class="p">,</span> <span class="n">l3off</span><span class="p">,</span> <span class="n">ihl</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ipv6</span><span class="p">;</span>

	<span class="n">eth_proto</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>
	<span class="n">eth_proto_inner</span> <span class="o">=</span> <span class="n">eth_proto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eth_proto</span> <span class="o">==</span> <span class="n">ETH_P_8021Q</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">ehdr</span><span class="p">;</span>
		<span class="n">__be16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span><span class="p">;</span>

		<span class="n">eth_proto_inner</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipv6</span> <span class="o">=</span> <span class="n">ihl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span>:
		<span class="n">ip_proto</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">ihl</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">)</span>:
		<span class="n">ip_proto</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span><span class="p">;</span>
		<span class="n">ihl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">40</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ipv6</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ip_proto</span> <span class="o">=</span> <span class="n">ihl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csum_bits</span> <span class="o">=</span> <span class="n">TXHDR_CSUM_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">stuff</span><span class="p">;</span>

		<span class="n">csum_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_proto</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span> <span class="o">?</span>
			     <span class="n">TXHDR_CSUM_TCP</span> <span class="o">:</span>
			     <span class="p">(</span><span class="n">ip_proto</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span> <span class="o">?</span>
			      <span class="n">TXHDR_CSUM_UDP</span> <span class="o">:</span> <span class="n">TXHDR_CSUM_SCTP</span><span class="p">));</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">skb_checksum_start_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">pad_bytes</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span><span class="p">));</span>
		<span class="n">stuff</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>

		<span class="n">csum_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXHDR_L4START_SHIFT</span><span class="p">;</span>
		<span class="n">csum_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stuff</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXHDR_L4STUFF_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l3off</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">pad_bytes</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(((</span><span class="n">pad_bytes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXHDR_PAD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">TXHDR_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">l3off</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXHDR_L3START_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="n">TXHDR_IHL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">eth_proto_inner</span> <span class="o">&lt;</span> <span class="mi">1536</span><span class="p">)</span> <span class="o">?</span> <span class="n">TXHDR_LLC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">eth_proto</span> <span class="o">==</span> <span class="n">ETH_P_8021Q</span><span class="p">)</span> <span class="o">?</span> <span class="n">TXHDR_VLAN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">ipv6</span> <span class="o">?</span> <span class="n">TXHDR_IP_VER</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">csum_bits</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">niu_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">,</span> <span class="n">headroom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_pkt_hdr</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">nfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ehdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prod</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tlen</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">mrk</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">niu_tx_avail</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s: BUG! Tx ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad_bytes</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_pad</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pad_bytes</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pad_bytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_new</span><span class="p">;</span>

		<span class="n">skb_new</span> <span class="o">=</span> <span class="n">skb_realloc_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_new</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb_orphan</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">align</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">headroom</span> <span class="o">=</span> <span class="n">align</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span><span class="p">);</span>

	<span class="n">ehdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">headroom</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_hdr</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">niu_compute_tx_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ehdr</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">resv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">prod</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">prod</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">prod</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="n">mrk</span> <span class="o">=</span> <span class="n">TX_DESC_SOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">mark_counter</span> <span class="o">==</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mark_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mark_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mrk</span> <span class="o">|=</span> <span class="n">TX_DESC_MARK</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">mark_pending</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">nfg</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlen</span> <span class="o">-=</span> <span class="n">MAX_TX_DESC_LEN</span><span class="p">;</span>
		<span class="n">nfg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">this_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this_len</span> <span class="o">&gt;</span> <span class="n">MAX_TX_DESC_LEN</span><span class="p">)</span>
			<span class="n">this_len</span> <span class="o">=</span> <span class="n">MAX_TX_DESC_LEN</span><span class="p">;</span>

		<span class="n">niu_set_txd</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">this_len</span><span class="p">,</span> <span class="n">mrk</span><span class="p">,</span> <span class="n">nfg</span><span class="p">);</span>
		<span class="n">mrk</span> <span class="o">=</span> <span class="n">nfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">prod</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">prod</span><span class="p">);</span>
		<span class="n">mapping</span> <span class="o">+=</span> <span class="n">this_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">this_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_page</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
					    <span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">prod</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_buffs</span><span class="p">[</span><span class="n">prod</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>

		<span class="n">niu_set_txd</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">prod</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">prod</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prod</span> <span class="o">&lt;</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">)</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">wrap_bit</span> <span class="o">^=</span> <span class="n">TX_RING_KICK_WRAP</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="n">prod</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">TX_RING_KICK</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">),</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">wrap_bit</span> <span class="o">|</span> <span class="p">(</span><span class="n">prod</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">niu_tx_avail</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">niu_tx_avail</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NIU_TX_WAKEUP_THRESH</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">out_drop:</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">orig_jumbo</span><span class="p">,</span> <span class="n">new_jumbo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">NIU_MAX_MTU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">orig_jumbo</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">);</span>
	<span class="n">new_jumbo</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">orig_jumbo</span> <span class="o">==</span> <span class="n">new_jumbo</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">niu_full_shutdown</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">niu_free_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">niu_enable_napi</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_alloc_channels</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">np</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">niu_timer</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">niu_stop_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">!=</span> <span class="n">LOOPBACK_DISABLED</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_vpd</span> <span class="o">*</span><span class="n">vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span>
		<span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_major</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">!=</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_advertising</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_autoneg</span><span class="p">;</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">)</span> <span class="o">?</span> <span class="n">PORT_FIBRE</span> <span class="o">:</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">XCVR_EXTERNAL</span> <span class="o">:</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">niu_init_link</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">niu_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">niu_init_link</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">b_offset</span><span class="p">,</span> <span class="n">b_count</span><span class="p">;</span>

		<span class="n">b_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">b_count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">b_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_count</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">b_count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NCR</span><span class="p">((</span><span class="n">offset</span> <span class="o">-</span> <span class="n">b_offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_offset</span><span class="p">,</span> <span class="n">b_count</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">b_count</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">b_count</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">b_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NCR</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NCR</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_ethflow_to_l3proto</span><span class="p">(</span><span class="kt">int</span> <span class="n">flow_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">TCP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AH_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V6_FLOW</span>:
		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">IPPROTO_AH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">IPPROTO_ESP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_class_to_ethflow</span><span class="p">(</span><span class="n">u64</span> <span class="n">class</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flow_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_TCP_IPV4</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">TCP_V4_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_UDP_IPV4</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">UDP_V4_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_AH_ESP_IPV4</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">AH_V4_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_SCTP_IPV4</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">SCTP_V4_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_TCP_IPV6</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">TCP_V6_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_UDP_IPV6</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">UDP_V6_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_AH_ESP_IPV6</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">AH_V6_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_SCTP_IPV6</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">SCTP_V6_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLASS_CODE_USER_PROG1</span>:
	<span class="k">case</span> <span class="n">CLASS_CODE_USER_PROG2</span>:
	<span class="k">case</span> <span class="n">CLASS_CODE_USER_PROG3</span>:
	<span class="k">case</span> <span class="n">CLASS_CODE_USER_PROG4</span>:
		<span class="o">*</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">IP_USER_FLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_ethflow_to_class</span><span class="p">(</span><span class="kt">int</span> <span class="n">flow_type</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_TCP_IPV4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_UDP_IPV4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AH_ESP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V4_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_AH_ESP_IPV4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_SCTP_IPV4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_TCP_IPV6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_UDP_IPV6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AH_ESP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_AH_ESP_IPV6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_V6_FLOW</span>:
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_SCTP_IPV6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_flowkey_to_ethflow</span><span class="p">(</span><span class="n">u64</span> <span class="n">flow_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ethflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="n">FLOW_KEY_L2DA</span><span class="p">)</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_L2DA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="n">FLOW_KEY_VLAN</span><span class="p">)</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_VLAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="n">FLOW_KEY_IPSA</span><span class="p">)</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_IP_SRC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="n">FLOW_KEY_IPDA</span><span class="p">)</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="n">FLOW_KEY_PROTO</span><span class="p">)</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_L3_PROTO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FLOW_KEY_L4_BYTE12</span> <span class="o">&lt;&lt;</span> <span class="n">FLOW_KEY_L4_0_SHIFT</span><span class="p">))</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_L4_B_0_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FLOW_KEY_L4_BYTE12</span> <span class="o">&lt;&lt;</span> <span class="n">FLOW_KEY_L4_1_SHIFT</span><span class="p">))</span>
		<span class="n">ethflow</span> <span class="o">|=</span> <span class="n">RXH_L4_B_2_3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ethflow</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_ethflow_to_flowkey</span><span class="p">(</span><span class="n">u64</span> <span class="n">ethflow</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">flow_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L2DA</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="n">FLOW_KEY_L2DA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_VLAN</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="n">FLOW_KEY_VLAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_IP_SRC</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="n">FLOW_KEY_IPSA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_IP_DST</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="n">FLOW_KEY_IPDA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L3_PROTO</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="n">FLOW_KEY_PROTO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L4_B_0_1</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FLOW_KEY_L4_BYTE12</span> <span class="o">&lt;&lt;</span> <span class="n">FLOW_KEY_L4_0_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethflow</span> <span class="o">&amp;</span> <span class="n">RXH_L4_B_2_3</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FLOW_KEY_L4_BYTE12</span> <span class="o">&lt;&lt;</span> <span class="n">FLOW_KEY_L4_1_SHIFT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">flow_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_hash_opts</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">nfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">class</span><span class="p">;</span>

	<span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">niu_ethflow_to_class</span><span class="p">(</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">]</span> <span class="o">&amp;</span>
	    <span class="n">TCAM_KEY_DISC</span><span class="p">)</span>
		<span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_DISCARD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">niu_flowkey_to_ethflow</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">flow_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span>
						      <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_ip4fs_from_tcam_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">fsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">prt</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY3_SADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TCAM_V4KEY3_SADDR_SHIFT</span><span class="p">;</span>
	<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4src</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY3_DADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TCAM_V4KEY3_DADDR_SHIFT</span><span class="p">;</span>
	<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4dst</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY3_SADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TCAM_V4KEY3_SADDR_SHIFT</span><span class="p">;</span>
	<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4src</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY3_DADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TCAM_V4KEY3_DADDR_SHIFT</span><span class="p">;</span>
	<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4dst</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">tos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_TOS</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TCAM_V4KEY2_TOS_SHIFT</span><span class="p">;</span>
	<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">tos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_TOS</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TCAM_V4KEY2_TOS_SHIFT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
		<span class="n">prt</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">psrc</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">prt</span><span class="p">);</span>

		<span class="n">prt</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">pdst</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">prt</span><span class="p">);</span>

		<span class="n">prt</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">psrc</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">prt</span><span class="p">);</span>

		<span class="n">prt</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			 <span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">pdst</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">prt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AH_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V4_FLOW</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">ah_ip4_spec</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">ah_ip4_spec</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IP_USER_FLOW</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">l4_4_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PORT_SPI</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PORT_SPI_SHIFT</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">l4_4_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PROTO</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PROTO_SHIFT</span><span class="p">;</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PROTO</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PROTO_SHIFT</span><span class="p">;</span>

		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">ip_ver</span> <span class="o">=</span> <span class="n">ETH_RX_NFC_IP4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_ethtool_tcam_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">nfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">fsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">class</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">tcam_get_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: entry [%d] invalid for idx[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill the flow spec entry */</span>
	<span class="n">class</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY0_CLASS_CODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TCAM_V4KEY0_CLASS_CODE_SHIFT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_class_to_ethflow</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: niu_class_to_ethflow failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">AH_V4_FLOW</span> <span class="o">||</span> <span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">AH_V6_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY2_PROTO</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_V4KEY2_PROTO_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_ESP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">AH_V4_FLOW</span><span class="p">)</span>
				<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">ESP_V4_FLOW</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">=</span> <span class="n">ESP_V6_FLOW</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V4_FLOW</span>:
		<span class="n">niu_get_ip4fs_from_tcam_key</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V6_FLOW</span>:
		<span class="cm">/* Not yet implemented */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IP_USER_FLOW</span>:
		<span class="n">niu_get_ip4fs_from_tcam_key</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span> <span class="o">&amp;</span> <span class="n">TCAM_ASSOCDATA_DISC</span><span class="p">)</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">=</span> <span class="n">RX_CLS_FLOW_DISC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fsp</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span> <span class="o">&amp;</span> <span class="n">TCAM_ASSOCDATA_OFFSET</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TCAM_ASSOCDATA_OFFSET_SHIFT</span><span class="p">;</span>

	<span class="cm">/* put the tcam size here */</span>
	<span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">tcam_get_size</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_ethtool_tcam_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">nfc</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="o">*</span><span class="n">rule_locs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* put the tcam size here */</span>
	<span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">tcam_get_size</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">tcam_get_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">nfc</span><span class="o">-&gt;</span><span class="n">rule_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rule_locs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nfc</span><span class="o">-&gt;</span><span class="n">rule_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_nfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="o">*</span><span class="n">rule_locs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXFH</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_get_hash_opts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXRINGS</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXCLSRLCNT</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rule_cnt</span> <span class="o">=</span> <span class="n">tcam_get_valid_entry_cnt</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXCLSRULE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_get_ethtool_tcam_entry</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXCLSRLALL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_get_ethtool_tcam_all</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rule_locs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_hash_opts</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">nfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">class</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">flow_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">niu_ethflow_to_class</span><span class="p">(</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&lt;</span> <span class="n">CLASS_CODE_USER_PROG1</span> <span class="o">||</span>
	    <span class="n">class</span> <span class="o">&gt;</span> <span class="n">CLASS_CODE_SCTP_IPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">RXH_DISCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">flow_key</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span>
					       <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">];</span>
		<span class="n">flow_key</span> <span class="o">|=</span> <span class="n">TCAM_KEY_DISC</span><span class="p">;</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY</span><span class="p">(</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">),</span> <span class="n">flow_key</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_key</span><span class="p">;</span>
		<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Discard was set before, but is not set now */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="n">TCAM_KEY_DISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">flow_key</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span>
					       <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">];</span>
			<span class="n">flow_key</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TCAM_KEY_DISC</span><span class="p">;</span>
			<span class="n">nw64</span><span class="p">(</span><span class="n">TCAM_KEY</span><span class="p">(</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">),</span>
			     <span class="n">flow_key</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">flow_key</span><span class="p">;</span>
			<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">niu_ethflow_to_flowkey</span><span class="p">(</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow_key</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">FLOW_KEY</span><span class="p">(</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">),</span> <span class="n">flow_key</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">flow_key</span><span class="p">[</span><span class="n">class</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_key</span><span class="p">;</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_tcamkey_from_ip4fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">fsp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">l2_rdc_tab</span><span class="p">,</span> <span class="n">u64</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sip</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">sipm</span><span class="p">,</span> <span class="n">dipm</span><span class="p">,</span> <span class="n">spi</span><span class="p">,</span> <span class="n">spim</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="n">spm</span><span class="p">,</span> <span class="n">dpm</span><span class="p">;</span>

	<span class="n">sip</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4src</span><span class="p">);</span>
	<span class="n">sipm</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4src</span><span class="p">);</span>
	<span class="n">dip</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4dst</span><span class="p">);</span>
	<span class="n">dipm</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">ip4dst</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">class</span> <span class="o">&lt;&lt;</span> <span class="n">TCAM_V4KEY0_CLASS_CODE_SHIFT</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TCAM_V4KEY0_CLASS_CODE</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">l2_rdc_tab</span> <span class="o">&lt;&lt;</span> <span class="n">TCAM_V4KEY1_L2RDCNUM_SHIFT</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TCAM_V4KEY1_L2RDCNUM</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">sip</span> <span class="o">&lt;&lt;</span> <span class="n">TCAM_V4KEY3_SADDR_SHIFT</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">dip</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">sipm</span> <span class="o">&lt;&lt;</span> <span class="n">TCAM_V4KEY3_SADDR_SHIFT</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">dipm</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">tos</span> <span class="o">&lt;&lt;</span>
		       <span class="n">TCAM_V4KEY2_TOS_SHIFT</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">tos</span> <span class="o">&lt;&lt;</span>
			    <span class="n">TCAM_V4KEY2_TOS_SHIFT</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
		<span class="n">sport</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">psrc</span><span class="p">);</span>
		<span class="n">spm</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">psrc</span><span class="p">);</span>
		<span class="n">dport</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">pdst</span><span class="p">);</span>
		<span class="n">dpm</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">tcp_ip4_spec</span><span class="p">.</span><span class="n">pdst</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">sport</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dport</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">spm</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dpm</span><span class="p">);</span>
		<span class="n">niu_ethflow_to_l3proto</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AH_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V4_FLOW</span>:
		<span class="n">spi</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">ah_ip4_spec</span><span class="p">.</span><span class="n">spi</span><span class="p">);</span>
		<span class="n">spim</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">ah_ip4_spec</span><span class="p">.</span><span class="n">spi</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">spi</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">spim</span><span class="p">;</span>
		<span class="n">niu_ethflow_to_l3proto</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IP_USER_FLOW</span>:
		<span class="n">spi</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">l4_4_bytes</span><span class="p">);</span>
		<span class="n">spim</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">l4_4_bytes</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">spi</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">spim</span><span class="p">;</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">.</span><span class="n">proto</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pid</span> <span class="o">&lt;&lt;</span> <span class="n">TCAM_V4KEY2_PROTO_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TCAM_V4KEY2_PROTO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_add_ethtool_tcam_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">nfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_rx_flow_spec</span> <span class="o">*</span><span class="n">fsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfc</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_rdc_tables</span> <span class="o">*</span><span class="n">rdc_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_group_cfg</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">l2_rdc_table</span> <span class="o">=</span> <span class="n">rdc_table</span><span class="o">-&gt;</span><span class="n">first_table_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">class</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">nfc</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">tcam_get_size</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">IP_USER_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">add_usr_cls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ethtool_usrip4_spec</span> <span class="o">*</span><span class="n">uspec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">h_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ethtool_usrip4_spec</span> <span class="o">*</span><span class="n">umask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">m_u</span><span class="p">.</span><span class="n">usr_ip4_spec</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uspec</span><span class="o">-&gt;</span><span class="n">ip_ver</span> <span class="o">!=</span> <span class="n">ETH_RX_NFC_IP4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NIU_L3_PROG_CLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uspec</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_pid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">class</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_refcnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
					<span class="n">add_usr_cls</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Program new user IP class */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG2</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG3</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>:
					<span class="n">class</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG4</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">tcam_user_ip_class_set</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							     <span class="n">uspec</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span>
							     <span class="n">uspec</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">,</span>
							     <span class="n">umask</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">tcam_user_ip_class_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">class</span><span class="p">;</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_pid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uspec</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_refcnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">add_usr_cls</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_usr_cls</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: %s(): Could not find/insert class for pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">uspec</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">niu_ethflow_to_class</span><span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">tcam_get_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>

	<span class="cm">/* fill in the tcam key and mask */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V4_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V4_FLOW</span>:
		<span class="n">niu_get_tcamkey_from_ip4fs</span><span class="p">(</span><span class="n">fsp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">l2_rdc_table</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">UDP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">SCTP_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">AH_V6_FLOW</span>:
	<span class="k">case</span> <span class="n">ESP_V6_FLOW</span>:
		<span class="cm">/* Not yet implemented */</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: In %s(): flow %d for IPv6 not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IP_USER_FLOW</span>:
		<span class="n">niu_get_tcamkey_from_ip4fs</span><span class="p">(</span><span class="n">fsp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">l2_rdc_table</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: In %s(): Unknown flow type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fsp</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in the assoc data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">==</span> <span class="n">RX_CLS_FLOW_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span> <span class="o">=</span> <span class="n">TCAM_ASSOCDATA_DISC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: In %s(): Invalid RX ring %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">ring_cookie</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCAM_ASSOCDATA_TRES_USE_OFFSET</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">ring_cookie</span> <span class="o">&lt;&lt;</span>
				   <span class="n">TCAM_ASSOCDATA_OFFSET_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">key_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tcam_assoc_write</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">assoc_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* validate the entry */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">.</span><span class="n">tcam_valid_entries</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_del_ethtool_tcam_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u32</span> <span class="n">loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_tcam_entry</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">class</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="n">tcam_get_size</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">tcam_get_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="cm">/* if the entry is of a user defined class, then update*/</span>
	<span class="n">class</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TCAM_V4KEY0_CLASS_CODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TCAM_V4KEY0_CLASS_CODE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&gt;=</span> <span class="n">CLASS_CODE_USER_PROG1</span> <span class="o">&amp;&amp;</span> <span class="n">class</span> <span class="o">&lt;=</span> <span class="n">CLASS_CODE_USER_PROG4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NIU_L3_PROG_CLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">class</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_refcnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_refcnt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="cm">/* disable class */</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">tcam_user_ip_class_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span>
									<span class="n">class</span><span class="p">,</span>
									<span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">parent</span><span class="o">-&gt;</span><span class="n">l3_cls_pid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NIU_L3_PROG_CLS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;niu%d: In %s(): Usr class 0x%llx not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">class</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tcam_flush</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* invalidate the entry */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">.</span><span class="n">tcam_valid_entries</span><span class="o">--</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_nfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_SRXFH</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_set_hash_opts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_SRXCLSRLINS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_add_ethtool_tcam_entry</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_SRXCLSRLDEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">niu_del_ethtool_tcam_entry</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">location</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">niu_xmac_stat_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tx_frames&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_fifo_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_overflow_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_max_pkt_size_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_underflow_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_local_faults&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_remote_faults&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_link_faults&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_align_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_frags&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_mcasts&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bcasts&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt1&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt4&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt5&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt6&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_hist_cnt7&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_octets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_code_violations&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_len_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_crc_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_underflows&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_overflows&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pause_off_state&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pause_on_state&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pause_received&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_XMAC_STAT_KEYS	ARRAY_SIZE(niu_xmac_stat_keys)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">niu_bmac_stat_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tx_underflow_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_max_pkt_size_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_frames&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_overflows&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_frames&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_align_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_crc_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_len_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pause_off_state&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pause_on_state&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pause_received&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_BMAC_STAT_KEYS	ARRAY_SIZE(niu_bmac_stat_keys)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">niu_rxchan_stat_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;rx_channel&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_dropped&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_errors&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_RXCHAN_STAT_KEYS	ARRAY_SIZE(niu_rxchan_stat_keys)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">niu_txchan_stat_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tx_channel&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_errors&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_TXCHAN_STAT_KEYS	ARRAY_SIZE(niu_txchan_stat_keys)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">!=</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">niu_xmac_stat_keys</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_xmac_stat_keys</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_xmac_stat_keys</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">niu_bmac_stat_keys</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_bmac_stat_keys</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_bmac_stat_keys</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">niu_rxchan_stat_keys</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_rxchan_stat_keys</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_rxchan_stat_keys</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">niu_txchan_stat_keys</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_txchan_stat_keys</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">niu_txchan_stat_keys</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stringset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">!=</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span> <span class="o">?</span>
		 <span class="n">NUM_XMAC_STAT_KEYS</span> <span class="o">:</span>
		 <span class="n">NUM_BMAC_STAT_KEYS</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span> <span class="o">*</span> <span class="n">NUM_RXCHAN_STAT_KEYS</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span> <span class="o">*</span> <span class="n">NUM_TXCHAN_STAT_KEYS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">niu_sync_mac_stats</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">.</span><span class="n">xmac</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_xmac_stats</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_xmac_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">.</span><span class="n">bmac</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_bmac_stats</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_bmac_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_rx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">niu_sync_rx_discard_stats</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_channel</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_tx_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_channel</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_led_state_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">BMAC_XIF_CONFIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_led_state_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">XMAC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nw64_mac</span><span class="p">(</span><span class="n">BMAC_XIF_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_force_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">XMAC_CONFIG</span><span class="p">;</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">XMAC_CONFIG_FORCE_LED_ON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">BMAC_XIF_CONFIG</span><span class="p">;</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">BMAC_XIF_CONFIG_LINK_LED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="n">nw64_mac</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_phys_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_led_state</span> <span class="o">=</span> <span class="n">niu_led_state_save</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cycle on/off once per second */</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">niu_force_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">niu_force_led</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="n">niu_led_state_restore</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">orig_led_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">niu_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">niu_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">niu_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">niu_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">niu_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">niu_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">niu_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">niu_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">niu_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">niu_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">niu_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">niu_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span>		<span class="o">=</span> <span class="n">niu_set_phys_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxnfc</span>		<span class="o">=</span> <span class="n">niu_get_nfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rxnfc</span>		<span class="o">=</span> <span class="n">niu_set_nfc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_ldg_assign_ldn</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">ldg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ldn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ldg</span> <span class="o">&lt;</span> <span class="n">NIU_LDG_MIN</span> <span class="o">||</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="n">NIU_LDG_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ldn</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ldn</span> <span class="o">&gt;</span> <span class="n">LDN_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">parent</span><span class="o">-&gt;</span><span class="n">ldg_map</span><span class="p">[</span><span class="n">ldn</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* On N2 NIU, the ldn--&gt;ldg assignments are setup and fixed by</span>
<span class="cm">		 * the firmware, and we&#39;re not supposed to change them.</span>
<span class="cm">		 * Validate the mapping, because if it&#39;s wrong we probably</span>
<span class="cm">		 * won&#39;t get any interrupts and that&#39;s painful to debug.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr64</span><span class="p">(</span><span class="n">LDG_NUM</span><span class="p">(</span><span class="n">ldn</span><span class="p">))</span> <span class="o">!=</span> <span class="n">ldg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Port %u, mis-matched LDG assignment for ldn %d, should be %d is %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ldn</span><span class="p">,</span> <span class="n">ldg</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nr64</span><span class="p">(</span><span class="n">LDG_NUM</span><span class="p">(</span><span class="n">ldn</span><span class="p">)));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">LDG_NUM</span><span class="p">(</span><span class="n">ldn</span><span class="p">),</span> <span class="n">ldg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_ldg_timer_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="n">LDG_TIMER_RES_VAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


	<span class="n">nw64</span><span class="p">(</span><span class="n">LDG_TIMER_RES</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_set_ldg_sid</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ldg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ldg</span> <span class="o">&lt;</span> <span class="n">NIU_LDG_MIN</span> <span class="o">||</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="n">NIU_LDG_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">func</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">func</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vector</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vector</span> <span class="o">&gt;</span> <span class="mh">0x1f</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nw64</span><span class="p">(</span><span class="n">SID</span><span class="p">(</span><span class="n">ldg</span><span class="p">),</span> <span class="p">(</span><span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">SID_FUNC_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">vector</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESPC_PIO_STAT_READ_START</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">ESPC_PIO_STAT_ADDR_SHIFT</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ESPC_PIO_STAT_ADDR</span> <span class="o">&gt;&gt;</span> <span class="n">ESPC_PIO_STAT_ADDR_SHIFT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">frame_base</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ESPC_PIO_STAT</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_PIO_STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="n">ESPC_PIO_STAT_READ_END</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="n">ESPC_PIO_STAT_READ_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;EEPROM read timeout frame[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">frame_base</span><span class="p">;</span>
	<span class="n">nw64</span><span class="p">(</span><span class="n">ESPC_PIO_STAT</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_PIO_STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="n">ESPC_PIO_STAT_READ_END</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="n">ESPC_PIO_STAT_READ_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;EEPROM read timeout frame[%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_PIO_STAT</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="n">ESPC_PIO_STAT_DATA</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ESPC_PIO_STAT_DATA_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_eeprom_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_eeprom_read16_swp</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_vpd_get_propname</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">off</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">namebuf</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">namebuf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">namebuf_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="o">*</span><span class="n">namebuf</span><span class="o">++</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">namebuf_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_vpd_parse_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_vpd</span> <span class="o">*</span><span class="n">vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;FCode &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_major</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_minor</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;VPD_SCAN: FCODE major(%d) minor(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_major</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_major</span> <span class="o">&gt;</span> <span class="n">NIU_VPD_MIN_MAJOR</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_major</span> <span class="o">==</span> <span class="n">NIU_VPD_MIN_MAJOR</span> <span class="o">&amp;&amp;</span>
	     <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">fcode_minor</span> <span class="o">&gt;=</span> <span class="n">NIU_VPD_MIN_MINOR</span><span class="p">))</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_VPD_VALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ESPC_PIO_EN_ENABLE must be set */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_vpd_scan_props</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define FOUND_MASK_MODEL	0x00000001</span>
<span class="cp">#define FOUND_MASK_BMODEL	0x00000002</span>
<span class="cp">#define FOUND_MASK_VERS		0x00000004</span>
<span class="cp">#define FOUND_MASK_MAC		0x00000008</span>
<span class="cp">#define FOUND_MASK_NMAC		0x00000010</span>
<span class="cp">#define FOUND_MASK_PHY		0x00000020</span>
<span class="cp">#define FOUND_MASK_ALL		0x0000003f</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;VPD_SCAN: start[%x] end[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">prop_len</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">namebuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">prop_buf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found_mask</span> <span class="o">==</span> <span class="n">FOUND_MASK_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">niu_vpd_parse_version</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">prop_len</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_vpd_get_propname</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">namebuf</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">prop_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">;</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">NIU_VPD_MODEL_MAX</span><span class="p">;</span>
			<span class="n">found_mask</span> <span class="o">|=</span> <span class="n">FOUND_MASK_MODEL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">&quot;board-model&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">board_model</span><span class="p">;</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">NIU_VPD_BD_MODEL_MAX</span><span class="p">;</span>
			<span class="n">found_mask</span> <span class="o">|=</span> <span class="n">FOUND_MASK_BMODEL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">&quot;version&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">NIU_VPD_VERSION_MAX</span><span class="p">;</span>
			<span class="n">found_mask</span> <span class="o">|=</span> <span class="n">FOUND_MASK_VERS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">local_mac</span><span class="p">;</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
			<span class="n">found_mask</span> <span class="o">|=</span> <span class="n">FOUND_MASK_MAC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">&quot;num-mac-addresses&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">mac_num</span><span class="p">;</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">found_mask</span> <span class="o">|=</span> <span class="n">FOUND_MASK_NMAC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">&quot;phy-type&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">;</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">NIU_VPD_PHY_TYPE_MAX</span><span class="p">;</span>
			<span class="n">found_mask</span> <span class="o">|=</span> <span class="n">FOUND_MASK_PHY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&amp;&amp;</span> <span class="n">prop_len</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Property &#39;%s&#39; length (%d) is too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">namebuf</span><span class="p">,</span> <span class="n">prop_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prop_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">off</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">err</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;VPD_SCAN: Reading in property [%s] len[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">namebuf</span><span class="p">,</span> <span class="n">prop_len</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">prop_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="o">*</span><span class="n">prop_buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ESPC_PIO_EN_ENABLE must be set */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_pci_vpd_fetch</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16_swp</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">err</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">ESPC_EEPROM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">here</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">end</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">here</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mh">0x90</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16_swp</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">here</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">here</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_vpd_scan_props</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">here</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ESPC_PIO_EN_ENABLE must be set */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__devinit</span> <span class="nf">niu_pci_vpd_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">ESPC_EEPROM_SIZE</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

		<span class="cm">/* ROM header signature?  */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mh">0x55aa</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Apply offset to PCI data structure.  */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">23</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Check for &quot;PCIR&quot; signature.  */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mh">0x5043</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span>  <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mh">0x4952</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check for OBP image type.  */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">start</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">+</span> <span class="p">(</span><span class="n">err</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read16_swp</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_eeprom_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mh">0x82</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_phy_type_prop_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phy_prop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_prop</span><span class="p">,</span> <span class="s">&quot;mif&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 1G copper, MII */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			       <span class="n">NIU_FLAGS_10G</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_MII</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_prop</span><span class="p">,</span> <span class="s">&quot;xgf&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 10G fiber, XPCS */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span>
			      <span class="n">NIU_FLAGS_FIBER</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_XPCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_prop</span><span class="p">,</span> <span class="s">&quot;pcs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 1G fiber, PCS */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_PCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_prop</span><span class="p">,</span> <span class="s">&quot;xgc&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 10G copper, XPCS */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_XPCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_prop</span><span class="p">,</span> <span class="s">&quot;xgsd&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_prop</span><span class="p">,</span> <span class="s">&quot;gsd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 10G Serdes or 1G Serdes, default to 10G */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_XPCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_pci_vpd_get_nports</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_QGC_LP_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_QGC_PEM_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_MARAMBA_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_KIMI_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_ALONSO_MDL_STR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ports</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_2XGF_LP_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_2XGF_PEM_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_FOXXY_MDL_STR</span><span class="p">))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_2XGF_MRVL_MDL_STR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ports</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ports</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_pci_vpd_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_vpd</span> <span class="o">*</span><span class="n">vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">local_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;VPD MAC invalid, falling back to SPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_VPD_VALID</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_ALONSO_MDL_STR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_KIMI_MDL_STR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_PCS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_XPCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_FOXXY_MDL_STR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			      <span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">niu_phy_type_prop_decode</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Illegal phy string [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Falling back to SPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_VPD_VALID</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">local_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">val8</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">val8</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_probe_sprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">sum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val8</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_VER_IMGSZ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESPC_VER_IMGSZ_IMGSZ</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="n">ESPC_VER_IMGSZ_IMGSZ_SHIFT</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: Image size %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

	<span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NCR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: Checksum %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xab</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Bad SPROM checksum (%x, should be 0xab)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_PHY_TYPE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val8</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ESPC_PHY_TYPE_PORT0</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">ESPC_PHY_TYPE_PORT0_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val8</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ESPC_PHY_TYPE_PORT1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">ESPC_PHY_TYPE_PORT1_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val8</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ESPC_PHY_TYPE_PORT2</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">ESPC_PHY_TYPE_PORT2_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val8</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ESPC_PHY_TYPE_PORT3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">ESPC_PHY_TYPE_PORT3_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Bogus port number %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: PHY type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val8</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val8</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ESPC_PHY_TYPE_1G_COPPER</span>:
		<span class="cm">/* 1G copper, MII */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			       <span class="n">NIU_FLAGS_10G</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_MII</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESPC_PHY_TYPE_1G_FIBER</span>:
		<span class="cm">/* 1G fiber, PCS */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_PCS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESPC_PHY_TYPE_10G_COPPER</span>:
		<span class="cm">/* 10G copper, XPCS */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_10G</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_FIBER</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_XPCS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESPC_PHY_TYPE_10G_FIBER</span>:
		<span class="cm">/* 10G fiber, XPCS */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span>
			      <span class="n">NIU_FLAGS_FIBER</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">=</span> <span class="n">MAC_XCVR_XPCS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Bogus SPROM phy type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val8</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_MAC_ADDR0</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: MAC_ADDR0[%08llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_MAC_ADDR1</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: MAC_ADDR1[%08llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;SPROM MAC address invalid [ %pM ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val8</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">val8</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_MOD_STR_LEN</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: MOD_STR_LEN[%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NCR</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)));</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_BD_MOD_STR_LEN</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: BD_MOD_STR_LEN[%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NCR</span><span class="p">(</span><span class="mi">14</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)));</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">board_model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">board_model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">board_model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">board_model</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">board_model</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">mac_num</span> <span class="o">=</span>
		<span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NUM_PORTS_MACS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESPC_NUM_PORTS_MACS_VAL</span><span class="p">;</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;SPROM: NUM_PORTS_MACS[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">mac_num</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_get_and_validate_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_XMAC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">niu_pci_vpd_get_nports</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Fall back to SPROM as last resort.</span>
<span class="cm">				 * This will fail on most cards.</span>
<span class="cm">				 */</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">nr64</span><span class="p">(</span><span class="n">ESPC_NUM_PORTS_MACS</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">ESPC_NUM_PORTS_MACS_VAL</span><span class="p">;</span>

				<span class="cm">/* All of the current probing methods fail on</span>
<span class="cm">				 * Maramba on-board parts.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">)</span>
					<span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">phy_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">phy_probe_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">dev_id_1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_id_2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_port</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_id_1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dev_id_2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_id_1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev_id_2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PHY_TYPE_PMA_PMD</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">PHY_TYPE_PCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Because of the NIU_PHY_ID_MASK being applied, the 8704</span>
<span class="cm">		 * test covers the 8706 as well.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">NIU_PHY_ID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NIU_PHY_ID_BCM8704</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">NIU_PHY_ID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NIU_PHY_ID_MRVL88X2011</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">NIU_PHY_ID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NIU_PHY_ID_BCM5464R</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;niu%d: Found PHY %08x type %s at phy_port %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
		<span class="n">type</span> <span class="o">==</span> <span class="n">PHY_TYPE_PMA_PMD</span> <span class="o">?</span> <span class="s">&quot;PMA/PMD&quot;</span> <span class="o">:</span>
		<span class="n">type</span> <span class="o">==</span> <span class="n">PHY_TYPE_PCS</span> <span class="o">?</span> <span class="s">&quot;PCS&quot;</span> <span class="o">:</span> <span class="s">&quot;MII&quot;</span><span class="p">,</span>
		<span class="n">phy_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">NIU_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Too many PHY ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">[</span><span class="n">type</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_port</span><span class="p">[</span><span class="n">type</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_port</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">port_has_10g</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_probe_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">PHY_TYPE_PMA_PMD</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_port</span><span class="p">[</span><span class="n">PHY_TYPE_PMA_PMD</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">PHY_TYPE_PCS</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_port</span><span class="p">[</span><span class="n">PHY_TYPE_PCS</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">count_10g_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_probe_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lowest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lowest</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_has_10g</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
				<span class="o">*</span><span class="n">lowest</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">count_1g_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_probe_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lowest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">lowest</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">PHY_TYPE_MII</span><span class="p">])</span>
		<span class="o">*</span><span class="n">lowest</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_port</span><span class="p">[</span><span class="n">PHY_TYPE_MII</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">[</span><span class="n">PHY_TYPE_MII</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_n2_divide_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_ports</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="n">num_ports</span><span class="p">);</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="n">num_ports</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;niu%d: Port %u [%u RX chans] [%u TX chans]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_divide_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">num_10g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_1g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_ports</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_chans_per_10g</span><span class="p">,</span> <span class="n">rx_chans_per_1g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_chans_per_10g</span><span class="p">,</span> <span class="n">tx_chans_per_1g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tot_rx</span><span class="p">,</span> <span class="n">tot_tx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_10g</span> <span class="o">||</span> <span class="o">!</span><span class="n">num_1g</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_chans_per_10g</span> <span class="o">=</span> <span class="n">rx_chans_per_1g</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">NIU_NUM_RXCHAN</span> <span class="o">/</span> <span class="n">num_ports</span><span class="p">);</span>
		<span class="n">tx_chans_per_10g</span> <span class="o">=</span> <span class="n">tx_chans_per_1g</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">NIU_NUM_TXCHAN</span> <span class="o">/</span> <span class="n">num_ports</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_chans_per_1g</span> <span class="o">=</span> <span class="n">NIU_NUM_RXCHAN</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rx_chans_per_10g</span> <span class="o">=</span> <span class="p">(</span><span class="n">NIU_NUM_RXCHAN</span> <span class="o">-</span>
				    <span class="p">(</span><span class="n">rx_chans_per_1g</span> <span class="o">*</span> <span class="n">num_1g</span><span class="p">))</span> <span class="o">/</span>
			<span class="n">num_10g</span><span class="p">;</span>

		<span class="n">tx_chans_per_1g</span> <span class="o">=</span> <span class="n">NIU_NUM_TXCHAN</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">tx_chans_per_10g</span> <span class="o">=</span> <span class="p">(</span><span class="n">NIU_NUM_TXCHAN</span> <span class="o">-</span>
				    <span class="p">(</span><span class="n">tx_chans_per_1g</span> <span class="o">*</span> <span class="n">num_1g</span><span class="p">))</span> <span class="o">/</span>
			<span class="n">num_10g</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tot_rx</span> <span class="o">=</span> <span class="n">tot_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">phy_decode</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_TYPE_10G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_chans_per_10g</span><span class="p">;</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_chans_per_10g</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_chans_per_1g</span><span class="p">;</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_chans_per_1g</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;niu%d: Port %u [%u RX chans] [%u TX chans]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">tot_rx</span> <span class="o">+=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tot_tx</span> <span class="o">+=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tot_rx</span> <span class="o">&gt;</span> <span class="n">NIU_NUM_RXCHAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;niu%d: Too many RX channels (%d), resetting to one per port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">tot_rx</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_tx</span> <span class="o">&gt;</span> <span class="n">NIU_NUM_TXCHAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;niu%d: Too many TX channels (%d), resetting to one per port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">tot_tx</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_rx</span> <span class="o">&lt;</span> <span class="n">NIU_NUM_RXCHAN</span> <span class="o">||</span> <span class="n">tot_tx</span> <span class="o">&lt;</span> <span class="n">NIU_NUM_TXCHAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;niu%d: Driver bug, wasted channels, RX[%d] TX[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">tot_rx</span><span class="p">,</span> <span class="n">tot_tx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_divide_rdc_groups</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">num_10g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_1g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_ports</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rdc_group</span><span class="p">,</span> <span class="n">rdc_groups_per_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rdc_channel_base</span><span class="p">;</span>

	<span class="n">rdc_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdc_groups_per_port</span> <span class="o">=</span> <span class="n">NIU_NUM_RDC_TABLES</span> <span class="o">/</span> <span class="n">num_ports</span><span class="p">;</span>

	<span class="n">rdc_channel_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_rdc_tables</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_group_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">grp</span><span class="p">,</span> <span class="n">num_channels</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">this_channel_offset</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_table_num</span> <span class="o">=</span> <span class="n">rdc_group</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">num_tables</span> <span class="o">=</span> <span class="n">rdc_groups_per_port</span><span class="p">;</span>
		<span class="n">this_channel_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">grp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">grp</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">num_tables</span><span class="p">;</span> <span class="n">grp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rdc_table</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">[</span><span class="n">grp</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;niu%d: Port %d RDC tbl(%d) [ &quot;</span><span class="p">,</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_table_num</span> <span class="o">+</span> <span class="n">grp</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">NIU_RDC_TABLE_SLOTS</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rxdma_channel</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">rdc_channel_base</span> <span class="o">+</span> <span class="n">this_channel_offset</span><span class="p">;</span>

				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rxdma_channel</span><span class="p">[</span><span class="n">slot</span><span class="p">]);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">this_channel_offset</span> <span class="o">==</span> <span class="n">num_channels</span><span class="p">)</span>
					<span class="n">this_channel_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rdc_default</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdc_channel_base</span><span class="p">;</span>

		<span class="n">rdc_channel_base</span> <span class="o">+=</span> <span class="n">num_channels</span><span class="p">;</span>
		<span class="n">rdc_group</span> <span class="o">+=</span> <span class="n">rdc_groups_per_port</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fill_phy_probe_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">phy_probe_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>

	<span class="cm">/* Port 0 to 7 are reserved for onboard Serdes, probe the rest.  */</span>
	<span class="n">niu_lock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dev_id_1</span><span class="p">,</span> <span class="n">dev_id_2</span><span class="p">;</span>

		<span class="n">dev_id_1</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				     <span class="n">NIU_PMA_PMD_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
		<span class="n">dev_id_2</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				     <span class="n">NIU_PMA_PMD_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">phy_record</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">dev_id_1</span><span class="p">,</span> <span class="n">dev_id_2</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				 <span class="n">PHY_TYPE_PMA_PMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev_id_1</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				     <span class="n">NIU_PCS_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
		<span class="n">dev_id_2</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				     <span class="n">NIU_PCS_DEV_ADDR</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">phy_record</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">dev_id_1</span><span class="p">,</span> <span class="n">dev_id_2</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				 <span class="n">PHY_TYPE_PCS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev_id_1</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
		<span class="n">dev_id_2</span> <span class="o">=</span> <span class="n">mii_read</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">phy_record</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">dev_id_1</span><span class="p">,</span> <span class="n">dev_id_2</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				 <span class="n">PHY_TYPE_MII</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">niu_unlock_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">walk_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phy_probe_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">phy_probe_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lowest_10g</span><span class="p">,</span> <span class="n">lowest_1g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_10g</span><span class="p">,</span> <span class="n">num_1g</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">num_10g</span> <span class="o">=</span> <span class="n">num_1g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_ALONSO_MDL_STR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_KIMI_MDL_STR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num_10g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">num_1g</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_ATCA_CP3220</span><span class="p">;</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">NIU_FOXXY_MDL_STR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num_10g</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">num_1g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this is the Monza case */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fill_phy_probe_info</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">num_10g</span> <span class="o">=</span> <span class="n">count_10g_ports</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lowest_10g</span><span class="p">);</span>
		<span class="n">num_1g</span> <span class="o">=</span> <span class="n">count_1g_ports</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lowest_1g</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">num_10g</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">num_1g</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x24</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lowest_1g</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_VF_P0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lowest_1g</span> <span class="o">==</span> <span class="mi">26</span><span class="p">)</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_VF_P1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">unknown_vg_1g_port</span><span class="p">;</span>

			<span class="cm">/* fallthru */</span>
		<span class="k">case</span> <span class="mh">0x22</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x20</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x14</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lowest_1g</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_VF_P0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lowest_1g</span> <span class="o">==</span> <span class="mi">26</span><span class="p">)</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_VF_P1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">unknown_vg_1g_port</span><span class="p">;</span>

			<span class="cm">/* fallthru */</span>
		<span class="k">case</span> <span class="mh">0x13</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">lowest_10g</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_10G</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lowest_1g</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_VF_P0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lowest_1g</span> <span class="o">==</span> <span class="mi">26</span><span class="p">)</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">PLAT_TYPE_VF_P1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">unknown_vg_1g_port</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">phy_encode</span><span class="p">(</span><span class="n">PORT_TYPE_1G</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unsupported port config 10G[%d] 1G[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">num_10g</span><span class="p">,</span> <span class="n">num_1g</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span>
		<span class="n">niu_n2_divide_channels</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">niu_divide_channels</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">num_10g</span><span class="p">,</span> <span class="n">num_1g</span><span class="p">);</span>

	<span class="n">niu_divide_rdc_groups</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">num_10g</span><span class="p">,</span> <span class="n">num_1g</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unknown_vg_1g_port:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot identify platform type, 1gport=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lowest_1g</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_probe_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span> <span class="o">==</span> <span class="n">PORT_PHY_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">walk_phys</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">niu_set_ldg_timer_res</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LDN_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">niu_ldn_irq_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port_phy</span> <span class="o">==</span> <span class="n">PORT_PHY_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_classifier_swstate_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_classifier</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">clas</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">tcam_top</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">tcam_sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">tcam_num_entries</span> <span class="o">/</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">h1_init</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">h2_init</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fflp_early_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_link_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_link_config</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_Autoneg</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	lp-&gt;loopback_mode = LOOPBACK_MAC;</span>
<span class="c">	lp-&gt;active_speed = SPEED_10000;</span>
<span class="c">	lp-&gt;active_duplex = DUPLEX_FULL;</span>
<span class="cp">#else</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">LOOPBACK_DISABLED</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_init_mac_ipp_pcs_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">XMAC_PORT0_OFF</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ipp_off</span>  <span class="o">=</span> <span class="mh">0x00000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pcs_off</span>  <span class="o">=</span> <span class="mh">0x04000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">xpcs_off</span> <span class="o">=</span> <span class="mh">0x02000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">XMAC_PORT1_OFF</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ipp_off</span>  <span class="o">=</span> <span class="mh">0x08000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pcs_off</span>  <span class="o">=</span> <span class="mh">0x0a000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">xpcs_off</span> <span class="o">=</span> <span class="mh">0x08000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">BMAC_PORT2_OFF</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ipp_off</span>  <span class="o">=</span> <span class="mh">0x04000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pcs_off</span>  <span class="o">=</span> <span class="mh">0x0e000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">xpcs_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">BMAC_PORT3_OFF</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ipp_off</span>  <span class="o">=</span> <span class="mh">0x0c000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">pcs_off</span>  <span class="o">=</span> <span class="mh">0x12000</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">xpcs_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Port %u is invalid, cannot compute MAC block offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_try_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ldg_num_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">msi_vec</span><span class="p">[</span><span class="n">NIU_NUM_LDG</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_irqs</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">first_ldg</span><span class="p">;</span>

	<span class="n">first_ldg</span> <span class="o">=</span> <span class="p">(</span><span class="n">NIU_NUM_LDG</span> <span class="o">/</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">NIU_NUM_LDG</span> <span class="o">/</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ldg_num_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_ldg</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">num_irqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">+</span>
		    <span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">num_irqs</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">NIU_NUM_LDG</span> <span class="o">/</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">));</span>

<span class="nl">retry:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_irqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msi_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msi_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">msi_vec</span><span class="p">,</span> <span class="n">num_irqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NIU_FLAGS_MSIX</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NIU_FLAGS_MSIX</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_irqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">msi_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span> <span class="o">=</span> <span class="n">num_irqs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_n2_irq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ldg_num_map</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC64</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">int_prop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">int_prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">num_irqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ldg_num_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_prop</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">num_irqs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_ldg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">NIU_NUM_LDG</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">first_chan</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">ldg_rotor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_n2_irq_init</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ldg_num_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">niu_try_msix</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ldg_num_map</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu_ldg</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ldg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">niu_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ldg_num</span> <span class="o">=</span> <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* XXX */</span>

		<span class="cm">/* On N2 NIU the firmware has setup the SID mappings so they go</span>
<span class="cm">		 * to the correct values that will route the LDG to the proper</span>
<span class="cm">		 * interrupt in the NCU interrupt table.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">!=</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_set_ldg_sid</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ldg_num</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We adopt the LDG assignment ordering used by the N2 NIU</span>
<span class="cm">	 * &#39;interrupt&#39; properties because that simplifies a lot of</span>
<span class="cm">	 * things.  This ordering is:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	MAC</span>
<span class="cm">	 *	MIF	(if port zero)</span>
<span class="cm">	 *	SYSERR	(if port zero)</span>
<span class="cm">	 *	RX channels</span>
<span class="cm">	 *	TX channels</span>
<span class="cm">	 */</span>

	<span class="n">ldg_rotor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ldg_assign_ldn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">ldg_rotor</span><span class="p">],</span>
				  <span class="n">LDN_MAC</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ldg_rotor</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ldg_rotor</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">)</span>
		<span class="n">ldg_rotor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ldg_assign_ldn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
					 <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">ldg_rotor</span><span class="p">],</span>
					 <span class="n">LDN_MIF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">ldg_rotor</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ldg_rotor</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">)</span>
			<span class="n">ldg_rotor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ldg_assign_ldn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
					 <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">ldg_rotor</span><span class="p">],</span>
					 <span class="n">LDN_DEVICE_ERROR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">ldg_rotor</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ldg_rotor</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">)</span>
			<span class="n">ldg_rotor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">first_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">first_chan</span> <span class="o">+=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">num_chan</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_chan</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">first_chan</span> <span class="o">+</span> <span class="n">num_chan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ldg_assign_ldn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
					 <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">ldg_rotor</span><span class="p">],</span>
					 <span class="n">LDN_RXDMA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">ldg_rotor</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ldg_rotor</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">)</span>
			<span class="n">ldg_rotor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">first_chan</span> <span class="o">+=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">num_chan</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_chan</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">first_chan</span> <span class="o">+</span> <span class="n">num_chan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_ldg_assign_ldn</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
					 <span class="n">ldg_num_map</span><span class="p">[</span><span class="n">ldg_rotor</span><span class="p">],</span>
					 <span class="n">LDN_TXDMA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">ldg_rotor</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ldg_rotor</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">num_ldg</span><span class="p">)</span>
			<span class="n">ldg_rotor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">niu_ldg_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_MSIX</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_get_of_props</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC64</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phy_type</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prop_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">phy_type</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;phy-type&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prop_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: OF node lacks phy-type property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">phy_type</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">niu_phy_type_prop_decode</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Illegal phy string [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prop_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: OF node lacks local-mac-address property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop_len</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: OF MAC address prop len (%d) is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">prop_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: OF MAC address is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: [ %pM ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prop_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;hot-swappable-phy&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prop_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NIU_FLAGS_10G</span> <span class="o">|</span> <span class="n">NIU_FLAGS_FIBER</span> <span class="o">|</span>
			<span class="n">NIU_FLAGS_HOTPLUG_PHY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_get_invariants</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">have_props</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_get_of_props</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">have_props</span> <span class="o">=</span> <span class="o">!</span><span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_mac_ipp_pcs_base</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">have_props</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_get_and_validate_port</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">nw64</span><span class="p">(</span><span class="n">ESPC_PIO_EN</span><span class="p">,</span> <span class="n">ESPC_PIO_EN_ENABLE</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">niu_pci_vpd_offset</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;%s() VPD offset [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
			<span class="n">niu_pci_vpd_fetch</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">nw64</span><span class="p">(</span><span class="n">ESPC_PIO_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_VPD_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">niu_pci_vpd_validate</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_get_and_validate_port</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_VPD_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_get_and_validate_port</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">niu_pci_probe_sprom</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_probe_ports</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">niu_ldg_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">niu_classifier_swstate_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">niu_link_config_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_determine_phy_disposition</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_link</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">niu_parent_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">niu_parent_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">niu_parent_index</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_port_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_phy</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_phy</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">orig_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_phy</span> <span class="o">==</span> <span class="n">PORT_PHY_UNKNOWN</span> <span class="o">||</span>
	    <span class="n">port_phy</span> <span class="o">==</span> <span class="n">PORT_PHY_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_str</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">phy_decode</span><span class="p">(</span><span class="n">port_phy</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_TYPE_10G</span><span class="p">)</span>
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;10G&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;1G&quot;</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;%s&quot;</span> <span class="o">:</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span>
			       <span class="n">type_str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">orig_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_plat_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_str</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PLAT_TYPE_ATLAS</span>:
		<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;atlas&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLAT_TYPE_NIU</span>:
		<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;niu&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLAT_TYPE_VF_P0</span>:
		<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;vf_p0&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLAT_TYPE_VF_P1</span>:
		<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;vf_p1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type_str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__show_chan_per_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">orig_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">arr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rxchan_per_port</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">txchan_per_port</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;%d&quot;</span> <span class="o">:</span> <span class="s">&quot; %d&quot;</span><span class="p">,</span>
			       <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">orig_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rxchan_per_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__show_chan_per_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_txchan_per_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__show_chan_per_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_num_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">niu_parent_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">port_phy</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_port_phy</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">plat_type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_plat_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rxchan_per_port</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_rxchan_per_port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">txchan_per_port</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_txchan_per_port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">num_ports</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_num_ports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">niu_new_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
						    <span class="k">union</span> <span class="n">niu_parent_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
						    <span class="n">u8</span> <span class="n">ptype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">plat_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">plat_dev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;niu-board&quot;</span><span class="p">,</span> <span class="n">niu_parent_index</span><span class="p">,</span>
						   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">plat_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">attr_name</span><span class="p">(</span><span class="n">niu_parent_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">niu_parent_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_unregister</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">niu_parent_index</span><span class="o">++</span><span class="p">;</span>

	<span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">plat_dev</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">=</span> <span class="n">ptype</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">niu_parent_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rxdma_clock_divider</span> <span class="o">=</span> <span class="mi">7500</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tcam_num_entries</span> <span class="o">=</span> <span class="n">NIU_PCI_TCAM_ENTRIES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_NIU</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tcam_num_entries</span> <span class="o">=</span> <span class="n">NIU_NONPCI_TCAM_ENTRIES</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">CLASS_CODE_SCTP_IPV6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">CLASS_CODE_USER_PROG1</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tcam_key</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">TCAM_KEY_TSEL</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">flow_key</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLOW_KEY_IPSA</span> <span class="o">|</span>
				      <span class="n">FLOW_KEY_IPDA</span> <span class="o">|</span>
				      <span class="n">FLOW_KEY_PROTO</span> <span class="o">|</span>
				      <span class="p">(</span><span class="n">FLOW_KEY_L4_BYTE12</span> <span class="o">&lt;&lt;</span>
				       <span class="n">FLOW_KEY_L4_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				      <span class="p">(</span><span class="n">FLOW_KEY_L4_BYTE12</span> <span class="o">&lt;&lt;</span>
				       <span class="n">FLOW_KEY_L4_1_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LDN_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ldg_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDG_INVALID</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>

<span class="nl">fail_unregister:</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">plat_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">niu_get_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
						    <span class="k">union</span> <span class="n">niu_parent_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
						    <span class="n">u8</span> <span class="n">ptype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_parent_lock</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">niu_parent_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">niu_new_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ptype</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="s">&quot;port%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="n">port_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_parent_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_put_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">niu_parent</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;%s() port[%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="s">&quot;port%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_parent_lock</span><span class="p">);</span>

	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">port_name</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_parent_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">niu_pci_alloc_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				    <span class="n">u64</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dh</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dh</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">dh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_pci_free_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_pci_map_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_pci_unmap_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_address</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_pci_map_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_pci_unmap_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_address</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_ops</span> <span class="n">niu_pci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_coherent</span>	<span class="o">=</span> <span class="n">niu_pci_alloc_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_coherent</span>	<span class="o">=</span> <span class="n">niu_pci_free_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_page</span>	<span class="o">=</span> <span class="n">niu_pci_map_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_page</span>	<span class="o">=</span> <span class="n">niu_pci_unmap_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_single</span>	<span class="o">=</span> <span class="n">niu_pci_map_single</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_single</span>	<span class="o">=</span> <span class="n">niu_pci_unmap_single</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_driver_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">niu_version_printed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">niu_version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">niu_alloc_and_init</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gen_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span><span class="p">),</span> <span class="n">NIU_NUM_TXCHAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gen_dev</span><span class="p">);</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">gen_dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">niu_debug</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">niu_reset_task</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">niu_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">niu_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">niu_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">niu_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">niu_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">niu_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">niu_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">niu_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">niu_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">niu_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_assign_netdev_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">niu_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">niu_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">NIU_TX_TIMEOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_device_announce</span><span class="p">(</span><span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: NIU Ethernet %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">plat_type</span> <span class="o">==</span> <span class="n">PLAT_TYPE_ATCA_CP3220</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Port type[%s] mode[%s:%s] XCVR[%s] phy[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span> <span class="o">?</span> <span class="s">&quot;XMAC&quot;</span> <span class="o">:</span> <span class="s">&quot;BMAC&quot;</span><span class="p">),</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">?</span> <span class="s">&quot;10G&quot;</span> <span class="o">:</span> <span class="s">&quot;1G&quot;</span><span class="p">),</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_FIBER</span> <span class="o">?</span> <span class="s">&quot;RGMII FIBER&quot;</span> <span class="o">:</span> <span class="s">&quot;SERDES&quot;</span><span class="p">),</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">==</span> <span class="n">MAC_XCVR_MII</span> <span class="o">?</span> <span class="s">&quot;MII&quot;</span> <span class="o">:</span>
				 <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">==</span> <span class="n">MAC_XCVR_PCS</span> <span class="o">?</span> <span class="s">&quot;PCS&quot;</span> <span class="o">:</span> <span class="s">&quot;XPCS&quot;</span><span class="p">)),</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Port type[%s] mode[%s:%s] XCVR[%s] phy[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XMAC</span> <span class="o">?</span> <span class="s">&quot;XMAC&quot;</span> <span class="o">:</span> <span class="s">&quot;BMAC&quot;</span><span class="p">),</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_10G</span> <span class="o">?</span> <span class="s">&quot;10G&quot;</span> <span class="o">:</span> <span class="s">&quot;1G&quot;</span><span class="p">),</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_FIBER</span> <span class="o">?</span> <span class="s">&quot;FIBER&quot;</span> <span class="o">:</span>
				 <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NIU_FLAGS_XCVR_SERDES</span> <span class="o">?</span> <span class="s">&quot;SERDES&quot;</span> <span class="o">:</span>
				  <span class="s">&quot;COPPER&quot;</span><span class="p">)),</span>
				<span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">==</span> <span class="n">MAC_XCVR_MII</span> <span class="o">?</span> <span class="s">&quot;MII&quot;</span> <span class="o">:</span>
				 <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mac_xcvr</span> <span class="o">==</span> <span class="n">MAC_XCVR_PCS</span> <span class="o">?</span> <span class="s">&quot;PCS&quot;</span> <span class="o">:</span> <span class="s">&quot;XPCS&quot;</span><span class="p">)),</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">phy_type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">niu_set_basic_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXHASH</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_pci_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">niu_parent_id</span> <span class="n">parent_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>

	<span class="n">niu_driver_version</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot find proper PCI device base addresses, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot obtain PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot find PCI Express capability, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">niu_alloc_and_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">niu_pci_ops</span><span class="p">,</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">parent_id</span><span class="p">));</span>
	<span class="n">parent_id</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">parent_id</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">parent_id</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">niu_get_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent_id</span><span class="p">,</span>
				    <span class="n">PLAT_TYPE_ATLAS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">val16</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">;</span>
	<span class="n">val16</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_EXP_DEVCTL_CERE</span> <span class="o">|</span>
		  <span class="n">PCI_EXP_DEVCTL_NFERE</span> <span class="o">|</span>
		  <span class="n">PCI_EXP_DEVCTL_FERE</span> <span class="o">|</span>
		  <span class="n">PCI_EXP_DEVCTL_URRE</span> <span class="o">|</span>
		  <span class="n">PCI_EXP_DEVCTL_RELAX_EN</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">val16</span><span class="p">);</span>

	<span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to obtain 44 bit DMA for consistent allocations, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_release_parent</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_release_parent</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">niu_set_basic_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map device registers, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release_parent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">niu_assign_netdev_ops</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_get_invariants</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Problem fetching invariants of chip, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">niu_device_announce</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_iounmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out_release_parent:</span>
	<span class="n">niu_put_parent</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">niu_pci_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">niu_ldg_free</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="n">niu_put_parent</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">niu_netif_stop</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">niu_enable_interrupts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">niu_stop_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">niu_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_init_hw</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">niu_netif_start</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">niu_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">niu_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">niu_pci_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">niu_pci_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">niu_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">niu_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SPARC64</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">niu_phys_alloc_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="o">*</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">__get_free_pages</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_phys_free_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_phys_map_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_phys_unmap_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_address</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do.  */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">niu_phys_map_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__pa</span><span class="p">(</span><span class="n">cpu_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">niu_phys_unmap_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_address</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do.  */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">niu_ops</span> <span class="n">niu_phys_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_coherent</span>	<span class="o">=</span> <span class="n">niu_phys_alloc_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_coherent</span>	<span class="o">=</span> <span class="n">niu_phys_free_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_page</span>	<span class="o">=</span> <span class="n">niu_phys_map_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_page</span>	<span class="o">=</span> <span class="n">niu_phys_unmap_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_single</span>	<span class="o">=</span> <span class="n">niu_phys_map_single</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_single</span>	<span class="o">=</span> <span class="n">niu_phys_unmap_single</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">niu_of_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">niu_parent_id</span> <span class="n">parent_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">niu_driver_version</span><span class="p">();</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: No &#39;reg&#39; property, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">niu_alloc_and_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">niu_phys_ops</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">parent_id</span><span class="p">));</span>
	<span class="n">parent_id</span><span class="p">.</span><span class="n">of</span> <span class="o">=</span> <span class="n">of_get_parent</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">niu_get_parent</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent_id</span><span class="p">,</span>
				    <span class="n">PLAT_TYPE_NIU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">niu_set_basic_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
			      <span class="s">&quot;niu regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map device registers, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release_parent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
				    <span class="s">&quot;niu vregs-1&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map device vir registers 1, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
				    <span class="s">&quot;niu vregs-2&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map device vir registers 2, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">niu_assign_netdev_ops</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">niu_get_invariants</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Problem fetching invariants of chip, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">niu_device_announce</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_iounmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span><span class="p">,</span>
			   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span><span class="p">,</span>
			   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span>
			   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out_release_parent:</span>
	<span class="n">niu_put_parent</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">niu_of_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">niu</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span><span class="p">,</span>
				   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span><span class="p">,</span>
				   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">vir_regs_2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span>
				   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">niu_ldg_free</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="n">niu_put_parent</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">niu_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;SUNW,niusl&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">niu_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">niu_of_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;niu&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">niu_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">niu_of_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">niu_of_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SPARC64 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">niu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">niu_debug</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">NIU_MSG_DEFAULT</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SPARC64</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_of_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_pci_driver</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SPARC64</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_of_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">niu_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_pci_driver</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SPARC64</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">niu_of_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">niu_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">niu_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
