<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sun › sungem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sungem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: sungem.c,v 1.44.2.22 2002/03/13 01:18:12 davem Exp $</span>
<span class="cm"> * sungem.c: Sun GEM ethernet driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000, 2001, 2002, 2003 David S. Miller (davem@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Support for Apple GMAC and assorted PHYs, WOL, Power Management</span>
<span class="cm"> * (C) 2001,2002,2003 Benjamin Herrenscmidt (benh@kernel.crashing.org)</span>
<span class="cm"> * (C) 2004,2005 Benjamin Herrenscmidt, IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * NAPI and NETPOLL support</span>
<span class="cm"> * (C) 2004 by Eric Lemoine (eric.lemoine@gmail.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/sungem_phy.h&gt;</span>
<span class="cp">#include &quot;sungem.h&quot;</span>

<span class="cm">/* Stripping FCS is causing problems, disabled for now */</span>
<span class="cp">#undef STRIP_FCS</span>

<span class="cp">#define DEFAULT_MSG	(NETIF_MSG_DRV		| \</span>
<span class="cp">			 NETIF_MSG_PROBE	| \</span>
<span class="cp">			 NETIF_MSG_LINK)</span>

<span class="cp">#define ADVERTISE_MASK	(SUPPORTED_10baseT_Half | SUPPORTED_10baseT_Full | \</span>
<span class="cp">			 SUPPORTED_100baseT_Half | SUPPORTED_100baseT_Full | \</span>
<span class="cp">			 SUPPORTED_1000baseT_Half | SUPPORTED_1000baseT_Full | \</span>
<span class="cp">			 SUPPORTED_Pause | SUPPORTED_Autoneg)</span>

<span class="cp">#define DRV_NAME	&quot;sungem&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.0&quot;</span>
<span class="cp">#define DRV_AUTHOR	&quot;David S. Miller &lt;davem@redhat.com&gt;&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
        <span class="n">DRV_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_AUTHOR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun GEM Gbit ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define GEM_MODULE_NAME	&quot;gem&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">gem_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SUN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SUN_GEM</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>

	<span class="cm">/* These models only differ from the original GEM in</span>
<span class="cm">	 * that their tx/rx fifos are of a different size and</span>
<span class="cm">	 * they only support 10/100 speeds. -DaveM</span>
<span class="cm">	 *</span>
<span class="cm">	 * Apple&#39;s GMAC does support gigabit on machines with</span>
<span class="cm">	 * the BCM54xx PHYs. -BenH</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SUN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SUN_RIO_GEM</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_UNI_N_GMAC</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_UNI_N_GMACP</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_UNI_N_GMAC2</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_K2_GMAC</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_SH_SUNGEM</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_IPID2_GMAC</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">gem_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">__phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">cmd</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_PHYAD</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_REGAD</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MIF_FRAME_TAMSB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_FRAME</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_FRAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_TALSB</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">limit</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__phy_read</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">mii_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__phy_read</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">cmd</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_PHYAD</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_REGAD</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MIF_FRAME_TAMSB</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_DATA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_FRAME</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_FRAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">MIF_FRAME_TALSB</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__phy_write</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">mii_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__phy_write</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gem_enable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable all interrupts but TXDONE */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GREG_STAT_TXDONE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_IMASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gem_disable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable all interrupts, including TXDONE */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GREG_STAT_NAPI</span> <span class="o">|</span> <span class="n">GREG_STAT_TXDONE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_IMASK</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_IMASK</span><span class="p">);</span> <span class="cm">/* write posting */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_get_cell</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/* Turn off the chip&#39;s clock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_put_cell</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gem_netif_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>	<span class="cm">/* prevent tx timeout */</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gem_netif_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NOTE: unconditional netif_wake_queue is only</span>
<span class="cm">	 * appropriate so long as all callers are assured to</span>
<span class="cm">	 * have free tx slots.</span>
<span class="cm">	 */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_schedule_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_handle_mif_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: mif interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_pcs_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pcs_istat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_ISTAT</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pcs_miistat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: pcs interrupt, pcs_istat: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pcs_istat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcs_istat</span> <span class="o">&amp;</span> <span class="n">PCS_ISTAT_LSC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCS irq but no link status change???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The link status bit latches on zero, so you must</span>
<span class="cm">	 * read it twice in such a case to see a transition</span>
<span class="cm">	 * to the link being up.</span>
<span class="cm">	 */</span>
	<span class="n">pcs_miistat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIISTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcs_miistat</span> <span class="o">&amp;</span> <span class="n">PCS_MIISTAT_LS</span><span class="p">))</span>
		<span class="n">pcs_miistat</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIISTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">PCS_MIISTAT_LS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcs_miistat</span> <span class="o">&amp;</span> <span class="n">PCS_MIISTAT_ANC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The remote-fault indication is only valid</span>
<span class="cm">		 * when autoneg has completed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcs_miistat</span> <span class="o">&amp;</span> <span class="n">PCS_MIISTAT_RF</span><span class="p">)</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCS AutoNEG complete, RemoteFault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCS AutoNEG complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcs_miistat</span> <span class="o">&amp;</span> <span class="n">PCS_MIISTAT_LS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCS link is now up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCS link is now down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* If this happens and the link timer is not running,</span>
<span class="cm">		 * reset so we re-negotiate.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_txmac_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">txmac_stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXSTAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: txmac interrupt, txmac_stat: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">txmac_stat</span><span class="p">);</span>

	<span class="cm">/* Defer timer expiration is quite normal,</span>
<span class="cm">	 * don&#39;t even log the event.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_TXSTAT_DTE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_TXSTAT_DTE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_TXSTAT_URUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX MAC xmit underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_TXSTAT_MPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX MAC max packet size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The rest are all cases of one of the 16-bit TX</span>
<span class="cm">	 * counters expiring.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_TXSTAT_NCE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_TXSTAT_ECE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_TXSTAT_LCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We do not keep track of MAC_TXSTAT_FCE and</span>
<span class="cm">	 * MAC_TXSTAT_PCE events.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* When we get a RX fifo overflow, the RX unit in GEM is probably hung</span>
<span class="cm"> * so we do the following.</span>
<span class="cm"> *</span>
<span class="cm"> * If any part of the reset goes wrong, we return 1 and that causes the</span>
<span class="cm"> * whole chip to be reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_rxmac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">desc_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* First, reset &amp; disable MAC RX. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MAC_RXRST_CMD</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXRST</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">limit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXRST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_RXRST_CMD</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX MAC will not reset, resetting whole chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">mac_rx_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_RXCFG_ENAB</span><span class="p">,</span>
	       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">limit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_RXCFG_ENAB</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX MAC will not disable, resetting whole chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Second, disable RX DMA. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">limit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_CFG_ENABLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX DMA will not disable, resetting whole chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Execute RX reset command. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">swrst_base</span> <span class="o">|</span> <span class="n">GREG_SWRST_RXRST</span><span class="p">,</span>
	       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_SWRST</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">limit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_SWRST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_SWRST_RXRST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX reset command will not execute, resetting whole chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Refresh the RX ring. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem_rxd</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Parts of RX ring empty, resetting whole chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status_word</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">RXDCTRL_FRESH</span><span class="p">(</span><span class="n">gp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Now we must reprogram the rest of RX unit. */</span>
	<span class="n">desc_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">gblock_dvma</span><span class="p">;</span>
	<span class="n">desc_dma</span> <span class="o">+=</span> <span class="p">(</span><span class="n">INIT_BLOCK_TX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem_txd</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">desc_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DBHI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">desc_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DBLOW</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_KICK</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXDMA_CFG_BASE</span> <span class="o">|</span> <span class="p">(</span><span class="n">RX_OFFSET</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="mi">14</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">RXDMA_CFG_FTHRESH_128</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_BIFCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_BIFCFG_M66EN</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(((</span><span class="mi">5</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_IPKTS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_ITIME</span><span class="p">)),</span>
		       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_BLANK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(((</span><span class="mi">5</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_IPKTS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_ITIME</span><span class="p">)),</span>
		       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_BLANK</span><span class="p">);</span>
	<span class="n">val</span>  <span class="o">=</span> <span class="p">(((</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_off</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_PTHRESH_OFF</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_on</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_PTHRESH_ON</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_PTHRESH</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">RXDMA_CFG_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MAC_RXSTAT_RCV</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXMASK</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">MAC_RXCFG_ENAB</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_rxmac_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rxmac_stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXSTAT</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: rxmac interrupt, rxmac_stat: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rxmac_stat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_RXSTAT_OFLW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">smac</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_SMACHINE</span><span class="p">);</span>

		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX MAC fifo overflow smac[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smac</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gem_rxmac_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_RXSTAT_ACE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_RXSTAT_CCE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxmac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_RXSTAT_LCE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="cm">/* We do not track MAC_RXSTAT_FCE and MAC_RXSTAT_VCE</span>
<span class="cm">	 * events.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_mac_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mac_cstat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_CSTAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: mac interrupt, mac_cstat: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mac_cstat</span><span class="p">);</span>

	<span class="cm">/* This interrupt is just for pause frame and pause</span>
<span class="cm">	 * tracking.  It is useful for diagnostics and debug</span>
<span class="cm">	 * but probably by default we will mask these events.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_cstat</span> <span class="o">&amp;</span> <span class="n">MAC_CSTAT_PS</span><span class="p">)</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">pause_entered</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_cstat</span> <span class="o">&amp;</span> <span class="n">MAC_CSTAT_PRCV</span><span class="p">)</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">pause_last_time_recvd</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_cstat</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_mif_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mif_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_STATUS</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">changed_bits</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">mif_status</span> <span class="o">&amp;</span> <span class="n">MIF_STATUS_DATA</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">changed_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">mif_status</span> <span class="o">&amp;</span> <span class="n">MIF_STATUS_STAT</span><span class="p">);</span>

	<span class="n">gem_handle_mif_event</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">changed_bits</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_pci_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pci_estat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_PCIESTAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_GEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI error [%04x]&quot;</span><span class="p">,</span> <span class="n">pci_estat</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_estat</span> <span class="o">&amp;</span> <span class="n">GREG_PCIESTAT_BADACK</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; &lt;No ACK64# during ABS64 cycle&gt;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_estat</span> <span class="o">&amp;</span> <span class="n">GREG_PCIESTAT_DTRTO</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; &lt;Delayed transaction timeout&gt;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_estat</span> <span class="o">&amp;</span> <span class="n">GREG_PCIESTAT_OTHER</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; &lt;other&gt;&quot;</span><span class="p">);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_estat</span> <span class="o">|=</span> <span class="n">GREG_PCIESTAT_OTHER</span><span class="p">;</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_estat</span> <span class="o">&amp;</span> <span class="n">GREG_PCIESTAT_OTHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pci_cfg_stat</span><span class="p">;</span>

		<span class="cm">/* Interrogate PCI config space for the</span>
<span class="cm">		 * true cause.</span>
<span class="cm">		 */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">pci_cfg_stat</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read PCI cfg space status [%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pci_cfg_stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_stat</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_PARITY</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI parity error detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_stat</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI target abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_stat</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_REC_TARGET_ABORT</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI master acks target abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_stat</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_REC_MASTER_ABORT</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI master abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_stat</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI system error SERR#</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_stat</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_DETECTED_PARITY</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Write the error bits back to clear them. */</span>
		<span class="n">pci_cfg_stat</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">PCI_STATUS_PARITY</span> <span class="o">|</span>
				 <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span> <span class="o">|</span>
				 <span class="n">PCI_STATUS_REC_TARGET_ABORT</span> <span class="o">|</span>
				 <span class="n">PCI_STATUS_REC_MASTER_ABORT</span> <span class="o">|</span>
				 <span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span> <span class="o">|</span>
				 <span class="n">PCI_STATUS_DETECTED_PARITY</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">pci_cfg_stat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For all PCI errors, we should reset the chip. */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* All non-normal interrupt conditions get serviced here.</span>
<span class="cm"> * Returns non-zero if we should just exit the interrupt</span>
<span class="cm"> * handler right now (ie. if we reset the card which invalidates</span>
<span class="cm"> * all of the other original irq status bits).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_abnormal_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXNOBUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Frame arrived, no free RX buffers available. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: no buffer for rx frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXTAGERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* corrupt RX tag framing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: corrupt rx tag framing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_PCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_pcs_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_txmac_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_RXMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_rxmac_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_MAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_mac_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_MIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_mif_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_PCIERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_pci_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">gem_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gem_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">gem_status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_TXNR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">GREG_STAT_TXNR_SHIFT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gem_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">dma_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_done</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: tx done, slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">walk</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">incomplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">last</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
				<span class="n">walk</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">walk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">walk</span> <span class="o">==</span> <span class="n">limit</span><span class="p">)</span>
					<span class="n">incomplete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">walk</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">incomplete</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">control_word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXDCTRL_BUFSZ</span><span class="p">;</span>

			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="cm">/* Need to make the tx_old update visible to gem_start_xmit()</span>
<span class="cm">	 * before checking for netif_queue_stopped().  Without the</span>
<span class="cm">	 * memory barrier, there is a small possibility that gem_start_xmit()</span>
<span class="cm">	 * will miss it and cause the queue to be stopped forever.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">gem_post_rxds</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cluster_start</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">kick</span><span class="p">;</span>

	<span class="n">cluster_start</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kick</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">curr</span> <span class="o">!=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curr</span> <span class="o">=</span> <span class="n">NEXT_RX</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">gem_rxd</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">[</span><span class="n">cluster_start</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
				<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status_word</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">RXDCTRL_FRESH</span><span class="p">(</span><span class="n">gp</span><span class="p">));</span>
				<span class="n">rxd</span><span class="o">++</span><span class="p">;</span>
				<span class="n">cluster_start</span> <span class="o">=</span> <span class="n">NEXT_RX</span><span class="p">(</span><span class="n">cluster_start</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cluster_start</span> <span class="o">==</span> <span class="n">curr</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kick</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kick</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">kick</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_KICK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define ALIGNED_RX_SKB_ADDR(addr) \</span>
<span class="cp">        ((((unsigned long)(addr) + (64UL - 1UL)) &amp; ~(64UL - 1UL)) - (unsigned long)(addr))</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">gem_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
						<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ALIGNED_RX_SKB_ADDR</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">drops</span><span class="p">,</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">__sum16</span> <span class="n">csum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: rx interrupt, done: %d, rx_new: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DONE</span><span class="p">),</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">;</span>
	<span class="n">drops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">done</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DONE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem_rxd</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status_word</span><span class="p">);</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXDCTRL_OWN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">RX_RING_SIZE</span> <span class="o">||</span> <span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">work_to_do</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* When writing back RX descriptor, GEM writes status</span>
<span class="cm">		 * then buffer address, possibly in separate transactions.</span>
<span class="cm">		 * If we don&#39;t wait for the chip to write both, we could</span>
<span class="cm">		 * post a new buffer to this descriptor then have GEM spam</span>
<span class="cm">		 * on the buffer address.  We sync on the RX completion</span>
<span class="cm">		 * register to prevent this from happening.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DONE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">done</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* We can now account for the work we&#39;re about to do */</span>
		<span class="n">work_done</span><span class="o">++</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXDCTRL_BUFSZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXDCTRL_BAD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">RXDCTRL_BAD</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* We&#39;ll just return it to GEM. */</span>
		<span class="nl">drop_it:</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RX_COPY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>

			<span class="n">new_skb</span> <span class="o">=</span> <span class="n">gem_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drops</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
				       <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="n">RX_OFFSET</span><span class="p">));</span>
			<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">pci_map_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							       <span class="n">virt_to_page</span><span class="p">(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
							       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
							       <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span>
							       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">RX_OFFSET</span><span class="p">);</span>

			<span class="cm">/* Trim the original skb for the netif. */</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">copy_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drops</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">copy_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="cm">/* We&#39;ll reuse the original ring buffer. */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">copy_skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">csum</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__sum16</span><span class="p">)</span><span class="n">htons</span><span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXDCTRL_TCPCSUM</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_unfold</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="nl">next:</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_RX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gem_post_rxds</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drops</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory squeeze, deferring packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Handle anomalies */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_ABNORMAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>

			<span class="cm">/* We run the abnormal interrupt handling code with</span>
<span class="cm">			 * the Tx lock. It only resets the Rx portion of the</span>
<span class="cm">			 * chip, but we need to guard it against DMA being</span>
<span class="cm">			 * restarted by the link poll timer</span>
<span class="cm">			 */</span>
			<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
			<span class="n">reset</span> <span class="o">=</span> <span class="n">gem_abnormal_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gem_schedule_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
				<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Run TX completion thread */</span>
		<span class="n">gem_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="cm">/* Run RX thread. We don&#39;t use any locking here,</span>
<span class="cm">		 * code willing to do bad things - like cleaning the</span>
<span class="cm">		 * rx ring - must call napi_disable(), which</span>
<span class="cm">		 * schedule_timeout()&#39;s if polling is already disabled.</span>
<span class="cm">		 */</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">gem_rx</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">work_done</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>

		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_STAT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GREG_STAT_NAPI</span><span class="p">);</span>

	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">gem_enable_ints</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">gem_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gem_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_STAT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gem_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: gem_interrupt() gem_status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">gem_status</span><span class="p">);</span>

		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">gem_status</span><span class="p">;</span>
		<span class="n">gem_disable_ints</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If polling was disabled at the time we received that</span>
<span class="cm">	 * interrupt, we may return IRQ_HANDLED here while we</span>
<span class="cm">	 * should return IRQ_NONE. No big deal...</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">gem_interrupt</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX_STATE[%08x:%08x:%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXSTAT</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">));</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX_STATE[%08x:%08x:%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXSTAT</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">));</span>

	<span class="n">gem_schedule_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">gem_intme</span><span class="p">(</span><span class="kt">int</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Algorithm: IRQ every 1/2 of descriptors. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">TX_RING_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">gem_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="n">csum_start_off</span> <span class="o">=</span> <span class="n">skb_checksum_start_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="n">csum_stuff_off</span> <span class="o">=</span> <span class="n">csum_start_off</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">TXDCTRL_CENAB</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">csum_start_off</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">csum_stuff_off</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* This is a hard error, log it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG! Tx Ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem_txd</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				       <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">TXDCTRL_SOF</span> <span class="o">|</span> <span class="n">TXDCTRL_EOF</span> <span class="o">|</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_intme</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">TXDCTRL_INTME</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">control_word</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">first_len</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">intme</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">first_mapping</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">first_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

		<span class="n">intme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gem_intme</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">intme</span> <span class="o">|=</span> <span class="n">TXDCTRL_INTME</span><span class="p">;</span>

		<span class="cm">/* We must give this initial chunk to the device last.</span>
<span class="cm">		 * Otherwise we could race with the device.</span>
<span class="cm">		 */</span>
		<span class="n">first_len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">first_mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					     <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					     <span class="n">first_len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">this_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">frag</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">this_ctrl</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">this_frag</span><span class="p">);</span>
			<span class="n">mapping</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">this_frag</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">this_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">this_ctrl</span> <span class="o">|=</span> <span class="n">TXDCTRL_EOF</span><span class="p">;</span>

			<span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
			<span class="n">txd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">txd</span><span class="o">-&gt;</span><span class="n">control_word</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">this_ctrl</span> <span class="o">|</span> <span class="n">len</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gem_intme</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
				<span class="n">intme</span> <span class="o">|=</span> <span class="n">TXDCTRL_INTME</span><span class="p">;</span>

			<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">[</span><span class="n">first_entry</span><span class="p">];</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">first_mapping</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">control_word</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">TXDCTRL_SOF</span> <span class="o">|</span> <span class="n">intme</span> <span class="o">|</span> <span class="n">first_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* netif_stop_queue() must be done before checking</span>
<span class="cm">		 * checking tx index in TX_BUFFS_AVAIL() below, because</span>
<span class="cm">		 * in gem_tx(), we update tx_old before checking for</span>
<span class="cm">		 * netif_queue_stopped().</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: tx queued, slot %d, skblen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_KICK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_pcs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Reset PCS unit. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIICTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">PCS_MIICTRL_RST</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIICTRL</span><span class="p">);</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIICTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCS_MIICTRL_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCS reset bit would not clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_pcs_reinit_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Make sure PCS is disabled while changing advertisement</span>
<span class="cm">	 * configuration.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCS_CFG_ENABLE</span> <span class="o">|</span> <span class="n">PCS_CFG_TO</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_CFG</span><span class="p">);</span>

	<span class="cm">/* Advertise all capabilities except asymmetric</span>
<span class="cm">	 * pause.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIIADV</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCS_MIIADV_FD</span> <span class="o">|</span> <span class="n">PCS_MIIADV_HD</span> <span class="o">|</span>
		<span class="n">PCS_MIIADV_SP</span> <span class="o">|</span> <span class="n">PCS_MIIADV_AP</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIIADV</span><span class="p">);</span>

	<span class="cm">/* Enable and restart auto-negotiation, disable wrapback/loopback,</span>
<span class="cm">	 * and re-enable PCS.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIICTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCS_MIICTRL_RAN</span> <span class="o">|</span> <span class="n">PCS_MIICTRL_ANE</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCS_MIICTRL_WB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIICTRL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">PCS_CFG_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_CFG</span><span class="p">);</span>

	<span class="cm">/* Make sure serialink loopback is off.  The meaning</span>
<span class="cm">	 * of this bit is logically inverted based upon whether</span>
<span class="cm">	 * you are in Serialink or SERDES mode.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_SCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serialink</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCS_SCTRL_LOOP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCS_SCTRL_LOOP</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_SCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define STOP_TRIES 32</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Make sure we won&#39;t get any more interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_IMASK</span><span class="p">);</span>

	<span class="cm">/* Reset the chip */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">swrst_base</span> <span class="o">|</span> <span class="n">GREG_SWRST_TXRST</span> <span class="o">|</span> <span class="n">GREG_SWRST_RXRST</span><span class="p">,</span>
	       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_SWRST</span><span class="p">);</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="n">STOP_TRIES</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_SWRST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GREG_SWRST_TXRST</span> <span class="o">|</span> <span class="n">GREG_SWRST_RXRST</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SW reset is ghetto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serialink</span> <span class="o">||</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serdes</span><span class="p">)</span>
		<span class="n">gem_pcs_reinit_adv</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* We are ready to rock, turn everything on. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">TXDMA_CFG_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">RXDMA_CFG_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">MAC_TXCFG_ENAB</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">MAC_RXCFG_ENAB</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">gem_enable_ints</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_KICK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DMA won&#39;t be actually stopped before about 4ms tho ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_stop_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* We are done rocking, turn everything off. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXDMA_CFG_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RXDMA_CFG_ENABLE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_TXCFG_ENAB</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_RXCFG_ENAB</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>

	<span class="cm">/* Need to wait a bit ... done by the caller */</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>XXX dbl check what that function should do when called on PCS PHY</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_begin_auto_negotiation</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">advertise</span><span class="p">,</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">phy_mii_mdio0</span> <span class="o">&amp;&amp;</span>
     	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">phy_mii_mdio1</span><span class="p">)</span>
     	    	<span class="k">goto</span> <span class="n">non_mii</span><span class="p">;</span>

	<span class="cm">/* Setup advertise */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">advertise</span> <span class="o">=</span> <span class="n">features</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">advertising</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">advertise</span> <span class="o">&amp;=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>

	<span class="n">autoneg</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">duplex</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>

	<span class="cm">/* Setup link parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">start_aneg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">advertise</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">;</span>
		<span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">duplex</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">start_aneg:</span>
	<span class="cm">/* Sanitize settings based on PHY capabilities */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">)))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">)))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
	    		  <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
	    		  <span class="n">SUPPORTED_10baseT_Full</span><span class="p">)))</span>
	    	<span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>

	<span class="cm">/* If we are asleep, we don&#39;t try to actually setup the PHY, we</span>
<span class="cm">	 * just store the settings</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span> <span class="o">=</span> <span class="n">autoneg</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">duplex</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure PHY &amp; start aneg */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span> <span class="o">=</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_aneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span> <span class="n">advertise</span><span class="p">);</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_aneg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_forced</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">);</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_force_ok</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">non_mii:</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="mi">12</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* A link-up condition has occurred, initialize and enable the</span>
<span class="cm"> * rest of the chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_set_link_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">full_duplex</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">pause</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
	<span class="n">pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span> <span class="p">{</span>
	    	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">))</span>
	    		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">);</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">pause</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">pause</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serialink</span> <span class="o">||</span>
	    	   <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serdes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pcs_lpa</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIILP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pcs_lpa</span> <span class="o">&amp;</span> <span class="n">PCS_MIIADV_FD</span><span class="p">)</span> <span class="o">||</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serdes</span><span class="p">)</span>
			<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is up at %d Mbps, %s-duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">speed</span><span class="p">,</span> <span class="p">(</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">));</span>


	<span class="cm">/* We take the tx queue lock to avoid collisions between</span>
<span class="cm">	 * this code, the tx path and the NAPI-driven error path</span>
<span class="cm">	 */</span>
	<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_TXCFG_EIPG0</span> <span class="o">|</span> <span class="n">MAC_TXCFG_NGU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_TXCFG_ICS</span> <span class="o">|</span> <span class="n">MAC_TXCFG_ICOLL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MAC_TXCFG_NBO must be zero. */</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_XIFCFG_OE</span> <span class="o">|</span> <span class="n">MAC_XIFCFG_LLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">full_duplex</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio0</span> <span class="o">||</span>
	     <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_XIFCFG_DISE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_XIFCFG_FLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_XIFCFG_GMII</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">);</span>

	<span class="cm">/* If gigabit and half-duplex, enable carrier extension</span>
<span class="cm">	 * mode.  Else, disable it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">MAC_TXCFG_TCE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">MAC_RXCFG_RCE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_TXCFG_TCE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_RXCFG_RCE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serialink</span> <span class="o">||</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serdes</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">u32</span> <span class="n">pcs_lpa</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIILP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pcs_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCS_MIIADV_SP</span> <span class="o">|</span> <span class="n">PCS_MIIADV_AP</span><span class="p">))</span>
			<span class="n">pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">full_duplex</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_STIME</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_STIME</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MCCFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_MCCFG_SPE</span> <span class="o">|</span> <span class="n">MAC_MCCFG_RPE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_MCCFG_SPE</span> <span class="o">|</span> <span class="n">MAC_MCCFG_RPE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MCCFG</span><span class="p">);</span>

	<span class="n">gem_start_dma</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;Pause is enabled (rxfifo: %d off: %d on: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span><span class="p">,</span>
				    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_off</span><span class="p">,</span>
				    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_on</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Pause is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_mdio_link_not_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">link_force_ret</span>:
		<span class="n">netif_info</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Autoneg failed again, keeping forced mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_forced</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">last_forced_speed</span><span class="p">,</span> <span class="n">DUPLEX_HALF</span><span class="p">);</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_force_ok</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">link_aneg</span>:
		<span class="cm">/* We try forced modes after a failed aneg only on PHYs that don&#39;t</span>
<span class="cm">		 * have &quot;magic_aneg&quot; bit set, which means they internally do the</span>
<span class="cm">		 * while forced-mode thingy. On these, we just restart aneg</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">magic_aneg</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;switching to forced 100bt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Try forced modes. */</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_forced</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">,</span>
			<span class="n">DUPLEX_HALF</span><span class="p">);</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_force_try</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">link_force_try</span>:
		<span class="cm">/* Downgrade from 100 to 10 Mbps if necessary.</span>
<span class="cm">		 * If already at 10Mbps, warn user about the</span>
<span class="cm">		 * situation every 10 ticks.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_forced</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">,</span>
				<span class="n">DUPLEX_HALF</span><span class="p">);</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;switching to forced 10bt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_link_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart_aneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* There&#39;s no point doing anything if we&#39;re going to be reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task_pending</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serialink</span> <span class="o">||</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serdes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIISTAT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCS_MIISTAT_LS</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_MIISTAT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCS_MIISTAT_LS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">link_up</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">gem_set_link_modes</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">poll_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Ok, here we got a link. If we had it due to a forced</span>
<span class="cm">		 * fallback, and we were configured for autoneg, we do</span>
<span class="cm">		 * retry a short autoneg pass. If you know your hub is</span>
<span class="cm">		 * broken, use ethtool ;)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">link_force_try</span> <span class="o">&amp;&amp;</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_force_ret</span><span class="p">;</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">last_forced_speed</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;Got link after fallback, retrying autoneg once...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_aneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">!=</span> <span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_up</span><span class="p">;</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gem_set_link_modes</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
				<span class="n">restart_aneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If the link was previously up, we restart the</span>
<span class="cm">		 * whole process</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_down</span><span class="p">;</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">gem_schedule_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
			<span class="cm">/* The reset task will restart the timer */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
				<span class="n">restart_aneg</span> <span class="o">=</span> <span class="n">gem_mdio_link_not_up</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">restart_aneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart_aneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gem_begin_auto_negotiation</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">restart:</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="mi">12</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_clean_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem_init_block</span> <span class="o">*</span><span class="n">gb</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>

		<span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
				       <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">gem_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">ent</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">[</span><span class="n">ent</span><span class="p">];</span>
				<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
				<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
					       <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">control_word</span><span class="p">)</span> <span class="o">&amp;</span>
					       <span class="n">TXDCTRL_BUFSZ</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem_init_block</span> <span class="o">*</span><span class="n">gb</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gem_clean_rings</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">VLAN_ETH_FRAME_LEN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gem_rxd</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">gem_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="n">RX_OFFSET</span><span class="p">));</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					<span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					<span class="n">RX_BUF_ALLOC_SIZE</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span>
					<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status_word</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">RXDCTRL_FRESH</span><span class="p">(</span><span class="n">gp</span><span class="p">));</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RX_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem_txd</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">control_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Init PHY interface and start link poll state machine */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mifcfg</span><span class="p">;</span>

	<span class="cm">/* Revert MIF CFG setting done on stop_phy */</span>
	<span class="n">mifcfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
	<span class="n">mifcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIF_CFG_BBMODE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mifcfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Those delay sucks, the HW seem to love them though, I&#39;ll</span>
<span class="cm">		 * serisouly consider breaking some locks here to be able</span>
<span class="cm">		 * to schedule instead</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
			<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_GMAC_PHY_RESET</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* Some PHYs used by apple have problem getting back to us,</span>
<span class="cm">			 * we do an additional reset here</span>
<span class="cm">			 */</span>
			<span class="n">phy_write</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_read</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">netdev_warn</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GMAC PHY not responding !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_GEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* Init datapath mode register. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio0</span> <span class="o">||</span>
		    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">PCS_DMODE_MGM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serialink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">PCS_DMODE_SM</span> <span class="o">|</span> <span class="n">PCS_DMODE_GMOE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">PCS_DMODE_ESM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_DMODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio0</span> <span class="o">||</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset and detect MII PHY */</span>
		<span class="n">sungem_phy_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span><span class="p">);</span>

		<span class="cm">/* Init PHY */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span> <span class="o">&amp;&amp;</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gem_pcs_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="n">gem_pcs_reinit_adv</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Default aneg parameters */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_down</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Print things out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio0</span> <span class="o">||</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio1</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found %s PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span> <span class="o">?</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="n">gem_begin_auto_negotiation</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">desc_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">gblock_dvma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">TXDMA_CFG_BASE</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7ff</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXDMA_CFG_PMODE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">desc_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_DBHI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">desc_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_DBLOW</span><span class="p">);</span>
	<span class="n">desc_dma</span> <span class="o">+=</span> <span class="p">(</span><span class="n">INIT_BLOCK_TX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem_txd</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_KICK</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXDMA_CFG_BASE</span> <span class="o">|</span> <span class="p">(</span><span class="n">RX_OFFSET</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="mi">14</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">RXDMA_CFG_FTHRESH_128</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">desc_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DBHI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">desc_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_DBLOW</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_KICK</span><span class="p">);</span>

	<span class="n">val</span>  <span class="o">=</span> <span class="p">(((</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_off</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_PTHRESH_OFF</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_on</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_PTHRESH_ON</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_PTHRESH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_BIFCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_BIFCFG_M66EN</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(((</span><span class="mi">5</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_IPKTS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_ITIME</span><span class="p">)),</span>
		       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_BLANK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(((</span><span class="mi">5</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_IPKTS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RXDMA_BLANK_ITIME</span><span class="p">)),</span>
		       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_BLANK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gem_setup_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rxcfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">))</span> <span class="p">{</span>
	    	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_HASH0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">MAC_RXCFG_HFE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">MAC_RXCFG_PROM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">hash_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hash_table</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">hash_table</span><span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
		<span class="p">}</span>
	    	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_HASH0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">MAC_RXCFG_HFE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rxcfg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x1bf0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_SNDPAUSE</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_IPG0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_IPG1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_IPG2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_STIME</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MINFSZ</span><span class="p">);</span>

	<span class="cm">/* Ethernet payload + header + FCS + optional VLAN tag. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x20000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MAXFSZ</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_PASIZE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_JAMSIZE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ATTLIM</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x8808</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MCTYPE</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RANDSEED</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR2</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR3</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR4</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR5</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR6</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xc200</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR7</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0180</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR8</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AFILT0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AFILT1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AFILT2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AF21MSK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AF0MSK</span><span class="p">);</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">mac_rx_cfg</span> <span class="o">=</span> <span class="n">gem_setup_multicast</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
<span class="cp">#ifdef STRIP_FCS</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">mac_rx_cfg</span> <span class="o">|=</span> <span class="n">MAC_RXCFG_SFCS</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_NCOLL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_FASUCC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ECOLL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_LCOLL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_DTIMER</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_PATMPS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RFCTR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_LERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_FCSERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCVERR</span><span class="p">);</span>

	<span class="cm">/* Clear RX/TX/MAC/XIF config, we will set these up and enable</span>
<span class="cm">	 * them once a link is established.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">mac_rx_cfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MCCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">);</span>

	<span class="cm">/* Setup MAC interrupts.  We want to get all of the interesting</span>
<span class="cm">	 * counter expiration events, but we do not want to hear about</span>
<span class="cm">	 * normal rx/tx as the DMA engine tells us that.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MAC_TXSTAT_XMIT</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXMASK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MAC_RXSTAT_RCV</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXMASK</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t enable even the PAUSE interrupts for now, we</span>
<span class="cm">	 * make no use of those events other than to record them.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_MCMASK</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t enable GEM&#39;s WOL in normal operations</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">has_wol</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_WAKECSR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_init_pause_thresholds</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
       	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* Calculate pause thresholds.  Setting the OFF threshold to the</span>
<span class="cm">	 * full RX fifo size effectively disables PAUSE generation which</span>
<span class="cm">	 * is what we do for 10/100 only GEMs which have FIFOs too small</span>
<span class="cm">	 * to make real gains from PAUSE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_off</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_on</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_frame</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">on</span> <span class="o">=</span> <span class="n">off</span> <span class="o">-</span> <span class="n">max_frame</span><span class="p">;</span>

		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_off</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_pause_on</span> <span class="o">=</span> <span class="n">on</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Configure the chip &quot;burst&quot; DMA mode &amp; enable some</span>
<span class="cm">	 * HW bug fixes on Apple version</span>
<span class="cm">	 */</span>
       	<span class="n">cfg</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">GREG_CFG_RONPAULBIT</span> <span class="o">|</span> <span class="n">GREG_CFG_ENBUG2FIX</span><span class="p">;</span>
<span class="cp">#if !defined(CONFIG_SPARC64) &amp;&amp; !defined(CONFIG_ALPHA)</span>
       	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">GREG_CFG_IBURST</span><span class="p">;</span>
<span class="cp">#endif</span>
       	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">31</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_CFG_TXDMALIM</span><span class="p">);</span>
       	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">31</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_CFG_RXDMALIM</span><span class="p">);</span>
       	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">);</span>

	<span class="cm">/* If Infinite Burst didn&#39;t stick, then use different</span>
<span class="cm">	 * thresholds (and Apple bug fixes don&#39;t exist)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_CFG_IBURST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_CFG_TXDMALIM</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GREG_CFG_RXDMALIM</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GREG_CFG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_check_invariants</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mif_cfg</span><span class="p">;</span>

	<span class="cm">/* On Apple&#39;s sungem, we can&#39;t rely on registers as the chip</span>
<span class="cm">	 * was been powered down by the firmware. The PHY is looked</span>
<span class="cm">	 * up later on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">phy_mii_mdio0</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_fifo_sz</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_FSZ</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_FSZ</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">swrst_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mif_cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
		<span class="n">mif_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MIF_CFG_PSELECT</span><span class="o">|</span><span class="n">MIF_CFG_POLL</span><span class="o">|</span><span class="n">MIF_CFG_BBMODE</span><span class="o">|</span><span class="n">MIF_CFG_MDI1</span><span class="p">);</span>
		<span class="n">mif_cfg</span> <span class="o">|=</span> <span class="n">MIF_CFG_MDI0</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mif_cfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">PCS_DMODE_MGM</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PCS_DMODE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MAC_XIFCFG_OE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">);</span>

		<span class="cm">/* We hard-code the PHY address so we can properly bring it out of</span>
<span class="cm">		 * reset later on, we can&#39;t really probe it at this point, though</span>
<span class="cm">		 * that isn&#39;t an issue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_APPLE_K2_GMAC</span><span class="p">)</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mif_cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_RIO_GEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* One of the MII PHYs _must_ be present</span>
<span class="cm">		 * as this chip has no gigabit PHY.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mif_cfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MIF_CFG_MDI0</span> <span class="o">|</span> <span class="n">MIF_CFG_MDI1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO GEM lacks MII phy, mif_cfg[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mif_cfg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Determine initial PHY interface type guess.  MDIO1 is the</span>
<span class="cm">	 * external PHY and thus takes precedence over MDIO0.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mif_cfg</span> <span class="o">&amp;</span> <span class="n">MIF_CFG_MDI1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">phy_mii_mdio1</span><span class="p">;</span>
		<span class="n">mif_cfg</span> <span class="o">|=</span> <span class="n">MIF_CFG_PSELECT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mif_cfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mif_cfg</span> <span class="o">&amp;</span> <span class="n">MIF_CFG_MDI0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">phy_mii_mdio0</span><span class="p">;</span>
		<span class="n">mif_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIF_CFG_PSELECT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mif_cfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;shared-pins&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;serdes&quot;</span><span class="p">))</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">phy_serdes</span><span class="p">;</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">phy_serialink</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio1</span> <span class="o">||</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_read</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_SUN_GEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO MII phy will not respond</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">phy_serdes</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fetch the FIFO configurations now too. */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_fifo_sz</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_FSZ</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_FSZ</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_GEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_fifo_sz</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;GEM has bogus fifo sizes tx(%d) rx(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_fifo_sz</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">swrst_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_fifo_sz</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO GEM has bogus fifo sizes tx(%d) rx(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">tx_fifo_sz</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">rx_fifo_sz</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">swrst_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">GREG_SWRST_CACHE_SHIFT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_reinit_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reset the chip */</span>
	<span class="n">gem_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Make sure ints are disabled */</span>
	<span class="n">gem_disable_ints</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Allocate &amp; setup ring buffers */</span>
	<span class="n">gem_init_rings</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Configure pause thresholds */</span>
	<span class="n">gem_init_pause_thresholds</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Init DMA &amp; MAC engines */</span>
	<span class="n">gem_init_dma</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">gem_init_mac</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_stop_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mifcfg</span><span class="p">;</span>

	<span class="cm">/* Let the chip settle down a bit, it seems that helps</span>
<span class="cm">	 * for sleep mode on some models</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Make sure we aren&#39;t polling PHY status change. We</span>
<span class="cm">	 * don&#39;t currently use that feature though</span>
<span class="cm">	 */</span>
	<span class="n">mifcfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
	<span class="n">mifcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIF_CFG_POLL</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mifcfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span> <span class="o">&amp;&amp;</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">has_wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

		<span class="cm">/* Setup wake-on-lan for MAGIC packet */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MAC_RXCFG_HFE</span> <span class="o">|</span> <span class="n">MAC_RXCFG_SFCS</span> <span class="o">|</span> <span class="n">MAC_RXCFG_ENAB</span><span class="p">,</span>
		       <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_MATCH0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_MATCH1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_MATCH2</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">WOL_MCOUNT_N</span> <span class="o">|</span> <span class="n">WOL_MCOUNT_M</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_MCOUNT</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">WOL_WAKECSR_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_XIFCFG_GMII</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">WOL_WAKECSR_MII</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_WAKECSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
		<span class="cm">/* Machine sleep will die in strange ways if we</span>
<span class="cm">		 * dont wait a bit here, looks like the chip takes</span>
<span class="cm">		 * some time to really shut down</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TXDMA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">RXDMA_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gem_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MAC_TXRST_CMD</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_TXRST</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MAC_RXRST_CMD</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXRST</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found_mii_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">);</span>

		<span class="cm">/* According to Apple, we must set the MDIO pins to this begnign</span>
<span class="cm">		 * state or we may 1) eat more current, 2) damage some PHYs</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mifcfg</span> <span class="o">|</span> <span class="n">MIF_CFG_BBMODE</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_CFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_BBCLK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_BBDATA</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MIF_BBOENAB</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MAC_XIFCFG_GMII</span> <span class="o">|</span> <span class="n">MAC_XIFCFG_LBCK</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_XIFCFG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_do_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Enable the cell */</span>
	<span class="n">gem_get_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Make sure PCI access and bus master are enabled */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to enable chip on PCI bus !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Put cell and forget it for now, it will be considered as</span>
<span class="cm">		 * still asleep, a new sleep cycle may bring it back</span>
<span class="cm">		 */</span>
		<span class="n">gem_put_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Init &amp; setup chip hardware */</span>
	<span class="n">gem_reinit_chip</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* An interrupt might come in handy */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">gem_interrupt</span><span class="p">,</span>
			 <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request irq !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">gem_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="n">gem_clean_rings</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="n">gem_put_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mark us as attached again if we come from resume(), this has</span>
<span class="cm">	 * no effect if we weren&#39;t detatched and needs to be done now.</span>
<span class="cm">	 */</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Restart NAPI &amp; queues */</span>
	<span class="n">gem_netif_start</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Detect &amp; init PHY, start autoneg etc... this will</span>
<span class="cm">	 * eventually result in starting DMA operations when</span>
<span class="cm">	 * the link is up</span>
<span class="cm">	 */</span>
	<span class="n">gem_init_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_do_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Stop NAPI and stop tx queue */</span>
	<span class="n">gem_netif_stop</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Make sure ints are disabled. We don&#39;t care about</span>
<span class="cm">	 * synchronizing as NAPI is disabled, thus a stray</span>
<span class="cm">	 * interrupt will do nothing bad (our irq handler</span>
<span class="cm">	 * just schedules NAPI)</span>
<span class="cm">	 */</span>
	<span class="n">gem_disable_ints</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Stop the link timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">);</span>

	<span class="cm">/* We cannot cancel the reset task while holding the</span>
<span class="cm">	 * rtnl lock, we&#39;d get an A-&gt;B / B-&gt;A deadlock stituation</span>
<span class="cm">	 * if we did. This is not an issue however as the reset</span>
<span class="cm">	 * task is synchronized vs. us (rtnl_lock) and will do</span>
<span class="cm">	 * nothing if the device is down or suspended. We do</span>
<span class="cm">	 * still clear reset_task_pending to avoid a spurrious</span>
<span class="cm">	 * reset later on in case we do resume before it gets</span>
<span class="cm">	 * scheduled.</span>
<span class="cm">	 */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we are going to sleep with WOL */</span>
	<span class="n">gem_stop_dma</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wol</span><span class="p">)</span>
		<span class="n">gem_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Get rid of rings */</span>
	<span class="n">gem_clean_rings</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* No irq needed anymore */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Shut the PHY down eventually and setup WOL */</span>
	<span class="n">gem_stop_phy</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">wol</span><span class="p">);</span>

	<span class="cm">/* Make sure bus master is disabled */</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Cell not needed neither if no WOL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wol</span><span class="p">)</span>
		<span class="n">gem_put_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_reset_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gem</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>

	<span class="cm">/* Lock out the network stack (essentially shield ourselves</span>
<span class="cm">	 * against a racing open, close, control call, or suspend</span>
<span class="cm">	 */</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="cm">/* Skip the reset task if suspended or closed, or if it&#39;s</span>
<span class="cm">	 * been cancelled by gem_do_stop (see comment there)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stop the link timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">);</span>

	<span class="cm">/* Stop NAPI and tx */</span>
	<span class="n">gem_netif_stop</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Reset the chip &amp; rings */</span>
	<span class="n">gem_reinit_chip</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">link_up</span><span class="p">)</span>
		<span class="n">gem_set_link_modes</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Restart NAPI and Tx */</span>
	<span class="n">gem_netif_start</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* We are back ! */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the link is not up, restart autoneg, else restart the</span>
<span class="cm">	 * polling timer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">!=</span> <span class="n">link_up</span><span class="p">)</span>
		<span class="n">gem_begin_auto_negotiation</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="mi">12</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We allow open while suspended, we just do nothing,</span>
<span class="cm">	 * the chip will be initialized in resume()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gem_do_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">gem_do_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Lock the network stack first to avoid racing with open/close,</span>
<span class="cm">	 * reset task and setting calls</span>
<span class="cm">	 */</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="cm">/* Not running, mark ourselves non-present, no need for</span>
<span class="cm">	 * a lock here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspending, WakeOnLan %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">wake_on_lan</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">?</span>
		    <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="cm">/* Tell the network stack we&#39;re gone. gem_do_stop() below will</span>
<span class="cm">	 * synchronize with TX, stop NAPI etc...</span>
<span class="cm">	 */</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Switch off chip, remember WOL setting */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">asleep_wol</span> <span class="o">=</span> <span class="o">!!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">wake_on_lan</span><span class="p">;</span>
	<span class="n">gem_do_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">asleep_wol</span><span class="p">);</span>

	<span class="cm">/* Unlock the network stack */</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* See locking comment in gem_suspend */</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="cm">/* Not running, mark ourselves present, no need for</span>
<span class="cm">	 * a lock here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restart chip. If that fails there isn&#39;t much we can do, we</span>
<span class="cm">	 * leave things stopped.</span>
<span class="cm">	 */</span>
	<span class="n">gem_do_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If we had WOL enabled, the cell clock was never turned off during</span>
<span class="cm">	 * sleep, so we end up beeing unbalanced. Fix that here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">asleep_wol</span><span class="p">)</span>
		<span class="n">gem_put_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Unlock the network stack */</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">gem_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* I have seen this being called while the PM was in progress,</span>
<span class="cm">	 * so we shield against this. Let&#39;s also not poke at registers</span>
<span class="cm">	 * while the reset task is going on.</span>
<span class="cm">	 *</span>
<span class="cm">	 * TODO: Move stats collection elsewhere (link timer ?) and</span>
<span class="cm">	 * make this a nop to avoid all those synchro issues</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="cm">/* Better safe than sorry... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_FCSERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_FCSERR</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_AERR</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_LERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_LERR</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ECOLL</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span>
		<span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ECOLL</span><span class="p">)</span> <span class="o">+</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_LCOLL</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ECOLL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_LCOLL</span><span class="p">);</span>
 <span class="nl">bail:</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">macaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">macaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">macaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* We&#39;ll just catch it later when the device is up&#39;d or resumed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Better safe than sorry... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_ADDR2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rxcfg</span><span class="p">,</span> <span class="n">rxcfg_new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Better safe than sorry... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task_pending</span> <span class="o">||</span> <span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rxcfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="n">rxcfg_new</span> <span class="o">=</span> <span class="n">gem_setup_multicast</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
<span class="cp">#ifdef STRIP_FCS</span>
	<span class="n">rxcfg_new</span> <span class="o">|=</span> <span class="n">MAC_RXCFG_SFCS</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">mac_rx_cfg</span> <span class="o">=</span> <span class="n">rxcfg_new</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">rxcfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_RXCFG_ENAB</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_RXCFG_ENAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">limit</span><span class="o">--</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rxcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_RXCFG_PROM</span> <span class="o">|</span> <span class="n">MAC_RXCFG_HFE</span><span class="p">);</span>
	<span class="n">rxcfg</span> <span class="o">|=</span> <span class="n">rxcfg_new</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">rxcfg</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MAC_RXCFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Jumbo-grams don&#39;t seem to work :-( */</span>
<span class="cp">#define GEM_MIN_MTU	68</span>
<span class="cp">#if 1</span>
<span class="cp">#define GEM_MAX_MTU	1500</span>
<span class="cp">#else</span>
<span class="cp">#define GEM_MAX_MTU	9000</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">GEM_MIN_MTU</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">GEM_MAX_MTU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="cm">/* We&#39;ll just catch it later when the device is up&#39;d or resumed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Better safe than sorry... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">cell_enabled</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gem_netif_stop</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">gem_reinit_chip</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">link_up</span><span class="p">)</span>
		<span class="n">gem_set_link_modes</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">gem_netif_start</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio0</span> <span class="o">||</span>
	    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_mii_mdio1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					  <span class="n">SUPPORTED_10baseT_Full</span><span class="p">);</span>

		<span class="cm">/* XXX hardcoded stuff for now */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XXX fixed PHYAD */</span>

		<span class="cm">/* Return current PHY settings */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span><span class="p">;</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>

		<span class="cm">/* If we started with a forced mode, we don&#39;t have a default</span>
<span class="cm">		 * advertise set, we need to return something sensible so</span>
<span class="cm">		 * userland can re-enable autoneg properly.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// XXX PCS ?</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			 <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			 <span class="n">SUPPORTED_Autoneg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* serdes means usually a Fibre connector, with most fixed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">phy_serdes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
				<span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
				<span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span> <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
				<span class="n">SUPPORTED_Pause</span> <span class="o">|</span> <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">link_up</span><span class="p">)</span>
				<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Verify the settings we care about. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span>
	      <span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span>
	      <span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
	      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Apply settings and restart link process. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">);</span>
		<span class="n">gem_begin_auto_negotiation</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Restart link process  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">);</span>
		<span class="n">gem_begin_auto_negotiation</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gem_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Add more when I understand how to program the chip */</span>
<span class="cm">/* like WAKE_UCAST | WAKE_MCAST | WAKE_BCAST */</span>

<span class="cp">#define WOL_SUPPORTED_MASK	(WAKE_MAGIC)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Add more when I understand how to program the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">has_wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WOL_SUPPORTED_MASK</span><span class="p">;</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">wake_on_lan</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">has_wol</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">wake_on_lan</span> <span class="o">=</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WOL_SUPPORTED_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">gem_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">gem_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">gem_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">gem_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">gem_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">gem_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">gem_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">gem_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">gem_set_wol</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gem_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* For SIOCGMIIREG and SIOCSMIIREG the core checks for us that</span>
<span class="cm">	 * netif_device_present() is true and holds rtnl_lock for us</span>
<span class="cm">	 * so we have nothing to worry about</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:		<span class="cm">/* Get address of MII PHY in use. */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">mii_phy_addr</span><span class="p">;</span>
		<span class="cm">/* Fallthrough... */</span>

	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:		<span class="cm">/* Read MII PHY register. */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">__phy_read</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span>
					   <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:		<span class="cm">/* Write MII PHY register. */</span>
		<span class="n">__phy_write</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span>
			    <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if (!defined(CONFIG_SPARC) &amp;&amp; !defined(CONFIG_PPC_PMAC))</span>
<span class="cm">/* Fetch MAC address from vital product data of PCI ROM. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_eth_addr_in_vpd</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">this_offset</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">this_offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">this_offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">rom_base</span> <span class="o">+</span> <span class="n">this_offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x90</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x09</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4e</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x41</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x06</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">this_offset</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_gem_mac_nonobp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

		<span class="n">found</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span> <span class="o">&amp;&amp;</span>
			<span class="n">readb</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span> <span class="o">&amp;&amp;</span>
			<span class="n">find_eth_addr_in_vpd</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sun MAC prefix then 3 random bytes. */</span>
	<span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* not Sparc and not PPC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gem_get_device_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_SPARC) || defined(CONFIG_PPC_PMAC)</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get mac-address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">get_gem_mac_nonobp</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gem_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Ensure reset task is truely gone */</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>

		<span class="cm">/* Free resources */</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem_init_block</span><span class="p">),</span>
				    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="p">,</span>
				    <span class="n">gp</span><span class="o">-&gt;</span><span class="n">gblock_dvma</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">gem_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">gem_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">gem_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">gem_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">gem_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">gem_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">gem_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">gem_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">gem_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">gem_set_mac_address</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>    <span class="o">=</span> <span class="n">gem_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gem_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gemreg_base</span><span class="p">,</span> <span class="n">gemreg_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gem</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">pci_using_dac</span><span class="p">;</span>

	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="cm">/* Apple gmac note: during probe, the chip is powered up by</span>
<span class="cm">	 * the arch code to allow the code below to work (and to let</span>
<span class="cm">	 * the chip be probed on the config space. It won&#39;t stay powered</span>
<span class="cm">	 * up until the interface is brought up however, so we can&#39;t rely</span>
<span class="cm">	 * on register configuration done at this point.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot enable MMIO operation, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Configure DMA attributes. */</span>

	<span class="cm">/* All of the GEM documentation states that 64-bit DMA addressing</span>
<span class="cm">	 * is fully supported and should work just fine.  However the</span>
<span class="cm">	 * front end for RIO based GEMs is different and only supports</span>
<span class="cm">	 * 32-bit addressing.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For now we assume the various PPC GEMs are 32-bit only as well.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_GEM</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gemreg_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gemreg_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot find proper PCI device base address, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">gp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot obtain PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">DEFAULT_MSG</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">gem_link_timer</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">link_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">gp</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">gem_reset_task</span><span class="p">);</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">link_down</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">gemreg_base</span><span class="p">,</span> <span class="n">gemreg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot map device registers, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On Apple, we want a reference to the Open Firmware device-tree</span>
<span class="cm">	 * node. We use it for clock control.</span>
<span class="cm">	 */</span>
<span class="cp">#if defined(CONFIG_PPC_PMAC) || defined(CONFIG_SPARC)</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Only Apple version supports WOL afaik */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">)</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">has_wol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Make sure cell is enabled */</span>
	<span class="n">gem_get_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Make sure everything is stopped and in init state */</span>
	<span class="n">gem_reset</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="cm">/* Fill up the mii_phy structure (even if we won&#39;t use it) */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">_phy_read</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">_phy_write</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">phy_mii</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* By default, we start with autoneg */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">want_autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check fifo sizes, PHY type, etc... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gem_check_invariants</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It is guaranteed that the returned buffer will be at least</span>
<span class="cm">	 * PAGE_SIZE aligned.</span>
<span class="cm">	 */</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gem_init_block</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gem_init_block</span><span class="p">),</span>
				     <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">gblock_dvma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">init_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot allocate init block, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_get_device_address</span><span class="p">(</span><span class="n">gp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_free_consistent</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gem_netdev_ops</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">gem_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gem_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set that now, in case PM kicks in now */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We can do scatter/gather and HW checksum */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_CSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="cm">/* Register with kernel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot register net device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_consistent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Undo the get_cell with appropriate locking (we could use</span>
<span class="cm">	 * ndo_init/uninit but that would be even more clumsy imho)</span>
<span class="cm">	 */</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">gem_put_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sun GEM (PCI) 10/100/1000BaseT Ethernet %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_consistent:</span>
	<span class="n">gem_remove_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_iounmap:</span>
	<span class="n">gem_put_cell</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">gem_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">GEM_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">gem_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">gem_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">gem_remove_one</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">gem_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">gem_resume</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gem_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">gem_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gem_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">gem_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">gem_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
