<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dnet.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dnet.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Dave DNET Ethernet Controller driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Dave S.r.l. &lt;www.dave.eu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _DNET_H</span>
<span class="cp">#define _DNET_H</span>

<span class="cp">#define DRV_NAME		&quot;dnet&quot;</span>
<span class="cp">#define DRV_VERSION		&quot;0.9.1&quot;</span>
<span class="cp">#define PFX				DRV_NAME &quot;: &quot;</span>

<span class="cm">/* Register access macros */</span>
<span class="cp">#define dnet_writel(port, value, reg)	\</span>
<span class="cp">	writel((value), (port)-&gt;regs + DNET_##reg)</span>
<span class="cp">#define dnet_readl(port, reg)	readl((port)-&gt;regs + DNET_##reg)</span>

<span class="cm">/* ALL DNET FIFO REGISTERS */</span>
<span class="cp">#define DNET_RX_LEN_FIFO		0x000	</span><span class="cm">/* RX_LEN_FIFO */</span><span class="cp"></span>
<span class="cp">#define DNET_RX_DATA_FIFO		0x004	</span><span class="cm">/* RX_DATA_FIFO */</span><span class="cp"></span>
<span class="cp">#define DNET_TX_LEN_FIFO		0x008	</span><span class="cm">/* TX_LEN_FIFO */</span><span class="cp"></span>
<span class="cp">#define DNET_TX_DATA_FIFO		0x00C	</span><span class="cm">/* TX_DATA_FIFO */</span><span class="cp"></span>

<span class="cm">/* ALL DNET CONTROL/STATUS REGISTERS OFFSETS */</span>
<span class="cp">#define DNET_VERCAPS			0x100	</span><span class="cm">/* VERCAPS */</span><span class="cp"></span>
<span class="cp">#define DNET_INTR_SRC			0x104	</span><span class="cm">/* INTR_SRC */</span><span class="cp"></span>
<span class="cp">#define DNET_INTR_ENB			0x108	</span><span class="cm">/* INTR_ENB */</span><span class="cp"></span>
<span class="cp">#define DNET_RX_STATUS			0x10C	</span><span class="cm">/* RX_STATUS */</span><span class="cp"></span>
<span class="cp">#define DNET_TX_STATUS			0x110	</span><span class="cm">/* TX_STATUS */</span><span class="cp"></span>
<span class="cp">#define DNET_RX_FRAMES_CNT		0x114	</span><span class="cm">/* RX_FRAMES_CNT */</span><span class="cp"></span>
<span class="cp">#define DNET_TX_FRAMES_CNT		0x118	</span><span class="cm">/* TX_FRAMES_CNT */</span><span class="cp"></span>
<span class="cp">#define DNET_RX_FIFO_TH			0x11C	</span><span class="cm">/* RX_FIFO_TH */</span><span class="cp"></span>
<span class="cp">#define DNET_TX_FIFO_TH			0x120	</span><span class="cm">/* TX_FIFO_TH */</span><span class="cp"></span>
<span class="cp">#define DNET_SYS_CTL			0x124	</span><span class="cm">/* SYS_CTL */</span><span class="cp"></span>
<span class="cp">#define DNET_PAUSE_TMR			0x128	</span><span class="cm">/* PAUSE_TMR */</span><span class="cp"></span>
<span class="cp">#define DNET_RX_FIFO_WCNT		0x12C	</span><span class="cm">/* RX_FIFO_WCNT */</span><span class="cp"></span>
<span class="cp">#define DNET_TX_FIFO_WCNT		0x130	</span><span class="cm">/* TX_FIFO_WCNT */</span><span class="cp"></span>

<span class="cm">/* ALL DNET MAC REGISTERS */</span>
<span class="cp">#define DNET_MACREG_DATA		0x200	</span><span class="cm">/* Mac-Reg Data */</span><span class="cp"></span>
<span class="cp">#define DNET_MACREG_ADDR		0x204	</span><span class="cm">/* Mac-Reg Addr  */</span><span class="cp"></span>

<span class="cm">/* ALL DNET RX STATISTICS COUNTERS  */</span>
<span class="cp">#define DNET_RX_PKT_IGNR_CNT		0x300</span>
<span class="cp">#define DNET_RX_LEN_CHK_ERR_CNT		0x304</span>
<span class="cp">#define DNET_RX_LNG_FRM_CNT		0x308</span>
<span class="cp">#define DNET_RX_SHRT_FRM_CNT		0x30C</span>
<span class="cp">#define DNET_RX_IPG_VIOL_CNT		0x310</span>
<span class="cp">#define DNET_RX_CRC_ERR_CNT		0x314</span>
<span class="cp">#define DNET_RX_OK_PKT_CNT		0x318</span>
<span class="cp">#define DNET_RX_CTL_FRM_CNT		0x31C</span>
<span class="cp">#define DNET_RX_PAUSE_FRM_CNT		0x320</span>
<span class="cp">#define DNET_RX_MULTICAST_CNT		0x324</span>
<span class="cp">#define DNET_RX_BROADCAST_CNT		0x328</span>
<span class="cp">#define DNET_RX_VLAN_TAG_CNT		0x32C</span>
<span class="cp">#define DNET_RX_PRE_SHRINK_CNT		0x330</span>
<span class="cp">#define DNET_RX_DRIB_NIB_CNT		0x334</span>
<span class="cp">#define DNET_RX_UNSUP_OPCD_CNT		0x338</span>
<span class="cp">#define DNET_RX_BYTE_CNT		0x33C</span>

<span class="cm">/* DNET TX STATISTICS COUNTERS */</span>
<span class="cp">#define DNET_TX_UNICAST_CNT		0x400</span>
<span class="cp">#define DNET_TX_PAUSE_FRM_CNT		0x404</span>
<span class="cp">#define DNET_TX_MULTICAST_CNT		0x408</span>
<span class="cp">#define DNET_TX_BRDCAST_CNT		0x40C</span>
<span class="cp">#define DNET_TX_VLAN_TAG_CNT		0x410</span>
<span class="cp">#define DNET_TX_BAD_FCS_CNT		0x414</span>
<span class="cp">#define DNET_TX_JUMBO_CNT		0x418</span>
<span class="cp">#define DNET_TX_BYTE_CNT		0x41C</span>

<span class="cm">/* SOME INTERNAL MAC-CORE REGISTER */</span>
<span class="cp">#define DNET_INTERNAL_MODE_REG		0x0</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_REG	0x2</span>
<span class="cp">#define DNET_INTERNAL_MAX_PKT_SIZE_REG	0x4</span>
<span class="cp">#define DNET_INTERNAL_IGP_REG		0x8</span>
<span class="cp">#define DNET_INTERNAL_MAC_ADDR_0_REG	0xa</span>
<span class="cp">#define DNET_INTERNAL_MAC_ADDR_1_REG	0xc</span>
<span class="cp">#define DNET_INTERNAL_MAC_ADDR_2_REG	0xe</span>
<span class="cp">#define DNET_INTERNAL_TX_RX_STS_REG	0x12</span>
<span class="cp">#define DNET_INTERNAL_GMII_MNG_CTL_REG	0x14</span>
<span class="cp">#define DNET_INTERNAL_GMII_MNG_DAT_REG	0x16</span>

<span class="cp">#define DNET_INTERNAL_GMII_MNG_CMD_FIN	(1 &lt;&lt; 14)</span>

<span class="cp">#define DNET_INTERNAL_WRITE		(1 &lt;&lt; 31)</span>

<span class="cm">/* MAC-CORE REGISTER FIELDS */</span>

<span class="cm">/* MAC-CORE MODE REGISTER FIELDS */</span>
<span class="cp">#define DNET_INTERNAL_MODE_GBITEN			(1 &lt;&lt; 0)</span>
<span class="cp">#define DNET_INTERNAL_MODE_FCEN				(1 &lt;&lt; 1)</span>
<span class="cp">#define DNET_INTERNAL_MODE_RXEN				(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_INTERNAL_MODE_TXEN				(1 &lt;&lt; 3)</span>

<span class="cm">/* MAC-CORE RXTX CONTROL REGISTER FIELDS */</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_RXSHORTFRAME		(1 &lt;&lt; 8)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_RXBROADCAST		(1 &lt;&lt; 7)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_RXMULTICAST		(1 &lt;&lt; 4)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_RXPAUSE		(1 &lt;&lt; 3)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_DISTXFCS		(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_DISCFXFCS		(1 &lt;&lt; 1)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_ENPROMISC		(1 &lt;&lt; 0)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_DROPCONTROL		(1 &lt;&lt; 6)</span>
<span class="cp">#define DNET_INTERNAL_RXTX_CONTROL_ENABLEHALFDUP	(1 &lt;&lt; 5)</span>

<span class="cm">/* SYSTEM CONTROL REGISTER FIELDS */</span>
<span class="cp">#define DNET_SYS_CTL_IGNORENEXTPKT			(1 &lt;&lt; 0)</span>
<span class="cp">#define DNET_SYS_CTL_SENDPAUSE				(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_SYS_CTL_RXFIFOFLUSH			(1 &lt;&lt; 3)</span>
<span class="cp">#define DNET_SYS_CTL_TXFIFOFLUSH			(1 &lt;&lt; 4)</span>

<span class="cm">/* TX STATUS REGISTER FIELDS */</span>
<span class="cp">#define DNET_TX_STATUS_FIFO_ALMOST_EMPTY		(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_TX_STATUS_FIFO_ALMOST_FULL			(1 &lt;&lt; 1)</span>

<span class="cm">/* INTERRUPT SOURCE REGISTER FIELDS */</span>
<span class="cp">#define DNET_INTR_SRC_TX_PKTSENT			(1 &lt;&lt; 0)</span>
<span class="cp">#define DNET_INTR_SRC_TX_FIFOAF				(1 &lt;&lt; 1)</span>
<span class="cp">#define DNET_INTR_SRC_TX_FIFOAE				(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_INTR_SRC_TX_DISCFRM			(1 &lt;&lt; 3)</span>
<span class="cp">#define DNET_INTR_SRC_TX_FIFOFULL			(1 &lt;&lt; 4)</span>
<span class="cp">#define DNET_INTR_SRC_RX_CMDFIFOAF			(1 &lt;&lt; 8)</span>
<span class="cp">#define DNET_INTR_SRC_RX_CMDFIFOFF			(1 &lt;&lt; 9)</span>
<span class="cp">#define DNET_INTR_SRC_RX_DATAFIFOFF			(1 &lt;&lt; 10)</span>
<span class="cp">#define DNET_INTR_SRC_TX_SUMMARY			(1 &lt;&lt; 16)</span>
<span class="cp">#define DNET_INTR_SRC_RX_SUMMARY			(1 &lt;&lt; 17)</span>
<span class="cp">#define DNET_INTR_SRC_PHY				(1 &lt;&lt; 19)</span>

<span class="cm">/* INTERRUPT ENABLE REGISTER FIELDS */</span>
<span class="cp">#define DNET_INTR_ENB_TX_PKTSENT			(1 &lt;&lt; 0)</span>
<span class="cp">#define DNET_INTR_ENB_TX_FIFOAF				(1 &lt;&lt; 1)</span>
<span class="cp">#define DNET_INTR_ENB_TX_FIFOAE				(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_INTR_ENB_TX_DISCFRM			(1 &lt;&lt; 3)</span>
<span class="cp">#define DNET_INTR_ENB_TX_FIFOFULL			(1 &lt;&lt; 4)</span>
<span class="cp">#define DNET_INTR_ENB_RX_PKTRDY				(1 &lt;&lt; 8)</span>
<span class="cp">#define DNET_INTR_ENB_RX_FIFOAF				(1 &lt;&lt; 9)</span>
<span class="cp">#define DNET_INTR_ENB_RX_FIFOERR			(1 &lt;&lt; 10)</span>
<span class="cp">#define DNET_INTR_ENB_RX_ERROR				(1 &lt;&lt; 11)</span>
<span class="cp">#define DNET_INTR_ENB_RX_FIFOFULL			(1 &lt;&lt; 12)</span>
<span class="cp">#define DNET_INTR_ENB_RX_FIFOAE				(1 &lt;&lt; 13)</span>
<span class="cp">#define DNET_INTR_ENB_TX_SUMMARY			(1 &lt;&lt; 16)</span>
<span class="cp">#define DNET_INTR_ENB_RX_SUMMARY			(1 &lt;&lt; 17)</span>
<span class="cp">#define DNET_INTR_ENB_GLOBAL_ENABLE			(1 &lt;&lt; 18)</span>

<span class="cm">/* default values:</span>
<span class="cm"> * almost empty = less than one full sized ethernet frame (no jumbo) inside</span>
<span class="cm"> * the fifo almost full = can write less than one full sized ethernet frame</span>
<span class="cm"> * (no jumbo) inside the fifo</span>
<span class="cm"> */</span>
<span class="cp">#define DNET_CFG_TX_FIFO_FULL_THRES	25</span>
<span class="cp">#define DNET_CFG_RX_FIFO_FULL_THRES	20</span>

<span class="cm">/*</span>
<span class="cm"> * Capabilities. Used by the driver to know the capabilities that the ethernet</span>
<span class="cm"> * controller inside the FPGA have.</span>
<span class="cm"> */</span>

<span class="cp">#define DNET_HAS_MDIO		(1 &lt;&lt; 0)</span>
<span class="cp">#define DNET_HAS_IRQ		(1 &lt;&lt; 1)</span>
<span class="cp">#define DNET_HAS_GIGABIT	(1 &lt;&lt; 2)</span>
<span class="cp">#define DNET_HAS_DMA		(1 &lt;&lt; 3)</span>

<span class="cp">#define DNET_HAS_MII		(1 &lt;&lt; 4) </span><span class="cm">/* or GMII */</span><span class="cp"></span>
<span class="cp">#define DNET_HAS_RMII		(1 &lt;&lt; 5) </span><span class="cm">/* or RGMII */</span><span class="cp"></span>

<span class="cp">#define DNET_CAPS_MASK		0xFFFF</span>

<span class="cp">#define DNET_FIFO_SIZE		1024 </span><span class="cm">/* 1K x 32 bit */</span><span class="cp"></span>
<span class="cp">#define DNET_FIFO_TX_DATA_AF_TH	(DNET_FIFO_SIZE - 384) </span><span class="cm">/* 384 = 1536 / 4 */</span><span class="cp"></span>
<span class="cp">#define DNET_FIFO_TX_DATA_AE_TH	384</span>

<span class="cp">#define DNET_FIFO_RX_CMD_AF_TH	(1 &lt;&lt; 16) </span><span class="cm">/* just one frame inside the FIFO */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Hardware-collected statistics.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dnet_stats</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">rx_pkt_ignr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_len_chk_err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_lng_frm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_shrt_frm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_ipg_viol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_crc_err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_ok_pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_ctl_frm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_pause_frm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_multicast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_broadcast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_vlan_tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_pre_shrink</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drib_nib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_unsup_opcd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_unicast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_pause_frm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_multicast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_brdcast</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_vlan_tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_bad_fcs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_jumbo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_byte</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dnet</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dnet_stats</span>		<span class="n">hw_stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">capabilities</span><span class="p">;</span> <span class="cm">/* read from FPGA */</span>
	<span class="k">struct</span> <span class="n">napi_struct</span>		<span class="n">napi</span><span class="p">;</span>

	<span class="cm">/* PHY stuff */</span>
	<span class="k">struct</span> <span class="n">mii_bus</span>			<span class="o">*</span><span class="n">mii_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span>		<span class="o">*</span><span class="n">phy_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">duplex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* _DNET_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
