<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › racal › ni5010.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ni5010.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*	ni5010.c: A network driver for the MiCom-Interlan NI5010 ethercard.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright 1996,1997,2006 Jan-Pascal van Best and Andreas Mohr.</span>
<span class="cm"> *</span>
<span class="cm"> *	This software may be used and distributed according to the terms</span>
<span class="cm"> *	of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * 	The authors may be reached as:</span>
<span class="cm"> *		janpascal@vanbest.org		andi@lisas.de</span>
<span class="cm"> *</span>
<span class="cm"> *	Sources:</span>
<span class="cm"> * 	 	Donald Becker&#39;s &quot;skeleton.c&quot;</span>
<span class="cm"> *  		Crynwr ni5010 packet driver</span>
<span class="cm"> *</span>
<span class="cm"> *	Changes:</span>
<span class="cm"> *		v0.0: First test version</span>
<span class="cm"> *		v0.1: First working version</span>
<span class="cm"> *		v0.2:</span>
<span class="cm"> *		v0.3-&gt;v0.90: Now demand setting io and irq when loading as module</span>
<span class="cm"> *	970430	v0.91: modified for Linux 2.1.14</span>
<span class="cm"> *		v0.92: Implemented Andreas&#39; (better) NI5010 probe</span>
<span class="cm"> *	970503	v0.93: Fixed auto-irq failure on warm reboot (JB)</span>
<span class="cm"> *	970623	v1.00: First kernel version (AM)</span>
<span class="cm"> *	970814	v1.01: Added detection of onboard receive buffer size (AM)</span>
<span class="cm"> *	060611	v1.02: slight cleanup: email addresses, driver modernization.</span>
<span class="cm"> *	Bugs:</span>
<span class="cm"> *		- not SMP-safe (no locking of I/O accesses)</span>
<span class="cm"> *		- Note that you have to patch ifconfig for the new /proc/net/dev</span>
<span class="cm"> *		format. It gives incorrect stats otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> *	To do:</span>
<span class="cm"> *		Fix all bugs :-)</span>
<span class="cm"> *		Move some stuff to chipset_init()</span>
<span class="cm"> *		Handle xmt errors other than collisions</span>
<span class="cm"> *		Complete merge with Andreas&#39; driver</span>
<span class="cm"> *		Implement ring buffers (Is this useful? You can&#39;t squeeze</span>
<span class="cm"> *			too many packet in a 2k buffer!)</span>
<span class="cm"> *		Implement DMA (Again, is this useful? Some docs say DMA is</span>
<span class="cm"> *			slower than programmed I/O)</span>
<span class="cm"> *</span>
<span class="cm"> *	Compile with:</span>
<span class="cm"> *		gcc -O2 -fomit-frame-pointer -m486 -D__KERNEL__ \</span>
<span class="cm"> *			-DMODULE -c ni5010.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Insert with e.g.:</span>
<span class="cm"> *		insmod ni5010.ko io=0x300 irq=5</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>

<span class="cp">#include &quot;ni5010.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">boardname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;NI5010&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="s">&quot;ni5010.c: v1.02 20060611 Jan-Pascal van Best and Andreas Mohr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cm">/* bufsize_rcv == 0 means autoprobing */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsize_rcv</span><span class="p">;</span>

<span class="cp">#define JUMPERED_INTERRUPTS	</span><span class="cm">/* IRQ line jumpered on board */</span><span class="cp"></span>
<span class="cp">#undef JUMPERED_DMA		</span><span class="cm">/* No DMA used */</span><span class="cp"></span>
<span class="cp">#undef FULL_IODETECT		</span><span class="cm">/* Only detect in portlist */</span><span class="cp"></span>

<span class="cp">#ifndef FULL_IODETECT</span>
<span class="cm">/* A zero-terminated list of I/O addresses to be probed. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ports</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mh">0x380</span><span class="p">,</span> <span class="mh">0x3a0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* Use 0 for production, 1 for verification, &gt;2 for debug */</span>
<span class="cp">#ifndef NI5010_DEBUG</span>
<span class="cp">#define NI5010_DEBUG 0</span>
<span class="cp">#endif</span>

<span class="cm">/* Information that needs to be kept for each board. */</span>
<span class="k">struct</span> <span class="n">ni5010_local</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">o_pkt_size</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Index to functions, as function prototypes. */</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">ni5010_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">ni5010_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">ni5010_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ni5010_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">ni5010_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">ni5010_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">ni5010_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">ni5010_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">reset_receiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">process_xmt_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#define tx_done(dev) 1</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">chipset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">startp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">dump_packet</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">ni5010_show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">ni5010_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ni5010_local</span><span class="p">));</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">io</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Entering ni5010_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>	<span class="p">{</span>	<span class="cm">/* Check a single specified location. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ni5010_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Don&#39;t probe at all. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef FULL_IODETECT</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">io</span><span class="o">=</span><span class="mh">0x200</span><span class="p">;</span> <span class="n">io</span><span class="o">&lt;</span><span class="mh">0x400</span> <span class="o">&amp;&amp;</span> <span class="n">ni5010_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span> <span class="p">;</span> <span class="n">io</span><span class="o">+=</span><span class="mh">0x20</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">==</span> <span class="mh">0x400</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">;</span> <span class="o">*</span><span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="n">ni5010_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">port</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* FULL_IODETECT */</span><span class="cp"></span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">NI5010_IO_EXTENT</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rd_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">IE_RBUF</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">IE_SAPROM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">trigger_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">EDLC_RESET</span><span class="p">);</span>	<span class="cm">/* Clear EDLC hold RESET state */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">IE_RESET</span><span class="p">);</span>	<span class="cm">/* Board reset */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span>	<span class="cm">/* Disable all Xmt interrupts */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">EDLC_RMASK</span><span class="p">);</span> <span class="cm">/* Disable all Rcv interrupt */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_XCLR</span><span class="p">);</span>	<span class="cm">/* Clear all pending Xmt interrupts */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RCLR</span><span class="p">);</span>	<span class="cm">/* Clear all pending Rcv interrupts */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Transmit packet mode: Ignore parity, Power xcvr,</span>
<span class="cm">		 * 	Enable loopback</span>
<span class="cm">		 */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">XMD_IG_PAR</span> <span class="o">|</span> <span class="n">XMD_T_MODE</span> <span class="o">|</span> <span class="n">XMD_LBC</span><span class="p">,</span> <span class="n">EDLC_XMODE</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">RMD_BROADCAST</span><span class="p">,</span> <span class="n">EDLC_RMODE</span><span class="p">);</span> <span class="cm">/* Receive normal&amp;broadcast */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">XM_ALL</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span>	<span class="cm">/* Enable all Xmt interrupts */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>			<span class="cm">/* FIXME: Necessary? */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MM_EN_XMT</span><span class="o">|</span><span class="n">MM_MUX</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span> <span class="cm">/* Start transmission */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ni5010_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ni5010_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ni5010_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ni5010_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ni5010_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ni5010_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *      This is the real probe routine.  Linux has a history of friendly device</span>
<span class="cm"> *      probes on the ISA bus.  A good device probes avoids doing writes, and</span>
<span class="cm"> *      verifies that the correct device exists and functions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ni5010_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">version_printed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ni5010_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NI5010_IO_EXTENT</span><span class="p">,</span> <span class="n">boardname</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is no &quot;official&quot; probe method, I&#39;ve rather tested which</span>
<span class="cm">	 * probe works best with my seven NI5010 cards</span>
<span class="cm">	 * (they have very different serial numbers)</span>
<span class="cm">	 * Suggestions or failure reports are very, very welcome !</span>
<span class="cm">	 * But I think it is a relatively good probe method</span>
<span class="cm">	 * since it doesn&#39;t use any &quot;outb&quot;</span>
<span class="cm">	 * It should be nearly 100% reliable !</span>
<span class="cm">	 * well-known WARNING: this probe method (like many others)</span>
<span class="cm">	 * will hang the system if a NE2000 card region is probed !</span>
<span class="cm">	 *</span>
<span class="cm">	 *   - Andreas</span>
<span class="cm">	 */</span>

 	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering ni5010_probe1(%#3x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boguscount</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #1 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">==</span><span class="mh">0xff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #2 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">!=</span> <span class="n">SA_ADDR0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SA_ADDR1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SA_ADDR2</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NI5010_MAGICVAL1</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">rd_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NI5010_MAGICVAL2</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #3 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NI5010_DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NI5010 ethercard probe at 0x%x: &quot;</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IE_SAPROM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%pM &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #4 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

<span class="cp">#ifdef JUMPERED_INTERRUPTS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span><span class="p">;</span>

		<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #5 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>
		<span class="n">trigger_irq</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">);</span>

		<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #6 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: no IRQ found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #7 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* JUMPERED_INTERRUPTS */</span><span class="cp"></span>
	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #9 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* DMA is not supported (yet?), so no use detecting it */</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: I/O #10 passed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

<span class="cm">/* get the size of the onboard receive buffer</span>
<span class="cm"> * higher addresses than bufsize are wrapped into real buffer</span>
<span class="cm"> * i.e. data for offs. 0x801 is written to 0x1 with a 2K onboard buffer</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bufsize_rcv</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span>      <span class="cm">/* Put Rcv buffer on system bus */</span>
        	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span>		<span class="cm">/* Point GP at start of packet */</span>
        	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_RBUF</span><span class="p">);</span>	<span class="cm">/* set buffer byte 0 to 0 */</span>
        	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                	<span class="n">outw</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span> <span class="cm">/* Point GP at packet size to be tested */</span>
                	<span class="n">outb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IE_RBUF</span><span class="p">);</span>
                	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span> <span class="cm">/* Point GP at start of packet */</span>
                	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IE_RBUF</span><span class="p">);</span>
                	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        	<span class="p">}</span>
		<span class="n">bufsize_rcv</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
        	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span>		<span class="cm">/* Point GP at start of packet */</span>
        	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_RBUF</span><span class="p">);</span>	<span class="cm">/* set buffer byte 0 to 0 again */</span>
	<span class="p">}</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;-&gt; bufsize rcv/xmt=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bufsize_rcv</span><span class="p">,</span> <span class="n">NI5010_BUFSIZE</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ni5010_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_MULTICAST</span><span class="p">;</span>	<span class="cm">/* Multicast doesn&#39;t work */</span>

	<span class="cm">/* Shut up the ni5010 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EDLC_RMASK</span><span class="p">);</span>	<span class="cm">/* Mask all receive interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span>	<span class="cm">/* Mask all xmit interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RCLR</span><span class="p">);</span>	<span class="cm">/* Kill all pending rcv interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_XCLR</span><span class="p">);</span> 	<span class="cm">/* Kill all pending xmt interrupts */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: NI5010 found at 0x%x, using IRQ %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &amp; DMA %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">NI5010_IO_EXTENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open/initialize the board.  This is called (in the current kernel)</span>
<span class="cm"> * sometime after booting when the &#39;ifconfig&#39; program is run.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should set everything up anew at each open, even</span>
<span class="cm"> * registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm"> * there is a non-reboot way to recover if something goes wrong.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni5010_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering ni5010_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ni5010_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boardname</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Cannot get irq %#2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: passed open() #1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
        <span class="cm">/*</span>
<span class="cm">         * Always allocate the DMA channel after the IRQ,</span>
<span class="cm">         * and clean up on failure.</span>
<span class="cm">         */</span>
<span class="cp">#ifdef JUMPERED_DMA</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">cardname</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Cannot get dma %#2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
                <span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* JUMPERED_DMA */</span><span class="cp"></span>

	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: passed open() #2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* Reset the hardware here.  Don&#39;t forget to set the station address. */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">RS_RESET</span><span class="p">,</span> <span class="n">EDLC_RESET</span><span class="p">);</span>	<span class="cm">/* Hold up EDLC_RESET while configing board */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_RESET</span><span class="p">);</span>		<span class="cm">/* Hardware reset of ni5010 board */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">XMD_LBC</span><span class="p">,</span> <span class="n">EDLC_XMODE</span><span class="p">);</span>	<span class="cm">/* Only loopback xmits */</span>

	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: passed open() #3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* Set the station address */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">EDLC_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Initialising ni5010</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span>	<span class="cm">/* No xmit interrupts for now */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">XMD_IG_PAR</span> <span class="o">|</span> <span class="n">XMD_T_MODE</span> <span class="o">|</span> <span class="n">XMD_LBC</span><span class="p">,</span> <span class="n">EDLC_XMODE</span><span class="p">);</span>
				<span class="cm">/* Normal packet xmit mode */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_XCLR</span><span class="p">);</span>	<span class="cm">/* Clear all pending xmit interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RMD_BROADCAST</span><span class="p">,</span> <span class="n">EDLC_RMODE</span><span class="p">);</span>
				<span class="cm">/* Receive broadcast and normal packets */</span>
	<span class="n">reset_receiver</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* Ready ni5010 for receiving packets */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EDLC_RESET</span><span class="p">);</span>	<span class="cm">/* Un-reset the ni5010 */</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NI5010_DEBUG</span><span class="p">)</span> <span class="n">ni5010_show_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: open successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
     	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_receiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: resetting receiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span>		<span class="cm">/* Receive packet at start of buffer */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RCLR</span><span class="p">);</span>	<span class="cm">/* Clear all pending rcv interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span>	<span class="cm">/* Put EDLC to rcv buffer */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MM_EN_RCV</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span> <span class="cm">/* Enable rcv */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RMASK</span><span class="p">);</span>	<span class="cm">/* Enable all rcv interrupts */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni5010_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IRQ conflict&quot;</span> <span class="o">:</span> <span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>
	<span class="cm">/* Try to restart the adaptor. */</span>
	<span class="cm">/* FIXME: Give it a real kick here */</span>
	<span class="n">chipset_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni5010_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering ni5010_send_packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">         * Block sending</span>
<span class="cm">	 */</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hardware_send_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">length</span><span class="o">-</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The typical workload of the driver:</span>
<span class="cm"> * Handle the network interface interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ni5010_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ni5010_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_was_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering ni5010_interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IE_ISTAT</span><span class="p">);</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: IE_ISTAT = %#02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IS_R_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">ni5010_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IS_X_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">xmit_was_error</span> <span class="o">=</span> <span class="n">process_xmt_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IS_DMA_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: DMA complete (?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
                <span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_DMA_RST</span><span class="p">);</span> <span class="cm">/* Reset DMA int */</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xmit_was_error</span><span class="p">)</span>
		<span class="n">reset_receiver</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_packet</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Packet length = %#4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%#4.4x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%2.2x&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We have a good packet, get it out of the buffer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni5010_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rcv_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_pkt_size</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering ni5010_rx()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">rcv_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_RSTAT</span><span class="p">);</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: EDLC_RSTAT = %#2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rcv_stat</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rcv_stat</span> <span class="o">&amp;</span> <span class="n">RS_VALID_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RS_PKT_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: receive error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcv_stat</span> <span class="o">&amp;</span> <span class="n">RS_RUNT</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcv_stat</span> <span class="o">&amp;</span> <span class="n">RS_ALIGN</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcv_stat</span> <span class="o">&amp;</span> <span class="n">RS_CRC_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcv_stat</span> <span class="o">&amp;</span> <span class="n">RS_OFLW</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
        	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RCLR</span><span class="p">);</span> <span class="cm">/* Clear the interrupt */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RCLR</span><span class="p">);</span>  <span class="cm">/* Clear the interrupt */</span>

	<span class="n">i_pkt_size</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">IE_RCNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i_pkt_size</span> <span class="o">&gt;</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">||</span> <span class="n">i_pkt_size</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Packet size error, packet size = %#4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i_pkt_size</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Malloc up new buffer. */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i_pkt_size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Read packet into buffer */</span>
        <span class="n">outb</span><span class="p">(</span><span class="n">MM_MUX</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span> <span class="cm">/* Rcv buffer to system bus */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span>	<span class="cm">/* Seek to beginning of packet */</span>
	<span class="n">insb</span><span class="p">(</span><span class="n">IE_RBUF</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i_pkt_size</span><span class="p">),</span> <span class="n">i_pkt_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NI5010_DEBUG</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dump_packet</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">i_pkt_size</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Received packet, size=%#4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i_pkt_size</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_xmt_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ni5010_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_stat</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering process_xmt_interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">xmit_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_XSTAT</span><span class="p">);</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: EDLC_XSTAT = %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xmit_stat</span><span class="p">));</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span>	<span class="cm">/* Disable xmit IRQ&#39;s */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_XCLR</span><span class="p">);</span>	<span class="cm">/* Clear all pending xmit IRQ&#39;s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xmit_stat</span> <span class="o">&amp;</span> <span class="n">XS_COLL</span><span class="p">){</span>
		<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: collision detected, retransmitting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">NI5010_BUFSIZE</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">o_pkt_size</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span>
		<span class="cm">/* outb(0, IE_MMODE); */</span> <span class="cm">/* xmt buf on sysbus FIXME: needed ? */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MM_EN_XMT</span> <span class="o">|</span> <span class="n">MM_MUX</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">XM_ALL</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span> <span class="cm">/* Enable xmt IRQ&#39;s */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: handle other xmt error conditions */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">o_pkt_size</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: sent packet, size=%#4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">o_pkt_size</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The inverse routine to ni5010_open(). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni5010_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering ni5010_close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="cp">#ifdef JUMPERED_INTERRUPTS</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Put card in held-RESET state */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RS_RESET</span><span class="p">,</span> <span class="n">EDLC_RESET</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s closed down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">boardname</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Set or clear the multicast filter for this adaptor.</span>
<span class="cm">   num_addrs == -1      Promiscuous mode, receive all packets</span>
<span class="cm">   num_addrs == 0       Normal mode, clear multicast list</span>
<span class="cm">   num_addrs &gt; 0        Multicast mode, receive normal and MC packets, and do</span>
<span class="cm">                        best-effort filtering.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni5010_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering set_multicast_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">RMD_PROMISC</span><span class="p">,</span> <span class="n">EDLC_RMODE</span><span class="p">);</span> <span class="cm">/* Enable promiscuous mode */</span>
		<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Entering promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Entering broadcast mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">RMD_BROADCAST</span><span class="p">,</span> <span class="n">EDLC_RMODE</span><span class="p">);</span>  <span class="cm">/* Disable promiscuous mode, use normal mode */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ni5010_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_offs</span><span class="p">;</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering hardware_send_packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">ETH_FRAME_LEN</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet too large, not possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NI5010_DEBUG</span><span class="p">)</span> <span class="n">ni5010_show_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">IE_ISTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IS_EN_XMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">((</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: sending packet while already transmitting, not possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NI5010_DEBUG</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">dump_packet</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">buf_offs</span> <span class="o">=</span> <span class="n">NI5010_BUFSIZE</span> <span class="o">-</span> <span class="n">length</span> <span class="o">-</span> <span class="n">pad</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">o_pkt_size</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">pad</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EDLC_RMASK</span><span class="p">);</span>	<span class="cm">/* Mask all receive interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span>	<span class="cm">/* Put Xmit buffer on system bus */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">EDLC_RCLR</span><span class="p">);</span>	<span class="cm">/* Clear out pending rcv interrupts */</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">buf_offs</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span> <span class="cm">/* Point GP at start of packet */</span>
	<span class="n">outsb</span><span class="p">(</span><span class="n">IE_XBUF</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span> <span class="cm">/* Put data in buffer */</span>
	<span class="k">while</span><span class="p">(</span><span class="n">pad</span><span class="o">--</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IE_XBUF</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">buf_offs</span><span class="p">,</span> <span class="n">IE_GP</span><span class="p">);</span> <span class="cm">/* Rewrite where packet starts */</span>

	<span class="cm">/* should work without that outb() (Crynwr used it) */</span>
	<span class="cm">/*outb(MM_MUX, IE_MMODE);*/</span> <span class="cm">/* Xmt buffer to EDLC bus */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MM_EN_XMT</span> <span class="o">|</span> <span class="n">MM_MUX</span><span class="p">,</span> <span class="n">IE_MMODE</span><span class="p">);</span> <span class="cm">/* Begin transmission */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">XM_ALL</span><span class="p">,</span> <span class="n">EDLC_XMASK</span><span class="p">);</span> <span class="cm">/* Cause interrupt after completion or fail */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NI5010_DEBUG</span><span class="p">)</span> <span class="n">ni5010_show_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chipset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">startp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: Move some stuff here */</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: doing NOTHING in chipset_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni5010_show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: XSTAT %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_XSTAT</span><span class="p">)));</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: XMASK %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_XMASK</span><span class="p">)));</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RSTAT %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_RSTAT</span><span class="p">)));</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RMASK %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_RMASK</span><span class="p">)));</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RMODE %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_RMODE</span><span class="p">)));</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: XMODE %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">EDLC_XMODE</span><span class="p">)));</span>
	<span class="n">PRINTK3</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ISTAT %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">IE_ISTAT</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_ni5010</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;ni5010 I/O base address&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;ni5010 IRQ number&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ni5010_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering init_module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardname</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	if(io &lt;= 0 || irq == 0){</span>
<span class="cm">	   	printk(KERN_WARNING &quot;%s: Autoprobing not allowed for modules.\n&quot;, boardname);</span>
<span class="cm">		printk(KERN_WARNING &quot;%s: Set symbols &#39;io&#39; and &#39;irq&#39;\n&quot;, boardname);</span>
<span class="cm">	   	return -EINVAL;</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Autoprobing for modules is hazardous, trying anyway..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: init_module irq=%#2x, io=%#3x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardname</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">io</span><span class="p">));</span>
	<span class="n">dev_ni5010</span> <span class="o">=</span> <span class="n">ni5010_probe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_ni5010</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev_ni5010</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ni5010_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PRINTK2</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering cleanup_module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardname</span><span class="p">));</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev_ni5010</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev_ni5010</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">NI5010_IO_EXTENT</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev_ni5010</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ni5010_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ni5010_cleanup_module</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
