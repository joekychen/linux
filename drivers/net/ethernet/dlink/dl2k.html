<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dlink › dl2k.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dl2k.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*  D-Link DL2000-based Gigabit Ethernet Adapter Linux driver */</span>
<span class="cm">/*</span>
<span class="cm">    Copyright (c) 2001, 2002 by D-Link Corporation</span>
<span class="cm">    Written by Edward Peng.&lt;edward_peng@dlink.com.tw&gt;</span>
<span class="cm">    Created 03-May-2001, base on Linux&#39; sundance.c.</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>
<span class="cm">*/</span>

<span class="cp">#define DRV_NAME	&quot;DL2000/TC902x-based linux driver&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;v1.19&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;2007/08/12&quot;</span>
<span class="cp">#include &quot;dl2k.h&quot;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#define dw32(reg, val)	iowrite32(val, ioaddr + (reg))</span>
<span class="cp">#define dw16(reg, val)	iowrite16(val, ioaddr + (reg))</span>
<span class="cp">#define dw8(reg, val)	iowrite8(val, ioaddr + (reg))</span>
<span class="cp">#define dr32(reg)	ioread32(ioaddr + (reg))</span>
<span class="cp">#define dr16(reg)	ioread16(ioaddr + (reg))</span>
<span class="cp">#define dr8(reg)	ioread8(ioaddr + (reg))</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
      <span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="cp">#define MAX_UNITS 8</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vlan</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">jumbo</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">media</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">copy_thresh</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_coalesce</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>	<span class="cm">/* Rx frame count each interrupt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_timeout</span><span class="o">=</span><span class="mi">200</span><span class="p">;</span>	<span class="cm">/* Rx DMA wait time in 640ns increments */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_coalesce</span><span class="o">=</span><span class="mi">16</span><span class="p">;</span>	<span class="cm">/* HW xmit count each TxDMAComplete */</span>


<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;Edward Peng&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;D-Link DL2000-based Gigabit Ethernet Adapter&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vlan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">jumbo</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tx_flow</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_flow</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">copy_thresh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_coalesce</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Rx frame count each interrupt */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Rx DMA wait time in 64ns increments */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tx_coalesce</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* HW xmit count each TxDMAComplete */</span>


<span class="cm">/* Enable the default interrupts */</span>
<span class="cp">#define DEFAULT_INTR (RxDMAComplete | HostError | IntRequested | TxDMAComplete| \</span>
<span class="cp">       UpdateStats | LinkEvent)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dl2k_enable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">dw16</span><span class="p">(</span><span class="n">IntEnable</span><span class="p">,</span> <span class="n">DEFAULT_INTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_intrloop</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rio_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rio_timer</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rio_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">alloc_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">start_xmit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">rio_interrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rio_free_tx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_error</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">receive_packet</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rio_error</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">int_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">change_mtu</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">get_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">clear_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rio_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rio_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">find_miiphy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">parse_eeprom</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">read_eeprom</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eep_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_wait_link</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_set_media</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_get_media</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_set_media_pcs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_get_media_pcs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_num</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_num</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">rio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>	<span class="o">=</span> <span class="n">start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">rio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">rio_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">rio_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">rio_probe1</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">card_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_idx</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">version_printed</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ring_space</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">version_printed</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;dl2k&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>

	<span class="n">pci_set_master</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_res</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* IO registers range. */</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

<span class="cp">#ifdef MEM_MAPPING</span>
	<span class="cm">/* MM registers range. */</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">chip_idx</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="cm">/* Parse manual configuration */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_coalesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;auto&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;autosense&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;100mbps_fd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;4&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;100mbps_hd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				   <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;3&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;10mbps_fd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				   <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;10mbps_hd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				   <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;1000mbps_fd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				 <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;6&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span><span class="o">=</span><span class="mi">1000</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;1000mbps_hd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				 <span class="n">strcmp</span> <span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">card_idx</span><span class="p">],</span> <span class="s">&quot;5&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jumbo</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">MAX_JUMBO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mtu</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">PACKET_SIZE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">[</span><span class="n">card_idx</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlan</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vlan</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">vlan</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_coalesce</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rx_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_coalesce</span> <span class="o">=</span> <span class="n">rx_coalesce</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="n">rx_timeout</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">coalesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_flow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_flow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_coalesce</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tx_coalesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_coalesce</span> <span class="o">&gt;</span> <span class="n">TX_RING_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">tx_coalesce</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_ops</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	dev-&gt;features = NETIF_F_IP_CSUM;</span>
<span class="cp">#endif</span>
	<span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">ring_space</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring_space</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">ring_space</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="n">ring_space</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring_space</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unmap_tx</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">ring_space</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="cm">/* Parse eeprom data */</span>
	<span class="n">parse_eeprom</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Find PHY address */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">find_miiphy</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unmap_rx</span><span class="p">;</span>

	<span class="cm">/* Fiber device? */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_media</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr16</span><span class="p">(</span><span class="n">ASICCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PhyMedia</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Set media and reset PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_media</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* default Auto-Negotiation for fiber deivices */</span>
	 	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mii_set_media_pcs</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Auto-Negotiation is mandatory for 1000BASE-T,</span>
<span class="cm">		   IEEE 802.3ab Annex 28D page 14 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mii_set_media</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unmap_rx</span><span class="p">;</span>

	<span class="n">card_idx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s, %pM, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_coalesce</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tx_coalesce:</span><span class="se">\t</span><span class="s">%d packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tx_coalesce</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">coalesce</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;rx_coalesce:</span><span class="se">\t</span><span class="s">%d packets</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;rx_timeout: </span><span class="se">\t</span><span class="s">%d ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_coalesce</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="o">*</span><span class="mi">640</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;vlan(id):</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unmap_rx:</span>
	<span class="n">pci_free_consistent</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
<span class="nl">err_out_unmap_tx:</span>
	<span class="n">pci_free_consistent</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
<span class="nl">err_out_iounmap:</span>
<span class="cp">#ifdef MEM_MAPPING</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span><span class="p">);</span>
<span class="nl">err_out_dev:</span>
	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_res:</span>
	<span class="n">pci_release_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable:</span>
	<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_miiphy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">phy_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mii_status</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">phy_found</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: No MII PHY found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_eeprom</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sromdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">psib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">PSROM_t</span> <span class="n">psrom</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSROM_t</span><span class="p">)</span> <span class="n">sromdata</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">cid</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">sromdata</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* D-Link Only */</span>
		<span class="cm">/* Check CRC */</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="o">~</span><span class="n">ether_crc_le</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sromdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psrom</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">crc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: EEPROM data CRC error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set MAC address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psrom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parse Software Information Block */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">psib</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sromdata</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">psib</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">psib</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">next</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">next</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cell data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* Format version */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* End of cell */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* Duplex Polarity */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplex_polarity</span> <span class="o">=</span> <span class="n">psib</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dw8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">,</span> <span class="n">dr8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">psib</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* Wake Polarity */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">wake_polarity</span> <span class="o">=</span> <span class="n">psib</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:	<span class="cm">/* Adapter description */</span>
			<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">next</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">memcpy</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">psib</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">case</span> <span class="mi">8</span>:	<span class="cm">/* Reversed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* Unknown cell */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macctrl</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">rio_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Reset all logic functions */</span>
	<span class="n">dw16</span><span class="p">(</span><span class="n">ASICCtrl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
	     <span class="n">GlobalReset</span> <span class="o">|</span> <span class="n">DMAReset</span> <span class="o">|</span> <span class="n">FIFOReset</span> <span class="o">|</span> <span class="n">NetworkReset</span> <span class="o">|</span> <span class="n">HostReset</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* DebugCtrl bit 4, 5, 9 must set */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DebugCtrl</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">DebugCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0230</span><span class="p">);</span>

	<span class="cm">/* Jumbo frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">jumbo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">MaxFrameSize</span><span class="p">,</span> <span class="n">MAX_JUMBO</span><span class="o">+</span><span class="mi">14</span><span class="p">);</span>

	<span class="n">alloc_list</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Get station address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dw8</span><span class="p">(</span><span class="n">StationAddr0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">set_multicast</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">coalesce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">RxDMAIntCtrl</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_coalesce</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Set RIO to poll every N*320nsec. */</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">RxDMAPollPeriod</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">TxDMAPollPeriod</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">RxDMABurstThresh</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">RxDMAUrgentThresh</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">RmonStatMask</span><span class="p">,</span> <span class="mh">0x0007ffff</span><span class="p">);</span>
	<span class="cm">/* clear statistics */</span>
	<span class="n">clear_stats</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* VLAN supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* priority field in RxDMAIntCtrl  */</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">RxDMAIntCtrl</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">RxDMAIntCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="cm">/* VLANId */</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">VLANId</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>
		<span class="cm">/* Length/Type should be 0x8100 */</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">VLANTag</span><span class="p">,</span> <span class="mh">0x8100</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>
		<span class="cm">/* Enable AutoVLANuntagging, but disable AutoVLANtagging.</span>
<span class="cm">		   VLAN information tagged by TFC&#39; VID, CFI fields. */</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">AutoVLANuntagging</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">rio_timer</span><span class="p">;</span>
	<span class="n">add_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Start Tx/Rx */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">StatsEnable</span> <span class="o">|</span> <span class="n">RxEnable</span> <span class="o">|</span> <span class="n">TxEnable</span><span class="p">);</span>

	<span class="n">macctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span> <span class="o">?</span> <span class="n">AutoVLANuntagging</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="o">?</span> <span class="n">DuplexSelect</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span><span class="p">)</span> <span class="o">?</span> <span class="n">TxFlowControlEnable</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span><span class="p">)</span> <span class="o">?</span> <span class="n">RxFlowControlEnable</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dw16</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">,</span> <span class="n">macctrl</span><span class="p">);</span>

	<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dl2k_enable_int</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rio_timer</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Recover rx ring exhausted error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span> <span class="o">&gt;=</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Try to recover rx ring exhausted...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Re-allocate skbuffs to fill the descriptor ring */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
			<span class="cm">/* Dropped packets don&#39;t need to re-allocate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span>
						<span class="s">&quot;%s: Still unable to re-allocate Rx skbuff.#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span>
				    <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">pci_map_single</span>
					 <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
					  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">|=</span>
			    <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* end for */</span>
	<span class="p">}</span> <span class="cm">/* end if */</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">next_tick</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rio_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Tx timed out (%4.4x), is buffer full?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">TxStatus</span><span class="p">));</span>
	<span class="n">rio_free_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
<span class="p">}</span>

 <span class="cm">/* allocate and initialize Tx and Rx descriptors */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">alloc_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="mi">1500</span> <span class="o">?</span> <span class="n">PACKET_SIZE</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Initialize Tx descriptors, TFDListPtr leaves in start_xmit(). */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">TFDDone</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span>
					      <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="o">*</span>
					      <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netdev_desc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize Rx descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span>
						<span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="o">*</span>
						<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netdev_desc</span><span class="p">));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the rx buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocated fixed size of skbuff */</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: alloc_list: allocate Rx buffer error! &quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Rubicon now supports 40 bits of addressing space. */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le64</span> <span class="p">(</span> <span class="n">pci_map_single</span> <span class="p">(</span>
			 	  <span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
				  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">|=</span> <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set RFDListPtr */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">RFDListPtr0</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">RFDListPtr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">start_xmit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_desc</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tfc_vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Link Down */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">txdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (skb-&gt;ip_summed == CHECKSUM_PARTIAL) {</span>
<span class="c">		txdesc-&gt;status |=</span>
<span class="c">		    cpu_to_le64 (TCPChecksumEnable | UDPChecksumEnable |</span>
<span class="c">				 IPChecksumEnable);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tfc_vlan_tag</span> <span class="o">=</span> <span class="n">VLANTagInsert</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;&lt;</span> <span class="mi">45</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">fraginfo</span> <span class="o">=</span> <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">pci_map_single</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
							<span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">fraginfo</span> <span class="o">|=</span> <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>

	<span class="cm">/* DL2K bug: DMA fails to get next descriptor ptr in 10Mbps mode</span>
<span class="cm">	 * Work around: Always use 1 descriptor in 10Mbps mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">%</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_coalesce</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">entry</span> <span class="o">|</span> <span class="n">tfc_vlan_tag</span> <span class="o">|</span>
					      <span class="n">WordAlignDisable</span> <span class="o">|</span>
					      <span class="n">TxDMAIndicate</span> <span class="o">|</span>
					      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FragCountShift</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">entry</span> <span class="o">|</span> <span class="n">tfc_vlan_tag</span> <span class="o">|</span>
					      <span class="n">WordAlignDisable</span> <span class="o">|</span>
					      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FragCountShift</span><span class="p">));</span>

	<span class="cm">/* TxDMAPollNow */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">DMACtrl</span><span class="p">,</span> <span class="n">dr32</span><span class="p">(</span><span class="n">DMACtrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00001000</span><span class="p">);</span>
	<span class="cm">/* Schedule ISR */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">CountDown</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">+</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span>
			<span class="o">&lt;</span> <span class="n">TX_QUEUE_LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do nothing */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The first TFDListPtr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dr32</span><span class="p">(</span><span class="n">TFDListPtr0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">TFDListPtr0</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span>
		     <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netdev_desc</span><span class="p">));</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">TFDListPtr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">rio_interrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">int_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">max_intrloop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_status</span> <span class="o">=</span> <span class="n">dr16</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">);</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>
		<span class="n">int_status</span> <span class="o">&amp;=</span> <span class="n">DEFAULT_INTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">--</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Processing received packets */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">RxDMAComplete</span><span class="p">)</span>
			<span class="n">receive_packet</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* TxDMAComplete interrupt */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxDMAComplete</span><span class="o">|</span><span class="n">IntRequested</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tx_status</span><span class="p">;</span>
			<span class="n">tx_status</span> <span class="o">=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">TxStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">tx_error</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
			<span class="cm">/* Free used tx skbuffs */</span>
			<span class="n">rio_free_tx</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Handle uncommon events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">HostError</span> <span class="o">|</span> <span class="n">LinkEvent</span> <span class="o">|</span> <span class="n">UpdateStats</span><span class="p">))</span>
			<span class="n">rio_error</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span><span class="p">)</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">CountDown</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span> <span class="nf">desc_to_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fraginfo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rio_free_tx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

	<span class="cm">/* Free used tx skbuffs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">TFDDone</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="n">pci_unmap_single</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="n">desc_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">]),</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_irq</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
		<span class="n">tx_use</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="cm">/* If the ring is no longer full, clear tx_full and</span>
<span class="cm">	   call netif_wake_queue() */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">+</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span>
	    <span class="o">&lt;</span> <span class="n">TX_QUEUE_LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tx_error</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frame_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">frame_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Transmit error, TxStatus %4.4x, FrameId %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Ttransmit Underrun */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">TxStartThresh</span><span class="p">,</span> <span class="n">dr16</span><span class="p">(</span><span class="n">TxStartThresh</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="cm">/* Transmit Underrun need to set TxReset, DMARest, FIFOReset */</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">ASICCtrl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
		     <span class="n">TxReset</span> <span class="o">|</span> <span class="n">DMAReset</span> <span class="o">|</span> <span class="n">FIFOReset</span> <span class="o">|</span> <span class="n">NetworkReset</span><span class="p">);</span>
		<span class="cm">/* Wait for ResetBusy bit clear */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dr16</span><span class="p">(</span><span class="n">ASICCtrl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ResetBusy</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rio_free_tx</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Reset TFDListPtr */</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">TFDListPtr0</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span>
		     <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netdev_desc</span><span class="p">));</span>
		<span class="n">dw32</span><span class="p">(</span><span class="n">TFDListPtr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Let TxStartThresh stay default value */</span>
	<span class="p">}</span>
	<span class="cm">/* Late Collision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* TxReset and clear FIFO */</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">ASICCtrl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TxReset</span> <span class="o">|</span> <span class="n">FIFOReset</span><span class="p">);</span>
		<span class="cm">/* Wait reset done */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dr16</span><span class="p">(</span><span class="n">ASICCtrl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ResetBusy</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Let TxStartThresh stay default value */</span>
	<span class="p">}</span>
	<span class="cm">/* Maximum Collisions */</span>
<span class="cp">#ifdef ETHER_STATS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions16</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* Restart the Tx */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">,</span> <span class="n">dr16</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">TxEnable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">receive_packet</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="cm">/* If RFDDone, FrameStart and FrameEnd set, there is a new packet in. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">frame_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">RFDDone</span><span class="p">))</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">FrameStart</span><span class="p">))</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">FrameEnd</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Chip omits the CRC. */</span>
		<span class="n">frame_status</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Update rx error statistics, drop packet. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">RFS_Errors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxRuntFrame</span> <span class="o">|</span> <span class="n">RxLengthError</span><span class="p">))</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">RxFCSError</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">RxAlignmentError</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">RxFIFOOverrun</span><span class="p">)</span>
	 			<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="cm">/* Small skbuffs for short packets */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="n">copy_thresh</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="n">desc_to_dma</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
						  <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
						  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							    <span class="n">desc_to_dma</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
							    <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
							    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">skb_copy_to_linear_data</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						  <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						  <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							       <span class="n">desc_to_dma</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
							       <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
							       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			/* Checksum done by hw, but csum value unavailable. */</span>
<span class="c">			if (np-&gt;pdev-&gt;pci_rev_id &gt;= 0x0c &amp;&amp;</span>
<span class="c">				!(frame_status &amp; (TCPError | UDPError | IPError))) {</span>
<span class="c">				skb-&gt;ip_summed = CHECKSUM_UNNECESSARY;</span>
<span class="c">			}</span>
<span class="cp">#endif</span>
			<span class="n">netif_rx</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="cm">/* Re-allocate skbuffs to fill the descriptor ring */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="cm">/* Dropped packets don&#39;t need to re-allocate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span>
					<span class="s">&quot;%s: receive_packet: &quot;</span>
					<span class="s">&quot;Unable to re-allocate Rx skbuff.#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span>
			    <span class="n">cpu_to_le64</span> <span class="p">(</span><span class="n">pci_map_single</span>
					 <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
					  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">|=</span>
		    <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">old_rx</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rio_error</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">int_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macctrl</span><span class="p">;</span>

	<span class="cm">/* Link change event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">LinkEvent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_wait_link</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_media</span><span class="p">)</span>
				<span class="n">mii_get_media_pcs</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mii_get_media</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_coalesce</span> <span class="o">=</span> <span class="n">tx_coalesce</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_coalesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">macctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span> <span class="o">?</span> <span class="n">AutoVLANuntagging</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="o">?</span> <span class="n">DuplexSelect</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">TxFlowControlEnable</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">macctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">RxFlowControlEnable</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dw16</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">,</span> <span class="n">macctrl</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* UpdateStats statistics registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">UpdateStats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_stats</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PCI Error, a catastronphic error related to the bus interface</span>
<span class="cm">	   occurs, set GlobalReset and HostReset to reset. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">HostError</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: HostError! IntStatus %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>
		<span class="n">dw16</span><span class="p">(</span><span class="n">ASICCtrl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GlobalReset</span> <span class="o">|</span> <span class="n">HostReset</span><span class="p">);</span>
		<span class="n">mdelay</span> <span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">get_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
<span class="cp">#ifdef MEM_MAPPING</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat_reg</span><span class="p">;</span>

	<span class="cm">/* All statistics registers need to be acknowledged,</span>
<span class="cm">	   else statistic overflow could cause problems */</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">FramesRcvOk</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">FramesXmtOk</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">OctetRcvOk</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">OctetXmtOk</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">McstFramesRcvdOk</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">dr32</span><span class="p">(</span><span class="n">SingleColFrames</span><span class="p">)</span>
			     <span class="o">+</span>  <span class="n">dr32</span><span class="p">(</span><span class="n">MultiColFrames</span><span class="p">);</span>

	<span class="cm">/* detailed tx errors */</span>
	<span class="n">stat_reg</span> <span class="o">=</span> <span class="n">dr16</span><span class="p">(</span><span class="n">FramesAbortXSColls</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">stat_reg</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">stat_reg</span><span class="p">;</span>

	<span class="n">stat_reg</span> <span class="o">=</span> <span class="n">dr16</span><span class="p">(</span><span class="n">CarrierSenseErrors</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">+=</span> <span class="n">stat_reg</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">stat_reg</span><span class="p">;</span>

	<span class="cm">/* Clear all other statistic register. */</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstOctetXmtOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">BcstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">BcstFramesRcvdOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">MacControlFramesRcvd</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FrameTooLongErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">InRangeLengthErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesCheckSeqErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesLostRxErrors</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstOctetXmtOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">BcstOctetXmtOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">FramesWDeferredXmt</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">LateCollisions</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">BcstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">MacControlFramesXmtd</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesWEXDeferal</span><span class="p">);</span>

<span class="cp">#ifdef MEM_MAPPING</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x150</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dr32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">TxJumboFrames</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">RxJumboFrames</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">TCPCheckSumErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">UDPCheckSumErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">IPCheckSumErrors</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">clear_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
<span class="cp">#ifdef MEM_MAPPING</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* All statistics registers need to be acknowledged,</span>
<span class="cm">	   else statistic overflow could cause problems */</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">FramesRcvOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">FramesXmtOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">OctetRcvOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">OctetXmtOk</span><span class="p">);</span>

	<span class="n">dr32</span><span class="p">(</span><span class="n">McstFramesRcvdOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">SingleColFrames</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">MultiColFrames</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">LateCollisions</span><span class="p">);</span>
	<span class="cm">/* detailed rx errors */</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FrameTooLongErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">InRangeLengthErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesCheckSeqErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesLostRxErrors</span><span class="p">);</span>

	<span class="cm">/* detailed tx errors */</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesAbortXSColls</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">CarrierSenseErrors</span><span class="p">);</span>

	<span class="cm">/* Clear all other statistic register. */</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstOctetXmtOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">BcstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">BcstFramesRcvdOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">MacControlFramesRcvd</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstOctetXmtOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">BcstOctetXmtOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">McstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr32</span><span class="p">(</span><span class="n">FramesWDeferredXmt</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">BcstFramesXmtdOk</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">MacControlFramesXmtd</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">FramesWEXDeferal</span><span class="p">);</span>
<span class="cp">#ifdef MEM_MAPPING</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x150</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dr32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">TxJumboFrames</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">RxJumboFrames</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">TCPCheckSumErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">UDPCheckSumErrors</span><span class="p">);</span>
	<span class="n">dr16</span><span class="p">(</span><span class="n">IPCheckSumErrors</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">change_mtu</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">jumbo</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAX_JUMBO</span> <span class="o">:</span> <span class="mi">1536</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_multicast</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">rx_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hash_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* RxFlowcontrol DA: 01-80-C2-00-00-01. Hash index=0x39 */</span>
	<span class="n">hash_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Receive all frames promiscuously. */</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">ReceiveAllFrames</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Receive broadcast and multicast frames */</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">ReceiveBroadcast</span> <span class="o">|</span> <span class="n">ReceiveMulticast</span> <span class="o">|</span> <span class="n">ReceiveUnicast</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="cm">/* Receive broadcast frames and multicast frames filtering</span>
<span class="cm">		   by Hashtable */</span>
		<span class="n">rx_mode</span> <span class="o">=</span>
		    <span class="n">ReceiveBroadcast</span> <span class="o">|</span> <span class="n">ReceiveMulticastHash</span> <span class="o">|</span> <span class="n">ReceiveUnicast</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="cm">/* The inverted high significant 6 bits of CRC are</span>
<span class="cm">			   used as an index to hashtable */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">bit</span><span class="p">)))</span>
					<span class="n">index</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
			<span class="n">hash_table</span><span class="p">[</span><span class="n">index</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">ReceiveBroadcast</span> <span class="o">|</span> <span class="n">ReceiveUnicast</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ReceiveVLANMatch field in ReceiveMode */</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">ReceiveVLANMatch</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dw32</span><span class="p">(</span><span class="n">HashTable0</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">HashTable1</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">dw16</span><span class="p">(</span><span class="n">ReceiveMode</span><span class="p">,</span> <span class="n">rx_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;dl2k&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_media</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fiber device */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="o">=</span> <span class="n">ADVERTISED_Autoneg</span> <span class="o">|</span> <span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* copper device */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Half</span>
			<span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			<span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_MII</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
			<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span> <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
			<span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="o">|</span>
			<span class="n">ADVERTISED_Autoneg</span> <span class="o">|</span> <span class="n">ADVERTISED_MII</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mii_set_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Warning!! Can&#39;t disable Auto negotiation in 1000Mbps, change to Manual 100Mbps, Full duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>: <span class="cm">/* not supported */</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mii_set_media</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rio_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">rio_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">rio_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">rio_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">rio_get_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">miidata</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">miidata</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
		<span class="n">miidata</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">miidata</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">miidata</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">miidata</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EEP_READ 0x0200</span>
<span class="cp">#define EEP_BUSY 0x8000</span>
<span class="cm">/* Read the EEPROM word */</span>
<span class="cm">/* We use I/O instruction to read/write eeprom to avoid fail on some machines */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eep_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dw16</span><span class="p">(</span><span class="n">EepromCtrl</span><span class="p">,</span> <span class="n">EEP_READ</span> <span class="o">|</span> <span class="p">(</span><span class="n">eep_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dr16</span><span class="p">(</span><span class="n">EepromCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEP_BUSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">dr16</span><span class="p">(</span><span class="n">EepromData</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">phy_ctrl_bits</span> <span class="p">{</span>
	<span class="n">MII_READ</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">MII_CLK</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">MII_DATA1</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">MII_WRITE</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">MII_DUPLEX</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define mii_delay() dr8(PhyCtrl)</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mii_sendbit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">)</span> <span class="o">?</span> <span class="n">MII_DATA1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dr8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">MII_WRITE</span><span class="p">;</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mii_delay</span> <span class="p">();</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">MII_CLK</span><span class="p">);</span>
	<span class="n">mii_delay</span> <span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_getbit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">MII_READ</span><span class="p">;</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mii_delay</span> <span class="p">();</span>
	<span class="n">dw8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">MII_CLK</span><span class="p">);</span>
	<span class="n">mii_delay</span> <span class="p">();</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dr8</span><span class="p">(</span><span class="n">PhyCtrl</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mii_send_bits</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_sendbit</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Preamble */</span>
	<span class="n">mii_send_bits</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/* ST(2), OP(2), ADDR(5), REG#(5), TA(2), Data(16) total 32 bits */</span>
	<span class="cm">/* ST,OP = 0110&#39;b for read operation */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span> <span class="o">|</span> <span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">reg_num</span><span class="p">);</span>
	<span class="n">mii_send_bits</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="cm">/* Turnaround */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_getbit</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="cm">/* Read data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">mii_getbit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* End cycle */</span>
	<span class="n">mii_getbit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

      <span class="nl">err_out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_num</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* Preamble */</span>
	<span class="n">mii_send_bits</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/* ST(2), OP(2), ADDR(5), REG#(5), TA(2), Data(16) total 32 bits */</span>
	<span class="cm">/* ST,OP,AAAAA,RRRRR,TA = 0101xxxxxxxxxx10&#39;b = 0x5002 for write */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x5002</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg_num</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">mii_send_bits</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/* End cycle */</span>
	<span class="n">mii_getbit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_wait_link</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">bmsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bmsr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_get_media</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">negotiate</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">bmsr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">mscr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">mssr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCOMPLETE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Auto-Negotiation not completed */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">negotiate</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
		<span class="n">mscr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">);</span>
		<span class="n">mssr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mscr</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000FULL</span> <span class="o">&amp;&amp;</span> <span class="n">mssr</span> <span class="o">&amp;</span> <span class="n">LPA_1000FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 1000 Mbps, Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mscr</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000HALF</span> <span class="o">&amp;&amp;</span> <span class="n">mssr</span> <span class="o">&amp;</span> <span class="n">LPA_1000HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 1000 Mbps, Half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 100 Mbps, Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 100 Mbps, Half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 10 Mbps, Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 10 Mbps, Half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* else tx_flow, rx_flow = user select  */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__u16</span> <span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMCR_SPEED100</span> <span class="o">|</span> <span class="n">BMCR_SPEED1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BMCR_SPEED1000</span>:
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Operating at 1000 Mbps, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BMCR_SPEED100</span>:
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Operating at 100 Mbps, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Operating at 10 Mbps, &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enable Tx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Disable Tx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enable Rx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Disable Rx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_set_media</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">pscr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">bmsr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">anar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="cm">/* Does user set speed? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Advertise capabilities */</span>
		<span class="n">bmsr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="n">anar</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_100FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">|</span>
			  <span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10HALF</span> <span class="o">|</span>
			  <span class="n">ADVERTISE_100BASE4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">)</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100BASE4</span><span class="p">)</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">ADVERTISE_100BASE4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">)</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
		<span class="n">anar</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">anar</span><span class="p">);</span>

		<span class="cm">/* Enable Auto crossover */</span>
		<span class="n">pscr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_PHY_SCR</span><span class="p">);</span>
		<span class="n">pscr</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* 11&#39;b */</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_PHY_SCR</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>

		<span class="cm">/* Soft reset PHY */</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span> <span class="o">|</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Force speed setting */</span>
		<span class="cm">/* 1) Disable Auto crossover */</span>
		<span class="n">pscr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_PHY_SCR</span><span class="p">);</span>
		<span class="n">pscr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_PHY_SCR</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>

		<span class="cm">/* 2) PHY Reset */</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

		<span class="cm">/* 3) Power Down */</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="mh">0x1940</span><span class="p">;</span>	<span class="cm">/* must be 0x1940 */</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="n">mdelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>	<span class="cm">/* wait a certain time */</span>

		<span class="cm">/* 4) Advertise nothing */</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* 5) Set media and Power Up */</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_PDOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Manual 100 Mbps, &quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Manual 10 Mbps, &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* Set 1000BaseT Master/Slave setting */</span>
<span class="c">		mscr = mii_read (dev, phy_addr, MII_CTRL1000);</span>
<span class="c">		mscr |= MII_MSCR_CFG_ENABLE;</span>
<span class="c">		mscr &amp;= ~MII_MSCR_CFG_VALUE = 0;</span>
<span class="cp">#endif</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_get_media_pcs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">negotiate</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">bmsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">PCS_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCOMPLETE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Auto-Negotiation not completed */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">negotiate</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">PCS_ANAR</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">PCS_ANLPAR</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">PCS_ANAR_FULL_DUPLEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 1000 Mbps, Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Auto 1000 Mbps, half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">PCS_ANAR_PAUSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">negotiate</span> <span class="o">&amp;</span> <span class="n">PCS_ANAR_ASYMMETRIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* else tx_flow, rx_flow = user select  */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__u16</span> <span class="n">bmcr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">PCS_BMCR</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Operating at 1000 Mbps, &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_flow</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enable Tx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Disable Tx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_flow</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enable Rx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Disable Rx Flow Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mii_set_media_pcs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">esr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">anar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="cm">/* Auto-Negotiation? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">an_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Advertise capabilities */</span>
		<span class="n">esr</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">PCS_ESR</span><span class="p">);</span>
		<span class="n">anar</span> <span class="o">=</span> <span class="n">mii_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">PCS_ANAR_HALF_DUPLEX</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">PCS_ANAR_FULL_DUPLEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MII_ESR_1000BT_HD</span> <span class="o">|</span> <span class="n">MII_ESR_1000BX_HD</span><span class="p">))</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">PCS_ANAR_HALF_DUPLEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MII_ESR_1000BT_FD</span> <span class="o">|</span> <span class="n">MII_ESR_1000BX_FD</span><span class="p">))</span>
			<span class="n">anar</span> <span class="o">|=</span> <span class="n">PCS_ANAR_FULL_DUPLEX</span><span class="p">;</span>
		<span class="n">anar</span> <span class="o">|=</span> <span class="n">PCS_ANAR_PAUSE</span> <span class="o">|</span> <span class="n">PCS_ANAR_ASYMMETRIC</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">anar</span><span class="p">);</span>

		<span class="cm">/* Soft reset PHY */</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span> <span class="o">|</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Force speed setting */</span>
		<span class="cm">/* PHY Reset */</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Manual full duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Manual half duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="cm">/*  Advertise nothing */</span>
		<span class="n">mii_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">dw16</span><span class="p">(</span><span class="n">IntEnable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Stop Tx and Rx logics */</span>
	<span class="n">dw32</span><span class="p">(</span><span class="n">MACCtrl</span><span class="p">,</span> <span class="n">TxDisable</span> <span class="o">|</span> <span class="n">RxDisable</span> <span class="o">|</span> <span class="n">StatsDisable</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Free all the skbuffs in the queue. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">desc_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fraginfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">desc_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">rio_remove1</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unregister_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
				     <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
				     <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
<span class="cp">#ifdef MEM_MAPPING</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span><span class="p">);</span>
		<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;dl2k&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rio_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rio_probe1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rio_remove1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">rio_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">rio_exit</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span> <span class="p">(</span><span class="n">rio_init</span><span class="p">);</span>
<span class="n">module_exit</span> <span class="p">(</span><span class="n">rio_exit</span><span class="p">);</span>

<span class="cm">/*</span>

<span class="cm">Compile command:</span>

<span class="cm">gcc -D__KERNEL__ -DMODULE -I/usr/src/linux/include -Wall -Wstrict-prototypes -O2 -c dl2k.c</span>

<span class="cm">Read Documentation/networking/dl2k.txt for details.</span>

<span class="cm">*/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
