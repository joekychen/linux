<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › dlink › de600.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>de600.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**************************************************</span>
<span class="cm"> *                                                *</span>
<span class="cm"> * Definition of D-Link Ethernet Pocket adapter   *</span>
<span class="cm"> *                                                *</span>
<span class="cm"> **************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * D-Link Ethernet pocket adapter ports</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * OK, so I&#39;m cheating, but there are an awful lot of</span>
<span class="cm"> * reads and writes in order to get anything in and out</span>
<span class="cm"> * of the DE-600 with 4 bits at a time in the parallel port,</span>
<span class="cm"> * so every saved instruction really helps :-)</span>
<span class="cm"> */</span>

<span class="cp">#ifndef DE600_IO</span>
<span class="cp">#define DE600_IO	0x378</span>
<span class="cp">#endif</span>

<span class="cp">#define DATA_PORT	(DE600_IO)</span>
<span class="cp">#define STATUS_PORT	(DE600_IO + 1)</span>
<span class="cp">#define COMMAND_PORT	(DE600_IO + 2)</span>

<span class="cp">#ifndef DE600_IRQ</span>
<span class="cp">#define DE600_IRQ	7</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> * It really should look like this, and autoprobing as well...</span>
<span class="cm"> *</span>
<span class="cm">#define DATA_PORT	(dev-&gt;base_addr + 0)</span>
<span class="cm">#define STATUS_PORT	(dev-&gt;base_addr + 1)</span>
<span class="cm">#define COMMAND_PORT	(dev-&gt;base_addr + 2)</span>
<span class="cm">#define DE600_IRQ	dev-&gt;irq</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * D-Link COMMAND_PORT commands</span>
<span class="cm"> */</span>
<span class="cp">#define SELECT_NIC	0x04 </span><span class="cm">/* select Network Interface Card */</span><span class="cp"></span>
<span class="cp">#define SELECT_PRN	0x1c </span><span class="cm">/* select Printer */</span><span class="cp"></span>
<span class="cp">#define NML_PRN		0xec </span><span class="cm">/* normal Printer situation */</span><span class="cp"></span>
<span class="cp">#define IRQEN		0x10 </span><span class="cm">/* enable IRQ line */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * D-Link STATUS_PORT</span>
<span class="cm"> */</span>
<span class="cp">#define RX_BUSY		0x80</span>
<span class="cp">#define RX_GOOD		0x40</span>
<span class="cp">#define TX_FAILED16	0x10</span>
<span class="cp">#define TX_BUSY		0x08</span>

<span class="cm">/*</span>
<span class="cm"> * D-Link DATA_PORT commands</span>
<span class="cm"> * command in low 4 bits</span>
<span class="cm"> * data in high 4 bits</span>
<span class="cm"> * select current data nibble with HI_NIBBLE bit</span>
<span class="cm"> */</span>
<span class="cp">#define WRITE_DATA	0x00 </span><span class="cm">/* write memory */</span><span class="cp"></span>
<span class="cp">#define READ_DATA	0x01 </span><span class="cm">/* read memory */</span><span class="cp"></span>
<span class="cp">#define STATUS		0x02 </span><span class="cm">/* read  status register */</span><span class="cp"></span>
<span class="cp">#define COMMAND		0x03 </span><span class="cm">/* write command register (see COMMAND below) */</span><span class="cp"></span>
<span class="cp">#define NULL_COMMAND	0x04 </span><span class="cm">/* null command */</span><span class="cp"></span>
<span class="cp">#define RX_LEN		0x05 </span><span class="cm">/* read  received packet length */</span><span class="cp"></span>
<span class="cp">#define TX_ADDR		0x06 </span><span class="cm">/* set adapter transmit memory address */</span><span class="cp"></span>
<span class="cp">#define RW_ADDR		0x07 </span><span class="cm">/* set adapter read/write memory address */</span><span class="cp"></span>
<span class="cp">#define HI_NIBBLE	0x08 </span><span class="cm">/* read/write the high nibble of data,</span>
<span class="cm">				or-ed with rest of command */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * command register, accessed through DATA_PORT with low bits = COMMAND</span>
<span class="cm"> */</span>
<span class="cp">#define RX_ALL		0x01 </span><span class="cm">/* PROMISCUOUS */</span><span class="cp"></span>
<span class="cp">#define RX_BP		0x02 </span><span class="cm">/* default: BROADCAST &amp; PHYSICAL ADDRESS */</span><span class="cp"></span>
<span class="cp">#define RX_MBP		0x03 </span><span class="cm">/* MULTICAST, BROADCAST &amp; PHYSICAL ADDRESS */</span><span class="cp"></span>

<span class="cp">#define TX_ENABLE	0x04 </span><span class="cm">/* bit 2 */</span><span class="cp"></span>
<span class="cp">#define RX_ENABLE	0x08 </span><span class="cm">/* bit 3 */</span><span class="cp"></span>

<span class="cp">#define RESET		0x80 </span><span class="cm">/* set bit 7 high */</span><span class="cp"></span>
<span class="cp">#define STOP_RESET	0x00 </span><span class="cm">/* set bit 7 low */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * data to command register</span>
<span class="cm"> * (high 4 bits in write to DATA_PORT)</span>
<span class="cm"> */</span>
<span class="cp">#define RX_PAGE2_SELECT	0x10 </span><span class="cm">/* bit 4, only 2 pages to select */</span><span class="cp"></span>
<span class="cp">#define RX_BASE_PAGE	0x20 </span><span class="cm">/* bit 5, always set when specifying RX_ADDR */</span><span class="cp"></span>
<span class="cp">#define FLIP_IRQ	0x40 </span><span class="cm">/* bit 6 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * D-Link adapter internal memory:</span>
<span class="cm"> *</span>
<span class="cm"> * 0-2K 1:st transmit page (send from pointer up to 2K)</span>
<span class="cm"> * 2-4K	2:nd transmit page (send from pointer up to 4K)</span>
<span class="cm"> *</span>
<span class="cm"> * 4-6K 1:st receive page (data from 4K upwards)</span>
<span class="cm"> * 6-8K 2:nd receive page (data from 6K upwards)</span>
<span class="cm"> *</span>
<span class="cm"> * 8K+	Adapter ROM (contains magic code and last 3 bytes of Ethernet address)</span>
<span class="cm"> */</span>
<span class="cp">#define MEM_2K		0x0800 </span><span class="cm">/* 2048 */</span><span class="cp"></span>
<span class="cp">#define MEM_4K		0x1000 </span><span class="cm">/* 4096 */</span><span class="cp"></span>
<span class="cp">#define MEM_6K		0x1800 </span><span class="cm">/* 6144 */</span><span class="cp"></span>
<span class="cp">#define NODE_ADDRESS	0x2000 </span><span class="cm">/* 8192 */</span><span class="cp"></span>

<span class="cp">#define RUNT 60		</span><span class="cm">/* Too small Ethernet packet */</span><span class="cp"></span>

<span class="cm">/**************************************************</span>
<span class="cm"> *                                                *</span>
<span class="cm"> *             End of definition                  *</span>
<span class="cm"> *                                                *</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Index to functions, as function prototypes.</span>
<span class="cm"> */</span>
<span class="cm">/* Routines used internally. (See &quot;convenience macros&quot;) */</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">de600_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">de600_read_byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Put in the device structure. */</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">de600_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">de600_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">de600_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Dispatch from interrupts. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">de600_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">de600_tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">de600_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Initialization */</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">trigger_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">adapter_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Convenience macros/functions for D-Link adapter</span>
<span class="cm"> */</span>

<span class="cp">#define select_prn() outb_p(SELECT_PRN, COMMAND_PORT); DE600_SLOW_DOWN</span>
<span class="cp">#define select_nic() outb_p(SELECT_NIC, COMMAND_PORT); DE600_SLOW_DOWN</span>

<span class="cm">/* Thanks for hints from Mark Burton &lt;markb@ordern.demon.co.uk&gt; */</span>
<span class="cp">#define de600_put_byte(data) ( \</span>
<span class="cp">	outb_p(((data) &lt;&lt; 4)   | WRITE_DATA            , DATA_PORT), \</span>
<span class="cp">	outb_p(((data) &amp; 0xf0) | WRITE_DATA | HI_NIBBLE, DATA_PORT))</span>

<span class="cm">/*</span>
<span class="cm"> * The first two outb_p()&#39;s below could perhaps be deleted if there</span>
<span class="cm"> * would be more delay in the last two. Not certain about it yet...</span>
<span class="cm"> */</span>
<span class="cp">#define de600_put_command(cmd) ( \</span>
<span class="cp">	outb_p(( rx_page        &lt;&lt; 4)   | COMMAND            , DATA_PORT), \</span>
<span class="cp">	outb_p(( rx_page        &amp; 0xf0) | COMMAND | HI_NIBBLE, DATA_PORT), \</span>
<span class="cp">	outb_p(((rx_page | cmd) &lt;&lt; 4)   | COMMAND            , DATA_PORT), \</span>
<span class="cp">	outb_p(((rx_page | cmd) &amp; 0xf0) | COMMAND | HI_NIBBLE, DATA_PORT))</span>

<span class="cp">#define de600_setup_address(addr,type) ( \</span>
<span class="cp">	outb_p((((addr) &lt;&lt; 4) &amp; 0xf0) | type            , DATA_PORT), \</span>
<span class="cp">	outb_p(( (addr)       &amp; 0xf0) | type | HI_NIBBLE, DATA_PORT), \</span>
<span class="cp">	outb_p((((addr) &gt;&gt; 4) &amp; 0xf0) | type            , DATA_PORT), \</span>
<span class="cp">	outb_p((((addr) &gt;&gt; 8) &amp; 0xf0) | type | HI_NIBBLE, DATA_PORT))</span>

<span class="cp">#define rx_page_adr() ((rx_page &amp; RX_PAGE2_SELECT)?(MEM_6K):(MEM_4K))</span>

<span class="cm">/* Flip bit, only 2 pages */</span>
<span class="cp">#define next_rx_page() (rx_page ^= RX_PAGE2_SELECT)</span>

<span class="cp">#define tx_page_adr(a) (((a) + 1) * MEM_2K)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
