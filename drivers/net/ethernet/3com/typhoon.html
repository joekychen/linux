<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › 3com › typhoon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>typhoon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* typhoon.c: A Linux Ethernet device driver for 3Com 3CR990 family of NICs */</span>
<span class="cm">/*</span>
<span class="cm">	Written 2002-2004 by David Dillow &lt;dave@thedillows.org&gt;</span>
<span class="cm">	Based on code written 1998-2000 by Donald Becker &lt;becker@scyld.com&gt; and</span>
<span class="cm">	Linux 2.2.x driver by David P. McLean &lt;davidpmclean@yahoo.com&gt;.</span>

<span class="cm">	This software may be used and distributed according to the terms of</span>
<span class="cm">	the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">	Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm">	retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm">	a complete program and may only be used when the entire operating</span>
<span class="cm">	system is licensed under the GPL.</span>

<span class="cm">	This software is available on a public web site. It may enable</span>
<span class="cm">	cryptographic capabilities of the 3Com hardware, and may be</span>
<span class="cm">	exported from the United States under License Exception &quot;TSU&quot;</span>
<span class="cm">	pursuant to 15 C.F.R. Section 740.13(e).</span>

<span class="cm">	This work was funded by the National Library of Medicine under</span>
<span class="cm">	the Department of Energy project number 0274DD06D1 and NLM project</span>
<span class="cm">	number Y1-LM-2015-01.</span>

<span class="cm">	This driver is designed for the 3Com 3CR990 Family of cards with the</span>
<span class="cm">	3XP Processor. It has been tested on x86 and sparc64.</span>

<span class="cm">	KNOWN ISSUES:</span>
<span class="cm">	*) Cannot DMA Rx packets to a 2 byte aligned address. Also firmware</span>
<span class="cm">		issue. Hopefully 3Com will fix it.</span>
<span class="cm">	*) Waiting for a command response takes 8ms due to non-preemptable</span>
<span class="cm">		polling. Only significant for getting stats and creating</span>
<span class="cm">		SAs, but an ugly wart never the less.</span>

<span class="cm">	TODO:</span>
<span class="cm">	*) Doesn&#39;t do IPSEC offloading. Yet. Keep yer pants on, it&#39;s coming.</span>
<span class="cm">	*) Add more support for ethtool (especially for NIC stats)</span>
<span class="cm">	*) Allow disabling of RX checksum offloading</span>
<span class="cm">	*) Fix MAC changing to work while the interface is up</span>
<span class="cm">		(Need to put commands on the TX ring, which changes</span>
<span class="cm">		the locking)</span>
<span class="cm">	*) Add in FCS to {rx,tx}_bytes, since the hardware doesn&#39;t. See</span>
<span class="cm">		http://oss.sgi.com/cgi-bin/mesg.cgi?a=netdev&amp;i=20031215152211.7003fe8e.rddunlap%40osdl.org</span>
<span class="cm">*/</span>

<span class="cm">/* Set the copy breakpoint for the copy-only-tiny-frames scheme.</span>
<span class="cm"> * Setting to &gt; 1518 effectively disables this feature.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

<span class="cm">/* Should we use MMIO or Port IO?</span>
<span class="cm"> * 0: Port IO</span>
<span class="cm"> * 1: MMIO</span>
<span class="cm"> * 2: Try MMIO, fallback to Port IO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">use_mmio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cm">/* end user-configurable values */</span>

<span class="cm">/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="cm">/* Operational parameters that are set at compile time. */</span>

<span class="cm">/* Keep the ring sizes a power of two for compile efficiency.</span>
<span class="cm"> * The compiler will convert &lt;unsigned&gt;&#39;%&#39;&lt;2^N&gt; into a bit mask.</span>
<span class="cm"> * Making the Tx ring too large decreases the effectiveness of channel</span>
<span class="cm"> * bonding and packet priority.</span>
<span class="cm"> * There are no ill effects from too-large receive rings.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t currently use the Hi Tx ring so, don&#39;t make it very big.</span>
<span class="cm"> *</span>
<span class="cm"> * Beware that if we start using the Hi Tx ring, we will need to change</span>
<span class="cm"> * typhoon_num_free_tx() and typhoon_tx_complete() to account for that.</span>
<span class="cm"> */</span>
<span class="cp">#define TXHI_ENTRIES		2</span>
<span class="cp">#define TXLO_ENTRIES		128</span>
<span class="cp">#define RX_ENTRIES		32</span>
<span class="cp">#define COMMAND_ENTRIES		16</span>
<span class="cp">#define RESPONSE_ENTRIES	32</span>

<span class="cp">#define COMMAND_RING_SIZE	(COMMAND_ENTRIES * sizeof(struct cmd_desc))</span>
<span class="cp">#define RESPONSE_RING_SIZE	(RESPONSE_ENTRIES * sizeof(struct resp_desc))</span>

<span class="cm">/* The 3XP will preload and remove 64 entries from the free buffer</span>
<span class="cm"> * list, and we need one entry to keep the ring from wrapping, so</span>
<span class="cm"> * to keep this a power of two, we use 128 entries.</span>
<span class="cm"> */</span>
<span class="cp">#define RXFREE_ENTRIES		128</span>
<span class="cp">#define RXENT_ENTRIES		(RXFREE_ENTRIES - 1)</span>

<span class="cm">/* Operational parameters that usually are not changed. */</span>

<span class="cm">/* Time in jiffies before concluding the transmitter is hung. */</span>
<span class="cp">#define TX_TIMEOUT  (2*HZ)</span>

<span class="cp">#define PKT_BUF_SZ		1536</span>
<span class="cp">#define FIRMWARE_NAME		&quot;3com/typhoon.bin&quot;</span>

<span class="cp">#define pr_fmt(fmt)		KBUILD_MODNAME &quot; &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &quot;typhoon.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Dillow &lt;dave@thedillows.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_NAME</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;3Com Typhoon Family (3C990, 3CR990, and variants)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;Packets smaller than this are copied and &quot;</span>
			       <span class="s">&quot;the buffer given back to the NIC. Default &quot;</span>
			       <span class="s">&quot;is 200.&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_mmio</span><span class="p">,</span> <span class="s">&quot;Use MMIO (1) or PIO(0) to access the NIC. &quot;</span>
			   <span class="s">&quot;Default is to try MMIO and fallback to PIO.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_mmio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if defined(NETIF_F_TSO) &amp;&amp; MAX_SKB_FRAGS &gt; 32</span>
<span class="cp">#warning Typhoon only supports 32 entries in its SG list for TSO, disabling TSO</span>
<span class="cp">#undef NETIF_F_TSO</span>
<span class="cp">#endif</span>

<span class="cp">#if TXLO_ENTRIES &lt;= (2 * MAX_SKB_FRAGS)</span>
<span class="cp">#error TX ring too small!</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">typhoon_card_info</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">capabilities</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TYPHOON_CRYPTO_NONE		0x00</span>
<span class="cp">#define TYPHOON_CRYPTO_DES		0x01</span>
<span class="cp">#define TYPHOON_CRYPTO_3DES		0x02</span>
<span class="cp">#define	TYPHOON_CRYPTO_VARIABLE		0x04</span>
<span class="cp">#define TYPHOON_FIBER			0x08</span>
<span class="cp">#define TYPHOON_WAKEUP_NEEDS_RESET	0x10</span>

<span class="k">enum</span> <span class="n">typhoon_cards</span> <span class="p">{</span>
	<span class="n">TYPHOON_TX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_TX95</span><span class="p">,</span> <span class="n">TYPHOON_TX97</span><span class="p">,</span> <span class="n">TYPHOON_SVR</span><span class="p">,</span>
	<span class="n">TYPHOON_SVR95</span><span class="p">,</span> <span class="n">TYPHOON_SVR97</span><span class="p">,</span> <span class="n">TYPHOON_TXM</span><span class="p">,</span> <span class="n">TYPHOON_BSVR</span><span class="p">,</span>
	<span class="n">TYPHOON_FX95</span><span class="p">,</span> <span class="n">TYPHOON_FX97</span><span class="p">,</span> <span class="n">TYPHOON_FX95SVR</span><span class="p">,</span> <span class="n">TYPHOON_FX97SVR</span><span class="p">,</span>
	<span class="n">TYPHOON_FXM</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* directly indexed by enum typhoon_cards, above */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">typhoon_card_info</span> <span class="n">typhoon_card_info</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3C990-TX)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_NONE</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990-TX-95)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_DES</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990-TX-97)&quot;</span><span class="p">,</span>
	 	<span class="n">TYPHOON_CRYPTO_DES</span> <span class="o">|</span> <span class="n">TYPHOON_CRYPTO_3DES</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3C990SVR)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_NONE</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990SVR95)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_DES</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990SVR97)&quot;</span><span class="p">,</span>
	 	<span class="n">TYPHOON_CRYPTO_DES</span> <span class="o">|</span> <span class="n">TYPHOON_CRYPTO_3DES</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon2 (3C990B-TX-M)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_VARIABLE</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon2 (3C990BSVR)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_VARIABLE</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990-FX-95)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_DES</span> <span class="o">|</span> <span class="n">TYPHOON_FIBER</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990-FX-97)&quot;</span><span class="p">,</span>
	 	<span class="n">TYPHOON_CRYPTO_DES</span> <span class="o">|</span> <span class="n">TYPHOON_CRYPTO_3DES</span> <span class="o">|</span> <span class="n">TYPHOON_FIBER</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990-FX-95 Server)&quot;</span><span class="p">,</span>
	 	<span class="n">TYPHOON_CRYPTO_DES</span> <span class="o">|</span> <span class="n">TYPHOON_FIBER</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon (3CR990-FX-97 Server)&quot;</span><span class="p">,</span>
	 	<span class="n">TYPHOON_CRYPTO_DES</span> <span class="o">|</span> <span class="n">TYPHOON_CRYPTO_3DES</span> <span class="o">|</span> <span class="n">TYPHOON_FIBER</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;3Com Typhoon2 (3C990B-FX-97)&quot;</span><span class="p">,</span>
		<span class="n">TYPHOON_CRYPTO_VARIABLE</span> <span class="o">|</span> <span class="n">TYPHOON_FIBER</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Notes on the new subsystem numbering scheme:</span>
<span class="cm"> * bits 0-1 indicate crypto capabilities: (0) variable, (1) DES, or (2) 3DES</span>
<span class="cm"> * bit 4 indicates if this card has secured firmware (we don&#39;t support it)</span>
<span class="cm"> * bit 8 indicates if this is a (0) copper or (1) fiber card</span>
<span class="cm"> * bits 12-16 indicate card type: (0) client and (1) server</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">typhoon_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">TYPHOON_TX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990_TX_95</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_TX95</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990_TX_97</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_TX97</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990B</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_TXM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990B</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x1102</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_FXM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990B</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_BSVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990_FX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x1101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_FX95</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990_FX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x1102</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_FX97</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990_FX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x2101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_FX95SVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990_FX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x2102</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_FX97SVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990SVR95</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_SVR95</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990SVR97</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_SVR97</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3COM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3COM_3CR990SVR</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TYPHOON_SVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">typhoon_pci_tbl</span><span class="p">);</span>

<span class="cm">/* Define the shared memory area</span>
<span class="cm"> * Align everything the 3XP will normally be using.</span>
<span class="cm"> * We&#39;ll need to move/align txHi if we start using that ring.</span>
<span class="cm"> */</span>
<span class="cp">#define __3xp_aligned	____cacheline_aligned</span>
<span class="k">struct</span> <span class="n">typhoon_shared</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_interface</span>	<span class="n">iface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span>		<span class="n">indexes</span>			<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span>			<span class="n">txLo</span><span class="p">[</span><span class="n">TXLO_ENTRIES</span><span class="p">]</span> 	<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span>			<span class="n">rxLo</span><span class="p">[</span><span class="n">RX_ENTRIES</span><span class="p">]</span>	<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span>			<span class="n">rxHi</span><span class="p">[</span><span class="n">RX_ENTRIES</span><span class="p">]</span>	<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span>			<span class="n">cmd</span><span class="p">[</span><span class="n">COMMAND_ENTRIES</span><span class="p">]</span>	<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_desc</span>		<span class="n">resp</span><span class="p">[</span><span class="n">RESPONSE_ENTRIES</span><span class="p">]</span>	<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_free</span>			<span class="n">rxBuff</span><span class="p">[</span><span class="n">RXFREE_ENTRIES</span><span class="p">]</span>	<span class="n">__3xp_aligned</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">zeroWord</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span>			<span class="n">txHi</span><span class="p">[</span><span class="n">TXHI_ENTRIES</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rxbuff_ent</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">typhoon</span> <span class="p">{</span>
	<span class="cm">/* Tx cache line section */</span>
	<span class="k">struct</span> <span class="n">transmit_ring</span> 	<span class="n">txLoRing</span>	<span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span>	<span class="n">tx_pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">tx_ioaddr</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">txlo_dma_addr</span><span class="p">;</span>

	<span class="cm">/* Irq/Rx cache line section */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">ioaddr</span>		<span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">awaiting_resp</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">duplex</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">speed</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">card_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">basic_ring</span>	<span class="n">rxLoRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span>	<span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>	<span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span>	<span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">basic_ring</span>	<span class="n">rxHiRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">basic_ring</span>	<span class="n">rxBuffRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxbuff_ent</span>	<span class="n">rxbuffers</span><span class="p">[</span><span class="n">RXENT_ENTRIES</span><span class="p">];</span>

	<span class="cm">/* general section */</span>
	<span class="n">spinlock_t</span>		<span class="n">command_lock</span>	<span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">basic_ring</span>	<span class="n">cmdRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">basic_ring</span>	<span class="n">respRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span>	<span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span>	<span class="n">stats_saved</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">typhoon_shared</span> <span class="o">*</span>	<span class="n">shared</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">shared_dma</span><span class="p">;</span>
	<span class="n">__le16</span>			<span class="n">xcvr_select</span><span class="p">;</span>
	<span class="n">__le16</span>			<span class="n">wol_events</span><span class="p">;</span>
	<span class="n">__le32</span>			<span class="n">offload</span><span class="p">;</span>

	<span class="cm">/* unused stuff (future use) */</span>
	<span class="kt">int</span>			<span class="n">capabilities</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">transmit_ring</span> 	<span class="n">txHiRing</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">completion_wait_values</span> <span class="p">{</span>
	<span class="n">NoWait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WaitNoSleep</span><span class="p">,</span> <span class="n">WaitSleep</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* These are the values for the typhoon.card_state variable.</span>
<span class="cm"> * These determine where the statistics will come from in get_stats().</span>
<span class="cm"> * The sleep image does not support the statistics we need.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">state_values</span> <span class="p">{</span>
	<span class="n">Sleeping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Running</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* PCI writes are not guaranteed to be posted in order, but outstanding writes</span>
<span class="cm"> * cannot pass a read, so this forces current writes to post.</span>
<span class="cm"> */</span>
<span class="cp">#define typhoon_post_pci_writes(x) \</span>
<span class="cp">	do { if(likely(use_mmio)) ioread32(x+TYPHOON_REG_HEARTBEAT); } while(0)</span>

<span class="cm">/* We&#39;ll wait up to six seconds for a reset, and half a second normally.</span>
<span class="cm"> */</span>
<span class="cp">#define TYPHOON_UDELAY			50</span>
<span class="cp">#define TYPHOON_RESET_TIMEOUT_SLEEP	(6 * HZ)</span>
<span class="cp">#define TYPHOON_RESET_TIMEOUT_NOSLEEP	((6 * 1000000) / TYPHOON_UDELAY)</span>
<span class="cp">#define TYPHOON_WAIT_TIMEOUT		((1000000 / 2) / TYPHOON_UDELAY)</span>

<span class="cp">#if defined(NETIF_F_TSO)</span>
<span class="cp">#define skb_tso_size(x)		(skb_shinfo(x)-&gt;gso_size)</span>
<span class="cp">#define TSO_NUM_DESCRIPTORS	2</span>
<span class="cp">#define TSO_OFFLOAD_ON		TYPHOON_OFFLOAD_TCP_SEGMENT</span>
<span class="cp">#else</span>
<span class="cp">#define NETIF_F_TSO 		0</span>
<span class="cp">#define skb_tso_size(x) 	0</span>
<span class="cp">#define TSO_NUM_DESCRIPTORS	0</span>
<span class="cp">#define TSO_OFFLOAD_ON		0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_inc_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Increment a ring index -- we can use this for all rings execept</span>
<span class="cm">	 * the Rx rings, as they use different size descriptors</span>
<span class="cm">	 * otherwise, everything is the same size as a cmd_desc</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc</span><span class="p">);</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">%=</span> <span class="n">num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_inc_cmd_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">typhoon_inc_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">COMMAND_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_inc_resp_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">typhoon_inc_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">RESPONSE_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_inc_rxfree_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">typhoon_inc_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">RXFREE_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_inc_tx_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if we start using the Hi Tx ring, this needs updateing */</span>
	<span class="n">typhoon_inc_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">TXLO_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_inc_rx_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sizeof(struct rx_desc) != sizeof(struct cmd_desc) */</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">%=</span> <span class="n">RX_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_reset</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">wait_type</span> <span class="o">==</span> <span class="n">WaitNoSleep</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">TYPHOON_RESET_TIMEOUT_NOSLEEP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">TYPHOON_RESET_TIMEOUT_SLEEP</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_RESET_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_SOFT_RESET</span><span class="p">);</span>
	<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_RESET_NONE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_SOFT_RESET</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">wait_type</span> <span class="o">!=</span> <span class="n">NoWait</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">)</span> <span class="o">==</span>
			   <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">wait_type</span> <span class="o">==</span> <span class="n">WaitSleep</span><span class="p">)</span>
				<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">TYPHOON_UDELAY</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>

	<span class="cm">/* The 3XP seems to need a little extra time to complete the load</span>
<span class="cm">	 * of the sleep image before we can reliably boot it. Failure to</span>
<span class="cm">	 * do this occasionally results in a hung adapter after boot in</span>
<span class="cm">	 * typhoon_init_one() while trying to read the MAC address or</span>
<span class="cm">	 * putting the card to sleep. 3Com&#39;s driver waits 5ms, but</span>
<span class="cm">	 * that seems to be overkill. However, if we can sleep, we might</span>
<span class="cm">	 * as well give it that much time. Otherwise, we&#39;ll give it 500us,</span>
<span class="cm">	 * which should be enough (I&#39;ve see it work well at 100us, but still</span>
<span class="cm">	 * saw occasional problems.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">wait_type</span> <span class="o">==</span> <span class="n">WaitSleep</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_wait_status</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wait_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TYPHOON_WAIT_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">)</span> <span class="o">==</span> <span class="n">wait_value</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">TYPHOON_UDELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_media_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resp_desc</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">parm1</span> <span class="o">&amp;</span> <span class="n">TYPHOON_MEDIA_STAT_NO_LINK</span><span class="p">)</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_hello</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">basic_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmdRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* We only get a hello request if we&#39;ve not sent anything to the</span>
<span class="cm">	 * card in a long while. If the lock is held, then we&#39;re in the</span>
<span class="cm">	 * process of issuing a command, so we don&#39;t need to respond.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
		<span class="n">typhoon_inc_cmd_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_HELLO_RESP</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_CMD_READY</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_process_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">resp_size</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">resp_desc</span> <span class="o">*</span><span class="n">resp_save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_desc</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">respRing</span><span class="p">.</span><span class="n">ringBase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">wrap_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cleared</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ready</span><span class="p">;</span>

	<span class="n">cleared</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respCleared</span><span class="p">);</span>
	<span class="n">ready</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respReady</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">cleared</span> <span class="o">!=</span> <span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resp_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">base</span> <span class="o">+</span> <span class="n">cleared</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">numDesc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">resp_save</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">seqNo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">resp_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">resp_save</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TYPHOON_RESP_ERROR</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">wrap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cleared</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">RESPONSE_RING_SIZE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">wrap_len</span> <span class="o">=</span> <span class="n">cleared</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">RESPONSE_RING_SIZE</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">RESPONSE_RING_SIZE</span> <span class="o">-</span> <span class="n">cleared</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">resp_save</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wrap_len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">resp_save</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">resp_save</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">wrap_len</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">resp_save</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">TYPHOON_CMD_READ_MEDIA_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">typhoon_media_status</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">TYPHOON_CMD_HELLO_RESP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">typhoon_hello</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;dumping unexpected response 0x%04x:%d:0x%02x:0x%04x:%08x:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">),</span>
				   <span class="n">resp</span><span class="o">-&gt;</span><span class="n">numDesc</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">parm1</span><span class="p">),</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">parm2</span><span class="p">),</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">parm3</span><span class="p">));</span>
		<span class="p">}</span>

<span class="nl">cleanup:</span>
		<span class="n">typhoon_inc_resp_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cleared</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respCleared</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cleared</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">resp_save</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">typhoon_num_free</span><span class="p">(</span><span class="kt">int</span> <span class="n">lastWrite</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lastRead</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ringSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this works for all descriptors but rx_desc, as they are a</span>
<span class="cm">	 * different size than the cmd_desc -- everyone else is the same</span>
<span class="cm">	 */</span>
	<span class="n">lastWrite</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc</span><span class="p">);</span>
	<span class="n">lastRead</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ringSize</span> <span class="o">+</span> <span class="n">lastRead</span> <span class="o">-</span> <span class="n">lastWrite</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ringSize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">typhoon_num_free_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lastWrite</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmdRing</span><span class="p">.</span><span class="n">lastWrite</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdCleared</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">cmdCleared</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">typhoon_num_free</span><span class="p">(</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">cmdCleared</span><span class="p">,</span> <span class="n">COMMAND_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">typhoon_num_free_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">respReady</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respReady</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">respCleared</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respCleared</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">typhoon_num_free</span><span class="p">(</span><span class="n">respReady</span><span class="p">,</span> <span class="n">respCleared</span><span class="p">,</span> <span class="n">RESPONSE_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">typhoon_num_free_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">transmit_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if we start using the Hi Tx ring, this needs updating */</span>
	<span class="k">return</span> <span class="n">typhoon_num_free</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastRead</span><span class="p">,</span> <span class="n">TXLO_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_issue_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_desc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">num_resp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resp_desc</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">basic_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmdRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_desc</span> <span class="n">local_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">got_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freeCmd</span><span class="p">,</span> <span class="n">freeResp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">wrap_len</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="n">freeCmd</span> <span class="o">=</span> <span class="n">typhoon_num_free_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">freeResp</span> <span class="o">=</span> <span class="n">typhoon_num_free_resp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">freeCmd</span> <span class="o">&lt;</span> <span class="n">num_cmd</span> <span class="o">||</span> <span class="n">freeResp</span> <span class="o">&lt;</span> <span class="n">num_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no descs for cmd, had (needed) %d (%d) cmd, %d (%d) resp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">freeCmd</span><span class="p">,</span> <span class="n">num_cmd</span><span class="p">,</span> <span class="n">freeResp</span><span class="p">,</span> <span class="n">num_resp</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TYPHOON_CMD_RESPOND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we&#39;re expecting a response, but the caller hasn&#39;t given</span>
<span class="cm">		 * us a place to put it, we&#39;ll provide one.</span>
<span class="cm">		 */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">awaiting_resp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_resp</span><span class="p">;</span>
			<span class="n">num_resp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wrap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">num_cmd</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">COMMAND_RING_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wrap_len</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">COMMAND_RING_SIZE</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">COMMAND_RING_SIZE</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wrap_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="o">*</span><span class="n">wrap_ptr</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">wrap_ptr</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ringBase</span><span class="p">,</span> <span class="n">wrap_ptr</span><span class="p">,</span> <span class="n">wrap_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">typhoon_inc_cmd_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">num_cmd</span><span class="p">);</span>

	<span class="cm">/* &quot;I feel a presence... another warrior is on the mesa.&quot;</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_CMD_READY</span><span class="p">);</span>
	<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TYPHOON_CMD_RESPOND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Ugh. We&#39;ll be here about 8ms, spinning our thumbs, unable to</span>
<span class="cm">	 * preempt or do anything other than take interrupts. So, don&#39;t</span>
<span class="cm">	 * wait for a response unless you have to.</span>
<span class="cm">	 *</span>
<span class="cm">	 * I&#39;ve thought about trying to sleep here, but we&#39;re called</span>
<span class="cm">	 * from many contexts that don&#39;t allow that. Also, given the way</span>
<span class="cm">	 * 3Com has implemented irq coalescing, we would likely timeout --</span>
<span class="cm">	 * this has been observed in real life!</span>
<span class="cm">	 *</span>
<span class="cm">	 * The big killer is we have to wait to get stats from the card,</span>
<span class="cm">	 * though we could go to a periodic refresh of those if we don&#39;t</span>
<span class="cm">	 * mind them getting somewhat stale. The rest of the waiting</span>
<span class="cm">	 * commands occur during open/close/suspend/resume, so they aren&#39;t</span>
<span class="cm">	 * time critical. Creating SAs in the future will also have to</span>
<span class="cm">	 * wait here.</span>
<span class="cm">	 */</span>
	<span class="n">got_resp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TYPHOON_WAIT_TIMEOUT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">got_resp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respCleared</span> <span class="o">!=</span> <span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respReady</span><span class="p">)</span>
			<span class="n">got_resp</span> <span class="o">=</span> <span class="n">typhoon_process_response</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">num_resp</span><span class="p">,</span>
								<span class="n">resp</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">TYPHOON_UDELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">got_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Collect the error response even if we don&#39;t care about the</span>
<span class="cm">	 * rest of the response</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TYPHOON_RESP_ERROR</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">awaiting_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">awaiting_resp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>

		<span class="cm">/* Ugh. If a response was added to the ring between</span>
<span class="cm">		 * the call to typhoon_process_response() and the clearing</span>
<span class="cm">		 * of tp-&gt;awaiting_resp, we could have missed the interrupt</span>
<span class="cm">		 * and it could hang in the ring an indeterminate amount of</span>
<span class="cm">		 * time. So, check for it, and interrupt ourselves if this</span>
<span class="cm">		 * is the case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respCleared</span> <span class="o">!=</span> <span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respReady</span><span class="p">)</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_SELF_INTERRUPT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">typhoon_tso_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">transmit_ring</span> <span class="o">*</span><span class="n">txRing</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">ring_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcpopt_desc</span> <span class="o">*</span><span class="n">tcpd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tcpd_offset</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="n">tcpd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcpopt_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
	<span class="n">tcpd_offset</span> <span class="o">+=</span> <span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">;</span>
	<span class="n">tcpd_offset</span> <span class="o">+=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcpopt_desc</span><span class="p">,</span> <span class="n">bytesTx</span><span class="p">);</span>
	<span class="n">typhoon_inc_tx_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TYPHOON_OPT_DESC</span> <span class="o">|</span> <span class="n">TYPHOON_OPT_TCP_SEG</span><span class="p">;</span>
	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">numDesc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">mss_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_tso_size</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">mss_flags</span> <span class="o">|=</span> <span class="n">TYPHOON_TSO_FIRST</span> <span class="o">|</span> <span class="n">TYPHOON_TSO_LAST</span><span class="p">;</span>
	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">respAddrLo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tcpd_offset</span><span class="p">);</span>
	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">bytesTx</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tcpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">typhoon_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">transmit_ring</span> <span class="o">*</span><span class="n">txRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">txd</span><span class="p">,</span> <span class="o">*</span><span class="n">first_txd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">skb_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numDesc</span><span class="p">;</span>

	<span class="cm">/* we have two rings to choose from, but we only use txLo for now</span>
<span class="cm">	 * If we start using the Hi ring as well, we&#39;ll need to update</span>
<span class="cm">	 * typhoon_stop_runtime(), typhoon_interrupt(), typhoon_num_free_tx(),</span>
<span class="cm">	 * and TXHI_ENTRIES to match, as well as update the TSO code below</span>
<span class="cm">	 * to get the right DMA address</span>
<span class="cm">	 */</span>
	<span class="n">txRing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">;</span>

	<span class="cm">/* We need one descriptor for each fragment of the sk_buff, plus the</span>
<span class="cm">	 * one for the -&gt;data area of it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The docs say a maximum of 16 fragment descriptors per TCP option</span>
<span class="cm">	 * descriptor, then make a new packet descriptor and option descriptor</span>
<span class="cm">	 * for the next 16 fragments. The engineers say just an option</span>
<span class="cm">	 * descriptor is needed. I&#39;ve tested up to 26 fragments with a single</span>
<span class="cm">	 * packet descriptor/option descriptor combo, so I use that for now.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If problems develop with TSO, check this first.</span>
<span class="cm">	 */</span>
	<span class="n">numDesc</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">numDesc</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* When checking for free space in the ring, we need to also</span>
<span class="cm">	 * account for the initial Tx descriptor, and we always must leave</span>
<span class="cm">	 * at least one descriptor unused in the ring so that it doesn&#39;t</span>
<span class="cm">	 * wrap and look empty.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The only time we should loop here is when we hit the race</span>
<span class="cm">	 * between marking the queue awake and updating the cleared index.</span>
<span class="cm">	 * Just loop and it will appear. This comes from the acenic driver.</span>
<span class="cm">	 */</span>
	<span class="k">while</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">typhoon_num_free_tx</span><span class="p">(</span><span class="n">txRing</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numDesc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="n">first_txd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
	<span class="n">typhoon_inc_tx_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TYPHOON_TX_DESC</span> <span class="o">|</span> <span class="n">TYPHOON_DESC_VALID</span><span class="p">;</span>
	<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">numDesc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">tx_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The 3XP will figure out if this is UDP/TCP */</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">|=</span> <span class="n">TYPHOON_TX_PF_TCP_CHKSUM</span><span class="p">;</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">|=</span> <span class="n">TYPHOON_TX_PF_UDP_CHKSUM</span><span class="p">;</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">|=</span> <span class="n">TYPHOON_TX_PF_IP_CHKSUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">|=</span>
		    <span class="n">TYPHOON_TX_PF_INSERT_VLAN</span> <span class="o">|</span> <span class="n">TYPHOON_TX_PF_VLAN_PRIORITY</span><span class="p">;</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">|=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">htons</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
				<span class="n">TYPHOON_TX_PF_VLAN_TAG_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">processFlags</span> <span class="o">|=</span> <span class="n">TYPHOON_TX_PF_TCP_SEGMENT</span><span class="p">;</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">numDesc</span><span class="o">++</span><span class="p">;</span>

		<span class="n">typhoon_tso_fill</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">txRing</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">txlo_dma_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
	<span class="n">typhoon_inc_tx_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* No need to worry about padding packet -- the firmware pads</span>
<span class="cm">	 * it with zeros to ETH_ZLEN for us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TYPHOON_FRAG_DESC</span> <span class="o">|</span> <span class="n">TYPHOON_DESC_VALID</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_dma</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addrHi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">numDesc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				         <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TYPHOON_FRAG_DESC</span> <span class="o">|</span> <span class="n">TYPHOON_DESC_VALID</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_dma</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addrHi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">numDesc</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">frag_addr</span><span class="p">;</span>

			<span class="n">txd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span>
						<span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
			<span class="n">typhoon_inc_tx_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">frag_addr</span> <span class="o">=</span> <span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">skb_dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_pdev</span><span class="p">,</span> <span class="n">frag_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TYPHOON_FRAG_DESC</span> <span class="o">|</span> <span class="n">TYPHOON_DESC_VALID</span><span class="p">;</span>
			<span class="n">txd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
			<span class="n">txd</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_dma</span><span class="p">);</span>
			<span class="n">txd</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addrHi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">first_txd</span><span class="o">-&gt;</span><span class="n">numDesc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Kick the 3XP</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_ioaddr</span> <span class="o">+</span> <span class="n">txRing</span><span class="o">-&gt;</span><span class="n">writeRegister</span><span class="p">);</span>

	<span class="cm">/* If we don&#39;t have room to put the worst case packet on the</span>
<span class="cm">	 * queue, then we must stop the queue. We need 2 extra</span>
<span class="cm">	 * descriptors -- one to prevent ring wrap, and one for the</span>
<span class="cm">	 * Tx header.</span>
<span class="cm">	 */</span>
	<span class="n">numDesc</span> <span class="o">=</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="n">TSO_NUM_DESCRIPTORS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_num_free_tx</span><span class="p">(</span><span class="n">txRing</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numDesc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* A Tx complete IRQ could have gotten between, making</span>
<span class="cm">		 * the ring free again. Only need to recheck here, since</span>
<span class="cm">		 * Tx is serialized.</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">typhoon_num_free_tx</span><span class="p">(</span><span class="n">txRing</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">numDesc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">filter</span><span class="p">;</span>

	<span class="n">filter</span> <span class="o">=</span> <span class="n">TYPHOON_RX_FILTER_DIRECTED</span> <span class="o">|</span> <span class="n">TYPHOON_RX_FILTER_BROADCAST</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter</span> <span class="o">|=</span> <span class="n">TYPHOON_RX_FILTER_PROMISCOUS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to match, or accept all multicasts. */</span>
		<span class="n">filter</span> <span class="o">|=</span> <span class="n">TYPHOON_RX_FILTER_ALL_MCAST</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span>
					 <span class="n">TYPHOON_CMD_SET_MULTICAST_HASH</span><span class="p">);</span>
		<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">TYPHOON_MCAST_HASH_SET</span><span class="p">;</span>
		<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">filter</span> <span class="o">|=</span> <span class="n">TYPHOON_RX_FILTER_MCAST_HASH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_SET_RX_FILTER</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">filter</span><span class="p">;</span>
	<span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_do_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">saved</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_saved</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_desc</span> <span class="n">xp_resp</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">stats_resp</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stats_resp</span> <span class="o">*</span><span class="p">)</span> <span class="n">xp_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_READ_STATS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">xp_resp</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* 3Com&#39;s Linux driver uses txMultipleCollisions as it&#39;s</span>
<span class="cm">	 * collisions value, but there is some other collision info as well...</span>
<span class="cm">	 *</span>
<span class="cm">	 * The extra status reported would be a good candidate for</span>
<span class="cm">	 * ethtool_ops-&gt;get_{strings,stats}()</span>
<span class="cm">	 */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txPackets</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txBytes</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txCarrierLost</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txCarrierLost</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txMultipleCollisions</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">collisions</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxPacketsGood</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxBytesGood</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxFifoOverruns</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxFifoOverruns</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">BadSSD</span><span class="p">)</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxCrcErrors</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxCrcErrors</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxOversized</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">saved</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">linkStatus</span> <span class="o">&amp;</span> <span class="n">TYPHOON_LINK_100MBPS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">linkStatus</span> <span class="o">&amp;</span> <span class="n">TYPHOON_LINK_FULL_DUPLEX</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">typhoon_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">saved</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_saved</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">card_state</span> <span class="o">==</span> <span class="n">Sleeping</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">saved</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_do_get_stats</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error getting stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">saved</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_desc</span> <span class="n">xp_resp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">card_state</span> <span class="o">==</span> <span class="n">Sleeping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;Sleep image&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_READ_VERSIONS</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">xp_resp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;Unknown runtime&quot;</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">sleep_ver</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parm2</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
				<span class="s">&quot;%02x.%03x.%03x&quot;</span><span class="p">,</span> <span class="n">sleep_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
				<span class="p">(</span><span class="n">sleep_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="n">sleep_ver</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
				<span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">xcvr_select</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPHOON_XCVR_10HALF</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPHOON_XCVR_10FULL</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPHOON_XCVR_100HALF</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPHOON_XCVR_100FULL</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPHOON_XCVR_AUTONEG</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">TYPHOON_FIBER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
		    			<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_TP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_TP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* need to get stats to make these link speed/duplex valid */</span>
	<span class="n">typhoon_do_get_stats</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">xcvr_select</span> <span class="o">==</span> <span class="n">TYPHOON_XCVR_AUTONEG</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">xcvr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xcvr</span> <span class="o">=</span> <span class="n">TYPHOON_XCVR_AUTONEG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
				<span class="n">xcvr</span> <span class="o">=</span> <span class="n">TYPHOON_XCVR_10HALF</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
				<span class="n">xcvr</span> <span class="o">=</span> <span class="n">TYPHOON_XCVR_100HALF</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
				<span class="n">xcvr</span> <span class="o">=</span> <span class="n">TYPHOON_XCVR_10FULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
				<span class="n">xcvr</span> <span class="o">=</span> <span class="n">TYPHOON_XCVR_100FULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_XCVR_SELECT</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">xcvr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">xcvr_select</span> <span class="o">=</span> <span class="n">xcvr</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* invalid */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* invalid */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span> <span class="o">&amp;</span> <span class="n">TYPHOON_WAKE_LINK_EVENT</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_PHY</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span> <span class="o">&amp;</span> <span class="n">TYPHOON_WAKE_MAGIC_PKT</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span> <span class="o">|=</span> <span class="n">TYPHOON_WAKE_LINK_EVENT</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span> <span class="o">|=</span> <span class="n">TYPHOON_WAKE_MAGIC_PKT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">RXENT_ENTRIES</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">TXLO_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">RXENT_ENTRIES</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">TXLO_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">typhoon_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">typhoon_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">typhoon_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">typhoon_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">typhoon_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">typhoon_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">typhoon_get_ringparam</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_wait_interrupt</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TYPHOON_WAIT_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="n">TYPHOON_INTR_BOOTCMD</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">TYPHOON_UDELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_BOOTCMD</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define shared_offset(x)	offsetof(struct typhoon_shared, x)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_init_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">shared_dma</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_shared</span><span class="p">));</span>

	<span class="cm">/* The *Hi members of iface are all init&#39;d to zero by the memset().</span>
<span class="cm">	 */</span>
	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">indexes</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">ringIndex</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">txLo</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">txLoAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">txLoSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TXLO_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">));</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">txHi</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">txHiAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">txHiSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TXHI_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">));</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">rxBuff</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rxBuffAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rxBuffSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RXFREE_ENTRIES</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_free</span><span class="p">));</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">rxLo</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rxLoAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rxLoSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RX_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">));</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">rxHi</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rxHiAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rxHiSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RX_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">));</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">cmdAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">cmdSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">COMMAND_RING_SIZE</span><span class="p">);</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">respAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">respSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RESPONSE_RING_SIZE</span><span class="p">);</span>

	<span class="n">shared_dma</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">+</span> <span class="n">shared_offset</span><span class="p">(</span><span class="n">zeroWord</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">zeroAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">shared_dma</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">txLo</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txHiRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">txHi</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxLoRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">rxLo</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxHiRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">rxHi</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxBuffRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">rxBuff</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmdRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">respRing</span><span class="p">.</span><span class="n">ringBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">.</span><span class="n">writeRegister</span> <span class="o">=</span> <span class="n">TYPHOON_REG_TX_LO_READY</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txHiRing</span><span class="p">.</span><span class="n">writeRegister</span> <span class="o">=</span> <span class="n">TYPHOON_REG_TX_HI_READY</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txlo_dma_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">txLoAddr</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">card_state</span> <span class="o">=</span> <span class="n">Sleeping</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">offload</span> <span class="o">=</span> <span class="n">TYPHOON_OFFLOAD_IP_CHKSUM</span> <span class="o">|</span> <span class="n">TYPHOON_OFFLOAD_TCP_CHKSUM</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">offload</span> <span class="o">|=</span> <span class="n">TYPHOON_OFFLOAD_UDP_CHKSUM</span> <span class="o">|</span> <span class="n">TSO_OFFLOAD_ON</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">offload</span> <span class="o">|=</span> <span class="n">TYPHOON_OFFLOAD_VLAN</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="cm">/* Force the writes to the shared memory area out before continuing. */</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_indexes</span><span class="p">));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txHiRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxLoRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxHiRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxBuffRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmdRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">respRing</span><span class="p">.</span><span class="n">lastWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">.</span><span class="n">lastRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txHiRing</span><span class="p">.</span><span class="n">lastRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">typhoon_fw</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">typhoon_file_header</span> <span class="o">*</span><span class="n">fHdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">typhoon_section_header</span> <span class="o">*</span><span class="n">sHdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">image_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">numSections</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">section_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">typhoon_fw</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">typhoon_fw</span><span class="p">,</span> <span class="n">FIRMWARE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">FIRMWARE_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">image_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">typhoon_fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">typhoon_fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_file_header</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">invalid_fw</span><span class="p">;</span>

	<span class="n">fHdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_file_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">image_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="s">&quot;TYPHOON&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">invalid_fw</span><span class="p">;</span>

	<span class="n">numSections</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">numSections</span><span class="p">);</span>
	<span class="n">image_data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_file_header</span><span class="p">);</span>
	<span class="n">remaining</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_file_header</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">numSections</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_section_header</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">invalid_fw</span><span class="p">;</span>

		<span class="n">sHdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_section_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">image_data</span><span class="p">;</span>
		<span class="n">image_data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_section_header</span><span class="p">);</span>
		<span class="n">section_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sHdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="n">section_len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid_fw</span><span class="p">;</span>

		<span class="n">image_data</span> <span class="o">+=</span> <span class="n">section_len</span><span class="p">;</span>
		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">section_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">invalid_fw:</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid firmware image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">typhoon_fw</span><span class="p">);</span>
	<span class="n">typhoon_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">typhoon_file_header</span> <span class="o">*</span><span class="n">fHdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">typhoon_section_header</span> <span class="o">*</span><span class="n">sHdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">image_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dpage</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dpage_dma</span><span class="p">;</span>
	<span class="n">__sum16</span> <span class="n">csum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqEnabled</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqMasked</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">numSections</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">section_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">load_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hmac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">image_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">typhoon_fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fHdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_file_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">image_data</span><span class="p">;</span>

	<span class="cm">/* Cannot just map the firmware image using pci_map_single() as</span>
<span class="cm">	 * the firmware is vmalloc()&#39;d and may not be physically contiguous,</span>
<span class="cm">	 * so we allocate some consistent memory to copy the sections into.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dpage</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpage_dma</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no DMA mem for firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irqEnabled</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">irqEnabled</span> <span class="o">|</span> <span class="n">TYPHOON_INTR_BOOTCMD</span><span class="p">,</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>
	<span class="n">irqMasked</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">irqMasked</span> <span class="o">|</span> <span class="n">TYPHOON_INTR_BOOTCMD</span><span class="p">,</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;card ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">numSections</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">numSections</span><span class="p">);</span>
	<span class="n">load_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">startAddr</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_BOOTCMD</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_DOWNLOAD_BOOT_ADDR</span><span class="p">);</span>
	<span class="n">hmac</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">hmacDigest</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">hmac</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_DOWNLOAD_HMAC_0</span><span class="p">);</span>
	<span class="n">hmac</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">hmacDigest</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">hmac</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_DOWNLOAD_HMAC_1</span><span class="p">);</span>
	<span class="n">hmac</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">hmacDigest</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">hmac</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_DOWNLOAD_HMAC_2</span><span class="p">);</span>
	<span class="n">hmac</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">hmacDigest</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">hmac</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_DOWNLOAD_HMAC_3</span><span class="p">);</span>
	<span class="n">hmac</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fHdr</span><span class="o">-&gt;</span><span class="n">hmacDigest</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">hmac</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_DOWNLOAD_HMAC_4</span><span class="p">);</span>
	<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_BOOTCMD_RUNTIME_IMAGE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_COMMAND</span><span class="p">);</span>

	<span class="n">image_data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_file_header</span><span class="p">);</span>

	<span class="cm">/* The ioread32() in typhoon_wait_interrupt() will force the</span>
<span class="cm">	 * last write to the command register to post, so</span>
<span class="cm">	 * we don&#39;t need a typhoon_post_pci_writes() after it.</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sHdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_section_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">image_data</span><span class="p">;</span>
		<span class="n">image_data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_section_header</span><span class="p">);</span>
		<span class="n">load_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sHdr</span><span class="o">-&gt;</span><span class="n">startAddr</span><span class="p">);</span>
		<span class="n">section_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sHdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">while</span><span class="p">(</span><span class="n">section_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">section_len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_interrupt</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">)</span> <span class="o">!=</span>
			   <span class="n">TYPHOON_STATUS_WAITING_FOR_SEGMENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;segment ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_out_irq</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Do an pseudo IPv4 checksum on the data -- first</span>
<span class="cm">			 * need to convert each u16 to cpu order before</span>
<span class="cm">			 * summing. Fortunately, due to the properties of</span>
<span class="cm">			 * the checksum, we can do this once, at the end.</span>
<span class="cm">			 */</span>
			<span class="n">csum</span> <span class="o">=</span> <span class="n">csum_fold</span><span class="p">(</span><span class="n">csum_partial_copy_nocheck</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span>
								   <span class="n">dpage</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
								   <span class="mi">0</span><span class="p">));</span>

			<span class="n">iowrite32</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_LENGTH</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">((</span><span class="n">__force</span> <span class="n">__le16</span><span class="p">)</span><span class="n">csum</span><span class="p">),</span>
					<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_CHECKSUM</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">load_addr</span><span class="p">,</span>
					<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_DEST_ADDR</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_DATA_HI</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">dpage_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_DATA_LO</span><span class="p">);</span>
			<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_BOOTCMD_SEG_AVAILABLE</span><span class="p">,</span>
					<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_COMMAND</span><span class="p">);</span>

			<span class="n">image_data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">load_addr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">section_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_interrupt</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">)</span> <span class="o">!=</span>
	   <span class="n">TYPHOON_STATUS_WAITING_FOR_SEGMENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;final segment ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_BOOTCMD_DNLD_COMPLETE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_COMMAND</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_BOOT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;boot ready timeout, status 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_irq:</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">irqMasked</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">irqEnabled</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">dpage</span><span class="p">,</span> <span class="n">dpage_dma</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_boot_3XP</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">initial_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">initial_status</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;boot ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_timeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_RECORD_ADDR_HI</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_BOOT_RECORD_ADDR_LO</span><span class="p">);</span>
	<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_BOOTCMD_REG_BOOT_RECORD</span><span class="p">,</span>
				<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_COMMAND</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_RUNNING</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;boot finish timeout (status 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_timeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the Transmit and Command ready registers</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_TX_HI_READY</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_CMD_READY</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_TX_LO_READY</span><span class="p">);</span>
	<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_BOOTCMD_BOOT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_COMMAND</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_timeout:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">typhoon_clean_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">transmit_ring</span> <span class="o">*</span><span class="n">txRing</span><span class="p">,</span>
			<span class="k">volatile</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lastRead</span> <span class="o">=</span> <span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastRead</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">skb_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">lastRead</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">lastRead</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TYPHOON_TYPE_MASK</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPHOON_TX_DESC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This tx_desc describes a packet.</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_addr</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPHOON_FRAG_DESC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This tx_desc describes a memory mapping. Free it.</span>
<span class="cm">			 */</span>
			<span class="n">skb_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb_dma</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">typhoon_inc_tx_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lastRead</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lastRead</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">transmit_ring</span> <span class="o">*</span><span class="n">txRing</span><span class="p">,</span>
			<span class="k">volatile</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lastRead</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numDesc</span> <span class="o">=</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* This will need changing if we start to use the Hi Tx ring. */</span>
	<span class="n">lastRead</span> <span class="o">=</span> <span class="n">typhoon_clean_tx</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">txRing</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">typhoon_num_free</span><span class="p">(</span><span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span>
				<span class="n">lastRead</span><span class="p">,</span> <span class="n">TXLO_ENTRIES</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">numDesc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">txRing</span><span class="o">-&gt;</span><span class="n">lastRead</span> <span class="o">=</span> <span class="n">lastRead</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_recycle_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxbuff_ent</span> <span class="o">*</span><span class="n">rxb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxbuffers</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">basic_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxBuffRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_free</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="n">RXFREE_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">==</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxBuffCleared</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no room in ring, just drop the skb</span>
<span class="cm">		 */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_free</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
	<span class="n">typhoon_inc_rxfree_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="cm">/* Tell the card about it */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxBuffReady</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_alloc_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxbuff_ent</span> <span class="o">*</span><span class="n">rxb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxbuffers</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">basic_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxBuffRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_free</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="n">RXFREE_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">==</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxBuffCleared</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Please, 3com, fix the firmware to allow DMA to a unaligned</span>
<span class="c">	 * address! Pretty please?</span>
<span class="c">	 */</span>
<span class="c">	skb_reserve(skb, 2);</span>
<span class="cp">#endif</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				  <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="cm">/* Since no card does 64 bit DAC, the high bits will never</span>
<span class="cm">	 * change from zero.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_free</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
	<span class="n">typhoon_inc_rxfree_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="cm">/* Tell the card about it */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxBuffReady</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">basic_ring</span> <span class="o">*</span><span class="n">rxRing</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">ready</span><span class="p">,</span>
	   <span class="k">volatile</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">cleared</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxbuff_ent</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local_ready</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">csum_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span><span class="p">;</span>

	<span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_ready</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ready</span><span class="p">);</span>
	<span class="n">rxaddr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">cleared</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">rxaddr</span> <span class="o">!=</span> <span class="n">local_ready</span> <span class="o">&amp;&amp;</span> <span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rxRing</span><span class="o">-&gt;</span><span class="n">ringBase</span> <span class="o">+</span> <span class="n">rxaddr</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxbuffers</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">typhoon_inc_rx_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TYPHOON_RX_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">typhoon_recycle_rx_skb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">frameLen</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">rx_copybreak</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
						    <span class="n">PKT_BUF_SZ</span><span class="p">,</span>
						    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
						       <span class="n">PKT_BUF_SZ</span><span class="p">,</span>
						       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">typhoon_recycle_rx_skb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">typhoon_alloc_rx_skb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">csum_bits</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">rxStatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TYPHOON_RX_IP_CHK_GOOD</span> <span class="o">|</span>
			<span class="n">TYPHOON_RX_UDP_CHK_GOOD</span> <span class="o">|</span> <span class="n">TYPHOON_RX_TCP_CHK_GOOD</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">csum_bits</span> <span class="o">==</span>
		   <span class="p">(</span><span class="n">TYPHOON_RX_IP_CHK_GOOD</span> <span class="o">|</span> <span class="n">TYPHOON_RX_TCP_CHK_GOOD</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">csum_bits</span> <span class="o">==</span>
		   <span class="p">(</span><span class="n">TYPHOON_RX_IP_CHK_GOOD</span> <span class="o">|</span> <span class="n">TYPHOON_RX_UDP_CHK_GOOD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">rxStatus</span> <span class="o">&amp;</span> <span class="n">TYPHOON_RX_VLAN</span><span class="p">)</span>
			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span>
					       <span class="n">ntohl</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">vlanTag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>

		<span class="n">received</span><span class="o">++</span><span class="p">;</span>
		<span class="n">budget</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cleared</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rxaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_fill_free_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RXENT_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rxbuff_ent</span> <span class="o">*</span><span class="n">rxb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxbuffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">typhoon_alloc_rx_skb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">typhoon</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">rmb</span><span class="p">();</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">awaiting_resp</span> <span class="o">&amp;&amp;</span> <span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respReady</span> <span class="o">!=</span> <span class="n">indexes</span><span class="o">-&gt;</span><span class="n">respCleared</span><span class="p">)</span>
			<span class="n">typhoon_process_response</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">.</span><span class="n">lastRead</span><span class="p">)</span>
		<span class="n">typhoon_tx_complete</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span><span class="p">);</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxHiCleared</span> <span class="o">!=</span> <span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxHiReady</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">typhoon_rx</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxHiRing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxHiReady</span><span class="p">,</span>
			   		<span class="o">&amp;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxHiCleared</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxLoCleared</span> <span class="o">!=</span> <span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxLoReady</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">typhoon_rx</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxLoRing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxLoReady</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxLoCleared</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">work_done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">rxBuffCleared</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxBuffRing</span><span class="p">.</span><span class="n">lastWrite</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rxBuff ring is empty, try to fill it. */</span>
		<span class="n">typhoon_fill_free_ring</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_NONE</span><span class="p">,</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
		<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">typhoon_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_status</span><span class="p">;</span>

	<span class="n">intr_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">TYPHOON_INTR_HOST_INT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">intr_status</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
		<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error, poll already scheduled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_free_rx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RXENT_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rxbuff_ent</span> <span class="o">*</span><span class="n">rxb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rxbuffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">pci_power_t</span> <span class="n">state</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_ENABLE_WAKE_EVENTS</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;typhoon_sleep(): wake events cmd err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_GOTO_SLEEP</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;typhoon_sleep(): sleep cmd err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_SLEEPING</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="cm">/* Since we cannot monitor the status of the link while sleeping,</span>
<span class="cm">	 * tell the world it went away.</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Post 2.x.x versions of the Sleep Image require a reset before</span>
<span class="cm">	 * we can download the Runtime Image. But let&#39;s not make users of</span>
<span class="cm">	 * the old firmware pay for the reset.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_BOOTCMD_WAKEUP</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_COMMAND</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">TYPHOON_WAKEUP_NEEDS_RESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">typhoon_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">wait_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_start_runtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">typhoon_init_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">typhoon_fill_free_ring</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_download_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot load runtime on 3XP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_boot_3XP</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_BOOT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot boot 3XP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_SET_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PKT_BUF_SZ</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_SET_MAC_ADDRESS</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="cm">/* Disable IRQ coalescing -- we can reenable it when 3Com gives</span>
<span class="cm">	 * us some more information on how to control it.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_IRQ_COALESCE_CTRL</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_XCVR_SELECT</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">xcvr_select</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_VLAN_TYPE_WRITE</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_SET_OFFLOAD_TASKS</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">offload</span><span class="p">;</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm3</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">offload</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">typhoon_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_TX_ENABLE</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_RX_ENABLE</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">card_state</span> <span class="o">=</span> <span class="n">Running</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ENABLE_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_NONE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">typhoon_post_pci_writes</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_out:</span>
	<span class="n">typhoon_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">WaitNoSleep</span><span class="p">);</span>
	<span class="n">typhoon_free_rx_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">typhoon_init_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_stop_runtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon_indexes</span> <span class="o">*</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">transmit_ring</span> <span class="o">*</span><span class="n">txLo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable interrupts early, since we can&#39;t schedule a poll</span>
<span class="cm">	 * when called with !netif_running(). This will be posted</span>
<span class="cm">	 * when we force the posting of the command.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_NONE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_RX_DISABLE</span><span class="p">);</span>
	<span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Wait 1/2 sec for any outstanding transmits to occur</span>
<span class="cm">	 * We&#39;ll cleanup after the reset if this times out.</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TYPHOON_WAIT_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span> <span class="o">==</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">txLo</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">TYPHOON_UDELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TYPHOON_WAIT_TIMEOUT</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;halt timed out waiting for Tx to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_TX_DISABLE</span><span class="p">);</span>
	<span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* save the statistics so when we bring the interface up again,</span>
<span class="cm">	 * the values reported to userspace are correct.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">card_state</span> <span class="o">=</span> <span class="n">Sleeping</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">typhoon_do_get_stats</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_saved</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">));</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_HALT</span><span class="p">);</span>
	<span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wait_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_HALTED</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timed out waiting for 3XP to halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">wait_type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to reset 3XP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cleanup any outstanding Tx packets */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">txLo</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">txLo</span><span class="o">-&gt;</span><span class="n">lastWrite</span><span class="p">);</span>
		<span class="n">typhoon_clean_tx</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">typhoon_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_reset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">WaitNoSleep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not reset in tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">truly_dead</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we ever start using the Hi ring, it will need cleaning too */</span>
	<span class="n">typhoon_clean_tx</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">txLoRing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indexes</span><span class="o">-&gt;</span><span class="n">txLoCleared</span><span class="p">);</span>
	<span class="n">typhoon_free_rx_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_start_runtime</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not start runtime in tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">truly_dead</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">truly_dead:</span>
	<span class="cm">/* Reset the hardware, and turn off carrier to avoid more timeouts */</span>
	<span class="n">typhoon_reset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NoWait</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_request_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_wakeup</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WaitSleep</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to wakeup device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">typhoon_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">typhoon_start_runtime</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out_sleep:</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_boot_3XP</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to reboot into sleep img</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">typhoon_reset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NoWait</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_sleep</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to go back to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_stop_runtime</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WaitSleep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to stop runtime</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Make sure there is no irq handler running on a different CPU. */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">typhoon_free_rx_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">typhoon_init_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_boot_3XP</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to boot sleep image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_sleep</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to put card to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re down, resume when we are upped.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_wakeup</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WaitNoSleep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;critical: could not wake up in resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_start_runtime</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;critical: could not start runtime in resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">reset:</span>
	<span class="n">typhoon_reset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NoWait</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">typhoon_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re down, we&#39;re already suspended.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* TYPHOON_OFFLOAD_VLAN is always on now, so this doesn&#39;t work */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span> <span class="o">&amp;</span> <span class="n">TYPHOON_WAKE_MAGIC_PKT</span><span class="p">)</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot do WAKE_MAGIC with VLAN offloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_stop_runtime</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WaitNoSleep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to stop runtime</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">need_resume</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">typhoon_free_rx_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">typhoon_init_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_boot_3XP</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to boot sleep image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">need_resume</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_SET_MAC_ADDRESS</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to set mac address in suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">need_resume</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_NO_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_SET_RX_FILTER</span><span class="p">);</span>
	<span class="n">xp_cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">TYPHOON_RX_FILTER_DIRECTED</span> <span class="o">|</span> <span class="n">TYPHOON_RX_FILTER_BROADCAST</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to set rx filter in suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">need_resume</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_sleep</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wol_events</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to put card to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">need_resume</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">need_resume:</span>
	<span class="n">typhoon_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">typhoon_test_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_STATUS</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Ok, see if we can change our interrupt status register by</span>
<span class="cm">	 * sending ourselves an interrupt. If so, then MMIO works.</span>
<span class="cm">	 * The 50usec delay is arbitrary -- it could probably be smaller.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TYPHOON_INTR_SELF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_SELF_INTERRUPT</span><span class="p">);</span>
		<span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TYPHOON_INTR_SELF</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_ALL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TYPHOON_INTR_NONE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_ENABLE</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TYPHOON_REG_INTR_STATUS</span><span class="p">);</span>

<span class="nl">out_unmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: falling back to port IO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">typhoon_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">typhoon_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">typhoon_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">typhoon_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">typhoon_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">typhoon_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">typhoon_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">typhoon_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">card_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">shared_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc</span> <span class="n">xp_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_desc</span> <span class="n">xp_resp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;unable to alloc new net device&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;unable to enable device&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;unable to set MWI&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;No usable DMA configuration&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_mwi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sanity checks on IO and MMIO BARs</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;region #1 not a PCI IO resource, aborting&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_mwi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Invalid PCI IO region size, aborting&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_mwi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;region #1 not a PCI MMIO resource, aborting&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_mwi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Invalid PCI MMIO region size, aborting&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_mwi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;could not request regions&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_mwi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* map our registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">use_mmio</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">use_mmio</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">use_mmio</span> <span class="o">=</span> <span class="n">typhoon_test_mmio</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">use_mmio</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;cannot remap registers, aborting&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate pci dma space for rx and tx descriptor rings</span>
<span class="cm">	 */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_shared</span><span class="p">),</span>
				      <span class="o">&amp;</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">shared</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;could not allocate DMA memory&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_remap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span> <span class="o">=</span> <span class="n">shared</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span> <span class="o">=</span> <span class="n">shared_dma</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_ioaddr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Init sequence:</span>
<span class="cm">	 * 1) Reset the adapter to clear any bad juju</span>
<span class="cm">	 * 2) Reload the sleep image</span>
<span class="cm">	 * 3) Boot the sleep image</span>
<span class="cm">	 * 4) Get the hardware address.</span>
<span class="cm">	 * 5) Put the card to sleep.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">typhoon_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">WaitSleep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;could not reset 3XP&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now that we&#39;ve reset the 3XP and are sure it&#39;s not going to</span>
<span class="cm">	 * write all over memory, enable bus mastering, and save our</span>
<span class="cm">	 * state for resuming after a suspend.</span>
<span class="cm">	 */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">typhoon_init_interface</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">typhoon_init_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_boot_3XP</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TYPHOON_STATUS_WAITING_FOR_HOST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;cannot boot 3XP sleep image&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_READ_MAC_ADDRESS</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xp_resp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;cannot read MAC address&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parm1</span><span class="p">));</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parm2</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Could not obtain valid ethernet address, aborting&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the Sleep Image version last, so the response is valid</span>
<span class="cm">	 * later when we print out the version reported.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_COMMAND_WITH_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="n">TYPHOON_CMD_READ_VERSIONS</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_issue_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">xp_resp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Could not get Sleep Image version&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">typhoon_card_info</span><span class="p">[</span><span class="n">card_id</span><span class="p">].</span><span class="n">capabilities</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">xcvr_select</span> <span class="o">=</span> <span class="n">TYPHOON_XCVR_AUTONEG</span><span class="p">;</span>

	<span class="cm">/* Typhoon 1.0 Sleep Images return one response descriptor to the</span>
<span class="cm">	 * READ_VERSIONS command. Those versions are OK after waking up</span>
<span class="cm">	 * from sleep without needing a reset. Typhoon 1.1+ Sleep Images</span>
<span class="cm">	 * seem to need a little extra help to get started. Since we don&#39;t</span>
<span class="cm">	 * know how to nudge it along, just kick it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">numDesc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">TYPHOON_WAKEUP_NEEDS_RESET</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">typhoon_sleep</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;cannot put adapter to sleep&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The chip-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">typhoon_netdev_ops</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">typhoon_poll</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">typhoon_ethtool_ops</span><span class="p">);</span>

	<span class="cm">/* We can handle scatter gather, up to 16 entries, and</span>
<span class="cm">	 * we can do IP checksumming (only version 4, doh...)</span>
<span class="cm">	 *</span>
<span class="cm">	 * There&#39;s no way to turn off the RX VLAN offloading and stripping</span>
<span class="cm">	 * on the current 3XP firmware -- it does not respect the offload</span>
<span class="cm">	 * settings -- so we only allow the user to toggle the TX processing.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;unable to register netdev&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s at %s 0x%llx, %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">typhoon_card_info</span><span class="p">[</span><span class="n">card_id</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">use_mmio</span> <span class="o">?</span> <span class="s">&quot;MMIO&quot;</span> <span class="o">:</span> <span class="s">&quot;IO&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">use_mmio</span><span class="p">),</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* xp_resp still contains the response to the READ_VERSIONS command.</span>
<span class="cm">	 * For debugging, let the user know what version he has.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">numDesc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the Typhoon 1.0 type Sleep Image, last 16 bits</span>
<span class="cm">		 * of version is Month/Day of build.</span>
<span class="cm">		 */</span>
		<span class="n">u16</span> <span class="n">monthday</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parm2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Typhoon 1.0 Sleep Image built %02u/%02u/2000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">monthday</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">monthday</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">numDesc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the Typhoon 1.1+ type Sleep Image</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">sleep_ver</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parm2</span><span class="p">);</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ver_string</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ver_string</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Typhoon 1.1+ Sleep Image version %02x.%03x.%03x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">sleep_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">sleep_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span>
			    <span class="n">sleep_ver</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="n">ver_string</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown Sleep Image version (%u:%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">numDesc</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">xp_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parm2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_out_reset:</span>
	<span class="n">typhoon_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NoWait</span><span class="p">);</span>

<span class="nl">error_out_dma:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_shared</span><span class="p">),</span>
			    <span class="n">shared</span><span class="p">,</span> <span class="n">shared_dma</span><span class="p">);</span>
<span class="nl">error_out_remap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">error_out_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">error_out_mwi:</span>
	<span class="n">pci_clear_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">error_out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">error_out_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">error_out:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">err_msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">typhoon_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">typhoon</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">typhoon_reset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NoWait</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">typhoon_shared</span><span class="p">),</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_clear_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">typhoon_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">typhoon_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">typhoon_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">typhoon_remove_one</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">typhoon_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">typhoon_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">typhoon_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">typhoon_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">typhoon_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">typhoon_fw</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">typhoon_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">typhoon_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">typhoon_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
