<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › 3com › 3c509.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>3c509.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* 3c509.c: A 3c509 EtherLink3 ethernet driver for linux. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1993-2000 by Donald Becker.</span>

<span class="cm">	Copyright 1994-2000 by Donald Becker.</span>
<span class="cm">	Copyright 1993 United States Government as represented by the</span>
<span class="cm">	Director, National Security Agency.	 This software may be used and</span>
<span class="cm">	distributed according to the terms of the GNU General Public License,</span>
<span class="cm">	incorporated herein by reference.</span>

<span class="cm">	This driver is for the 3Com EtherLinkIII series.</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>

<span class="cm">	Known limitations:</span>
<span class="cm">	Because of the way 3c509 ISA detection works it&#39;s difficult to predict</span>
<span class="cm">	a priori which of several ISA-mode cards will be detected first.</span>

<span class="cm">	This driver does not use predictive interrupt mode, resulting in higher</span>
<span class="cm">	packet latency but lower overhead.  If interrupts are disabled for an</span>
<span class="cm">	unusually long time it could also result in missed packets, but in</span>
<span class="cm">	practice this rarely happens.</span>


<span class="cm">	FIXES:</span>
<span class="cm">		Alan Cox:       Removed the &#39;Unexpected interrupt&#39; bug.</span>
<span class="cm">		Michael Meskes:	Upgraded to Donald Becker&#39;s version 1.07.</span>
<span class="cm">		Alan Cox:	Increased the eeprom delay. Regardless of</span>
<span class="cm">				what the docs say some people definitely</span>
<span class="cm">				get problems with lower (but in card spec)</span>
<span class="cm">				delays</span>
<span class="cm">		v1.10 4/21/97 Fixed module code so that multiple cards may be detected,</span>
<span class="cm">				other cleanups.  -djb</span>
<span class="cm">		Andrea Arcangeli:	Upgraded to Donald Becker&#39;s version 1.12.</span>
<span class="cm">		Rick Payne:	Fixed SMP race condition</span>
<span class="cm">		v1.13 9/8/97 Made &#39;max_interrupt_work&#39; an insmod-settable variable -djb</span>
<span class="cm">		v1.14 10/15/97 Avoided waiting..discard message for fast machines -djb</span>
<span class="cm">		v1.15 1/31/98 Faster recovery for Tx errors. -djb</span>
<span class="cm">		v1.16 2/3/98 Different ID port handling to avoid sound cards. -djb</span>
<span class="cm">		v1.18 12Mar2001 Andrew Morton</span>
<span class="cm">			- Avoid bogus detect of 3c590&#39;s (Andrzej Krzysztofowicz)</span>
<span class="cm">			- Reviewed against 1.18 from scyld.com</span>
<span class="cm">		v1.18a 17Nov2001 Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm">			- ethtool support</span>
<span class="cm">		v1.18b 1Mar2002 Zwane Mwaikambo &lt;zwane@commfireservices.com&gt;</span>
<span class="cm">			- Power Management support</span>
<span class="cm">		v1.18c 1Mar2002 David Ruggiero &lt;jdr@farfalle.com&gt;</span>
<span class="cm">			- Full duplex support</span>
<span class="cm">		v1.19  16Oct2002 Zwane Mwaikambo &lt;zwane@linuxpower.ca&gt;</span>
<span class="cm">			- Additional ethtool features</span>
<span class="cm">		v1.19a 28Oct2002 Davud Ruggiero &lt;jdr@farfalle.com&gt;</span>
<span class="cm">			- Increase *read_eeprom udelay to workaround oops with 2 cards.</span>
<span class="cm">		v1.19b 08Nov2002 Marc Zyngier &lt;maz@wild-wind.fr.eu.org&gt;</span>
<span class="cm">			- Introduce driver model for EISA cards.</span>
<span class="cm">		v1.20  04Feb2008 Ondrej Zary &lt;linux@rainbow-software.org&gt;</span>
<span class="cm">			- convert to isa_driver and pnp_driver and some cleanups</span>
<span class="cm">*/</span>

<span class="cp">#define DRV_NAME	&quot;3c509&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.20&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;04Feb2008&quot;</span>

<span class="cm">/* A few values that may be tweaked. */</span>

<span class="cm">/* Time in jiffies before concluding the transmitter is hung. */</span>
<span class="cp">#define TX_TIMEOUT  (400*HZ/1000)</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/isa.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for udelay() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/eisa.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="n">DRV_NAME</span> <span class="s">&quot;.c:&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot; becker@scyld.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#ifdef EL3_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_debug</span> <span class="o">=</span> <span class="n">EL3_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_debug</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* Used to do a global count of all the cards in the system.  Must be</span>
<span class="cm"> * a global variable so that the eisa probe routines can increment</span>
<span class="cm"> * it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_cards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define EL3_MAX_CARDS 8</span>

<span class="cm">/* To minimize the size of the driver source I only define operating</span>
<span class="cm">   constants if they are used several times.  You&#39;ll need the manual</span>
<span class="cm">   anyway if you want to understand driver details. */</span>
<span class="cm">/* Offsets from base I/O address. */</span>
<span class="cp">#define EL3_DATA 0x00</span>
<span class="cp">#define EL3_CMD 0x0e</span>
<span class="cp">#define EL3_STATUS 0x0e</span>
<span class="cp">#define	EEPROM_READ 0x80</span>

<span class="cp">#define EL3_IO_EXTENT	16</span>

<span class="cp">#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)</span>


<span class="cm">/* The top five bits written to EL3_CMD are a command, the lower</span>
<span class="cm">   11 bits are the parameter, if applicable. */</span>
<span class="k">enum</span> <span class="n">c509cmd</span> <span class="p">{</span>
	<span class="n">TotalReset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SelectWindow</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">StartCoax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">RxDisable</span> <span class="o">=</span> <span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">RxEnable</span> <span class="o">=</span> <span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">RxReset</span> <span class="o">=</span> <span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">RxDiscard</span> <span class="o">=</span> <span class="mi">8</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">TxEnable</span> <span class="o">=</span> <span class="mi">9</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">TxDisable</span> <span class="o">=</span> <span class="mi">10</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">TxReset</span> <span class="o">=</span> <span class="mi">11</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">FakeIntr</span> <span class="o">=</span> <span class="mi">12</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">AckIntr</span> <span class="o">=</span> <span class="mi">13</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetIntrEnb</span> <span class="o">=</span> <span class="mi">14</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">SetStatusEnb</span> <span class="o">=</span> <span class="mi">15</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetRxFilter</span> <span class="o">=</span> <span class="mi">16</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetRxThreshold</span> <span class="o">=</span> <span class="mi">17</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">SetTxThreshold</span> <span class="o">=</span> <span class="mi">18</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetTxStart</span> <span class="o">=</span> <span class="mi">19</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">StatsEnable</span> <span class="o">=</span> <span class="mi">21</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">StatsDisable</span> <span class="o">=</span> <span class="mi">22</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">StopCoax</span> <span class="o">=</span> <span class="mi">23</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">PowerUp</span> <span class="o">=</span> <span class="mi">27</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">PowerDown</span> <span class="o">=</span> <span class="mi">28</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">PowerAuto</span> <span class="o">=</span> <span class="mi">29</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">};</span>

<span class="k">enum</span> <span class="n">c509status</span> <span class="p">{</span>
	<span class="n">IntLatch</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">AdapterFailure</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">TxComplete</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">TxAvailable</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">RxComplete</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="n">RxEarly</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
	<span class="n">IntReq</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="n">StatsFull</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="n">CmdBusy</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="p">};</span>

<span class="cm">/* The SetRxFilter command accepts the following classes: */</span>
<span class="k">enum</span> <span class="n">RxFilter</span> <span class="p">{</span>
	<span class="n">RxStation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RxMulticast</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">RxBroadcast</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">RxProm</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">};</span>

<span class="cm">/* Register window 1 offsets, the window used in normal operation. */</span>
<span class="cp">#define TX_FIFO		0x00</span>
<span class="cp">#define RX_FIFO		0x00</span>
<span class="cp">#define RX_STATUS 	0x08</span>
<span class="cp">#define TX_STATUS 	0x0B</span>
<span class="cp">#define TX_FREE		0x0C		</span><span class="cm">/* Remaining free bytes in Tx buffer. */</span><span class="cp"></span>

<span class="cp">#define WN0_CONF_CTRL	0x04		</span><span class="cm">/* Window 0: Configuration control register */</span><span class="cp"></span>
<span class="cp">#define WN0_ADDR_CONF	0x06		</span><span class="cm">/* Window 0: Address configuration register */</span><span class="cp"></span>
<span class="cp">#define WN0_IRQ		0x08		</span><span class="cm">/* Window 0: Set IRQ line in bits 12-15. */</span><span class="cp"></span>
<span class="cp">#define WN4_MEDIA	0x0A		</span><span class="cm">/* Window 4: Various transcvr/media bits. */</span><span class="cp"></span>
<span class="cp">#define	MEDIA_TP	0x00C0		</span><span class="cm">/* Enable link beat and jabber for 10baseT. */</span><span class="cp"></span>
<span class="cp">#define WN4_NETDIAG	0x06		</span><span class="cm">/* Window 4: Net diagnostic */</span><span class="cp"></span>
<span class="cp">#define FD_ENABLE	0x8000		</span><span class="cm">/* Enable full-duplex (&quot;external loopback&quot;) */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Must be a power of two (we use a binary and in the</span>
<span class="cm"> * circular queue)</span>
<span class="cm"> */</span>
<span class="cp">#define SKB_QUEUE_SIZE	64</span>

<span class="k">enum</span> <span class="n">el3_cardtype</span> <span class="p">{</span> <span class="n">EL3_ISA</span><span class="p">,</span> <span class="n">EL3_PNP</span><span class="p">,</span> <span class="n">EL3_EISA</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">el3_private</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="cm">/* skb send-queue */</span>
	<span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">queue</span><span class="p">[</span><span class="n">SKB_QUEUE_SIZE</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">el3_cardtype</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">id_port</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">current_tag</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">el3_devs</span><span class="p">[</span><span class="n">EL3_MAX_CARDS</span><span class="p">];</span>

<span class="cm">/* Parameters that may be passed into the module. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="cm">/* Maximum events (Rx packets, etc.) to handle at each interrupt. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nopnp</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">el3_common_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el3_common_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">id_read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">el3_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">el3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">el3_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el3_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el3_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el3_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">,</span> <span class="n">pm_message_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define el3_suspend NULL</span>
<span class="cp">#define el3_resume NULL</span>
<span class="cp">#endif</span>


<span class="cm">/* generic device remove for all device types */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_device_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el3_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Return 0 on success, 1 on error, 2 when found already detected PnP card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_isa_id_sequence</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="n">phys_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">lrs_state</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* ISA boards are detected by sending the ID sequence to the</span>
<span class="cm">	   ID_PORT.  We find cards past the first by setting the &#39;current_tag&#39;</span>
<span class="cm">	   on cards as they are found.  Cards with their tag set will not</span>
<span class="cm">	   respond to subsequent ID sequences. */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">lrs_state</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
		<span class="n">lrs_state</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lrs_state</span> <span class="o">=</span> <span class="n">lrs_state</span> <span class="o">&amp;</span> <span class="mh">0x100</span> <span class="o">?</span> <span class="n">lrs_state</span> <span class="o">^</span> <span class="mh">0xcf</span> <span class="o">:</span> <span class="n">lrs_state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* For the first probe, clear all board&#39;s tag registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_tag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
	<span class="k">else</span>			<span class="cm">/* Otherwise kill off already-found boards. */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id_read_eeprom</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x6d50</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Read in EEPROM data, which does contention-select.</span>
<span class="cm">	   Only the lowest address board will stay &quot;on-line&quot;.</span>
<span class="cm">	   3Com got the byte order backwards. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">id_read_eeprom</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nopnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The ISA PnP 3c509 cards respond to the ID sequence too.</span>
<span class="cm">		   This check is needed in order not to register them twice. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">el3_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">el3_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EL3_PNP</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">el3_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				    <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;3c509 with address %02x %02x %02x %02x %02x %02x was found by ISAPnP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">phys_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
						<span class="n">phys_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
						<span class="n">phys_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="cm">/* Set the adaptor tag so that the next card can be found. */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xd0</span> <span class="o">+</span> <span class="o">++</span><span class="n">current_tag</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">el3_dev_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be16</span> <span class="o">*</span><span class="n">phys_addr</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">if_port</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">el3_cardtype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">if_port</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">el3_isa_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">isa_irq</span><span class="p">,</span> <span class="n">if_port</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">el3_isa_id_sequence</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">;</span>	<span class="cm">/* Skip to next card when PnP card found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">id_read_eeprom</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">if_port</span> <span class="o">=</span> <span class="n">iobase</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="mh">0x200</span> <span class="o">+</span> <span class="p">((</span><span class="n">iobase</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">el3_cards</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="p">[</span><span class="n">el3_cards</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">isa_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">el3_cards</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">isa_irq</span> <span class="o">=</span> <span class="n">id_read_eeprom</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">el3_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;3c509-isa&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the adaptor tag so that the next card can be found. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xd0</span> <span class="o">+</span> <span class="o">++</span><span class="n">current_tag</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>

	<span class="cm">/* Activate the adaptor at the EEPROM location. */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">ioaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>

	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x6d50</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free the interrupt so that some other card can use it. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0f00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_IRQ</span><span class="p">);</span>

	<span class="n">el3_dev_fill</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">isa_irq</span><span class="p">,</span> <span class="n">if_port</span><span class="p">,</span> <span class="n">EL3_ISA</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">el3_common_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">el3_devs</span><span class="p">[</span><span class="n">el3_cards</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">el3_isa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">el3_device_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_isa_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
			   <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">el3_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_isa_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">el3_isa_id_sequence</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">;</span>	<span class="cm">/* Skip to next card when PnP card found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Set the adaptor tag so that the next card can be found. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xd0</span> <span class="o">+</span> <span class="o">++</span><span class="n">current_tag</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
	<span class="cm">/* Enable the card */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">ioaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x6d50</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Free the interrupt so that some other card can use it. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0f00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_IRQ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">el3_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isa_driver</span> <span class="n">el3_isa_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">el3_isa_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">el3_isa_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">el3_isa_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">el3_isa_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;3c509&quot;</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isa_registered</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">el3_pnp_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;TCM5090&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III (TP) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;TCM5091&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;TCM5094&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III (combo) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;TCM5095&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III (TPO) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;TCM5098&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III (TPC) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;PNP80f7&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III compatible */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;PNP80f8&quot;</span> <span class="p">},</span> <span class="cm">/* 3Com Etherlink III compatible */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">el3_pnp_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">el3_pnp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">if_port</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;3c509-pnp&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="n">if_port</span> <span class="o">=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">el3_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">el3_dev_fill</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">if_port</span><span class="p">,</span> <span class="n">EL3_PNP</span><span class="p">);</span>
	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">el3_common_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">el3_devs</span><span class="p">[</span><span class="n">el3_cards</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">el3_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">el3_common_remove</span><span class="p">(</span><span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_pnp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">el3_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_pnp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">el3_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">el3_pnp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;3c509&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">el3_pnp_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">el3_pnp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">el3_pnp_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">el3_pnp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">el3_pnp_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pnp_registered</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_device_id</span> <span class="n">el3_eisa_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="s">&quot;TCM5090&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM5091&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM5092&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM5093&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM5094&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM5095&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM5098&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">eisa</span><span class="p">,</span> <span class="n">el3_eisa_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">el3_eisa_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_driver</span> <span class="n">el3_eisa_driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">el3_eisa_ids</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;3c579&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">el3_eisa_probe</span><span class="p">,</span>
				<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span> <span class="p">(</span><span class="n">el3_device_remove</span><span class="p">),</span>
				<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">el3_suspend</span><span class="p">,</span>
				<span class="p">.</span><span class="n">resume</span>  <span class="o">=</span> <span class="n">el3_resume</span><span class="p">,</span>
		<span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eisa_registered</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">el3_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	 	<span class="o">=</span> <span class="n">el3_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> 	<span class="o">=</span> <span class="n">el3_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> 		<span class="o">=</span> <span class="n">el3_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> 	<span class="o">=</span> <span class="n">el3_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">el3_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">el3_common_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">if_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;10baseT&quot;</span><span class="p">,</span> <span class="s">&quot;AUI&quot;</span><span class="p">,</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span> <span class="s">&quot;BNC&quot;</span><span class="p">};</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x05</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* xcvr codes 1/3/4/12 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* xcvr codes 0/8 */</span>
		<span class="cm">/* use eeprom value, but save user&#39;s full-duplex selection */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The EL3-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_ops</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register 3c5x9 at %#3.3lx, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: 3c5x9 found at %#3.3lx, %s port, address %pM, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">if_names</span><span class="p">[(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)],</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">el3_common_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">);</span>
	<span class="n">free_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">el3_eisa_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">if_port</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Yeepee, The driver framework is calling us ! */</span>
	<span class="n">edev</span> <span class="o">=</span> <span class="n">to_eisa_device</span> <span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">edev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;3c579-eisa&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Change the register set to the configuration window 0. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SelectWindow</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xC80</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_IRQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">if_port</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* Restore the &quot;Product ID&quot; to the EEPROM read register. */</span>
	<span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el3_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL3_IO_EXTENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">el3_dev_fill</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">if_port</span><span class="p">,</span> <span class="n">EL3_EISA</span><span class="p">);</span>
	<span class="n">eisa_set_drvdata</span> <span class="p">(</span><span class="n">edev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">el3_common_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eisa_set_drvdata</span> <span class="p">(</span><span class="n">edev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">el3_devs</span><span class="p">[</span><span class="n">el3_cards</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* This remove works for all device types.</span>
<span class="cm"> *</span>
<span class="cm"> * The net dev must be stored in the driver data field */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">el3_device_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">el3_common_remove</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read a word from the EEPROM using the regular EEPROM access register.</span>
<span class="cm">   Assume that we are in register window zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="nf">read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">EEPROM_READ</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* Pause for at least 162 us. for the read to take place.</span>
<span class="cm">	   Some chips seem to require much longer */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read a word from the EEPROM when in the ISA ID probe state. */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="nf">id_read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Issue read command, and pause for at least 162 us. for it to complete.</span>
<span class="cm">	   Assume extra-fast 16Mhz bus. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EEPROM_READ</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>

	<span class="cm">/* Pause for at least 162 us. for the read to take place. */</span>
	<span class="cm">/* Some chips seem to require much longer */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span><span class="o">--</span><span class="p">)</span>
		<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">id_port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  3c509 EEPROM word %d %#4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">word</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">RxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">el3_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Opening, IRQ %d	 status@%x %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>

	<span class="n">el3_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Opened 3c509  IRQ %d  status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">el3_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* Transmitter timeout, serious problems. */</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: transmit timed out, Tx_status %2.2x status %4.4x Tx FIFO room %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">),</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">),</span>
		   <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FREE</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="cm">/* Issue TX_RESET and TX_START commands. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">el3_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: el3_start_xmit(length = %u) called, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">#ifndef final_version</span>
<span class="c">	{	/* Error-checking code, delete someday. */</span>
<span class="c">		ushort status = inw(ioaddr + EL3_STATUS);</span>
<span class="c">		if (status &amp; 0x0001 &amp;&amp; 		/* IRQ line active, missed one. */</span>
<span class="c">		    inw(ioaddr + EL3_STATUS) &amp; 1) { 			/* Make sure. */</span>
<span class="c">			pr_debug(&quot;%s: Missed interrupt, status then %04x now %04x&quot;</span>
<span class="c">				   &quot;  Tx %2.2x Rx %4.4x.\n&quot;, dev-&gt;name, status,</span>
<span class="c">				   inw(ioaddr + EL3_STATUS), inb(ioaddr + TX_STATUS),</span>
<span class="c">				   inw(ioaddr + RX_STATUS));</span>
<span class="c">			/* Fake interrupt trigger by masking, acknowledge interrupts. */</span>
<span class="c">			outw(SetStatusEnb | 0x00, ioaddr + EL3_CMD);</span>
<span class="c">			outw(AckIntr | IntLatch | TxAvailable | RxEarly | IntReq,</span>
<span class="c">				 ioaddr + EL3_CMD);</span>
<span class="c">			outw(SetStatusEnb | 0xff, ioaddr + EL3_CMD);</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 *	We lock the driver against other processors. Note</span>
<span class="cm">	 *	we don&#39;t need to lock versus the IRQ as we suspended</span>
<span class="cm">	 *	that. This means that we lose the ability to take</span>
<span class="cm">	 *	an RX during a TX upload. That sucks a bit with SMP</span>
<span class="cm">	 *	on an original 3c509 (2K buffer)</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Using disable_irq stops us crapping on other</span>
<span class="cm">	 *	time sensitive devices.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Put out the doubleword header... */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">);</span>
	<span class="cm">/* ... and the packet rounded to a doubleword. */</span>
	<span class="n">outsl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FREE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Interrupt us when the FIFO has room for max-sized packet. */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">SetTxThreshold</span> <span class="o">+</span> <span class="mi">1536</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Clear the Tx status stack. */</span>
	<span class="p">{</span>
		<span class="kt">short</span> <span class="n">tx_status</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span>	<span class="o">&amp;&amp;</span>	<span class="p">(</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">);</span> <span class="cm">/* Pop the status stack. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The EL3 interrupt handler. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">el3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">IntLatch</span> <span class="o">|</span> <span class="n">RxComplete</span> <span class="o">|</span> <span class="n">StatsFull</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxComplete</span><span class="p">)</span>
			<span class="n">el3_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxAvailable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;	TX room bit was handled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* There&#39;s room in the FIFO for a full-sized packet. */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">TxAvailable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AdapterFailure</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">StatsFull</span> <span class="o">|</span> <span class="n">TxComplete</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Handle all uncommon interrupts. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">StatsFull</span><span class="p">)</span>				<span class="cm">/* Empty statistics. */</span>
				<span class="n">update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxEarly</span><span class="p">)</span> <span class="p">{</span>				<span class="cm">/* Rx early is unused. */</span>
				<span class="n">el3_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">RxEarly</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxComplete</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* Really Tx error. */</span>
				<span class="kt">short</span> <span class="n">tx_status</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
					<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">);</span> <span class="cm">/* Pop the status stack. */</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AdapterFailure</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Adapter failure requires Rx reset and reinit. */</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">RxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
				<span class="cm">/* Set the Rx filter to the current state. */</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxBroadcast</span>
					 <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">?</span> <span class="n">RxMulticast</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
					 <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span> <span class="o">?</span> <span class="n">RxProm</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
					 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Re-enable the receiver. */</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">AdapterFailure</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Infinite loop in interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* Clear all interrupts. */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Acknowledge the IRQ. */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntReq</span> <span class="o">|</span> <span class="n">IntLatch</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Ack IRQ */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: exiting interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling receive - used by netconsole and other diagnostic tools</span>
<span class="cm"> * to allow network i/o with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">el3_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">el3_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">el3_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	This is fast enough not to bother with disable IRQ</span>
<span class="cm">	 *	stuff.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Update statistics.  We change to register window 6, so this should be run</span>
<span class="cm">	single-threaded if the device is active. This is expected to be a rare</span>
<span class="cm">	operation, and it&#39;s simpler for the rest of the driver to assume that</span>
<span class="cm">	window 1 is always valid rather than use a special window-state variable.</span>
<span class="cm">	*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;   Updating the statistics.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Turn off statistics updates while reading. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="cm">/* Switch to the stats window, and read everything. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> 	<span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span>	<span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Multiple collisions. */</span>	   <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span>		<span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span>	<span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span>	<span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span>		<span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="cm">/* Rx packets	*/</span>		   <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="cm">/* Tx deferrals */</span>		   <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* Total Rx and Tx octets. */</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Back to window 1, and turn statistics back on. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rx_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;   In rx_packet(), status %4.4x, rx_status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EL3_STATUS</span><span class="p">),</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">RX_STATUS</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Error, update stats. */</span>
			<span class="kt">short</span> <span class="n">error</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x3800</span><span class="p">;</span>

			<span class="n">outw</span><span class="p">(</span><span class="n">RxDiscard</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x0000</span>:		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0800</span>:		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1000</span>:		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1800</span>:		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2000</span>:		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2800</span>:		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receiving packet size %d status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">pkt_len</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>     <span class="cm">/* Align IP on 16 byte */</span>

				<span class="cm">/* &#39;skb-&gt;data&#39; points to the start of sk_buff data area. */</span>
				<span class="n">insl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_FIFO</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">),</span>
					 <span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

				<span class="n">outw</span><span class="p">(</span><span class="n">RxDiscard</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Pop top Rx packet. */</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">RxDiscard</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Couldn&#39;t allocate a sk_buff of size %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">);</span> 				<span class="cm">/* Delay. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;	Waiting for 3c509 to discard packet, status %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *     Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">old</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">mc_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">old</span> <span class="o">=</span> <span class="n">mc_count</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Setting Rx mode to %d addresses.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mc_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxMulticast</span> <span class="o">|</span> <span class="n">RxBroadcast</span> <span class="o">|</span> <span class="n">RxProm</span><span class="p">,</span>
			 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxMulticast</span> <span class="o">|</span> <span class="n">RxBroadcast</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxBroadcast</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Shutting down ethercard.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">el3_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Switching back to window 0 disables the IRQ. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EL3_EISA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* But we explicitly zero the IRQ line select anyway. Don&#39;t do</span>
<span class="cm">		 * it on EISA cards, it prevents the module from getting an</span>
<span class="cm">		 * IRQ after unload+reload... */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0f00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_IRQ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_link_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_MEDIA</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_netdev_get_ecmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* obtain current transceiver via WN4_MEDIA? */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_ADDR_CONF</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_AUI</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_BNC</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_CONF_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">))</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_AUI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">))</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_BNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
				<span class="n">SUPPORTED_10baseT_Full</span><span class="p">;</span>	<span class="cm">/* hmm... */</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_NETDIAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">FD_ENABLE</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_netdev_set_ecmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">!=</span> <span class="n">XCVR_INTERNAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">!=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* change XCVR type */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_ADDR_CONF</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_TP</span>:
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_AUI</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_BNC</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_ADDR_CONF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fire up the DC-DC convertor if BNC gets enabled */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_ADDR_CONF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">StartCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">800</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_NETDIAG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">FD_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FD_ENABLE</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_NETDIAG</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">el3_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">el3_netdev_get_ecmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">el3_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">el3_netdev_set_ecmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">el3_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">el3_link_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">el3_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">el3_debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">el3_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">el3_debug</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">el3_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">el3_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">el3_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">el3_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">el3_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">el3_set_msglevel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">el3_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Turn off statistics ASAP.  We update lp-&gt;stats below. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="cm">/* Disable the receiver and transmitter. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">RxDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="cm">/* Turn off thinnet power.  Green! */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">StopCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable link beat and jabber, if_port may change here next open(). */</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_MEDIA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MEDIA_TP</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_MEDIA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">el3_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sw_info</span><span class="p">,</span> <span class="n">net_diag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* Activating the board required and does no harm otherwise */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Set the IRQ line. */</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN0_IRQ</span><span class="p">);</span>

	<span class="cm">/* Set the station address in window 2 each time opened. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* BNC interface */</span>
		<span class="cm">/* Start the thinnet transceiver. We should really wait 50ms...*/</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">StartCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 10baseT interface */</span>
		<span class="cm">/* Combine secondary sw_info word (the adapter level) and primary</span>
<span class="cm">			sw_info word (duplex setting plus other useless bits) */</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">sw_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x400f</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBff0</span><span class="p">);</span>

		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">net_diag</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_NETDIAG</span><span class="p">);</span>
		<span class="n">net_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_diag</span> <span class="o">|</span> <span class="n">FD_ENABLE</span><span class="p">);</span> <span class="cm">/* temporarily assume full-duplex will be set */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="cm">/* force full-duplex mode if 3c5x9b */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sw_info</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Forcing 3c5x9b full-duplex mode&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="cm">/* set full-duplex mode based on eeprom config setting */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sw_info</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sw_info</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Setting 3c5x9b full-duplex mode (from EEPROM configuration bit)&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="nl">default:</span>
				<span class="cm">/* xcvr=(0 || 4) OR user has an old 3c5x9 non &quot;B&quot; model */</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Setting 3c5x9/3c5x9B half-duplex mode&quot;</span><span class="p">);</span>
				<span class="n">net_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_diag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FD_ENABLE</span><span class="p">);</span> <span class="cm">/* disable full duplex */</span>
		<span class="p">}</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">net_diag</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_NETDIAG</span><span class="p">);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; if_port: %d, sw_info: %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">,</span> <span class="n">sw_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">el3_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: 3c5x9 net diag word is now: %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">net_diag</span><span class="p">);</span>
		<span class="cm">/* Enable link beat and jabber check. */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_MEDIA</span><span class="p">)</span> <span class="o">|</span> <span class="n">MEDIA_TP</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WN4_MEDIA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Switch to the stats window, and clear all stats by reading. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Switch to register set 1 for normal use. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Accept b-case and phys addr only. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxBroadcast</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Turn on statistics. */</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Enable the receiver. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Enable transmitter. */</span>
	<span class="cm">/* Allow status bits to be seen. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="cm">/* Ack all pending events, and set active indicator mask. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntLatch</span> <span class="o">|</span> <span class="n">TxAvailable</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">IntReq</span><span class="p">,</span>
		 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="n">IntLatch</span><span class="o">|</span><span class="n">TxAvailable</span><span class="o">|</span><span class="n">TxComplete</span><span class="o">|</span><span class="n">RxComplete</span><span class="o">|</span><span class="n">StatsFull</span><span class="p">,</span>
		 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Power Management support functions */</span>
<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">el3_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">PowerDown</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">el3_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el3_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">PowerUp</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">el3_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug level (0-6)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ number(s) (assigned)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;maximum events handled per interrupt&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nopnp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nopnp</span><span class="p">,</span> <span class="s">&quot;disable ISA PnP support (0-1)&quot;</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;3Com Etherlink III (3c509, 3c509B, 3c529, 3c579) ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">el3_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">el3_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nopnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el3_pnp_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pnp_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Select an open I/O location at 0x1*0 to do ISA contention select. */</span>
	<span class="cm">/* Start with 0x110 to avoid some sound cards.*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id_port</span> <span class="o">=</span> <span class="mh">0x110</span> <span class="p">;</span> <span class="n">id_port</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">;</span> <span class="n">id_port</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">id_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;3c509-control&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">id_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">id_port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">id_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id_port</span> <span class="o">&gt;=</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No I/O port available for 3c509 activation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">isa_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el3_isa_driver</span><span class="p">,</span> <span class="n">EL3_MAX_CARDS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">isa_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">eisa_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el3_eisa_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">eisa_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_registered</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isa_registered</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eisa_registered</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">el3_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_registered</span><span class="p">)</span>
		<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el3_pnp_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isa_registered</span><span class="p">)</span>
		<span class="n">isa_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el3_isa_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id_port</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">id_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eisa_registered</span><span class="p">)</span>
		<span class="n">eisa_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el3_eisa_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span> <span class="p">(</span><span class="n">el3_init_module</span><span class="p">);</span>
<span class="n">module_exit</span> <span class="p">(</span><span class="n">el3_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
