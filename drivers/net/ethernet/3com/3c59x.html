<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › 3com › 3c59x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>3c59x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* EtherLinkXL.c: A 3Com EtherLink PCI III/XL ethernet driver for linux. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1996-1999 by Donald Becker.</span>

<span class="cm">	This software may be used and distributed according to the terms</span>
<span class="cm">	of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">	This driver is for the 3Com &quot;Vortex&quot; and &quot;Boomerang&quot; series ethercards.</span>
<span class="cm">	Members of the series include Fast EtherLink 3c590/3c592/3c595/3c597</span>
<span class="cm">	and the EtherLink XL 3c900 and 3c905 cards.</span>

<span class="cm">	Problem reports and questions should be directed to</span>
<span class="cm">	vortex@scyld.com</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: This driver _could_ support MTU changing, but doesn&#39;t.  See Don&#39;s hamachi.c implementation</span>
<span class="cm"> * as well as other drivers</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: If you make &#39;vortex_debug&#39; a constant (#define vortex_debug 0) the driver shrinks by 2k</span>
<span class="cm"> * due to dead code elimination.  There will be some performance benefits from this due to</span>
<span class="cm"> * elimination of all the tests and reduced cache footprint.</span>
<span class="cm"> */</span>


<span class="cp">#define DRV_NAME	&quot;3c59x&quot;</span>



<span class="cm">/* A few values that may be tweaked. */</span>
<span class="cm">/* Keep the ring sizes a power of two for efficiency. */</span>
<span class="cp">#define TX_RING_SIZE	16</span>
<span class="cp">#define RX_RING_SIZE	32</span>
<span class="cp">#define PKT_BUF_SZ		1536			</span><span class="cm">/* Size of each temporary Rx buffer.*/</span><span class="cp"></span>

<span class="cm">/* &quot;Knobs&quot; that adjust features and parameters. */</span>
<span class="cm">/* Set the copy breakpoint for the copy-only-tiny-frames scheme.</span>
<span class="cm">   Setting to &gt; 1512 effectively disables this feature. */</span>
<span class="cp">#ifndef __arm__</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cm">/* ARM systems perform better by disregarding the bus-master</span>
<span class="cm">   transfer capability of these cards. -- rmk */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">1513</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cm">/* Allow setting MTU to a larger size, bypassing the normal ethernet setup. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
<span class="cm">/* Maximum events (Rx packets, etc.) to handle at each interrupt. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="cm">/* Tx timeout interval (millisecs) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

<span class="cm">/* Allow aggregation of Tx interrupts.  Saves CPU load at the cost</span>
<span class="cm"> * of possible Tx stalls if the system is blocking interrupts</span>
<span class="cm"> * somewhere else.  Undefine this to disable.</span>
<span class="cm"> */</span>
<span class="cp">#define tx_interrupt_mitigation 1</span>

<span class="cm">/* Put out somewhat more debugging messages. (0: no msg, 1 minimal .. 6). */</span>
<span class="cp">#define vortex_debug debug</span>
<span class="cp">#ifdef VORTEX_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_debug</span> <span class="o">=</span> <span class="n">VORTEX_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/eisa.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;			</span><span class="cm">/* For nr_irqs only. */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* Kernel compatibility defines, some common to David Hinds&#39; PCMCIA package.</span>
<span class="cm">   This is only in the support-all-kernels source code. */</span>

<span class="cp">#define RUN_AT(x) (jiffies + (x))</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span>
	<span class="n">DRV_NAME</span> <span class="s">&quot;: Donald Becker and others.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;3Com 3c59x/3c9xx ethernet driver &quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/* Operational parameter that usually are not changed. */</span>

<span class="cm">/* The Vortex size is twice that of the original EtherLinkIII series: the</span>
<span class="cm">   runtime register window, window 1, is now always mapped in.</span>
<span class="cm">   The Boomerang size is twice as large as the Vortex -- it has additional</span>
<span class="cm">   bus master control registers. */</span>
<span class="cp">#define VORTEX_TOTAL_SIZE 0x20</span>
<span class="cp">#define BOOMERANG_TOTAL_SIZE 0x40</span>

<span class="cm">/* Set iff a MII transceiver on any interface requires mdio preamble.</span>
<span class="cm">   This only set with the original DP83840 on older 3c905 boards, so the extra</span>
<span class="cm">   code size of a per-interface flag is not worthwhile. */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">mii_preamble_required</span><span class="p">;</span>

<span class="cp">#define PFX DRV_NAME &quot;: &quot;</span>



<span class="cm">/*</span>
<span class="cm">				Theory of Operation</span>

<span class="cm">I. Board Compatibility</span>

<span class="cm">This device driver is designed for the 3Com FastEtherLink and FastEtherLink</span>
<span class="cm">XL, 3Com&#39;s PCI to 10/100baseT adapters.  It also works with the 10Mbs</span>
<span class="cm">versions of the FastEtherLink cards.  The supported product IDs are</span>
<span class="cm">  3c590, 3c592, 3c595, 3c597, 3c900, 3c905</span>

<span class="cm">The related ISA 3c515 is supported with a separate driver, 3c515.c, included</span>
<span class="cm">with the kernel source or available from</span>
<span class="cm">    cesdis.gsfc.nasa.gov:/pub/linux/drivers/3c515.html</span>

<span class="cm">II. Board-specific settings</span>

<span class="cm">PCI bus devices are configured by the system at boot time, so no jumpers</span>
<span class="cm">need to be set on the board.  The system BIOS should be set to assign the</span>
<span class="cm">PCI INTA signal to an otherwise unused system IRQ line.</span>

<span class="cm">The EEPROM settings for media type and forced-full-duplex are observed.</span>
<span class="cm">The EEPROM media type should be left at the default &quot;autoselect&quot; unless using</span>
<span class="cm">10base2 or AUI connections which cannot be reliably detected.</span>

<span class="cm">III. Driver operation</span>

<span class="cm">The 3c59x series use an interface that&#39;s very similar to the previous 3c5x9</span>
<span class="cm">series.  The primary interface is two programmed-I/O FIFOs, with an</span>
<span class="cm">alternate single-contiguous-region bus-master transfer (see next).</span>

<span class="cm">The 3c900 &quot;Boomerang&quot; series uses a full-bus-master interface with separate</span>
<span class="cm">lists of transmit and receive descriptors, similar to the AMD LANCE/PCnet,</span>
<span class="cm">DEC Tulip and Intel Speedo3.  The first chip version retains a compatible</span>
<span class="cm">programmed-I/O interface that has been removed in &#39;B&#39; and subsequent board</span>
<span class="cm">revisions.</span>

<span class="cm">One extension that is advertised in a very large font is that the adapters</span>
<span class="cm">are capable of being bus masters.  On the Vortex chip this capability was</span>
<span class="cm">only for a single contiguous region making it far less useful than the full</span>
<span class="cm">bus master capability.  There is a significant performance impact of taking</span>
<span class="cm">an extra interrupt or polling for the completion of each transfer, as well</span>
<span class="cm">as difficulty sharing the single transfer engine between the transmit and</span>
<span class="cm">receive threads.  Using DMA transfers is a win only with large blocks or</span>
<span class="cm">with the flawed versions of the Intel Orion motherboard PCI controller.</span>

<span class="cm">The Boomerang chip&#39;s full-bus-master interface is useful, and has the</span>
<span class="cm">currently-unused advantages over other similar chips that queued transmit</span>
<span class="cm">packets may be reordered and receive buffer groups are associated with a</span>
<span class="cm">single frame.</span>

<span class="cm">With full-bus-master support, this driver uses a &quot;RX_COPYBREAK&quot; scheme.</span>
<span class="cm">Rather than a fixed intermediate receive buffer, this scheme allocates</span>
<span class="cm">full-sized skbuffs as receive buffers.  The value RX_COPYBREAK is used as</span>
<span class="cm">the copying breakpoint: it is chosen to trade-off the memory wasted by</span>
<span class="cm">passing the full-sized skbuff to the queue layer for all frames vs. the</span>
<span class="cm">copying cost of copying a frame to a correctly-sized skbuff.</span>

<span class="cm">IIIC. Synchronization</span>
<span class="cm">The driver runs as two independent, single-threaded flows of control.  One</span>
<span class="cm">is the send-packet routine, which enforces single-threaded use by the</span>
<span class="cm">dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single</span>
<span class="cm">threaded by the hardware and other software.</span>

<span class="cm">IV. Notes</span>

<span class="cm">Thanks to Cameron Spitzer and Terry Murphy of 3Com for providing development</span>
<span class="cm">3c590, 3c595, and 3c900 boards.</span>
<span class="cm">The name &quot;Vortex&quot; is the internal 3Com project name for the PCI ASIC, and</span>
<span class="cm">the EISA version is called &quot;Demon&quot;.  According to Terry these names come</span>
<span class="cm">from rides at the local amusement park.</span>

<span class="cm">The new chips support both ethernet (1.5K) and FDDI (4.5K) packet sizes!</span>
<span class="cm">This driver only supports ethernet packets because of the skbuff allocation</span>
<span class="cm">limit of 4K.</span>
<span class="cm">*/</span>

<span class="cm">/* This table drives the PCI probe routines.  It&#39;s mostly boilerplate in all</span>
<span class="cm">   of the drivers, and will likely be provided by some future kernel.</span>
<span class="cm">*/</span>
<span class="k">enum</span> <span class="n">pci_flags_bit</span> <span class="p">{</span>
	<span class="n">PCI_USES_MASTER</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="n">IS_VORTEX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
	<span class="n">EEPROM_8BIT</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* AKPM: Uses 0x230 as the base bitmaps for EEPROM reads */</span>
	<span class="n">HAS_PWR_CTRL</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">HAS_MII</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">HAS_NWAY</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">HAS_CB_FNS</span><span class="o">=</span><span class="mh">0x100</span><span class="p">,</span>
	<span class="n">INVERT_MII_PWR</span><span class="o">=</span><span class="mh">0x200</span><span class="p">,</span> <span class="n">INVERT_LED_PWR</span><span class="o">=</span><span class="mh">0x400</span><span class="p">,</span> <span class="n">MAX_COLLISION_RESET</span><span class="o">=</span><span class="mh">0x800</span><span class="p">,</span>
	<span class="n">EEPROM_OFFSET</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">HAS_HWCKSM</span><span class="o">=</span><span class="mh">0x2000</span><span class="p">,</span> <span class="n">WNO_XCVR_PWR</span><span class="o">=</span><span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">EXTRA_PREAMBLE</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">EEPROM_RESET</span><span class="o">=</span><span class="mh">0x10000</span><span class="p">,</span> <span class="p">};</span>

<span class="k">enum</span> <span class="n">vortex_chips</span> <span class="p">{</span>
	<span class="n">CH_3C590</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CH_3C592</span><span class="p">,</span>
	<span class="n">CH_3C597</span><span class="p">,</span>
	<span class="n">CH_3C595_1</span><span class="p">,</span>
	<span class="n">CH_3C595_2</span><span class="p">,</span>

	<span class="n">CH_3C595_3</span><span class="p">,</span>
	<span class="n">CH_3C900_1</span><span class="p">,</span>
	<span class="n">CH_3C900_2</span><span class="p">,</span>
	<span class="n">CH_3C900_3</span><span class="p">,</span>
	<span class="n">CH_3C900_4</span><span class="p">,</span>

	<span class="n">CH_3C900_5</span><span class="p">,</span>
	<span class="n">CH_3C900B_FL</span><span class="p">,</span>
	<span class="n">CH_3C905_1</span><span class="p">,</span>
	<span class="n">CH_3C905_2</span><span class="p">,</span>
	<span class="n">CH_3C905B_TX</span><span class="p">,</span>
	<span class="n">CH_3C905B_1</span><span class="p">,</span>

	<span class="n">CH_3C905B_2</span><span class="p">,</span>
	<span class="n">CH_3C905B_FX</span><span class="p">,</span>
	<span class="n">CH_3C905C</span><span class="p">,</span>
	<span class="n">CH_3C9202</span><span class="p">,</span>
	<span class="n">CH_3C980</span><span class="p">,</span>
	<span class="n">CH_3C9805</span><span class="p">,</span>

	<span class="n">CH_3CSOHO100_TX</span><span class="p">,</span>
	<span class="n">CH_3C555</span><span class="p">,</span>
	<span class="n">CH_3C556</span><span class="p">,</span>
	<span class="n">CH_3C556B</span><span class="p">,</span>
	<span class="n">CH_3C575</span><span class="p">,</span>

	<span class="n">CH_3C575_1</span><span class="p">,</span>
	<span class="n">CH_3CCFE575</span><span class="p">,</span>
	<span class="n">CH_3CCFE575CT</span><span class="p">,</span>
	<span class="n">CH_3CCFE656</span><span class="p">,</span>
	<span class="n">CH_3CCFEM656</span><span class="p">,</span>

	<span class="n">CH_3CCFEM656_1</span><span class="p">,</span>
	<span class="n">CH_3C450</span><span class="p">,</span>
	<span class="n">CH_3C920</span><span class="p">,</span>
	<span class="n">CH_3C982A</span><span class="p">,</span>
	<span class="n">CH_3C982B</span><span class="p">,</span>

	<span class="n">CH_905BT4</span><span class="p">,</span>
	<span class="n">CH_920B_EMB_WNM</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* note: this array directly indexed by above enums, and MUST</span>
<span class="cm"> * be kept in sync with both the enums above, and the PCI device</span>
<span class="cm"> * table below</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vortex_chip_info</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drv_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">io_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">vortex_info_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;3c590 Vortex 10Mbps&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_VORTEX</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c592 EISA 10Mbps Demon/Vortex&quot;</span><span class="p">,</span>					<span class="cm">/* AKPM: from Don&#39;s 3c59x_cb.c 0.49H */</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_VORTEX</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c597 EISA Fast Demon/Vortex&quot;</span><span class="p">,</span>					<span class="cm">/* AKPM: from Don&#39;s 3c59x_cb.c 0.49H */</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_VORTEX</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c595 Vortex 100baseTx&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_VORTEX</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c595 Vortex 100baseT4&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_VORTEX</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3c595 Vortex 100base-MII&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_VORTEX</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c900 Boomerang 10baseT&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">|</span><span class="n">EEPROM_RESET</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c900 Boomerang 10Mbps Combo&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">|</span><span class="n">EEPROM_RESET</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c900 Cyclone 10Mbps TPO&quot;</span><span class="p">,</span>						<span class="cm">/* AKPM: from Don&#39;s 0.99M */</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c900 Cyclone 10Mbps Combo&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3c900 Cyclone 10Mbps TPC&quot;</span><span class="p">,</span>						<span class="cm">/* AKPM: from Don&#39;s 0.99M */</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c900B-FL Cyclone 10base-FL&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c905 Boomerang 100baseTx&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">|</span><span class="n">HAS_MII</span><span class="o">|</span><span class="n">EEPROM_RESET</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c905 Boomerang 100baseT4&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">|</span><span class="n">HAS_MII</span><span class="o">|</span><span class="n">EEPROM_RESET</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3C905B-TX Fast Etherlink XL PCI&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">EXTRA_PREAMBLE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c905B Cyclone 100baseTx&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">EXTRA_PREAMBLE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3c905B Cyclone 10/100/BNC&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c905B-FX Cyclone 100baseFx&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c905C Tornado&quot;</span><span class="p">,</span>
	<span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">EXTRA_PREAMBLE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c920B-EMB-WNM (ATI Radeon 9100 IGP)&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_MII</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c980 Cyclone&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">EXTRA_PREAMBLE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3c980C Python-T&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3cSOHO100-TX Hurricane&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">EXTRA_PREAMBLE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c555 Laptop Hurricane&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c556 Laptop Tornado&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">INVERT_MII_PWR</span><span class="o">|</span>
									<span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c556B Laptop Hurricane&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">EEPROM_OFFSET</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">INVERT_MII_PWR</span><span class="o">|</span>
	                                <span class="n">WNO_XCVR_PWR</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3c575 [Megahertz] 10/100 LAN 	CardBus&quot;</span><span class="p">,</span>
	<span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">|</span><span class="n">HAS_MII</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c575 Boomerang CardBus&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_BOOMERANG</span><span class="o">|</span><span class="n">HAS_MII</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3CCFE575BT Cyclone CardBus&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span>
									<span class="n">INVERT_LED_PWR</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3CCFE575CT Tornado CardBus&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span><span class="n">INVERT_MII_PWR</span><span class="o">|</span>
									<span class="n">MAX_COLLISION_RESET</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3CCFE656 Cyclone CardBus&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span><span class="n">INVERT_MII_PWR</span><span class="o">|</span>
									<span class="n">INVERT_LED_PWR</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3CCFEM656B Cyclone+Winmodem CardBus&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span><span class="n">INVERT_MII_PWR</span><span class="o">|</span>
									<span class="n">INVERT_LED_PWR</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3CXFEM656C Tornado+Winmodem CardBus&quot;</span><span class="p">,</span>			<span class="cm">/* From pcmcia-cs-3.1.5 */</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_CB_FNS</span><span class="o">|</span><span class="n">EEPROM_8BIT</span><span class="o">|</span><span class="n">INVERT_MII_PWR</span><span class="o">|</span>
									<span class="n">MAX_COLLISION_RESET</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c450 HomePNA Tornado&quot;</span><span class="p">,</span>						<span class="cm">/* AKPM: from Don&#39;s 0.99Q */</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c920 Tornado&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c982 Hydra Dual Port A&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;3c982 Hydra Dual Port B&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c905B-T4&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_CYCLONE</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="o">|</span><span class="n">EXTRA_PREAMBLE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;3c920B-EMB-WNM Tornado&quot;</span><span class="p">,</span>
	 <span class="n">PCI_USES_MASTER</span><span class="p">,</span> <span class="n">IS_TORNADO</span><span class="o">|</span><span class="n">HAS_NWAY</span><span class="o">|</span><span class="n">HAS_HWCKSM</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="p">},</span>

	<span class="p">{</span><span class="nb">NULL</span><span class="p">,},</span> <span class="cm">/* NULL terminated list. */</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">vortex_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5900</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C590</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5920</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C592</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5970</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C597</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5950</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C595_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5951</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C595_2</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5952</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C595_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C900_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C900_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9004</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C900_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C900_4</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9006</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C900_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x900A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C900B_FL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9050</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9051</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9054</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905B_TX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9055</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905B_1</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9058</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905B_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x905A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905B_FX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9200</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C905C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9202</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C9202</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9800</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C980</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9805</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C9805</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x7646</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3CSOHO100_TX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5055</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C555</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x6055</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C556</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x6056</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C556B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5b57</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C575</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5057</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C575_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5157</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3CCFE575</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x5257</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3CCFE575CT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x6560</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3CCFE656</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x6562</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3CCFEM656</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x6564</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3CCFEM656_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x4500</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C450</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9201</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C920</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x1201</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C982A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x1202</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_3C982B</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_905BT4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10B7</span><span class="p">,</span> <span class="mh">0x9210</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CH_920B_EMB_WNM</span> <span class="p">},</span>

	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>						<span class="cm">/* 0 terminated list. */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">vortex_pci_tbl</span><span class="p">);</span>


<span class="cm">/* Operational definitions.</span>
<span class="cm">   These are not used by other compilation units and thus are not</span>
<span class="cm">   exported in a &quot;.h&quot; file.</span>

<span class="cm">   First the windows.  There are eight register windows, with the command</span>
<span class="cm">   and status registers available in each.</span>
<span class="cm">   */</span>
<span class="cp">#define EL3_CMD 0x0e</span>
<span class="cp">#define EL3_STATUS 0x0e</span>

<span class="cm">/* The top five bits written to EL3_CMD are a command, the lower</span>
<span class="cm">   11 bits are the parameter, if applicable.</span>
<span class="cm">   Note that 11 parameters bits was fine for ethernet, but the new chip</span>
<span class="cm">   can handle FDDI length frames (~4500 octets) and now parameters count</span>
<span class="cm">   32-bit &#39;Dwords&#39; rather than octets. */</span>

<span class="k">enum</span> <span class="n">vortex_cmd</span> <span class="p">{</span>
	<span class="n">TotalReset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SelectWindow</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">StartCoax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">RxDisable</span> <span class="o">=</span> <span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">RxEnable</span> <span class="o">=</span> <span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">RxReset</span> <span class="o">=</span> <span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">UpStall</span> <span class="o">=</span> <span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">UpUnstall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">DownStall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DownUnstall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
	<span class="n">RxDiscard</span> <span class="o">=</span> <span class="mi">8</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">TxEnable</span> <span class="o">=</span> <span class="mi">9</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">TxDisable</span> <span class="o">=</span> <span class="mi">10</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">TxReset</span> <span class="o">=</span> <span class="mi">11</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">FakeIntr</span> <span class="o">=</span> <span class="mi">12</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">AckIntr</span> <span class="o">=</span> <span class="mi">13</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetIntrEnb</span> <span class="o">=</span> <span class="mi">14</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">SetStatusEnb</span> <span class="o">=</span> <span class="mi">15</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetRxFilter</span> <span class="o">=</span> <span class="mi">16</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetRxThreshold</span> <span class="o">=</span> <span class="mi">17</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">SetTxThreshold</span> <span class="o">=</span> <span class="mi">18</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetTxStart</span> <span class="o">=</span> <span class="mi">19</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">StartDMAUp</span> <span class="o">=</span> <span class="mi">20</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">StartDMADown</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">StatsEnable</span> <span class="o">=</span> <span class="mi">21</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
	<span class="n">StatsDisable</span> <span class="o">=</span> <span class="mi">22</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">StopCoax</span> <span class="o">=</span> <span class="mi">23</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="n">SetFilterBit</span> <span class="o">=</span> <span class="mi">25</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,};</span>

<span class="cm">/* The SetRxFilter command accepts the following classes: */</span>
<span class="k">enum</span> <span class="n">RxFilter</span> <span class="p">{</span>
	<span class="n">RxStation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RxMulticast</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">RxBroadcast</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">RxProm</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">};</span>

<span class="cm">/* Bits in the general status register. */</span>
<span class="k">enum</span> <span class="n">vortex_status</span> <span class="p">{</span>
	<span class="n">IntLatch</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">HostError</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">TxComplete</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">TxAvailable</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">RxComplete</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="n">RxEarly</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
	<span class="n">IntReq</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="n">StatsFull</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
	<span class="n">DMADone</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">DownComplete</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">,</span> <span class="n">UpComplete</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">,</span>
	<span class="n">DMAInProgress</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>			<span class="cm">/* DMA controller is still busy.*/</span>
	<span class="n">CmdInProgress</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">,</span>			<span class="cm">/* EL3_CMD is still busy.*/</span>
<span class="p">};</span>

<span class="cm">/* Register window 1 offsets, the window used in normal operation.</span>
<span class="cm">   On the Vortex this window is always mapped at offsets 0x10-0x1f. */</span>
<span class="k">enum</span> <span class="n">Window1</span> <span class="p">{</span>
	<span class="n">TX_FIFO</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>  <span class="n">RX_FIFO</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>  <span class="n">RxErrors</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">RxStatus</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>  <span class="n">Timer</span><span class="o">=</span><span class="mh">0x1A</span><span class="p">,</span> <span class="n">TxStatus</span> <span class="o">=</span> <span class="mh">0x1B</span><span class="p">,</span>
	<span class="n">TxFree</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="cm">/* Remaining free bytes in Tx buffer. */</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Window0</span> <span class="p">{</span>
	<span class="n">Wn0EepromCmd</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		<span class="cm">/* Window 0: EEPROM command register. */</span>
	<span class="n">Wn0EepromData</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>		<span class="cm">/* Window 0: EEPROM results register. */</span>
	<span class="n">IntrStatus</span><span class="o">=</span><span class="mh">0x0E</span><span class="p">,</span>		<span class="cm">/* Valid in all windows. */</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Win0_EEPROM_bits</span> <span class="p">{</span>
	<span class="n">EEPROM_Read</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">EEPROM_WRITE</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">EEPROM_ERASE</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
	<span class="n">EEPROM_EWENB</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>		<span class="cm">/* Enable erasing/writing for 10 msec. */</span>
	<span class="n">EEPROM_EWDIS</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* Disable EWENB before 10 msec timeout. */</span>
<span class="p">};</span>
<span class="cm">/* EEPROM locations. */</span>
<span class="k">enum</span> <span class="n">eeprom_offset</span> <span class="p">{</span>
	<span class="n">PhysAddr01</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">PhysAddr23</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">PhysAddr45</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ModelID</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
	<span class="n">EtherLink3ID</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">IFXcvrIO</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">IRQLine</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
	<span class="n">NodeAddr01</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">NodeAddr23</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">NodeAddr45</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
	<span class="n">DriverTune</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">Checksum</span><span class="o">=</span><span class="mi">15</span><span class="p">};</span>

<span class="k">enum</span> <span class="n">Window2</span> <span class="p">{</span>			<span class="cm">/* Window 2. */</span>
	<span class="n">Wn2_ResetOptions</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Window3</span> <span class="p">{</span>			<span class="cm">/* Window 3: MAC/config bits. */</span>
	<span class="n">Wn3_Config</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Wn3_MaxPktSize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">Wn3_MAC_Ctrl</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">Wn3_Options</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define BFEXT(value, offset, bitcount)  \</span>
<span class="cp">    ((((unsigned long)(value)) &gt;&gt; (offset)) &amp; ((1 &lt;&lt; (bitcount)) - 1))</span>

<span class="cp">#define BFINS(lhs, rhs, offset, bitcount)					\</span>
<span class="cp">	(((lhs) &amp; ~((((1 &lt;&lt; (bitcount)) - 1)) &lt;&lt; (offset))) |	\</span>
<span class="cp">	(((rhs) &amp; ((1 &lt;&lt; (bitcount)) - 1)) &lt;&lt; (offset)))</span>

<span class="cp">#define RAM_SIZE(v)		BFEXT(v, 0, 3)</span>
<span class="cp">#define RAM_WIDTH(v)	BFEXT(v, 3, 1)</span>
<span class="cp">#define RAM_SPEED(v)	BFEXT(v, 4, 2)</span>
<span class="cp">#define ROM_SIZE(v)		BFEXT(v, 6, 2)</span>
<span class="cp">#define RAM_SPLIT(v)	BFEXT(v, 16, 2)</span>
<span class="cp">#define XCVR(v)			BFEXT(v, 20, 4)</span>
<span class="cp">#define AUTOSELECT(v)	BFEXT(v, 24, 1)</span>

<span class="k">enum</span> <span class="n">Window4</span> <span class="p">{</span>		<span class="cm">/* Window 4: Xcvr/media bits. */</span>
	<span class="n">Wn4_FIFODiag</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_NetDiag</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">Wn4_Media</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Win4_Media_bits</span> <span class="p">{</span>
	<span class="n">Media_SQE</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>		<span class="cm">/* Enable SQE error counting for AUI. */</span>
	<span class="n">Media_10TP</span> <span class="o">=</span> <span class="mh">0x00C0</span><span class="p">,</span>	<span class="cm">/* Enable link beat and jabber for 10baseT. */</span>
	<span class="n">Media_Lnk</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>		<span class="cm">/* Enable just link beat for 100TX/100FX. */</span>
	<span class="n">Media_LnkBeat</span> <span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Window7</span> <span class="p">{</span>					<span class="cm">/* Window 7: Bus Master control. */</span>
	<span class="n">Wn7_MasterAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Wn7_VlanEtherType</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">Wn7_MasterLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">Wn7_MasterStatus</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/* Boomerang bus master control registers. */</span>
<span class="k">enum</span> <span class="n">MasterCtrl</span> <span class="p">{</span>
	<span class="n">PktStatus</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">DownListPtr</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">FragAddr</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">FragLen</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>
	<span class="n">TxFreeThreshold</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">UpPktStatus</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">UpListPtr</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The Rx and Tx descriptor lists.</span>
<span class="cm">   Caution Alpha hackers: these types are 32 bits!  Note also the 8 byte</span>
<span class="cm">   alignment contraint on tx_ring[] and rx_ring[]. */</span>
<span class="cp">#define LAST_FRAG 	0x80000000			</span><span class="cm">/* Last Addr/Len pair in descriptor. */</span><span class="cp"></span>
<span class="cp">#define DN_COMPLETE	0x00010000			</span><span class="cm">/* This packet has been downloaded */</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">boom_rx_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">next</span><span class="p">;</span>					<span class="cm">/* Last entry points to 0.   */</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>					<span class="cm">/* Up to 63 addr/len pairs possible. */</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>					<span class="cm">/* Set LAST_FRAG to indicate last pair. */</span>
<span class="p">};</span>
<span class="cm">/* Values for the Rx status entry. */</span>
<span class="k">enum</span> <span class="n">rx_desc_status</span> <span class="p">{</span>
	<span class="n">RxDComplete</span><span class="o">=</span><span class="mh">0x00008000</span><span class="p">,</span> <span class="n">RxDError</span><span class="o">=</span><span class="mh">0x4000</span><span class="p">,</span>
	<span class="cm">/* See boomerang_rx() for actual error bits */</span>
	<span class="n">IPChksumErr</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">25</span><span class="p">,</span> <span class="n">TCPChksumErr</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">26</span><span class="p">,</span> <span class="n">UDPChksumErr</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">,</span>
	<span class="n">IPChksumValid</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">29</span><span class="p">,</span> <span class="n">TCPChksumValid</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">,</span> <span class="n">UDPChksumValid</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef MAX_SKB_FRAGS</span>
<span class="cp">#define DO_ZEROCOPY 1</span>
<span class="cp">#else</span>
<span class="cp">#define DO_ZEROCOPY 0</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">boom_tx_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">next</span><span class="p">;</span>					<span class="cm">/* Last entry points to 0.   */</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>					<span class="cm">/* bits 0:12 length, others see below.  */</span>
<span class="cp">#if DO_ZEROCOPY</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">frag</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">MAX_SKB_FRAGS</span><span class="p">];</span>
<span class="cp">#else</span>
		<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* Values for the Tx status entry. */</span>
<span class="k">enum</span> <span class="n">tx_desc_status</span> <span class="p">{</span>
	<span class="n">CRCDisable</span><span class="o">=</span><span class="mh">0x2000</span><span class="p">,</span> <span class="n">TxDComplete</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">AddIPChksum</span><span class="o">=</span><span class="mh">0x02000000</span><span class="p">,</span> <span class="n">AddTCPChksum</span><span class="o">=</span><span class="mh">0x04000000</span><span class="p">,</span> <span class="n">AddUDPChksum</span><span class="o">=</span><span class="mh">0x08000000</span><span class="p">,</span>
	<span class="n">TxIntrUploaded</span><span class="o">=</span><span class="mh">0x80000000</span><span class="p">,</span>		<span class="cm">/* IRQ when in FIFO, but maybe not sent. */</span>
<span class="p">};</span>

<span class="cm">/* Chip features we care about in vp-&gt;capabilities, read from the EEPROM. */</span>
<span class="k">enum</span> <span class="n">ChipCaps</span> <span class="p">{</span> <span class="n">CapBusMaster</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">CapPwrMgmt</span><span class="o">=</span><span class="mh">0x2000</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">vortex_extra_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_deferred</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_max_collisions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_multiple_collisions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_single_collisions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_bad_ssd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vortex_private</span> <span class="p">{</span>
	<span class="cm">/* The Rx and Tx rings should be quad-word-aligned. */</span>
	<span class="k">struct</span> <span class="n">boom_rx_desc</span><span class="o">*</span> <span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="o">*</span> <span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_ring_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_ring_dma</span><span class="p">;</span>
	<span class="cm">/* The addresses of transmit- and receive-in-place skbuffs. */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">rx_skbuff</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">tx_skbuff</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_rx</span><span class="p">,</span> <span class="n">cur_tx</span><span class="p">;</span>		<span class="cm">/* The next free ring entry */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty_rx</span><span class="p">,</span> <span class="n">dirty_tx</span><span class="p">;</span>	<span class="cm">/* The ring entries to be free()ed. */</span>
	<span class="k">struct</span> <span class="n">vortex_extra_stats</span> <span class="n">xstats</span><span class="p">;</span>	<span class="cm">/* NIC-specific extra stats */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>				<span class="cm">/* Packet being eaten by bus master ctrl.  */</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_skb_dma</span><span class="p">;</span>				<span class="cm">/* Allocated DMA address for bus master ctrl DMA.   */</span>

	<span class="cm">/* PCI configuration space information. */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>			<span class="cm">/* IO address space */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cb_fn_base</span><span class="p">;</span>		<span class="cm">/* CardBus function status addr space. */</span>

	<span class="cm">/* Some values here only for performance evaluation and path-coverage */</span>
	<span class="kt">int</span> <span class="n">rx_nocopy</span><span class="p">,</span> <span class="n">rx_copy</span><span class="p">,</span> <span class="n">queued_packet</span><span class="p">,</span> <span class="n">rx_csumhits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">card_idx</span><span class="p">;</span>

	<span class="cm">/* The remainder are related to chip state, mostly media selection. */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>			<span class="cm">/* Media selection timer. */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rx_oom_timer</span><span class="p">;</span>		<span class="cm">/* Rx skb allocation retry timer */</span>
	<span class="kt">int</span> <span class="n">options</span><span class="p">;</span>						<span class="cm">/* User-settable misc. driver options. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">media_override</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span> 		<span class="cm">/* Passed-in media type. */</span>
		<span class="nl">default_media:</span><span class="mi">4</span><span class="p">,</span>				<span class="cm">/* Read from the EEPROM/Wn3_Config. */</span>
		<span class="nl">full_duplex:</span><span class="mi">1</span><span class="p">,</span> <span class="n">autoselect</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="nl">bus_master:</span><span class="mi">1</span><span class="p">,</span>					<span class="cm">/* Vortex can only do a fragment bus-m. */</span>
		<span class="nl">full_bus_master_tx:</span><span class="mi">1</span><span class="p">,</span> <span class="n">full_bus_master_rx</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/* Boomerang  */</span>
		<span class="nl">flow_ctrl:</span><span class="mi">1</span><span class="p">,</span>					<span class="cm">/* Use 802.3x flow control (PAUSE only) */</span>
		<span class="nl">partner_flow_ctrl:</span><span class="mi">1</span><span class="p">,</span>			<span class="cm">/* Partner supports flow control */</span>
		<span class="nl">has_nway:</span><span class="mi">1</span><span class="p">,</span>
		<span class="nl">enable_wol:</span><span class="mi">1</span><span class="p">,</span>					<span class="cm">/* Wake-on-LAN is enabled */</span>
		<span class="nl">pm_state_valid:</span><span class="mi">1</span><span class="p">,</span>				<span class="cm">/* pci_dev-&gt;saved_config_space has sane contents */</span>
		<span class="nl">open:</span><span class="mi">1</span><span class="p">,</span>
		<span class="nl">medialock:</span><span class="mi">1</span><span class="p">,</span>
		<span class="nl">must_free_region:</span><span class="mi">1</span><span class="p">,</span>				<span class="cm">/* Flag: if zero, Cardbus owns the I/O region */</span>
		<span class="nl">large_frames:</span><span class="mi">1</span><span class="p">,</span>			<span class="cm">/* accept large frames */</span>
		<span class="nl">handling_irq:</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* private in_irq indicator */</span>
	<span class="cm">/* {get|set}_wol operations are already serialized by rtnl.</span>
<span class="cm">	 * no additional locking is required for the enable_wol and acpi_set_WOL()</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">drv_flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status_enable</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intr_enable</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">available_media</span><span class="p">;</span>				<span class="cm">/* From Wn3_Options. */</span>
	<span class="n">u16</span> <span class="n">capabilities</span><span class="p">,</span> <span class="n">info1</span><span class="p">,</span> <span class="n">info2</span><span class="p">;</span>		<span class="cm">/* Various, from EEPROM. */</span>
	<span class="n">u16</span> <span class="n">advertising</span><span class="p">;</span>					<span class="cm">/* NWay media advertisement */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>				<span class="cm">/* MII device addresses. */</span>
	<span class="n">u16</span> <span class="n">deferred</span><span class="p">;</span>						<span class="cm">/* Resend these interrupts when we</span>
<span class="cm">										 * bale from the ISR */</span>
	<span class="n">u16</span> <span class="n">io_size</span><span class="p">;</span>						<span class="cm">/* Size of PCI region (for release_region) */</span>

	<span class="cm">/* Serialises access to hardware other than MII and variables below.</span>
<span class="cm">	 * The lock hierarchy is rtnl_lock &gt; {lock, mii_lock} &gt; window_lock. */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">mii_lock</span><span class="p">;</span>		<span class="cm">/* Serialises access to MII */</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii</span><span class="p">;</span>		<span class="cm">/* MII lib hooks/info */</span>
	<span class="n">spinlock_t</span> <span class="n">window_lock</span><span class="p">;</span>		<span class="cm">/* Serialises access to windowed regs */</span>
	<span class="kt">int</span> <span class="n">window</span><span class="p">;</span>			<span class="cm">/* Register window */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">window_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">!=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">SelectWindow</span> <span class="o">+</span> <span class="n">window</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define DEFINE_WINDOW_IO(size)						\</span>
<span class="cp">static u ## size							\</span>
<span class="cp">window_read ## size(struct vortex_private *vp, int window, int addr)	\</span>
<span class="cp">{									\</span>
<span class="cp">	unsigned long flags;						\</span>
<span class="cp">	u ## size ret;							\</span>
<span class="cp">	spin_lock_irqsave(&amp;vp-&gt;window_lock, flags);			\</span>
<span class="cp">	window_set(vp, window);						\</span>
<span class="cp">	ret = ioread ## size(vp-&gt;ioaddr + addr);			\</span>
<span class="cp">	spin_unlock_irqrestore(&amp;vp-&gt;window_lock, flags);		\</span>
<span class="cp">	return ret;							\</span>
<span class="cp">}									\</span>
<span class="cp">static void								\</span>
<span class="cp">window_write ## size(struct vortex_private *vp, u ## size value,	\</span>
<span class="cp">		     int window, int addr)				\</span>
<span class="cp">{									\</span>
<span class="cp">	unsigned long flags;						\</span>
<span class="cp">	spin_lock_irqsave(&amp;vp-&gt;window_lock, flags);			\</span>
<span class="cp">	window_set(vp, window);						\</span>
<span class="cp">	iowrite ## size(value, vp-&gt;ioaddr + addr);			\</span>
<span class="cp">	spin_unlock_irqrestore(&amp;vp-&gt;window_lock, flags);		\</span>
<span class="cp">}</span>
<span class="n">DEFINE_WINDOW_IO</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">DEFINE_WINDOW_IO</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">DEFINE_WINDOW_IO</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#define DEVICE_PCI(dev) (((dev)-&gt;bus == &amp;pci_bus_type) ? to_pci_dev((dev)) : NULL)</span>
<span class="cp">#else</span>
<span class="cp">#define DEVICE_PCI(dev) NULL</span>
<span class="cp">#endif</span>

<span class="cp">#define VORTEX_PCI(vp)							\</span>
<span class="cp">	((struct pci_dev *) (((vp)-&gt;gendev) ? DEVICE_PCI((vp)-&gt;gendev) : NULL))</span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="cp">#define DEVICE_EISA(dev) (((dev)-&gt;bus == &amp;eisa_bus_type) ? to_eisa_device((dev)) : NULL)</span>
<span class="cp">#else</span>
<span class="cp">#define DEVICE_EISA(dev) NULL</span>
<span class="cp">#endif</span>

<span class="cp">#define VORTEX_EISA(vp)							\</span>
<span class="cp">	((struct eisa_device *) (((vp)-&gt;gendev) ? DEVICE_EISA((vp)-&gt;gendev) : NULL))</span>

<span class="cm">/* The action to take with a media selection timer tick.</span>
<span class="cm">   Note that we deviate from the 3Com order by checking 10base2 before AUI.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">xcvr_types</span> <span class="p">{</span>
	<span class="n">XCVR_10baseT</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">XCVR_AUI</span><span class="p">,</span> <span class="n">XCVR_10baseTOnly</span><span class="p">,</span> <span class="n">XCVR_10base2</span><span class="p">,</span> <span class="n">XCVR_100baseTx</span><span class="p">,</span>
	<span class="n">XCVR_100baseFx</span><span class="p">,</span> <span class="n">XCVR_MII</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">XCVR_NWAY</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">XCVR_ExtMII</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">XCVR_Default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_table</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">media_bits</span><span class="o">:</span><span class="mi">16</span><span class="p">,</span>		<span class="cm">/* Bits to set in Wn4_Media register. */</span>
		<span class="nl">mask:</span><span class="mi">8</span><span class="p">,</span>						<span class="cm">/* The transceiver-present bit in Wn3_Config.*/</span>
		<span class="nl">next:</span><span class="mi">8</span><span class="p">;</span>						<span class="cm">/* The media type to try next. */</span>
	<span class="kt">int</span> <span class="n">wait</span><span class="p">;</span>						<span class="cm">/* Time before we check media status. */</span>
<span class="p">}</span> <span class="n">media_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>	<span class="s">&quot;10baseT&quot;</span><span class="p">,</span>   <span class="n">Media_10TP</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">XCVR_10base2</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;10Mbs AUI&quot;</span><span class="p">,</span> <span class="n">Media_SQE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">XCVR_Default</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="mh">0x80</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">10000</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;10base2&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>			<span class="mh">0x10</span><span class="p">,</span> <span class="n">XCVR_AUI</span><span class="p">,</span>		<span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;100baseTX&quot;</span><span class="p">,</span> <span class="n">Media_Lnk</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">XCVR_100baseFx</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;100baseFX&quot;</span><span class="p">,</span> <span class="n">Media_Lnk</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">XCVR_MII</span><span class="p">,</span>		<span class="p">(</span><span class="mi">14</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;MII&quot;</span><span class="p">,</span>		 <span class="mi">0</span><span class="p">,</span>			<span class="mh">0x41</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="mh">0x01</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">10000</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;Autonegotiate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		<span class="mh">0x41</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;MII-External&quot;</span><span class="p">,</span>	 <span class="mi">0</span><span class="p">,</span>		<span class="mh">0x41</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s">&quot;Default&quot;</span><span class="p">,</span>	 <span class="mi">0</span><span class="p">,</span>			<span class="mh">0xFF</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">10000</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ethtool_stats_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tx_deferred&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_max_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_multiple_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_single_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bad_ssd&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* number of ETHTOOL_GSTATS u64&#39;s */</span>
<span class="cp">#define VORTEX_NUM_STATS    5</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">chip_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_idx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">final</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mdio_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_oom_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">vortex_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">boomerang_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">boomerang_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">vortex_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">boomerang_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dump_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_stats</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">vortex_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">acpi_set_WOL</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">vortex_ethtool_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_8021q_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>

<span class="cm">/* This driver uses &#39;options&#39; to pass the media type, full-duplex flag, etc. */</span>
<span class="cm">/* Option count limit only -- unlimited interfaces are supported. */</span>
<span class="cp">#define MAX_UNITS 8</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_UNITS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_UNITS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hw_checksums</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_UNITS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flow_ctrl</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_UNITS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_wol</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_UNITS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_mmio</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_UNITS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">global_options</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">global_full_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">global_enable_wol</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">global_use_mmio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Variables to work-around the Compaq PCI BIOS32 problem. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">compaq_ioaddr</span><span class="p">,</span> <span class="n">compaq_irq</span><span class="p">,</span> <span class="n">compaq_device_id</span> <span class="o">=</span> <span class="mh">0x5900</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">compaq_net_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_cards_found</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">global_options</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">global_full_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">hw_checksums</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">flow_ctrl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">global_enable_wol</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable_wol</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">compaq_ioaddr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">compaq_irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">compaq_device_id</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">watchdog</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">global_use_mmio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">use_mmio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;3c59x debug level (0-6)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;3c59x: Bits 0-3: media type, bit 4: bus mastering, bit 9: full duplex&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">global_options</span><span class="p">,</span> <span class="s">&quot;3c59x: same as options, but applies to all NICs if options is unset&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="s">&quot;3c59x full duplex setting(s) (1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">global_full_duplex</span><span class="p">,</span> <span class="s">&quot;3c59x: same as full_duplex, but applies to all NICs if full_duplex is unset&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hw_checksums</span><span class="p">,</span> <span class="s">&quot;3c59x Hardware checksum checking by adapter(s) (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">flow_ctrl</span><span class="p">,</span> <span class="s">&quot;3c59x 802.3x flow control usage (PAUSE only) (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_wol</span><span class="p">,</span> <span class="s">&quot;3c59x: Turn on Wake-on-LAN for adapter(s) (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">global_enable_wol</span><span class="p">,</span> <span class="s">&quot;3c59x: same as enable_wol, but applies to all NICs if enable_wol is unset&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;3c59x copy breakpoint for copy-only-tiny-frames&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;3c59x maximum events handled per interrupt&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">compaq_ioaddr</span><span class="p">,</span> <span class="s">&quot;3c59x PCI I/O base address (Compaq BIOS problem workaround)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">compaq_irq</span><span class="p">,</span> <span class="s">&quot;3c59x PCI IRQ number (Compaq BIOS problem workaround)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">compaq_device_id</span><span class="p">,</span> <span class="s">&quot;3c59x PCI device ID (Compaq BIOS problem workaround)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">watchdog</span><span class="p">,</span> <span class="s">&quot;3c59x transmit timeout in milliseconds&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">global_use_mmio</span><span class="p">,</span> <span class="s">&quot;3c59x: same as use_mmio, but applies to all NICs if options is unset&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_mmio</span><span class="p">,</span> <span class="s">&quot;3c59x: use memory-mapped PCI I/O resource (0-1)&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">poll_vortex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">?</span> <span class="n">boomerang_interrupt</span><span class="o">:</span><span class="n">vortex_interrupt</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">vortex_down</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vortex_up</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">vortex_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">vortex_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">vortex_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">vortex_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">vortex_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poweroff</span> <span class="o">=</span> <span class="n">vortex_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">vortex_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define VORTEX_PM_OPS (&amp;vortex_pm_ops)</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define VORTEX_PM_OPS NULL</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_device_id</span> <span class="n">vortex_eisa_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;TCM5920&quot;</span><span class="p">,</span> <span class="n">CH_3C592</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TCM5970&quot;</span><span class="p">,</span> <span class="n">CH_3C597</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">eisa</span><span class="p">,</span> <span class="n">vortex_eisa_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vortex_eisa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">;</span>

	<span class="n">edev</span> <span class="o">=</span> <span class="n">to_eisa_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioport_map</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_probe1</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xC88</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span>
					  <span class="n">edev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_data</span><span class="p">,</span> <span class="n">vortex_cards_found</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vortex_cards_found</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">vortex_eisa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">edev</span> <span class="o">=</span> <span class="n">to_eisa_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">eisa_get_drvdata</span><span class="p">(</span><span class="n">edev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;vortex_eisa_remove called for Compaq device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">TotalReset</span><span class="o">|</span><span class="mh">0x14</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_driver</span> <span class="n">vortex_eisa_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">vortex_eisa_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;3c59x&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">vortex_eisa_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">vortex_eisa_remove</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_EISA */</span><span class="cp"></span>

<span class="cm">/* returns count found (&gt;= 0), or negative on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vortex_eisa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eisa_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_cards_found</span> <span class="o">=</span> <span class="n">vortex_cards_found</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">eisa_driver_register</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">vortex_eisa_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Because of the way EISA bus is probed, we cannot assume</span>
<span class="cm">		 * any device have been found when we exit from</span>
<span class="cm">		 * eisa_driver_register (the bus root driver may not be</span>
<span class="cm">		 * initialized yet). So we blindly assume something was</span>
<span class="cm">		 * found, and let the sysfs magic happened...</span>
<span class="cm">		 */</span>
		<span class="n">eisa_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Special code to work-around the Compaq PCI BIOS32 problem. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compaq_ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_probe1</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ioport_map</span><span class="p">(</span><span class="n">compaq_ioaddr</span><span class="p">,</span> <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">),</span>
			      <span class="n">compaq_irq</span><span class="p">,</span> <span class="n">compaq_device_id</span><span class="p">,</span> <span class="n">vortex_cards_found</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">vortex_cards_found</span> <span class="o">-</span> <span class="n">orig_cards_found</span> <span class="o">+</span> <span class="n">eisa_found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns count (&gt;= 0), or negative on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vortex_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">pci_bar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_chip_info</span> <span class="o">*</span><span class="n">vci</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="cm">/* wake up and enable device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">vortex_cards_found</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">global_use_mmio</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="n">MAX_UNITS</span> <span class="o">||</span> <span class="n">use_mmio</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Determine the default if the user didn&#39;t override us */</span>
		<span class="n">vci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex_info_tbl</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
		<span class="n">pci_bar</span> <span class="o">=</span> <span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IS_CYCLONE</span> <span class="o">|</span> <span class="n">IS_TORNADO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span> <span class="o">&amp;&amp;</span> <span class="n">use_mmio</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_bar</span> <span class="o">=</span> <span class="n">use_mmio</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pci_bar</span> <span class="o">=</span> <span class="n">global_use_mmio</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_bar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="cm">/* If mapping fails, fall-back to BAR 0... */</span>
		<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">vortex_probe1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			   <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vortex_cards_found</span><span class="o">++</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">boomrang_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">vortex_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">vortex_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">boomerang_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">vortex_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">vortex_get_stats</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> 		<span class="o">=</span> <span class="n">vortex_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">poll_vortex</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">vortex_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">vortex_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">vortex_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">vortex_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">vortex_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">vortex_get_stats</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> 		<span class="o">=</span> <span class="n">vortex_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">poll_vortex</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Start up the PCI/EISA device which is described by *gendev.</span>
<span class="cm"> * Return 0 on success.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: pdev can be NULL, for the case of a Compaq device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vortex_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">chip_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eeprom</span><span class="p">[</span><span class="mh">0x40</span><span class="p">],</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* EEPROM contents */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">print_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_chip_info</span> <span class="o">*</span> <span class="k">const</span> <span class="n">vci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex_info_tbl</span><span class="p">[</span><span class="n">chip_idx</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">print_name</span> <span class="o">=</span> <span class="s">&quot;3c59x&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
		<span class="n">printed_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gendev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">DEVICE_PCI</span><span class="p">(</span><span class="n">gendev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">print_name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">edev</span> <span class="o">=</span> <span class="n">DEVICE_EISA</span><span class="p">(</span><span class="n">gendev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">print_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vp</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gendev</span><span class="p">);</span>
	<span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">option</span> <span class="o">=</span> <span class="n">global_options</span><span class="p">;</span>

	<span class="cm">/* The lower four bits are the media type. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The &#39;options&#39; param is passed in as the third arg to the</span>
<span class="cm">		 * LILO &#39;ether=&#39; argument for non-modular use</span>
<span class="cm">		 */</span>
		<span class="n">option</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">option</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">card_idx</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="n">vortex_debug</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
			<span class="n">vortex_debug</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">print_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;See Documentation/networking/vortex.txt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: 3Com %s %s at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">print_name</span><span class="p">,</span>
	       <span class="n">pdev</span> <span class="o">?</span> <span class="s">&quot;PCI&quot;</span> <span class="o">:</span> <span class="s">&quot;EISA&quot;</span><span class="p">,</span>
	       <span class="n">vci</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">large_frames</span> <span class="o">=</span> <span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">=</span> <span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">has_nway</span> <span class="o">=</span> <span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_NWAY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">io_size</span> <span class="o">=</span> <span class="n">vci</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">card_idx</span> <span class="o">=</span> <span class="n">card_idx</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* module list only for Compaq device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gendev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compaq_net_device</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PCI-only startup logic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EISA resources already marked, so only PCI needs to do this here */</span>
		<span class="cm">/* Ignore return value, because Cardbus drivers already allocate for us */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">vci</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">,</span> <span class="n">print_name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">must_free_region</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* enable bus-mastering if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PCI_USES_MASTER</span><span class="p">)</span>
			<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">IS_VORTEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">pci_latency</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">new_latency</span> <span class="o">=</span> <span class="mi">248</span><span class="p">;</span>

			<span class="cm">/* Check the PCI latency value.  On the 3c590 series the latency timer</span>
<span class="cm">			   must be set to the maximum value to avoid data corruption that occurs</span>
<span class="cm">			   when the timer expires during a transfer.  This bug exists the Vortex</span>
<span class="cm">			   chip only. */</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_latency</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_latency</span> <span class="o">&lt;</span> <span class="n">new_latency</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Overriding PCI latency timer (CFLT) setting of %d, new value is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">print_name</span><span class="p">,</span> <span class="n">pci_latency</span><span class="p">,</span> <span class="n">new_latency</span><span class="p">);</span>
				<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">new_latency</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">gendev</span> <span class="o">=</span> <span class="n">gendev</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="cm">/* Makes sure rings are at least 16 byte aligned. */</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span>
					   <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_RING_SIZE</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_region</span><span class="p">;</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">RX_RING_SIZE</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>

	<span class="cm">/* if we are a PCI driver, we store info in pdev-&gt;driver_data</span>
<span class="cm">	 * instead of a module list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edev</span><span class="p">)</span>
		<span class="n">eisa_set_drvdata</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">=</span> <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>  <span class="o">?</span>  <span class="mi">0</span>  <span class="o">:</span>  <span class="n">option</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">medialock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">=</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">global_full_duplex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">global_enable_wol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_duplex</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_ctrl</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable_wol</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
	<span class="cm">/* Read the station address from the EEPROM. */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">base</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">EEPROM_8BIT</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mh">0x230</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">EEPROM_OFFSET</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">EEPROM_Read</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">EEPROM_Read</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>
			<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Wn0EepromCmd</span><span class="p">);</span>
			<span class="cm">/* Pause for at least 162 us. for the read to take place. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">timer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timer</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">162</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Wn0EepromCmd</span><span class="p">)</span> <span class="o">&amp;</span>
				     <span class="mh">0x8000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Wn0EepromData</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">^=</span> <span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">^</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Grrr, needless incompatible change 3Com. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x21</span><span class="p">)</span>
			<span class="n">checksum</span> <span class="o">^=</span> <span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">^</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">IS_TORNADO</span><span class="p">))</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; ***INVALID CHECKSUM %4.4x*** &quot;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="cm">/* Unfortunately an all zero eeprom passes the checksum and this</span>
<span class="cm">	   gets found in the wild in failure cases. Crypto is hard 8) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;*** EEPROM MAC address is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_ring</span><span class="p">;</span>	<span class="cm">/* With every pack */</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">window_write8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="cm">/* Tell them about an invalid IRQ. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="n">nr_irqs</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot; *** Warning: IRQ %d is unlikely to work! ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_NetDiag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  product code %02x%02x rev %02x.%d date %02d-%02d-%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mh">0x14</span><span class="p">],</span>
			<span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">&amp;&amp;</span> <span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_CB_FNS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_ring</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: CardBus functions mapped %16.16llx-&gt;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Wn2_ResetOptions</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4010</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">INVERT_LED_PWR</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">INVERT_MII_PWR</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Wn2_ResetOptions</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">WNO_XCVR_PWR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Extract our information from the EEPROM data. */</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">info1</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">info1</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Full duplex capable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">ram_split</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;5:3&quot;</span><span class="p">,</span> <span class="s">&quot;3:1&quot;</span><span class="p">,</span> <span class="s">&quot;1:1&quot;</span><span class="p">,</span> <span class="s">&quot;3:5&quot;</span><span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Options</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* Broken 3c916 */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">window_read32</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  Internal config register is %4.4x, transceivers %#x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">config</span><span class="p">,</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Options</span><span class="p">));</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  %dK %s-wide RAM %s Rx:Tx split, %s%s interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">RAM_SIZE</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
				   <span class="n">RAM_WIDTH</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;word&quot;</span> <span class="o">:</span> <span class="s">&quot;byte&quot;</span><span class="p">,</span>
				   <span class="n">ram_split</span><span class="p">[</span><span class="n">RAM_SPLIT</span><span class="p">(</span><span class="n">config</span><span class="p">)],</span>
				   <span class="n">AUTOSELECT</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;autoselect/&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				   <span class="n">XCVR</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">XCVR_ExtMII</span> <span class="o">?</span> <span class="s">&quot;&lt;invalid transceiver&gt;&quot;</span> <span class="o">:</span>
				   <span class="n">media_tbl</span><span class="p">[</span><span class="n">XCVR</span><span class="p">(</span><span class="n">config</span><span class="p">)].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span> <span class="o">=</span> <span class="n">XCVR</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span> <span class="o">==</span> <span class="n">XCVR_NWAY</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">has_nway</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">autoselect</span> <span class="o">=</span> <span class="n">AUTOSELECT</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:  Media override to transceiver type %d (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">,</span>
				<span class="n">media_tbl</span><span class="p">[</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vci</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_NWAY</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_MII</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_NWAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mii_preamble_required</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">EXTRA_PREAMBLE</span><span class="p">)</span>
			<span class="n">mii_preamble_required</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mdio_sync</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mii_status</span><span class="p">,</span> <span class="n">phyx</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * For the 3c905CX we look at index 24 first, because it bogusly</span>
<span class="cm">			 * reports an external PHY at all indices</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">phyx</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">)</span>
				<span class="n">phyx</span> <span class="o">=</span> <span class="n">phy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">phyx</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
			<span class="n">mii_status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phyx</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span>  <span class="o">&amp;&amp;</span>  <span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">phy_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phyx</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  MII transceiver found at address %d, status %4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">phyx</span><span class="p">,</span> <span class="n">mii_status</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">mii_preamble_required</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mii_preamble_required</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;  ***WARNING*** No MII transceivers found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Only advertise the FD media types. */</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02A0</span><span class="p">;</span>
				<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CapBusMaster</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  Enabling bus-master transmits and %s receives.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;early&quot;</span> <span class="o">:</span> <span class="s">&quot;whole-frame&quot;</span> <span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* AKPM: vortex only */</span>
	<span class="p">}</span>

	<span class="cm">/* The 3c59x-specific entries in the device structure. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">boomrang_netdev_ops</span><span class="p">;</span>
		<span class="cm">/* Actually, it still should work with iommu. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">hw_checksums</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_HWCKSM</span><span class="p">))</span> <span class="o">||</span>
				<span class="n">hw_checksums</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">vortex_netdev_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: scatter/gather %sabled. h/w checksums %sabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_name</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_SG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span><span class="o">:</span><span class="s">&quot;dis&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span><span class="o">:</span><span class="s">&quot;dis&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="p">(</span><span class="n">watchdog</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">pm_state_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">));</span>
 		<span class="n">acpi_set_WOL</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_ring:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span>
							<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_RING_SIZE</span><span class="p">,</span>
						<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
						<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
<span class="nl">free_region:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">must_free_region</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">vci</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;vortex_probe1 fails.  Returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">issue_and_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OK, that didn&#39;t work.  Do it the slow way.  One second */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: command 0x%04x took %d usecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: command 0x%04x did not complete! Status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_set_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:  setting %s-duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>

	<span class="cm">/* Set the full-duplex bit. */</span>
	<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">info1</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">||</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">large_frames</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">&amp;&amp;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">partner_flow_ctrl</span><span class="p">)</span> <span class="o">?</span>
			<span class="mh">0x100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_MAC_Ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_check_media</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ok_to_print</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ok_to_print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_check_media</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">ok_to_print</span><span class="p">,</span> <span class="n">init</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">;</span>
		<span class="n">vortex_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mii_reg1</span><span class="p">,</span> <span class="n">mii_reg5</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">PCI_D0</span><span class="p">);</span>	<span class="cm">/* Go active */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">pm_state_valid</span><span class="p">)</span>
			<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Could not enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Before initializing select the active media port. */</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">window_read32</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Media override to transceiver %d (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">,</span>
			   <span class="n">media_tbl</span><span class="p">[</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">autoselect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">has_nway</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: using NWAY device table, not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">XCVR_NWAY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Find first available media type, starting with 100baseTx. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">XCVR_100baseTx</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">&amp;</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mask</span><span class="p">))</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: first available media type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: using default media %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">vortex_timer</span><span class="p">;</span>		<span class="cm">/* timer handler */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_oom_timer</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_oom_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_oom_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">rx_oom_timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Initial media type %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span><span class="p">;</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">BFINS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;vortex_up(): writing 0x%x to InternalConfig</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="n">window_write32</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_MII</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_NWAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_reg1</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="n">mii_reg5</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_LPA</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">partner_flow_ctrl</span> <span class="o">=</span> <span class="p">((</span><span class="n">mii_reg5</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">;</span>

		<span class="n">vortex_check_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">vortex_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TxReset</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t reset the PHY - that upsets autonegotiation during DHCP operations.</span>
<span class="cm">	 */</span>
	<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RxReset</span><span class="o">|</span><span class="mh">0x04</span><span class="p">);</span>


	<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vortex_up() irq %d media status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_Media</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Set the station address and mask in window 2 each time opened. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">window_write8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">n</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Wn2_ResetOptions</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4010</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">INVERT_LED_PWR</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">INVERT_MII_PWR</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Wn2_ResetOptions</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_10base2</span><span class="p">)</span>
		<span class="cm">/* Start the thinnet transceiver. We should really wait 50ms...*/</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">StartCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">!=</span> <span class="n">XCVR_NWAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_Media</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">Media_10TP</span><span class="o">|</span><span class="n">Media_SQE</span><span class="p">))</span> <span class="o">|</span>
			       <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">media_bits</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_Media</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Switch to the stats window, and clear all stats by reading. */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* New: On the Vortex we must also clear the BadSSD counter. */</span>
	<span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* ..and on the Boomerang we enable the extra statistics bits. */</span>
	<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_NetDiag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Boomerang bus master. */</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Initialize the RxEarly register as recommended. */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetRxThreshold</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1536</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0020</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PktStatus</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UpListPtr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span> 		<span class="cm">/* Boomerang bus master Tx. */</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">IS_BOOMERANG</span><span class="p">)</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="n">PKT_BUF_SZ</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFreeThreshold</span><span class="p">);</span> <span class="cm">/* Room for a packet. */</span>
		<span class="cm">/* Clear the Rx, Tx rings. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* AKPM: this is done in vortex_open, too */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Set receiver mode: presumably accept b-case and phys addr only. */</span>
	<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* enable 802.1q tagged frames */</span>
	<span class="n">set_8021q_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">StatsEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Turn on statistics. */</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Enable the receiver. */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Enable transmitter. */</span>
	<span class="cm">/* Allow status bits to be seen. */</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">status_enable</span> <span class="o">=</span> <span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="n">HostError</span><span class="o">|</span><span class="n">IntReq</span><span class="o">|</span><span class="n">StatsFull</span><span class="o">|</span><span class="n">TxComplete</span><span class="o">|</span>
		<span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span> <span class="o">?</span> <span class="n">DownComplete</span> <span class="o">:</span> <span class="n">TxAvailable</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">?</span> <span class="n">UpComplete</span> <span class="o">:</span> <span class="n">RxComplete</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">?</span> <span class="n">DMADone</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">intr_enable</span> <span class="o">=</span> <span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="n">IntLatch</span> <span class="o">|</span> <span class="n">TxAvailable</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">RxComplete</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">StatsFull</span> <span class="o">|</span> <span class="n">HostError</span> <span class="o">|</span> <span class="n">TxComplete</span> <span class="o">|</span> <span class="n">IntReq</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">?</span> <span class="n">DMADone</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">UpComplete</span> <span class="o">|</span> <span class="n">DownComplete</span><span class="p">;</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">status_enable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="cm">/* Ack all pending events, and set active indicator mask. */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntLatch</span> <span class="o">|</span> <span class="n">TxAvailable</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">IntReq</span><span class="p">,</span>
		 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">)</span>			<span class="cm">/* The PCMCIA people are idiots.  */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Use the now-standard shared IRQ implementation. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">?</span>
				<span class="n">boomerang_interrupt</span> <span class="o">:</span> <span class="n">vortex_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Could not reserve IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Boomerang bus master. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:  Filling in the Rx ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Clear complete bit. */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">PKT_BUF_SZ</span> <span class="o">|</span> <span class="n">LAST_FRAG</span><span class="p">);</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">,</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>			<span class="cm">/* Bad news!  */</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">pr_emerg</span><span class="p">(</span><span class="s">&quot;%s: no memory for rx ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Wrap the ring. */</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">vortex_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: vortex_open() fails: returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">media_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection timer tick happened, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev-&gt;watchdog_timeo=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">media_status</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_Media</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XCVR_10baseT</span>:  <span class="k">case</span> <span class="n">XCVR_100baseTx</span>:  <span class="k">case</span> <span class="n">XCVR_100baseFx</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">media_status</span> <span class="o">&amp;</span> <span class="n">Media_LnkBeat</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media %s has link beat, %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">media_status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media %s has no link beat, %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">media_status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XCVR_MII</span>: <span class="k">case</span> <span class="n">XCVR_NWAY</span>:
		<span class="p">{</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vortex_check_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="nl">default:</span>					<span class="cm">/* Other media types handled by Tx timeouts. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		  <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media %s has no indication, %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">media_status</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_SLAVE</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">medialock</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">leave_media_alone</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">&amp;</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mask</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_Default</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Go back to default. */</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span><span class="p">;</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection failing, using default %s port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection failed, now trying %s port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="n">next_tick</span> <span class="o">=</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">wait</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">media_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Media_10TP</span><span class="o">|</span><span class="n">Media_SQE</span><span class="p">))</span> <span class="o">|</span>
			       <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">media_bits</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_Media</span><span class="p">);</span>

		<span class="n">config</span> <span class="o">=</span> <span class="n">window_read32</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Config</span><span class="p">);</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">BFINS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">window_write32</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_Config</span><span class="p">);</span>

		<span class="n">iowrite16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_10base2</span> <span class="o">?</span> <span class="n">StartCoax</span> <span class="o">:</span> <span class="n">StopCoax</span><span class="p">,</span>
			 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;wrote 0x%08x to Wn3_Config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
		<span class="cm">/* AKPM: FIXME: Should reset Rx &amp; Tx here.  P60 of 3c90xc.pdf */</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">leave_media_alone:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
	  <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection timer finished, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">next_tick</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span><span class="p">)</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">FakeIntr</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: transmit timed out, tx_status %2.2x status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">),</span>
		   <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  diagnostics: net %04x media %04x dma %08x fifo %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_NetDiag</span><span class="p">),</span>
			<span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_Media</span><span class="p">),</span>
			<span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PktStatus</span><span class="p">),</span>
			<span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_FIFODiag</span><span class="p">));</span>
	<span class="cm">/* Slight code bloat to be user friendly. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x88</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Transmitter encountered 16 collisions --&quot;</span>
			   <span class="s">&quot; network cable problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IntLatch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Interrupt posted but not delivered --&quot;</span>
			   <span class="s">&quot; IRQ blocked by another device?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* Bad idea here.. but we might as well handle a few events. */</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Block interrupts because vortex_interrupt does a bare spin_lock()</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span>
				<span class="n">boomerang_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">vortex_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dump_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TxReset</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Resetting the Tx ring pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span>  <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">),</span>
				 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">IS_BOOMERANG</span><span class="p">)</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="n">PKT_BUF_SZ</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFreeThreshold</span><span class="p">);</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">DownUnstall</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue Tx Enable */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle uncommon interrupt sources.  This is a separate routine to minimize</span>
<span class="cm"> * the cache impact.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_tx_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reset_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: vortex_error(), status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxComplete</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* Really &quot;TxError&quot; for us. */</span>
		<span class="n">tx_status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">);</span>
		<span class="cm">/* Presumably a tx-timeout. We must merely re-enable. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tx_status</span> <span class="o">!=</span> <span class="mh">0x88</span> <span class="o">&amp;&amp;</span> <span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Transmit error, Tx status register %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">==</span> <span class="mh">0x82</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Probably a duplex mismatch.  See &quot;</span>
						<span class="s">&quot;Documentation/networking/vortex.txt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dump_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x14</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>  <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_max_collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* txJabber or txUnderrun */</span>
			<span class="n">do_tx_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">MAX_COLLISION_RESET</span><span class="p">))</span>  <span class="p">{</span>	<span class="cm">/* maxCollisions */</span>
			<span class="n">do_tx_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">reset_mask</span> <span class="o">=</span> <span class="mh">0x0108</span><span class="p">;</span>		<span class="cm">/* Reset interface logic, but not download logic */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* Merely re-enable the transmitter. */</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxEarly</span><span class="p">)</span>				<span class="cm">/* Rx early is unused. */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">RxEarly</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">StatsFull</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* Empty statistics. */</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">DoneDidThat</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Updating stats.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* HACK: Disable statistics as an interrupt source. */</span>
		<span class="cm">/* This occurs when we have the wrong media type! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DoneDidThat</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span>
			<span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">StatsFull</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Updating statistics failed, disabling &quot;</span>
				   <span class="s">&quot;stats as an interrupt source.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">StatsFull</span><span class="p">),</span>
				  <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">intr_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">StatsFull</span><span class="p">;</span>
			<span class="n">DoneDidThat</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IntReq</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Restore all interrupt sources.  */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">status_enable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HostError</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">fifo_diag</span><span class="p">;</span>
		<span class="n">fifo_diag</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_FIFODiag</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Host error, FIFO diagnostic register %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fifo_diag</span><span class="p">);</span>
		<span class="cm">/* Adapter failure requires Tx/Rx reset and reinit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bus_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PktStatus</span><span class="p">);</span>
			<span class="cm">/* 0x80000000 PCI master abort. */</span>
			<span class="cm">/* 0x40000000 PCI target abort. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: PCI bus error, bus status %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bus_status</span><span class="p">);</span>

			<span class="cm">/* In this case, blow the card away */</span>
			<span class="cm">/* Must not enter D3 or we can&#39;t legally issue the reset! */</span>
			<span class="n">vortex_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TotalReset</span> <span class="o">|</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">vortex_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>		<span class="cm">/* AKPM: bug.  vortex_up() assumes that the rx ring is full. It may not be. */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fifo_diag</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
			<span class="n">do_tx_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo_diag</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reset Rx fifo and upload logic */</span>
			<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RxReset</span><span class="o">|</span><span class="mh">0x07</span><span class="p">);</span>
			<span class="cm">/* Set the Rx filter to the current state. */</span>
			<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* enable 802.1q VLAN tagged frames */</span>
			<span class="n">set_8021q_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Re-enable the receiver. */</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">HostError</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_tx_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TxReset</span><span class="o">|</span><span class="n">reset_mask</span><span class="p">);</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">vortex_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="cm">/* Put out the doubleword header... */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the bus-master controller to transfer the packet. */</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb_dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
						<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
		<span class="n">window_set</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterAddr</span><span class="p">);</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterLen</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">StartDMADown</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="cm">/* netif_wake_queue() will be called at the DMADone interrupt. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ... and the packet rounded to a doubleword. */</span>
		<span class="n">iowrite32_rep</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* AKPM: redundant? */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Interrupt us when the FIFO has room for max-sized packet. */</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetTxThreshold</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1536</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* Clear the Tx status stack. */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">tx_status</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span>	<span class="o">&amp;&amp;</span>	<span class="p">(</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* A Tx-disabling error occurred.  */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				  <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Tx error, status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TxReset</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">);</span> <span class="cm">/* Pop the status stack. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">boomerang_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="cm">/* Calculate the next Tx descriptor entry. */</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">boom_tx_desc</span> <span class="o">*</span><span class="n">prev_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_start_xmit()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Trying to send a packet, Tx index %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t allow a recursion from our interrupt handler back into the</span>
<span class="cm">	 * tx routine, as they take the same spin lock, and that causes</span>
<span class="cm">	 * deadlock.  Just return NETDEV_TX_BUSY and let the stack try again in</span>
<span class="cm">	 * a bit</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">handling_irq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&gt;=</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: BUG! Tx Ring full, refusing to send buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DO_ZEROCOPY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">!=</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="n">TxIntrUploaded</span><span class="p">);</span>
	<span class="k">else</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="n">TxIntrUploaded</span> <span class="o">|</span> <span class="n">AddTCPChksum</span> <span class="o">|</span> <span class="n">AddUDPChksum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
										<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="n">LAST_FRAG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
										<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span>
						<span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span>
						<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						<span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span><span class="o">|</span><span class="n">LAST_FRAG</span><span class="p">);</span>
			<span class="k">else</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="n">LAST_FRAG</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="n">TxIntrUploaded</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Wait for the stall to complete. */</span>
	<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DownStall</span><span class="p">);</span>
	<span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">queued_packet</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>					<span class="cm">/* Clear previous interrupt enable. */</span>
<span class="cp">#if defined(tx_interrupt_mitigation)</span>
		<span class="cm">/* Dubious. If in boomeang_interrupt &quot;faster&quot; cyclone ifdef</span>
<span class="cm">		 * were selected, this would corrupt DN_COMPLETE. No?</span>
<span class="cm">		 */</span>
		<span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">TxIntrUploaded</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">DownUnstall</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>

<span class="cm">/*</span>
<span class="cm"> * This is the ISR for the vortex series chips.</span>
<span class="cm"> * full_bus_master_tx == 0 &amp;&amp; full_bus_master_rx == 0</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">vortex_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;vortex_interrupt(). status=0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IntLatch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handler_exit</span><span class="p">;</span>		<span class="cm">/* No interrupt: shared IRQs cause this */</span>
	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IntReq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>		<span class="cm">/* h/w no longer present (hotplug)? */</span>
		<span class="k">goto</span> <span class="n">handler_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: interrupt, status %4.4x, latency %d ticks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Timer</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
	<span class="n">window_set</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: In interrupt loop, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxComplete</span><span class="p">)</span>
			<span class="n">vortex_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxAvailable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;	TX room bit was handled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* There&#39;s room in the FIFO for a full-sized packet. */</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">TxAvailable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DMADone</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterStatus</span><span class="p">);</span> <span class="cm">/* Ack the event. */</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb_dma</span><span class="p">,</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span> <span class="cm">/* Release the transferred buffer */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * AKPM: FIXME: I don&#39;t think we need this.  If the queue was stopped due to</span>
<span class="cm">					 * insufficient FIFO room, the TxAvailable test will succeed and call</span>
<span class="cm">					 * netif_wake_queue()</span>
<span class="cm">					 */</span>
					<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Interrupt when FIFO has room for max-sized packet. */</span>
					<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetTxThreshold</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1536</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
					<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Check for all uncommon interrupts at once. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HostError</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">StatsFull</span> <span class="o">|</span> <span class="n">TxComplete</span> <span class="o">|</span> <span class="n">IntReq</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxEarly</span><span class="p">)</span>
				<span class="n">vortex_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
			<span class="n">vortex_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
			<span class="n">window_set</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Too much work in interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* Disable all pending interrupts. */</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">status_enable</span><span class="p">),</span>
					 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">IntLatch</span><span class="p">);</span>
			<span class="cm">/* The timer will reenable interrupts. */</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Acknowledge the IRQ. */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntReq</span> <span class="o">|</span> <span class="n">IntLatch</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IntLatch</span> <span class="o">|</span> <span class="n">RxComplete</span><span class="p">));</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: exiting interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="nl">handler_exit:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the ISR for the boomerang series chips.</span>
<span class="cm"> * full_bus_master_tx == 1 &amp;&amp; full_bus_master_rx == 1</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">boomerang_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * It seems dopey to put the spinlock this early, but we could race against vortex_tx_timeout</span>
<span class="cm">	 * and boomerang_start_xmit</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">handling_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_interrupt. status=0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IntLatch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handler_exit</span><span class="p">;</span>		<span class="cm">/* No interrupt: shared IRQs can cause this */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* h/w no longer present (hotplug)? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_interrupt(1): status = 0xffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">handler_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IntReq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: interrupt, status %4.4x, latency %d ticks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Timer</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: In interrupt loop, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UpComplete</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">UpComplete</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_interrupt-&gt;boomerang_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">boomerang_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DownComplete</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>

			<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">DownComplete</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
<span class="cp">#if 1	</span><span class="cm">/* AKPM: the latter is faster, but cyclone-only */</span><span class="cp"></span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>			<span class="cm">/* It still hasn&#39;t been processed. */</span>
<span class="cp">#else</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DN_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>			<span class="cm">/* It still hasn&#39;t been processed. */</span>
<span class="cp">#endif</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
<span class="cp">#if DO_ZEROCOPY</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span>
											 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span>
											 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFFF</span><span class="p">,</span>
											 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
<span class="cp">#else</span>
					<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_interrupt: no skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* dev-&gt;stats.tx_packets++;  Counted below. */</span>
				<span class="n">dirty_tx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">dirty_tx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&lt;=</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_interrupt: wake queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check for all uncommon interrupts at once. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HostError</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">StatsFull</span> <span class="o">|</span> <span class="n">TxComplete</span> <span class="o">|</span> <span class="n">IntReq</span><span class="p">))</span>
			<span class="n">vortex_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Too much work in interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* Disable all pending interrupts. */</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">status_enable</span><span class="p">),</span>
					 <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">IntLatch</span><span class="p">);</span>
			<span class="cm">/* The timer will reenable interrupts. */</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Acknowledge the IRQ. */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntReq</span> <span class="o">|</span> <span class="n">IntLatch</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">)</span>			<span class="cm">/* The PCMCIA people are idiots.  */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">IntLatch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: exiting interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="nl">handler_exit:</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">handling_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rx_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;vortex_rx(): status %4.4x, rx_status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EL3_STATUS</span><span class="p">),</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">RxStatus</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStatus</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Error, update stats. */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_error</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxErrors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; Rx error: status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_error</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The packet length: up to 4.5K!. */</span>
			<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receiving packet size %d status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">pkt_len</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
				<span class="cm">/* &#39;skb_put()&#39; points to the start of sk_buff data area. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
									   <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
					<span class="n">iowrite32</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterAddr</span><span class="p">);</span>
					<span class="n">iowrite16</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterLen</span><span class="p">);</span>
					<span class="n">iowrite16</span><span class="p">(</span><span class="n">StartDMAUp</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
						<span class="p">;</span>
					<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">dma</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ioread32_rep</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_FIFO</span><span class="p">,</span>
					             <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
						     <span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">RxDiscard</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span> <span class="cm">/* Pop top Rx packet. */</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* Wait a limited time to go to next packet. */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: No memory to allocate a sk_buff of size %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RxDiscard</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">boomerang_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_work_limit</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+</span> <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;boomerang_rx(): status %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EL3_STATUS</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RxDComplete</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">rx_work_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxDError</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Error, update stats. */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_error</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; Rx error: status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_error</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The packet length: up to 4.5K!. */</span>
			<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receiving packet size %d status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">pkt_len</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>

			<span class="cm">/* Check if the packet is long enough to just accept without</span>
<span class="cm">			   copying to a properly sized skbuff. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">rx_copybreak</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">dma</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="cm">/* &#39;skb_put()&#39; points to the start of sk_buff data area. */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
					   <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					   <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">dma</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_copy</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Pass up the skbuff already on the Rx ring. */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">dma</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_nocopy</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="p">{</span>					<span class="cm">/* Use hardware checksum info. */</span>
				<span class="kt">int</span> <span class="n">csum_bits</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0xee000000</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">csum_bits</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">csum_bits</span> <span class="o">==</span> <span class="p">(</span><span class="n">IPChksumValid</span> <span class="o">|</span> <span class="n">TCPChksumValid</span><span class="p">)</span> <span class="o">||</span>
					 <span class="n">csum_bits</span> <span class="o">==</span> <span class="p">(</span><span class="n">IPChksumValid</span> <span class="o">|</span> <span class="n">UDPChksumValid</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_csumhits</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Refill the Rx ring buffers. */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_jif</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">last_jif</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: memory shortage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">last_jif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="p">)</span> <span class="o">==</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span>
					<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_oom_timer</span><span class="p">,</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>			<span class="cm">/* Bad news!  */</span>
			<span class="p">}</span>

			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Clear complete bit. */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">UpUnstall</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we&#39;ve hit a total OOM refilling the Rx ring we poll once a second</span>
<span class="cm"> * for some memory.  Otherwise there is no way to restart the rx process.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rx_oom_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="p">)</span> <span class="o">==</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span>	<span class="cm">/* This test is redundant, but makes me feel good */</span>
		<span class="n">boomerang_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: rx_oom_timer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;retrying&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">final_down</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_oom_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Turn off statistics ASAP.  We update dev-&gt;stats below. */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="cm">/* Disable the receiver and transmitter. */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">RxDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">TxDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="cm">/* Disable receiving 802.1q tagged frames */</span>
	<span class="n">set_8021q_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_10base2</span><span class="p">)</span>
		<span class="cm">/* Turn off thinnet power.  Green! */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">StopCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">update_stats</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UpListPtr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">final_down</span> <span class="o">&amp;&amp;</span> <span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">pm_state_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">));</span>
		<span class="n">acpi_set_WOL</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">vortex_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vortex_close() status %4.4x, Tx status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">),</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">));</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vortex close stats: rx_nocopy %d rx_copy %d&quot;</span>
			   <span class="s">&quot; tx_queued %d Rx pre-checksummed %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_nocopy</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_copy</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">queued_packet</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_csumhits</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if DO_ZEROCOPY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_csumhits</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_HWCKSM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">card_idx</span> <span class="o">&gt;=</span> <span class="n">MAX_UNITS</span> <span class="o">||</span> <span class="n">hw_checksums</span><span class="p">[</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s supports hardware checksums, and we&#39;re not using them!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Free Boomerang bus master Rx buffers. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span>	<span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span>
									<span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Free Boomerang bus master Tx buffers. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#if DO_ZEROCOPY</span>
				<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;=</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
						<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span>
										 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span>
										 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFFF</span><span class="p">,</span>
										 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">stalled</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PktStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* Possible racy. But it&#39;s only debug stuff */</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  Flags; bus-master %d, dirty %d(%d) current %d(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">,</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">,</span>
					<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  Transmit list %8.8x vs. %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">]);</span>
			<span class="n">issue_and_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DownStall</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

<span class="cp">#if DO_ZEROCOPY</span>
				<span class="n">length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  %d: @%p  length %8.8x status %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">length</span><span class="p">,</span>
					   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stalled</span><span class="p">)</span>
				<span class="n">iowrite16</span><span class="p">(</span><span class="n">DownUnstall</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">vortex_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* AKPM: Used to be netif_running */</span>
		<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Update statistics.</span>
<span class="cm">	Unlike with the EL3 we need not worry about interrupts changing</span>
<span class="cm">	the window setting from underneath us, but we must still guard</span>
<span class="cm">	against a race condition with a StatsUpdate interrupt updating the</span>
<span class="cm">	table.  This is done by checking that the ASM (!) code generated uses</span>
<span class="cm">	atomic updates with &#39;+=&#39;.</span>
<span class="cm">	*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_stats</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Unlike the 3c5x9 we need not turn off stats updates while reading. */</span>
	<span class="cm">/* Switch to the stats window, and read everything. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span>		<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span>		<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span>		<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span>		<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span>			<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span>			<span class="o">+=</span> <span class="p">(</span><span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span>
						    <span class="mh">0x30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* Rx packets	*/</span>			<span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>   <span class="cm">/* Must read to clear */</span>
	<span class="cm">/* Don&#39;t bother with register 9, an extension of registers 6&amp;7.</span>
<span class="cm">	   If we do use the 6&amp;7 values the atomic update assumption above</span>
<span class="cm">	   is invalid. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> 			<span class="o">+=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> 			<span class="o">+=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* Extra stats for get_ethtool_stats() */</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_multiple_collisions</span>	<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_single_collisions</span>         <span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_deferred</span>			<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">rx_bad_ssd</span>			<span class="o">+=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_multiple_collisions</span>
		<span class="o">+</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_single_collisions</span>
		<span class="o">+</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_max_collisions</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">up</span> <span class="o">=</span> <span class="n">window_read8</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">up</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">up</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">vortex_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vortex_debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dbg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_debug</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">VORTEX_NUM_STATS</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">update_stats</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_deferred</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_max_collisions</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_multiple_collisions</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_single_collisions</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">rx_bad_ssd</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_stats_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_stats_keys</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">)),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_EISA</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span>
				<span class="s">&quot;EISA 0x%lx %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acpi_set_WOL</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">vortex_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">vortex_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>            <span class="o">=</span> <span class="n">vortex_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>           <span class="o">=</span> <span class="n">vortex_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>           <span class="o">=</span> <span class="n">vortex_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>      <span class="o">=</span> <span class="n">vortex_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">vortex_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>           <span class="o">=</span> <span class="n">vortex_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>           <span class="o">=</span> <span class="n">vortex_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>               <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>             <span class="o">=</span> <span class="n">vortex_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>                <span class="o">=</span> <span class="n">vortex_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>                <span class="o">=</span> <span class="n">vortex_set_wol</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cm">/*</span>
<span class="cm"> *	Must power the device up to do MDIO operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_power_t</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">;</span>

	<span class="cm">/* The kernel core really should have pci_get_power_state() */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/* Pre-Cyclone chips have no documented multicast filter, so the only</span>
<span class="cm">   multicast setting is to receive all multicast frames.  At least</span>
<span class="cm">   the chip has a very clean way to set the mode, unlike many others. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vortex_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: Setting promiscuous mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">SetRxFilter</span><span class="o">|</span><span class="n">RxStation</span><span class="o">|</span><span class="n">RxMulticast</span><span class="o">|</span><span class="n">RxBroadcast</span><span class="o">|</span><span class="n">RxProm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">SetRxFilter</span><span class="o">|</span><span class="n">RxStation</span><span class="o">|</span><span class="n">RxMulticast</span><span class="o">|</span><span class="n">RxBroadcast</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxBroadcast</span><span class="p">;</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">new_mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)</span>
<span class="cm">/* Setup the card so that it can receive frames with an 802.1q VLAN tag.</span>
<span class="cm">   Note that this must be done after each RxReset due to some backwards</span>
<span class="cm">   compatibility logic in the Cyclone and Tornado ASICs */</span>

<span class="cm">/* The Ethernet Type used for 802.1q tagged frames */</span>
<span class="cp">#define VLAN_ETHER_TYPE 0x8100</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_8021q_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mac_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span><span class="o">&amp;</span><span class="n">IS_CYCLONE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span><span class="o">&amp;</span><span class="n">IS_TORNADO</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* cyclone and tornado chipsets can recognize 802.1q</span>
<span class="cm">		 * tagged frames and treat them correctly */</span>

		<span class="kt">int</span> <span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="o">+</span><span class="mi">14</span><span class="p">;</span>	<span class="cm">/* MTU+Ethernet header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">max_pkt_size</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* 802.1Q VLAN tag */</span>

		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">max_pkt_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_MaxPktSize</span><span class="p">);</span>

		<span class="cm">/* set VlanEtherType to let the hardware checksumming</span>
<span class="cm">		   treat tagged frames correctly */</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">VLAN_ETHER_TYPE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">Wn7_VlanEtherType</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* on older cards we have to enable large frames */</span>

		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">large_frames</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1500</span> <span class="o">||</span> <span class="n">enable</span><span class="p">;</span>

		<span class="n">mac_ctrl</span> <span class="o">=</span> <span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_MAC_Ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">large_frames</span><span class="p">)</span>
			<span class="n">mac_ctrl</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">mac_ctrl</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Wn3_MAC_Ctrl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_8021q_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="cp">#endif</span>

<span class="cm">/* MII transceiver control section.</span>
<span class="cm">   Read and write the MII registers using software-generated serial</span>
<span class="cm">   MDIO protocol.  See the MII specifications or DP83840A data sheet</span>
<span class="cm">   for details. */</span>

<span class="cm">/* The maximum data clock rate is 2.5 Mhz.  The minimum timing is usually</span>
<span class="cm">   met by back-to-back PCI I/O cycles, but we insert a delay to avoid</span>
<span class="cm">   &quot;overclocking&quot; issues. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">window_read32</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MDIO_SHIFT_CLK	0x01</span>
<span class="cp">#define MDIO_DIR_WRITE	0x04</span>
<span class="cp">#define MDIO_DATA_WRITE0 (0x00 | MDIO_DIR_WRITE)</span>
<span class="cp">#define MDIO_DATA_WRITE1 (0x02 | MDIO_DIR_WRITE)</span>
<span class="cp">#define MDIO_DATA_READ	0x02</span>
<span class="cp">#define MDIO_ENB_IN		0x00</span>

<span class="cm">/* Generate the preamble required for initial synchronization and</span>
<span class="cm">   a few older transceivers. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Establish sync by sending at least 32 logic ones. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span> <span class="n">bits</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">MDIO_DATA_WRITE1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">MDIO_DATA_WRITE1</span> <span class="o">|</span> <span class="n">MDIO_SHIFT_CLK</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">read_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xf6</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">location</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_preamble_required</span><span class="p">)</span>
		<span class="n">mdio_sync</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Shift the read command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_cmd</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">MDIO_DATA_WRITE1</span> <span class="o">:</span> <span class="n">MDIO_DATA_WRITE0</span><span class="p">;</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">dataval</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">dataval</span> <span class="o">|</span> <span class="n">MDIO_SHIFT_CLK</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Read the two transition, 16 data, and wire-idle bits. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">MDIO_ENB_IN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">window_read16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="n">MDIO_DATA_READ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">MDIO_ENB_IN</span> <span class="o">|</span> <span class="n">MDIO_SHIFT_CLK</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span> <span class="o">&amp;</span> <span class="mh">0x20000</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="n">retval</span><span class="o">&gt;&gt;</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">write_cmd</span> <span class="o">=</span> <span class="mh">0x50020000</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_preamble_required</span><span class="p">)</span>
		<span class="n">mdio_sync</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Shift the command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_cmd</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">MDIO_DATA_WRITE1</span> <span class="o">:</span> <span class="n">MDIO_DATA_WRITE0</span><span class="p">;</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">dataval</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">dataval</span> <span class="o">|</span> <span class="n">MDIO_SHIFT_CLK</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Leave the interface idle. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">MDIO_ENB_IN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">MDIO_ENB_IN</span> <span class="o">|</span> <span class="n">MDIO_SHIFT_CLK</span><span class="p">,</span>
			       <span class="mi">4</span><span class="p">,</span> <span class="n">Wn4_PhysicalMgmt</span><span class="p">);</span>
		<span class="n">mdio_delay</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">mii_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ACPI: Advanced Configuration and Power Interface. */</span>
<span class="cm">/* Set Wake-On-LAN mode and put the board into D3 (power-down) state. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_set_WOL</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Power up on: 1==Downloaded Filter, 2==Magic Packets, 4==Link Status. */</span>
		<span class="n">window_write16</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="cm">/* The RxFilter must accept the WOL frames. */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">SetRxFilter</span><span class="o">|</span><span class="n">RxStation</span><span class="o">|</span><span class="n">RxMulticast</span><span class="o">|</span><span class="n">RxBroadcast</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: WOL not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">)));</span>

			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">enable_wol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">&lt;</span> <span class="n">PCI_D3hot</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* Change the power state to D3; RxEnable doesn&#39;t take effect. */</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">vortex_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;vortex_remove_one called for Compaq device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cb_fn_base</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">PCI_D0</span><span class="p">);</span>	<span class="cm">/* Go active */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">pm_state_valid</span><span class="p">)</span>
			<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">));</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* Should really use issue_and_wait() here */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">TotalReset</span> <span class="o">|</span> <span class="p">((</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">EEPROM_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mh">0x14</span><span class="p">),</span>
	     <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">VORTEX_PCI</span><span class="p">(</span><span class="n">vp</span><span class="p">),</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span>
							<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boom_tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_RING_SIZE</span><span class="p">,</span>
						<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
						<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">must_free_region</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">vortex_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;3c59x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">vortex_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">vortex_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">vortex_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">VORTEX_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_have_pci</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_have_eisa</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vortex_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pci_rc</span><span class="p">,</span> <span class="n">eisa_rc</span><span class="p">;</span>

	<span class="n">pci_rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex_driver</span><span class="p">);</span>
	<span class="n">eisa_rc</span> <span class="o">=</span> <span class="n">vortex_eisa_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vortex_have_pci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eisa_rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vortex_have_eisa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">vortex_have_pci</span> <span class="o">+</span> <span class="n">vortex_have_eisa</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vortex_eisa_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vortex_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="cm">/* Take care of the EISA devices */</span>
	<span class="n">eisa_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex_eisa_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compaq_net_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">compaq_net_device</span><span class="p">);</span>
		<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioport_map</span><span class="p">(</span><span class="n">compaq_net_device</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
		                    <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">);</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">compaq_net_device</span><span class="p">);</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">TotalReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">compaq_net_device</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
		               <span class="n">VORTEX_TOTAL_SIZE</span><span class="p">);</span>

		<span class="n">free_netdev</span><span class="p">(</span><span class="n">compaq_net_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vortex_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_have_pci</span><span class="p">)</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vortex_have_eisa</span><span class="p">)</span>
		<span class="n">vortex_eisa_cleanup</span><span class="p">();</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">vortex_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vortex_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
