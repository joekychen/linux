<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › 3com › 3c515.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>3c515.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Written 1997-1998 by Donald Becker.</span>

<span class="cm">	This software may be used and distributed according to the terms</span>
<span class="cm">	of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">	This driver is for the 3Com ISA EtherLink XL &quot;Corkscrew&quot; 3c515 ethercard.</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>


<span class="cm">	2000/2/2- Added support for kernel-level ISAPnP</span>
<span class="cm">		by Stephen Frost &lt;sfrost@snowman.net&gt; and Alessandro Zummo</span>
<span class="cm">	Cleaned up for 2.3.x/softnet by Jeff Garzik and Alan Cox.</span>

<span class="cm">	2001/11/17 - Added ethtool support (jgarzik)</span>

<span class="cm">	2002/10/28 - Locking updates for 2.5 (alan@lxorguk.ukuu.org.uk)</span>

<span class="cm">*/</span>

<span class="cp">#define DRV_NAME		&quot;3c515&quot;</span>
<span class="cp">#define DRV_VERSION		&quot;0.99t-ac&quot;</span>
<span class="cp">#define DRV_RELDATE		&quot;28-Oct-2002&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span>
<span class="n">DRV_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot; becker@scyld.com and others</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#define CORKSCREW 1</span>

<span class="cm">/* &quot;Knobs&quot; that adjust features and parameters. */</span>
<span class="cm">/* Set the copy breakpoint for the copy-only-tiny-frames scheme.</span>
<span class="cm">   Setting to &gt; 1512 effectively disables this feature. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

<span class="cm">/* Allow setting MTU to a larger size, bypassing the normal ethernet setup. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>

<span class="cm">/* Maximum events (Rx packets, etc.) to handle at each interrupt. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="cm">/* Enable the automatic media selection code -- usually set. */</span>
<span class="cp">#define AUTOMEDIA 1</span>

<span class="cm">/* Allow the use of fragment bus master transfers instead of only</span>
<span class="cm">   programmed-I/O for Vortex cards.  Full-bus-master transfers are always</span>
<span class="cm">   enabled by default on Boomerang cards.  If VORTEX_BUS_MASTER is defined,</span>
<span class="cm">   the feature may be turned on using &#39;options&#39;. */</span>
<span class="cp">#define VORTEX_BUS_MASTER</span>

<span class="cm">/* A few values that may be tweaked. */</span>
<span class="cm">/* Keep the ring sizes a power of two for efficiency. */</span>
<span class="cp">#define TX_RING_SIZE	16</span>
<span class="cp">#define RX_RING_SIZE	16</span>
<span class="cp">#define PKT_BUF_SZ		1536	</span><span class="cm">/* Size of each temporary Rx buffer. */</span><span class="cp"></span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#define NEW_MULTICAST</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#define MAX_UNITS 8</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;3Com 3c515 Corkscrew driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="cm">/* &quot;Knobs&quot; for adjusting internal parameters. */</span>
<span class="cm">/* Put out somewhat more debugging messages. (0 - no msg, 1 minimal msgs). */</span>
<span class="cp">#define DRIVER_DEBUG 1</span>
<span class="cm">/* Some values here only for performance evaluation and path-coverage</span>
<span class="cm">   debugging. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_nocopy</span><span class="p">,</span> <span class="n">rx_copy</span><span class="p">,</span> <span class="n">queued_packet</span><span class="p">;</span>

<span class="cm">/* Number of times to check to see if the Tx FIFO has space, used in some</span>
<span class="cm">   limited cases. */</span>
<span class="cp">#define WAIT_TX_AVAIL 200</span>

<span class="cm">/* Operational parameter that usually are not changed. */</span>
<span class="cp">#define TX_TIMEOUT  ((4*HZ)/10)	</span><span class="cm">/* Time in jiffies before concluding Tx hung */</span><span class="cp"></span>

<span class="cm">/* The size here is somewhat misleading: the Corkscrew also uses the ISA</span>
<span class="cm">   aliased registers at &lt;base&gt;+0x400.</span>
<span class="cm">   */</span>
<span class="cp">#define CORKSCREW_TOTAL_SIZE 0x20</span>

<span class="cp">#ifdef DRIVER_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">corkscrew_debug</span> <span class="o">=</span> <span class="n">DRIVER_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">corkscrew_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define CORKSCREW_ID 10</span>

<span class="cm">/*</span>
<span class="cm">				Theory of Operation</span>

<span class="cm">I. Board Compatibility</span>

<span class="cm">This device driver is designed for the 3Com 3c515 ISA Fast EtherLink XL,</span>
<span class="cm">3Com&#39;s ISA bus adapter for Fast Ethernet.  Due to the unique I/O port layout,</span>
<span class="cm">it&#39;s not practical to integrate this driver with the other EtherLink drivers.</span>

<span class="cm">II. Board-specific settings</span>

<span class="cm">The Corkscrew has an EEPROM for configuration, but no special settings are</span>
<span class="cm">needed for Linux.</span>

<span class="cm">III. Driver operation</span>

<span class="cm">The 3c515 series use an interface that&#39;s very similar to the 3c900 &quot;Boomerang&quot;</span>
<span class="cm">PCI cards, with the bus master interface extensively modified to work with</span>
<span class="cm">the ISA bus.</span>

<span class="cm">The card is capable of full-bus-master transfers with separate</span>
<span class="cm">lists of transmit and receive descriptors, similar to the AMD LANCE/PCnet,</span>
<span class="cm">DEC Tulip and Intel Speedo3.</span>

<span class="cm">This driver uses a &quot;RX_COPYBREAK&quot; scheme rather than a fixed intermediate</span>
<span class="cm">receive buffer.  This scheme allocates full-sized skbuffs as receive</span>
<span class="cm">buffers.  The value RX_COPYBREAK is used as the copying breakpoint: it is</span>
<span class="cm">chosen to trade-off the memory wasted by passing the full-sized skbuff to</span>
<span class="cm">the queue layer for all frames vs. the copying cost of copying a frame to a</span>
<span class="cm">correctly-sized skbuff.</span>


<span class="cm">IIIC. Synchronization</span>
<span class="cm">The driver runs as two independent, single-threaded flows of control.  One</span>
<span class="cm">is the send-packet routine, which enforces single-threaded use by the netif</span>
<span class="cm">layer.  The other thread is the interrupt handler, which is single</span>
<span class="cm">threaded by the hardware and other software.</span>

<span class="cm">IV. Notes</span>

<span class="cm">Thanks to Terry Murphy of 3Com for providing documentation and a development</span>
<span class="cm">board.</span>

<span class="cm">The names &quot;Vortex&quot;, &quot;Boomerang&quot; and &quot;Corkscrew&quot; are the internal 3Com</span>
<span class="cm">project names.  I use these names to eliminate confusion -- 3Com product</span>
<span class="cm">numbers and names are very similar and often confused.</span>

<span class="cm">The new chips support both ethernet (1.5K) and FDDI (4.5K) frame sizes!</span>
<span class="cm">This driver only supports ethernet frames because of the recent MTU limit</span>
<span class="cm">of 1.5K, but the changes to support 4.5K are minimal.</span>
<span class="cm">*/</span>

<span class="cm">/* Operational definitions.</span>
<span class="cm">   These are not used by other compilation units and thus are not</span>
<span class="cm">   exported in a &quot;.h&quot; file.</span>

<span class="cm">   First the windows.  There are eight register windows, with the command</span>
<span class="cm">   and status registers available in each.</span>
<span class="cm">   */</span>
<span class="cp">#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)</span>
<span class="cp">#define EL3_CMD 0x0e</span>
<span class="cp">#define EL3_STATUS 0x0e</span>

<span class="cm">/* The top five bits written to EL3_CMD are a command, the lower</span>
<span class="cm">   11 bits are the parameter, if applicable.</span>
<span class="cm">   Note that 11 parameters bits was fine for ethernet, but the new chips</span>
<span class="cm">   can handle FDDI length frames (~4500 octets) and now parameters count</span>
<span class="cm">   32-bit &#39;Dwords&#39; rather than octets. */</span>

<span class="k">enum</span> <span class="n">corkscrew_cmd</span> <span class="p">{</span>
	<span class="n">TotalReset</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">SelectWindow</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">StartCoax</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">RxDisable</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">RxEnable</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">RxReset</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">UpStall</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">UpUnstall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DownStall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">DownUnstall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">RxDiscard</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">TxEnable</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">TxDisable</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">TxReset</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">FakeIntr</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">AckIntr</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">SetIntrEnb</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">SetStatusEnb</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">SetRxFilter</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">SetRxThreshold</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">SetTxThreshold</span> <span class="o">=</span> <span class="mi">18</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">SetTxStart</span> <span class="o">=</span> <span class="mi">19</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">StartDMAUp</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">StartDMADown</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">StatsEnable</span> <span class="o">=</span> <span class="mi">21</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">StatsDisable</span> <span class="o">=</span> <span class="mi">22</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">StopCoax</span> <span class="o">=</span> <span class="mi">23</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The SetRxFilter command accepts the following classes: */</span>
<span class="k">enum</span> <span class="n">RxFilter</span> <span class="p">{</span>
	<span class="n">RxStation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RxMulticast</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">RxBroadcast</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">RxProm</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="cm">/* Bits in the general status register. */</span>
<span class="k">enum</span> <span class="n">corkscrew_status</span> <span class="p">{</span>
	<span class="n">IntLatch</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">AdapterFailure</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">TxComplete</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">TxAvailable</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">RxComplete</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="n">RxEarly</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
	<span class="n">IntReq</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="n">StatsFull</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
	<span class="n">DMADone</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">DownComplete</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">UpComplete</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">DMAInProgress</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>	<span class="cm">/* DMA controller is still busy. */</span>
	<span class="n">CmdInProgress</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>	<span class="cm">/* EL3_CMD is still busy. */</span>
<span class="p">};</span>

<span class="cm">/* Register window 1 offsets, the window used in normal operation.</span>
<span class="cm">   On the Corkscrew this window is always mapped at offsets 0x10-0x1f. */</span>
<span class="k">enum</span> <span class="n">Window1</span> <span class="p">{</span>
	<span class="n">TX_FIFO</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">RX_FIFO</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">RxErrors</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">RxStatus</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">Timer</span> <span class="o">=</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="n">TxStatus</span> <span class="o">=</span> <span class="mh">0x1B</span><span class="p">,</span>
	<span class="n">TxFree</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span>		<span class="cm">/* Remaining free bytes in Tx buffer. */</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Window0</span> <span class="p">{</span>
	<span class="n">Wn0IRQ</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
<span class="cp">#if defined(CORKSCREW)</span>
	<span class="n">Wn0EepromCmd</span> <span class="o">=</span> <span class="mh">0x200A</span><span class="p">,</span>	<span class="cm">/* Corkscrew EEPROM command register. */</span>
	<span class="n">Wn0EepromData</span> <span class="o">=</span> <span class="mh">0x200C</span><span class="p">,</span>	<span class="cm">/* Corkscrew EEPROM results register. */</span>
<span class="cp">#else</span>
	<span class="n">Wn0EepromCmd</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>	<span class="cm">/* Window 0: EEPROM command register. */</span>
	<span class="n">Wn0EepromData</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>	<span class="cm">/* Window 0: EEPROM results register. */</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Win0_EEPROM_bits</span> <span class="p">{</span>
	<span class="n">EEPROM_Read</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">EEPROM_WRITE</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">EEPROM_ERASE</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
	<span class="n">EEPROM_EWENB</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* Enable erasing/writing for 10 msec. */</span>
	<span class="n">EEPROM_EWDIS</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* Disable EWENB before 10 msec timeout. */</span>
<span class="p">};</span>

<span class="cm">/* EEPROM locations. */</span>
<span class="k">enum</span> <span class="n">eeprom_offset</span> <span class="p">{</span>
	<span class="n">PhysAddr01</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PhysAddr23</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PhysAddr45</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ModelID</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">EtherLink3ID</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">Window3</span> <span class="p">{</span>			<span class="cm">/* Window 3: MAC/config bits. */</span>
	<span class="n">Wn3_Config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Wn3_MAC_Ctrl</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Wn3_Options</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">wn3_config</span> <span class="p">{</span>
	<span class="n">Ram_size</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">Ram_width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">Ram_speed</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">Rom_size</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="n">Ram_split_shift</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">Ram_split</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">Ram_split_shift</span><span class="p">,</span>
	<span class="n">Xcvr_shift</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="n">Xcvr</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">Xcvr_shift</span><span class="p">,</span>
	<span class="n">Autoselect</span> <span class="o">=</span> <span class="mh">0x1000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">Window4</span> <span class="p">{</span>
	<span class="n">Wn4_NetDiag</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Wn4_Media</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>	<span class="cm">/* Window 4: Xcvr/media bits. */</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Win4_Media_bits</span> <span class="p">{</span>
	<span class="n">Media_SQE</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>	<span class="cm">/* Enable SQE error counting for AUI. */</span>
	<span class="n">Media_10TP</span> <span class="o">=</span> <span class="mh">0x00C0</span><span class="p">,</span>	<span class="cm">/* Enable link beat and jabber for 10baseT. */</span>
	<span class="n">Media_Lnk</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>	<span class="cm">/* Enable just link beat for 100TX/100FX. */</span>
	<span class="n">Media_LnkBeat</span> <span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">Window7</span> <span class="p">{</span>			<span class="cm">/* Window 7: Bus Master control. */</span>
	<span class="n">Wn7_MasterAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Wn7_MasterLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Wn7_MasterStatus</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Boomerang-style bus master control registers.  Note ISA aliases! */</span>
<span class="k">enum</span> <span class="n">MasterCtrl</span> <span class="p">{</span>
	<span class="n">PktStatus</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span> <span class="n">DownListPtr</span> <span class="o">=</span> <span class="mh">0x404</span><span class="p">,</span> <span class="n">FragAddr</span> <span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span> <span class="n">FragLen</span> <span class="o">=</span>
	    <span class="mh">0x40c</span><span class="p">,</span>
	<span class="n">TxFreeThreshold</span> <span class="o">=</span> <span class="mh">0x40f</span><span class="p">,</span> <span class="n">UpPktStatus</span> <span class="o">=</span> <span class="mh">0x410</span><span class="p">,</span> <span class="n">UpListPtr</span> <span class="o">=</span> <span class="mh">0x418</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The Rx and Tx descriptor lists.</span>
<span class="cm">   Caution Alpha hackers: these types are 32 bits!  Note also the 8 byte</span>
<span class="cm">   alignment contraint on tx_ring[] and rx_ring[]. */</span>
<span class="k">struct</span> <span class="n">boom_rx_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Values for the Rx status entry. */</span>
<span class="k">enum</span> <span class="n">rx_desc_status</span> <span class="p">{</span>
	<span class="n">RxDComplete</span> <span class="o">=</span> <span class="mh">0x00008000</span><span class="p">,</span> <span class="n">RxDError</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="cm">/* See boomerang_rx() for actual error bits */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">boom_tx_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">product_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">our_dev</span><span class="p">;</span>
	<span class="cm">/* The Rx and Tx rings are here to keep them quad-word-aligned. */</span>
	<span class="k">struct</span> <span class="n">boom_rx_desc</span> <span class="n">rx_ring</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">boom_tx_desc</span> <span class="n">tx_ring</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="cm">/* The addresses of transmit- and receive-in-place skbuffs. */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_rx</span><span class="p">,</span> <span class="n">cur_tx</span><span class="p">;</span>	<span class="cm">/* The next free ring entry */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty_rx</span><span class="p">,</span> <span class="n">dirty_tx</span><span class="p">;</span><span class="cm">/* The ring entries to be free()ed. */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>	<span class="cm">/* Packet being eaten by bus master ctrl.  */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* Media selection timer. */</span>
	<span class="kt">int</span> <span class="n">capabilities</span>	<span class="p">;</span>	<span class="cm">/* Adapter capabilities word. */</span>
	<span class="kt">int</span> <span class="n">options</span><span class="p">;</span>			<span class="cm">/* User-settable misc. driver options. */</span>
	<span class="kt">int</span> <span class="n">last_rx_packets</span><span class="p">;</span>		<span class="cm">/* For media autoselection. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">available_media</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span>	<span class="cm">/* From Wn3_Options */</span>
		<span class="nl">media_override:</span><span class="mi">3</span><span class="p">,</span>	<span class="cm">/* Passed-in media type. */</span>
		<span class="nl">default_media:</span><span class="mi">3</span><span class="p">,</span>	<span class="cm">/* Read from the EEPROM. */</span>
		<span class="nl">full_duplex:</span><span class="mi">1</span><span class="p">,</span> <span class="n">autoselect</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">bus_master</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Vortex can only do a fragment bus-m. */</span>
		<span class="nl">full_bus_master_tx:</span><span class="mi">1</span><span class="p">,</span> <span class="n">full_bus_master_rx</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Boomerang  */</span>
		<span class="nl">tx_full:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The action to take with a media selection timer tick.</span>
<span class="cm">   Note that we deviate from the 3Com order by checking 10base2 before AUI.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">xcvr_types</span> <span class="p">{</span>
	<span class="n">XCVR_10baseT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XCVR_AUI</span><span class="p">,</span> <span class="n">XCVR_10baseTOnly</span><span class="p">,</span> <span class="n">XCVR_10base2</span><span class="p">,</span> <span class="n">XCVR_100baseTx</span><span class="p">,</span>
	<span class="n">XCVR_100baseFx</span><span class="p">,</span> <span class="n">XCVR_MII</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">XCVR_Default</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">media_table</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">media_bits</span><span class="o">:</span><span class="mi">16</span><span class="p">,</span>	<span class="cm">/* Bits to set in Wn4_Media register. */</span>
		<span class="nl">mask:</span><span class="mi">8</span><span class="p">,</span>			<span class="cm">/* The transceiver-present bit in Wn3_Config. */</span>
		<span class="nl">next:</span><span class="mi">8</span><span class="p">;</span>			<span class="cm">/* The media type to try next. */</span>
	<span class="kt">short</span> <span class="n">wait</span><span class="p">;</span>			<span class="cm">/* Time before we check media status. */</span>
<span class="p">}</span> <span class="n">media_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;10baseT&quot;</span><span class="p">,</span> <span class="n">Media_10TP</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">XCVR_10base2</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;10Mbs AUI&quot;</span><span class="p">,</span> <span class="n">Media_SQE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">XCVR_Default</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">10000</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;10base2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">XCVR_AUI</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;100baseTX&quot;</span><span class="p">,</span> <span class="n">Media_Lnk</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">XCVR_100baseFx</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;100baseFX&quot;</span><span class="p">,</span> <span class="n">Media_Lnk</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">XCVR_MII</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MII&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">10000</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Default&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XCVR_10baseT</span><span class="p">,</span> <span class="mi">10000</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef __ISAPNP__</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">corkscrew_isapnp_adapters</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x5051</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="s">&quot;3Com Fast EtherLink ISA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="n">corkscrew_isapnp_adapters</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nopnp</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* __ISAPNP__ */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">corkscrew_scan</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">corkscrew_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_number</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">corkscrew_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">corkscrew_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">corkscrew_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">corkscrew_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">corkscrew_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">boomerang_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">corkscrew_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">corkscrew_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_stats</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">corkscrew_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">   Unfortunately maximizing the shared code between the integrated and</span>
<span class="cm">   module version of the driver results in a complicated set of initialization</span>
<span class="cm">   procedures.</span>
<span class="cm">   init_module() -- modules /  tc59x_init()  -- built-in</span>
<span class="cm">		The wrappers for corkscrew_scan()</span>
<span class="cm">   corkscrew_scan()  		 The common routine that scans for PCI and EISA cards</span>
<span class="cm">   corkscrew_found_device() Allocate a device structure when we find a card.</span>
<span class="cm">					Different versions exist for modules and built-in.</span>
<span class="cm">   corkscrew_probe1()		Fill in the device structure -- this is separated</span>
<span class="cm">					so that the modules code can put it in dev-&gt;init.</span>
<span class="cm">*/</span>
<span class="cm">/* This driver uses &#39;options&#39; to pass the media type, full-duplex flag, etc. */</span>
<span class="cm">/* Note: this is the only limit on the number of cards supported!! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">};</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;3c515 debug level (0-6)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;3c515: Bits 0-2: media type, bit 3: full duplex, bit 4: bus mastering&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;3c515 copy breakpoint for copy-only-tiny-frames&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;3c515 maximum events handled per interrupt&quot;</span><span class="p">);</span>

<span class="cm">/* A list of all installed Vortex devices, for removing the driver module. */</span>
<span class="cm">/* we will need locking (and refcounting) if we ever use it for more */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">root_corkscrew_dev</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">corkscrew_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">corkscrew_scan</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">found</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">tc515_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">corkscrew_scan</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">printed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* not MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">CORKSCREW_TOTAL_SIZE</span><span class="p">,</span> <span class="s">&quot;3c515&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Check the resource configuration for a matching ioaddr. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2002</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">&amp;</span> <span class="mh">0x1f0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">CORKSCREW_TOTAL_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Verify by reading the device ID from the EEPROM. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">EEPROM_Read</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn0EepromCmd</span><span class="p">);</span>
	<span class="cm">/* Pause for at least 162 us. for the read to take place. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">timer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timer</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">162</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn0EepromCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn0EepromData</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x6d50</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">CORKSCREW_TOTAL_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TotalReset</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">CORKSCREW_TOTAL_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">to_pnp_dev</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">corkscrew_scan</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef __ISAPNP__</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">pnp_cards</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">corkscrew_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">if</span><span class="p">(</span><span class="n">nopnp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_pnp</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">corkscrew_isapnp_adapters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
		<span class="k">while</span><span class="p">((</span><span class="n">idev</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					   <span class="n">corkscrew_isapnp_adapters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
					   <span class="n">corkscrew_isapnp_adapters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">,</span>
					   <span class="n">idev</span><span class="p">)))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_device_attach</span><span class="p">(</span><span class="n">idev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">idev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;pnp activate failed (out of resources?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_device</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">corkscrew_debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ISAPNP reports %s at i/o 0x%x, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">corkscrew_isapnp_adapters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">driver_data</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;3c515 Resource configuration register %#4.4x, DCR %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     		<span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2002</span><span class="p">),</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">));</span>
			<span class="cm">/* irq = inw(ioaddr + 0x2002) &amp; 15; */</span> <span class="cm">/* Use the irq from isapnp */</span>
			<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">pnp_cards</span><span class="o">++</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">corkscrew_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">cards_found</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">cleanup_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">no_pnp:</span>
<span class="cp">#endif </span><span class="cm">/* __ISAPNP__ */</span><span class="cp"></span>

	<span class="cm">/* Check all locations on the ISA bus -- evil! */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">ioaddr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_device</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;3c515 Resource configuration register %#4.4x, DCR %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2002</span><span class="p">),</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">corkscrew_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cards_found</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">cleanup_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">corkscrew_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">corkscrew_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">corkscrew_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">corkscrew_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">corkscrew_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">corkscrew_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eeprom</span><span class="p">[</span><span class="mh">0x40</span><span class="p">],</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* EEPROM contents */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2002</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2002</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">product_name</span> <span class="o">=</span> <span class="s">&quot;3c515&quot;</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">our_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">card_number</span> <span class="o">&gt;=</span> <span class="n">MAX_UNITS</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">card_number</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_corkscrew_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: 3Com %s at %#3x,&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Read the station address from the EEPROM. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be16</span> <span class="o">*</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">EEPROM_Read</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn0EepromCmd</span><span class="p">);</span>
		<span class="cm">/* Pause for at least 162 us. for the read to take place. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">timer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timer</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">162</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn0EepromCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn0EepromData</span><span class="p">);</span>
		<span class="n">checksum</span> <span class="o">^=</span> <span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">^</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; ***INVALID CHECKSUM %4.4x*** &quot;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x11c7</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Corkscrew */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;3c515&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, DMA %d allocation failed&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, DMA %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="cm">/* Tell them about an invalid IRQ. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot; *** Warning: this IRQ is unlikely to work! ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">ram_split</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;5:3&quot;</span><span class="p">,</span> <span class="s">&quot;3:1&quot;</span><span class="p">,</span> <span class="s">&quot;1:1&quot;</span><span class="p">,</span> <span class="s">&quot;3:5&quot;</span>
		<span class="p">};</span>
		<span class="n">__u32</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Options</span><span class="p">);</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  Internal config register is %4.4x, transceivers %#x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">config</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Options</span><span class="p">));</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  %dK %s-wide RAM %s Rx:Tx split, %s%s interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="n">Ram_size</span><span class="p">,</span>
			<span class="n">config</span> <span class="o">&amp;</span> <span class="n">Ram_width</span> <span class="o">?</span> <span class="s">&quot;word&quot;</span> <span class="o">:</span> <span class="s">&quot;byte&quot;</span><span class="p">,</span>
			<span class="n">ram_split</span><span class="p">[(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">Ram_split</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">Ram_split_shift</span><span class="p">],</span>
			<span class="n">config</span> <span class="o">&amp;</span> <span class="n">Autoselect</span> <span class="o">?</span> <span class="s">&quot;autoselect/&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">media_tbl</span><span class="p">[(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">Xcvr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">Xcvr_shift</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">Xcvr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">Xcvr_shift</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">autoselect</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="n">Autoselect</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  Media override to transceiver type %d (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">,</span>
		       <span class="n">media_tbl</span><span class="p">[</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Rx is broken at 10mbps, so we always disable it. */</span>
	<span class="cm">/* vp-&gt;full_bus_master_rx = 0; */</span>
	<span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The 3c51x-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">400</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">corkscrew_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Before initializing select the active media port. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_MAC_Ctrl</span><span class="p">);</span>	<span class="cm">/* Set the full-duplex bit. */</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Media override to transceiver %d (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">,</span>
				<span class="n">media_tbl</span><span class="p">[</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">media_override</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">autoselect</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Find first available media type, starting with 100baseTx. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">&amp;</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mask</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Initial media type %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">wait</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">corkscrew_timer</span><span class="p">;</span>	<span class="cm">/* timer handler */</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Xcvr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&lt;&lt;</span> <span class="n">Xcvr_shift</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: corkscrew_open() InternalConfig %8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">RxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="cm">/* Wait a few ticks for the RxReset command to complete. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="cm">/* Use the now-standard shared IRQ implementation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">==</span> <span class="mh">0x11c7</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Corkscrew: Cannot share ISA resources. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">corkscrew_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">corkscrew_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			       <span class="n">vp</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: corkscrew_open() irq %d media status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn4_Media</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Set the station address and mask in window 2 each time opened. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="cm">/* Start the thinnet transceiver. We should really wait 50ms... */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">StartCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn4_Media</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Media_10TP</span> <span class="o">|</span> <span class="n">Media_SQE</span><span class="p">))</span> <span class="o">|</span>
	     <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">media_bits</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn4_Media</span><span class="p">);</span>

	<span class="cm">/* Switch to the stats window, and clear all stats by reading. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* New: On the Vortex we must also clear the BadSSD counter. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* ..and on the Boomerang we enable the extra statistics bits. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn4_NetDiag</span><span class="p">);</span>

	<span class="cm">/* Switch to register set 7 for normal use. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Boomerang bus master. */</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:  Filling in the Rx ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span>
				    <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Clear complete bit. */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">PKT_BUF_SZ</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Bad news!  */</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span>
				<span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>	<span class="cm">/* Wrap the ring. */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UpListPtr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Boomerang bus master Tx. */</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">PKT_BUF_SZ</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFreeThreshold</span><span class="p">);</span>	<span class="cm">/* Room for a packet. */</span>
		<span class="cm">/* Clear the Tx ring. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Set receiver mode: presumably accept b-case and phys addr only. */</span>
	<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>	<span class="cm">/* Turn on statistics. */</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>	<span class="cm">/* Enable the receiver. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>	<span class="cm">/* Enable transmitter. */</span>
	<span class="cm">/* Allow status bits to be seen. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="n">AdapterFailure</span> <span class="o">|</span> <span class="n">IntReq</span> <span class="o">|</span> <span class="n">StatsFull</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span> <span class="o">?</span> <span class="n">DownComplete</span> <span class="o">:</span> <span class="n">TxAvailable</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span> <span class="o">?</span> <span class="n">UpComplete</span> <span class="o">:</span> <span class="n">RxComplete</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">?</span> <span class="n">DMADone</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="cm">/* Ack all pending events, and set active indicator mask. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntLatch</span> <span class="o">|</span> <span class="n">TxAvailable</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">IntReq</span><span class="p">,</span>
	     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="n">IntLatch</span> <span class="o">|</span> <span class="n">TxAvailable</span> <span class="o">|</span> <span class="n">RxComplete</span> <span class="o">|</span> <span class="n">StatsFull</span>
	     <span class="o">|</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span> <span class="o">?</span> <span class="n">DMADone</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">UpComplete</span> <span class="o">|</span> <span class="n">DownComplete</span><span class="p">,</span>
	     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">corkscrew_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef AUTOMEDIA</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection timer tick happened, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">old_window</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">media_status</span><span class="p">;</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">media_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn4_Media</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* 10baseT, 100baseTX, 100baseFX  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">media_status</span> <span class="o">&amp;</span> <span class="n">Media_LnkBeat</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media %s has link beat, %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
						<span class="n">media_status</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media %s is has no link beat, %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
					<span class="n">media_status</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* Other media types handled by Tx timeouts. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media %s is has no indication, %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
					<span class="n">media_status</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__u32</span> <span class="n">config</span><span class="p">;</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span>
				    <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">available_media</span> <span class="o">&amp;</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mask</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Go back to default. */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">default_media</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection failing, using default %s port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection failed, now trying %s port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">wait</span><span class="p">;</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">outw</span><span class="p">((</span><span class="n">media_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Media_10TP</span> <span class="o">|</span> <span class="n">Media_SQE</span><span class="p">))</span> <span class="o">|</span>
			     <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">media_bits</span><span class="p">,</span>
			     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn4_Media</span><span class="p">);</span>

			<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Config</span><span class="p">);</span>
			<span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Xcvr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">&lt;&lt;</span> <span class="n">Xcvr_shift</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn3_Config</span><span class="p">);</span>

			<span class="n">outw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">StartCoax</span> <span class="o">:</span> <span class="n">StopCoax</span><span class="p">,</span>
			     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">EL3WINDOW</span><span class="p">(</span><span class="n">old_window</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Media selection timer finished, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">media_tbl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* AUTOMEDIA */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">corkscrew_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: transmit timed out, tx_status %2.2x status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">),</span>
	       <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">));</span>
	<span class="cm">/* Slight code bloat to be user friendly. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x88</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Transmitter encountered 16 collisions --&quot;</span>
		       <span class="s">&quot; network cable problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifndef final_version</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  Flags; bus-master %d, full %d; dirty %d current %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span>
	       <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  Down list %8.8x vs. %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  %d: %p  length %8.8x status %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Issue TX_RESET and TX_START commands. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">corkscrew_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* Block a timer-based transmit from overlapping. */</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* BOOMERANG bus-master */</span>
		<span class="cm">/* Calculate the next Tx descriptor entry. */</span>
		<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">boom_tx_desc</span> <span class="o">*</span><span class="n">prev_entry</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">)</span>	<span class="cm">/* No room to transmit with */</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">prev_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">prev_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Trying to send a packet, Tx index %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>
		<span class="cm">/* vp-&gt;tx_full = 1; */</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">DownStall</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="cm">/* Wait for the stall to complete. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev_entry</span><span class="p">)</span>
			<span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">]),</span>
			     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>
			<span class="n">queued_packet</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">DownUnstall</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Clear previous interrupt enable. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_entry</span><span class="p">)</span>
				<span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Put out the doubleword header... */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="cp">#ifdef VORTEX_BUS_MASTER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the bus-master controller to transfer the packet. */</span>
		<span class="n">outl</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterAddr</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterLen</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">StartDMADown</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="cm">/* queue will be woken at the DMADone interrupt. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ... and the packet rounded to a doubleword. */</span>
		<span class="n">outsl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* Interrupt us when the FIFO has room for max-sized packet. */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">SetTxThreshold</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1536</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span>
			     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cm">/* ... and the packet rounded to a doubleword. */</span>
	<span class="n">outsl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_FIFO</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxFree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Interrupt us when the FIFO has room for max-sized packet. */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">SetTxThreshold</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1536</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* bus master */</span><span class="cp"></span>


	<span class="cm">/* Clear the Tx status stack. */</span>
	<span class="p">{</span>
		<span class="kt">short</span> <span class="n">tx_status</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* A Tx-disabling error occurred.  */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Tx error, status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
					<span class="n">outw</span><span class="p">(</span><span class="n">TxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">TxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">);</span>	<span class="cm">/* Pop the status stack. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">corkscrew_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Use the now-standard shared IRQ implementation. */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">latency</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">latency</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Timer</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: interrupt, status %4.4x, timer %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">latency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">donedidthis</span><span class="p">;</span>
		<span class="cm">/* Some interrupt controllers store a bogus interrupt from boot-time.</span>
<span class="cm">		   Ignore a single early interrupt, but don&#39;t hang the machine for</span>
<span class="cm">		   other interrupt problems. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">donedidthis</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Bogus interrupt, bailing. Status %4.4x, start=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: In interrupt loop, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxComplete</span><span class="p">)</span>
			<span class="n">corkscrew_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxAvailable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;	TX room bit was handled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* There&#39;s room in the FIFO for a full-sized packet. */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">TxAvailable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DownComplete</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">)</span> <span class="o">==</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">]))</span>
					<span class="k">break</span><span class="p">;</span>	<span class="cm">/* It still hasn&#39;t been processed. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dirty_tx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">dirty_tx</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">DownComplete</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&lt;=</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef VORTEX_BUS_MASTER</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DMADone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outw</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Wn7_MasterStatus</span><span class="p">);</span>	<span class="cm">/* Ack the event. */</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>	<span class="cm">/* Release the transferred buffer */</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UpComplete</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boomerang_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">UpComplete</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AdapterFailure</span> <span class="o">|</span> <span class="n">RxEarly</span> <span class="o">|</span> <span class="n">StatsFull</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Handle all uncommon interrupts at once. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxEarly</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Rx early is unused. */</span>
				<span class="n">corkscrew_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">RxEarly</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">StatsFull</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Empty statistics. */</span>
				<span class="k">static</span> <span class="kt">int</span> <span class="n">DoneDidThat</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Updating stats.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">update_stats</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="cm">/* DEBUG HACK: Disable statistics as an interrupt source. */</span>
				<span class="cm">/* This occurs when we have the wrong media type! */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">DoneDidThat</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">StatsFull</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">win</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
					<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: Updating stats failed, disabling stats as an interrupt source.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">win</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">win</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">EL3WINDOW</span><span class="p">(</span><span class="n">win</span><span class="p">);</span>
						<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Vortex window %d:&quot;</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span>
							<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %2.2x&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>
						<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
					<span class="n">outw</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="n">TxAvailable</span> <span class="o">|</span>
					     <span class="n">RxComplete</span> <span class="o">|</span> <span class="n">AdapterFailure</span> <span class="o">|</span>
					     <span class="n">UpComplete</span> <span class="o">|</span> <span class="n">DownComplete</span> <span class="o">|</span>
					     <span class="n">TxComplete</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
					<span class="n">DoneDidThat</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AdapterFailure</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Adapter failure requires Rx reset and reinit. */</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">RxReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
				<span class="cm">/* Set the Rx filter to the current state. */</span>
				<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>	<span class="cm">/* Re-enable the receiver. */</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">AdapterFailure</span><span class="p">,</span>
				     <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Too much work in interrupt, status %4.4x. Disabling functions (%4.4x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FE</span><span class="p">));</span>
			<span class="cm">/* Disable all pending interrupts. */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">SetStatusEnb</span> <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FE</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="mh">0x7FF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Acknowledge the IRQ. */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">AckIntr</span> <span class="o">|</span> <span class="n">IntReq</span> <span class="o">|</span> <span class="n">IntLatch</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IntLatch</span> <span class="o">|</span> <span class="n">RxComplete</span><span class="p">));</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: exiting interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">corkscrew_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rx_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;   In rx_packet(), status %4.4x, rx_status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">),</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStatus</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStatus</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Error, update stats. */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_error</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxErrors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; Rx error: status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rx_error</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The packet length: up to 4.5K!. */</span>
			<span class="kt">short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receiving packet size %d status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">pkt_len</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
				<span class="cm">/* &#39;skb_put()&#39; points to the start of sk_buff data area. */</span>
				<span class="n">insl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_FIFO</span><span class="p">,</span>
				     <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
				     <span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">RxDiscard</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>	<span class="cm">/* Pop top Rx packet. */</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
				<span class="cm">/* Wait a limited time to go to next packet. */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Couldn&#39;t allocate a sk_buff of size %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">RxDiscard</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Wait a limited time to skip this packet. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdInProgress</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">boomerang_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;   In boomerang_rx(), status %4.4x, rx_status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">),</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxStatus</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RxDComplete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxDError</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Error, update stats. */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_error</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; Rx error: status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rx_error</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_error</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The packet length: up to 4.5K!. */</span>
			<span class="kt">short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receiving packet size %d status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">pkt_len</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>

			<span class="cm">/* Check if the packet is long enough to just accept without</span>
<span class="cm">			   copying to a properly sized skbuff. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">rx_copybreak</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
				<span class="cm">/* &#39;skb_put()&#39; points to the start of sk_buff data area. */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
				       <span class="n">isa_bus_to_virt</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span>
						   <span class="n">addr</span><span class="p">),</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">rx_copy</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
				<span class="cm">/* Pass up the skbuff already on the Rx ring. */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="cm">/* Remove this checking code for final release. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isa_bus_to_virt</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">)</span>
					<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Warning -- the skbuff addresses do not match&quot;</span>
					     <span class="s">&quot; in boomerang_rx: %p vs. %p / %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					     <span class="n">isa_bus_to_virt</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span>
							 <span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span>
							 <span class="n">addr</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
					     <span class="n">temp</span><span class="p">);</span>
				<span class="n">rx_nocopy</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Refill the Rx ring buffers. */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Bad news!  */</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte boundaries */</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Clear complete bit. */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">corkscrew_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: corkscrew_close() status %4.4x, Tx status %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_STATUS</span><span class="p">),</span>
		     <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStatus</span><span class="p">));</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: corkscrew close stats: rx_nocopy %d rx_copy %d tx_queued %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_nocopy</span><span class="p">,</span> <span class="n">rx_copy</span><span class="p">,</span> <span class="n">queued_packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Turn off statistics ASAP.  We update lp-&gt;stats below. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">StatsDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="cm">/* Disable the receiver and transmitter. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">RxDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TxDisable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">XCVR_10base2</span><span class="p">)</span>
		<span class="cm">/* Turn off thinnet power.  Green! */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">StopCoax</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">SetIntrEnb</span> <span class="o">|</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>

	<span class="n">update_stats</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_rx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Free Boomerang bus master Rx buffers. */</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UpListPtr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">full_bus_master_tx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Free Boomerang bus master Tx buffers. */</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DownListPtr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">corkscrew_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Update statistics.</span>
<span class="cm">	Unlike with the EL3 we need not worry about interrupts changing</span>
<span class="cm">	the window setting from underneath us, but we must still guard</span>
<span class="cm">	against a race condition with a StatsUpdate interrupt updating the</span>
<span class="cm">	table.  This is done by checking that the ASM (!) code generated uses</span>
<span class="cm">	atomic updates with &#39;+=&#39;.</span>
<span class="cm">	*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_stats</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Unlike the 3c5x9 we need not turn off stats updates while reading. */</span>
	<span class="cm">/* Switch to the stats window, and read everything. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Multiple collisions. */</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
						<span class="cm">/* Rx packets   */</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
						<span class="cm">/* Must read to clear */</span>
	<span class="cm">/* Tx deferrals */</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t bother with register 9, an extension of registers 6&amp;7.</span>
<span class="cm">	   If we do use the 6&amp;7 values the atomic update assumption above</span>
<span class="cm">	   is invalid. */</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* Total Rx and Tx octets. */</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* New: On the Vortex we must also clear the BadSSD counter. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* We change back to window 7 (not 1) with the Vortex. */</span>
	<span class="n">EL3WINDOW</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This new version of set_rx_mode() supports v1.4 kernels.</span>
<span class="cm">   The Vortex chip has no documented multicast filter, so the only</span>
<span class="cm">   multicast setting is to receive all multicast frames.  At least</span>
<span class="cm">   the chip has a very clean way to set the mode, unlike many others. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">new_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corkscrew_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Setting promiscuous mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxMulticast</span> <span class="o">|</span> <span class="n">RxBroadcast</span> <span class="o">|</span> <span class="n">RxProm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxMulticast</span> <span class="o">|</span> <span class="n">RxBroadcast</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">SetRxFilter</span> <span class="o">|</span> <span class="n">RxStation</span> <span class="o">|</span> <span class="n">RxBroadcast</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">new_mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EL3_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;ISA 0x%lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netdev_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">corkscrew_debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">corkscrew_debug</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">netdev_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">netdev_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">netdev_set_msglevel</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#ifdef MODULE</span>
<span class="kt">void</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root_corkscrew_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">corkscrew_private</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>

		<span class="n">vp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">root_corkscrew_dev</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">corkscrew_private</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">our_dev</span><span class="p">;</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">cleanup_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
