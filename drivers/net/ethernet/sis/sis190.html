<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sis › sis190.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sis190.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   sis190.c: Silicon Integrated Systems SiS190 ethernet driver</span>

<span class="cm">   Copyright (c) 2003 K.M. Liu &lt;kmliu@sis.com&gt;</span>
<span class="cm">   Copyright (c) 2003, 2004 Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm">   Copyright (c) 2003, 2004, 2005 Francois Romieu &lt;romieu@fr.zoreil.com&gt;</span>

<span class="cm">   Based on r8169.c, tg3.c, 8139cp.c, skge.c, epic100.c and SiS 190/191</span>
<span class="cm">   genuine driver.</span>

<span class="cm">   This software may be used and distributed according to the terms of</span>
<span class="cm">   the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">   Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm">   retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm">   a complete program and may only be used when the entire operating</span>
<span class="cm">   system is licensed under the GPL.</span>

<span class="cm">   See the file COPYING in this distribution for more information.</span>

<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#define PHY_MAX_ADDR		32</span>
<span class="cp">#define PHY_ID_ANY		0x1f</span>
<span class="cp">#define MII_REG_ANY		0x1f</span>

<span class="cp">#define DRV_VERSION		&quot;1.4&quot;</span>
<span class="cp">#define DRV_NAME		&quot;sis190&quot;</span>
<span class="cp">#define SIS190_DRIVER_NAME	DRV_NAME &quot; Gigabit Ethernet driver &quot; DRV_VERSION</span>

<span class="cp">#define sis190_rx_skb			netif_rx</span>
<span class="cp">#define sis190_rx_quota(count, quota)	count</span>

<span class="cp">#define NUM_TX_DESC		64	</span><span class="cm">/* [8..1024] */</span><span class="cp"></span>
<span class="cp">#define NUM_RX_DESC		64	</span><span class="cm">/* [8..8192] */</span><span class="cp"></span>
<span class="cp">#define TX_RING_BYTES		(NUM_TX_DESC * sizeof(struct TxDesc))</span>
<span class="cp">#define RX_RING_BYTES		(NUM_RX_DESC * sizeof(struct RxDesc))</span>
<span class="cp">#define RX_BUF_SIZE		1536</span>
<span class="cp">#define RX_BUF_MASK		0xfff8</span>

<span class="cp">#define SIS190_REGS_SIZE	0x80</span>
<span class="cp">#define SIS190_TX_TIMEOUT	(6*HZ)</span>
<span class="cp">#define SIS190_PHY_TIMEOUT	(10*HZ)</span>
<span class="cp">#define SIS190_MSG_DEFAULT	(NETIF_MSG_DRV | NETIF_MSG_PROBE | \</span>
<span class="cp">				 NETIF_MSG_LINK | NETIF_MSG_IFUP | \</span>
<span class="cp">				 NETIF_MSG_IFDOWN)</span>

<span class="cm">/* Enhanced PHY access register bit definitions */</span>
<span class="cp">#define EhnMIIread		0x0000</span>
<span class="cp">#define EhnMIIwrite		0x0020</span>
<span class="cp">#define EhnMIIdataShift		16</span>
<span class="cp">#define EhnMIIpmdShift		6	</span><span class="cm">/* 7016 only */</span><span class="cp"></span>
<span class="cp">#define EhnMIIregShift		11</span>
<span class="cp">#define EhnMIIreq		0x0010</span>
<span class="cp">#define EhnMIInotDone		0x0010</span>

<span class="cm">/* Write/read MMIO register */</span>
<span class="cp">#define SIS_W8(reg, val)	writeb ((val), ioaddr + (reg))</span>
<span class="cp">#define SIS_W16(reg, val)	writew ((val), ioaddr + (reg))</span>
<span class="cp">#define SIS_W32(reg, val)	writel ((val), ioaddr + (reg))</span>
<span class="cp">#define SIS_R8(reg)		readb (ioaddr + (reg))</span>
<span class="cp">#define SIS_R16(reg)		readw (ioaddr + (reg))</span>
<span class="cp">#define SIS_R32(reg)		readl (ioaddr + (reg))</span>

<span class="cp">#define SIS_PCI_COMMIT()	SIS_R32(IntrControl)</span>

<span class="k">enum</span> <span class="n">sis190_registers</span> <span class="p">{</span>
	<span class="n">TxControl</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">TxDescStartAddr</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">rsv0</span>			<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="c1">// reserved</span>
	<span class="n">TxSts</span>			<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>	<span class="c1">// unused (Control/Status)</span>
	<span class="n">RxControl</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">RxDescStartAddr</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">rsv1</span>			<span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="c1">// reserved</span>
	<span class="n">RxSts</span>			<span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">IntrStatus</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">IntrMask</span>		<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="n">IntrControl</span>		<span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="n">IntrTimer</span>		<span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>	<span class="c1">// unused (Interrupt Timer)</span>
	<span class="n">PMControl</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="c1">// unused (Power Mgmt Control/Status)</span>
	<span class="n">rsv2</span>			<span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="c1">// reserved</span>
	<span class="n">ROMControl</span>		<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="n">ROMInterface</span>		<span class="o">=</span> <span class="mh">0x3c</span><span class="p">,</span>
	<span class="n">StationControl</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">GMIIControl</span>		<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="n">GIoCR</span>			<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span> <span class="c1">// unused (GMAC IO Compensation)</span>
	<span class="n">GIoCtrl</span>			<span class="o">=</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="c1">// unused (GMAC IO Control)</span>
	<span class="n">TxMacControl</span>		<span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">TxLimit</span>			<span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span> <span class="c1">// unused (Tx MAC Timer/TryLimit)</span>
	<span class="n">RGDelay</span>			<span class="o">=</span> <span class="mh">0x58</span><span class="p">,</span> <span class="c1">// unused (RGMII Tx Internal Delay)</span>
	<span class="n">rsv3</span>			<span class="o">=</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="c1">// reserved</span>
	<span class="n">RxMacControl</span>		<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">RxMacAddr</span>		<span class="o">=</span> <span class="mh">0x62</span><span class="p">,</span>
	<span class="n">RxHashTable</span>		<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Undocumented        = 0x6c,</p></td><td class="code"><div class="highlight"><pre>	<span class="n">RxWolCtrl</span>		<span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="n">RxWolData</span>		<span class="o">=</span> <span class="mh">0x74</span><span class="p">,</span> <span class="c1">// unused (Rx WOL Data Access)</span>
	<span class="n">RxMPSControl</span>		<span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>	<span class="c1">// unused (Rx MPS Control)</span>
	<span class="n">rsv4</span>			<span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="c1">// reserved</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sis190_register_content</span> <span class="p">{</span>
	<span class="cm">/* IntrStatus */</span>
	<span class="n">SoftInt</span>			<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">Timeup</span>			<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">PauseFrame</span>		<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">MagicPacket</span>		<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">WakeupFrame</span>		<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">LinkChange</span>		<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
	<span class="n">RxQEmpty</span>		<span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>
	<span class="n">RxQInt</span>			<span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>
	<span class="n">TxQ1Empty</span>		<span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">TxQ1Int</span>			<span class="o">=</span> <span class="mh">0x00000010</span><span class="p">,</span>
	<span class="n">TxQ0Empty</span>		<span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">TxQ0Int</span>			<span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>
	<span class="n">RxHalt</span>			<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>
	<span class="n">TxHalt</span>			<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>

	<span class="cm">/* {Rx/Tx}CmdBits */</span>
	<span class="n">CmdReset</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CmdRxEnb</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>		<span class="c1">// unused</span>
	<span class="n">CmdTxEnb</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">RxBufEmpty</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>		<span class="c1">// unused</span>

	<span class="cm">/* Cfg9346Bits */</span>
	<span class="n">Cfg9346_Lock</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="c1">// unused</span>
	<span class="n">Cfg9346_Unlock</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>		<span class="c1">// unused</span>

	<span class="cm">/* RxMacControl */</span>
	<span class="n">AcceptErr</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>		<span class="c1">// unused</span>
	<span class="n">AcceptRunt</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>		<span class="c1">// unused</span>
	<span class="n">AcceptBroadcast</span>		<span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
	<span class="n">AcceptMulticast</span>		<span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="n">AcceptMyPhys</span>		<span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="n">AcceptAllPhys</span>		<span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>

	<span class="cm">/* RxConfigBits */</span>
	<span class="n">RxCfgFIFOShift</span>		<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">RxCfgDMAShift</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>		<span class="c1">// 0x1a in RxControl ?</span>

	<span class="cm">/* TxConfigBits */</span>
	<span class="n">TxInterFrameGapShift</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="n">TxDMAShift</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="cm">/* DMA burst value (0-7) is shift this many bits */</span>

	<span class="n">LinkStatus</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>		<span class="c1">// unused</span>
	<span class="n">FullDup</span>			<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>		<span class="c1">// unused</span>

	<span class="cm">/* TBICSRBit */</span>
	<span class="n">TBILinkOK</span>		<span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>	<span class="c1">// unused</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">TxDesc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">PSize</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">RxDesc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">PSize</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">_DescStatusBit</span> <span class="p">{</span>
	<span class="cm">/* _Desc.status */</span>
	<span class="n">OWNbit</span>		<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="c1">// RXOWN/TXOWN</span>
	<span class="n">INTbit</span>		<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="c1">// RXINT/TXINT</span>
	<span class="n">CRCbit</span>		<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span> <span class="c1">// CRCOFF/CRCEN</span>
	<span class="n">PADbit</span>		<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="c1">// PREADD/PADEN</span>
	<span class="cm">/* _Desc.size */</span>
	<span class="n">RingEnd</span>		<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>
	<span class="cm">/* TxDesc.status */</span>
	<span class="n">LSEN</span>		<span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="c1">// TSO ? -- FR</span>
	<span class="n">IPCS</span>		<span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>
	<span class="n">TCPCS</span>		<span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>
	<span class="n">UDPCS</span>		<span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span>
	<span class="n">BSTEN</span>		<span class="o">=</span> <span class="mh">0x00800000</span><span class="p">,</span>
	<span class="n">EXTEN</span>		<span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>
	<span class="n">DEFEN</span>		<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
	<span class="n">BKFEN</span>		<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
	<span class="n">CRSEN</span>		<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>
	<span class="n">COLEN</span>		<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
	<span class="n">THOL3</span>		<span class="o">=</span> <span class="mh">0x30000000</span><span class="p">,</span>
	<span class="n">THOL2</span>		<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
	<span class="n">THOL1</span>		<span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">THOL0</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>

	<span class="n">WND</span>		<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>
	<span class="n">TABRT</span>		<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
	<span class="n">FIFO</span>		<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>
	<span class="n">LINK</span>		<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
	<span class="n">ColCountMask</span>	<span class="o">=</span> <span class="mh">0x0000ffff</span><span class="p">,</span>
	<span class="cm">/* RxDesc.status */</span>
	<span class="n">IPON</span>		<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
	<span class="n">TCPON</span>		<span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">UDPON</span>		<span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span>
	<span class="n">Wakup</span>		<span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>
	<span class="n">Magic</span>		<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
	<span class="n">Pause</span>		<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
	<span class="n">DEFbit</span>		<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
	<span class="n">BCAST</span>		<span class="o">=</span> <span class="mh">0x000c0000</span><span class="p">,</span>
	<span class="n">MCAST</span>		<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>
	<span class="n">UCAST</span>		<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
	<span class="cm">/* RxDesc.PSize */</span>
	<span class="n">TAGON</span>		<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>
	<span class="n">RxDescCountMask</span>	<span class="o">=</span> <span class="mh">0x7f000000</span><span class="p">,</span> <span class="c1">// multi-desc pkt when &gt; 1 ? -- FR</span>
	<span class="n">ABORT</span>		<span class="o">=</span> <span class="mh">0x00800000</span><span class="p">,</span>
	<span class="n">SHORT</span>		<span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>
	<span class="n">LIMIT</span>		<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
	<span class="n">MIIER</span>		<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
	<span class="n">OVRUN</span>		<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>
	<span class="n">NIBON</span>		<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
	<span class="n">COLON</span>		<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>
	<span class="n">CRCOK</span>		<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
	<span class="n">RxSizeMask</span>	<span class="o">=</span> <span class="mh">0x0000ffff</span>
	<span class="cm">/*</span>
<span class="cm">	 * The asic could apparently do vlan, TSO, jumbo (sis191 only) and</span>
<span class="cm">	 * provide two (unused with Linux) Tx queues. No publicly</span>
<span class="cm">	 * available documentation alas.</span>
<span class="cm">	 */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sis190_eeprom_access_register_bits</span> <span class="p">{</span>
	<span class="n">EECS</span>	<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">EECLK</span>	<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">EEDO</span>	<span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">EEDI</span>	<span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">EEREQ</span>	<span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>
	<span class="n">EEROP</span>	<span class="o">=</span> <span class="mh">0x00000200</span><span class="p">,</span>
	<span class="n">EEWOP</span>	<span class="o">=</span> <span class="mh">0x00000100</span>	<span class="c1">// unused</span>
<span class="p">};</span>

<span class="cm">/* EEPROM Addresses */</span>
<span class="k">enum</span> <span class="n">sis190_eeprom_address</span> <span class="p">{</span>
	<span class="n">EEPROMSignature</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">EEPROMCLK</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="c1">// unused</span>
	<span class="n">EEPROMInfo</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">EEPROMMACAddr</span>	<span class="o">=</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sis190_feature</span> <span class="p">{</span>
	<span class="n">F_HAS_RGMII</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">F_PHY_88E1111</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">F_PHY_BCM5461</span>	<span class="o">=</span> <span class="mi">4</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sis190_private</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_buf_sz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_tx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dirty_rx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dirty_tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">RxDescRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">TxDescRing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">NUM_RX_DESC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">Tx_skbuff</span><span class="p">[</span><span class="n">NUM_TX_DESC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">phy_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii_if</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">first_phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">negotiated_lpa</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">LNK_OFF</span><span class="p">,</span>
		<span class="n">LNK_ON</span><span class="p">,</span>
		<span class="n">LNK_AUTONEG</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">link_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sis190_phy</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sis190_phy_type</span> <span class="p">{</span>
	<span class="n">UNKNOWN</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">HOME</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">LAN</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">MIX</span>	<span class="o">=</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mii_chip_info</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">feature</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mii_chip_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Atheros PHY&quot;</span><span class="p">,</span>          <span class="p">{</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0xd010</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Atheros PHY AR8012&quot;</span><span class="p">,</span>   <span class="p">{</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0xd020</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom PHY BCM5461&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x60c0</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="n">F_PHY_BCM5461</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom PHY AC131&quot;</span><span class="p">,</span>   <span class="p">{</span> <span class="mh">0x0143</span><span class="p">,</span> <span class="mh">0xbc70</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Agere PHY ET1101B&quot;</span><span class="p">,</span>    <span class="p">{</span> <span class="mh">0x0282</span><span class="p">,</span> <span class="mh">0xf010</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Marvell PHY 88E1111&quot;</span><span class="p">,</span>  <span class="p">{</span> <span class="mh">0x0141</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="n">F_PHY_88E1111</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Realtek PHY RTL8201&quot;</span><span class="p">,</span>  <span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8200</span> <span class="p">},</span> <span class="n">LAN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sis_chip_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;SiS 190 PCI Fast Ethernet adapter&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS 191 PCI Gigabit Ethernet adapter&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">sis190_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0190</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0191</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">sis190_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span> <span class="n">debug</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SiS sis190/191 Gigabit Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;Copy breakpoint for copy-only-tiny-frames&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug verbosity level (0=none, ..., 16=all)&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;K.M. Liu &lt;kmliu@sis.com&gt;, Ueimor &lt;romieu@fr.zoreil.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">sis190_intr_mask</span> <span class="o">=</span>
	<span class="n">RxQEmpty</span> <span class="o">|</span> <span class="n">RxQInt</span> <span class="o">|</span> <span class="n">TxQ1Int</span> <span class="o">|</span> <span class="n">TxQ0Int</span> <span class="o">|</span> <span class="n">RxHalt</span> <span class="o">|</span> <span class="n">TxHalt</span> <span class="o">|</span> <span class="n">LinkChange</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum number of multicast addresses to filter (vs. Rx-all-multicast).</span>
<span class="cm"> * The chips use a 64 element hash table based on the Ethernet CRC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__mdio_cmd</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">GMIIControl</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SIS_R32</span><span class="p">(</span><span class="n">GMIIControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EhnMIInotDone</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PHY command failed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__mdio_cmd</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EhnMIIreq</span> <span class="o">|</span> <span class="n">EhnMIIwrite</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EhnMIIregShift</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="n">EhnMIIpmdShift</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EhnMIIdataShift</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__mdio_cmd</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EhnMIIreq</span> <span class="o">|</span> <span class="n">EhnMIIread</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EhnMIIregShift</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="n">EhnMIIpmdShift</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">SIS_R32</span><span class="p">(</span><span class="n">GMIIControl</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">EhnMIIdataShift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mdio_write</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">mdio_read_latched</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">__devinit</span> <span class="nf">sis190_read_eeprom</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SIS_R32</span><span class="p">(</span><span class="n">ROMControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">ROMInterface</span><span class="p">,</span> <span class="n">EEREQ</span> <span class="o">|</span> <span class="n">EEROP</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SIS_R32</span><span class="p">(</span><span class="n">ROMInterface</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEREQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIS_R32</span><span class="p">(</span><span class="n">ROMInterface</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_irq_mask_and_ack</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">SIS_PCI_COMMIT</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_asic_down</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Stop the chip&#39;s Tx and Rx DMA processes. */</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">TxControl</span><span class="p">,</span> <span class="mh">0x1a00</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxControl</span><span class="p">,</span> <span class="mh">0x1a00</span><span class="p">);</span>

	<span class="n">sis190_irq_mask_and_ack</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_mark_as_last_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RingEnd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sis190_give_to_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_buf_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eor</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RingEnd</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">PSize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">rx_buf_sz</span> <span class="o">&amp;</span> <span class="n">RX_BUF_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">eor</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">OWNbit</span> <span class="o">|</span> <span class="n">INTbit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sis190_map_to_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">rx_buf_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="n">sis190_give_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sis190_make_unusable_by_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">PSize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RingEnd</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">sis190_alloc_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skb_alloc_failed</span><span class="p">;</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
			<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">sis190_map_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">skb_alloc_failed:</span>
	<span class="n">sis190_make_unusable_by_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sis190_rx_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cur</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">cur</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">%</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sis190_alloc_rx_skb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cur</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">sis190_try_rx_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">sk_buff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pkt_size</span><span class="p">,</span>
			       <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_size</span> <span class="o">&gt;=</span> <span class="n">rx_copybreak</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
				<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sk_buff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sis190_rx_pkt_err</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ErrMask	(OVRUN | SHORT | LIMIT | MIIER | NIBON | COLON | ABORT)</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CRCOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ErrMask</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CRCOK</span><span class="p">))</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OVRUN</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SHORT</span> <span class="o">|</span> <span class="n">LIMIT</span><span class="p">))</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MIIER</span> <span class="o">|</span> <span class="n">NIBON</span> <span class="o">|</span> <span class="n">COLON</span><span class="p">))</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_left</span><span class="p">,</span> <span class="n">cur_rx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delta</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">rx_left</span> <span class="o">=</span> <span class="n">NUM_RX_DESC</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">-</span> <span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">rx_left</span> <span class="o">=</span> <span class="n">sis190_rx_quota</span><span class="p">(</span><span class="n">rx_left</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">quota</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">rx_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_left</span><span class="o">--</span><span class="p">,</span> <span class="n">cur_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">cur_rx</span> <span class="o">%</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OWNbit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">PSize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>netif_info(tp, intr, dev, "Rx PSize = %08x\n", status);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">sis190_rx_pkt_err</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sis190_give_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
			<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">pkt_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxSizeMask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pkt_size</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;(frag) status = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sis190_give_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">sis190_try_rx_copy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">sis190_give_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
						 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">sis190_make_unusable_by_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="n">sis190_rx_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BCAST</span><span class="p">)</span> <span class="o">==</span> <span class="n">MCAST</span><span class="p">)</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">cur_rx</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">cur_rx</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">sis190_rx_fill</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no Rx buffer allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span>
		<span class="n">netif_emerg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx buffers exhausted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_unmap_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span> <span class="o">?</span> <span class="n">ETH_ZLEN</span> <span class="o">:</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sis190_tx_pkt_err</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define TxErrMask	(WND | TABRT | FIFO | LINK)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxErrMask</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">WND</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TABRT</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FIFO</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_tx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pending</span><span class="p">,</span> <span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * It would not be needed if queueing was allowed to be enabled</span>
<span class="cm">	 * again too early (hint: think preempt and unclocked smp systems).</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue_stopped</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="n">pending</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span><span class="p">;</span>
	<span class="n">queue_stopped</span> <span class="o">=</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="n">NUM_TX_DESC</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">pending</span><span class="p">;</span> <span class="n">pending</span><span class="o">--</span><span class="p">,</span> <span class="n">dirty_tx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OWNbit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">Tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sis190_tx_pkt_err</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ColCountMask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sis190_unmap_tx_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">Tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">!=</span> <span class="n">dirty_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">dirty_tx</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_stopped</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The interrupt handler does all of the Rx thread work and cleans up after</span>
<span class="cm"> * the Tx thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sis190_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">__dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">SIS_R32</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sis190_asic_down</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>netif_info(tp, intr, dev, "status = %08x\n", status);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LinkChange</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxQInt</span><span class="p">)</span>
		<span class="n">sis190_rx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxQ0Int</span><span class="p">)</span>
		<span class="n">sis190_tx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">sis190_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_free_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">sk_buff</span><span class="p">,</span> <span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="o">*</span><span class="n">sk_buff</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sk_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sis190_make_unusable_by_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_rx_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sis190_free_rx_skb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_init_ring_indexes</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sis190_init_ring_indexes</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Tx_skbuff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">NUM_TX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_skbuff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">NUM_RX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sis190_rx_fill</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NUM_RX_DESC</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NUM_RX_DESC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rx_clear</span><span class="p">;</span>

	<span class="n">sis190_mark_as_last_descriptor</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_rx_clear:</span>
	<span class="n">sis190_rx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Multicast hash filter */</span>
	<span class="n">u16</span> <span class="n">rx_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_mode</span> <span class="o">=</span>
			<span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span> <span class="o">|</span>
			<span class="n">AcceptAllPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to filter perfectly -- accept all multicasts. */</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bit_nr</span> <span class="o">=</span>
				<span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
			<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptMulticast</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">SIS_W16</span><span class="p">(</span><span class="n">RxMacControl</span><span class="p">,</span> <span class="n">rx_mode</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxHashTable</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxHashTable</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_soft_reset</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrControl</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">SIS_PCI_COMMIT</span><span class="p">();</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrControl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">sis190_asic_down</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_hw_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">sis190_soft_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">TxDescStartAddr</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxDescStartAddr</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">GMIIControl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">TxMacControl</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">SIS_W16</span><span class="p">(</span><span class="n">RxMacControl</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxHashTable</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxWolCtrl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxWolData</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">SIS_PCI_COMMIT</span><span class="p">();</span>

	<span class="n">sis190_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable all known interrupts by setting the interrupt mask. */</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="n">sis190_intr_mask</span><span class="p">);</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">TxControl</span><span class="p">,</span> <span class="mh">0x1a00</span> <span class="o">|</span> <span class="n">CmdTxEnb</span><span class="p">);</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RxControl</span><span class="p">,</span> <span class="mh">0x1a1d</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_phy_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sis190_private</span><span class="p">,</span> <span class="n">phy_task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>FIXME: needlessly high ?  -- FR 02/07/2005</p></td><td class="code"><div class="highlight"><pre>		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdio_read_latched</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMSR_ANEGCOMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">!=</span> <span class="n">LNK_AUTONEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;auto-negotiating...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">LNK_AUTONEG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">!=</span> <span class="n">LNK_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Rejoice ! */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">ctl</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">reg31</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="n">LPA_1000FULL</span><span class="p">,</span> <span class="mh">0x07000c00</span> <span class="o">|</span> <span class="mh">0x00001000</span><span class="p">,</span>
				<span class="s">&quot;1000 Mbps Full Duplex&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">LPA_1000HALF</span><span class="p">,</span> <span class="mh">0x07000c00</span><span class="p">,</span>
				<span class="s">&quot;1000 Mbps Half Duplex&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">LPA_100FULL</span><span class="p">,</span> <span class="mh">0x04000800</span> <span class="o">|</span> <span class="mh">0x00001000</span><span class="p">,</span>
				<span class="s">&quot;100 Mbps Full Duplex&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">LPA_100HALF</span><span class="p">,</span> <span class="mh">0x04000800</span><span class="p">,</span>
				<span class="s">&quot;100 Mbps Half Duplex&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">LPA_10FULL</span><span class="p">,</span> <span class="mh">0x04000400</span> <span class="o">|</span> <span class="mh">0x00001000</span><span class="p">,</span>
				<span class="s">&quot;10 Mbps Full Duplex&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">LPA_10HALF</span><span class="p">,</span> <span class="mh">0x04000400</span><span class="p">,</span>
				<span class="s">&quot;10 Mbps Half Duplex&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x04000400</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span> <span class="p">}</span>
		<span class="p">},</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">adv</span><span class="p">,</span> <span class="n">autoexp</span><span class="p">,</span> <span class="n">gigadv</span><span class="p">,</span> <span class="n">gigrec</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mii ext = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">);</span>
		<span class="n">adv</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
		<span class="n">autoexp</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_EXPANSION</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mii lpa=%04x adv=%04x exp=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">val</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">autoexp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LPA_NPAGE</span> <span class="o">&amp;&amp;</span> <span class="n">autoexp</span> <span class="o">&amp;</span> <span class="n">EXPANSION_NWAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* check for gigabit speed */</span>
			<span class="n">gigadv</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">);</span>
			<span class="n">gigrec</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">gigadv</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gigrec</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">reg31</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000HALF</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">reg31</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">adv</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">reg31</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">|=</span> <span class="n">SIS_R32</span><span class="p">(</span><span class="n">StationControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f001c00</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">F_HAS_RGMII</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">F_PHY_BCM5461</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Set Tx Delay in RGMII mode.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xf1c7</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x8c00</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">|=</span> <span class="mh">0x03000000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SIS_W32</span><span class="p">(</span><span class="n">StationControl</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">F_HAS_RGMII</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RGDelay</span><span class="p">,</span> <span class="mh">0x0441</span><span class="p">);</span>
			<span class="n">SIS_W32</span><span class="p">(</span><span class="n">RGDelay</span><span class="p">,</span> <span class="mh">0x0440</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">negotiated_lpa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>

		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link on %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">LNK_ON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">!=</span> <span class="n">LNK_AUTONEG</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">LNK_OFF</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SIS190_PHY_TIMEOUT</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_phy_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">__opaque</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sis190_delete_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sis190_request_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SIS190_PHY_TIMEOUT</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">sis190_phy_timer</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_set_rxbufsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">RX_BUF_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">:</span> <span class="n">RX_BUF_SIZE</span><span class="p">;</span>
	<span class="cm">/* RxDesc-&gt;size has a licence to kill the lower bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&amp;=</span> <span class="n">RX_BUF_MASK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sis190_set_rxbufsize</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rx and Tx descriptors need 256 bytes alignment.</span>
<span class="cm">	 * pci_alloc_consistent() guarantees a stronger alignment.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_RING_BYTES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_RING_BYTES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_tx_0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sis190_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_rx_1</span><span class="p">;</span>

	<span class="n">sis190_request_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sis190_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_timer_2</span><span class="p">;</span>

	<span class="n">sis190_hw_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_release_timer_2:</span>
	<span class="n">sis190_delete_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sis190_rx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="nl">err_free_rx_1:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>
<span class="nl">err_free_tx_0:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_tx_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">Tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sis190_unmap_tx_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">Tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">poll_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sis190_delete_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">sis190_asic_down</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">poll_locked</span><span class="p">)</span>
			<span class="n">poll_locked</span><span class="o">++</span><span class="p">;</span>

		<span class="n">synchronize_sched</span><span class="p">();</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">SIS_R32</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">));</span>

	<span class="n">sis190_tx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">sis190_rx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">sis190_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescRing</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">sis190_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">dirty_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescRing</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OWNbit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;BUG! Tx Ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;PCI mapping failed, dropping packet&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">Tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">PSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="p">(</span><span class="n">NUM_TX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RingEnd</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">OWNbit</span> <span class="o">|</span> <span class="n">INTbit</span> <span class="o">|</span> <span class="n">DEFbit</span> <span class="o">|</span> <span class="n">CRCbit</span> <span class="o">|</span> <span class="n">PADbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">negotiated_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_1000HALF</span> <span class="o">|</span> <span class="n">LPA_100HALF</span> <span class="o">|</span> <span class="n">LPA_10HALF</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Half Duplex */</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">COLEN</span> <span class="o">|</span> <span class="n">CRSEN</span> <span class="o">|</span> <span class="n">BKFEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">negotiated_lpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LPA_1000HALF</span> <span class="o">|</span> <span class="n">LPA_1000FULL</span><span class="p">))</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXTEN</span> <span class="o">|</span> <span class="n">BSTEN</span><span class="p">);</span> <span class="cm">/* gigabit HD */</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">TxControl</span><span class="p">,</span> <span class="mh">0x1a00</span> <span class="o">|</span> <span class="n">CmdReset</span> <span class="o">|</span> <span class="n">CmdTxEnb</span><span class="p">);</span>

	<span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">NUM_TX_DESC</span><span class="p">)</span> <span class="o">==</span> <span class="n">dirty_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">smp_rmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dirty_tx</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_free_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">first_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_phy</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">first_phy</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sis190_default_phy - Select default PHY for sis190 mac.</span>
<span class="cm"> *	@dev: the net device to probe for</span>
<span class="cm"> *</span>
<span class="cm"> *	Select first detected PHY with link as default.</span>
<span class="cm"> *	If no one is link on, select PHY whose types is HOME as default.</span>
<span class="cm"> *	If HOME doesn&#39;t exist, select LAN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">sis190_default_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="o">*</span><span class="n">phy_home</span><span class="p">,</span> <span class="o">*</span><span class="n">phy_default</span><span class="p">,</span> <span class="o">*</span><span class="n">phy_lan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="o">*</span><span class="n">mii_if</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">phy_home</span> <span class="o">=</span> <span class="n">phy_default</span> <span class="o">=</span> <span class="n">phy_lan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mdio_read_latched</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Link ON &amp; Not select default PHY &amp; not ghost PHY.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">phy_default</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phy_default</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
				   <span class="n">status</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ISOLATE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HOME</span><span class="p">)</span>
				<span class="n">phy_home</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LAN</span><span class="p">)</span>
				<span class="n">phy_lan</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_default</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_home</span><span class="p">)</span>
			<span class="n">phy_default</span> <span class="o">=</span> <span class="n">phy_home</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_lan</span><span class="p">)</span>
			<span class="n">phy_default</span> <span class="o">=</span> <span class="n">phy_lan</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy_default</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">sis190_phy</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">!=</span> <span class="n">phy_default</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_default</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Using transceiver at address %d as default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">BMCR_ISOLATE</span><span class="p">);</span>

	<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mdio_read_latched</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sis190_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">mii_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_chip_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">mii_status</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">mii_chip_table</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MIX</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">((</span><span class="n">mii_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMSR_100FULL</span> <span class="o">|</span> <span class="n">BMSR_100HALF</span><span class="p">))</span> <span class="o">?</span>
				<span class="n">LAN</span> <span class="o">:</span> <span class="n">HOME</span><span class="p">)</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s transceiver at address %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unknown PHY 0x%x:0x%x transceiver at address %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_mii_probe_88e1111_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">F_PHY_88E1111</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">phy_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x808b</span><span class="p">,</span> <span class="mh">0x0ce1</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x808f</span><span class="p">,</span> <span class="mh">0x0c60</span> <span class="p">}</span>
		<span class="p">},</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">F_HAS_RGMII</span><span class="p">)</span> <span class="o">?</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sis190_mii_probe - Probe MII PHY for sis190</span>
<span class="cm"> *	@dev: the net device to probe for</span>
<span class="cm"> *</span>
<span class="cm"> *	Search for total of 32 possible mii phy addresses.</span>
<span class="cm"> *	Identify and set current phy if found one,</span>
<span class="cm"> *	return error if it failed to found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis190_mii_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="o">*</span><span class="n">mii_if</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy_id</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="n">phy_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sis190_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">mdio_read_latched</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Try next mii if the current one is not accessible.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">phy</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sis190_free_phy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sis190_init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: No MII transceivers found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select default PHY for mac */</span>
	<span class="n">sis190_default_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sis190_mii_probe_88e1111_fixup</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">__mdio_read</span><span class="p">;</span>
	<span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">__mdio_write</span><span class="p">;</span>
	<span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="n">PHY_ID_ANY</span><span class="p">;</span>
	<span class="n">mii_if</span><span class="o">-&gt;</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="n">MII_REG_ANY</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_mii_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sis190_free_phy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">first_phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_release_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">sis190_init_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="n">SIS190_MSG_DEFAULT</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: enable failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_free_dev_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: region #0 is no MMIO resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_pci_disable_2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SIS190_REGS_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid PCI region size(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_pci_disable_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: could not request regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_pci_disable_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: DMA configuration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_free_res_3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">SIS190_REGS_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot remap MMIO, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_res_3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">LNK_OFF</span><span class="p">;</span>

	<span class="n">sis190_irq_mask_and_ack</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">sis190_soft_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">err_free_res_3:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_pci_disable_2:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_free_dev_1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_0:</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>

	<span class="cm">/* Disable Tx, if not already */</span>
	<span class="n">tmp8</span> <span class="o">=</span> <span class="n">SIS_R8</span><span class="p">(</span><span class="n">TxControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">CmdTxEnb</span><span class="p">)</span>
		<span class="n">SIS_W8</span><span class="p">(</span><span class="n">TxControl</span><span class="p">,</span> <span class="n">tmp8</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CmdTxEnb</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit timeout, status %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">SIS_R32</span><span class="p">(</span><span class="n">TxControl</span><span class="p">),</span> <span class="n">SIS_R32</span><span class="p">(</span><span class="n">TxSts</span><span class="p">));</span>

	<span class="cm">/* Disable interrupts by clearing the interrupt mask. */</span>
	<span class="n">SIS_W32</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Stop a shared interrupt from scavenging while we are. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sis190_tx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* ...and finally, reset everything. */</span>
	<span class="n">sis190_hw_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_set_rgmii</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="n">F_HAS_RGMII</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis190_get_mac_addr_from_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Read MAC address from EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="cm">/* Check to see if there is a sane EEPROM */</span>
	<span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">sis190_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEPROMSignature</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Error EEPROM read %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">sig</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get MAC address from EEPROM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span> <span class="o">=</span> <span class="n">sis190_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEPROMMACAddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sis190_set_rgmii</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">sis190_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEPROMInfo</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sis190_get_mac_addr_from_apc - Get MAC address for SiS96x model</span>
<span class="cm"> *	@pdev: PCI device</span>
<span class="cm"> *	@dev:  network device to get address for</span>
<span class="cm"> *</span>
<span class="cm"> *	SiS96x model, use APC CMOS RAM to store MAC address.</span>
<span class="cm"> *	APC CMOS RAM is accessed through ISA bridge.</span>
<span class="cm"> *	MAC address is read into @net_dev-&gt;dev_addr.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis190_get_mac_addr_from_apc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">__devinitdata</span> <span class="n">ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0965</span><span class="p">,</span> <span class="mh">0x0966</span><span class="p">,</span> <span class="mh">0x0968</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">isa_bridge</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Read MAC address from APC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isa_bridge</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isa_bridge</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isa_bridge</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Can not find ISA bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable port 78h &amp; 79h to access APC Registers. */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">isa_bridge</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">isa_bridge</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">isa_bridge</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">outb</span><span class="p">(</span><span class="mh">0x9</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x79</span><span class="p">);</span>
        <span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x79</span><span class="p">);</span>

	<span class="n">sis190_set_rgmii</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Restore the value to ISA Bridge */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">isa_bridge</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">isa_bridge</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      sis190_init_rxfilter - Initialize the Rx filter</span>
<span class="cm"> *      @dev: network device to initialize</span>
<span class="cm"> *</span>
<span class="cm"> *      Set receive filter address to our MAC address</span>
<span class="cm"> *      and enable packet filtering.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sis190_init_rxfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">SIS_R16</span><span class="p">(</span><span class="n">RxMacControl</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable packet filtering before setting filter.</span>
<span class="cm">	 * Note: SiS&#39;s driver writes 32 bits but RxMacControl is 16 bits</span>
<span class="cm">	 * only and followed by RxMacAddr (6 bytes). Strange. -- FR</span>
<span class="cm">	 */</span>
	<span class="n">SIS_W16</span><span class="p">(</span><span class="n">RxMacControl</span><span class="p">,</span> <span class="n">ctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f00</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">SIS_W8</span><span class="p">(</span><span class="n">RxMacAddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">SIS_W16</span><span class="p">(</span><span class="n">RxMacControl</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">SIS_PCI_COMMIT</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis190_get_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sis190_get_mac_addr_from_eeprom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sis190_get_mac_addr_from_apc</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_set_speed_auto</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling Auto-negotiation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Enable 10/100 Full/Half Mode, leave MII_ADVERTISE bit4:0
unchanged.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_SLCT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">ADVERTISE_100FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">|</span>
		   <span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10HALF</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Enable 1000 Full Mode.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Enable auto-negotiation and restart auto-negotiation.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
		   <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span> <span class="o">|</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">SIS190_REGS_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">SIS190_REGS_SIZE</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">SIS190_REGS_SIZE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sis190_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis190_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">sis190_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">sis190_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">sis190_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">sis190_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>	<span class="o">=</span> <span class="n">sis190_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>	<span class="o">=</span> <span class="n">sis190_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>	<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>	<span class="o">=</span> <span class="n">sis190_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>	<span class="o">=</span> <span class="n">sis190_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>	<span class="o">=</span> <span class="n">sis190_nway_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span>
		<span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sis190_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">sis190_init_rxfilter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sis190_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sis190_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sis190_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">sis190_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sis190_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">sis190_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">sis190_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">sis190_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	 <span class="o">=</span> <span class="n">sis190_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis190_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="n">SIS190_DRIVER_NAME</span> <span class="s">&quot; loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printed_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">sis190_init_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sis190_get_mac_addr</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_board</span><span class="p">;</span>

	<span class="n">sis190_init_rxfilter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_task</span><span class="p">,</span> <span class="n">sis190_phy_task</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sis190_netdev_ops</span><span class="p">;</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sis190_ethtool_ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">SIS190_TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sis190_mii_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_board</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_remove_mii</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s at %p (IRQ: %d), %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span>
			    <span class="n">sis_chip_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">ioaddr</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">F_HAS_RGMII</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RGMII&quot;</span> <span class="o">:</span> <span class="s">&quot;GMII&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sis190_set_speed_auto</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_remove_mii:</span>
	<span class="n">sis190_mii_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_release_board:</span>
	<span class="n">sis190_release_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sis190_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sis190_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sis190_mii_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_task</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sis190_release_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sis190_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sis190_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sis190_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sis190_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sis190_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sis190_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sis190_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sis190_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sis190_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sis190_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
